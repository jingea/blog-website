
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>ming15</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="ming15">
    

    
    <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="ming15">
<meta property="og:url" content="http://www.ming15.wang/index.html">
<meta property="og:site_name" content="ming15">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ming15">
<meta name="twitter:description">

    
    <link rel="alternative" href="/atom.xml" title="ming15" type="application/atom+xml">
    
    
    
    <link rel="apple-touch-icon" href="/img/author.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/author.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="ming15" title="ming15"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="ming15">ming15</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
						<form class="search" action="http://zhannei.baidu.com/cse/search" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= 17728547076946147000 ><input type="text" name="q" size="30" placeholder="Search"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/19/netty/Unsafe/" title="Netty Unsafe" itemprop="url">Netty Unsafe</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-03-18T16:00:00.000Z" itemprop="datePublished"> Published 2016-03-19</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>首先我们来看一下<code>Unsafe</code>的继承<br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/netty/unsafe.jpg" alt=""></p>
<h2 id="Unsafe"><a href="#Unsafe" class="headerlink" title="Unsafe"></a>Unsafe</h2><p><code>Unsafe</code>是<code>Channel</code>的内部接口, 它定义了下面的相关功能</p>
<ul>
<li><code>localAddress()</code> : 获得本地绑定的<code>SocketAddress</code>对象</li>
<li><code>remoteAddress()</code> : 返回与网络对等端绑定的地址<code>SocketAddress</code></li>
<li><code>register()</code> : 将<code>EventLoop</code>注册到<code>Channel</code>上, 一旦注册成功就返回<code>ChannelFuture</code></li>
<li><code>bind()</code> : 将<code>SocketAddress</code>绑定到<code>Channel</code>上.</li>
<li><code>connect()</code> : <code>Channel</code>与对端的<code>SocketAddress</code>进行连接</li>
<li><code>disconnect()</code> : <code>Channel</code>与网络对端断开连接</li>
<li><code>close()</code> : 关闭<code>Channel</code>与网络对端的连接</li>
<li><code>deregister()</code> : <code>Channel</code>与<code>EventLoop</code>解除注册关系</li>
<li><code>beginRead()</code> : Schedules a read operation that fills the inbound buffer of the first {@link ChannelInboundHandler} in the {@link ChannelPipeline}.  If there’s already a pending read operation, this method does nothing.</li>
<li><code>write()</code> : 调度一个写操作</li>
<li><code>flush()</code> : 通过<code>write()</code>将全部的写操作进行调用</li>
<li><code>outboundBuffer()</code> : Returns the {@link ChannelOutboundBuffer} of the {@link Channel} where the pending write requests are stored.</li>
</ul>
<h2 id="AbstractUnsafe"><a href="#AbstractUnsafe" class="headerlink" title="AbstractUnsafe"></a>AbstractUnsafe</h2><p><code>AbstractUnsafe</code>是<code>AbstractChannel</code>的内部类, 主要是提供了对<code>AbstractChannel</code>的辅助功能, 它内部实现了N个, 这些方法最终都会调用<code>AbstractChannel</code>子类实现的<code>doXXX()</code>相关方法. 例如:</p>
<ul>
<li><code>register()</code> -&gt; <code>doRegister()</code>, <code>doRegister()</code>(<code>AbstractNioChannel</code>实现)调用完成之后调用pipline的<code>fireChannelRegistered()</code>和<code>fireChannelActive()</code>.</li>
<li><code>bind()</code> -&gt; <code>doBind()</code></li>
<li><code>disconnect()</code> -&gt; <code>doDisconnect()</code></li>
<li><code>close()</code> -&gt; <code>doClose()</code></li>
<li><code>deregister</code> -&gt; <code>doDeregister()</code>(<code>AbstractNioChannel</code>实现)</li>
<li><code>beginRead()</code> -&gt; <code>doBeginRead()</code>(<code>AbstractNioChannel</code>实现)</li>
<li><code>flush()</code> -&gt; <code>doWrite()</code></li>
</ul>
<p>需要仔细看一下的是<code>AbstractUnsafe</code>内部消息存储的一个环形数组<code>ChannelOutboundBuffer</code>成员<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ChannelOutboundBuffer outboundBuffer = <span class="keyword">new</span> ChannelOutboundBuffer(AbstractChannel.<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure></p>
<p>下来我们看一下它的<code>write()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(Object msg, ChannelPromise promise)</span> </span>&#123;</span><br><span class="line">            ChannelOutboundBuffer outboundBuffer = <span class="keyword">this</span>.outboundBuffer;</span><br><span class="line">            <span class="keyword">if</span> (outboundBuffer == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// outboundBuffer为空, 说明channel已经关闭了, 那么现在就需要立刻做快速失败处理</span></span><br><span class="line">                safeSetFailure(promise, CLOSED_CHANNEL_EXCEPTION);</span><br><span class="line">                <span class="comment">// 将消息释放掉, 避免发生内存泄漏</span></span><br><span class="line">                ReferenceCountUtil.release(msg);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> size;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                msg = filterOutboundMessage(msg);</span><br><span class="line">                size = estimatorHandle().size(msg);</span><br><span class="line">                <span class="keyword">if</span> (size &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    size = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                safeSetFailure(promise, t);</span><br><span class="line">                ReferenceCountUtil.release(msg);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 我们看到, 在写消息的时候,最后就是将msg写到了一个环形数组里</span></span><br><span class="line">            outboundBuffer.addMessage(msg, size, promise);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>将消息写到<code>outboundBuffer</code>之后, 最终我们还是需要调用<code>flush()</code>将其真正刷到TCP中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            ChannelOutboundBuffer outboundBuffer = <span class="keyword">this</span>.outboundBuffer;</span><br><span class="line">            outboundBuffer.addFlush();</span><br><span class="line">            flush0();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">flush0</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> ChannelOutboundBuffer outboundBuffer = <span class="keyword">this</span>.outboundBuffer;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                doWrite(outboundBuffer);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                inFlush0 = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>我们看到最终的写到channel中也是由<code>doWrite()</code>方法实现的.</p>
<h2 id="AbstractNioUnsafe"><a href="#AbstractNioUnsafe" class="headerlink" title="AbstractNioUnsafe"></a>AbstractNioUnsafe</h2><p><code>AbstractNioUnsafe</code>是<code>AbstactNioChannel</code>的内部类. 与<code>AbstractUnsafe</code>类似, 它也是提供了一些对Channel的代理调用</p>
<ul>
<li><code>connect()</code> -&gt; <code>doConnect()</code></li>
<li><code>finishConnect()</code> -&gt; <code>doFinishConnect()</code></li>
</ul>
<h2 id="NioByteUnsafe"><a href="#NioByteUnsafe" class="headerlink" title="NioByteUnsafe"></a>NioByteUnsafe</h2><p>我们重点看一下<code>read()</code>和<code>write()</code>方法</p>
<p>我们首先看一下<code>read()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> ChannelConfig config = config();</span><br><span class="line">            <span class="keyword">if</span> (!config.isAutoRead() &amp;&amp; !isReadPending()) &#123;</span><br><span class="line">                <span class="comment">// ChannelConfig.setAutoRead(false) was called in the meantime</span></span><br><span class="line">                removeReadOp();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> ChannelPipeline pipeline = pipeline();</span><br><span class="line">            <span class="keyword">final</span> ByteBufAllocator allocator = config.getAllocator();</span><br><span class="line">            <span class="comment">// 我们配置的每次读取数据最多读取的数据量</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> maxMessagesPerRead = config.getMaxMessagesPerRead();</span><br><span class="line">            RecvByteBufAllocator.Handle allocHandle = <span class="keyword">this</span>.allocHandle;</span><br><span class="line">            <span class="keyword">if</span> (allocHandle == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.allocHandle = allocHandle = config.getRecvByteBufAllocator().newHandle();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ByteBuf byteBuf = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">int</span> messages = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">boolean</span> close = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 读取的总量</span></span><br><span class="line">                <span class="keyword">int</span> totalReadAmount = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="keyword">boolean</span> readPendingReset = <span class="keyword">false</span>;</span><br><span class="line">                do &#123;</span><br><span class="line">                    <span class="comment">// 获取一个byteBuf对象, 用于这次读取数据, 具体的获取策略, 本文最后有介绍</span></span><br><span class="line">                    byteBuf = allocHandle.allocate(allocator);</span><br><span class="line">                    <span class="keyword">int</span> writable = byteBuf.writableBytes();</span><br><span class="line">                    <span class="comment">// 调用NioSocketChannel的doReadBytes()实现, 将数据读进byteBuf中</span></span><br><span class="line">                    <span class="keyword">int</span> localReadAmount = doReadBytes(byteBuf);</span><br><span class="line">                    <span class="keyword">if</span> (localReadAmount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// 如果没有读到数据,则将ByteBuf释放掉</span></span><br><span class="line">                        byteBuf.release();</span><br><span class="line">                        close = localReadAmount &lt; <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!readPendingReset) &#123;</span><br><span class="line">                        readPendingReset = <span class="keyword">true</span>;</span><br><span class="line">                        setReadPending(<span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 开始在pipeline里进行ByteBuf数据传播</span></span><br><span class="line">                    pipeline.fireChannelRead(byteBuf);</span><br><span class="line">                    byteBuf = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (totalReadAmount &gt;= Integer.MAX_VALUE - localReadAmount) &#123;</span><br><span class="line">                        <span class="comment">// Avoid overflow.</span></span><br><span class="line">                        totalReadAmount = Integer.MAX_VALUE;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 统计所有的读到的数据</span></span><br><span class="line">                    totalReadAmount += localReadAmount;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// stop reading</span></span><br><span class="line">                    <span class="keyword">if</span> (!config.isAutoRead()) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (localReadAmount &lt; writable) &#123;</span><br><span class="line">                        <span class="comment">// Read less than what the buffer can hold,</span></span><br><span class="line">                        <span class="comment">// which might mean we drained the recv buffer completely.</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 如果仍然有未读数据的话, 则继续读取</span></span><br><span class="line">                &#125; <span class="keyword">while</span> (++ messages &lt; maxMessagesPerRead);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 当前所有数据都读取完了, 触发</span></span><br><span class="line">                pipeline.fireChannelReadComplete();</span><br><span class="line">                allocHandle.record(totalReadAmount);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (close) &#123;</span><br><span class="line">                    closeOnRead(pipeline);</span><br><span class="line">                    close = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                handleReadException(pipeline, byteBuf, t, close);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// Check if there is a readPending which was not processed yet.</span></span><br><span class="line">                <span class="comment">// This could be for two reasons:</span></span><br><span class="line">                <span class="comment">// * The user called Channel.read() or ChannelHandlerContext.read() in channelRead(...) method</span></span><br><span class="line">                <span class="comment">// * The user called Channel.read() or ChannelHandlerContext.read() in channelReadComplete(...) method</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// See https://github.com/netty/netty/issues/2254</span></span><br><span class="line">                <span class="keyword">if</span> (!config.isAutoRead() &amp;&amp; !isReadPending()) &#123;</span><br><span class="line">                    removeReadOp();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="NioMessageUnsafe"><a href="#NioMessageUnsafe" class="headerlink" title="NioMessageUnsafe"></a>NioMessageUnsafe</h2><p><code>NioMessageUnsafe</code>是<code>AbstractNioMessageChannel</code>的内部类. 它的<code>read()</code>方法与<code>NioByteMessage</code>的类似, 只不过这个是用于<br>服务<code>NioServerSocketChannel</code>的, 它内部的<code>doReadMessages()</code>会调用的<code>NioServerSocketChannel</code>的实现.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">assert</span> <span class="title">eventLoop</span><span class="params">()</span>.<span class="title">inEventLoop</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="keyword">final</span> ChannelConfig config = config();</span><br><span class="line">            <span class="keyword">if</span> (!config.isAutoRead() &amp;&amp; !isReadPending()) &#123;</span><br><span class="line">                <span class="comment">// ChannelConfig.setAutoRead(false) was called in the meantime</span></span><br><span class="line">                removeReadOp();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> maxMessagesPerRead = config.getMaxMessagesPerRead();</span><br><span class="line">            <span class="keyword">final</span> ChannelPipeline pipeline = pipeline();</span><br><span class="line">            <span class="keyword">boolean</span> closed = <span class="keyword">false</span>;</span><br><span class="line">            Throwable exception = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                        <span class="keyword">int</span> localRead = doReadMessages(readBuf);</span><br><span class="line">                        <span class="keyword">if</span> (localRead == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (localRead &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                            closed = <span class="keyword">true</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// stop reading and remove op</span></span><br><span class="line">                        <span class="keyword">if</span> (!config.isAutoRead()) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (readBuf.size() &gt;= maxMessagesPerRead) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    exception = t;</span><br><span class="line">                &#125;</span><br><span class="line">                setReadPending(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">int</span> size = readBuf.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i ++) &#123;</span><br><span class="line">                    pipeline.fireChannelRead(readBuf.get(i));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                readBuf.clear();</span><br><span class="line">                pipeline.fireChannelReadComplete();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (exception != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> IOException &amp;&amp; !(exception <span class="keyword">instanceof</span> PortUnreachableException)) &#123;</span><br><span class="line">                        <span class="comment">// ServerChannel should not be closed even on IOException because it can often continue</span></span><br><span class="line">                        <span class="comment">// accepting incoming connections. (e.g. too many open files)</span></span><br><span class="line">                        closed = !(AbstractNioMessageChannel.<span class="keyword">this</span> <span class="keyword">instanceof</span> ServerChannel);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    pipeline.fireExceptionCaught(exception);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (isOpen()) &#123;</span><br><span class="line">                        close(voidPromise());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// Check if there is a readPending which was not processed yet.</span></span><br><span class="line">                <span class="comment">// This could be for two reasons:</span></span><br><span class="line">                <span class="comment">// * The user called Channel.read() or ChannelHandlerContext.read() in channelRead(...) method</span></span><br><span class="line">                <span class="comment">// * The user called Channel.read() or ChannelHandlerContext.read() in channelReadComplete(...) method</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// See https://github.com/netty/netty/issues/2254</span></span><br><span class="line">                <span class="keyword">if</span> (!config.isAutoRead() &amp;&amp; !isReadPending()) &#123;</span><br><span class="line">                    removeReadOp();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Netty/">Netty</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/19/netty/Unsafe/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/19/netty/Unsafe/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/17/netty/Netty 压测/" title="Netty 压测" itemprop="url">Netty 压测</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-03-16T16:00:00.000Z" itemprop="datePublished"> Published 2016-03-17</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我们知道Netty的性能是非常好的,那究竟有多好呢? 今天我写了一个小程序测试了一下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> cpuSize = Runtime.getRuntime().availableProcessors();</span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup(cpuSize);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">            b.group(bossGroup, workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">                    .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</span><br><span class="line">                    .option(ChannelOption.AUTO_READ, <span class="keyword">true</span>)</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> </span>&#123;</span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> InHandler());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            ChannelFuture f = b.bind(<span class="number">8881</span>).sync();</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> </span>&#123;</span><br><span class="line">        ctx.write(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面是一个简单的Socket服务器, 不做任何的编解码工作, 当接收到数据之后, 直接返回给客户端.</p>
<p>在启动的这个服务器的时候加上指定虚拟机的堆大小(我们指定了大小为固定的30M)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xmx30m -Xms30m</span><br><span class="line">`</span><br></pre></td></tr></table></figure></p>
<p>然后写一个Socket客户端程序(原谅我客户端是用python写的, 现在我正在把我业余时间写代码的语言替换成python)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">socketSendData</span><span class="params">()</span>:</span></span><br><span class="line">    client=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">    client.connect((<span class="string">'localhost'</span>,<span class="number">8881</span>))</span><br><span class="line">    client.send(<span class="string">'2'</span>)</span><br><span class="line">    time.sleep(<span class="number">60</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">2000</span>, <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">       t = threading.Thread(target=socketSendData)</span><br><span class="line">       info = t.start()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">       count += <span class="number">1</span></span><br><span class="line">       <span class="keyword">print</span> <span class="string">"Error: unable to start thread  "</span> + str(count)</span><br></pre></td></tr></table></figure></p>
<p>由于测试机配置问题, 我的python程序只能启动2000个Socket连接, 但是也无所谓, 我们看一下在这俩千个Socket连接时, Netty服务器的消耗</p>
<p>我们首先看一下客户端连接运行之前的Netty程序的内存占用<br><img src="" alt=""><br>我们看到了在top中为46M, 在visualVM中分配的30M堆内存也只使用了10M, 而且一直在GC.</p>
<p>那么我们再看一下压测之后的内?<br><img src="" alt=""><br>top中显示占用了58M的内存, 而在visualVM只不过偶尔比10M多一点的内存,而且又很快的GC掉了.</p>
<p>那么top中多出的12M内存是怎么回事呢?这是因为Netty默认的使用的是UnpooledDirectByteBuf(姑且是这么个名字吧), 它使用的是非池化的直接内存, 也就是说在接受网络连接数据的时候,它并没有直接使用堆内内存,而是使用的堆外的.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Netty/">Netty</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/17/netty/Netty 压测/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/17/netty/Netty 压测/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/16/数据库/数据压缩/" title="Mysql 数据压缩" itemprop="url">Mysql 数据压缩</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-03-15T16:00:00.000Z" itemprop="datePublished"> Published 2016-03-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我们在创建一个表的时候, 可以采用压缩技术<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> CUSTOMER (  </span><br><span class="line">…  </span><br><span class="line">) <span class="keyword">COMPRESS</span> YES;</span><br></pre></td></tr></table></figure></p>
<p>如果想要在中途停止表的压缩<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> CUSTOMER <span class="keyword">COMPRESS</span> <span class="keyword">NO</span>;</span><br></pre></td></tr></table></figure></p>
<p>但是停止之后并不会对已经存在的数据进行解压缩,如果想要对已经存在的数据解压缩的话, 我们可以使用<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REORG TABLE CUSTOMER;</span><br></pre></td></tr></table></figure></p>
<p>这个语句会根据当前表的压缩状态来重新整理表, 对数据进行压缩解压缩.</p>
<p>如果我们只是想要对某个字符串字段(一般是针对Blob字段进行压缩)进行压缩的话, 那么我们可以使用压缩函数<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COMPRESS(string_to_compress)</span><br></pre></td></tr></table></figure></p>
<p>然后再对其进行解压缩<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UNCOMPRESS()</span><br></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/数据库/">数据库</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/16/数据库/数据压缩/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/16/数据库/数据压缩/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/14/netty/NioEventLoop/" title="Netty NioEventLoop" itemprop="url">Netty NioEventLoop</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-03-13T16:00:00.000Z" itemprop="datePublished"> Published 2016-03-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>在真实的业务环境中, 我们都是使用主从Reactor线程模型. 在Netty中主从线程池都是使用的<code>NioEventLoopGroup</code>, 它实现了<br><code>java.util.concurrent.Executor</code>. 虽然在编程中我们使用的是<code>NioEventLoopGroup</code>, 但是主要的逻辑确是在<code>MultithreadEventExecutorGroup</code>里实现的.<br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/netty/NioEventLoopGroup.jpg" alt=""><br>下来我们首先看一下<code>MultithreadEventExecutorGroup</code>的数据成员<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> EventExecutor[] children;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> EventExecutorChooser chooser;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">MultithreadEventExecutorGroup</span><span class="params">(<span class="keyword">int</span> nThreads, ThreadFactory threadFactory, Object... args)</span> </span>&#123;</span><br><span class="line">        children = <span class="keyword">new</span> SingleThreadEventExecutor[nThreads];</span><br><span class="line">        <span class="keyword">if</span> (isPowerOfTwo(children.length)) &#123;</span><br><span class="line">            chooser = <span class="keyword">new</span> PowerOfTwoEventExecutorChooser();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            chooser = <span class="keyword">new</span> GenericEventExecutorChooser();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nThreads; i ++) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                children[i] = newChild(threadFactory, args);</span><br><span class="line">                success = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> Think about if this is a good exception type</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"failed to create a child event loop"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>我们看到了<code>NioEventLoopGroup</code>内部聚合了一个<code>EventExecutor</code>的数组. 这个数组就构成了主从线程池. 线程的选择由<code>EventExecutorChooser chooser</code>来实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> EventExecutor <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> chooser.next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PowerOfTwoEventExecutorChooser</span> <span class="keyword">implements</span> <span class="title">EventExecutorChooser</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EventExecutor <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> children[childIndex.getAndIncrement() &amp; children.length - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericEventExecutorChooser</span> <span class="keyword">implements</span> <span class="title">EventExecutorChooser</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EventExecutor <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> children[Math.abs(childIndex.getAndIncrement() % children.length)];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而<code>newChild()</code>的方法实现是由子类来确定的, 我们来直接看一下<code>NioEventLoopGroup</code>的内部实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> EventExecutor <span class="title">newChild</span><span class="params">(ThreadFactory threadFactory, Object... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NioEventLoop(<span class="keyword">this</span>, threadFactory, (SelectorProvider) args[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>它是直接生成了一个<code>NioEventLoop</code>的实例出来. 下来我们看一下<code>NioEventLoop</code>的实现<br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/netty/NioEventLoop.jpg" alt=""><br>我们看一下<code>NioEventLoop</code>的属性成员<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多路选择复用器</span></span><br><span class="line">Selector selector;</span><br><span class="line"><span class="comment">// Netty优化过的SelectedSelectionKeys</span></span><br><span class="line"><span class="keyword">private</span> SelectedSelectionKeySet selectedKeys;</span><br><span class="line"><span class="comment">// SelectorProvider.provider()提供, 在NioEventLoopGroup构造器中实现</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SelectorProvider provider;</span><br></pre></td></tr></table></figure></p>
<p>我们看到<code>NioEventLoop</code>主要是实现了IO多路复用, 它的任务执行是由父类<code>SingleThreadEventExecutor</code>实现的, 下面我们从它的构造器来追溯到<code>SingleThreadEventExecutor</code>上<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NioEventLoop(NioEventLoopGroup parent, ThreadFactory threadFactory, SelectorProvider selectorProvider) &#123;</span><br><span class="line">    <span class="keyword">super</span>(parent, threadFactory, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (selectorProvider == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"selectorProvider"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    provider = selectorProvider;</span><br><span class="line">    selector = openSelector();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>SingleThreadEventExecutor</code>这个类主要是实现了主从线程池中的线程功能, 所有的任务都在单线程中执行, 因此将这个线程池串行化, 可以将其看待成一个线程. 在<code>SingleThreadEventExecutor</code>中的构造器中,添加向任务队列中添加一个调用<code>NioEventLoop</code>的<code>run()</code>方法的任务<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">SingleThreadEventExecutor</span><span class="params">(</span><br><span class="line">            EventExecutorGroup parent, ThreadFactory threadFactory, <span class="keyword">boolean</span> addTaskWakesUp)</span> </span>&#123;</span><br><span class="line">        thread = threadFactory.newThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">                updateLastExecutionTime();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    SingleThreadEventExecutor.<span class="keyword">this</span>.run();</span><br><span class="line">                    success = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                        <span class="keyword">int</span> oldState = STATE_UPDATER.get(SingleThreadEventExecutor.<span class="keyword">this</span>);</span><br><span class="line">                        <span class="keyword">if</span> (oldState &gt;= ST_SHUTTING_DOWN || STATE_UPDATER.compareAndSet(</span><br><span class="line">                                SingleThreadEventExecutor.<span class="keyword">this</span>, oldState, ST_SHUTTING_DOWN)) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// Check if confirmShutdown() was called at the end of the loop.</span></span><br><span class="line">                    <span class="keyword">if</span> (success &amp;&amp; gracefulShutdownStartTime == <span class="number">0</span>) &#123;</span><br><span class="line">                        logger.error(<span class="string">"Buggy "</span> + EventExecutor.class.getSimpleName());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// Run all remaining tasks and shutdown hooks.</span></span><br><span class="line">                        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (confirmShutdown()) &#123;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            cleanup();</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            STATE_UPDATER.set(SingleThreadEventExecutor.<span class="keyword">this</span>, ST_TERMINATED);</span><br><span class="line">                            threadLock.release();</span><br><span class="line">                            terminationFuture.setSuccess(<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        taskQueue = newTaskQueue();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>我们看到了一行关键性代码<code>SingleThreadEventExecutor.this.run()</code>, 它调用了自己的<code>run()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>而这个方法是在<code>NioEventLoop</code>中实现的,也是我们要重点分析的代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> oldWakenUp = wakenUp.getAndSet(<span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 查看taskQueue里是否有任务, 如果有任务的话, 则直接selector.selectNow();</span></span><br><span class="line">                <span class="keyword">if</span> (hasTasks()) &#123;</span><br><span class="line">                    selectNow();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    select(oldWakenUp);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (wakenUp.get()) &#123;</span><br><span class="line">                        selector.wakeup();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                cancelledKeys = <span class="number">0</span>;</span><br><span class="line">                needsToSelectAgain = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> ioRatio = <span class="keyword">this</span>.ioRatio;</span><br><span class="line">                <span class="comment">// 如果当前线程是百分百执行的话, 则直接处理所有的任务</span></span><br><span class="line">                <span class="keyword">if</span> (ioRatio == <span class="number">100</span>) &#123;</span><br><span class="line">                    processSelectedKeys();</span><br><span class="line">                    runAllTasks();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">long</span> ioStartTime = System.nanoTime();</span><br><span class="line"></span><br><span class="line">                    processSelectedKeys();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">long</span> ioTime = System.nanoTime() - ioStartTime;</span><br><span class="line">                    runAllTasks(ioTime * (<span class="number">100</span> - ioRatio) / ioRatio);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="keyword">if</span> (isShuttingDown()) &#123;</span><br><span class="line">                    closeAll();</span><br><span class="line">                    <span class="keyword">if</span> (confirmShutdown()) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的<code>run()</code>就是不断的轮询当前<code>NioEventLoop</code>里是否有任务. 然后处理Selector上已经就绪的Channel和任务队列里的任务.<br>然后我们接着往下看<code>processSelectedKeys()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processSelectedKeys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (selectedKeys != <span class="keyword">null</span>) &#123;</span><br><span class="line">           processSelectedKeysOptimized(selectedKeys.flip());</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           processSelectedKeysPlain(selector.selectedKeys());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processSelectedKeysPlain</span><span class="params">(Set&lt;SelectionKey&gt; selectedKeys)</span> </span>&#123;</span><br><span class="line">           <span class="comment">// check if the set is empty and if so just return to not create garbage by</span></span><br><span class="line">           <span class="comment">// creating a new Iterator every time even if there is nothing to process.</span></span><br><span class="line">           <span class="comment">// See https://github.com/netty/netty/issues/597</span></span><br><span class="line">           <span class="keyword">if</span> (selectedKeys.isEmpty()) &#123;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           Iterator&lt;SelectionKey&gt; i = selectedKeys.iterator();</span><br><span class="line">           <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">               <span class="keyword">final</span> SelectionKey k = i.next();</span><br><span class="line">               <span class="comment">// 取出SelectionKey的附件</span></span><br><span class="line">               <span class="keyword">final</span> Object a = k.attachment();</span><br><span class="line">               i.remove();</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (a <span class="keyword">instanceof</span> AbstractNioChannel) &#123;</span><br><span class="line">                 <span class="comment">// a有可能是NioServerSocketChannel或者NioSocketChannel</span></span><br><span class="line">                   processSelectedKey(k, (AbstractNioChannel) a);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">// 如果a不是Channel的话, 那就是NioTask了</span></span><br><span class="line">                   <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                   NioTask&lt;SelectableChannel&gt; task = (NioTask&lt;SelectableChannel&gt;) a;</span><br><span class="line">                   processSelectedKey(k, task);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (!i.hasNext()) &#123;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (needsToSelectAgain) &#123;</span><br><span class="line">                   selectAgain();</span><br><span class="line">                   selectedKeys = selector.selectedKeys();</span><br><span class="line"></span><br><span class="line">                   <span class="comment">// Create the iterator again to avoid ConcurrentModificationException</span></span><br><span class="line">                   <span class="keyword">if</span> (selectedKeys.isEmpty()) &#123;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       i = selectedKeys.iterator();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure></p>
<p>然后咱们接着往下看对Channel的处理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">processSelectedKey</span><span class="params">(SelectionKey k, AbstractNioChannel ch)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> NioUnsafe unsafe = ch.unsafe();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> readyOps = k.readyOps();</span><br><span class="line">        <span class="comment">// Also check for readOps of 0 to workaround possible JDK bug which may otherwise lead</span></span><br><span class="line">        <span class="comment">// to a spin loop</span></span><br><span class="line">        <span class="keyword">if</span> ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != <span class="number">0</span> || readyOps == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果是读事件或者连接的事件,则直接调用read方法</span></span><br><span class="line">            unsafe.read();</span><br><span class="line">            <span class="keyword">if</span> (!ch.isOpen()) &#123;</span><br><span class="line">                <span class="comment">// Connection already closed - no need to handle write.</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((readyOps &amp; SelectionKey.OP_WRITE) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果是写操作位, 则说明有半包消息没有写完, 需要继续</span></span><br><span class="line">            ch.unsafe().forceFlush();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((readyOps &amp; SelectionKey.OP_CONNECT) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// remove OP_CONNECT as otherwise Selector.select(..) will always return without blocking</span></span><br><span class="line">            <span class="comment">// See https://github.com/netty/netty/issues/924</span></span><br><span class="line">            <span class="keyword">int</span> ops = k.interestOps();</span><br><span class="line">            ops &amp;= ~SelectionKey.OP_CONNECT;</span><br><span class="line">            k.interestOps(ops);</span><br><span class="line"></span><br><span class="line">            unsafe.finishConnect();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CancelledKeyException ignored) &#123;</span><br><span class="line">        unsafe.close(unsafe.voidPromise());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>在unsafe的多态这我们要多说一些, 我们知道NioEventLoop内部处理的Channel其实是有俩种类型的, 一个是<code>NioServerScoketChannel</code>一个是<code>NioSocketChannel</code>.</p>
<p><code>NioServerSocketChannel</code>继承自<code>AbstractNioMessageChannel</code>, 而这个父类实现了一个<code>NioMessageUnsafe</code>的一个内部类, 这个内部类的<code>read()</code>方法会调用Channel里的<code>doReadMessage()</code>方法. 父类的<code>doReadMessage()</code>方法是由子类来具体实现的. 在<code>NioServerScoketChannel</code>中是生成了一个<code>NioSocketChannel</code>的列表作为消息返回, 然后再让<code>ServerBootstrapAcceptor</code>将<code>NioSocketChannel</code>绑定到从Reactor上.</p>
<p><code>NioSocketChannel</code>继承自<code>AbstractNioByteChannel</code>, 这个父类实现了一个<code>NioByteUnsafe</code>, 这个Unsafe就负责创建ByteBuf, 接受真正的网络数据了.</p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Netty/">Netty</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/14/netty/NioEventLoop/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/14/netty/NioEventLoop/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/12/算法/环形队列/" title="环形队列" itemprop="url">环形队列</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-03-11T16:00:00.000Z" itemprop="datePublished"> Published 2016-03-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*- coding=utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 环形队列实现</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CircleQueue</span>:</span></span><br><span class="line">    <span class="comment"># 队列头</span></span><br><span class="line">    queueHead = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 队列尾</span></span><br><span class="line">    queueTail = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 队列容量</span></span><br><span class="line">    queueCacity = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 队列当前长度</span></span><br><span class="line">    queueLength = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 队列容器</span></span><br><span class="line">    queue = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, capacity)</span>:</span></span><br><span class="line">        self.queueCacity = capacity</span><br><span class="line">        self.queue = [<span class="number">0</span>] * capacity</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 入列</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enqueue</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(self.isFull()):</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"Queue is Full"</span>)</span><br><span class="line"></span><br><span class="line">        self.queue[self.queueTail] = obj</span><br><span class="line">        self.queueTail += <span class="number">1</span></span><br><span class="line">        <span class="comment"># 为了让队列头一直在环形队列中进行变化, 因此进行取余操作,</span></span><br><span class="line">        <span class="comment"># 当队列头达到最大容量时,再增长就回到初始队列头的位置</span></span><br><span class="line">        self.queueTail = self.queueTail % self.queueCacity</span><br><span class="line">        self.queueLength += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.queueLength</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 出列</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dequeue</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(self.isEmpoty()):</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"Queue is Empoty"</span>)</span><br><span class="line">        obj = self.queue[self.queueHead]</span><br><span class="line">        self.queueHead += <span class="number">1</span></span><br><span class="line">        self.queueHead = self.queueHead % self.queueCacity</span><br><span class="line">        self.queueLength -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 判断队列是否为空</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isEmpoty</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.queueLength == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 判断队列是否已满</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isFull</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.queueLength == self.queueCacity</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">circleQueue = CircleQueue(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 入列5个元素</span></span><br><span class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">1</span>) == <span class="number">1</span></span><br><span class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">2</span>) == <span class="number">2</span></span><br><span class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">3</span>) == <span class="number">3</span></span><br><span class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">4</span>) == <span class="number">4</span></span><br><span class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">5</span>) == <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 现在队列的长度为5, 且队列尾已经和队列头重合了</span></span><br><span class="line"><span class="keyword">assert</span> circleQueue.queueLength == <span class="number">5</span></span><br><span class="line"><span class="keyword">assert</span> circleQueue.queueTail == <span class="number">0</span></span><br><span class="line"><span class="keyword">assert</span> circleQueue.queueHead == <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> circleQueue.dequeue() == <span class="number">1</span></span><br><span class="line"><span class="keyword">assert</span> circleQueue.dequeue() == <span class="number">2</span></span><br><span class="line"><span class="keyword">assert</span> circleQueue.dequeue() == <span class="number">3</span></span><br><span class="line"><span class="keyword">assert</span> circleQueue.dequeue() == <span class="number">4</span></span><br><span class="line"><span class="keyword">assert</span> circleQueue.dequeue() == <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> circleQueue.queueTail == <span class="number">0</span></span><br><span class="line"><span class="keyword">assert</span> circleQueue.queueHead == <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 再入列一个数据,当前长度为1,且队列头为0,队列尾为1</span></span><br><span class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">6</span>) == <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> circleQueue.queueTail == <span class="number">1</span></span><br><span class="line"><span class="keyword">assert</span> circleQueue.queueHead == <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>环形队列的关键是能让头索引和尾索引能够在整个环形队列中自己循环</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/算法/">算法</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/12/算法/环形队列/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/12/算法/环形队列/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/12/python/python2异常/" title="PYTHON2 异常" itemprop="url">PYTHON2 异常</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-03-11T16:00:00.000Z" itemprop="datePublished"> Published 2016-03-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>捕获异常<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">   fh = open(<span class="string">"test"</span>, <span class="string">"w"</span>)</span><br><span class="line"><span class="keyword">except</span> IOError:</span><br><span class="line">   <span class="keyword">print</span> <span class="string">"Error: open error"</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">   <span class="keyword">print</span> <span class="string">"hava open file"</span></span><br><span class="line">   fh.close()</span><br></pre></td></tr></table></figure></p>
<p>抛出异常<code>raise [Exception [, args [, traceback]]]</code>例如<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(num &lt; <span class="number">100</span>):</span><br><span class="line">  <span class="keyword">raise</span> RuntimeError(<span class="string">"num is greater than 100!"</span>)</span><br></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/python2/">python2</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/12/python/python2异常/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/12/python/python2异常/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/06/nginx/nginx文件服务器/" title="Nginx文件服务器" itemprop="url">Nginx文件服务器</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-03-05T16:00:00.000Z" itemprop="datePublished"> Published 2016-03-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我们使用Nginx搭建一个静态文件上传下载服务器.</p>
<p>需要完成的功能</p>
<ul>
<li>文件上传</li>
<li>文件下载</li>
<li>用户验证</li>
<li>频率控制</li>
</ul>
<p>Nginx配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#user  nobody;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    sendfile        on;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       8071;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        location /index &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /upload &#123;</span><br><span class="line">            root   files;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /download/ &#123;</span><br><span class="line">            root   files;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/06/nginx/nginx文件服务器/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/06/nginx/nginx文件服务器/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/06/nginx/nginx安装与命令/" title="Nginx安装与启动,关闭" itemprop="url">Nginx安装与启动,关闭</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-03-05T16:00:00.000Z" itemprop="datePublished"> Published 2016-03-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>在MAC上安装Nginx</p>
<p>使用命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install nginx</span><br></pre></td></tr></table></figure></p>
<p>homebrew会自动为我们安装. 程序会安装在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/Cellar/nginx/1.6.2</span><br></pre></td></tr></table></figure></p>
<p>nginx的配置文件在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/etc/nginx</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>一般通过Homebrew安装的程序都会放在<code>/usr/local/Cellar/</code>里, 而配置文件会存储在<code>/usr/local/etc/</code>里</p>
</blockquote>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>我们可以通过下面这个简单的命令直接启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/nginx</span><br></pre></td></tr></table></figure></p>
<p>或者使用一个经过配置化的参数启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/nginx -t -c ~/mynginx.conf -g &quot;pid /var/run/nginx.pid; worker_processes 2;&quot;</span><br></pre></td></tr></table></figure></p>
<h2 id="关闭"><a href="#关闭" class="headerlink" title="关闭"></a>关闭</h2><p>一般我们可以通过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/nginx -s stop</span><br></pre></td></tr></table></figure></p>
<p>但是我们还可以通过想Nginx 主进程发送信号的方式来关闭它.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -QUIT $( cat /usr/local/nginx/logs/nginx.pid )</span><br></pre></td></tr></table></figure></p>
<p>一般我们推荐第二种方式, 让Nginx自己去停掉所有的主从进程</p>
<p>Nginx还接受如下参数</p>
<ul>
<li>TERM, INT    : Quick shutdown</li>
<li>QUIT :    Graceful shutdown</li>
<li>KILL :    Halts a stubborn process</li>
<li>HUP : Configuration reload, Start the new worker processes with a new configuration, Gracefully shutdown the old worker processes</li>
<li>USR1 :    Reopen the log files</li>
<li>USR2 :    Upgrade Executable on the fly</li>
<li>WINCH :    Gracefully shutdown the worker processes</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/06/nginx/nginx安装与命令/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/06/nginx/nginx安装与命令/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/06/nginx/nginx负载均衡/" title="Nginx负载均衡" itemprop="url">Nginx负载均衡</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-03-05T16:00:00.000Z" itemprop="datePublished"> Published 2016-03-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我们测试一次Nginx的负载均衡配置.</p>
<p>首先我们使用python启动俩个HTTP服务器<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> BaseHTTPServer</span><br><span class="line"><span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">port = sys.argv[<span class="number">1</span>]</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WebRequestHandler</span><span class="params">(BaseHTTPServer.BaseHTTPRequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        """</span></span><br><span class="line">        <span class="keyword">print</span> port</span><br><span class="line"></span><br><span class="line">server = BaseHTTPServer.HTTPServer((<span class="string">'0.0.0.0'</span>,int(sys.argv[<span class="number">1</span>])), WebRequestHandler)</span><br><span class="line">server.serve_forever()</span><br></pre></td></tr></table></figure></p>
<p>然后在命令行分别启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python ./PyHttpServer.py 8091</span><br><span class="line">python ./PyHttpServer.py 8092</span><br></pre></td></tr></table></figure></p>
<p>然后我们配置nginx.conf文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#user  nobody;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    upstream big_server_com &#123;</span><br><span class="line">      server 127.0.0.1:8091 weight=5;</span><br><span class="line">      server 127.0.0.1:8092 weight=5;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       8090;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">            proxy_pass      http://big_server_com;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们让nginx在8090端口上监听, 然后将其反向代理到<code>8091</code>和<code>8092</code>端口上.</p>
<blockquote>
<p>还有一点很重要的是, 要代理的服务必须在Nginx启动之前都启动完毕, 否则Nginx没办法完成代理工作.</p>
</blockquote>
<p>最后我们在浏览器上发送HTTP请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8090</span><br></pre></td></tr></table></figure></p>
<p>我们发现那俩个python的HTTP服务器果真都有输出了.</p>
<p>但是我们发现, 就是那俩个服务器同时都有输出, 而不是应该只有其中一个有输出. 所以下来还需要研究一下如何配置Upstream, 看看如何让其真正实现负载均衡和单点失败</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/06/nginx/nginx负载均衡/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/06/nginx/nginx负载均衡/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/06/python/python2网络编程/" title="PYTHON2 网络编程" itemprop="url">PYTHON2 网络编程</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-03-05T16:00:00.000Z" itemprop="datePublished"> Published 2016-03-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="Socket服务器"><a href="#Socket服务器" class="headerlink" title="Socket服务器"></a>Socket服务器</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">sock=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">sock.bind((<span class="string">'localhost'</span>,<span class="number">8089</span>))</span><br><span class="line">sock.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'tcpServer listen at: %s:%s\n\r'</span> %(<span class="string">'localhost'</span>,<span class="number">8089</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    client_sock,client_addr=sock.accept()</span><br><span class="line">    print(<span class="string">'%s:%s connect'</span> %client_addr)</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        recv=client_sock.recv(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> recv:</span><br><span class="line">            client_sock.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        print(<span class="string">'[Client %s:%s said]:%s'</span> % (client_addr[<span class="number">0</span>],client_addr[<span class="number">1</span>],recv))</span><br><span class="line">        client_sock.send(<span class="string">'tcpServer has received your message'</span>)</span><br><span class="line">        sock.close()</span><br></pre></td></tr></table></figure>
<h2 id="HttpServer"><a href="#HttpServer" class="headerlink" title="HttpServer"></a>HttpServer</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> BaseHTTPServer</span><br><span class="line"><span class="keyword">import</span> urlparse</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WebRequestHandler</span><span class="params">(BaseHTTPServer.BaseHTTPRequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        """</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"8090"</span></span><br><span class="line"></span><br><span class="line">server = BaseHTTPServer.HTTPServer((<span class="string">'0.0.0.0'</span>,<span class="number">8090</span>), WebRequestHandler)</span><br><span class="line">server.serve_forever()</span><br></pre></td></tr></table></figure>
<p>self 还有如下参数</p>
<ul>
<li>self.path</li>
<li>self.client_address</li>
<li>self.address_string()</li>
<li>self.command</li>
<li>self.path</li>
<li>self.request_version</li>
<li>self.server_version</li>
<li>self.sys_version</li>
<li>self.protocol_version</li>
<li>self.headers</li>
<li>self.send_response(200)</li>
<li>self.end_headers()</li>
</ul>
<h2 id="Socket客户端"><a href="#Socket客户端" class="headerlink" title="Socket客户端"></a>Socket客户端</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">client=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">client.connect((<span class="string">'localhost'</span>,<span class="number">8880</span>))</span><br><span class="line"></span><br><span class="line">client.send(<span class="string">'2'</span>)</span><br><span class="line">recvData=client.recv(<span class="number">1024</span>)</span><br><span class="line"><span class="keyword">print</span> recvData</span><br></pre></td></tr></table></figure>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/python2/">python2</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/06/python/python2网络编程/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/06/python/python2网络编程/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/05/nginx/nginx配置/" title="Nginx配置" itemprop="url">Nginx配置</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-03-04T16:00:00.000Z" itemprop="datePublished"> Published 2016-03-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>下面我们看一下Nginx官方给出的nginx.config可有的全部配置内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">user       www www;  ## Default: nobody</span><br><span class="line"># 在Nginx启动的时候会启动一个Master进程,和N个worker进程,Master讲接收到的任务分配给worker进程执行. worker进程数一般与主机的CPU的核心数相等</span><br><span class="line">worker_processes  5;  ## Default: 1</span><br><span class="line"># 错误日志的输出位置. (TODO 错误日志指的是哪些?)</span><br><span class="line">error_log  logs/error.log;</span><br><span class="line"># Nginx启动时的主进程ID</span><br><span class="line">pid        logs/nginx.pid;</span><br><span class="line"># worker进程能打开的最多的文件数(TODO 在正式环境中Nginx都会打开什么文件? 指的是Socket连接吗?)</span><br><span class="line">worker_rlimit_nofile 8192;</span><br><span class="line"></span><br><span class="line"># events模块, 包含nginx中所有处理连接的设置</span><br><span class="line">events &#123;</span><br><span class="line">  # worker进程能打开的最大的连接数 (小于worker_rlimit_nofile数)</span><br><span class="line">  worker_connections  4096;  ## Default: 1024</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># http模块, 用于处理http请求</span><br><span class="line">http &#123;</span><br><span class="line">  # 引用mime.types配置, 主要是配置HTTP请求中的mineType类型</span><br><span class="line">  include    conf/mime.types;</span><br><span class="line">  # 引用nginx的代理配置. (TODO)</span><br><span class="line">  include    /etc/nginx/proxy.conf;</span><br><span class="line">  # 为nginx引用cgi配置</span><br><span class="line">  include    /etc/nginx/fastcgi.conf;</span><br><span class="line">  # 指定当HTTP请求没有任何请求路径时展示的界面.</span><br><span class="line">  index    index.html index.htm index.php;</span><br><span class="line"></span><br><span class="line">  #</span><br><span class="line">  default_type application/octet-stream;</span><br><span class="line">  # log输出格式</span><br><span class="line">  log_format   main &apos;$remote_addr - $remote_user [$time_local]  $status &apos;</span><br><span class="line">    &apos;&quot;$request&quot; $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">    &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">  # 访问nginx时, 记录的http请求的日志存储位置 (TODO  如何以时间分割文件?)</span><br><span class="line">  access_log   logs/access.log  main;</span><br><span class="line">  # sendfile并不是发送文件, 而是设置磁盘和TCP Socket传输数据时直接通过系统缓存实现, 不再经过用户区的Read, write操作</span><br><span class="line">  sendfile     on;</span><br><span class="line">  # 设置在发送HTTP头文件时一次性全部发送, 而不是一个接一个的发送. (TODO)</span><br><span class="line">  tcp_nopush   on;</span><br><span class="line">  # TODO</span><br><span class="line">  server_names_hash_bucket_size 128; # this seems to be required for some vhosts</span><br><span class="line"></span><br><span class="line">  # 开启一个网络监听服务</span><br><span class="line">  server &#123; # php/fastcgi</span><br><span class="line">    # 该server监听的端口</span><br><span class="line">    listen       80;</span><br><span class="line">    # 绑定到的域名地址, 一般我们在主机都是使用localhost</span><br><span class="line">    server_name  domain1.com www.domain1.com;</span><br><span class="line">    # 该server生成的日志的保存地址</span><br><span class="line">    access_log   logs/domain1.access.log  main;</span><br><span class="line">    # 指定http请求中主机资源起始位置, 也就是`http://localhost:8090/`后面的位置</span><br><span class="line">    root         html;</span><br><span class="line"></span><br><span class="line">    # 所有请求以.php结尾的文件都到下面的代理地址中进行代理请求</span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">      fastcgi_pass   127.0.0.1:1025;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # 再设置一个网络服务</span><br><span class="line">  server &#123; # simple reverse-proxy</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  domain2.com www.domain2.com;</span><br><span class="line">    access_log   logs/domain2.access.log  main;</span><br><span class="line"></span><br><span class="line">    # serve static files</span><br><span class="line">    location ~ ^/(images|javascript|js|css|flash|media|static)/  &#123;</span><br><span class="line">      root    /var/www/virtual/big.server.com/htdocs;</span><br><span class="line">      expires 30d;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # 反向代理设置, 将/下所有的请求进行转发</span><br><span class="line">    location / &#123;</span><br><span class="line">      #设置反向代理的地址, 將80端口接受到的请求转发到localhost的8080端口上</span><br><span class="line">      proxy_pass      http://127.0.0.1:8080;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # 设置反向代理</span><br><span class="line">  upstream big_server_com &#123;</span><br><span class="line">    # 按照权重将代理过来的请求代理到俩个代理服务器上</span><br><span class="line">    server 127.0.0.3:8000 weight=5;</span><br><span class="line">    server 127.0.0.3:8001 weight=5;</span><br><span class="line">    server 192.168.0.1:8000;</span><br><span class="line">    server 192.168.0.1:8001;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  server &#123; # simple load balancing</span><br><span class="line">    listen          80;</span><br><span class="line">    server_name     big.server.com;</span><br><span class="line">    access_log      logs/big.server.access.log main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">      # 设置反向代理, 代理到big_server_com上(upstream刚刚定义的)</span><br><span class="line">      proxy_pass      http://big_server_com;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面谈到的location涉及到的内容较多, 我们单独介绍一下:</p>
<p>nginx location语法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location [=|~|~*|^~] /uri/ &#123; … &#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>=</code> 严格匹配。如果这个查询匹配，那么将停止搜索并立即处理此请求。</li>
<li><code>~</code> 为区分大小写匹配(可用正则表达式)</li>
<li><code>~*</code> 为不区分大小写匹配(可用正则表达式)</li>
<li><code>!~</code> 区分大小写不匹配</li>
<li><code>!~*</code> 不区分大小写不匹配</li>
<li><code>^~</code> 如果路径匹配那么不测试正则表达式。</li>
</ul>
<p>上面的配置引用里其他的配置文件,而且很多配置没有配置选项,下面是Nginx官网给出的另一种配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">user  www www;</span><br><span class="line">worker_processes  2;</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"># [ debug | info | notice | warn | error | crit ]</span><br><span class="line">error_log  /var/log/nginx.error_log  info;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">  worker_connections   2000;</span><br><span class="line">  # use [ kqueue | rtsig | epoll | /dev/poll | select | poll ] ;</span><br><span class="line">  use kqueue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">  include       conf/mime.types;</span><br><span class="line">  default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">  log_format main      &apos;$remote_addr - $remote_user [$time_local]  &apos;</span><br><span class="line">    &apos;&quot;$request&quot; $status $bytes_sent &apos;</span><br><span class="line">    &apos;&quot;$http_referer&quot; &quot;$http_user_agent&quot; &apos;</span><br><span class="line">    &apos;&quot;$gzip_ratio&quot;&apos;;</span><br><span class="line"></span><br><span class="line">  log_format download  &apos;$remote_addr - $remote_user [$time_local]  &apos;</span><br><span class="line">    &apos;&quot;$request&quot; $status $bytes_sent &apos;</span><br><span class="line">    &apos;&quot;$http_referer&quot; &quot;$http_user_agent&quot; &apos;</span><br><span class="line">    &apos;&quot;$http_range&quot; &quot;$sent_http_content_range&quot;&apos;;</span><br><span class="line"></span><br><span class="line">  # HTTP请求,客户端相关设置</span><br><span class="line">  client_header_timeout  3m;</span><br><span class="line">  client_body_timeout    3m;</span><br><span class="line">  send_timeout           3m;</span><br><span class="line"></span><br><span class="line">  client_header_buffer_size    1k;</span><br><span class="line">  large_client_header_buffers  4 4k;</span><br><span class="line"></span><br><span class="line">  # 消息发送时开启gzip设置</span><br><span class="line">  gzip on;</span><br><span class="line">  gzip_min_length  1100;</span><br><span class="line">  gzip_buffers     4 8k;</span><br><span class="line">  gzip_types       text/plain;</span><br><span class="line"></span><br><span class="line">  output_buffers   1 32k;</span><br><span class="line">  postpone_output  1460;</span><br><span class="line"></span><br><span class="line">  sendfile         on;</span><br><span class="line">  tcp_nopush       on;</span><br><span class="line"></span><br><span class="line">  tcp_nodelay      on;</span><br><span class="line">  send_lowat       12000;</span><br><span class="line"></span><br><span class="line">  keepalive_timeout  75 20;</span><br><span class="line"></span><br><span class="line">  # lingering_time     30;</span><br><span class="line">  # lingering_timeout  10;</span><br><span class="line">  # reset_timedout_connection  on;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  server &#123;</span><br><span class="line">    listen        one.example.com;</span><br><span class="line">    server_name   one.example.com  www.one.example.com;</span><br><span class="line"></span><br><span class="line">    access_log   /var/log/nginx.access_log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">      proxy_pass         http://127.0.0.1/;</span><br><span class="line">      proxy_redirect     off;</span><br><span class="line"></span><br><span class="line">      proxy_set_header   Host             $host;</span><br><span class="line">      proxy_set_header   X-Real-IP        $remote_addr;</span><br><span class="line">      # proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">      client_max_body_size       10m;</span><br><span class="line">      client_body_buffer_size    128k;</span><br><span class="line"></span><br><span class="line">      client_body_temp_path      /var/nginx/client_body_temp;</span><br><span class="line"></span><br><span class="line">      proxy_connect_timeout      90;</span><br><span class="line">      proxy_send_timeout         90;</span><br><span class="line">      proxy_read_timeout         90;</span><br><span class="line">      proxy_send_lowat           12000;</span><br><span class="line"></span><br><span class="line">      proxy_buffer_size          4k;</span><br><span class="line">      proxy_buffers              4 32k;</span><br><span class="line">      proxy_busy_buffers_size    64k;</span><br><span class="line">      proxy_temp_file_write_size 64k;</span><br><span class="line"></span><br><span class="line">      proxy_temp_path            /var/nginx/proxy_temp;</span><br><span class="line"></span><br><span class="line">      charset  koi8-r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page  404  /404.html;</span><br><span class="line"></span><br><span class="line">    location /404.html &#123;</span><br><span class="line">      root  /spool/www;</span><br><span class="line"></span><br><span class="line">      charset         on;</span><br><span class="line">      source_charset  koi8-r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /old_stuff/ &#123;</span><br><span class="line">      rewrite   ^/old_stuff/(.*)$  /new_stuff/$1  permanent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /download/ &#123;</span><br><span class="line">      valid_referers  none  blocked  server_names  *.example.com;</span><br><span class="line"></span><br><span class="line">      if ($invalid_referer) &#123;</span><br><span class="line">        #rewrite   ^/   http://www.example.com/;</span><br><span class="line">        return   403;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      # rewrite_log  on;</span><br><span class="line">      # rewrite /download/*/mp3/*.any_ext to /download/*/mp3/*.mp3</span><br><span class="line">      rewrite ^/(download/.*)/mp3/(.*)\..*$ /$1/mp3/$2.mp3 break;</span><br><span class="line"></span><br><span class="line">      root         /spool/www;</span><br><span class="line">      # autoindex    on;</span><br><span class="line">      access_log   /var/log/nginx-download.access_log  download;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~* ^.+\.(jpg|jpeg|gif)$ &#123;</span><br><span class="line">      root         /spool/www;</span><br><span class="line">      access_log   off;</span><br><span class="line">      expires      30d;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/05/nginx/nginx配置/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/05/nginx/nginx配置/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/05/JavaSE/ListVSMap/" title="List VS Map" itemprop="url">List VS Map</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-03-04T16:00:00.000Z" itemprop="datePublished"> Published 2016-03-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>在日常的使用中, 使用的最多的结构就是List和Map了. 其中又以ArrayList和HashMap使用的最多. 今天特意找了一些时间来看一下他们各自的实现以及添加索引数据时的性能.</p>
<p>首先看一下ArrayList.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> Object[] elementData;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!!</span></span><br><span class="line">    elementData[size++] = e;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    rangeCheck(index);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> elementData(index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>它的内部就是一个Object类型的数组, 在添加数据时首先确保数组不会越界, 如果会产生越界则内部进行数组扩容拷贝操作.</p>
<p>对于<code>HashMap</code>它的Javadoc中是如此说的:</p>
<p><code>HashMap</code>是hash table的一个实现。它与<code>HashTable</code>不同之处就是它是非同步的而且键值都支持null.对于put和get操作，HashMap的耗时都是固定的，不会因为Map的大小而变化。因为hash函数会将元素分配到不同的bucket里面取. HashMap的迭代操作与它的容量（bucket数量+键值对数量）成正比关系.</p>
<p>一般情况下, load factor的默认值0.75, 这个值在空间和时间上找到较为平衡的查找性能。 如果高于这个值的话，会减少空间占用但是会增加查询的消耗(这点反应在了大多数的hashMap操作中，包括get和put操作).</p>
<p>下来我们首先看一下它的数据成员<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// load factor 默认值</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hash表存储数据的数据结构, 每个Node都是一个散列桶, 每个桶里是一个链表</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;K,V&gt;[] table;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hash表散列桶的大小阀值, 如果超过这个值就对hash表进行拓容 (大小为: capacity * load factor)</span></span><br><span class="line"><span class="keyword">int</span> threshold;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hash表使用的loadFactor</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">float</span> loadFactor;</span><br></pre></td></tr></table></figure></p>
<p>然后我们看一下<code>put()</code>方法的实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,                    <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab;</span><br><span class="line">        Node&lt;K,V&gt; p;</span><br><span class="line">        <span class="keyword">int</span> n, i;</span><br><span class="line">        <span class="comment">// 如果table不存在或者table大小为0, 则重新生成一个table</span></span><br><span class="line">        <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            n = (tab = resize()).length;</span><br><span class="line">        <span class="comment">// 根据与hash值与操作找到要插入的元素所在的散列桶的位置</span></span><br><span class="line">        <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">// 发现当前位置上的散列桶上没有Node则,重新生成一个Node</span></span><br><span class="line">            tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 发现当前散列桶已经有元素了</span></span><br><span class="line">            Node&lt;K,V&gt; e; K k;</span><br><span class="line">            <span class="comment">// 判断插入key是否与找到的Node的key是否相等, 如果相等则将p赋值给e, 进行value的赋值操作</span></span><br><span class="line">            <span class="keyword">if</span> (p.hash == hash &amp;&amp; ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                e = p;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 插入的key与散列桶链表中的第一个元素不相符, 则遍历整个链表</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                    <span class="comment">// 在连表中找不到存在的元素, 则生成一个新的Node插入进来</span></span><br><span class="line">                    <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                        <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                            treeifyBin(tab, hash);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 找到了与要插入的key相等的散列表的元素, 则停止继续查找</span></span><br><span class="line">                    <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    p = e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 在散列表里找到了相同的key的hash值, 就直接插入了, 不再需要进行下面的hash表拓容操作</span></span><br><span class="line">            <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">                V oldValue = e.value;</span><br><span class="line">                <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                    e.value = value;</span><br><span class="line">                afterNodeAccess(e);</span><br><span class="line">                <span class="keyword">return</span> oldValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ++modCount;</span><br><span class="line">        <span class="comment">// 占有了一个新的hash桶, 判断如果超过了Hash表散列桶的阀值,则对hash表进行拓容</span></span><br><span class="line">        <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">            resize();</span><br><span class="line">        afterNodeInsertion(evict);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>从上面的逻辑我们可以看出,<code>HashMap</code>在插入元素的时候,首先是根据key的hash值找到散列桶的位置, 然后再根据key与散列桶中的散列表的数据进行便利查找.</p>
<p>因此我们应该尽量的调大HashMap的容量, 尽可能的让桶的容量大于元素的个数, 同时尽可能的保证key值hash函数的正确性, 否则如果元素过多但是桶的数量太少, 会将hash 表退化到链表结构, 将O(1)的查找复杂度变成O(N). 说完HashMap的查找复杂度, 我们再来看一下HashMap的内存占有, 每当我们插入一个新的元素的时候都会生成一个<code>Node</code>对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Node&lt;K,V&gt; next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JavaSE/">JavaSE</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/05/JavaSE/ListVSMap/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/05/JavaSE/ListVSMap/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/04/mgits/java游戏服务器/" title="Java游戏服务器设计" itemprop="url">Java游戏服务器设计</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-03-03T16:00:00.000Z" itemprop="datePublished"> Published 2016-03-04</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>从毕业就开始在游戏行业摸爬滚打,至今4年将至,今天特意总结一下这四年来的心得.</p>
<p>现在的游戏服务器大多采用Netty作为网络传输层,然后采用Reactor模型将消息转发到业务线程池中进行执行,然后在业务线程池中进行CPU计算,数据库IO操作,最后将结果返回给前端.</p>
<p>这样的游戏服务器在压测的时候在线玩家不会超过2000人,而且经常会出现比较大的延迟,因为有的IO操作真的很耗时. </p>
<p>在上个项目中我见到了这样一种设计,仍然是采用Netty完成网络层Socket数据读取发送工作,然后将解码出的数据扔到俩个消息队列里面去(采用Vertx的EventBus实现). 一个消息队列负责登录请求,一个消息队列负责整个游戏的业务逻辑. 这么着一来整个游戏的业务就不会出现数据竞争的情况. 然后再定时的将数据写到redis里面去. 这种设计在压测的时候达到了10000人的同时在线规模. (当然还有很多优化的地方, 例如在消息查找的时候采取ASM而不是低效的JDK反射, 但是并没有对JVM和Netty进行过特殊优化, 只是对JVM的新生代的分区将8:1:1改成了6:2:2)</p>
<p>前俩天和一些游戏团队的人聊了聊,他们一致认为这种设计方式没有能充分的利用上主机多核的优势, 但是在Reactor的模型中, 主线程池和工作线程池都是需要CPU来运算的, 如果所有的CPU运算都来支持业务逻辑, 那么玩家一样会感觉到卡顿. 而且我们还可以对刚才的设计进行优化, 将不同模块业务放到不同的线程进行. 例如在Thread1中进行玩家自己的业务逻辑运算, 在Thread2中进行公会模块的业务计算, 当公会对玩家本身数据产生影响的时候, 我们可以让公会线程给玩家的业务线程发送消息(同样的使用消息队列). 这么着也能最大可能的利用多核优势同时让开发人员少的思考数据竞争出现的问题, 现在大多数的开发人员在处理数据竞争的时候还是较多的使用synchronized这种加锁方式(有些底层的接口也有可能使用读写锁, 但是使用锁, 在大规模用户的情况下,真的比较耗时).</p>
<p>还有一点需要说的是, 在上个项目中,只使用到了很少的数据库表, 基本上玩家数据都存储到了一张表里, 当定时存储的时候,将玩家数据整个序列化成一个JSON串, 然后入库. 这么做有显而易见的好处,在分服的游戏中, 合服很容易而且在线上出现问题的时候,也很容易拿到一个玩家的数据进行问题排查. 而且在线上的时候也会出现因为异常而导致玩家刷材料等等, 因此如果在处理消息之前, 拿一个玩家备份的数据让玩家去操作,一旦出现数据异常也不会对玩家自己的数据造成影响. (需要考虑的是大量的序列号和反序列化会造成大量的GC操作.)</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/mgits/">mgits</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/04/mgits/java游戏服务器/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/04/mgits/java游戏服务器/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/02/redis/jedis/" title="Jedis 初探" itemprop="url">Jedis 初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-03-01T16:00:00.000Z" itemprop="datePublished"> Published 2016-03-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="using-Jedis-in-a-multithreaded-environment"><a href="#using-Jedis-in-a-multithreaded-environment" class="headerlink" title="using Jedis in a multithreaded environment"></a>using Jedis in a multithreaded environment</h2><p>我们不应该在多线程的情况下使用同一个Jedis实例对象, 因为在Jedis本身不是线程安全的, 它可能会引发一些奇奇怪怪的问题. 但是如果我们在每个线程中都创建一个Jedis实例对象的话这也是不可取的, 因为每个Jedis对象的创建都意味着socket和网络连接的创建. 为了避免这种情况,我们应该使用<code>JedisPool</code>, 它是一个线程安全的网络连接池. 我们可以通过池子创建多个Jedis实例对象, 当使用完之后再将它返回给池子.</p>
<p>在下面的实例中我们初始化一个池子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JedisPool pool = <span class="keyword">new</span> JedisPool(<span class="keyword">new</span> JedisPoolConfig(), <span class="string">"localhost"</span>);</span><br></pre></td></tr></table></figure></p>
<p>因为JedisPool是线程安全的, 因此我们可以将它缓存起来, 供所有线程使用.</p>
<p><code>JedisPoolConfig</code>包含了一个丰富有用的Redis连接配置参数. <code>JedisPoolConfig</code>基于<a href="http://commons.apache.org/proper/commons-pool/apidocs/org/apache/commons/pool2/impl/GenericObjectPoolConfig.html" target="_blank" rel="external">Commons Pool 2</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Jedis implements Closable. Hence, the jedis instance will be auto-closed after the last statement.</span></span><br><span class="line"><span class="keyword">try</span> (Jedis jedis = pool.getResource()) &#123;</span><br><span class="line">  <span class="comment">/// ... do stuff here ... for example</span></span><br><span class="line">  jedis.set(<span class="string">"foo"</span>, <span class="string">"bar"</span>);</span><br><span class="line">  String foobar = jedis.get(<span class="string">"foo"</span>);</span><br><span class="line">  jedis.zadd(<span class="string">"sose"</span>, <span class="number">0</span>, <span class="string">"car"</span>); jedis.zadd(<span class="string">"sose"</span>, <span class="number">0</span>, <span class="string">"bike"</span>);</span><br><span class="line">  Set&lt;String&gt; sose = jedis.zrange(<span class="string">"sose"</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// ... when closing your application:</span></span><br><span class="line">pool.destroy();</span><br></pre></td></tr></table></figure>
<p>如果你不喜欢<code>try-with-resource</code>这种语法, 那么你可以使用<code>Jedis.close()</code>.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  jedis = pool.getResource();</span><br><span class="line">  <span class="comment">/// ... do stuff here ... for example</span></span><br><span class="line">  jedis.set(<span class="string">"foo"</span>, <span class="string">"bar"</span>);</span><br><span class="line">  String foobar = jedis.get(<span class="string">"foo"</span>);</span><br><span class="line">  jedis.zadd(<span class="string">"sose"</span>, <span class="number">0</span>, <span class="string">"car"</span>); jedis.zadd(<span class="string">"sose"</span>, <span class="number">0</span>, <span class="string">"bike"</span>);</span><br><span class="line">  Set&lt;String&gt; sose = jedis.zrange(<span class="string">"sose"</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">    jedis.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// ... when closing your application:</span></span><br><span class="line">pool.destroy();</span><br></pre></td></tr></table></figure></p>
<p>If Jedis was borrowed from pool, it will be returned to pool with proper method since it already determines there was JedisConnectionException occurred. If Jedis wasn’t borrowed from pool, it will be disconnected and closed.</p>
<p>下来我们来看一段测试代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JedisTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JedisPoolConfig jedisPoolConfig = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        jedisPoolConfig.setMaxTotal(<span class="number">10</span>);</span><br><span class="line">        JedisPool pool = <span class="keyword">new</span> JedisPool(jedisPoolConfig, <span class="string">"10.1.4.110"</span>);</span><br><span class="line">        System.out.println(<span class="string">"begin : "</span> + pool.getNumActive());</span><br><span class="line">        System.out.println(<span class="string">"begin : "</span> + pool.getNumIdle());</span><br><span class="line">        System.out.println(<span class="string">"begin : "</span> + pool.getNumWaiters());</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = pool.getResource();</span><br><span class="line">            System.out.println(<span class="string">"borrow : "</span> + pool.getNumActive());</span><br><span class="line">            System.out.println(<span class="string">"borrow : "</span> + pool.getNumIdle());</span><br><span class="line">            System.out.println(<span class="string">"borrow : "</span> + pool.getNumWaiters());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"return : "</span> + pool.getNumActive());</span><br><span class="line">        System.out.println(<span class="string">"return : "</span> + pool.getNumIdle());</span><br><span class="line">        System.out.println(<span class="string">"return : "</span> + pool.getNumWaiters());</span><br><span class="line">        pool.destroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">begin : <span class="number">0</span></span><br><span class="line">begin : <span class="number">0</span></span><br><span class="line">begin : <span class="number">0</span></span><br><span class="line">borrow : <span class="number">1</span></span><br><span class="line">borrow : <span class="number">0</span></span><br><span class="line">borrow : <span class="number">0</span></span><br><span class="line"><span class="keyword">return</span> : <span class="number">0</span></span><br><span class="line"><span class="keyword">return</span> : <span class="number">1</span></span><br><span class="line"><span class="keyword">return</span> : <span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<p>当调用<code>jedis.close();</code>后,池子里空闲的Jedis对象就多了1个, 可是如果我们注释掉这一行后的结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">begin : <span class="number">0</span></span><br><span class="line">begin : <span class="number">0</span></span><br><span class="line">begin : <span class="number">0</span></span><br><span class="line">borrow : <span class="number">1</span></span><br><span class="line">borrow : <span class="number">0</span></span><br><span class="line">borrow : <span class="number">0</span></span><br><span class="line"><span class="keyword">return</span> : <span class="number">1</span></span><br><span class="line"><span class="keyword">return</span> : <span class="number">0</span></span><br><span class="line"><span class="keyword">return</span> : <span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<p>我们发现那个Jedis仍然处于激活状态, 在Jedis 2.8.0版本以前当我们从池子里借用一个Jedis之后还需要将其还回去<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Jedis resource)</span> </span>&#123;</span><br><span class="line">    jedisPool.returnResource(resource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但是现在已经不需要了, 而且Jedis已经将这个<code>returnResource()</code>的方法舍弃掉了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnResource</span><span class="params">(Jedis resource)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(resource != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            resource.resetState();</span><br><span class="line">            <span class="keyword">this</span>.returnResourceObject(resource);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var3) &#123;</span><br><span class="line">            <span class="keyword">this</span>.returnBrokenResource(resource);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JedisException(<span class="string">"Could not return the resource to the pool"</span>, var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来我们看一下多线程情况<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JedisTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        JedisPoolConfig jedisPoolConfig = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        jedisPoolConfig.setMaxTotal(<span class="number">3</span>);</span><br><span class="line">        JedisPool pool = <span class="keyword">new</span> JedisPool(jedisPoolConfig, <span class="string">"10.1.4.110"</span>);</span><br><span class="line">        List&lt;Thread&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            Runnable runnable = () -&gt; &#123;</span><br><span class="line">                Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    jedis = pool.getResource();</span><br><span class="line">                    <span class="keyword">int</span> sleep = <span class="keyword">new</span> Random().nextInt(<span class="number">5</span>);</span><br><span class="line">                    System.out.println(<span class="string">"sleep:"</span> + sleep + <span class="string">". time:"</span> + <span class="keyword">new</span> Date().toLocaleString() + <span class="string">". active: "</span> + pool.getNumActive() + <span class="string">". idle: "</span> + pool.getNumIdle());</span><br><span class="line"></span><br><span class="line">                    TimeUnit.SECONDS.sleep(sleep);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        jedis.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            list.add(<span class="keyword">new</span> Thread(runnable));</span><br><span class="line">        &#125;</span><br><span class="line">        list.forEach(thread -&gt; thread.start());</span><br><span class="line"></span><br><span class="line">        Thread.currentThread().join();</span><br><span class="line">        pool.destroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sleep:<span class="number">4</span>. time:<span class="number">2016</span>-<span class="number">3</span>-<span class="number">4</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">03</span>. active: <span class="number">3</span>. idle: <span class="number">0</span></span><br><span class="line">sleep:<span class="number">4</span>. time:<span class="number">2016</span>-<span class="number">3</span>-<span class="number">4</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">03</span>. active: <span class="number">3</span>. idle: <span class="number">0</span></span><br><span class="line">sleep:<span class="number">3</span>. time:<span class="number">2016</span>-<span class="number">3</span>-<span class="number">4</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">03</span>. active: <span class="number">3</span>. idle: <span class="number">0</span></span><br><span class="line">sleep:<span class="number">3</span>. time:<span class="number">2016</span>-<span class="number">3</span>-<span class="number">4</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">06</span>. active: <span class="number">3</span>. idle: <span class="number">0</span></span><br><span class="line">sleep:<span class="number">3</span>. time:<span class="number">2016</span>-<span class="number">3</span>-<span class="number">4</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">07</span>. active: <span class="number">2</span>. idle: <span class="number">1</span></span><br></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Reids/">Reids</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/02/redis/jedis/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/02/redis/jedis/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/02/22/netty/ServerBootstrap/" title="NettyServerBootstrap" itemprop="url">NettyServerBootstrap</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-02-21T16:00:00.000Z" itemprop="datePublished"> Published 2016-02-22</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我们首先给出一个Netty上的一个Example示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> cpuSize = Runtime.getRuntime().availableProcessors();</span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup(cpuSize);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">            b.group(bossGroup, workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">                    .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</span><br><span class="line">                    .option(ChannelOption.AUTO_READ, <span class="keyword">true</span>)</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> </span>&#123;</span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> InHandler());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            ChannelFuture f = b.bind(<span class="number">8881</span>).sync();</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> </span>&#123;</span><br><span class="line">        ctx.write(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在这个示例中, 我们采用了主从Reactor线程模型, 添加了Netty内置的Protobuf编码器. 同时后端业务线程的处理我们也采用了线程池串行的方式.</p>
<p>下来我们分析一下<code>ServerBootstrap</code>的源码. 我们从<code>bind()</code>方法入手. <code>bind()</code>最终调用的是父类的<code>doBind()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ChannelFuture <span class="title">doBind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress)</span> </span>&#123;</span><br><span class="line">				<span class="comment">// 初始化NioServerSocketChannel</span></span><br><span class="line">        <span class="keyword">final</span> ChannelFuture regFuture = initAndRegister();</span><br><span class="line">        <span class="keyword">final</span> Channel channel = regFuture.channel();</span><br><span class="line">        <span class="keyword">if</span> (regFuture.cause() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> regFuture;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (regFuture.isDone()) &#123;</span><br><span class="line">            ChannelPromise promise = channel.newPromise();</span><br><span class="line">            doBind0(regFuture, channel, localAddress, promise);</span><br><span class="line">            <span class="keyword">return</span> promise;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">return</span> promise;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来我们看一下<code>initAndRegister()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ChannelFuture <span class="title">initAndRegister</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="comment">// 因为我们调用过channel(NioServerSocketChannel.class)方法, 因此下面这个Channel是NioServerSocketChannel类型</span></span><br><span class="line">        <span class="keyword">final</span> Channel channel = channelFactory().newChannel();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">					  <span class="comment">// 当channel接受到网络连接的时候, 会生成NioSocketChannel, 将NioSocketChannel与从Reactor进行绑定</span></span><br><span class="line">            init(channel);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 将Reactor模型中的主Reactor线程注册到NioServerSocketChannel的Unsafe对象里.</span></span><br><span class="line">				<span class="comment">// 此时就将NioServerSocketChannel与Reactor主线程关联起来了</span></span><br><span class="line">				ChannelFuture regFuture = group().register(channel);</span><br><span class="line">        <span class="keyword">if</span> (regFuture.cause() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (channel.isRegistered()) &#123;</span><br><span class="line">                channel.close();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                channel.unsafe().closeForcibly();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>init()</code>的具体实现是由子类<code>ServerBootstrap</code>实现的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">			 <span class="comment">// 获取NioServerSocketChannel的Pipeline</span></span><br><span class="line">			 ChannelPipeline p = channel.pipeline();</span><br><span class="line">			 <span class="keyword">if</span> (handler() != <span class="keyword">null</span>) &#123;</span><br><span class="line">					 p.addLast(handler());</span><br><span class="line">			 &#125;</span><br><span class="line"></span><br><span class="line">			 <span class="keyword">final</span> EventLoopGroup currentChildGroup = childGroup;</span><br><span class="line">			 <span class="keyword">final</span> ChannelHandler currentChildHandler = childHandler;</span><br><span class="line">			 <span class="keyword">final</span> Entry&lt;ChannelOption&lt;?&gt;, Object&gt;[] currentChildOptions;</span><br><span class="line">			 <span class="keyword">final</span> Entry&lt;AttributeKey&lt;?&gt;, Object&gt;[] currentChildAttrs;</span><br><span class="line"></span><br><span class="line">			 p.addLast(<span class="keyword">new</span> ChannelInitializer&lt;Channel&gt;() &#123;</span><br><span class="line">					 <span class="meta">@Override</span></span><br><span class="line">					 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(Channel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">						 	 <span class="comment">// 这里主要是产生网络连接时将处理数据的channel与Reactor从线程关联起来</span></span><br><span class="line">							 ch.pipeline().addLast(<span class="keyword">new</span> ServerBootstrapAcceptor(</span><br><span class="line">											 currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));</span><br><span class="line">					 &#125;</span><br><span class="line">			 &#125;);</span><br><span class="line">	 &#125;</span><br></pre></td></tr></table></figure></p>
<p>我们看到<code>ServerBootstrapAcceptor</code>也是实现自<code>ChannelInboundHandlerAdapter</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerBootstrapAcceptor</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> EventLoopGroup childGroup;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ChannelHandler childHandler;</span><br><span class="line">        ServerBootstrapAcceptor(</span><br><span class="line">                EventLoopGroup childGroup, ChannelHandler childHandler) &#123;</span><br><span class="line">            <span class="keyword">this</span>.childGroup = childGroup;</span><br><span class="line">            <span class="keyword">this</span>.childHandler = childHandler;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Channel child = (Channel) msg;</span><br><span class="line">            child.pipeline().addLast(childHandler);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">							  <span class="comment">// 将处理数据的NioSocketChannel与主从Reactor模型中的从Reactor线程关联起来</span></span><br><span class="line">                childGroup.register(child).addListener(<span class="keyword">new</span> ChannelFutureListener());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>然后我们看一下<code>NioEventLoop</code>的<code>register()</code>方法过程. 这个方法调用其实最终调用的是<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SingleThreadEventLoop</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">	 <span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">register</span><span class="params">(<span class="keyword">final</span> Channel channel, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</span><br><span class="line">			 channel.unsafe().register(<span class="keyword">this</span>, promise);</span><br><span class="line">			 <span class="keyword">return</span> promise;</span><br><span class="line">	 &#125;</span><br></pre></td></tr></table></figure></p>
<p>然后后续调用到了<code>AbstractUnsafe</code>的<code>register()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(EventLoop eventLoop, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</span><br><span class="line">              AbstractChannel.<span class="keyword">this</span>.eventLoop = eventLoop;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (eventLoop.inEventLoop()) &#123;</span><br><span class="line">                register0(promise);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    eventLoop.execute(<span class="keyword">new</span> OneTimeTask() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            register0(promise);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">				<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register0</span><span class="params">(ChannelPromise promise)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                doRegister();</span><br><span class="line">                pipeline.fireChannelRegistered();</span><br><span class="line">                <span class="comment">// Only fire a channelActive if the channel has never been registered. This prevents firing</span></span><br><span class="line">                <span class="comment">// multiple channel actives if the channel is deregistered and re-registered.</span></span><br><span class="line">                <span class="keyword">if</span> (firstRegistration &amp;&amp; isActive()) &#123;</span><br><span class="line">                    pipeline.fireChannelActive();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>接着调用<code>AbstractNioChannel</code>的<code>doRegister()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegister</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> selected = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                selectionKey = javaChannel().register(eventLoop().selector, <span class="number">0</span>, <span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>最终我们看到了, 当前JDK里的Channel注册到了EventLoop的IO多路复用器上面</p>
<p>看到这里之后, 我们再接着返回到<code>doBind()</code>方法继续看<code>doBind0()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doBind0</span><span class="params">(</span><br><span class="line">            <span class="keyword">final</span> ChannelFuture regFuture, <span class="keyword">final</span> Channel channel,</span><br><span class="line">            <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This method is invoked before channelRegistered() is triggered.  Give user handlers a chance to set up</span></span><br><span class="line">        <span class="comment">// the pipeline in its channelRegistered() implementation.</span></span><br><span class="line">        channel.eventLoop().execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (regFuture.isSuccess()) &#123;</span><br><span class="line">                    channel.bind(localAddress, promise).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    promise.setFailure(regFuture.cause());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>我们看到当在bind的时候也是调用的channel的bind(), 真实的bind是在<code>AbstractChannel</code>里发生的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> pipeline.bind(localAddress, promise);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后调用的是<code>DefaultChannelPipeline</code>的<code>bind()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;</span><br><span class="line">		 <span class="keyword">return</span> tail.bind(localAddress, promise);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>再具体的bind的话, 就要参考<code>DeaultChannelPipeline</code>的实现了</p>
<p>最后我们总结一下</p>
<ol>
<li>首先将NioServerSocketChannel与主Reactor线程池的Selector进行注册绑定</li>
<li>当NioServerSocketChannel接收到网络连接的时候(doReadMessage())会生成一个<code>NioSocketChannel</code>的消息列表</li>
<li>然后<code>ServerBootstrapAcceptor</code>负责将<code>NioSocketChannel</code>与从Reactor的Selector进行注册绑定</li>
<li>最后由从Reactor线程池中的Selector进行IO调度, 读写网络数据</li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Netty/">Netty</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/02/22/netty/ServerBootstrap/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/02/22/netty/ServerBootstrap/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/02/03/序列化工具/MessagePack 初探/" title="MessagePack 初探" itemprop="url">MessagePack 初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-02-02T16:00:00.000Z" itemprop="datePublished"> Published 2016-02-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>MessagePack 是一个高效的二进制数据序列化工具. 使用它可以让你像使用JSON那样在多种语言中进行数据交换, 但是它比JSON更加小巧,迅捷.</p>
<p>在Java中使用的话, 我们首先添加maven依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.msgpack<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>msgpack<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>首先看一个简单的示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.msgpack.MessagePack;</span><br><span class="line"><span class="keyword">import</span> org.msgpack.annotation.Message;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main1</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Message</span> <span class="comment">// Annotation</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMessage</span> </span>&#123;</span><br><span class="line">        <span class="comment">// public fields are serialized.</span></span><br><span class="line">        <span class="keyword">public</span> String name;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">double</span> version;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        MyMessage src = <span class="keyword">new</span> MyMessage();</span><br><span class="line">        src.name = <span class="string">"msgpack"</span>;</span><br><span class="line">        src.version = <span class="number">0.6</span>;</span><br><span class="line"></span><br><span class="line">        MessagePack msgpack = <span class="keyword">new</span> MessagePack();</span><br><span class="line">        <span class="comment">// Serialize</span></span><br><span class="line">        <span class="keyword">byte</span>[] bytes = msgpack.write(src);</span><br><span class="line">        <span class="comment">// Deserialize</span></span><br><span class="line">        MyMessage dst = msgpack.read(bytes, MyMessage.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在上面的例子中我们看到将一个<code>MyMessage</code>序列化成byte数组, 同时又将其反序列化出来了. 但是如果我们要同时序列化多个对象呢？那么我们就可以使用<code>Packer</code>和<code>Unpacker</code>.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.msgpack.MessagePack;</span><br><span class="line"><span class="keyword">import</span> org.msgpack.annotation.Message;</span><br><span class="line"><span class="keyword">import</span> org.msgpack.packer.Packer;</span><br><span class="line"><span class="keyword">import</span> org.msgpack.unpacker.Unpacker;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main2</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Message</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMessage</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> String name;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">double</span> version;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        MyMessage src1 = <span class="keyword">new</span> MyMessage();</span><br><span class="line">        src1.name = <span class="string">"msgpack"</span>;</span><br><span class="line">        src1.version = <span class="number">0.6</span>;</span><br><span class="line">        MyMessage src2 = <span class="keyword">new</span> MyMessage();</span><br><span class="line">        src2.name = <span class="string">"muga"</span>;</span><br><span class="line">        src2.version = <span class="number">10.0</span>;</span><br><span class="line">        MyMessage src3 = <span class="keyword">new</span> MyMessage();</span><br><span class="line">        src3.name = <span class="string">"frsyukik"</span>;</span><br><span class="line">        src3.version = <span class="number">1.0</span>;</span><br><span class="line"></span><br><span class="line">        MessagePack msgpack = <span class="keyword">new</span> MessagePack();</span><br><span class="line">        <span class="comment">// Serialize</span></span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        Packer packer = msgpack.createPacker(out);</span><br><span class="line">        packer.write(src1);</span><br><span class="line">        packer.write(src2);</span><br><span class="line">        packer.write(src3);</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = out.toByteArray();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Deserialize</span></span><br><span class="line">        ByteArrayInputStream in = <span class="keyword">new</span> ByteArrayInputStream(bytes);</span><br><span class="line">        Unpacker unpacker = msgpack.createUnpacker(in);</span><br><span class="line">        MyMessage dst1 = unpacker.read(MyMessage.class);</span><br><span class="line">        MyMessage dst2 = unpacker.read(MyMessage.class);</span><br><span class="line">        MyMessage dst3 = unpacker.read(MyMessage.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其实<code>Packer</code>和<code>Unpacker</code>内置了非常多了序列化类型<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.math.BigInteger;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.msgpack.MessagePack;</span><br><span class="line"><span class="keyword">import</span> org.msgpack.packer.Packer;</span><br><span class="line"><span class="keyword">import</span> org.msgpack.unpacker.Unpacker;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        MessagePack msgpack = <span class="keyword">new</span> MessagePack();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Serialization</span></span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        Packer packer = msgpack.createPacker(out);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对原生类型进行序列化</span></span><br><span class="line">        packer.write(<span class="keyword">true</span>); <span class="comment">// boolean value</span></span><br><span class="line">        packer.write(<span class="number">10</span>); <span class="comment">// int value</span></span><br><span class="line">        packer.write(<span class="number">10.5</span>); <span class="comment">// double value</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对原生包装类型进行序列化</span></span><br><span class="line">        packer.write(Boolean.TRUE);</span><br><span class="line">        packer.write(<span class="keyword">new</span> Integer(<span class="number">10</span>));</span><br><span class="line">        packer.write(<span class="keyword">new</span> Double(<span class="number">10.5</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对数组进行序列化</span></span><br><span class="line">        packer.write(<span class="keyword">new</span> <span class="keyword">int</span>[] &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span> &#125;);</span><br><span class="line">        packer.write(<span class="keyword">new</span> Double[] &#123; <span class="number">10.5</span>, <span class="number">20.5</span> &#125;);</span><br><span class="line">        packer.write(<span class="keyword">new</span> String[] &#123; <span class="string">"msg"</span>, <span class="string">"pack"</span>, <span class="string">"for"</span>, <span class="string">"java"</span> &#125;);</span><br><span class="line">        packer.write(<span class="keyword">new</span> <span class="keyword">byte</span>[] &#123; <span class="number">0x30</span>, <span class="number">0x31</span>, <span class="number">0x32</span> &#125;); <span class="comment">// byte array</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对其他引用类型进行序列化</span></span><br><span class="line">        packer.write(<span class="string">"MessagePack"</span>); <span class="comment">// String object</span></span><br><span class="line">        packer.write(ByteBuffer.wrap(<span class="keyword">new</span> <span class="keyword">byte</span>[] &#123; <span class="number">0x30</span>, <span class="number">0x31</span>, <span class="number">0x32</span> &#125;)); <span class="comment">// ByteBuffer object</span></span><br><span class="line">        packer.write(BigInteger.ONE); <span class="comment">// BigInteger object</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        <span class="keyword">byte</span>[] bytes = out.toByteArray();</span><br><span class="line">        ByteArrayInputStream in = <span class="keyword">new</span> ByteArrayInputStream(bytes);</span><br><span class="line">        Unpacker unpacker = msgpack.createUnpacker(in);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化出原生类型</span></span><br><span class="line">        <span class="keyword">boolean</span> b = unpacker.readBoolean(); <span class="comment">// boolean value</span></span><br><span class="line">        <span class="keyword">int</span> i = unpacker.readInt(); <span class="comment">// int value</span></span><br><span class="line">        <span class="keyword">double</span> d = unpacker.readDouble(); <span class="comment">// double value</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化出原生包装类型</span></span><br><span class="line">        Boolean wb = unpacker.read(Boolean.class);</span><br><span class="line">        Integer wi = unpacker.read(Integer.class);</span><br><span class="line">        Double wd = unpacker.read(Double.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化出数组</span></span><br><span class="line">        <span class="keyword">int</span>[] ia = unpacker.read(<span class="keyword">int</span>[].class);</span><br><span class="line">        Double[] da = unpacker.read(Double[].class);</span><br><span class="line">        String[] sa = unpacker.read(String[].class);</span><br><span class="line">        <span class="keyword">byte</span>[] ba = unpacker.read(<span class="keyword">byte</span>[].class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化出 String, ByteBuffer, BigInteger, List 和 Map</span></span><br><span class="line">        String ws = unpacker.read(String.class);</span><br><span class="line">        ByteBuffer buf = unpacker.read(ByteBuffer.class);</span><br><span class="line">        BigInteger bi = unpacker.read(BigInteger.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于<code>List, Map</code>这俩种类型的序列化, 我们需要额外说明一下. 在序列化<code>List, Map</code>的时候, 我们需要使用<code>Template</code>对其进行转换.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.msgpack.MessagePack;</span><br><span class="line"><span class="keyword">import</span> org.msgpack.packer.Packer;</span><br><span class="line"><span class="keyword">import</span> org.msgpack.template.Template;</span><br><span class="line"><span class="keyword">import</span> org.msgpack.unpacker.Unpacker;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.msgpack.template.Templates.tList;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.msgpack.template.Templates.tMap;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.msgpack.template.Templates.TString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        MessagePack msgpack = <span class="keyword">new</span> MessagePack();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 创建序列化/反序列化 List 和 Map 对象的模板</span></span><br><span class="line">		Template&lt;List&lt;String&gt;&gt; listTmpl = tList(TString);</span><br><span class="line">		Template&lt;Map&lt;String, String&gt;&gt; mapTmpl = tMap(TString, TString);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 开始序列化</span></span><br><span class="line">		ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">		Packer packer = msgpack.createPacker(out);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 序列化 List 对象</span></span><br><span class="line">		List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">		list.add(<span class="string">"msgpack"</span>);</span><br><span class="line">		list.add(<span class="string">"for"</span>);</span><br><span class="line">		list.add(<span class="string">"java"</span>);</span><br><span class="line">		packer.write(list); <span class="comment">// List object</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 序列化 Map 对象</span></span><br><span class="line">		Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">		map.put(<span class="string">"sadayuki"</span>, <span class="string">"furuhashi"</span>);</span><br><span class="line">		map.put(<span class="string">"muga"</span>, <span class="string">"nishizawa"</span>);</span><br><span class="line">		packer.write(map); <span class="comment">// Map object</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 开始反序列化</span></span><br><span class="line">		<span class="keyword">byte</span>[] bytes = out.toByteArray();</span><br><span class="line">		ByteArrayInputStream in = <span class="keyword">new</span> ByteArrayInputStream(bytes);</span><br><span class="line">		Unpacker unpacker = msgpack.createUnpacker(in);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 反序列化出 List 对象</span></span><br><span class="line">		List&lt;String&gt; dstList = unpacker.read(listTmpl);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//  反序列化出 Map 对象</span></span><br><span class="line">		Map&lt;String, String&gt; dstMap = unpacker.read(mapTmpl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>有时候我们可能没有办法将POJO类添加上<code>Message</code>注解(可能没有访问那个类的权限), 但是我们又想对其进行序列化, 那怎么办呢？<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MessagePack msgpack = <span class="keyword">new</span> MessagePack();</span><br><span class="line">msgpack.<span class="keyword">register</span>(MyMessage2.<span class="keyword">class</span>);</span><br></pre></td></tr></table></figure></p>
<p>我们只要向需要序列化的类注册到<code>MessagePack</code>上就可以了.</p>
<p>有时候,我们可能不需要对某个属性进行序列化, 例如线上某个老版本里并没有A属性, 但是在新的版本里填上了A属性, 但是又要兼容老版本怎么办呢？我们可以使用<code>@Optional</code>注解<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Message</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMessage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">double</span> version;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new field</span></span><br><span class="line">    <span class="meta">@Optional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> flag = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>MessagePack还提供了动态类型特性.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.msgpack.MessagePack;</span><br><span class="line"><span class="keyword">import</span> org.msgpack.type.Value;</span><br><span class="line"><span class="keyword">import</span> org.msgpack.unpacker.Converter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.msgpack.template.Templates.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main5</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// Create serialize objects.</span></span><br><span class="line">        List&lt;String&gt; src = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        src.add(<span class="string">"msgpack"</span>);</span><br><span class="line">        src.add(<span class="string">"kumofs"</span>);</span><br><span class="line">        src.add(<span class="string">"viver"</span>);</span><br><span class="line"></span><br><span class="line">        MessagePack msgpack = <span class="keyword">new</span> MessagePack();</span><br><span class="line">        <span class="comment">// Serialize</span></span><br><span class="line">        <span class="keyword">byte</span>[] raw = msgpack.write(src);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Deserialize directly using a template</span></span><br><span class="line">        List&lt;String&gt; dst1 = msgpack.read(raw, tList(TString));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Or, Deserialze to Value then convert type.</span></span><br><span class="line">        Value dynamic = msgpack.read(raw);</span><br><span class="line">        List&lt;String&gt; dst2 = <span class="keyword">new</span> Converter(dynamic).read(tList(TString));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当从MessagePack里读取数据的时候, 我们可以先不指定其转换的类型,　使用<code>Value</code>来代替, 等后期我们再使用<code>Converter</code> 对其转换.</p>
<p>接下来我们对其与JSON进行对比<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">msgpack</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		MessagePack msgpack = <span class="keyword">new</span> MessagePack();</span><br><span class="line"></span><br><span class="line">		List&lt;SeObj&gt; list = list();</span><br><span class="line">		<span class="keyword">long</span> start1 = System.currentTimeMillis();</span><br><span class="line">		<span class="keyword">byte</span>[] bytes1 = msgpack.write(list);</span><br><span class="line">		<span class="keyword">long</span> end1 = System.currentTimeMillis();</span><br><span class="line">		System.out.println((end1 - start1) + <span class="string">" : "</span> + bytes1.length);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">long</span> start2 = System.currentTimeMillis();</span><br><span class="line">		String json = JSON.toJSONString(list);</span><br><span class="line">		<span class="keyword">long</span> end2 = System.currentTimeMillis();</span><br><span class="line">		System.out.println((end2 - start2) + <span class="string">" : "</span> + json.getBytes().length);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;SeObj&gt; <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		List&lt;SeObj&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		Random random = <span class="keyword">new</span> Random();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">			SeObj seObj = <span class="keyword">new</span> SeObj();</span><br><span class="line">			seObj.id = random.nextInt(<span class="number">100000</span>);</span><br><span class="line">			seObj.tall = random.nextFloat();</span><br><span class="line">			seObj.name = <span class="string">"name"</span> + random.nextInt(<span class="number">100000</span>);</span><br><span class="line">			list.add(seObj);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> list;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Message</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SeObj</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> id;</span><br><span class="line">	<span class="keyword">public</span> String name;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">float</span> tall;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">100</span>的结果</span><br><span class="line"><span class="number">194</span> : <span class="number">1960</span></span><br><span class="line"><span class="number">50</span> : <span class="number">4947</span></span><br><span class="line"><span class="number">1000</span>的结果</span><br><span class="line"><span class="number">210</span> : <span class="number">19589</span></span><br><span class="line"><span class="number">70</span> : <span class="number">49424</span></span><br><span class="line"><span class="number">10000</span>的结果</span><br><span class="line"><span class="number">212</span> : <span class="number">195765</span></span><br><span class="line"><span class="number">160</span> : <span class="number">493987</span></span><br><span class="line"><span class="number">100000</span>的结果</span><br><span class="line"><span class="number">283</span> : <span class="number">1956964</span></span><br><span class="line"><span class="number">330</span> : <span class="number">4940270</span></span><br><span class="line"><span class="number">1000000</span>的结果</span><br><span class="line"><span class="number">649</span> : <span class="number">19573508</span></span><br><span class="line"><span class="number">1878</span> : <span class="number">49404120</span></span><br></pre></td></tr></table></figure></p>
<p>我们发现MessagePack的耗时相对来说是比较稳定的, 但是在生成的数据量上比JSON要强一倍多</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/序列化工具/">序列化工具</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/02/03/序列化工具/MessagePack 初探/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/02/03/序列化工具/MessagePack 初探/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/02/02/netty/ChannelPipeline/" title="Netty ChannelPipeline" itemprop="url">Netty ChannelPipeline</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-02-01T16:00:00.000Z" itemprop="datePublished"> Published 2016-02-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><code>ChannelPipeline</code>是一个<code>ChannelHandler</code>的集合, 用于处理或者截断<code>Channel</code>的<code>inbound events</code>和<code>outbound operations</code>. <code>ChannelPipeline</code>是<a href="http://www.oracle.com/technetwork/java/interceptingfilter-142169.html" target="_blank" rel="external">Intercepting Filter</a>的一个高级实现, 它保证了用户对事件处理的完整控制权以及确保了<code>ChannelHandler</code>在pipeline中的运行方式.</p>
<p>每当创建一个<code>Channel</code>的时候, 都会创建出一个对应的<code>ChannelPipeline</code>, 也就是说每个<code>Channel</code>都有其自己的<code>ChannelPipeline</code></p>
<p>下面的图给出了IO事件是如何在<code>ChannelPipeline</code>里的<code>ChannelHandler</code>进行传递处理的. IO事件由<code>ChannelInboundHandler</code>或者<code>ChannelOutboundHandler</code>处理, 我们在handler中调用<code>ChannelHandlerContext</code>中的事件传播方法将event传播给下一个handler继续执行, 例如调用<code>ChannelHandlerContext#fireChannelRead(Object)</code>和<code>ChannelHandlerContext#write(Object)</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">                                               I/O Request</span><br><span class="line">                                          via Channel&#125; or</span><br><span class="line">                                      ChannelHandlerContext&#125;</span><br><span class="line">                                                    |</span><br><span class="line">+---------------------------------------------------+---------------+</span><br><span class="line">|                           ChannelPipeline         |               |</span><br><span class="line">|                                                  \|/              |</span><br><span class="line">|    +---------------------+            +-----------+----------+    |</span><br><span class="line">|    | Inbound Handler  N  |            | Outbound Handler  <span class="number">1</span>  |    |</span><br><span class="line">|    +----------+----------+            +-----------+----------+    |</span><br><span class="line">|              /|\                                  |               |</span><br><span class="line">|               |                                  \|/              |</span><br><span class="line">|    +----------+----------+            +-----------+----------+    |</span><br><span class="line">|    | Inbound Handler N-<span class="number">1</span> |            | Outbound Handler  <span class="number">2</span>  |    |</span><br><span class="line">|    +----------+----------+            +-----------+----------+    |</span><br><span class="line">|              /|\                                  .               |</span><br><span class="line">|               .                                   .               |</span><br><span class="line">| ChannelHandlerContext.fireIN_EVT() ChannelHandlerContext.OUT_EVT()|</span><br><span class="line">|        [ method call]                       [method call]         |</span><br><span class="line">|               .                                   .               |</span><br><span class="line">|               .                                  \|/              |</span><br><span class="line">|    +----------+----------+            +-----------+----------+    |</span><br><span class="line">|    | Inbound Handler  <span class="number">2</span>  |            | Outbound Handler M-<span class="number">1</span> |    |</span><br><span class="line">|    +----------+----------+            +-----------+----------+    |</span><br><span class="line">|              /|\                                  |               |</span><br><span class="line">|               |                                  \|/              |</span><br><span class="line">|    +----------+----------+            +-----------+----------+    |</span><br><span class="line">|    | Inbound Handler  <span class="number">1</span>  |            | Outbound Handler  M  |    |</span><br><span class="line">|    +----------+----------+            +-----------+----------+    |</span><br><span class="line">|              /|\                                  |               |</span><br><span class="line">+---------------+-----------------------------------+---------------+</span><br><span class="line">                |                                  \|/</span><br><span class="line">+---------------+-----------------------------------+---------------+</span><br><span class="line">|               |                                   |               |</span><br><span class="line">|       [ Socket.read() ]                    [ Socket.write() ]     |</span><br><span class="line">|                                                                   |</span><br><span class="line">|  Netty Internal I/<span class="function">O <span class="title">Threads</span> <span class="params">(Transport Implementation)</span>            |</span><br><span class="line">+-------------------------------------------------------------------+</span></span><br></pre></td></tr></table></figure></p>
<p>从上图中我们可以看出左边是<code>inbound</code>handler(从下向上进行处理), 右图是<code>outbound</code>流程(从上向下进行处理).<code>inbound</code>handler通常处理的是由IO线程生成的<code>inbound</code>数据(例如<code>SocketChannel#read(ByteBuffer)</code>).<br><code>outbound</code>handler一般由write请求生成或者转换传输数据. 如果<code>outbound</code>数据传输到上图的底部后, 它就会被绑定到<code>Channel</code>上的IO线程进行操作. IO线程一般会进行<code>SocketChannel#write(ByteBuffer)</code>数据输出操作.</p>
<blockquote>
<p>底层的<code>SocketChannel#read()</code>方法读取<code>ByteBuf</code>, 然后由IO线程<code>NioEventLoop</code>调用<code>ChannelPipeline#fireChannelRead()</code>方法,将消息<code>ByteBuf</code>传递到<code>ChannelPipeline</code>中.</p>
</blockquote>
<h2 id="handler实现"><a href="#handler实现" class="headerlink" title="handler实现"></a>handler实现</h2><p>下面我们看一下如何自己实现一个inbound和outbound handler<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInboundHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Connected!"</span>);</span><br><span class="line">        ctx.fireChannelActive();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> clas MyOutboundHandler extends ChannelOutboundHandlerAdapter &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(ChannelHandlerContext ctx, ChannelPromise&#125; promise)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Closing .."</span>);</span><br><span class="line">        ctx.close(promise);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以预想到的是, 用户在使用pipeline中肯定最少会有一个<code>ChannelHandler</code>用来接受IO事件(例如read操作)和响应IO操作(例如write和close). 例如一个标准的服务器在每个channel中的pipeline中会有如下的handler</p>
<ul>
<li>Protocol Decoder ： 将二进制的字节码(例如<code>ByteBuf</code>中的数据)解析成Java对象</li>
<li>Protocol Encoder :  将Java对象转换成二进制数据进行网络传输</li>
<li>Business Logic Handler : 执行真正的业务逻辑</li>
</ul>
<p>下面我们将上面的流程转换成一个真实的示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> EventExecutorGroup group = <span class="keyword">new</span> DefaultEventExecutorGroup(<span class="number">16</span>);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">ChannelPipeline&#125; pipeline = ch.pipeline();</span><br><span class="line"></span><br><span class="line">pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> MyProtocolDecoder());</span><br><span class="line">pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> MyProtocolEncoder());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tell the pipeline to run MyBusinessLogicHandler's event handler methods</span></span><br><span class="line"><span class="comment">// in a different thread than an I/O thread so that the I/O thread is not blocked by</span></span><br><span class="line"><span class="comment">// a time-consuming task.</span></span><br><span class="line"><span class="comment">// If your business logic is fully asynchronous or finished very quickly, you don't</span></span><br><span class="line"><span class="comment">// need to specify a group.</span></span><br><span class="line">pipeline.addLast(group, <span class="string">"handler"</span>, <span class="keyword">new</span> MyBusinessLogicHandler());</span><br></pre></td></tr></table></figure></p>
<p>我们可以在任何时间在<code>ChannelPipeline</code>上添加或者移除<code>ChannelHandler</code>, 因为<code>ChannelPipeline</code>是线程安全的. 例如我们可以在线上环境中因为业务原因动态的添加或者移除handler.</p>
<h2 id="源码剖析"><a href="#源码剖析" class="headerlink" title="源码剖析"></a>源码剖析</h2><p>下来我们看一下<code>ChannelPipeline</code>的默认实现<code>DefaultChannelPipeline</code>里的数据结构<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> AbstractChannel channel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> DefaultChannelHandlerContext head;</span><br><span class="line"><span class="keyword">final</span> DefaultChannelHandlerContext tail;</span><br></pre></td></tr></table></figure></p>
<p><code>DefaultChannelPipeline</code>采用链式方式存储<code>ChannelHandlerContext</code>(内部存储的的是<code>ChannelHandler</code>). 当我们增加一个<code>ChannelHandler</code>时<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ChannelPipeline <span class="title">addFirst</span><span class="params">(EventExecutorGroup group, <span class="keyword">final</span> String name, ChannelHandler handler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        checkDuplicateName(name);</span><br><span class="line">        DefaultChannelHandlerContext newCtx = <span class="keyword">new</span> DefaultChannelHandlerContext(<span class="keyword">this</span>, group, name, handler);</span><br><span class="line">        addFirst0(name, newCtx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addFirst0</span><span class="params">(String name, DefaultChannelHandlerContext newCtx)</span> </span>&#123;</span><br><span class="line">    checkMultiplicity(newCtx);</span><br><span class="line"></span><br><span class="line">    DefaultChannelHandlerContext nextCtx = head.next;</span><br><span class="line">    newCtx.prev = head;</span><br><span class="line">    newCtx.next = nextCtx;</span><br><span class="line">    head.next = newCtx;</span><br><span class="line">    nextCtx.prev = newCtx;</span><br><span class="line"></span><br><span class="line">    name2ctx.put(name, newCtx);</span><br><span class="line"></span><br><span class="line">    callHandlerAdded(newCtx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们看到在<code>addFirst0()</code>方法里将<code>newCtx</code>放到了首位上,然后内部调用了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callHandlerAdded</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ctx.channel().isRegistered() &amp;&amp; !ctx.executor().inEventLoop()) &#123;</span><br><span class="line">        ctx.executor().execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                callHandlerAdded0(ctx);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    callHandlerAdded0(ctx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callHandlerAdded0</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ctx.handler().handlerAdded(ctx);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们看到最终的时候在<code>ChannelHandler</code>里添加了<code>ChannelHandlerContext</code>.</p>
<h2 id="事件触发"><a href="#事件触发" class="headerlink" title="事件触发"></a>事件触发</h2><p>在下面的示例中我们分别在pipeline中添加俩个<code>inbound</code>handler和俩个<code>outbound</code>handler.(以<code>Inbound</code>开头的类名表示为一个<code>inbound</code>handler, 以<code>Outbound</code>开头的类名表示为一个<code>outbound</code>handler.)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ChannelPipeline p = ...;</span><br><span class="line">p.addLast(<span class="string">"1"</span>, <span class="keyword">new</span> InboundHandlerA());</span><br><span class="line">p.addLast(<span class="string">"2"</span>, <span class="keyword">new</span> InboundHandlerB());</span><br><span class="line">p.addLast(<span class="string">"3"</span>, <span class="keyword">new</span> OutboundHandlerA());</span><br><span class="line">p.addLast(<span class="string">"4"</span>, <span class="keyword">new</span> OutboundHandlerB());</span><br><span class="line">p.addLast(<span class="string">"5"</span>, <span class="keyword">new</span> InboundOutboundHandlerX());</span><br></pre></td></tr></table></figure></p>
<p>事件在<code>inbound</code>handler中的执行过程是<code>1, 2, 3, 4, 5</code>. 事件在<code>outbound</code>handler中的执行过程是<code>5, 4, 3, 2, 1</code>.</p>
<p>但是在真实的执行过程中, 由于<code>3, 4</code>并没有实现<code>ChannelInboundHandler</code>, 因此inbound流程中真正执行的handler只有<code>1, 2, 5</code>. 而由于<code>1, 2</code>并没有实现<code>ChannelOutboundHandler</code>因此在outbound流程中真正执行的handler只有<code>5, 4, 3</code>.<br>如果<code>5</code>都实现了<code>ChannelInboundHandler</code>和<code>ChannelOutboundHandler</code>, 那么事件的执行顺序分别是<code>125</code>和<code>543</code>.</p>
<p>也许你已经注意到了, 在handler中不得不调用<code>ChannelHandlerContext</code>的事件传播方法, 将事件传递给下一个handler. 下面的是<br>能够触发<code>inbound</code>事件的方法</p>
<ul>
<li><code>ChannelHandlerContext#fireChannelRegistered()</code> Channel注册事件</li>
<li><code>ChannelHandlerContext#fireChannelActive()</code> TCP链路建立成功,Channel激活事件</li>
<li><code>ChannelHandlerContext#fireChannelRead(Object var1)</code> 读事件</li>
<li><code>ChannelHandlerContext#fireChannelReadComplete()</code> 读操作完成通知事件</li>
<li><code>ChannelHandlerContext#fireExceptionCaught(Throwable var1)</code> 异常通知事件</li>
<li><code>ChannelHandlerContext#fireUserEventTriggered(Object var1)</code> 用户自定义事件</li>
<li><code>ChannelHandlerContext#fireChannelWritabilityChanged()</code> Channel的可写状态变化通知事件</li>
<li><code>ChannelHandlerContext#fireChannelInactive()</code> TCP链路关闭, 链路不可用通知事件<br>触发<code>outbound</code>事件的方法有</li>
<li><code>ChannelHandlerContext#bind(SocketAddress var1, ChannelPromise var2)</code> 绑定本地地址事件</li>
<li><code>ChannelHandlerContext#connect(SocketAddress var1, ChannelPromise var2)</code> 连接服务端事件</li>
<li><code>ChannelHandlerContext#flush()</code> 刷新事件</li>
<li><code>ChannelHandlerContext#read()</code> 读事件</li>
<li><code>ChannelHandlerContext#disconnect(ChannelPromise var1)</code> 断开连接事件</li>
<li><code>ChannelHandlerContext#close(ChannelPromise var1)</code> 关闭当前Channel事件</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Netty/">Netty</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/02/02/netty/ChannelPipeline/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/02/02/netty/ChannelPipeline/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/02/02/JavaSE/java volatile/" title="volatile 使用" itemprop="url">volatile 使用</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-02-01T16:00:00.000Z" itemprop="datePublished"> Published 2016-02-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>在讲<code>volatile</code>的之前,我们先看一下java的内存模型. 我们知道当我们<code>new</code>出来一个对象的时候,这个对象会被直接分配到堆上(暂不考虑栈上分配等技术). 而程序的逻辑是在方法中定义的,方法运行在线程里也就是栈上. 因此JVM会将线程里使用的数据从堆上拷贝到线程的本地存储上. 这个过程涉及了下列8个操作</p>
<ol>
<li>lock: 将堆上的变量标志为某个线程独享的状态</li>
<li>unlock: 将堆上的变量释放出来, 以便被其他线程锁定</li>
<li>read: 将某个变量从堆上拷贝到线程的工作内存上</li>
<li>load: 将已经从堆上拷贝到线程的工作内存上的变量放入到变量副本中</li>
<li>use: 将线程变量副本中的变量传递给虚拟机执行引擎. (每当虚拟机遇到一个需要使用该变量的字节码指令时,都会执行该操作)</li>
<li>assign: 将虚拟机执行引擎返回的变量的值赋值到工作变量中</li>
<li>store: 将工作变量值传递到堆内存中.</li>
<li>write: 将从线程工作变量中接受到的值写入到主内存变量中</li>
</ol>
<p>当一个变量被<code>volatile</code>修饰后, 每次<code>load</code>操作都是从堆中获取值, <code>assign</code>的时候也是直接写回到堆中内存变量中, 而不是在线程本地变量中操作.</p>
<p>volatile变量具备俩种特性</p>
<ul>
<li>线程可见性: 某个线程修改了被<code>volatile</code>修饰的变量后,其他线程可以里面看见这个最新的值.</li>
<li>禁止指令重排序优化</li>
</ul>
<blockquote>
<p><code>volatile</code>最适用的场景是一个线程写,多个线程读的场景. 如果有多个线程同时写的话还是需要锁或者并发容器等等进行保护</p>
</blockquote>
<p>下面我们看一个指令重排序的例子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">		Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">			<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">while</span> (!stop) &#123;</span><br><span class="line">				i++;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		thread.start();</span><br><span class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">		stop = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的这段代码会被优化成(这种优化也被称为提升优化)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">		Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">			<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span> (!stop) &#123;</span><br><span class="line">				<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">					i++;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		thread.start();</span><br><span class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">		stop = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但是如果<code>stop</code>变量被<code>volatile</code>修饰后<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">		Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">			<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">while</span> (!stop) &#123;</span><br><span class="line">				i++;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		thread.start();</span><br><span class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">		stop = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序就能正确的停止运行了</p>
<blockquote>
<p>Java中对于重排序是这样规定的, 只要在单线程环境中, 重排序前后代码的运行结果总是一致的, 那么这段代码的重排序就是合法的. 但是当在多线程的环境中, 重排序就会影响到程序的执行, 就像刚才我们的例子展示的那样. 例外还有一点值得说明的是, 当代码中运行时包含<code>native</code>方法时, 会打断编译器的重排序(例如<code>System.out.println()</code>或者<code>Threads.sleep()</code>)</p>
</blockquote>
<p><code>volatile</code>并不能解决并发写的情况, 正如我们开头所说的<code>volatile</code>最适用的场景是一个线程写,多个线程读的场景. 例如下面的程序, 无论我是否对<code>counter</code>进行<code>volatile</code>修饰都不能解决并发异常的问题<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">		List&lt;Thread&gt; threads = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">			Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">				<span class="comment">// 并发写counter</span></span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					TimeUnit.MILLISECONDS.sleep(<span class="number">50</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">				counter++;</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line">			thread.start();</span><br><span class="line">			threads.add(thread);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		threads.forEach(thread -&gt; &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				thread.join();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		System.out.println(counter);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的程序最后的输出结果, 总是小于100000.</p>
<blockquote>
<p>还有一点需要说明的是,<code>volatile</code>修饰的数组,只能保证数组本身的内存可见性,但是对于其中的元素的修改是不会保证的.</p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JavaSE/">JavaSE</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/02/02/JavaSE/java volatile/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/02/02/JavaSE/java volatile/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/30/java综合工具/Typesafe Config 初探/" title="Typesafe Config 初探" itemprop="url">Typesafe Config 初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-01-29T16:00:00.000Z" itemprop="datePublished"> Published 2016-01-30</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>Typesafe Config 是为JVM平台语言提供的配置类库.</p>
<p>目前config只支持配置文件，如果想从数据库获取配置文件，需要自己diy。 config库很擅长合并配置。</p>
<p>我们可以直接使用maven方式依赖该库<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.typesafe<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>API示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.typesafe.config.ConfigFactory</span><br><span class="line"></span><br><span class="line">Config conf = ConfigFactory.load();</span><br><span class="line"><span class="keyword">int</span> bar1 = conf.getInt(<span class="string">"foo.bar"</span>);</span><br><span class="line">Config foo = conf.getConfig(<span class="string">"foo"</span>);</span><br><span class="line"><span class="keyword">int</span> bar2 = foo.getInt(<span class="string">"bar"</span>);</span><br></pre></td></tr></table></figure></p>
<p>在上面的例子中我们使用了最简单的方式<code>ConfigFactory.load()</code>加载出了一个配置类<code>Config</code>, config会自动去classPath中查找<code>reference.conf</code>. <code>ConfigFactory.load()</code>会按照下面的优先级依次从classpath中查找文件进行加载</p>
<ol>
<li><code>system properties</code></li>
<li><code>application.conf</code> (all resources on classpath with this name)</li>
<li><code>application.json</code> (all resources on classpath with this name)</li>
<li><code>application.properties</code> (all resources on classpath with this name)</li>
<li><code>reference.conf</code> (all resources on classpath with this name)<br>如果我们不想要使用上面的文件名或者我们将配置分配到多个文件中,那么我们可以使用<code>ConfigFactory.load(&quot;test.conf&quot;);</code></li>
</ol>
<p>当然如果你想自己创建<code>Config</code>也可以调用<code>ConfigFactory</code>的<code>parseXXX</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ConfigFactory.parseFile(<span class="keyword">new</span> File(<span class="string">""</span>));</span><br><span class="line">ConfigFactory.parseMap(<span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line">ConfigFactory.parseProperties(<span class="keyword">new</span> Properties());</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>需要注意的从<code>Config</code>实例中得到的<code>Config</code>, <code>ConfigParseOptions</code>, <code>ConfigResolveOptions</code>, <code>ConfigObject</code> 得到的对象都是不可变的.</p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java工具/">Java工具</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/30/java综合工具/Typesafe Config 初探/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/30/java综合工具/Typesafe Config 初探/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/29/jvm/使用Classloader加载类/" title="使用Classloader加载类" itemprop="url">使用Classloader加载类</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="ming15" target="_blank" itemprop="author">ming15</a>
		
  <p class="article-time">
    <time datetime="2016-01-28T16:00:00.000Z" itemprop="datePublished"> Published 2016-01-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>类加载器不单单是用于实现类的加载动作, 对于任意一个类,都需要由加载它的类加载器和类本身一同确立其在java虚拟机中的唯一性.换句话说:比较俩个类是否相等,只有在这俩个类是由同一个类加载器加载的前提下才有意义. 否则即使来自同一个源文件,只要加载它们的类加载器不同,这俩个类就必定不相等.</p>
<blockquote>
<p>判断俩个类相等可以通过下面方法: <code>Class</code>对象的<code>equals()</code>方法, <code>isAssignbleFrom()</code>方法, <code>isInstance()</code>方法的返回结果, 也包括使用<code>instanceof</code>关键字做对象所属关系判断等. 不同的类加载器对<code>instanceof</code>关键字运算结果的影响</p>
</blockquote>
<h2 id="双亲委派模型"><a href="#双亲委派模型" class="headerlink" title="双亲委派模型"></a>双亲委派模型</h2><p><img src="https://raw.githubusercontent.com/ming15/blog-website/images/jvm/ClassLoader%E7%9A%84%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84.png" alt="ClassLoader的体系架构"><br>从JVM来角度讲, 只存在俩种不同的类加载器:</p>
<ul>
<li>启动类加载器: 使用C++语言实践,是虚拟机自身的一部分. </li>
<li>其他类加载器: 这些类加载器都由java语言实现,独立于虚拟机外部,并且全部都继承自抽象类:<code>java.lang.ClassLoader</code></li>
</ul>
<p>系统提供的类加载器</p>
<ul>
<li>启动类加载器 : 这个类加载器负责将<code>&lt;JAVA_HOME&gt;\lib</code>目录中的,或者<code>-Xbootclasspath</code>参数所指定的路径中的,并且是虚拟机识别的(仅按照文件名识别,如rt,jar,名字不符合的类库即使放在lib目录里也不会被加载)类库加载到虚拟机内存中,启动类加载器无法被java程序直接使用.</li>
<li>扩展类加载器 : 这个类加载器由<code>sun.misc.Launcher$ExtClassLoader</code>实现,负责加载<code>&lt;JAVA_HOME&gt;\lib\ext</code>目录中的,或者被<code>java.ext.dirs</code>系统变量所指定的路径中的所有类库, 开发者可以直接使用扩展类加载器.</li>
<li>应用程序加载器 : 这个类加载器由<code>sun.misc.Launcher$AppClassLoader</code>来实现. 由于类加载器是<code>ClassLoader</code>中<code>getSystemClassLoader()</code>方法的返回值,所以一般也称它为系统类加载器. 它负责加载用户类路径(ClassPath)上所指定的类库,开发者可以直接使用这个类加载器,如果应用程序中没有自定义过自己的类加载器,一般情况下就是程序中默认的类加载器.</li>
</ul>
<p>类加载器收到类加载请求,它不会自己去尝试加载这个类,而把这个请求委派给父类加载器去完成,每一个层次的类加载都是如此,因此所有的类加请求最终都应该传送到顶层的启动类加载器中,只有当父加载器反馈自己无法完成这个加载请求(它的搜索范围中没有找到所需的类)时,子类加载器才会尝试自己去加载.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br><span class="line">       <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">           <span class="comment">// 第一步检查被加载的类是否已经被加载进入了虚拟机</span></span><br><span class="line">           Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">           <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">// 如果没有被加载进虚拟机中则进行加载</span></span><br><span class="line">               <span class="keyword">long</span> t0 = System.nanoTime();</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="comment">// 优先从父类加载器中进行加载, 所有的类加请求最终都应该传送到顶层的启动类加载器中</span></span><br><span class="line">                   <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// </span></span><br><span class="line">                       c = findBootstrapClassOrNull(name);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                   <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">                   <span class="comment">// from the non-null parent class loader</span></span><br><span class="line">               &#125;</span><br><span class="line">			</span><br><span class="line">               <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="comment">// 父类加载器找不到则调用自己的findClass(name)找到类然后进行加载</span></span><br><span class="line">                   <span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line">                   c = findClass(name);</span><br><span class="line"></span><br><span class="line">                   <span class="comment">// this is the defining class loader; record the stats</span></span><br><span class="line">                   sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">                   sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                   sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">               resolveClass(c);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> c;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用双亲委派模型来组织类加载之间的关系, 可以确保我们自己JVM的安全. 因为当我们自己写一个 <code>java.lang.Object</code>, 这个类虽然能够被正常编译, 但是它永远不会被加载器虚拟机中, 因为这个类会在启动类加载器中完成了加载.</p>
</blockquote>
<p>在刚才的<code>loadClass()</code>方法中我们看到最终我们自己实现类加载的逻辑是在<code>findClass()</code>中进行的, 这是为了向前兼容,JDK1.2之后添加的方法.JDK1.2之后已不提倡用户再去覆盖<code>loadClass()</code>方法,而在<code>loadClass()</code>方法的逻辑里如果父类加载失败,则会调用自己的<code>findClass()</code>方法来完成加载,这样就可以保证新写出来的类加载器是符合双亲委派规则的.</p>
<blockquote>
<p>为了解决各个类加载器的基础类调用用户代码, java设计团队引入了这样一个设计:线程上下文类加载器,这个类加载器可以通过<code>java.lang.Thread</code>类的<code>setContextClassLoaser()</code>方法进行设置,如果创建线程时还未设置,它将会从父线程中继承一个:如果在应用程序的全局范围内都没有设置过,那么这个类加载器默认就是应用程序类加载器.有了线程上下文类加载器,JNDI服务使用这个线程上下文类加载器去加载所需要的SPI代码,也就是父类加载器请求子类加载器去完成类加载的动作,这种行为实际就是打通了双亲委派模型的层次结构来逆向使用类加载器,已经违背了双亲委派模型的一般性原则.</p>
</blockquote>
<p>上面所说只完成了类加载的动作, 但是如果我们想要实现热更代码的这种功能的话,就不能单纯依赖重写<code>findClass(name)</code>了，而是要重写<code>loadClass(String name)</code>了，这是因为在<code>ClassLoader</code>中的<code>loadClass(String name)</code>方法当发现已经加载过的类就不会再重新加载了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">		URL url = <span class="keyword">new</span> File(<span class="string">"."</span>).toURL();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">			MyClassLoader myLoader = <span class="keyword">new</span> MyClassLoader(<span class="keyword">new</span> URL[]&#123;url&#125;);</span><br><span class="line">			Class&lt;?&gt; obj = myLoader.loadClass(<span class="string">"Mesurable"</span>);</span><br><span class="line">			<span class="keyword">for</span> (Field field : obj.getFields()) &#123;</span><br><span class="line">				System.out.println(field.getName());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MyClassLoader</span><span class="params">(URL[] urls)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(urls);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">		Class&lt;?&gt; loadClass = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (name.contains(<span class="string">"java.lang.Object"</span>)) &#123;</span><br><span class="line">			<span class="comment">// 因为我们的父类是java.lang.Object, 因此我们要调用父类加载器进行加载</span></span><br><span class="line">			loadClass = <span class="keyword">super</span>.loadClass(name);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			loadClass = findLoadedClass(name);</span><br><span class="line">			<span class="keyword">if</span> (loadClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> loadClass;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">byte</span>[] bytes = generateClass();</span><br><span class="line">			loadClass = defineClass(name, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> loadClass;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">byte</span>[] generateClass() &#123;</span><br><span class="line">		ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</span><br><span class="line">		cw.visit(V1_8,											<span class="comment">// 指定class文件版本号, 我们将其设置为java8</span></span><br><span class="line">				ACC_PUBLIC,	<span class="comment">// 设置接口的修饰符</span></span><br><span class="line">				<span class="string">"Mesurable"</span>,								<span class="comment">// 我们设置classname, 需要在这里指定全限定名</span></span><br><span class="line">				<span class="keyword">null</span>,											<span class="comment">// 设置泛型信息, 因为我们的接口是非泛化的, 因此我们将其设置为null</span></span><br><span class="line">				<span class="string">"java/lang/Object"</span>,							<span class="comment">// 设置父类, 同时需要设定全限定名</span></span><br><span class="line">				<span class="keyword">null</span>);			<span class="comment">// 设置接口, 同样需要设置全限定名</span></span><br><span class="line"></span><br><span class="line">		cw.visitField(</span><br><span class="line">				ACC_PUBLIC,	<span class="comment">// 设置字段的修饰符</span></span><br><span class="line">				<span class="string">"LESS__"</span> + random.nextInt(<span class="number">100</span>),										<span class="comment">// 设置字段名</span></span><br><span class="line">				<span class="string">"I"</span>,										<span class="comment">// 设置字段类型</span></span><br><span class="line">				<span class="keyword">null</span>,										<span class="comment">// 设置泛型信息</span></span><br><span class="line">				<span class="keyword">new</span> Long(-<span class="number">1</span>))							<span class="comment">// 设置字面量值.</span></span><br><span class="line">				.visitEnd();</span><br><span class="line"></span><br><span class="line">		cw.visitEnd();</span><br><span class="line">		<span class="keyword">return</span> cw.toByteArray();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><code>URLClassLoader</code>根据<code>URL</code>指定的路径从<code>JAR</code>文件或者目录里加载<code>class</code>文件或者其他资源文件. 如果<code>URL</code>以<code>/</code>结束,就表示到某个目录里进行加载. 否则就表示到某个<code>JAR</code>文件里进行加载. 线程里用于创建<code>URLClassLoader</code>实例的<code>AccessControlContext</code>会在加载类文件以及资源文件时使用到. <code>URLClassLoader</code>实例创建好之后会根据默认的授权权限依据指定的<code>URL</code>来进行加载类.</p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/29/jvm/使用Classloader加载类/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/29/jvm/使用Classloader加载类/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github Card</p>
<div class="github-card" data-github="ming15" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/Groovy/" title="Groovy">Groovy<sup>7</sup></a></li>
		  
		
		  
			<li><a href="/categories/Haskell/" title="Haskell">Haskell<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/JMH/" title="JMH">JMH<sup>11</sup></a></li>
		  
		
		  
			<li><a href="/categories/JVM/" title="JVM">JVM<sup>14</sup></a></li>
		  
		
		  
			<li><a href="/categories/JavaSE/" title="JavaSE">JavaSE<sup>28</sup></a></li>
		  
		
		  
			<li><a href="/categories/JavaScript/" title="JavaScript">JavaScript<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java工具/" title="Java工具">Java工具<sup>8</sup></a></li>
		  
		
		  
			<li><a href="/categories/MongoDB/" title="MongoDB">MongoDB<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Netty/" title="Netty">Netty<sup>8</sup></a></li>
		  
		
		  
			<li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Php/" title="Php">Php<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Reids/" title="Reids">Reids<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/TCP-IP/" title="TCP IP">TCP IP<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/asm/" title="asm">asm<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/guice/" title="guice">guice<sup>8</sup></a></li>
		  
		
		  
			<li><a href="/categories/http客户端/" title="http客户端">http客户端<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/http服务器/" title="http服务器">http服务器<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/linux/" title="linux">linux<sup>7</sup></a></li>
		  
		
		  
			<li><a href="/categories/memcached/" title="memcached">memcached<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/mgits/" title="mgits">mgits<sup>11</sup></a></li>
		  
		
		  
			<li><a href="/categories/mycat/" title="mycat">mycat<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/python2/" title="python2">python2<sup>11</sup></a></li>
		  
		
		  
			<li><a href="/categories/并发编程/" title="并发编程">并发编程<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/序列化工具/" title="序列化工具">序列化工具<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/操作系统/" title="操作系统">操作系统<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/数据库/" title="数据库">数据库<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/日志工具/" title="日志工具">日志工具<sup>7</sup></a></li>
		  
		
		  
			<li><a href="/categories/构建工具/" title="构建工具">构建工具<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/算法/" title="算法">算法<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  

  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="http://www1.vertx3.cn" target="_blank" title="vertx3">vertx3</a>
            
          </li>
        
    </ul>
</div>

  

<div class="doubanshow">
<p class="asidetitle">Douban Show</p>
<div>
<script type="text/javascript" src="http://www.douban.com/service/badge/xxxyy/?show=collection&amp;n=12&amp;columns=3&amp;hidelogo=yes&amp;hideself=yes&amp;cat=book|movie" ></script>
</div>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=3253370782&verifier=e9ca895b&dpc=1"></iframe>
</div>


  

<div class="lofter">
<p class="asidetitle">Lofter</p>

 <iframe width="100%" height="39" class="share_self"  frameborder="0" scrolling="no" src="http://ming15.lofter.com/"></iframe>
</div>




</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 博客,我选择重构 <br/>
			重构使事情变得更美,更加正确</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/3253370782" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/ming15" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		<a href="https://www.douban.com/people/xxxyy" target="_blank" class="icon-douban" title="豆瓣"></a>
		
		
		<a href="http://www.zhihu.com/people/ming15" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="ming15">ming15</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"wanggnim"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F9e8fca440159a2125668804e46682db4' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
