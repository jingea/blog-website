
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>·</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="王玉">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="·">
<meta property="og:url" content="http://www.yu66.wang/index.html">
<meta property="og:site_name" content="·">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="·">

    
    <link rel="alternative" href="/atom.xml" title="·" type="application/atom+xml">
    
    
    
    <link rel="apple-touch-icon" href="/img/author.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/author.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="·">·</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
						<form class="search" action="http://zhannei.baidu.com/cse/search" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= 17728547076946147000 ><input type="text" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/11/03/jvm/Spring-loaded/" title="Spring-loaded" itemprop="url">Spring-loaded</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-11-02T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-11-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>在前面的文章里分别都说过了instrument和Hotswap, 显然这俩个技术在代码热更方面都有比较大的局限性. 今天测试一下Spring出品的Spring-loaded. 它可以动态地添加删除方法, 属性字段等.</p>
<p>Spring-loaded 的用法非常简单, 下载springloaded.jar这个jar包, 然后使用代理的方式将它挂载到JVM上就可以了.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -javaagent:&lt;pathto&gt;/springloaded.jar -noverify SomeJavaClass</div></pre></td></tr></table></figure></p>
<p>尽管有了很高的灵活性,但是还是多少稍微有一些限制, 如果想要reload的文件不能以下列字符串开头<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">antlr/</div><div class="line">org/springsource/loaded/</div><div class="line">com/springsource/tcserver/</div><div class="line">com/springsource/insight/</div><div class="line">groovy/</div><div class="line">groovyjarjarantlr/</div><div class="line">groovyjarjarasm/</div><div class="line">grails/</div><div class="line">java/</div><div class="line">javassist/</div><div class="line">org/codehaus/groovy/</div><div class="line">org/apache/</div><div class="line">org/springframework/</div><div class="line">org/hibernate/</div><div class="line">org/hsqldb/</div><div class="line">org/aspectj/</div><div class="line">org/xml/</div><div class="line">org/h2/</div></pre></td></tr></table></figure></p>
<p>还可以设置一些系统参数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -Dspringloaded=explain -javaagent:&lt;pathto&gt;/springloaded.jar -noverify SomeJavaClass</div></pre></td></tr></table></figure></p>
<p><code>explain</code>mode会输出无法reload的诊断信息,例如<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Feb 05, 2014 11:00:51 AM org.springsource.loaded.TypeRegistry couldBeReloadable</div><div class="line">INFO: WhyNotReloadable? The <span class="built_in">type</span> org/apache/maven/model/building/ModelBuilder is using a package name <span class="string">'org/apache/'</span> <span class="built_in">which</span> is </div><div class="line">     considered infrastructure and types within it are not made reloadable</div></pre></td></tr></table></figure></p>
<p>除了<code>explain</code>还有<code>verbose</code>模式, 这个模式会使用<code>java.util.Logging</code>输出reload过程详细信息.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Watcher Observed last modification time change <span class="keyword">for</span> /Users/aclement/play/grails10411/jira-reload/target/classes/br/</div><div class="line">        com/app/domains/CategoryController.class (lastScanTime=1391628759166)</div><div class="line">Watcher Firing file changed event /Users/aclement/play/grails10411/jira-reload/target/classes/br/</div><div class="line">        com/app/domains/CategoryController.class</div><div class="line">ReloadableType Loading new version of br/com/app/domains/CategoryController, identifying suffix OV1YS1A,</div><div class="line">               new data length is 27209bytes</div></pre></td></tr></table></figure></p>
<p>当然, 上面俩个模式并不是互斥的, 我们可以对spring-loaded指定多个参数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-Dspringloaded=verbose;explain;profile=grails</div></pre></td></tr></table></figure></p>
<p>看到了这么多, 其实还有一些特性没有测试到， 但是不想再自欺欺人了, 只有一个原因<code>-noverify</code>, 它关闭了JVM的字节码检查功能, 它让<a href="https://blogs.oracle.com/buck/entry/never_disable_bytecode_verification_in" target="_blank" rel="external">JVM坐上火箭去了月球</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/11/03/jvm/Spring-loaded/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/11/03/jvm/Spring-loaded/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/10/31/JavaSE/Java  Float/" title="Java Float" itemprop="url">Java Float</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-10-30T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-10-31</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>今天有个以前的同事问了我一段代码,<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimplePrint</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">long</span> i = System.currentTimeMillis();</div><div class="line">		System.out.println(i);</div><div class="line">		<span class="keyword">float</span> h = <span class="number">0.0f</span>;</div><div class="line">		i -= h;</div><div class="line">		System.out.println(i);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>前后俩个i输出结果不一致, 想了一下, 应该是 i 或者 h在转型时出的问题.<br>于是写了段程序测试了一下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimplePrint</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">long</span> l = System.currentTimeMillis();</div><div class="line">		System.out.println(l);</div><div class="line">		l -= <span class="number">0.0f</span>;</div><div class="line">		System.out.println(l);</div><div class="line"></div><div class="line">		l = System.currentTimeMillis();</div><div class="line">		l = (<span class="keyword">long</span>)(l - <span class="number">0.0f</span>);</div><div class="line">		System.out.println(l);</div><div class="line"></div><div class="line">		l = System.currentTimeMillis();</div><div class="line">		<span class="keyword">float</span> f = (<span class="keyword">float</span>)l;</div><div class="line">		System.out.println(l);</div><div class="line">		System.out.println(f);</div><div class="line">		l = (<span class="keyword">long</span>)(f - <span class="number">0.0f</span>);</div><div class="line">		System.out.println(l);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>果真是如我所想, l 转换成了 Float,但是有点知其然不知其所然，于是跑到<a href="http://stackoverflow.com/questions/40339165/what-is-happening-when-llong-ffloat" target="_blank" rel="external">stackoverflow上问了一下</a>, 有个大大回答的很好:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">E1 op= E2</div></pre></td></tr></table></figure>
<p>等于<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">E1 = (T) ((E1) op (E2))</div></pre></td></tr></table></figure></p>
<p>T的类型就是E1, 而在上面的例子中当float和long运算时, long会转换成float.</p>
<p>我们知道在计算机中存储浮点数采用科学计数法, 也就是浮点数, 数字向右移动移动到小数点后面.<br><code>3.1415</code> 被转化为 <code>0.31415x10^1</code></p>
<p>Float是在Java中是用32个bit存储的, 1个bit表示正负符号(符号位), 7个bit表示精度(指数位), 23个bit表示有效数字.上面的数字就是5个有效数字, 指数为1, 精度也就是为1.</p>
<p>也就说按照小数点后面是0, 小数点前面最大有效数字是24位(16777216), 而指数为最大为7位(128), 很明显这个128位要大于24位, 这是为什么呢? 因为小数点后面可以是104个0然后是24个有效数字</p>
<blockquote>
<p>有效数字是一个数字中从左第一个不为0的开始向右数, 直到数字结束, 中间的这部分就是有效数字</p>
</blockquote>
<p>那么回到正文,刚开始的那个例子是问题出在哪里呢? 答案就在下面的例子里<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestFloat</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">long</span> now = <span class="number">1477911537443l</span>;</div><div class="line">		<span class="keyword">float</span> f = (<span class="keyword">float</span>)now;   <span class="comment">// 0.1477911537443l * 10^13  =&gt; 10101100000011010011001(24位有效数字) 000110011100100011</span></div><div class="line">		<span class="keyword">long</span> time = (<span class="keyword">long</span>)f;    <span class="comment">// 截取000110011100100011 =&gt; 10101100000011010011001(有效数字) 000000000000000000 =&gt; 1477911511040</span></div><div class="line">		System.out.println(time);   <span class="comment">// 1477911511040</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/10/31/JavaSE/Java  Float/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/10/31/JavaSE/Java  Float/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/10/27/JavaSE/LinkedHashMap/" title="LinkedHashMap" itemprop="url">LinkedHashMap</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-10-26T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-10-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><code>LinkedHashMap</code> 继承自<code>HashMap</code>, 它维护着一个运行于所有条目的双重链接列表。<br>此链接列表定义了迭代顺序，该迭代顺序通常就是将键插入到映射中的顺序（插入顺序）。</p>
<p>我们从<code>HashMap</code>的<code>putVal()</code>方法开始看<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></div><div class="line">               <span class="keyword">boolean</span> evict) &#123;</div><div class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</div><div class="line">    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</div><div class="line">        n = (tab = resize()).length;</div><div class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</div><div class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        Node&lt;K,V&gt; e; K k;</div><div class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</div><div class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">            e = p;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</div><div class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</div><div class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</div><div class="line">                    p.next = newNode(hash, key, value, <span class="keyword">null</span>);</div><div class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></div><div class="line">                        treeifyBin(tab, hash);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</div><div class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                p = e;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></div><div class="line">            V oldValue = e.value;</div><div class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</div><div class="line">                e.value = value;</div><div class="line">            afterNodeAccess(e);</div><div class="line">            <span class="keyword">return</span> oldValue;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ++modCount;</div><div class="line">    <span class="keyword">if</span> (++size &gt; threshold)</div><div class="line">        resize();</div><div class="line">    afterNodeInsertion(evict);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>newNode(hash, key, value, null);</code>时调用了<code>LinkedHashMap</code>的<code>linkNodeLast</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">linkNodeLast</span><span class="params">(LinkedHashMap.Entry&lt;K,V&gt; p)</span> </span>&#123;</div><div class="line">    LinkedHashMap.Entry&lt;K,V&gt; last = tail;</div><div class="line">    tail = p;</div><div class="line">    <span class="keyword">if</span> (last == <span class="keyword">null</span>)</div><div class="line">        head = p;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        p.before = last;</div><div class="line">        last.after = p;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个操作就是将新的Node插入到<code>LinkedHashMap</code>的尾节点.</p>
<p>我们看完插入操作, 再看一下<code>afterNodeAccess()</code>, 这个方法在<code>HashMap</code>的<code>putVal()</code>方法中, 重新插入一个数据时会调用到(还有一些其他的方法也会调用这个方法). 当重新插入数据时, 会尝试<code>afterNodeAccess()</code>调用, 然后改变<code>LinkedHashMap</code>的双向链表, 从而改变整个链表表达的插入顺序.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeAccess</span><span class="params">(Node&lt;K,V&gt; e)</span> </span>&#123; <span class="comment">// move node to last</span></div><div class="line">    LinkedHashMap.Entry&lt;K,V&gt; last;</div><div class="line">	<span class="comment">// 如果被访问的元素是最后一个元素的话, 就不处理, 否则尝试将被访问的元素移动到最后的位置</span></div><div class="line">    <span class="keyword">if</span> (accessOrder &amp;&amp; (last = tail) != e) &#123;</div><div class="line">        LinkedHashMap.Entry&lt;K,V&gt; p = (LinkedHashMap.Entry&lt;K,V&gt;)e, </div><div class="line">								 b = p.before, </div><div class="line">								 a = p.after;</div><div class="line">		</div><div class="line">		<span class="comment">// 将被访问元素p的后一个node置为null, 因为要将p放到最后面去, 因此它的后面不能再有数据</span></div><div class="line">        p.after = <span class="keyword">null</span>;</div><div class="line">		</div><div class="line">        </div><div class="line">		<span class="comment">// 下面俩个if 开始进行对p前后俩个数据进行双向绑定</span></div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (b == <span class="keyword">null</span>)</div><div class="line">			<span class="comment">// 如果p前面没有数据的话, 就将p后面的数据放到首位去, 然后将p放到最后</span></div><div class="line">            head = a;</div><div class="line">        <span class="keyword">else</span></div><div class="line">			<span class="comment">// 如果p前面有数据, 就将p后面的数据和前面的数据连接起来</span></div><div class="line">            b.after = a;</div><div class="line">			</div><div class="line">		</div><div class="line">        <span class="keyword">if</span> (a != <span class="keyword">null</span>)</div><div class="line">			<span class="comment">// 将p前面的数据绑定到p的后面的数据上.</span></div><div class="line">            a.before = b;</div><div class="line">        <span class="keyword">else</span></div><div class="line">			<span class="comment">// p后面没有数据, 因为在刚开始的if里已经判断, p不可能是最后一个元素, 但是当只有一个元素时, 可能会出现这种情况</span></div><div class="line">            last = b;</div><div class="line">        </div><div class="line">		<span class="keyword">if</span> (last == <span class="keyword">null</span>)</div><div class="line">            head = p;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// 进行置换, 将p放到队列尾</span></div><div class="line">            p.before = last;</div><div class="line">            last.after = p;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">		tail = p;</div><div class="line">        ++modCount;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面方法的if中我们可以看到,如果accessOrder为true(默认false), 当重新访问数据时, 插入顺序呢是会改变的. 也就是说在调用下列方法时</p>
<ul>
<li>put</li>
<li>replace</li>
<li>computeIfAbsent</li>
<li>compute</li>
<li>merge</li>
<li>get<br>被调用的数据会放到队列尾, 因此如果我们将accessOrder置为true, <code>LinkedHashMap</code>可以当做LRU Cache使用</li>
</ul>
<blockquote>
<p>当继承<code>LinkedHashMap</code>, 实现一个LRU Cache的时候, 我们可以重载一下<code>removeEldestEntry(Map.Entry&lt;K,V&gt; eldest)</code>这个方法, 当插入新的数据的时候, 可以灵活地处理过期的数据</p>
</blockquote>
<p>写个测试程序测试一下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestLinkedHashMap</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHashMap</span><span class="params">()</span> </span>&#123;</div><div class="line">		Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</div><div class="line">			map.put(i + <span class="string">""</span>, <span class="string">""</span>);</div><div class="line">		&#125;</div><div class="line">		testStep1(<span class="string">"testHashMap"</span>, map);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">falseAccessOrderMap</span><span class="params">()</span> </span>&#123;</div><div class="line">		LinkedHashMap&lt;String, String&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">1000</span>; i++) &#123;</div><div class="line">			map.put(i + <span class="string">""</span>, <span class="string">""</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> map;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">testStep1</span><span class="params">(String <span class="keyword">module</span>, Map&lt;String, String&gt; map)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> older = <span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span> (String string : map.keySet()) &#123;</div><div class="line">			<span class="keyword">int</span> num = Integer.parseInt(string);</div><div class="line">			<span class="keyword">if</span> ((older + <span class="number">1</span>) != num) &#123;</div><div class="line">				System.err.println(<span class="keyword">module</span> + <span class="string">" : "</span> + (older + <span class="number">1</span>) + <span class="string">" -&gt; "</span> + num);</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			older = num;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 测试 迭代顺序就是将键插入到映射中的顺序（插入顺序）</span></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">falseAccessOrderLinkedHashMap_SaveOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">		Map&lt;String, String&gt; map = falseAccessOrderMap();</div><div class="line">		testStep1(<span class="string">"falseAccessOrderLinkedHashMap_SaveOrder"</span>, map);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 测试 如果在映射中重新插入 键，则插入顺序不受影响</span></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">falseAccessOrderLinkedHashMap_RePutSaveOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">		Map&lt;String, String&gt; map = falseAccessOrderMap();</div><div class="line">		map.put(<span class="string">"123"</span>, <span class="string">""</span>);</div><div class="line">		testStep1(<span class="string">"falseAccessOrderLinkedHashMap_RePutSaveOrder"</span>, map);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">falseAccessOrderLinkedHashMap_GetSaveOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">		Map&lt;String, String&gt; map = falseAccessOrderMap();</div><div class="line">		map.put(<span class="string">"123"</span>, <span class="string">""</span>);</div><div class="line">		map.put(<span class="string">"123"</span>, <span class="string">""</span>);</div><div class="line">		map.put(<span class="string">"123"</span>, <span class="string">""</span>);</div><div class="line">		testStep1(<span class="string">"falseAccessOrderLinkedHashMap_GetSaveOrder"</span>, map);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">trueAccessOrderMap</span><span class="params">()</span> </span>&#123;</div><div class="line">		LinkedHashMap&lt;String, String&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(<span class="number">10</span>, <span class="number">0.75f</span>, <span class="keyword">true</span>);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">1000</span>; i++) &#123;</div><div class="line">			map.put(i + <span class="string">""</span>, <span class="string">""</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> map;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">trueAccessOrderLinkedHashMap_SaveOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">		Map&lt;String, String&gt; map = trueAccessOrderMap();</div><div class="line">		testStep1(<span class="string">"trueAccessOrderLinkedHashMap_SaveOrder"</span>, map);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">trueAccessOrderLinkedHashMap_RePutSaveOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">		Map&lt;String, String&gt; map = trueAccessOrderMap();</div><div class="line">		map.put(<span class="string">"123"</span>, <span class="string">""</span>);</div><div class="line">		testStep1(<span class="string">"trueAccessOrderLinkedHashMap_RePutSaveOrder"</span>, map);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">trueAccessOrderLinkedHashMap_GetSaveOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">		Map&lt;String, String&gt; map = trueAccessOrderMap();</div><div class="line">		map.put(<span class="string">"123"</span>, <span class="string">""</span>);</div><div class="line">		map.put(<span class="string">"123"</span>, <span class="string">""</span>);</div><div class="line">		map.put(<span class="string">"123"</span>, <span class="string">""</span>);</div><div class="line">		testStep1(<span class="string">"trueAccessOrderLinkedHashMap_GetSaveOrder"</span>, map);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行一下, 结果果真如此.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/10/27/JavaSE/LinkedHashMap/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/10/27/JavaSE/LinkedHashMap/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/10/24/算法/一致性hash/" title="一致性hash" itemprop="url">一致性hash</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-10-23T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-10-24</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://www.cnblogs.com/haippy/archive/2011/12/10/2282943.html" target="_blank" rel="external">原理</a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">import</span> java.util.Random;</div><div class="line"><span class="keyword">import</span> java.util.TreeMap;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConsistentHash</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Cache.INSTANCE.init();</div><div class="line">		Random random = <span class="keyword">new</span> Random(<span class="number">999999999</span>);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</div><div class="line">			<span class="keyword">long</span> number = random.nextLong();</div><div class="line">			Cache.INSTANCE.insert(number + <span class="string">""</span>, number + <span class="string">""</span>);</div><div class="line">		&#125;</div><div class="line">		System.out.println(Cache.INSTANCE);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Cache</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Cache INSTANCE = <span class="keyword">new</span> Cache();</div><div class="line"></div><div class="line">		<span class="keyword">private</span> Integer virtualNodeSize = <span class="number">50</span>;</div><div class="line">		<span class="keyword">private</span> Integer serverNodeSize = <span class="number">10</span>;</div><div class="line">		<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer MIN_HASH = <span class="number">0</span>;</div><div class="line">		<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MAX_HASH = (<span class="keyword">long</span>)(Math.pow(<span class="number">2</span>,<span class="number">32</span>) - <span class="number">1</span>);</div><div class="line"></div><div class="line">		<span class="keyword">private</span> Integer serverNodeIndex = <span class="number">0</span>;</div><div class="line"></div><div class="line">		<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ExecutorService exec = Executors.newSingleThreadExecutor();</div><div class="line"></div><div class="line">		<span class="keyword">private</span> Map&lt;Long, VirtualNode&gt; virtualNodes = <span class="keyword">new</span> TreeMap&lt;&gt;();</div><div class="line">		<span class="keyword">private</span> Map&lt;Integer, ServerNode&gt; serverNodes = <span class="keyword">new</span> TreeMap&lt;&gt;();</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">private</span> <span class="title">Cache</span><span class="params">()</span> </span>&#123;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; serverNodeSize; i++) &#123;</div><div class="line">				serverNodes.put(i, <span class="keyword">new</span> ServerNode());</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			System.out.println(<span class="string">"ServerNode Number : "</span> + serverNodes.size());</div><div class="line"></div><div class="line">			<span class="keyword">long</span> step = MAX_HASH / virtualNodeSize;</div><div class="line">			<span class="keyword">long</span> hashCode = <span class="number">0</span>;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; virtualNodeSize; i++) &#123;</div><div class="line">				VirtualNode virtualNode = <span class="keyword">new</span> VirtualNode();</div><div class="line">				virtualNode.setServerNode(serverNodes.get(serverNodeIndex++));</div><div class="line"></div><div class="line">				hashCode += step;</div><div class="line">				virtualNodes.put(hashCode, virtualNode);</div><div class="line">				System.out.println(<span class="string">"Add VirtualNode : "</span> + hashCode);</div><div class="line">			&#125;</div><div class="line">			System.out.println(<span class="string">"VirtualNode Number : "</span> + virtualNodes.size());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addVirtualNode</span><span class="params">()</span> </span>&#123;</div><div class="line">			exec.submit(() -&gt; &#123;</div><div class="line">				virtualNodes.clear();</div><div class="line">				++virtualNodeSize;</div><div class="line">				init();</div><div class="line">			&#125;);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeVirtualNode</span><span class="params">()</span> </span>&#123;</div><div class="line">			exec.submit(() -&gt; &#123;</div><div class="line">				virtualNodes.clear();</div><div class="line">				--virtualNodeSize;</div><div class="line">				init();</div><div class="line">			&#125;);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addServerNode</span><span class="params">()</span> </span>&#123;</div><div class="line">			exec.submit(() -&gt; &#123;</div><div class="line">				virtualNodes.clear();</div><div class="line">				serverNodes.clear();</div><div class="line">				serverNodeIndex++;</div><div class="line">				init();</div><div class="line">			&#125;);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeServerNode</span><span class="params">()</span> </span>&#123;</div><div class="line">			exec.submit(() -&gt; &#123;</div><div class="line">				virtualNodes.clear();</div><div class="line">				serverNodes.clear();</div><div class="line">				serverNodeIndex--;</div><div class="line">				init();</div><div class="line">			&#125;);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(String key, String value)</span> </span>&#123;</div><div class="line">			exec.submit(() -&gt; &#123;</div><div class="line">				<span class="keyword">int</span> hashCode = key.hashCode();</div><div class="line">				<span class="keyword">for</span> (Map.Entry&lt;Long, VirtualNode&gt; entry : virtualNodes.entrySet()) &#123;</div><div class="line">					<span class="keyword">long</span> hashcode = entry.getKey();</div><div class="line">					VirtualNode node = entry.getValue();</div><div class="line">					<span class="keyword">if</span> (hashCode &gt;= hashcode ) &#123;</div><div class="line">						node.insert(key, value);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">			StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</div><div class="line">			<span class="keyword">for</span> (Map.Entry&lt;Integer, ServerNode&gt; entry : serverNodes.entrySet()) &#123;</div><div class="line">				<span class="keyword">int</span> key1 = entry.getKey();</div><div class="line">				ServerNode node = entry.getValue();</div><div class="line">				stringBuffer.append(key1).append(<span class="string">" : "</span>).append(node.map.keySet().size()).append(<span class="string">"\n"</span>);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> stringBuffer.toString();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 虚拟节点</div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">VirtualNode</span> </span>&#123;</div><div class="line">		<span class="keyword">private</span> ServerNode serverNode;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(String key, String value)</span> </span>&#123;</div><div class="line">			serverNode.insert(key, value);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">			<span class="keyword">return</span> serverNode.get(key);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setServerNode</span><span class="params">(ServerNode serverNode)</span> </span>&#123;</div><div class="line">			<span class="keyword">this</span>.serverNode = serverNode;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 代表真实服务器</div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerNode</span> </span>&#123;</div><div class="line">		<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(String key, String value)</span> </span>&#123;</div><div class="line">			map.put(key, value);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">			<span class="keyword">return</span> map.get(key);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/算法/">算法</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/10/24/算法/一致性hash/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/10/24/算法/一致性hash/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/10/11/JavaLibrary/Jackson/" title="Jackson" itemprop="url">Jackson</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-10-10T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-10-11</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>Jackson 提供了三种对JSON处理的方式</p>
<ul>
<li>Data Binding </li>
<li>Tree Model</li>
<li>Streaming API</li>
</ul>
<h2 id="Data-Binding"><a href="#Data-Binding" class="headerlink" title="Data Binding"></a>Data Binding</h2><p>这种方式提供了JSON数据和Java对象之间的无缝转换，而且这种方式是相当便利的. 它内部基于 Streaming API 的JSON 读写系统, 尽管Data Binding 是非常高效地,但是相比纯　streaming/incremental 方式，仍然有一些额外的性能消耗．</p>
<h3 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">   <span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_Serialization</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	Obj obj = <span class="keyword">new</span> Obj();</div><div class="line">	obj.platform = <span class="string">"qq"</span>;</div><div class="line">	StringWriter stringWriter = <span class="keyword">new</span> StringWriter();</div><div class="line"></div><div class="line">	ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">	objectMapper.writeValue(stringWriter, obj);</div><div class="line"></div><div class="line">	System.out.println(stringWriter);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出为<code>{&quot;platform&quot;:&quot;qq&quot;}</code></p>
<h3 id="数据绑定"><a href="#数据绑定" class="headerlink" title="数据绑定"></a>数据绑定</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_ObjectMapperRead</span> <span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	String jsonStr = <span class="string">"&#123;\"platform\":\"1\"&#125;"</span>;</div><div class="line">	ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">	Obj obj = objectMapper.readValue(jsonStr, Obj.class);</div><div class="line">	System.out.println(obj.platform);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出为<code>1</code></p>
<h3 id="泛型绑定"><a href="#泛型绑定" class="headerlink" title="泛型绑定"></a>泛型绑定</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_Serialization</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	Map&lt;Integer, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">	map.put(<span class="number">2016</span>, <span class="string">"10/11"</span>);</div><div class="line">	StringWriter stringWriter = <span class="keyword">new</span> StringWriter();</div><div class="line"></div><div class="line">	ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">	objectMapper.writeValue(stringWriter, map);</div><div class="line"></div><div class="line">	Map&lt;Integer, String&gt; newMap = objectMapper.readValue(stringWriter.toString(), <span class="keyword">new</span> TypeReference&lt;Map&lt;Integer, String&gt;&gt;() &#123;&#125;);</div><div class="line">	System.out.println(newMap.get(<span class="number">2016</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出为<code>10/11</code></p>
<h3 id="数组绑定"><a href="#数组绑定" class="headerlink" title="数组绑定"></a>数组绑定</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_Binding</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		String[] array = &#123;<span class="string">"2016"</span>&#125;;</div><div class="line">		StringWriter stringWriter = <span class="keyword">new</span> StringWriter();</div><div class="line"></div><div class="line">		ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">		objectMapper.writeValue(stringWriter, array);</div><div class="line"></div><div class="line">		String[] arr = objectMapper.readValue(stringWriter.toString(), String[].class);</div><div class="line">		System.out.println(arr[<span class="number">0</span>]);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h3 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h3><p>ObjectMapper被共享出来之后, 只要重新配置共享实例, 那么它就是线程安全的. 也就是不要调用下列方法</p>
<ul>
<li><code>enable()</code></li>
<li><code>disable()</code></li>
<li><code>configure()</code></li>
</ul>
<p>参考</p>
<ul>
<li><a href="http://stackoverflow.com/questions/3907929/should-i-declare-jacksons-objectmapper-as-a-static-field" target="_blank" rel="external">Should I declare Jackson’s ObjectMapper as a static field?</a></li>
<li><a href="http://wiki.fasterxml.com/JacksonFAQThreadSafety" target="_blank" rel="external">Jackson FAQ: Thread-Safety</a></li>
</ul>
<h2 id="Tree-Model"><a href="#Tree-Model" class="headerlink" title="Tree Model"></a>Tree Model</h2><p>Tree Model 和XML 处理方式 非常类似.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.JsonNode;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestTreeModel</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		Obj1 obj1 = <span class="keyword">new</span> Obj1();</div><div class="line">		Obj2 obj2 = <span class="keyword">new</span> Obj2();</div><div class="line">		Obj3 obj3 = <span class="keyword">new</span> Obj3();</div><div class="line">		obj1.obj2 = obj2;</div><div class="line">		obj2.obj3 = obj3;</div><div class="line">		obj3.string = <span class="string">"hello"</span>;</div><div class="line"></div><div class="line">		ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">		String str = objectMapper.writeValueAsString(obj1);</div><div class="line">		JsonNode objtree = objectMapper.readTree(str);</div><div class="line">		System.out.println(<span class="string">"get obj2 : "</span> + objtree.get(<span class="string">"obj2"</span>));</div><div class="line">		System.out.println(<span class="string">"get obj3 : "</span> + objtree.get(<span class="string">"obj3"</span>));</div><div class="line">		System.out.println(<span class="string">"get string : "</span> + objtree.get(<span class="string">"string"</span>));</div><div class="line"></div><div class="line">		System.out.println(<span class="string">"path obj2 : "</span> + objtree.path(<span class="string">"obj2"</span>));</div><div class="line">		System.out.println(<span class="string">"path obj3 : "</span> + objtree.path(<span class="string">"obj3"</span>));</div><div class="line">		System.out.println(<span class="string">"path string : "</span> + objtree.path(<span class="string">"string"</span>));</div><div class="line"></div><div class="line">		System.out.println(<span class="string">"path string obj2 -&gt; obj3 -&gt; string : "</span> + objtree.path(<span class="string">"obj2"</span>).path(<span class="string">"obj3"</span>).path(<span class="string">"string"</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Obj1</span> </span>&#123;</div><div class="line">		<span class="keyword">public</span> Obj2 obj2;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Obj2</span> </span>&#123;</div><div class="line">		<span class="keyword">public</span> Obj3 obj3;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Obj3</span> </span>&#123;</div><div class="line">		<span class="keyword">public</span> String string;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">get obj2 : &#123;<span class="string">"obj3"</span>:&#123;<span class="string">"string"</span>:<span class="string">"hello"</span>&#125;&#125;</div><div class="line">get obj3 : null</div><div class="line">get string : null</div><div class="line">path obj2 : &#123;<span class="string">"obj3"</span>:&#123;<span class="string">"string"</span>:<span class="string">"hello"</span>&#125;&#125;</div><div class="line">path obj3 : </div><div class="line">path string : </div><div class="line">path string obj2 -&gt; obj3 -&gt; string : <span class="string">"hello"</span></div></pre></td></tr></table></figure></p>
<p>当调用<code>get()</code>方法时, 如果找不到的话, 会返回<code>null</code>, 而<code>path()</code>找不到的话则会返回<code>MissingNode</code></p>
<p>还有一个方法<code>with(int index)</code>我们没有演示, 这个方法是如果找不到就添加.</p>
<p><code>get()</code>方法还有一个特别有用的地方就是用来处理数组.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.JsonNode;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestTreeModel</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		Obj1 obj1 = <span class="keyword">new</span> Obj1();</div><div class="line"></div><div class="line">		ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">		String str = objectMapper.writeValueAsString(obj1);</div><div class="line">		System.out.println(str);</div><div class="line"></div><div class="line">		JsonNode tree = objectMapper.readTree(str);</div><div class="line">		System.out.println(tree.get(<span class="string">"strings"</span>).get(<span class="number">1</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Obj1</span> </span>&#123;</div><div class="line">		<span class="keyword">public</span> String[] strings = &#123;<span class="string">"123"</span>, <span class="string">"456"</span>&#125;;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="string">"strings"</span>:[<span class="string">"123"</span>,<span class="string">"456"</span>]&#125;</div><div class="line"><span class="string">"456"</span></div></pre></td></tr></table></figure></p>
<h2 id="Streaming-API"><a href="#Streaming-API" class="headerlink" title="Streaming API"></a>Streaming API</h2><p>Streaming API 是 Jackson处理 JSON最高效地方式. 但是它的易用性却大大地降低了, 我们不能像Data Binding 或者 Tree Model 那样随机访问元素.</p>
<h2 id="SerializationFeature"><a href="#SerializationFeature" class="headerlink" title="SerializationFeature"></a>SerializationFeature</h2><h3 id="WRAP-ROOT-VALUE"><a href="#WRAP-ROOT-VALUE" class="headerlink" title="WRAP_ROOT_VALUE"></a>WRAP_ROOT_VALUE</h3><p>是否环绕根元素，默认false，如果为true，则默认以类名作为根元素，也可以通过<code>@JsonRootName</code>来自定义根元素名称<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializationFeature;</div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDataBinding</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_SerializationFeature</span> <span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">		objectMapper.enable(SerializationFeature.WRAP_ROOT_VALUE);</div><div class="line">		System.out.println( objectMapper.writeValueAsString(<span class="keyword">new</span> Obj()));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Obj</span> </span>&#123;</div><div class="line">		<span class="keyword">public</span> String platform = <span class="string">"example"</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<code>{&quot;Obj&quot;:{&quot;platform&quot;:&quot;example&quot;}}</code> 如果不开启<code>WRAP_ROOT_VALUE</code>的话, 结果为<code>{&quot;platform&quot;:&quot;example&quot;}</code></p>
<h3 id="INDENT-OUTPUT"><a href="#INDENT-OUTPUT" class="headerlink" title="INDENT_OUTPUT"></a>INDENT_OUTPUT</h3><p> 是否缩放排列输出<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">objectMapper.enable(SerializationFeature.INDENT_OUTPUT);</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"platform"</span> : <span class="string">"example"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="WRITE-DATES-AS-TIMESTAMPS"><a href="#WRITE-DATES-AS-TIMESTAMPS" class="headerlink" title="WRITE_DATES_AS_TIMESTAMPS"></a>WRITE_DATES_AS_TIMESTAMPS</h3><p>序列化日期时以timestamps输出<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDataBinding</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_SerializationFeature</span> <span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">		objectMapper.enable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);</div><div class="line">		System.out.println( objectMapper.writeValueAsString(<span class="keyword">new</span> Obj()));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Obj</span> </span>&#123;</div><div class="line">		<span class="keyword">public</span> Date now = <span class="keyword">new</span> Date();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="string">"now"</span>:1476179780913&#125;</div></pre></td></tr></table></figure></p>
<h3 id="WRITE-CHAR-ARRAYS-AS-JSON-ARRAYS"><a href="#WRITE-CHAR-ARRAYS-AS-JSON-ARRAYS" class="headerlink" title="WRITE_CHAR_ARRAYS_AS_JSON_ARRAYS"></a>WRITE_CHAR_ARRAYS_AS_JSON_ARRAYS</h3><p>序列化char[]时以json数组输出</p>
<h3 id="ORDER-MAP-ENTRIES-BY-KEYS"><a href="#ORDER-MAP-ENTRIES-BY-KEYS" class="headerlink" title="ORDER_MAP_ENTRIES_BY_KEYS"></a>ORDER_MAP_ENTRIES_BY_KEYS</h3><p>序列化Map时对key进行排序操作</p>
<h2 id="DeserializationFeature"><a href="#DeserializationFeature" class="headerlink" title="DeserializationFeature"></a>DeserializationFeature</h2><h3 id="FAIL-ON-UNKNOWN-PROPERTIES"><a href="#FAIL-ON-UNKNOWN-PROPERTIES" class="headerlink" title="FAIL_ON_UNKNOWN_PROPERTIES"></a>FAIL_ON_UNKNOWN_PROPERTIES</h3><p>在反序列化时, 如果Java对象中不包含json串的某个数据 属性, 则会报错.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDataBinding</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_SerializationFeature</span> <span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">		objectMapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);</div><div class="line"></div><div class="line">		String str = <span class="string">"&#123;\"strings1\":[\"123\"],\"strings2\":[\"456\"]&#125;"</span>;</div><div class="line">		objectMapper.readValue(str, Obj.class);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Obj</span> </span>&#123;</div><div class="line">		<span class="keyword">public</span> String[] strings1 = &#123;<span class="string">"123"</span>&#125;;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="MapperFeature"><a href="#MapperFeature" class="headerlink" title="MapperFeature"></a>MapperFeature</h2><h3 id="ACCEPT-CASE-INSENSITIVE-PROPERTIES"><a href="#ACCEPT-CASE-INSENSITIVE-PROPERTIES" class="headerlink" title="ACCEPT_CASE_INSENSITIVE_PROPERTIES"></a>ACCEPT_CASE_INSENSITIVE_PROPERTIES</h3><p> 在反序列化时是否忽略大小写<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.MapperFeature;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDataBinding</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_SerializationFeature</span> <span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">		Upper upper = <span class="keyword">new</span> Upper();</div><div class="line">		upper.setFirstName(<span class="string">"John"</span>);</div><div class="line">		System.out.println(objectMapper.writeValueAsString(upper));</div><div class="line"></div><div class="line">		Lower lower = <span class="keyword">new</span> Lower();</div><div class="line">		lower.setLastName(<span class="string">"li"</span>);</div><div class="line">		System.out.println(objectMapper.writeValueAsString(lower));</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_DeserializationFeature</span> <span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">		objectMapper.enable(MapperFeature.ACCEPT_CASE_INSENSITIVE_PROPERTIES);</div><div class="line"></div><div class="line">		Upper obj1 = objectMapper.readValue(<span class="string">"&#123;\"firstName\":\"John\"&#125;"</span>, Upper.class);</div><div class="line">		System.out.println(obj1.getFirstName());</div><div class="line"></div><div class="line">		Upper obj2 = objectMapper.readValue(<span class="string">"&#123;\"FirstName\":\"John\"&#125;"</span>, Upper.class);</div><div class="line">		System.out.println(obj2.getFirstName());</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Upper</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> String FirstName;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getFirstName</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> FirstName;&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFirstName</span><span class="params">(String firstName)</span> </span>&#123;FirstName = firstName;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lower</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> String lastName;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getLastName</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> lastName;&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLastName</span><span class="params">(String lastName)</span> </span>&#123;<span class="keyword">this</span>.lastName = lastName;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>test_SerializationFeature()</code>这个测试中, 我们可以通过结果看到, Upper的<code>FirstName</code>在JSON串 中成了<code>firstName</code>. 当反序列化得时候, 如果不指定<code>ACCEPT_CASE_INSENSITIVE_PROPERTIES</code>, 那么当JSON串中的<code>FirstName</code>为大写的时候, 是没办法序列化出来的.</p>
<h2 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h2><h3 id="JsonProperty"><a href="#JsonProperty" class="headerlink" title="JsonProperty"></a>JsonProperty</h3><p>jackson 默认是根据Getter来进行注值反序列化的, 但是有时候为了节省存储空间, 字段名远小于Getter名称, 这样就造成了字段名和方法名不一致, 此时就可以利用JsonProperty注解重命名来解决这个问题<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonProperty;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.MapperFeature;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDataBinding</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_Deferent</span> <span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">		objectMapper.enable(MapperFeature.ACCEPT_CASE_INSENSITIVE_PROPERTIES);</div><div class="line"></div><div class="line">		Different different = <span class="keyword">new</span> Different();</div><div class="line">		different.setMiddle(<span class="string">"Nice"</span>);</div><div class="line">		System.out.println(objectMapper.writeValueAsString(different));</div><div class="line"></div><div class="line">		Different obj2 = objectMapper.readValue(<span class="string">"&#123;\"middle\":\"Nice\"&#125;"</span>, Different.class);</div><div class="line">		System.out.println(obj2.getMiddle());</div><div class="line"></div><div class="line">		Different obj3 = objectMapper.readValue(<span class="string">"&#123;\"Mid\":\"Nice\"&#125;"</span>, Different.class);</div><div class="line">		System.out.println(obj3.getMiddle());</div><div class="line"></div><div class="line">		Different obj4 = objectMapper.readValue(<span class="string">"&#123;\"mid\":\"Nice\"&#125;"</span>, Different.class);</div><div class="line">		System.out.println(obj4.getMiddle());</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Different</span> </span>&#123;</div><div class="line">	<span class="meta">@JsonProperty</span>(<span class="string">"mid"</span>)</div><div class="line">	<span class="keyword">private</span> String Mid;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getMiddle</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> Mid;&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMiddle</span><span class="params">(String middle)</span> </span>&#123;<span class="keyword">this</span>.Mid = middle;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>说到这里就需要点出一个坑了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</div><div class="line"><span class="keyword">import</span> com.google.gson.Gson;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestPrivate</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line"></div><div class="line">		SimpleId simpleId = <span class="keyword">new</span> SimpleId();</div><div class="line">		simpleId.setString(<span class="string">"simple Id"</span>);</div><div class="line">		String json = objectMapper.writeValueAsString(simpleId);</div><div class="line">		System.out.println(<span class="string">"Jsckson  ---&gt; "</span> + json);</div><div class="line"></div><div class="line">		Gson gson = <span class="keyword">new</span> Gson();</div><div class="line">		json = gson.toJson(simpleId);</div><div class="line">		System.out.println(<span class="string">"Gson     ---&gt; "</span> + json);</div><div class="line"></div><div class="line">		json = JSON.toJSONString(simpleId);</div><div class="line">		System.out.println(<span class="string">"FastJson ---&gt; "</span> + json);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleId</span> </span>&#123;</div><div class="line">		<span class="keyword">private</span> String stringId;</div><div class="line">		<span class="keyword">private</span> String stringName = <span class="string">"empty name"</span>;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="keyword">return</span> stringId;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setString</span><span class="params">(String string)</span> </span>&#123;</div><div class="line">			<span class="keyword">this</span>.stringId = string;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> String <span class="title">getString1</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="keyword">return</span> <span class="string">"123456"</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Jsckson  ---&gt; &#123;<span class="string">"string"</span>:<span class="string">"simple Id"</span>,<span class="string">"string1"</span>:<span class="string">"123456"</span>&#125;</div><div class="line">Gson     ---&gt; &#123;<span class="string">"stringId"</span>:<span class="string">"simple Id"</span>,<span class="string">"stringName"</span>:<span class="string">"empty name"</span>&#125;</div><div class="line">FastJson ---&gt; &#123;<span class="string">"string"</span>:<span class="string">"simple Id"</span>,<span class="string">"string1"</span>:<span class="string">"123456"</span>&#125;</div></pre></td></tr></table></figure></p>
<p>有时候我们需要Gson这种输出结果, 即不使用Getter, 而是使用filed进行序列化, 怎么办呢？我们可以使用<code>@JsonAutoDetect(fieldVisibility = Visibility.ANY, getterVisibility = Visibility.NONE, setterVisibility = Visibility.NONE)</code>, 但是对于有时候我们并不想在每个类上面都加一个这样的注解, 配置一些ObjectMapper就可以了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">objectMapper.setVisibility(objectMapper.getSerializationConfig().getDefaultVisibilityChecker()</div><div class="line">		.withFieldVisibility(JsonAutoDetect.Visibility.ANY)</div><div class="line">		.withGetterVisibility(JsonAutoDetect.Visibility.NONE)</div><div class="line">		.withSetterVisibility(JsonAutoDetect.Visibility.NONE)</div><div class="line">		.withCreatorVisibility(JsonAutoDetect.Visibility.NONE));</div></pre></td></tr></table></figure></p>
<p>这样结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Jsckson  ---&gt; &#123;<span class="string">"stringId"</span>:<span class="string">"simple Id"</span>,<span class="string">"stringName"</span>:<span class="string">"empty name"</span>&#125;</div><div class="line">Gson     ---&gt; &#123;<span class="string">"stringId"</span>:<span class="string">"simple Id"</span>,<span class="string">"stringName"</span>:<span class="string">"empty name"</span>&#125;</div><div class="line">FastJson ---&gt; &#123;<span class="string">"string"</span>:<span class="string">"simple Id"</span>,<span class="string">"string1"</span>:<span class="string">"123456"</span>&#125;</div></pre></td></tr></table></figure></p>
<h3 id="JsonInclude"><a href="#JsonInclude" class="headerlink" title="JsonInclude"></a>JsonInclude</h3><p>指定在序列化时, 可以输出哪些值. 例如只输出非默认值(包含类型默认值和初始化默认值)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonInclude;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDefault</span> </span>&#123;</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException </span>&#123;</div><div class="line">		ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">		Foo foo = <span class="keyword">new</span> Foo();</div><div class="line">		foo.string1 = <span class="string">"123"</span>;</div><div class="line">		System.out.println(objectMapper.writeValueAsString(foo));</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@JsonInclude</span>(JsonInclude.Include.NON_DEFAULT)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> String string1;</div><div class="line">	<span class="keyword">public</span> String string2 = <span class="string">"xxx"</span>;</div><div class="line">	<span class="keyword">public</span> String string3;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="JsonSerialize"><a href="#JsonSerialize" class="headerlink" title="JsonSerialize"></a>JsonSerialize</h3><p>实现浮点数只保留俩位<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonGenerator;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.JsonSerializer;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializerProvider;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.annotation.JsonSerialize;</div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.text.DecimalFormat;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDouble</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException </span>&#123;</div><div class="line">		DoubleObject doubleObject = <span class="keyword">new</span> DoubleObject();</div><div class="line">		doubleObject.aDouble = <span class="number">1.101010101010101</span>;</div><div class="line">		doubleObject.aFloat = <span class="number">1.101010101010101f</span>;</div><div class="line"></div><div class="line">		ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">		String string = objectMapper.writeValueAsString(doubleObject);</div><div class="line">		System.out.println(string);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomDoubleSerializer</span> <span class="keyword">extends</span> <span class="title">JsonSerializer</span>&lt;<span class="title">Number</span>&gt; </span>&#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Number value, JsonGenerator jgen, SerializerProvider provider)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">			<span class="keyword">if</span> (<span class="keyword">null</span> == value) &#123;</div><div class="line">				jgen.writeNull();</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Double || value <span class="keyword">instanceof</span> Float)&#123;</div><div class="line">				<span class="keyword">final</span> String pattern = <span class="string">".##"</span>;</div><div class="line">				<span class="keyword">final</span> DecimalFormat myFormatter = <span class="keyword">new</span> DecimalFormat(pattern);</div><div class="line">				<span class="keyword">final</span> String output = myFormatter.format(value);</div><div class="line">				jgen.writeNumber(output);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DoubleObject</span> </span>&#123;</div><div class="line">		<span class="meta">@JsonSerialize</span>(using = CustomDoubleSerializer.class)</div><div class="line">		<span class="keyword">private</span> <span class="keyword">double</span> aDouble;</div><div class="line">		<span class="meta">@JsonSerialize</span>(using = CustomDoubleSerializer.class)</div><div class="line">		<span class="keyword">private</span> <span class="keyword">float</span> aFloat;</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getaDouble</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> aDouble;&#125;</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setaDouble</span><span class="params">(<span class="keyword">double</span> aDouble)</span> </span>&#123;<span class="keyword">this</span>.aDouble = aDouble;&#125;</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getaFloat</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> aFloat;&#125;</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setaFloat</span><span class="params">(<span class="keyword">float</span> aFloat)</span> </span>&#123;<span class="keyword">this</span>.aFloat = aFloat;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="module"><a href="#module" class="headerlink" title="module"></a>module</h2><p>可以通过module来自定义实现 序列化和反序列机制. 下面的例子中就是演示对Double类型的序列化时保留浮点数位数的实现</p>
<blockquote>
<p>注意 如果注解和自定义序列化重复时, 那么注解的设置会覆盖自定义序列化机制. 而且对于原生类型来说, 是区分原生类型和包装类型的</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonGenerator;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.JsonSerializer;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializerProvider;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.annotation.JsonSerialize;</div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.<span class="keyword">module</span>.SimpleModule;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.text.DecimalFormat;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestModule</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectMapper objectMapper;</div><div class="line"></div><div class="line">	<span class="keyword">static</span> &#123;</div><div class="line">		objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">		SimpleModule simpleModule = <span class="keyword">new</span> SimpleModule();</div><div class="line">		simpleModule.addSerializer(Double.class, <span class="keyword">new</span> CustomFiveDoubleSerializer());</div><div class="line">		simpleModule.addSerializer(<span class="keyword">double</span>.class, <span class="keyword">new</span> CustomFiveDoubleSerializer());</div><div class="line">		objectMapper.registerModule(simpleModule);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomFiveDoubleSerializer</span> <span class="keyword">extends</span> <span class="title">JsonSerializer</span>&lt;<span class="title">Number</span>&gt; </span>&#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Number value, JsonGenerator jgen, SerializerProvider provider)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">			<span class="keyword">if</span> (<span class="keyword">null</span> == value) &#123;</div><div class="line">				jgen.writeNull();</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Double || value <span class="keyword">instanceof</span> Float)&#123;</div><div class="line">				<span class="keyword">final</span> String pattern = <span class="string">".#####"</span>;</div><div class="line">				<span class="keyword">final</span> DecimalFormat myFormatter = <span class="keyword">new</span> DecimalFormat(pattern);</div><div class="line">				<span class="keyword">final</span> String output = myFormatter.format(value);</div><div class="line">				jgen.writeNumber(output);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomOneDoubleSerializer</span> <span class="keyword">extends</span> <span class="title">JsonSerializer</span>&lt;<span class="title">Number</span>&gt; </span>&#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Number value, JsonGenerator jgen, SerializerProvider provider)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">			<span class="keyword">if</span> (<span class="keyword">null</span> == value) &#123;</div><div class="line">				jgen.writeNull();</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Double || value <span class="keyword">instanceof</span> Float)&#123;</div><div class="line">				<span class="keyword">final</span> String pattern = <span class="string">".#"</span>;</div><div class="line">				<span class="keyword">final</span> DecimalFormat myFormatter = <span class="keyword">new</span> DecimalFormat(pattern);</div><div class="line">				<span class="keyword">final</span> String output = myFormatter.format(value);</div><div class="line">				jgen.writeNumber(output);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JsonProcessingException </span>&#123;</div><div class="line">		Obj obj = <span class="keyword">new</span> Obj();</div><div class="line">		obj.aDouble1 = <span class="number">1.111111111111</span>;</div><div class="line">		obj.aDouble2 = <span class="number">1.111111111111</span>;</div><div class="line"></div><div class="line">		System.out.println(objectMapper.writeValueAsString(obj));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Obj</span> </span>&#123;</div><div class="line">		<span class="keyword">public</span> Double aDouble1;</div><div class="line">		<span class="meta">@JsonSerialize</span>(using = CustomOneDoubleSerializer.class)</div><div class="line">		<span class="keyword">public</span> Double aDouble2;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/10/11/JavaLibrary/Jackson/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/10/11/JavaLibrary/Jackson/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/09/26/JavaSE/Java String/" title="Java 字符串优化" itemprop="url">Java 字符串优化</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-09-25T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-09-26</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>今天review同事写的一段代码, 在枚举中动态生成字符串key的时候, 使用字符串常量进行拼接, 虽然感觉这么写会有一定的GC性能消耗, 但是具体原因有点忘记了, 今天就重新写段测试代码,进行测试一下.</p>
<p>当使用字符串(<code>String</code>)的时候, Java编译器会给我们自动的做一些优化编译的工作. 下面我们分别用三段代码, 从GC和编译俩个角度看看Java是如何给我们优化的.</p>
<p>首先呢,我们使用<code>-XX:+PrintHeapAtGC  -Xmx10M -Xms10M</code>这个参数分别运行以下三段代码</p>
<p>首先看一下<code>TestCombine1</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCombine1</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String str1 = <span class="keyword">new</span> String(<span class="string">"123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789"</span>);</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</div><div class="line">			String string1 = <span class="string">"string"</span> + str1;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">&#123;Heap before GC invocations=1 (full 0):</div><div class="line"> PSYoungGen      total 2560K, used 2048K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 2048K, 100% used [0x00000000ffd00000,0x00000000fff00000,0x00000000fff00000)</div><div class="line">  from space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 7168K, used 0K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)</div><div class="line">  object space 7168K, 0% used [0x00000000ff600000,0x00000000ff600000,0x00000000ffd00000)</div><div class="line"> Metaspace       used 2754K, capacity 4480K, committed 4480K, reserved 1056768K</div><div class="line">  class space    used 296K, capacity 384K, committed 384K, reserved 1048576K</div><div class="line">Heap after GC invocations=1 (full 0):</div><div class="line"> PSYoungGen      total 2560K, used 488K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 2048K, 0% used [0x00000000ffd00000,0x00000000ffd00000,0x00000000fff00000)</div><div class="line">  from space 512K, 95% used [0x00000000fff00000,0x00000000fff7a020,0x00000000fff80000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line"> ParOldGen       total 7168K, used 530K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)</div><div class="line">  object space 7168K, 7% used [0x00000000ff600000,0x00000000ff684ac0,0x00000000ffd00000)</div><div class="line"> Metaspace       used 2754K, capacity 4480K, committed 4480K, reserved 1056768K</div><div class="line">  class space    used 296K, capacity 384K, committed 384K, reserved 1048576K</div><div class="line">&#125;</div><div class="line">&#123;Heap before GC invocations=2 (full 0):</div><div class="line"> PSYoungGen      total 2560K, used 2536K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 2048K, 100% used [0x00000000ffd00000,0x00000000fff00000,0x00000000fff00000)</div><div class="line">  from space 512K, 95% used [0x00000000fff00000,0x00000000fff7a020,0x00000000fff80000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line"> ParOldGen       total 7168K, used 530K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)</div><div class="line">  object space 7168K, 7% used [0x00000000ff600000,0x00000000ff684ac0,0x00000000ffd00000)</div><div class="line"> Metaspace       used 2969K, capacity 4490K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 319K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">Heap after GC invocations=2 (full 0):</div><div class="line"> PSYoungGen      total 2560K, used 504K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 2048K, 0% used [0x00000000ffd00000,0x00000000ffd00000,0x00000000fff00000)</div><div class="line">  from space 512K, 98% used [0x00000000fff80000,0x00000000ffffe010,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 7168K, used 581K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)</div><div class="line">  object space 7168K, 8% used [0x00000000ff600000,0x00000000ff691670,0x00000000ffd00000)</div><div class="line"> Metaspace       used 2969K, capacity 4490K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 319K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">&#125;</div><div class="line">...</div><div class="line">&#123;Heap before GC invocations=38 (full 0):</div><div class="line"> PSYoungGen      total 2560K, used 2080K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 2048K, 100% used [0x00000000ffd00000,0x00000000fff00000,0x00000000fff00000)</div><div class="line">  from space 512K, 6% used [0x00000000fff00000,0x00000000fff08000,0x00000000fff80000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line"> ParOldGen       total 7168K, used 1212K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)</div><div class="line">  object space 7168K, 16% used [0x00000000ff600000,0x00000000ff72f050,0x00000000ffd00000)</div><div class="line"> Metaspace       used 3236K, capacity 4494K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 351K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">Heap after GC invocations=38 (full 0):</div><div class="line"> PSYoungGen      total 2560K, used 32K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 2048K, 0% used [0x00000000ffd00000,0x00000000ffd00000,0x00000000fff00000)</div><div class="line">  from space 512K, 6% used [0x00000000fff80000,0x00000000fff88000,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 7168K, used 1212K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)</div><div class="line">  object space 7168K, 16% used [0x00000000ff600000,0x00000000ff72f050,0x00000000ffd00000)</div><div class="line"> Metaspace       used 3236K, capacity 4494K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 351K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们看到一共GC了38次.</p>
<p>接下来看一下<code>TestCombine2</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCombine2</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</div><div class="line">			String string3 = <span class="string">"string"</span> + getFieldConstant();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getFieldConstant</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789"</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">&#123;Heap before GC invocations=1 (full 0):</div><div class="line"> PSYoungGen      total 2560K, used 2048K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 2048K, 100% used [0x00000000ffd00000,0x00000000fff00000,0x00000000fff00000)</div><div class="line">  from space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 7168K, used 0K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)</div><div class="line">  object space 7168K, 0% used [0x00000000ff600000,0x00000000ff600000,0x00000000ffd00000)</div><div class="line"> Metaspace       used 2752K, capacity 4480K, committed 4480K, reserved 1056768K</div><div class="line">  class space    used 296K, capacity 384K, committed 384K, reserved 1048576K</div><div class="line">Heap after GC invocations=1 (full 0):</div><div class="line"> PSYoungGen      total 2560K, used 504K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 2048K, 0% used [0x00000000ffd00000,0x00000000ffd00000,0x00000000fff00000)</div><div class="line">  from space 512K, 98% used [0x00000000fff00000,0x00000000fff7e010,0x00000000fff80000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line"> ParOldGen       total 7168K, used 489K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)</div><div class="line">  object space 7168K, 6% used [0x00000000ff600000,0x00000000ff67a598,0x00000000ffd00000)</div><div class="line"> Metaspace       used 2752K, capacity 4480K, committed 4480K, reserved 1056768K</div><div class="line">  class space    used 296K, capacity 384K, committed 384K, reserved 1048576K</div><div class="line">&#125;</div><div class="line">...</div><div class="line">&#123;Heap before GC invocations=38 (full 0):</div><div class="line"> PSYoungGen      total 2560K, used 2080K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 2048K, 100% used [0x00000000ffd00000,0x00000000fff00000,0x00000000fff00000)</div><div class="line">  from space 512K, 6% used [0x00000000fff00000,0x00000000fff08000,0x00000000fff80000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line"> ParOldGen       total 7168K, used 1317K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)</div><div class="line">  object space 7168K, 18% used [0x00000000ff600000,0x00000000ff749738,0x00000000ffd00000)</div><div class="line"> Metaspace       used 3234K, capacity 4494K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 351K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">Heap after GC invocations=38 (full 0):</div><div class="line"> PSYoungGen      total 2560K, used 32K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 2048K, 0% used [0x00000000ffd00000,0x00000000ffd00000,0x00000000fff00000)</div><div class="line">  from space 512K, 6% used [0x00000000fff80000,0x00000000fff88000,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 7168K, used 1317K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)</div><div class="line">  object space 7168K, 18% used [0x00000000ff600000,0x00000000ff749738,0x00000000ffd00000)</div><div class="line"> Metaspace       used 3234K, capacity 4494K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 351K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>也GC了38次</p>
<p>接下来看一下<code>TestCombine3</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCombine3</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String str2 = <span class="string">"123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789"</span>;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</div><div class="line">			String string2 = <span class="string">"string"</span> + str2;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">&#123;Heap before GC invocations=1 (full 0):</div><div class="line"> PSYoungGen      total 2560K, used 2048K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 2048K, 100% used [0x00000000ffd00000,0x00000000fff00000,0x00000000fff00000)</div><div class="line">  from space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 7168K, used 0K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)</div><div class="line">  object space 7168K, 0% used [0x00000000ff600000,0x00000000ff600000,0x00000000ffd00000)</div><div class="line"> Metaspace       used 2753K, capacity 4480K, committed 4480K, reserved 1056768K</div><div class="line">  class space    used 296K, capacity 384K, committed 384K, reserved 1048576K</div><div class="line">Heap after GC invocations=1 (full 0):</div><div class="line"> PSYoungGen      total 2560K, used 504K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 2048K, 0% used [0x00000000ffd00000,0x00000000ffd00000,0x00000000fff00000)</div><div class="line">  from space 512K, 98% used [0x00000000fff00000,0x00000000fff7e030,0x00000000fff80000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line"> ParOldGen       total 7168K, used 435K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)</div><div class="line">  object space 7168K, 6% used [0x00000000ff600000,0x00000000ff66ccc0,0x00000000ffd00000)</div><div class="line"> Metaspace       used 2753K, capacity 4480K, committed 4480K, reserved 1056768K</div><div class="line">  class space    used 296K, capacity 384K, committed 384K, reserved 1048576K</div><div class="line">&#125;</div><div class="line">&#123;Heap before GC invocations=2 (full 0):</div><div class="line"> PSYoungGen      total 2560K, used 2552K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 2048K, 100% used [0x00000000ffd00000,0x00000000fff00000,0x00000000fff00000)</div><div class="line">  from space 512K, 98% used [0x00000000fff00000,0x00000000fff7e030,0x00000000fff80000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line"> ParOldGen       total 7168K, used 435K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)</div><div class="line">  object space 7168K, 6% used [0x00000000ff600000,0x00000000ff66ccc0,0x00000000ffd00000)</div><div class="line"> Metaspace       used 2970K, capacity 4490K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 319K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">Heap after GC invocations=2 (full 0):</div><div class="line"> PSYoungGen      total 2560K, used 488K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 2048K, 0% used [0x00000000ffd00000,0x00000000ffd00000,0x00000000fff00000)</div><div class="line">  from space 512K, 95% used [0x00000000fff80000,0x00000000ffffa020,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 7168K, used 570K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)</div><div class="line">  object space 7168K, 7% used [0x00000000ff600000,0x00000000ff68e880,0x00000000ffd00000)</div><div class="line"> Metaspace       used 2970K, capacity 4490K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 319K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>一共就GC了俩次, 为什么结果是这样的呢？我们使用javap分析一下(限于篇幅, 我们只看最关键的部分).</p>
<p>首先看TestCombine1反编译之后的源码<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">javap -v TestCombine1</div><div class="line">...</div><div class="line">Constant pool:</div><div class="line">   #1 = Methodref          #13.#33        // java/lang/Object."&lt;init&gt;":()V</div><div class="line">   #2 = Integer            100000</div><div class="line">   #3 = Class              #34            // java/lang/StringBuilder</div><div class="line">   #4 = Methodref          #3.#33         // java/lang/StringBuilder."&lt;init&gt;":()V</div><div class="line">   #5 = String             #35            // string</div><div class="line">   #6 = Methodref          #3.#36         // java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</div><div class="line">   #7 = Fieldref           #12.#37        // testString/TestCombine1.str1:Ljava/lang/String;</div><div class="line">   #8 = Methodref          #3.#38         // java/lang/StringBuilder.toString:()Ljava/lang/String;</div><div class="line">   #9 = Class              #39            // java/lang/String</div><div class="line">  #10 = String             #40            // 123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789</div><div class="line">  #11 = Methodref          #9.#41         // java/lang/String."&lt;init&gt;":(Ljava/lang/String;)V</div><div class="line">  #12 = Class              #42            // testString/TestCombine1</div><div class="line">  #13 = Class              #43            // java/lang/Object</div><div class="line">  #14 = Utf8               str1</div><div class="line">  #15 = Utf8               Ljava/lang/String;</div><div class="line">...</div><div class="line">  #33 = NameAndType        #16:#17        // "&lt;init&gt;":()V</div><div class="line">  #34 = Utf8               java/lang/StringBuilder</div><div class="line">  #35 = Utf8               string</div><div class="line">  #36 = NameAndType        #44:#45        // append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</div><div class="line">  #37 = NameAndType        #14:#15        // str1:Ljava/lang/String;</div><div class="line">  #38 = NameAndType        #46:#47        // toString:()Ljava/lang/String;</div><div class="line">  #39 = Utf8               java/lang/String</div><div class="line">  #40 = Utf8               123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789</div><div class="line">  #41 = NameAndType        #16:#48        // "&lt;init&gt;":(Ljava/lang/String;)V</div><div class="line">  #42 = Utf8               testString/TestCombine1</div><div class="line">  #43 = Utf8               java/lang/Object</div><div class="line">  #44 = Utf8               append</div><div class="line">  #45 = Utf8               (Ljava/lang/String;)Ljava/lang/StringBuilder;</div><div class="line">  #46 = Utf8               toString</div><div class="line">  #47 = Utf8               ()Ljava/lang/String;</div><div class="line">  #48 = Utf8               (Ljava/lang/String;)V</div><div class="line">&#123;</div><div class="line">...</div><div class="line">  public static void main(java.lang.String[]);</div><div class="line">    descriptor: ([Ljava/lang/String;)V</div><div class="line">    flags: ACC_PUBLIC, ACC_STATIC</div><div class="line">    Code:</div><div class="line">      stack=2, locals=3, args_size=1</div><div class="line">         0: iconst_0</div><div class="line">         1: istore_1</div><div class="line">         2: iload_1</div><div class="line">         3: ldc           #2                  // int 100000</div><div class="line">         5: if_icmpge     36</div><div class="line">         8: new           #3                  // class java/lang/StringBuilder</div><div class="line">        11: dup</div><div class="line">        12: invokespecial #4                  // Method java/lang/StringBuilder."&lt;init&gt;":()V</div><div class="line">        15: ldc           #5                  // String string</div><div class="line">        17: invokevirtual #6                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</div><div class="line">        20: getstatic     #7                  // Field str1:Ljava/lang/String;</div><div class="line">        23: invokevirtual #6                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</div><div class="line">        26: invokevirtual #8                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;</div><div class="line">        29: astore_2</div><div class="line">        30: iinc          1, 1</div><div class="line">        33: goto          2</div><div class="line">        36: return</div><div class="line">...</div><div class="line">SourceFile: "TestCombine1.java"</div></pre></td></tr></table></figure></p>
<p>通过看main方法, 我们可以看出, 是将<code>&quot;string&quot;</code>字符串常量和 <code>str1</code>这个静态常量通过<code>StringBuilder</code>进行拼接得到的<code>string1</code>. 所以不断产生<code>StringBuilder</code>对象,就不断地进行GC了</p>
<p>然后看TestCombine2反编译之后的源码<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">ζ javap -v TestCombine2</div><div class="line">...</div><div class="line">Constant pool:</div><div class="line">   #1 = Methodref          #11.#30        // java/lang/Object."&lt;init&gt;":()V</div><div class="line">   #2 = Integer            100000</div><div class="line">   #3 = Class              #31            // java/lang/StringBuilder</div><div class="line">   #4 = Methodref          #3.#30         // java/lang/StringBuilder."&lt;init&gt;":()V</div><div class="line">   #5 = String             #32            // string</div><div class="line">   #6 = Methodref          #3.#33         // java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</div><div class="line">   #7 = Methodref          #10.#34        // testString/TestCombine2.getFieldConstant:()Ljava/lang/String;</div><div class="line">   #8 = Methodref          #3.#35         // java/lang/StringBuilder.toString:()Ljava/lang/String;</div><div class="line">   #9 = String             #36            // 123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789</div><div class="line">  #10 = Class              #37            // testString/TestCombine2</div><div class="line">  #11 = Class              #38            // java/lang/Object</div><div class="line">  #12 = Utf8               &lt;init&gt;</div><div class="line">  #13 = Utf8               ()V</div><div class="line">...</div><div class="line">  #26 = Utf8               getFieldConstant</div><div class="line">  #27 = Utf8               ()Ljava/lang/String;</div><div class="line">  #28 = Utf8               SourceFile</div><div class="line">  #29 = Utf8               TestCombine2.java</div><div class="line">  #30 = NameAndType        #12:#13        // "&lt;init&gt;":()V</div><div class="line">  #31 = Utf8               java/lang/StringBuilder</div><div class="line">  #32 = Utf8               string</div><div class="line">  #33 = NameAndType        #39:#40        // append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</div><div class="line">  #34 = NameAndType        #26:#27        // getFieldConstant:()Ljava/lang/String;</div><div class="line">  #35 = NameAndType        #41:#27        // toString:()Ljava/lang/String;</div><div class="line">  #36 = Utf8               123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789</div><div class="line">  #37 = Utf8               testString/TestCombine2</div><div class="line">  #38 = Utf8               java/lang/Object</div><div class="line">  #39 = Utf8               append</div><div class="line">  #40 = Utf8               (Ljava/lang/String;)Ljava/lang/StringBuilder;</div><div class="line">  #41 = Utf8               toString</div><div class="line">&#123;</div><div class="line">...</div><div class="line">  public static void main(java.lang.String[]);</div><div class="line">    descriptor: ([Ljava/lang/String;)V</div><div class="line">    flags: ACC_PUBLIC, ACC_STATIC</div><div class="line">    Code:</div><div class="line">      stack=2, locals=3, args_size=1</div><div class="line">         0: iconst_0</div><div class="line">         1: istore_1</div><div class="line">         2: iload_1</div><div class="line">         3: ldc           #2                  // int 100000</div><div class="line">         5: if_icmpge     36</div><div class="line">         8: new           #3                  // class java/lang/StringBuilder</div><div class="line">        11: dup</div><div class="line">        12: invokespecial #4                  // Method java/lang/StringBuilder."&lt;init&gt;":()V</div><div class="line">        15: ldc           #5                  // String string</div><div class="line">        17: invokevirtual #6                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</div><div class="line">        20: invokestatic  #7                  // Method getFieldConstant:()Ljava/lang/String;</div><div class="line">        23: invokevirtual #6                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</div><div class="line">        26: invokevirtual #8                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;</div><div class="line">        29: astore_2</div><div class="line">        30: iinc          1, 1</div><div class="line">        33: goto          2</div><div class="line">        36: return</div><div class="line">...</div><div class="line">SourceFile: "TestCombine2.java"</div></pre></td></tr></table></figure></p>
<p>和TestCombine1类似, 在mian方法中， 也是使用<code>StringBuilder</code>进行拼接处理的</p>
<p>最后看下TestCombine3反编译之后的源码<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">ζ javap -v TestCombine3</div><div class="line">...</div><div class="line">Constant pool:</div><div class="line">   #1 = Methodref          #5.#26         // java/lang/Object."&lt;init&gt;":()V</div><div class="line">   #2 = Integer            1000000</div><div class="line">   #3 = Class              #27            // testString/TestCombine3</div><div class="line">   #4 = String             #28            // string123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789</div><div class="line">   #5 = Class              #29            // java/lang/Object</div><div class="line">   #6 = Utf8               str2</div><div class="line">   #7 = Utf8               Ljava/lang/String;</div><div class="line">   #8 = Utf8               ConstantValue</div><div class="line">   #9 = String             #30            // 123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789</div><div class="line">...</div><div class="line">  #26 = NameAndType        #10:#11        // "&lt;init&gt;":()V</div><div class="line">  #27 = Utf8               testString/TestCombine3</div><div class="line">  #28 = Utf8               string123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789</div><div class="line">  #29 = Utf8               java/lang/Object</div><div class="line">  #30 = Utf8               123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789</div><div class="line">&#123;</div><div class="line">...</div><div class="line">  public static void main(java.lang.String[]);</div><div class="line">    descriptor: ([Ljava/lang/String;)V</div><div class="line">    flags: ACC_PUBLIC, ACC_STATIC</div><div class="line">    Code:</div><div class="line">      stack=2, locals=3, args_size=1</div><div class="line">         0: iconst_0</div><div class="line">         1: istore_1</div><div class="line">         2: iload_1</div><div class="line">         3: ldc           #2                  // int 1000000</div><div class="line">         5: if_icmpge     17</div><div class="line">         8: ldc           #4                  // String string123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789</div><div class="line">        10: astore_2</div><div class="line">        11: iinc          1, 1</div><div class="line">        14: goto          2</div><div class="line">        17: return</div><div class="line">...</div><div class="line">&#125;</div><div class="line">SourceFile: "TestCombine3.java"</div></pre></td></tr></table></figure></p>
<p>我们看<code>#4 = String             #28            // string123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789</code>这一行, Java编译器已经将<code>String string2 = &quot;string&quot; + str2;</code>这俩个字符串字面量常量<br>优化成了一个字符串字面量常量.</p>
<p>从上面的分析中我们可以得到, 在Java编译器进行优化的话, 只有当字符串字面量进行拼接的时候, 才会对其进行优化.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/09/26/JavaSE/Java String/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/09/26/JavaSE/Java String/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/09/23/JavaSE/并发 wait sleep/" title="wait sleep 不同" itemprop="url">wait sleep 不同</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-09-22T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-09-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>wait和sleep都可以停止线程的运行,但是这俩点有什么不一样呢？当在加锁的代码中</p>
<ul>
<li>wait 会释放锁</li>
<li>sleep 不会释放锁</li>
</ul>
<blockquote>
<p>当进入wait或者sleep之后,线程退出CPU占用, 操作系统都不会再给这个线程分配时间片</p>
</blockquote>
<p>先看wait的例子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestLock</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		ThreadUtil.printThreadState(<span class="string">"thread1"</span>, <span class="string">"thread2"</span>);</div><div class="line"></div><div class="line">		Runnable runnable = () -&gt; &#123;</div><div class="line">			<span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">				System.out.println(Thread.currentThread().getName() + <span class="string">" Sleep"</span>);</div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					lock.wait(<span class="number">3000</span>);</div><div class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">					e.printStackTrace();</div><div class="line">				&#125;</div><div class="line">				System.out.println(Thread.currentThread().getName() + <span class="string">" Sleep Finshed"</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		Thread thread1 = <span class="keyword">new</span> Thread(runnable, <span class="string">"thread1"</span>);</div><div class="line">		Thread thread2 = <span class="keyword">new</span> Thread(runnable, <span class="string">"thread2"</span>);</div><div class="line">		thread1.start();</div><div class="line">		thread2.start();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">thread1 Sleep</div><div class="line">thread2 Sleep</div><div class="line">2016-09-23T15:15:31.629  thread2 -&gt; TIMED_WAITING</div><div class="line">2016-09-23T15:15:31.630  thread1 -&gt; TIMED_WAITING</div><div class="line">2016-09-23T15:15:32.529  thread2 -&gt; TIMED_WAITING</div><div class="line">2016-09-23T15:15:32.529  thread1 -&gt; TIMED_WAITING</div><div class="line">thread1 Sleep Finshed</div><div class="line">thread2 Sleep Finshed</div></pre></td></tr></table></figure></p>
<p>我们看到当线程1 wait之后,线程2也进入了锁中</p>
<p>然后我们将<code>lock.wait(3000);</code>改为<code>TimeUnit.SECONDS.sleep(3);</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestLock</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		ThreadUtil.printThreadState(<span class="string">"thread1"</span>, <span class="string">"thread2"</span>);</div><div class="line"></div><div class="line">		Runnable runnable = () -&gt; &#123;</div><div class="line">			<span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">				System.out.println(Thread.currentThread().getName() + <span class="string">" Sleep"</span>);</div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">					e.printStackTrace();</div><div class="line">				&#125;</div><div class="line">				System.out.println(Thread.currentThread().getName() + <span class="string">" Sleep Finshed"</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		Thread thread1 = <span class="keyword">new</span> Thread(runnable, <span class="string">"thread1"</span>);</div><div class="line">		Thread thread2 = <span class="keyword">new</span> Thread(runnable, <span class="string">"thread2"</span>);</div><div class="line">		thread1.start();</div><div class="line">		thread2.start();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">thread1 Sleep</div><div class="line">2016-09-23T15:17:52.488  thread2 -&gt; BLOCKED</div><div class="line">2016-09-23T15:17:52.488  thread1 -&gt; TIMED_WAITING</div><div class="line">2016-09-23T15:17:53.462  thread2 -&gt; BLOCKED</div><div class="line">2016-09-23T15:17:53.462  thread1 -&gt; TIMED_WAITING</div><div class="line">2016-09-23T15:17:54.463  thread2 -&gt; BLOCKED</div><div class="line">2016-09-23T15:17:54.463  thread1 -&gt; TIMED_WAITING</div><div class="line">thread1 Sleep Finshed</div><div class="line">thread2 Sleep</div><div class="line">2016-09-23T15:17:55.464  thread2 -&gt; TIMED_WAITING</div><div class="line">2016-09-23T15:17:56.465  thread2 -&gt; TIMED_WAITING</div><div class="line">2016-09-23T15:17:57.466  thread2 -&gt; TIMED_WAITING</div><div class="line">thread2 Sleep Finshed</div></pre></td></tr></table></figure></p>
<p>我们看到只有当线程1执行完之后线程才继续执行</p>
<p>在上面的例子中用到的输出线程状态信息的工具类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.time.LocalDateTime;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadUtil</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printThreadState</span><span class="params">(String... filter)</span> </span>&#123;</div><div class="line">		Thread print = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">			<span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">			<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (System.currentTimeMillis() - now &gt; <span class="number">1000</span>) &#123;</div><div class="line">					now = System.currentTimeMillis();</div><div class="line">					Thread.getAllStackTraces().forEach((key, thread) -&gt; &#123;</div><div class="line">						<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filter.length; i++) &#123;</div><div class="line">							<span class="keyword">if</span> (key.getName().equals(filter[i])) &#123;</div><div class="line">								System.out.println(LocalDateTime.now() + <span class="string">"  "</span> +key.getName() + <span class="string">" -&gt; "</span> + key.getState());</div><div class="line">							&#125;</div><div class="line">						&#125;</div><div class="line">					&#125;);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;, <span class="string">"Print"</span>);</div><div class="line">		print.start();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="线程中断"><a href="#线程中断" class="headerlink" title="线程中断"></a>线程中断</h2><p>Java 提供了中断机制,可以使用中断来结束一个线程.(使用中断来结束一个线程,要求线程检查它是否被中断了,然后决定是否响应这个中断请求. 线程允许忽略中断并继续执行(将if语句注掉就可忽略中断请求))<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"></div><div class="line">		Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">			<span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (Thread.interrupted()) &#123;</div><div class="line">					System.out.println(<span class="string">"interrupt  "</span> + System.currentTimeMillis());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		thread.start();</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			TimeUnit.SECONDS.sleep(<span class="number">5</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		System.out.println(<span class="string">"Begin interrupt"</span>);</div><div class="line">		thread.interrupt();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/09/23/JavaSE/并发 wait sleep/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/09/23/JavaSE/并发 wait sleep/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/09/19/JavaSE/并发 ThreadPoolExecutor/" title="Java ThreadPoolExecutor" itemprop="url">Java ThreadPoolExecutor</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-09-18T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-09-19</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>一直受困于<code>ThreadPoolExecutor</code>的内部实现, 今天就拿出点时间解决几点自己的疑问</p>
<ol>
<li><code>ThreadPoolExecutor</code>是如何重复利用线程资源的</li>
<li><code>ThreadPoolExecutor</code> reject 策略</li>
</ol>
<h2 id="线程资源管理"><a href="#线程资源管理" class="headerlink" title="线程资源管理"></a>线程资源管理</h2><p>首先拿出一段运行代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestPool</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		ExecutorService pool = Executors.newFixedThreadPool(<span class="number">5</span>);</div><div class="line">		pool.execute(() -&gt; System.out.println(<span class="string">"task is running"</span>));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们从构造函数入手<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> nThreads)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,</div><div class="line">                                      <span class="number">0L</span>, TimeUnit.MILLISECONDS,</div><div class="line">                                      <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;());</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></div><div class="line">                          <span class="keyword">int</span> maximumPoolSize,</div><div class="line">                          <span class="keyword">long</span> keepAliveTime,</div><div class="line">                          TimeUnit unit,</div><div class="line">                          BlockingQueue&lt;Runnable&gt; workQueue,</div><div class="line">                          ThreadFactory threadFactory,</div><div class="line">                          RejectedExecutionHandler handler) &#123;</div><div class="line">    <span class="keyword">if</span> (corePoolSize &lt; <span class="number">0</span> ||</div><div class="line">        maximumPoolSize &lt;= <span class="number">0</span> ||</div><div class="line">        maximumPoolSize &lt; corePoolSize ||</div><div class="line">        keepAliveTime &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</div><div class="line">    <span class="keyword">if</span> (workQueue == <span class="keyword">null</span> || threadFactory == <span class="keyword">null</span> || handler == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">    <span class="keyword">this</span>.corePoolSize = corePoolSize;</div><div class="line">    <span class="keyword">this</span>.maximumPoolSize = maximumPoolSize;</div><div class="line">    <span class="keyword">this</span>.workQueue = workQueue;</div><div class="line">    <span class="keyword">this</span>.keepAliveTime = unit.toNanos(keepAliveTime);</div><div class="line">    <span class="keyword">this</span>.threadFactory = threadFactory;</div><div class="line">    <span class="keyword">this</span>.handler = handler;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看到了在构造函数中, 只是进行了初始化的操作, 并没有运行任何逻辑代码, 那么下来我们从<code>execute(Runnable )</code>这个方法入手</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (command == <span class="keyword">null</span>)</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">       <span class="comment">/*</span></div><div class="line">        * 分三步执行</div><div class="line">        * 1. 现在的线程池的线程数量小于corePoolSize值, 则创建一个新的线程, 用新的线程执行command.</div><div class="line">        *    在调用addWorker()时会自动检测runState和workerCount, 如果发现添加失败的话, 会返回false.</div><div class="line">        * 2. 如果能将command成功地加入到任务队列里, 在接下来的执行中无论是否新建工作线程都要进行对线程池状态</div><div class="line">        * 	  进行Double check, 因为 existing ones died since last checking 或者线程池恰巧在这时关闭了.</div><div class="line">        * 	  So we recheck state and if necessary roll back the enqueuing if stopped, or start a new thread if there are none.</div><div class="line">        * 3. 如果不能将command入列到任务队列的话,就尝试启动一个新的线程来运行它. 如果仍然失败就需要reject任务了.</div><div class="line">        */</div><div class="line">       <span class="keyword">int</span> c = ctl.get();</div><div class="line">	<span class="comment">// 第一步 ：</span></div><div class="line">	<span class="comment">// 计算线程池中运行的线程数量, 如果当前运行的线程数量小于corePoolSize, 就增加一个worker.</span></div><div class="line">       <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</div><div class="line">           <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">		<span class="comment">// 因为在addWorker时会改变ctl的值, 因此重新获取一下</span></div><div class="line">           c = ctl.get();</div><div class="line">       &#125;</div><div class="line">	<span class="comment">// 第二步:</span></div><div class="line">	<span class="comment">// 工作线程已经达到corePoolSize数量或者添加worker失败, 将command加入到任务队列里面去</span></div><div class="line">       <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</div><div class="line">           <span class="keyword">int</span> recheck = ctl.get();</div><div class="line">		<span class="comment">// 如果线程池不再处于运行状态且能成功从任务队列里将删除删除掉, 就reject任务</span></div><div class="line">           <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</div><div class="line">               reject(command);</div><div class="line">		<span class="comment">// 如果worker数量为0的话，就新建一个worker, 执行刚刚添加到任务队列里的任务</span></div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</div><div class="line">               addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line">	<span class="comment">// 第三步:</span></div><div class="line">	<span class="comment">// 如果任务队列已经满了, 则尝试新建一个worker用来执行command</span></div><div class="line">       <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</div><div class="line">           reject(command);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这个方法的重点一个是<code>addWorker()</code>它会启动一个新的线程, 如果指定了first task(<code>addWorker(command, true)</code>), 那么新的worker线程就从first task开始执行.<br>如果没有指定的话(<code>addWorker(null, false)</code>), 就从任务队列里取出任务依次执行.</p>
<p>另一个重点是<code>workQueue.offer(command)</code>通过这个方法向任务队列里添加任务, 然后在<code>Worker</code>的<code>runWorker()</code>里依次执行任务.</p>
<p>下来我们看一下<code>addWorker()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addWorker</span><span class="params">(Runnable firstTask, <span class="keyword">boolean</span> core)</span> </span>&#123;</div><div class="line">		<span class="comment">// 下面整个循环都是为了 改变ctl中工作线程worker的数量.</span></div><div class="line">        retry:</div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">int</span> c = ctl.get();</div><div class="line">			<span class="comment">// 计算线程池状态.</span></div><div class="line">            <span class="keyword">int</span> rs = runStateOf(c);</div><div class="line"></div><div class="line">            <span class="comment">// Check if queue empty only if necessary.</span></div><div class="line">            <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;</div><div class="line">					! (rs == SHUTDOWN &amp;&amp; firstTask == <span class="keyword">null</span> &amp;&amp; ! workQueue.isEmpty())</div><div class="line">					)</div><div class="line">				<span class="comment">// 当线程池处于非运行状态,</span></div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"></div><div class="line">			<span class="comment">// 开始增加ctl中的线程数量</span></div><div class="line">            <span class="keyword">for</span> (;;) &#123;</div><div class="line">                <span class="keyword">int</span> wc = workerCountOf(c);</div><div class="line">                <span class="keyword">if</span> (wc &gt;= CAPACITY ||</div><div class="line">                    wc &gt;= (core ? corePoolSize : maximumPoolSize))</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</div><div class="line">                    <span class="keyword">break</span> retry;</div><div class="line">                c = ctl.get();  <span class="comment">// Re-read ctl</span></div><div class="line">				<span class="comment">// 如果线程池的状态发生了改变则继续执行retry循环, 进行Check if queue empty only if necessary 检测.</span></div><div class="line">				<span class="comment">// 没有线程池状态没有发生变化的话, 则继续执行ctl数量增加操作</span></div><div class="line">                <span class="keyword">if</span> (runStateOf(c) != rs)</div><div class="line">                    <span class="keyword">continue</span> retry;</div><div class="line">                <span class="comment">// else CAS failed due to workerCount change; retry inner loop</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">		<span class="comment">// ok,到现在ctl中的worker数量已经改变完成, 开始真正的创建worker</span></div><div class="line">        <span class="keyword">boolean</span> workerStarted = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">boolean</span> workerAdded = <span class="keyword">false</span>;</div><div class="line">        Worker w = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            w = <span class="keyword">new</span> Worker(firstTask);</div><div class="line">            <span class="keyword">final</span> Thread t = w.thread;</div><div class="line">            <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">                mainLock.lock();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="comment">// Recheck while holding lock.</span></div><div class="line">                    <span class="comment">// Back out on ThreadFactory failure or if</span></div><div class="line">                    <span class="comment">// shut down before lock acquired.</span></div><div class="line">                    <span class="keyword">int</span> rs = runStateOf(ctl.get());</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (rs &lt; SHUTDOWN ||</div><div class="line">                        (rs == SHUTDOWN &amp;&amp; firstTask == <span class="keyword">null</span>)) &#123;</div><div class="line">                        <span class="keyword">if</span> (t.isAlive()) <span class="comment">// precheck that t is startable</span></div><div class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</div><div class="line">                        workers.add(w);</div><div class="line">                        <span class="keyword">int</span> s = workers.size();</div><div class="line">                        <span class="keyword">if</span> (s &gt; largestPoolSize)</div><div class="line">                            largestPoolSize = s;</div><div class="line">                        workerAdded = <span class="keyword">true</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    mainLock.unlock();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (workerAdded) &#123;</div><div class="line">                    t.start();</div><div class="line">                    workerStarted = <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (! workerStarted)</div><div class="line">                addWorkerFailed(w);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> workerStarted;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>根据线程池的当前状态和指定的bound 检查新的worker能否添加.如果新的worker能被添加的话, 就会创建出一个新的worker, 同时增加worker count的数量。然后在这个新的worker运行firstTask</p>
<p>如果线程池是停止状态或者准备停止的话, 这个方法会返回一个false.如果ThreadFactory创建线程失败的话,也会返回一个false.当创建线程失败时,不管是ThreadFactory返回null还是产生错误(一般是在Thread.start()时抛出OutOfMemoryError), 我们将<br>执行回滚操作</p>
<p>当新创建一个线程时, firstTask会成为它第一个执行的任务。当线程池线程数量小于corePoolSize或者队列满的时候, 创建出的worker内部会自动创建一个first task ，忽略掉从任务队列中出列的任务.</p>
<p>我们需要着重看一下<code>t.start();</code>方法, 这个方法是开始运行<code>Worker</code>对象里的<code>thread</code>线程对象(其本身也是<code>Worker</code>类型). 最终也是执行到<code>Worker</code>的<code>runWorker()</code>方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runWorker</span><span class="params">(Worker w)</span> </span>&#123;</div><div class="line">        Thread wt = Thread.currentThread();</div><div class="line">        Runnable task = w.firstTask;</div><div class="line">        w.firstTask = <span class="keyword">null</span>;</div><div class="line">        w.unlock(); <span class="comment">// allow interrupts</span></div><div class="line">        <span class="keyword">boolean</span> completedAbruptly = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">// 如果first task不为空的话就先执行first task, 否则就从任务队列中取出task执行</span></div><div class="line">            <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = getTask()) != <span class="keyword">null</span>) &#123;</div><div class="line">                w.lock();</div><div class="line">                <span class="comment">// If pool is stopping, ensure thread is interrupted;</span></div><div class="line">                <span class="comment">// if not, ensure thread is not interrupted.  This</span></div><div class="line">                <span class="comment">// requires a recheck in second case to deal with</span></div><div class="line">                <span class="comment">// shutdownNow race while clearing interrupt</span></div><div class="line">                <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</div><div class="line">                     (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))) &amp;&amp; !wt.isInterrupted())</div><div class="line">                    wt.interrupt();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    beforeExecute(wt, task);</div><div class="line">                    Throwable thrown = <span class="keyword">null</span>;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        task.run();</div><div class="line">                    &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        afterExecute(task, thrown);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    task = <span class="keyword">null</span>;</div><div class="line">                    w.completedTasks++;</div><div class="line">                    w.unlock();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            completedAbruptly = <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            processWorkerExit(w, completedAbruptly);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>看到这里我们可以看出, <code>ThreadPoolExecutor</code>其内部也是通过<code>while</code>来不断轮训任务队列, 执行任务的<code>task.run();</code>方法, 不开启新线程的方式, 来达到线程资源管理的目的.</p>
<p>那么任务执行完之后, 线程就被干掉了吗? 我们重点看<code>processWorkerExit(w, completedAbruptly);</code>这个方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processWorkerExit</span><span class="params">(Worker w, <span class="keyword">boolean</span> completedAbruptly)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (completedAbruptly) <span class="comment">// If abrupt, then workerCount wasn't adjusted</span></div><div class="line">            decrementWorkerCount();</div><div class="line"></div><div class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">        mainLock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            completedTaskCount += w.completedTasks;</div><div class="line">			<span class="comment">// 将刚刚干完活的线程从worker队列中干掉</span></div><div class="line">            workers.remove(w);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            mainLock.unlock();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        tryTerminate();</div><div class="line"></div><div class="line">        <span class="keyword">int</span> c = ctl.get();</div><div class="line">        <span class="keyword">if</span> (runStateLessThan(c, STOP)) &#123;</div><div class="line">			<span class="comment">// 如果线程池还能执行任务队列里的任务(Runnable, SHUTDOWN状态),就继续执行任务</span></div><div class="line">            <span class="keyword">if</span> (!completedAbruptly) &#123;</div><div class="line">                <span class="keyword">int</span> min = allowCoreThreadTimeOut ? <span class="number">0</span> : corePoolSize;</div><div class="line">                <span class="keyword">if</span> (min == <span class="number">0</span> &amp;&amp; ! workQueue.isEmpty())</div><div class="line">                    min = <span class="number">1</span>;</div><div class="line">                <span class="keyword">if</span> (workerCountOf(c) &gt;= min)</div><div class="line">                    <span class="keyword">return</span>; <span class="comment">// replacement not needed</span></div><div class="line">            &#125;</div><div class="line">            addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h2 id="线程池状态"><a href="#线程池状态" class="headerlink" title="线程池状态"></a>线程池状态</h2><p>从上面的分析, 我们看到了很多这种代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">workerCountOf(c)</div><div class="line">isRunning(c)</div></pre></td></tr></table></figure></p>
<p>看到这里可能会有很多疑问, 贴一下<code>ThreadPoolExecutor</code>部分内部成员<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger ctl = <span class="keyword">new</span> AtomicInteger(ctlOf(RUNNING, <span class="number">0</span>));</div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COUNT_BITS = Integer.SIZE - <span class="number">3</span>;</div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CAPACITY   = (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</div><div class="line"></div><div class="line"> <span class="comment">// runState is stored in the high-order bits</span></div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RUNNING    = -<span class="number">1</span> &lt;&lt; COUNT_BITS;</div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHUTDOWN   =  <span class="number">0</span> &lt;&lt; COUNT_BITS;</div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP       =  <span class="number">1</span> &lt;&lt; COUNT_BITS;</div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIDYING    =  <span class="number">2</span> &lt;&lt; COUNT_BITS;</div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TERMINATED =  <span class="number">3</span> &lt;&lt; COUNT_BITS;</div><div class="line"></div><div class="line"> <span class="comment">// Packing and unpacking ctl</span></div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">runStateOf</span><span class="params">(<span class="keyword">int</span> c)</span>     </span>&#123; <span class="keyword">return</span> c &amp; ~CAPACITY; &#125;</div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">workerCountOf</span><span class="params">(<span class="keyword">int</span> c)</span>  </span>&#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;</div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ctlOf</span><span class="params">(<span class="keyword">int</span> rs, <span class="keyword">int</span> wc)</span> </span>&#123; <span class="keyword">return</span> rs | wc; &#125;</div></pre></td></tr></table></figure></p>
<p><code>ctl</code> 内部封装了俩个关键性的字段</p>
<ul>
<li>workerCount, 工作的线程数</li>
<li>runState, 线程池状态<br>为了将这俩个值都存储进<code>ctl</code>里，<code>workerCount</code>的最大值是500万左右(<code>(1 &lt;&lt; (Integer.SIZE - 3)) - 1</code>),而不是2亿(queue的最大值是Integer的最大值)。  如果将来需要更高的任务量的话,可以采用<code>AtomLong</code>作为<code>ctl</code>的类型，但是现在采用int可以带来更快的运行速度和更简单</li>
</ul>
<p>下面的几个值表示了整个线程池的运行状态</p>
<ul>
<li><code>RUNNING</code>:  Accept new tasks and process queued tasks</li>
<li><code>SHUTDOWN</code>: Don’t accept new tasks, but process queued tasks</li>
<li><code>STOP</code>:     Don’t accept new tasks, don’t process queued tasks, and interrupt in-progress tasks</li>
<li><code>TIDYING</code>:  All tasks have terminated, workerCount is zero, the thread transitioning to state TIDYING will run the terminated() hook method</li>
<li><code>TERMINATED</code>: terminated() has completed</li>
</ul>
<p>随着线程池运行, 上面几个状态是依次递增的, 但是在整个线程池生命周期中不一定会达到每个状态.<br>线程池的状态转换过程如下:</p>
<ul>
<li><code>RUNNING -&gt; SHUTDOWN</code>  On invocation of shutdown(), perhaps implicitly in finalize()</li>
<li><code>(RUNNING or SHUTDOWN) -&gt; STOP</code>    On invocation of shutdownNow()</li>
<li><code>SHUTDOWN -&gt; TIDYING</code> When both queue and pool are empty</li>
<li><code>STOP -&gt; TIDYING</code>    When pool is empty</li>
<li><code>TIDYING -&gt; TERMINATED</code>    When the terminated() hook method has completed</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/09/19/JavaSE/并发 ThreadPoolExecutor/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/09/19/JavaSE/并发 ThreadPoolExecutor/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/09/08/JavaSE/LinkedBlockingQueue/" title="LinkedBlockingQueue" itemprop="url">LinkedBlockingQueue</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-09-07T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-09-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><code>LinkedBlockingQueue</code> 是基于双锁队列算法(锁实现使用<code>ReentrantLock</code>)实现的阻塞式先进先出(FIFO)的链表式队列. 其默认的链表大小是Interger的最大值,也就是说只要内存hold住,可以在<code>LinkedBlockingQueue</code>入列2亿多个数据.</p>
<p>双锁指的是<code>LinkedBlockingQueue</code>内部使用了俩个<code>ReentrantLock</code></p>
<ul>
<li><p><code>ReentrantLock takeLock</code> : 用于操作队列头, 取出队头元素</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> E <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">       E x;</div><div class="line">       <span class="keyword">int</span> c = -<span class="number">1</span>;</div><div class="line">       <span class="keyword">final</span> AtomicInteger count = <span class="keyword">this</span>.count;</div><div class="line">       <span class="keyword">final</span> ReentrantLock takeLock = <span class="keyword">this</span>.takeLock;</div><div class="line">       takeLock.lockInterruptibly();</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">while</span> (count.get() == <span class="number">0</span>) &#123;</div><div class="line">               notEmpty.await();</div><div class="line">           &#125;</div><div class="line">           x = dequeue();</div><div class="line">           c = count.getAndDecrement();</div><div class="line">           <span class="keyword">if</span> (c &gt; <span class="number">1</span>)</div><div class="line">               notEmpty.signal();</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           takeLock.unlock();</div><div class="line">       &#125;</div><div class="line">	<span class="comment">// 由于count是先get后Decrement的, 因此现在的count &lt; capacity, 通知阻塞的线程可以添加数据了</span></div><div class="line">       <span class="keyword">if</span> (c == capacity)</div><div class="line">           signalNotFull();</div><div class="line">       <span class="keyword">return</span> x;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> E <span class="title">dequeue</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">// assert takeLock.isHeldByCurrentThread();</span></div><div class="line">       <span class="comment">// assert head.item == null;</span></div><div class="line">       Node&lt;E&gt; h = head;</div><div class="line">       Node&lt;E&gt; first = h.next;</div><div class="line">       h.next = h; <span class="comment">// help GC</span></div><div class="line">       head = first;</div><div class="line">       E x = first.item;</div><div class="line">       first.item = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">return</span> x;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
<li><p><code>ReentrantLock putLock</code> : 用于操作队列尾, 向队尾添加元素</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">      <span class="keyword">if</span> (e == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">      <span class="comment">// Note: convention in all put/take/etc is to preset local var</span></div><div class="line">      <span class="comment">// holding count negative to indicate failure unless set.</span></div><div class="line">      <span class="keyword">int</span> c = -<span class="number">1</span>;</div><div class="line">      Node&lt;E&gt; node = <span class="keyword">new</span> Node&lt;E&gt;(e);</div><div class="line">      <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">this</span>.putLock;</div><div class="line">      <span class="keyword">final</span> AtomicInteger count = <span class="keyword">this</span>.count;</div><div class="line">      putLock.lockInterruptibly();</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          <span class="keyword">while</span> (count.get() == capacity) &#123;</div><div class="line">              notFull.await();</div><div class="line">          &#125;</div><div class="line">          enqueue(node);</div><div class="line">          c = count.getAndIncrement();</div><div class="line">          <span class="keyword">if</span> (c + <span class="number">1</span> &lt; capacity)</div><div class="line">              notFull.signal();</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          putLock.unlock();</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (c == <span class="number">0</span>)</div><div class="line">          signalNotEmpty();</div><div class="line">  &#125;</div><div class="line">	</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Node&lt;E&gt; node)</span> </span>&#123;</div><div class="line">      <span class="comment">// assert putLock.isHeldByCurrentThread();</span></div><div class="line">      <span class="comment">// assert last.next == null;</span></div><div class="line">      last = last.next = node;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>通过双锁分别操作队列头和队列尾就实现了了一个高效地读写分离的并发安全链表队列</p>
<p>刚才我们只是从宏观上看了一下<code>LinkedBlockingQueue</code>. 下面我们从细节上分析一下. <code>LinkedBlockingQueue</code>有俩个入列方式, 分别是<code>put</code>和<code>offer</code>, 在上面中我们看到了<code>put</code>的实现. 它内部使用了一个<code>notEmpty</code>的<code>Condition</code>, 使用这个是为了当队列已经满了的时候, 就将添加元素的线程阻塞住。接着我们看一下<code>take()</code>方法, 它的最后有一个<code>signalNotFull()</code>, 就是由它来通知阻塞线程来添加数据的. 而<code>offer()</code>实现就没有阻塞行为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (e == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">    <span class="keyword">final</span> AtomicInteger count = <span class="keyword">this</span>.count;</div><div class="line">    <span class="keyword">if</span> (count.get() == capacity)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">int</span> c = -<span class="number">1</span>;</div><div class="line">    Node&lt;E&gt; node = <span class="keyword">new</span> Node&lt;E&gt;(e);</div><div class="line">    <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">this</span>.putLock;</div><div class="line">    putLock.lock();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">if</span> (count.get() &lt; capacity) &#123;</div><div class="line">            enqueue(node);</div><div class="line">            c = count.getAndIncrement();</div><div class="line">            <span class="keyword">if</span> (c + <span class="number">1</span> &lt; capacity)</div><div class="line">                notFull.signal();</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        putLock.unlock();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>)</div><div class="line">        signalNotEmpty();</div><div class="line">    <span class="keyword">return</span> c &gt;= <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>offer()</code>实现中,如果添加成功就返回true, 添加失败(没有进行添加操作)就返回false, 它并不会阻塞住调用者.</p>
<p>看完入列, 我们再看一下出列操作. 刚开始给出的一段代码就是一段出列代码<code>take()</code>方法. <code>take()</code>方法内部也使用了一个名为<code>notEmpty</code>的<code>Condition</code>, 如果当前队列为空的话, 就一直阻塞住进行出列操作的线程, 由<code>put()</code>的<code>signalNotEmpty()</code>来通知当前阻塞的线程可以出列操作了(但是为什么要判断为0呢？？想不明白).</p>
<p>大概琢磨一下就能理清<code>LinkedBlockingQueue</code>的工作流程. 但是仍然遗留了俩个比较大的疑问.</p>
<ol>
<li><code>LinkedBlockingQueue</code>的内部链表是由双锁保证线程安全的,那么当俩个线程分别操作队列头和队列尾的时候,如果恰巧是同一个元素,会不会发生问题</li>
<li>是如何保证<code>LinkedBlockingQueue</code>的内部计数器<code>count</code>(<code>AtomicInteger</code>)的线程安全的?</li>
</ol>
<p>对于第一个问题, 我画了一张入列和出列的流程图:<br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/concurrency/LinkedBlockingQueue.jpg" alt=""><br>从图中我们可以看到, 在初始化<code>LinkedBlockingQueue</code>实例的时候,其内部就有了一个Node, first和last都指向这个Node. 当入列一个元素的时候,last指针后移, 而first指针位置不变(参考<code>enqueue(Node&lt;E&gt; node)</code>和<code>dequeue()</code>方法)。其实这个时候实际的第一个Node为A, 而在逻辑上来讲第一个Node为B(因为第一个数据是存储在了B里), 出列的时候, 是删除队列的第一个实际位置(A)的Node,取出的是第二个实际位置(B)的数据,此时第三个实际位置就变成了第一个逻辑位置.</p>
<p>对于第二个问题,在<code>put()</code>方法中是这么描述的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Note that count is used <span class="keyword">in</span> <span class="built_in">wait</span> guard even though it is</div><div class="line"> * not protected by lock. This works because count can</div><div class="line"> * only decrease at this point (all other puts are shut</div><div class="line"> * out by lock), and we (or some other waiting put) are</div><div class="line"> * signalled <span class="keyword">if</span> it ever changes from capacity. Similarly</div><div class="line"> * <span class="keyword">for</span> all other uses of count <span class="keyword">in</span> other <span class="built_in">wait</span> guards.</div><div class="line"> */</div></pre></td></tr></table></figure></p>
<p>在入列的操作中count只会增加, 在出列的过程中count只会减少. 而入列只是向上做边界检查, 出列只是向下做边界检查, 因此只要保证了count是原子的, 哪怕出现了数据不一致的情况也不会出现队列的大小超过最大值或者小于0的情况.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/09/08/JavaSE/LinkedBlockingQueue/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/09/08/JavaSE/LinkedBlockingQueue/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/08/29/jvm/Attatch API/" title="HotSpot Dynamic Attach Mechanism 简析" itemprop="url">HotSpot Dynamic Attach Mechanism 简析</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-08-28T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-08-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>在 <code>在VirtualMachine</code> javadoc中给了我们一个示范用例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// attach to target VM</span></div><div class="line">VirtualMachine vm = VirtualMachine.attach(<span class="string">"2177"</span>);</div><div class="line"></div><div class="line"><span class="comment">// get system properties in target VM</span></div><div class="line">Properties props = vm.getSystemProperties();</div><div class="line"></div><div class="line"><span class="comment">// construct path to management agent</span></div><div class="line">String home = props.getProperty(<span class="string">"java.home"</span>);</div><div class="line">String agent = home + File.separator + <span class="string">"lib"</span> + File.separator</div><div class="line">    + <span class="string">"management-agent.jar"</span>;</div><div class="line"></div><div class="line"><span class="comment">// load agent into target VM</span></div><div class="line">vm.loadAgent(agent, <span class="string">"com.sun.management.jmxremote.port=5000"</span>);</div><div class="line"></div><div class="line"><span class="comment">// detach</span></div><div class="line">vm.detach();</div></pre></td></tr></table></figure></p>
<p>如果要引用 <code>在VirtualMachine</code>的话, 我们需要在classpath上添加tools.jar文件。注意在Windows和Linux上的tools.jar文件实现是不同的, 需要在不同的平台上依赖不同的文件.</p>
<p>Attach API 相关实现可以在openjdk中找到</p>
<ul>
<li><code>VirtualMachine</code> : <code>openjdk\jdk\src\share\classes\com\sun\tools\attach</code></li>
<li><code>AttachProvider</code> : <code>openjdk\jdk\src\share\classes\com\sun\tools\attach\spi</code></li>
<li><code>HotSpotAttachProvider</code> : <code>openjdk\jdk\src\share\classes\sun\tools\attach</code></li>
<li><code>HotSpotVirtualMachine</code> : <code>openjdk\jdk\src\share\classes\sun\tools\attach</code></li>
<li><code>LinuxVirtualMachine</code> : <code>openjdk\jdk\src\solaris\classes\sun\tools\attach</code></li>
<li><code>LinuxAttachProvider</code> : <code>openjdk\jdk\src\solaris\classes\sun\tools\attach</code></li>
<li><code>jvmstat</code> : <code>openjdk\jdk\src\share\classes\sun\jvmstat</code></li>
</ul>
<p>Attach API 主要就是依赖上面的几个文件实现的</p>
<p>从<a href="http://openjdk.java.net/groups/hotspot/docs/Serviceability.html#battach" target="_blank" rel="external">HotSpot Dynamic Attach Mechanism</a>这篇介绍中我们可以看到Attach API的实现概要.</p>
<p>HotSpot Dynamic Attach Mechanism这个工具是用于Attach到另一个运行Java代码的进程, 目标Java进程会开启一个<code>JVM TI</code>代理或者一个<code>java.lang.instrument</code>代理.</p>
<p>而Sun公司(Hotspot VM)对其还有一些额外的功能实现(<code>HotSpotVirtualMachine</code>中实现)</p>
<ul>
<li>dump堆内存</li>
<li>显示加载进目标虚拟机的class的实例数量. 可以选择是全部的实例数量还是仅仅显示存活下来的实例数量.</li>
</ul>
<p>当JVM第一次收到attach请求的时候, 它会创建一个<code>attach listener</code>线程. </p>
<p>在不同的系统上, 请求的发送方式也不一样(参考<code>LinuxVirtualMachine</code>). 例如在Linux或者Solaris系统上, attach 客户端会创建一个<code>.attach_pid(pid)</code>文件, 然后向目标虚拟机发送一个<code>SIGQUIT</code>信号. 目标虚拟机会根据<code>.attach_pid(pid)</code>文件与否运行<code>attach listener</code>线程. </p>
<p>在Linux系统上客户端是通过socket与<code>attach listener</code>线程进行交互的.</p>
<p>当attach成功之后, 会在<code>/tmp</code>目录下生成一个<code>.java_pid&lt;pid&gt;</code>的文件生成. 这个文件的生成目录是不可修改的, 而且一旦文件生成之后, 不可以删掉再尝试重新生成.</p>
<p>我们看一下<code>LinuxVirtualMachine</code> 的attach 过程<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line">LinuxVirtualMachine(AttachProvider provider, String vmid)</div><div class="line">      <span class="keyword">throws</span> AttachNotSupportedException, IOException</div><div class="line">  &#123;</div><div class="line">      <span class="keyword">super</span>(provider, vmid);</div><div class="line"></div><div class="line">      <span class="comment">// This provider only understands pids</span></div><div class="line">      <span class="keyword">int</span> pid;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          pid = Integer.parseInt(vmid);</div><div class="line">      &#125; <span class="keyword">catch</span> (NumberFormatException x) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> AttachNotSupportedException(<span class="string">"Invalid process identifier"</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 尝试搜索 socket file. 如果找不到的话就向目标虚拟机发送QUIT信号, 让目标虚拟机开启 attach mechanism.</span></div><div class="line">      <span class="comment">// 然后继续尝试搜索  socket file.</span></div><div class="line">      <span class="comment">// target VM会创建这个文件, 这个是因为Unix domain socket本身的实现机制需要去创建一个文件, 通过这个文件来进行IPC</span></div><div class="line">      <span class="comment">// Find the  socket file. If not found then we attempt to start the</span></div><div class="line">      <span class="comment">// attach mechanism in the target VM by sending it a QUIT signal.</span></div><div class="line">      <span class="comment">// Then we attempt to find the socket file again.</span></div><div class="line">      path = findSocketFile(pid);</div><div class="line">      <span class="keyword">if</span> (path == <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="comment">// 创建 .attach_pid&lt;pid&gt; 文件, 触发Attach Listener线程的创建,因为SIGQUIT信号不是只有这里发送，</span></div><div class="line">          <span class="comment">// 通过这个文件来告诉target VM，有attach请求过来了。</span></div><div class="line">          File f = createAttachFile(pid);</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              <span class="comment">// On LinuxThreads each thread is a process and we don't have the</span></div><div class="line">              <span class="comment">// pid of the VMThread which has SIGQUIT unblocked. To workaround</span></div><div class="line">              <span class="comment">// this we get the pid of the "manager thread" that is created</span></div><div class="line">              <span class="comment">// by the first call to pthread_create. This is parent of all</span></div><div class="line">              <span class="comment">// threads (except the initial thread).</span></div><div class="line">              <span class="keyword">if</span> (isLinuxThreads) &#123;</div><div class="line">                  <span class="keyword">int</span> mpid;</div><div class="line">                  <span class="keyword">try</span> &#123;</div><div class="line">                      mpid = getLinuxThreadsManager(pid);</div><div class="line">                  &#125; <span class="keyword">catch</span> (IOException x) &#123;</div><div class="line">                      <span class="keyword">throw</span> <span class="keyword">new</span> AttachNotSupportedException(x.getMessage());</div><div class="line">                  &#125;</div><div class="line">                  <span class="keyword">assert</span>(mpid &gt;= <span class="number">1</span>);</div><div class="line">                  sendQuitToChildrenOf(mpid);</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                  sendQuitTo(pid);</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="comment">// 默认等待5秒钟, 等待目标虚拟机 attach mechanism 启动完成</span></div><div class="line">              <span class="comment">// 启动完成之后会创建一个 .java_pid&lt;pid&gt; 文件, 该文件会赋值给 path 变量</span></div><div class="line">              <span class="comment">// give the target VM time to start the attach mechanism</span></div><div class="line">              <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">              <span class="keyword">long</span> delay = <span class="number">200</span>;</div><div class="line">              <span class="keyword">int</span> retries = (<span class="keyword">int</span>)(attachTimeout() / delay);</div><div class="line">              do &#123;</div><div class="line">                  <span class="keyword">try</span> &#123;</div><div class="line">                      Thread.sleep(delay);</div><div class="line">                  &#125; <span class="keyword">catch</span> (InterruptedException x) &#123; &#125;</div><div class="line">                  path = findSocketFile(pid);</div><div class="line">                  i++;</div><div class="line">              &#125; <span class="keyword">while</span> (i &lt;= retries &amp;&amp; path == <span class="keyword">null</span>);</div><div class="line">              <span class="keyword">if</span> (path == <span class="keyword">null</span>) &#123;</div><div class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> AttachNotSupportedException(</div><div class="line">                      <span class="string">"Unable to open socket file: target process not responding "</span> +</div><div class="line">                      <span class="string">"or HotSpot VM not loaded"</span>);</div><div class="line">              &#125;</div><div class="line">          &#125; <span class="keyword">finally</span> &#123;</div><div class="line">              f.delete();</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// Check that the file owner/permission to avoid attaching to</span></div><div class="line">      <span class="comment">// bogus process</span></div><div class="line">      checkPermissions(path);</div><div class="line"></div><div class="line">      <span class="comment">// Check that we can connect to the process</span></div><div class="line">      <span class="comment">// - this ensures we throw the permission denied error now rather than</span></div><div class="line">      <span class="comment">// later when we attempt to enqueue a command.</span></div><div class="line">      <span class="keyword">int</span> s = socket();</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          connect(s, path);</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          close(s);</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">	</div><div class="line"> <span class="comment">// Return the socket file for the given process.</span></div><div class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">findSocketFile</span><span class="params">(<span class="keyword">int</span> pid)</span> </span>&#123;</div><div class="line">      File f = <span class="keyword">new</span> File(tmpdir, <span class="string">".java_pid"</span> + pid);</div><div class="line">      <span class="keyword">if</span> (!f.exists()) &#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> f.getPath();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 在 Solaris/Linux 系统中开启 attach mechanism 的一个非常简单的方式是使用握手的方式. 通过在目标虚拟机的工作目录</span></div><div class="line">  <span class="comment">// (或者tmp目录下) 创建一个.attach_pid&lt;pid&gt; 文件 , 然后目标虚拟机的 SIGQUIT 信号处理器通过不断地查询这个文件是否存在</span></div><div class="line">  <span class="comment">// 来决定是否开启 attach mechanism .</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">// On Solaris/Linux a simple handshake is used to start the attach mechanism</span></div><div class="line">  <span class="comment">// if not already started. The client creates a .attach_pid&lt;pid&gt; file in the</span></div><div class="line">  <span class="comment">// target VM's working directory (or temp directory), and the SIGQUIT handler</span></div><div class="line">  <span class="comment">// checks for the file.</span></div><div class="line">  <span class="function"><span class="keyword">private</span> File <span class="title">createAttachFile</span><span class="params">(<span class="keyword">int</span> pid)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">      String fn = <span class="string">".attach_pid"</span> + pid;</div><div class="line">      String path = <span class="string">"/proc/"</span> + pid + <span class="string">"/cwd/"</span> + fn;</div><div class="line">      File f = <span class="keyword">new</span> File(path);</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          f.createNewFile();</div><div class="line">      &#125; <span class="keyword">catch</span> (IOException x) &#123;</div><div class="line">          f = <span class="keyword">new</span> File(tmpdir, fn);</div><div class="line">          f.createNewFile();</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> f;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>从以上分析我们可以看出, Attach API 是客户端通过本地socket与目标jvm进行通信的, 具体的功能实现都是在目标JVM里实现的.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/08/29/jvm/Attatch API/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/08/29/jvm/Attatch API/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/08/26/JavaSE/Java ClassPath 的秘密/" title="Java ClassPath 的秘密" itemprop="url">Java ClassPath 的秘密</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-08-25T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-08-26</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>写了一段简单的测试代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		JSONObject json = <span class="keyword">new</span> JSONObject();</div><div class="line">		TimeUnit.HOURS.sleep(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后分别执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">[root@root wangming]<span class="comment"># javac -cp ./* Test.java</span></div><div class="line">javac: invalid flag: ./Test.class</div><div class="line">Usage: javac &lt;options&gt; &lt;<span class="built_in">source</span> files&gt;</div><div class="line">use -help <span class="keyword">for</span> a list of possible options</div><div class="line">[root@root wangming]<span class="comment"># javac -cp . Test.java</span></div><div class="line">Test.java:2: error: package com.alibaba.fastjson does not exist</div><div class="line">import com.alibaba.fastjson.JSONObject;</div><div class="line">                           ^</div><div class="line">Test.java:9: error: cannot find symbol</div><div class="line">                JSONObject json = new JSONObject();</div><div class="line">                ^</div><div class="line">  symbol:   class JSONObject</div><div class="line">  location: class Test</div><div class="line">Test.java:9: error: cannot find symbol</div><div class="line">                JSONObject json = new JSONObject();</div><div class="line">                                      ^</div><div class="line">  symbol:   class JSONObject</div><div class="line">  location: class Test</div><div class="line">3 errors</div><div class="line">[root@root wangming]<span class="comment"># javac -cp .:./ Test.java</span></div><div class="line">Test.java:2: error: package com.alibaba.fastjson does not exist</div><div class="line">import com.alibaba.fastjson.JSONObject;</div><div class="line">                           ^</div><div class="line">Test.java:9: error: cannot find symbol</div><div class="line">                JSONObject json = new JSONObject();</div><div class="line">                ^</div><div class="line">  symbol:   class JSONObject</div><div class="line">  location: class Test</div><div class="line">Test.java:9: error: cannot find symbol</div><div class="line">                JSONObject json = new JSONObject();</div><div class="line">                                      ^</div><div class="line">  symbol:   class JSONObject</div><div class="line">  location: class Test</div><div class="line">3 errors</div><div class="line">[root@root wangming]<span class="comment"># javac -cp .:./* Test.java</span></div></pre></td></tr></table></figure></p>
<p>在<a href="http://docs.oracle.com/javase/7/docs/technotes/tools/solaris/classpath.html" target="_blank" rel="external">Setting the class path</a>这篇文章中, 说classpath 可以是以下三种形式</p>
<ul>
<li>jar包(.jar结尾的文件) 里面包含了class文件</li>
<li>zip包(.zip结尾的文件) 里面包含了class文件</li>
<li>目录(文件夹) 如果class文件里有package, 那么目录里一定要有和package相应的目录结构</li>
</ul>
<p>如果一个classpath中包含了通配符(<code>*</code>), 那么Java就不会在这个目录下搜索class文件了. </p>
<p>例如<code>lib/*</code>, 如果classpath是这个, 那么classpath就只会在<code>lib</code>目录下搜索jar文件, 然后从jar文件中去加载class, 如果想要在lib目录下既搜索jar文件也搜索class文件的话, 那么可以写成<code>lib:lib/*</code>或者<code>lib/*:lib</code>.</p>
<p>还有一点很重要的是, 如果<code>lib</code>目录下有子目录的话<code>lib/jetty</code>的话, Java是不会进行递归搜索子目录的。</p>
<p>说到这里, Java为什么不会在<code>lib/*</code>下搜索class文件呢？是这样的, 如果<code>lib</code>目录下有<code>a.jar</code>和<code>b.jar</code>, 其实现在的<code>lib/*</code>就被替换成了<code>lib/a.jar:lib/b.jar</code>. 我们可以在Java的系统变量里看到这个结果.</p>
<p>看到这,我们应该就推断出上面错误的原因了, <code>.</code>只会搜索<code>class</code>文件但是不会搜索jar, 而<code>*</code>通配符则自动帮我换成了jar文件的classpath的替换.</p>
<blockquote>
<p>安装上JDK后, 系统会自动设置一个CLASSPATH的环境变量(.:/home/jdk1.8/lib/dt.jar:/home/jdk1.8/lib/tools.jar), 但是当运行Java命令, 指定<code>-cp</code>的时候,会覆盖掉这个classpath, 所以在新的classpath上一定要指定<code>.</code></p>
</blockquote>
<p>classpath适用于下列工具<br><a href="http://docs.oracle.com/javase/7/docs/technotes/tools/index.html" target="_blank" rel="external">JDK Tools and Utilities</a></p>
<p><a href="http://docs.oracle.com/javase/7/docs/technotes/tools/findingclasses.html" target="_blank" rel="external">How Classes are Found</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/08/26/JavaSE/Java ClassPath 的秘密/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/08/26/JavaSE/Java ClassPath 的秘密/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/08/22/jvm/hsperfdata/" title="hsperfdata" itemprop="url">hsperfdata</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-08-21T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-08-22</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>Hotspot出于性能测试和排查问题的目的而提供了jvmstat 工具. 我们可以使用JVM参数<code>-XX:+UsePerfData</code>来决定是否开启这个功能. 因此jvm运行时会生成一个目录hsperfdata_$USER($USER是启动java进程的用户,在linux中默认是/tmp),目录下会有些java 进程的 pid文件. 文件内部存储的是jvmstat统计的jvm进程的相关信息.</p>
<blockquote>
<p>jvmstat源码参考<a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/com/sun/jvmstat" target="_blank" rel="external">openjdk\jdk\src\share\classes\sun\jvmstat</a></p>
</blockquote>
<p>当我们将/tmp/hsperfdata目录下的某个进程文件删除之后, 相应的进程也就消失了, 经过测试即使Java进程里已经注册了钩子程序, 但是钩子程序也不会执行, 进程就直接消失了. 而且进程消失之后, 这个文件也就没有了. </p>
<p>PerfData 相关的JVM选项</p>
<ul>
<li><code>-XX:+UsePerfData</code>    用于设置是否开启统计.(默认值为true, 开启)</li>
<li><code>-XX:+PerfDataSaveToFile</code>    在系统退出时是否将PerfData 内存数据保存到<code>hsperfdata_</code> 文件(默认为false, 不开启). 注意这个数据是保存到Java进程当前的工作目录, 而不是<code>/tmp</code>下</li>
<li><code>PerfDataSamplingInterval</code>    统计采样间隔(单位毫秒, 默认是50毫秒)</li>
<li><code>PerfDisableSharedMem</code>    是否将标准内存的性能数据进行存储(默认为false, 不存储)</li>
<li><code>PerfDataMemorySize</code>    性能统计数据可存储大小. 总是对操作系统内存页的大小进行取整(默认是32k)。 因为在内存中保存的是32k的数据, 因此存储到文件之后, 文件的大小也固定在32k.</li>
</ul>
<p>我们可以使用jdk提供的一些工具来读取这个目录下的JVM进程信息统计文件, 例如</p>
<p>jstat读取<code>/tmp/hsperfdata_username/</code>目录下的文件查看虚拟机老年代的情况<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@root wangming]<span class="comment"># jstat -gcold file:///tmp/hsperfdata_username/2332 </span></div><div class="line">   MC       MU      CCSC     CCSU       OC          OU       YGC    FGC    FGCT     GCT   </div><div class="line"> 26112.0  25379.2   3840.0   3719.1    164864.0     18007.6    495     1    0.102    2.377</div></pre></td></tr></table></figure></p>
<p><a href="http://openjdk.java.net/groups/hotspot/docs/Serviceability.html#bjvmstat" target="_blank" rel="external">HotSpot Jvmstat Performance Counters</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/08/22/jvm/hsperfdata/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/08/22/jvm/hsperfdata/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/08/02/杂记/linux 网络监控一探/" title="linux 网络监控一探" itemprop="url">linux 网络监控一探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-08-01T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-08-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>最近服务器在跑机器人, 看过内存和cpu之后, 想要看一下2500个机器人的流量情况, 打开zabix一看, 我擦嘞 Outgoing network traffic on eth0 的流量居然是从 20M~60M之间浮动, 这不科学啊. 但是后来一想这可能是整个机器的网络带宽, 于是便想找到一款可以以进程或者以端口为单元的监控工具. </p>
<p>在百度上搜索了一下, 居然有这么多的网络监控工具 (参考<a href="http://www.linuxdiyf.com/linux/12131.html" target="_blank" rel="external">一些你可能不知道的Linux网络工具</a>)</p>
<ul>
<li>nethogs</li>
<li>ntopng</li>
<li>nload</li>
<li>iftop</li>
<li>iptraf</li>
<li>bmon</li>
<li>slurm</li>
<li>tcptrack</li>
<li>cbm</li>
<li>netwatch</li>
<li>collectl</li>
<li>trafshow</li>
<li>cacti</li>
<li>etherape</li>
<li>ipband</li>
<li>jnettop</li>
<li>netspeed </li>
<li>speedometer<br>下面就开始了我的探索之旅</li>
</ul>
<h2 id="iftop"><a href="#iftop" class="headerlink" title="iftop"></a>iftop</h2><p>首先找到的是这个软件, 听说它可以实现我的要求, 于是开始安装</p>
<p>首先执行下列命令进行安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install flex byacc  libpcap ncurses ncurses-devel libpcap-devel</div></pre></td></tr></table></figure></p>
<p>ok, 依赖安装完成,但是在<code>yum install iftop</code>时提示<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[root@~]<span class="comment"># yum install iftop</span></div><div class="line">Loaded plugins: fastestmirror, refresh-packagekit, security</div><div class="line">Loading mirror speeds from cached hostfile</div><div class="line"> * base: mirrors.tuna.tsinghua.edu.cn</div><div class="line"> * epel: mirrors.neusoft.edu.cn</div><div class="line"> * extras: mirrors.tuna.tsinghua.edu.cn</div><div class="line"> * updates: mirrors.tuna.tsinghua.edu.cn</div><div class="line">Setting up Install Process</div><div class="line">Resolving Dependencies</div><div class="line">--&gt; Running transaction check</div><div class="line">---&gt; Package iftop.x86_64 0:1.0-0.7.pre4.el5 will be installed</div><div class="line">--&gt; Processing Dependency: libpcap.so.0.9.4()(64bit) <span class="keyword">for</span> package: iftop-1.0-0.7.pre4.el5.x86_64</div><div class="line">--&gt; Finished Dependency Resolution</div><div class="line">Error: Package: iftop-1.0-0.7.pre4.el5.x86_64 (epel)</div><div class="line">           Requires: libpcap.so.0.9.4()(64bit)</div><div class="line"> You could try using --skip-broken to work around the problem</div><div class="line"> You could try running: rpm -Va --nofiles --nodigest</div></pre></td></tr></table></figure></p>
<p>对libpcap的依赖和我们安装的版本不一致, 于是我尝试下载安装包手动安装试试<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wget http://www.ex-parrot.com/~pdw/iftop/download/iftop-0.17.tar.gz</div><div class="line"><span class="built_in">cd</span> iftop-0.17</div><div class="line">./configure</div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure></p>
<p>安装完成, 试试有没有安装成功<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iftop</div></pre></td></tr></table></figure></p>
<p>ok成功进入.</p>
<p>界面上面显示的是类似刻度尺的刻度范围，为显示流量图形的长条作标尺用的。中间的&lt;= =&gt;这两个左右箭头，表示的是流量的方向。</p>
<ul>
<li>TX：发送流量</li>
<li>RX：接收流量</li>
<li>TOTAL：总流量</li>
<li>Cumm：运行iftop到目前时间的总流量</li>
<li>peak：流量峰值</li>
<li>rates：分别表示过去 2s 10s 40s 的平均流量</li>
</ul>
<p>这个界面是以每个客户端连接到服务器的连接为单位进行显示的. 虽然达不到要以本机为单位显示端口和进程的带宽和流量, 但是也蛮不错的了.</p>
<blockquote>
<p>具体这个软件的其他参数,大家可以百度一下</p>
</blockquote>
<h2 id="iptraf"><a href="#iptraf" class="headerlink" title="iptraf"></a>iptraf</h2><p>后来又找到了iptraf这个软件, 是一个基于ncurses的IP局域网监控器，用来生成包括TCP信息、UDP计数、ICMP和OSPF信息、以太网负载信息、节点状态信息、IP校验和错误等等统计数据。</p>
<p>这个软件安装很简单, 不需要安装什么依赖<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install iptraf</div></pre></td></tr></table></figure></p>
<p>打开看了一下, 这个软件更多的是基于网卡, 和IP进行监听. 虽然在Staticstics breakdowns上可以看到端口信息, 但是不知道为什么没有看到应用程序的端口. 没办法接着百度, 于是在这篇文章里找到了答案<a href="http://blog.csdn.net/quiet_girl/article/details/50777210" target="_blank" rel="external">Linux中iptraf命令详解</a>原来在Configure里的Additional ports里设置需要监听的端口, 默认只监听1000以下的. </p>
<p>设置完以后, 再次进入Staticstics breakdowns可以看到我们要监控的端口了, 但是监测的出来的还有其他没有在我设定那个范围里的端口。 嗯，又研究了一下,发现在端口配置里是可以选择多个端口的. 只要配置多个端口就可以了. 但是还有个问题, 就是统计的流量都是总计的,没有实时或者平均值.</p>
<h2 id="nethogs"><a href="#nethogs" class="headerlink" title="nethogs"></a>nethogs</h2><p>nethogs 会根据进程来进行分组(ok,第一个要求达到了), 而且打开之后也会显示该进程的实时流量.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@~]<span class="comment"># nethogs -p eth0</span></div><div class="line"></div><div class="line">NetHogs version 0.8.0</div><div class="line"></div><div class="line">PID USER     PROGRAM                                                                        DEV       SEN         RECEIVED       </div><div class="line">23095 root   java                                                                           eth0      421.746     138.566 KB/sec</div><div class="line">10867 root     sshd: root@pts/1                                                             eth0      1.825       0.059 KB/sec</div><div class="line">?     root     192.168.15.25:10050-192.168.15.12:48691                                            0.000       0.014 KB/sec</div><div class="line">?     root     192.168.15.25:19001-192.168.10.220:26680                                               0.000       0.000 KB/sec</div><div class="line">?     root     192.168.15.25:10050-192.168.15.12:48608                                                0.000       0.000 KB/sec</div><div class="line">?     root     192.168.15.25:10050-192.168.15.12:48096                                                0.000       0.000 KB/sec</div><div class="line">?     root     192.168.15.25:10050-192.168.15.12:48082                                                0.000       0.000 KB/sec</div><div class="line">23182 root     java                                                                        eth0       0.000       0.000 KB/sec</div><div class="line">?     root     unknown TCP                                                                            0.000       0.000 KB/sec</div><div class="line"></div><div class="line">TOTAL                                                                                                 423.571     138.639 KB/sec</div></pre></td></tr></table></figure></p>
<p>完美, nethogs完美解决了我们的问题</p>
<h2 id="vnStat"><a href="#vnStat" class="headerlink" title="vnStat"></a>vnStat</h2><p>vnStat是一个基于控制台的网络流量监控工具，是为Linux和BSD设计的。它可以保留某个或多个所选择的网络接口的网络流量日志。为了生成日志，vnStat使用内核提供的信息。换句话说，它不会嗅探网络流量，确保尽量少用系统资源。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@ ~]<span class="comment"># vnstat --help</span></div><div class="line"> vnStat 1.6 by Teemu Toivola &lt;tst at iki dot <span class="keyword">fi</span>&gt;</div><div class="line"></div><div class="line">         -q,  --query          query database</div><div class="line">         -h,  --hours          show hours</div><div class="line">         <span class="_">-d</span>,  --days           show days</div><div class="line">         -m,  --months         show months</div><div class="line">         -w,  --weeks          show weeks</div><div class="line">         -t,  --top10          show top10</div><div class="line">         <span class="_">-s</span>,  --short          use short output</div><div class="line">         -u,  --update         update database</div><div class="line">         -i,  --iface          select interface (default: eth0)</div><div class="line">         -?,  --help           short <span class="built_in">help</span></div><div class="line">         -v,  --version        show version</div><div class="line">         -tr, --traffic        calculate traffic</div><div class="line">         <span class="_">-l</span>,  --live           实时显示流量数据</div><div class="line"></div><div class="line">See also <span class="string">"--longhelp"</span> <span class="keyword">for</span> complete options list and <span class="string">"man vnstat"</span>.</div></pre></td></tr></table></figure></p>
<p>测试<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">[root@ ~]<span class="comment"># vnstat </span></div><div class="line">Database updated: Tue Aug  2 14:08:15 2016</div><div class="line"></div><div class="line">        eth0</div><div class="line"></div><div class="line">           received:     686.90 MB (22.6%)</div><div class="line">        transmitted:       2.30 GB (77.4%)</div><div class="line">              total:       2.97 GB</div><div class="line"></div><div class="line">                        rx     |     tx     |  total</div><div class="line">        -----------------------+------------+-----------</div><div class="line">            today    686.90 MB |    2.30 GB |    2.97 GB</div><div class="line">        -----------------------+------------+-----------</div><div class="line">        estimated      1.14 GB |    3.91 GB |    5.04 GB</div><div class="line">[root@ ~]<span class="comment"># vnstat -l -u</span></div><div class="line">Monitoring eth0...    (press CTRL-C to stop)</div><div class="line"></div><div class="line">   rx:     791.08 kB/s 11969 p/s            tx:    2482.06 kB/s 21979 p/s^C</div><div class="line"></div><div class="line"></div><div class="line"> eth0  /  traffic statistics</div><div class="line"></div><div class="line">                             rx       |       tx</div><div class="line">--------------------------------------+----------------------------------------</div><div class="line">  bytes                      7.27 MB  |      22.35 MB</div><div class="line">--------------------------------------+----------------------------------------</div><div class="line">          max            894.73 kB/s  |     2.60 MB/s</div><div class="line">      average            620.59 kB/s  |     1.86 MB/s</div><div class="line">          min            599.12 kB/s  |     1.82 MB/s</div><div class="line">--------------------------------------+----------------------------------------</div><div class="line">  packets                     111771  |        200661</div><div class="line">--------------------------------------+----------------------------------------</div><div class="line">          max              13430 p/s  |     22767 p/s</div><div class="line">      average               9314 p/s  |     16721 p/s</div><div class="line">          min               9019 p/s  |     16711 p/s</div><div class="line">--------------------------------------+----------------------------------------</div><div class="line">  time                    12 seconds</div><div class="line"></div><div class="line">[root@ ~]<span class="comment"># vnstat </span></div><div class="line">Database updated: Tue Aug  2 14:08:56 2016</div><div class="line"></div><div class="line">        eth0</div><div class="line"></div><div class="line">           received:     712.66 MB (22.6%)</div><div class="line">        transmitted:       2.38 GB (77.4%)</div><div class="line">              total:       3.07 GB</div><div class="line"></div><div class="line">                        rx     |     tx     |  total</div><div class="line">        -----------------------+------------+-----------</div><div class="line">            today    712.66 MB |    2.38 GB |    3.07 GB</div><div class="line">        -----------------------+------------+-----------</div><div class="line">        estimated      1.18 GB |    4.03 GB |    5.21 GB</div><div class="line">[root@ ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>我们看到只有使用了<code>-u</code>参数将数据更新到数据库之后, 才能再次使用vnstat时将数据显示出来. 因此cnstat更像是一个历史记录工具</p>
<h2 id="tcpdump"><a href="#tcpdump" class="headerlink" title="tcpdump"></a>tcpdump</h2><p>对网络上的数据包进行截获的包分析工具. 虽然这个工具, 不是解决今天这个问题, 但是还是在这里记录一下, 万一用得到呢</p>
<blockquote>
<p>另外还有tcpflow工具, 与tcpdump不同的是它是以流为单位显示数据内容，而cpdump以包为单位显示数据。</p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/杂记/">杂记</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/08/02/杂记/linux 网络监控一探/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/08/02/杂记/linux 网络监控一探/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/29/nosql/jedis lambda/" title="当Jedis 遇上 Lambda" itemprop="url">当Jedis 遇上 Lambda</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-07-29T07:00:00.000Z" itemprop="datePublished"> 发表于 2016-07-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>一直苦恼于使用Jedis时要时时牢记关闭资源这个操作, 当Lambda出现后, 这种苦恼终于可以远离而去了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Medis</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> JedisPool jedisPool;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Medis</span><span class="params">()</span> </span>&#123;</div><div class="line">		JedisPoolConfig config = <span class="keyword">new</span> JedisPoolConfig();</div><div class="line">		jedisPool = <span class="keyword">new</span> JedisPool(config, <span class="string">"192.168.15.20"</span>, <span class="number">6379</span>, <span class="number">10000</span>, <span class="string">"xpec@2015"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumer</span><span class="params">(NonResultOperator consumer)</span> </span>&#123;</div><div class="line">		<span class="keyword">try</span>(Jedis jedis = jedisPool.getResource()) &#123;</div><div class="line">			consumer.accept(jedis);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> &lt;U&gt; <span class="function">U <span class="title">accept</span><span class="params">(ResultOperator consumer)</span> </span>&#123;</div><div class="line">		<span class="keyword">try</span>(Jedis jedis = jedisPool.getResource()) &#123;</div><div class="line">			<span class="keyword">return</span> (U) consumer.accept(jedis);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@FunctionalInterface</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ResultOperator</span> </span>&#123;</div><div class="line">	<span class="function">Object <span class="title">accept</span><span class="params">(redis.clients.jedis.Jedis t)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@FunctionalInterface</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">NonResultOperator</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">accept</span><span class="params">(redis.clients.jedis.Jedis t)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>写一个测试类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MedisTest</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</div><div class="line">		Medis medis = <span class="keyword">new</span> Medis();</div><div class="line">		medis.consumer(jedis -&gt; jedis.set(<span class="string">"123"</span>, <span class="string">"456"</span>));</div><div class="line"></div><div class="line">		String result = medis.accept(jedis -&gt; jedis.get(<span class="string">"123"</span>));</div><div class="line">		System.out.println(result);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">456</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/NoSql/">NoSql</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/07/29/nosql/jedis lambda/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/07/29/nosql/jedis lambda/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/25/JavaLibrary/Jetty/" title="Jetty 嵌入模式" itemprop="url">Jetty 嵌入模式</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-07-24T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-07-25</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>添加依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.eclipse.jetty/jetty-server --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.jetty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jetty-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.4.0.M0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<ul>
<li><code>HandlerCollection</code> ：维持一个handlers 集合, 然后按顺序依次调用每个handler(注意这个里的handler不管发生什么情况都会执行一遍, 这通常可以作为一个切面用于统计和记日志). </li>
<li><code>HandlerList</code>：同样维持一个handlers 集合,也是按顺序调用每个handler.但是当有异常抛出, 或者有response返回, 或者 <code>request.isHandled()</code>被设为true.</li>
<li><code>HandlerWrapper</code>：继承自<code>HandlerWrapper</code>的类可以以面向切面编程的方式将handler通过链式的形式组合在一起.例如一个标准的web应用程序就实现了一个这样的规则, 他将context,session,security,servlet的handler以链式的方式组合在一起.</li>
</ul>
<h2 id="文件服务器"><a href="#文件服务器" class="headerlink" title="文件服务器"></a>文件服务器</h2><p>通过<code>ResourceHandler</code> 指定了资源路径，并且允许列出目录和文件. 下面的例子中就是直接将<code>ResourceHandler</code>映射到根目录<code>/</code>下, 即通过<code>http://localhost:8080/</code>就可以在浏览器上看到所有的文件列表<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.eclipse.jetty.server.Server;</div><div class="line"><span class="keyword">import</span> org.eclipse.jetty.server.handler.ContextHandler;</div><div class="line"><span class="keyword">import</span> org.eclipse.jetty.server.handler.HandlerList;</div><div class="line"><span class="keyword">import</span> org.eclipse.jetty.server.handler.ResourceHandler;</div><div class="line"><span class="keyword">import</span> org.eclipse.jetty.server.handler.gzip.GzipHandler;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		Server server = <span class="keyword">new</span> Server(<span class="number">8080</span>);</div><div class="line"></div><div class="line">		ResourceHandler fileResourceHandler = <span class="keyword">new</span> ResourceHandler();</div><div class="line">		fileResourceHandler.setDirectoriesListed(<span class="keyword">true</span>);</div><div class="line">		fileResourceHandler.setResourceBase(<span class="string">"D:\\repository"</span>);</div><div class="line"></div><div class="line">		GzipHandler gzip = <span class="keyword">new</span> GzipHandler();</div><div class="line">		server.setHandler(gzip);</div><div class="line"></div><div class="line">		ContextHandler fileContext = <span class="keyword">new</span> ContextHandler(<span class="string">"/files"</span>);</div><div class="line">		fileContext.setHandler(fileResourceHandler);</div><div class="line"></div><div class="line">		ResourceHandler indexResourceHandler = <span class="keyword">new</span> ResourceHandler();</div><div class="line">		indexResourceHandler.setDirectoriesListed(<span class="keyword">true</span>);</div><div class="line">		indexResourceHandler.setWelcomeFiles(<span class="keyword">new</span> String[]&#123;<span class="string">"index.html"</span>&#125;);</div><div class="line">		indexResourceHandler.setResourceBase(<span class="string">"."</span>);</div><div class="line"></div><div class="line">		ContextHandler indexContextHandler = <span class="keyword">new</span> ContextHandler(<span class="string">"/"</span>);</div><div class="line">		indexContextHandler.setHandler(indexResourceHandler);</div><div class="line"></div><div class="line">		HandlerList handlerList = <span class="keyword">new</span> HandlerList();</div><div class="line">		handlerList.addHandler(fileContext);</div><div class="line">		handlerList.addHandler(indexContextHandler);</div><div class="line"></div><div class="line">		server.setHandler(handlerList);</div><div class="line">		server.start();</div><div class="line">		server.join();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>还可以使用<code>ContextHandler</code>将<code>ResourceHandler</code>映射到其他路径上. </p>
</blockquote>
<h2 id="ContextHandler"><a href="#ContextHandler" class="headerlink" title="ContextHandler"></a>ContextHandler</h2><p><code>ContextHandler</code>实现自<code>ScopedHandler</code>. <code>ContextHandler</code>实现的功能是将Http请求路径映射到某个具体处理业务逻辑的Handler上.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.eclipse.jetty.server.Handler;</div><div class="line"><span class="keyword">import</span> org.eclipse.jetty.server.Request;</div><div class="line"><span class="keyword">import</span> org.eclipse.jetty.server.Server;</div><div class="line"><span class="keyword">import</span> org.eclipse.jetty.server.handler.AbstractHandler;</div><div class="line"><span class="keyword">import</span> org.eclipse.jetty.server.handler.ContextHandler;</div><div class="line"><span class="keyword">import</span> org.eclipse.jetty.server.handler.ContextHandlerCollection;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.ServletException;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletOutputStream;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ManyContexts</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		Server server = <span class="keyword">new</span> Server(<span class="number">8080</span>);</div><div class="line"></div><div class="line">		<span class="comment">// 可以在ContextHandler的构造函数中设置URI映射,但是setContextPath()会覆盖构造函数中的映射</span></div><div class="line">		ContextHandler rootContext = <span class="keyword">new</span> ContextHandler(<span class="string">"/"</span>);</div><div class="line">		rootContext.setContextPath(<span class="string">"/root"</span>);</div><div class="line">		rootContext.setHandler(<span class="keyword">new</span> HelloHandler(<span class="string">"Root Hello"</span>));</div><div class="line"></div><div class="line">		ContextHandler contextFR = <span class="keyword">new</span> ContextHandler(<span class="string">"/fr"</span>);</div><div class="line">		contextFR.setHandler(<span class="keyword">new</span> HelloHandler(<span class="string">"Bonjoir"</span>));</div><div class="line"></div><div class="line">		ContextHandler contextV = <span class="keyword">new</span> ContextHandler(<span class="string">"/"</span>);</div><div class="line">		contextV.setVirtualHosts(<span class="keyword">new</span> String[] &#123; <span class="string">"127.0.0.2"</span> &#125;);</div><div class="line">		contextV.setHandler(<span class="keyword">new</span> HelloHandler(<span class="string">"Virtual Hello"</span>));</div><div class="line"></div><div class="line">		ContextHandler resourceBaseHandler = <span class="keyword">new</span> ContextHandler(<span class="string">"/resources"</span>);</div><div class="line">		<span class="comment">// 设置web内容的路径, 即请求web资源时(Html, js, css文件等)的根路径</span></div><div class="line">		resourceBaseHandler.setResourceBase(<span class="string">"/"</span>);</div><div class="line">		resourceBaseHandler.setHandler(<span class="keyword">new</span> HelloHandler(<span class="string">"Resource Hello"</span>));</div><div class="line"></div><div class="line">		ContextHandlerCollection contexts = <span class="keyword">new</span> ContextHandlerCollection();</div><div class="line">		contexts.setHandlers(<span class="keyword">new</span> Handler[] &#123; rootContext, contextFR, contextV, resourceBaseHandler&#125;);</div><div class="line"></div><div class="line">		server.setHandler(contexts);</div><div class="line"></div><div class="line">		server.start();</div><div class="line">		server.join();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloHandler</span> <span class="keyword">extends</span> <span class="title">AbstractHandler</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">private</span> String path;</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="title">HelloHandler</span><span class="params">(String path)</span> </span>&#123;</div><div class="line">			<span class="keyword">this</span>.path = path;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String target, Request baseRequest, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">			ServletOutputStream out = response.getOutputStream();</div><div class="line">			out.print(path);</div><div class="line">			out.flush();</div><div class="line">			response.setStatus(<span class="number">200</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们看一下测试结果<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ζ curl http://192.168.10.220:8080/</div><div class="line">Root Hello%                                                                                         </div><div class="line"><span class="comment"># wangming@OA1503P0256: ~                                                               (16:55:48)</span></div><div class="line">ζ curl http://192.168.10.220:8080/fr</div><div class="line"><span class="comment"># wangming@OA1503P0256: ~                                                               (16:55:55)</span></div><div class="line">ζ curl http://192.168.10.220:8080/it</div><div class="line"><span class="comment"># wangming@OA1503P0256: ~                                                               (16:56:07)</span></div><div class="line">ζ curl 127.0.0.2:8080/</div><div class="line">Virtual HelloRoot Hello%</div></pre></td></tr></table></figure></p>
<h2 id="Servlets"><a href="#Servlets" class="headerlink" title="Servlets"></a>Servlets</h2><p>Servlet是一种标准的处理HTTP请求逻辑的方式. Servlet和Jetty Handler非常像, 但是Servlet得request对象是不可变的.<br>Jetty的ServletHandler采用将请求映射到一个标准路径上.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.ServletException;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.eclipse.jetty.server.Server;</div><div class="line"><span class="keyword">import</span> org.eclipse.jetty.servlet.ServletHandler;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MinimalServlets</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		Server server = <span class="keyword">new</span> Server(<span class="number">8080</span>);</div><div class="line"></div><div class="line">		ServletHandler handler = <span class="keyword">new</span> ServletHandler();</div><div class="line">		server.setHandler(handler);</div><div class="line"></div><div class="line">		<span class="comment">// 下面我们配置一个原生的Servlet, 还有其他的Servlet(例如通过web.xml或者@WebServlet注解生成的)可配置</span></div><div class="line">		handler.addServletWithMapping(HelloServlet.class, <span class="string">"/*"</span>);</div><div class="line"></div><div class="line">		server.start();</div><div class="line">		server.join();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></div><div class="line">				<span class="keyword">throws</span> ServletException, IOException &#123;</div><div class="line">			response.setContentType(<span class="string">"text/html"</span>);</div><div class="line">			response.setStatus(HttpServletResponse.SC_OK);</div><div class="line">			response.getWriter().println(<span class="string">"&lt;h1&gt;Hello from HelloServlet&lt;/h1&gt;"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ServletContextHandler"><a href="#ServletContextHandler" class="headerlink" title="ServletContextHandler"></a>ServletContextHandler</h2><p>在上面的<code>Servlets</code>中我们看到每个Servlet都对应一个完整的URI地址映射, 但是如果我们想在某个特定的URI下, 增加子映射怎么办呢？这就用到了<code>ServletContextHandler</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.eclipse.jetty.server.Server;</div><div class="line"><span class="keyword">import</span> org.eclipse.jetty.servlet.ServletContextHandler;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.ServletException;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletContextHandlerTest</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		Server server = <span class="keyword">new</span> Server(<span class="number">8080</span>);</div><div class="line">		ServletContextHandler servletContextHandler = <span class="keyword">new</span> ServletContextHandler(ServletContextHandler.SESSIONS);</div><div class="line">		servletContextHandler.setContextPath(<span class="string">"/servlet"</span>);</div><div class="line">		servletContextHandler.addServlet(HelloServlet.class, <span class="string">"/abc"</span>);</div><div class="line">		server.setHandler(servletContextHandler);</div><div class="line">		server.start();</div><div class="line">		server.join();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></div><div class="line">				<span class="keyword">throws</span> ServletException, IOException &#123;</div><div class="line">			response.setContentType(<span class="string">"text/html"</span>);</div><div class="line">			response.setStatus(HttpServletResponse.SC_OK);</div><div class="line">			response.getWriter().println(<span class="string">"&lt;h1&gt;Hello from HelloServlet&lt;/h1&gt;"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Connectors"><a href="#Connectors" class="headerlink" title="Connectors"></a>Connectors</h2><p>当创建N个connectors应用时, 一般我们会将通用的配置首先提取出来, 使用一个配置类配置这些通用配置. 然后在其他具体Connectors配置时将这个配置传递到具体配置类中, 这样一来就形成了一个链式配置形式.</p>
<p>首先生成一个keystore文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">D:\ssl&gt;keytool -genkey -alias wm -keyalg RSA -keysize 1024 -keypass 123456 -validity 365 -keystore D:\ssl\wm.keystore -storepass 123456</div><div class="line">您的名字与姓氏是什么?</div><div class="line">  [Unknown]:  wm</div><div class="line">您的组织单位名称是什么?</div><div class="line">  [Unknown]:  wm</div><div class="line">您的组织名称是什么?</div><div class="line">  [Unknown]:  wm</div><div class="line">您所在的城市或区域名称是什么?</div><div class="line">  [Unknown]:  bj</div><div class="line">您所在的省/市/自治区名称是什么?</div><div class="line">  [Unknown]:  bj</div><div class="line">该单位的双字母国家/地区代码是什么?</div><div class="line">  [Unknown]:  cn</div><div class="line">CN=wm, OU=wm, O=wm, L=bj, ST=bj, C=cn是否正确?</div><div class="line">  [否]:  y</div><div class="line"></div><div class="line">D:\ssl&gt;</div></pre></td></tr></table></figure></p>
<p>然后看一下服务器代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> javax.servlet.ServletException;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ManyConnectors</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 加载ssl需要的keystore</span></div><div class="line">		File keystoreFile = <span class="keyword">new</span> File(<span class="string">"D:\\ssl\\wm.keystore"</span>);</div><div class="line">		<span class="keyword">if</span> (!keystoreFile.exists()) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(keystoreFile.getAbsolutePath());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// 开启一个JettyServer,但是此时我们并不设置端口,在Connectors里设置端口</span></div><div class="line">		Server server = <span class="keyword">new</span> Server();</div><div class="line"></div><div class="line">		<span class="comment">// 一个通用的HTTP配置. 使用HttpConfiguration进行对HTTP和HTTPS进行设置. HTTP默认的scheme是http,HTTPS默认的scheme是https</span></div><div class="line">		HttpConfiguration httpConfig = <span class="keyword">new</span> HttpConfiguration();</div><div class="line">		httpConfig.setSecureScheme(<span class="string">"https"</span>);</div><div class="line">		httpConfig.setSecurePort(<span class="number">8443</span>);</div><div class="line">		httpConfig.setOutputBufferSize(<span class="number">32768</span>);</div><div class="line"></div><div class="line">		<span class="comment">// 构建一个HTTP Connectors</span></div><div class="line">		ServerConnector http = <span class="keyword">new</span> ServerConnector(server, <span class="keyword">new</span> HttpConnectionFactory(httpConfig));</div><div class="line">		http.setPort(<span class="number">8080</span>);</div><div class="line">		http.setIdleTimeout(<span class="number">30000</span>);</div><div class="line"></div><div class="line">		<span class="comment">// 根据SSL证书生成ssl信息</span></div><div class="line">		SslContextFactory sslContextFactory = <span class="keyword">new</span> SslContextFactory();</div><div class="line">		sslContextFactory.setKeyStorePath(keystoreFile.getAbsolutePath());</div><div class="line">		sslContextFactory.setKeyStorePassword(<span class="string">"123456"</span>);</div><div class="line">		sslContextFactory.setKeyManagerPassword(<span class="string">"123456"</span>);</div><div class="line"></div><div class="line">		<span class="comment">// 现在为HTTP Connectors创建一个http配置对象, 这个对象是必须的, 我们不能在http Connectors里复用httpConfig对象,</span></div><div class="line">		<span class="comment">// 即便是将httpConfig对象作为参数进行构建，它的内部也是对它的一个克隆而已</span></div><div class="line">		HttpConfiguration httpsConfig = <span class="keyword">new</span> HttpConfiguration(httpConfig);</div><div class="line">		<span class="comment">// SecureRequestCustomizer用于处理从Jetty接手的https连接</span></div><div class="line">		SecureRequestCustomizer src = <span class="keyword">new</span> SecureRequestCustomizer();</div><div class="line">		src.setStsMaxAge(<span class="number">2000</span>);</div><div class="line">		src.setStsIncludeSubDomains(<span class="keyword">true</span>);</div><div class="line">		httpsConfig.addCustomizer(src);</div><div class="line"></div><div class="line">		ServerConnector https = <span class="keyword">new</span> ServerConnector(server,</div><div class="line">				<span class="keyword">new</span> SslConnectionFactory(sslContextFactory, HttpVersion.HTTP_1_1.asString()),</div><div class="line">				<span class="keyword">new</span> HttpConnectionFactory(httpsConfig));</div><div class="line">		https.setPort(<span class="number">8443</span>);</div><div class="line">		https.setIdleTimeout(<span class="number">500000</span>);</div><div class="line"></div><div class="line">		server.setConnectors(<span class="keyword">new</span> Connector[] &#123; http, https &#125;);</div><div class="line"></div><div class="line">		ServletHandler handler = <span class="keyword">new</span> ServletHandler();</div><div class="line">		handler.addServletWithMapping(HelloServlet.class, <span class="string">"/*"</span>);</div><div class="line">		server.setHandler(handler);</div><div class="line"></div><div class="line">		server.start();</div><div class="line">		server.join();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></div><div class="line">				<span class="keyword">throws</span> ServletException, IOException &#123;</div><div class="line">			response.setContentType(<span class="string">"text/html"</span>);</div><div class="line">			response.setStatus(HttpServletResponse.SC_OK);</div><div class="line">			response.getWriter().println(<span class="string">"&lt;h1&gt;Hello from HelloServlet&lt;/h1&gt;"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们使用JMeter模拟客户端进行访问</p>
<h2 id="JMX"><a href="#JMX" class="headerlink" title="JMX"></a>JMX</h2><p>服务器开启JMX<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.lang.management.ManagementFactory;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.management.remote.JMXServiceURL;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.eclipse.jetty.jmx.ConnectorServer;</div><div class="line"><span class="keyword">import</span> org.eclipse.jetty.jmx.MBeanContainer;</div><div class="line"><span class="keyword">import</span> org.eclipse.jetty.server.Server;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerWithJMX</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// === jetty-jmx.xml ===</span></div><div class="line">		MBeanContainer mbContainer = <span class="keyword">new</span> MBeanContainer(ManagementFactory.getPlatformMBeanServer());</div><div class="line"></div><div class="line">		Server server = <span class="keyword">new</span> Server(<span class="number">8080</span>);</div><div class="line">		server.addBean(mbContainer);</div><div class="line"></div><div class="line">		ConnectorServer jmx = <span class="keyword">new</span> ConnectorServer(</div><div class="line">				<span class="keyword">new</span> JMXServiceURL(<span class="string">"rmi"</span>, <span class="keyword">null</span>, <span class="number">1999</span>, <span class="string">"/jndi/rmi://localhost:1999/jmxrmi"</span>),</div><div class="line">				<span class="string">"org.eclipse.jetty.jmx:name=rmiconnectorserver"</span>);</div><div class="line">		server.addBean(jmx);</div><div class="line"></div><div class="line">		server.start();</div><div class="line">		server.dumpStdErr();</div><div class="line">		server.join();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/07/25/JavaLibrary/Jetty/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/07/25/JavaLibrary/Jetty/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/24/jvm/动态方法调用/" title="动态方法调用" itemprop="url">动态方法调用</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-07-23T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-07-24</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>java7增加了一个invokedynamic的指令，这个命令是为了更好地支持JVM平台上的动态语言和lambda表达式。在给出一个使用示例时，我们先看四个概念</p>
<ul>
<li>方法句柄(<code>MethodHandle</code>)：这个很像一个方法的代理，通过它就可以调用一个方法。（class文件常量池中的CONSTANT_MethodHandle就是方法句柄）</li>
<li>调用点(<code>CallSite</code>)：这个是对方法句柄的一个封装，通过在变调用点上设置不同的方法句柄就可以调用不同的方法</li>
<li>启动方法(<code>BootstrapMethods</code>)：通过启动方法可以获得调用点</li>
<li>方法类型(<code>MethodType</code>)：主要用于设置方法的参数和返回值</li>
</ul>
<p>下面我们看一下方法句柄的使用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.lang.invoke.MethodHandle;</div><div class="line"><span class="keyword">import</span> java.lang.invoke.MethodHandles;</div><div class="line"><span class="keyword">import</span> java.lang.invoke.MethodType;</div><div class="line"><span class="keyword">import</span> java.time.LocalDateTime;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMethodHandler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">// specify method's parameter and return types</span></div><div class="line">        MethodType methodType = MethodType.methodType(<span class="keyword">void</span>.class);</div><div class="line"></div><div class="line">        <span class="comment">// invoke static method</span></div><div class="line">        MethodHandle printHelloWorld = MethodHandles.lookup().findStatic(TestMethodHandler.class, <span class="string">"printHelloWorld"</span>, methodType);</div><div class="line">        printHelloWorld.invoke();</div><div class="line"></div><div class="line">        <span class="comment">// invoke instance method</span></div><div class="line">        TestMethodHandler testMethodHandler = <span class="keyword">new</span> TestMethodHandler();</div><div class="line">        MethodHandle printTime = MethodHandles.lookup().findVirtual(TestMethodHandler.class, <span class="string">"printTime"</span>, methodType).bindTo(testMethodHandler);</div><div class="line">        printTime.invoke();</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printHelloWorld</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Hello World!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printTime</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(LocalDateTime.now().toString());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Hello World!</div><div class="line"><span class="number">2016</span>-<span class="number">07</span>-<span class="number">24</span>T01:<span class="number">05</span>:<span class="number">31.010</span></div></pre></td></tr></table></figure></p>
<p>下面我们依次看一下上面的例子中使用的方法</p>
<ul>
<li><code>findStatic()</code>: 查找一个static方法，然后使用invokestatic进行函数调用 </li>
<li><code>findVirtual()</code>: 查找一个虚方法，使用invokevirtual指令进行函数调用</li>
<li><code>findSpecial()</code>: 查找私有方法或者父类的方法，使用invokespecial指令进行调用 </li>
<li><code>findConstructor()</code>:查找构造器方法 </li>
</ul>
<p>下面我们接着看一下调用点，调用点一共分为3种</p>
<ul>
<li>常量调用点</li>
<li>可变调用点</li>
<li>易变调用点</li>
</ul>
<p>我们接着看一下常量调用点的示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.lang.invoke.*;</div><div class="line"><span class="keyword">import</span> java.time.LocalDateTime;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCallSite</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">// specify method's parameter and return types</span></div><div class="line">        MethodType methodType = MethodType.methodType(<span class="keyword">void</span>.class);</div><div class="line"></div><div class="line">        <span class="comment">// invoke static method</span></div><div class="line">        MethodHandle printHelloWorld = MethodHandles.lookup().findStatic(TestCallSite.class, <span class="string">"printHelloWorld"</span>, methodType);</div><div class="line"></div><div class="line">        CallSite callSite = <span class="keyword">new</span> ConstantCallSite(printHelloWorld);</div><div class="line">        MethodHandle invoker = callSite.dynamicInvoker();</div><div class="line">        invoker.invoke();</div><div class="line"></div><div class="line">        MethodHandle printTime = MethodHandles.lookup().findStatic(TestCallSite.class, <span class="string">"printTime"</span>, methodType);</div><div class="line">        callSite.setTarget(printTime);</div><div class="line">        invoker.invoke();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printHelloWorld</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Hello World!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printTime</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(LocalDateTime.now().toString());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Exception in thread <span class="string">"main"</span> java.lang.UnsupportedOperationException</div><div class="line">    at java.lang.invoke.ConstantCallSite.setTarget(ConstantCallSite.java:<span class="number">106</span>)</div><div class="line">    at TestCallSite.main(TestCallSite.java:<span class="number">18</span>)</div><div class="line">    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</div><div class="line">    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</div><div class="line">    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</div><div class="line">    at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</div><div class="line">    at com.intellij.rt.execution.application.AppMain.main(AppMain.java:<span class="number">147</span>)</div><div class="line">Hello World!</div></pre></td></tr></table></figure></p>
<p>首先我们发现，当再一个常量调用点上进行重置target的时候，产生了一个异常，那么我们使用可变调用点试试呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.lang.invoke.*;</div><div class="line"><span class="keyword">import</span> java.time.LocalDateTime;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCallSite</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">// specify method's parameter and return types</span></div><div class="line">        MethodType methodType = MethodType.methodType(<span class="keyword">void</span>.class);</div><div class="line"></div><div class="line">        <span class="comment">// invoke static method</span></div><div class="line">        MethodHandle printHelloWorld = MethodHandles.lookup().findStatic(TestCallSite.class, <span class="string">"printHelloWorld"</span>, methodType);</div><div class="line"></div><div class="line">        CallSite callSite = <span class="keyword">new</span> MutableCallSite(printHelloWorld);</div><div class="line">        MethodHandle invoker = callSite.dynamicInvoker();</div><div class="line">        invoker.invoke();</div><div class="line"></div><div class="line">        MethodHandle printTime = MethodHandles.lookup().findStatic(TestCallSite.class, <span class="string">"printTime"</span>, methodType);</div><div class="line">        callSite.setTarget(printTime);</div><div class="line">        invoker.invoke();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printHelloWorld</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Hello World!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printTime</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(LocalDateTime.now().toString());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Hello World!</div><div class="line"><span class="number">2016</span>-<span class="number">07</span>-<span class="number">24</span>T01:<span class="number">18</span>:<span class="number">02.905</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/07/24/jvm/动态方法调用/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/07/24/jvm/动态方法调用/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/12/JavaSE/Java8 排序/" title="java8 排序" itemprop="url">java8 排序</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-07-11T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-07-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>在这里我们主要看一下Java8提供的<code>Comparator</code>实现的快捷排序.</p>
<p>首先写一个工具类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CompareObject</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> tall;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> age;</div><div class="line">	<span class="keyword">public</span> String name;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">CompareObject</span><span class="params">(<span class="keyword">int</span> tall, <span class="keyword">int</span> age, String name)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.tall = tall;</div><div class="line">		<span class="keyword">this</span>.age = age;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTall</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> tall;&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> age;&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> name;&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;CompareObject&gt; <span class="title">getList</span><span class="params">()</span> </span>&#123;</div><div class="line">		CompareObject co1 = <span class="keyword">new</span> CompareObject(<span class="number">160</span>, <span class="number">15</span>, <span class="string">"张华"</span>);</div><div class="line">		CompareObject co2 = <span class="keyword">new</span> CompareObject(<span class="number">160</span>, <span class="number">19</span>, <span class="string">"徐来"</span>);</div><div class="line">		CompareObject co3 = <span class="keyword">new</span> CompareObject(<span class="number">160</span>, <span class="number">16</span>, <span class="string">"张德建"</span>);</div><div class="line">		CompareObject co4 = <span class="keyword">new</span> CompareObject(<span class="number">170</span>, <span class="number">18</span>, <span class="string">"李子栋"</span>);</div><div class="line">		CompareObject co5 = <span class="keyword">new</span> CompareObject(<span class="number">170</span>, <span class="number">18</span>, <span class="string">"玛丽凯乐"</span>);</div><div class="line">		CompareObject co6 = <span class="keyword">new</span> CompareObject(<span class="number">180</span>, <span class="number">18</span>, <span class="string">"王义海"</span>);</div><div class="line">		CompareObject co7 = <span class="keyword">new</span> CompareObject(<span class="number">180</span>, <span class="number">19</span>, <span class="string">"赵同利"</span>);</div><div class="line">		CompareObject co8 = <span class="keyword">new</span> CompareObject(<span class="number">180</span>, <span class="number">19</span>, <span class="string">"刘丽"</span>);</div><div class="line">		List&lt;CompareObject&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">		list.add(co1);</div><div class="line">		list.add(co2);</div><div class="line">		list.add(co3);</div><div class="line">		list.add(co4);</div><div class="line">		list.add(co5);</div><div class="line">		list.add(co6);</div><div class="line">		list.add(co7);</div><div class="line">		list.add(co8);</div><div class="line">		<span class="keyword">return</span> list;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们首先看一个最普通的排序<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSort</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		List&lt;CompareObject&gt; list = CompareObject.getList();</div><div class="line">		list.stream().sorted(Comparator.comparing(CompareObject::getTall)</div><div class="line">						.thenComparing(CompareObject::getAge)</div><div class="line">						.thenComparing(CompareObject::getName))</div><div class="line">				.forEach(co -&gt; System.out.println(co.getTall() + <span class="string">" "</span> + co.getAge() + <span class="string">" "</span> + co.getName()));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">160 15 张华</div><div class="line">160 16 张德建</div><div class="line">160 19 徐来</div><div class="line">170 18 李子栋</div><div class="line">170 18 玛丽凯乐</div><div class="line">180 18 王义海</div><div class="line">180 19 刘丽</div><div class="line">180 19 赵同利</div></pre></td></tr></table></figure></p>
<p>下面我们看一下它的倒序<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSort</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		List&lt;CompareObject&gt; list = CompareObject.getList();</div><div class="line">		list.stream().sorted(Comparator.comparing(CompareObject::getTall).reversed()</div><div class="line">						.thenComparing(CompareObject::getAge)</div><div class="line">						.thenComparing(CompareObject::getName))</div><div class="line">				.forEach(co -&gt; System.out.println(co.getTall() + <span class="string">" "</span> + co.getAge() + <span class="string">" "</span> + co.getName()));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">180 18 王义海</div><div class="line">180 19 刘丽</div><div class="line">180 19 赵同利</div><div class="line">170 18 李子栋</div><div class="line">170 18 玛丽凯乐</div><div class="line">160 15 张华</div><div class="line">160 16 张德建</div><div class="line">160 19 徐来</div></pre></td></tr></table></figure></p>
<p>然们将其作用在第二个comparing上<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSort</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		List&lt;CompareObject&gt; list = CompareObject.getList();</div><div class="line">		list.stream().sorted(Comparator.comparing(CompareObject::getTall)</div><div class="line">						.thenComparing(CompareObject::getAge).reversed()</div><div class="line">						.thenComparing(CompareObject::getName))</div><div class="line">				.forEach(co -&gt; System.out.println(co.getTall() + <span class="string">" "</span> + co.getAge() + <span class="string">" "</span> + co.getName()));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">180 19 刘丽</div><div class="line">180 19 赵同利</div><div class="line">180 18 王义海</div><div class="line">170 18 李子栋</div><div class="line">170 18 玛丽凯乐</div><div class="line">160 19 徐来</div><div class="line">160 16 张德建</div><div class="line">160 15 张华</div></pre></td></tr></table></figure></p>
<p>然们将其作用在第三个comparing上<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSort</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		List&lt;CompareObject&gt; list = CompareObject.getList();</div><div class="line">		list.stream().sorted(Comparator.comparing(CompareObject::getTall)</div><div class="line">						.thenComparing(CompareObject::getAge)</div><div class="line">						.thenComparing(CompareObject::getName).reversed())</div><div class="line">				.forEach(co -&gt; System.out.println(co.getTall() + <span class="string">" "</span> + co.getAge() + <span class="string">" "</span> + co.getName()));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">180 19 赵同利</div><div class="line">180 19 刘丽</div><div class="line">180 18 王义海</div><div class="line">170 18 玛丽凯乐</div><div class="line">170 18 李子栋</div><div class="line">160 19 徐来</div><div class="line">160 16 张德建</div><div class="line">160 15 张华</div></pre></td></tr></table></figure></p>
<p>通关上面的现象我们可以得出, 放在后面的<code>reversed()</code>会将前面的都执行倒序操作.</p>
<p>那么如果只想对某个键进行倒序, 其他都正序要如何操作呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClassForName</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, ClassNotFoundException </span>&#123;</div><div class="line">        List&lt;CompareObject&gt; list = CompareObject.getList();</div><div class="line">        list.stream().sorted(Comparator.comparing(CompareObject::getTall)</div><div class="line">                .thenComparing(CompareObject::getAge, Comparator.reverseOrder())</div><div class="line">                .thenComparing(CompareObject::getName))</div><div class="line">                .forEach(co -&gt; System.out.println(co.getTall() + <span class="string">" "</span> + co.getAge() + <span class="string">" "</span> + co.getName()));</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">160 19 徐来</div><div class="line">160 16 张德建</div><div class="line">160 15 张华</div><div class="line">170 18 李子栋</div><div class="line">170 18 玛丽凯乐</div><div class="line">180 19 刘丽</div><div class="line">180 19 赵同利</div><div class="line">180 18 王义海</div></pre></td></tr></table></figure></p>
<p>我们看到年龄已经降序排序了</p>
<h2 id="TimSort异常"><a href="#TimSort异常" class="headerlink" title="TimSort异常"></a>TimSort异常</h2><p>今天项目中跑出了一段排序的异常代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">java.lang.IllegalArgumentException: Comparison method violates its general contract!</div><div class="line">	at java.util.TimSort.mergeLo(TimSort.java:<span class="number">777</span>)</div><div class="line">	at java.util.TimSort.mergeAt(TimSort.java:<span class="number">514</span>)</div><div class="line">	at java.util.TimSort.mergeCollapse(TimSort.java:<span class="number">441</span>)</div><div class="line">	at java.util.TimSort.sort(TimSort.java:<span class="number">245</span>)</div><div class="line">	at java.util.Arrays.sort(Arrays.java:<span class="number">1512</span>)</div><div class="line">	at java.util.ArrayList.sort(ArrayList.java:<span class="number">1454</span>)</div><div class="line">	at java.util.stream.SortedOps$RefSortingSink.end(SortedOps.java:<span class="number">387</span>)</div><div class="line">	at java.util.stream.Sink$ChainedReference.end(Sink.java:<span class="number">258</span>)</div><div class="line">	at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:<span class="number">482</span>)</div><div class="line">	at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:<span class="number">471</span>)</div><div class="line">	at java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:<span class="number">708</span>)</div><div class="line">	at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:<span class="number">234</span>)</div><div class="line">	at java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:<span class="number">499</span>)</div></pre></td></tr></table></figure></p>
<p>通过百度得知, 这是因为JDK升级到7的时候内置的排序算法由归并排序替换成了TimeSort算法. 然后打开JDK API看一下它现在的描述<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">int compare(T o1,</div><div class="line">          T o2)</div><div class="line">Compares its two arguments <span class="keyword">for</span> order. Returns a negative <span class="built_in">integer</span>, zero, or a positive <span class="built_in">integer</span> as the first argument is less than, equal to, or greater than the second.</div><div class="line">In the foregoing description, the notation sgn(expression) designates the mathematical signum <span class="keyword">function</span>, <span class="built_in">which</span> is defined to <span class="built_in">return</span> one of -1, 0, or 1 according to whether the value of expression is negative, zero or positive.</div><div class="line"></div><div class="line">The implementor must ensure that sgn(compare(x, y)) == -sgn(compare(y, x)) <span class="keyword">for</span> all x and y. (This implies that compare(x, y) must throw an exception <span class="keyword">if</span> and only <span class="keyword">if</span> compare(y, x) throws an exception.)</div><div class="line"></div><div class="line">The implementor must also ensure that the relation is transitive: ((compare(x, y)&gt;0) &amp;&amp; (compare(y, z)&gt;0)) implies compare(x, z)&gt;0.</div><div class="line"></div><div class="line">Finally, the implementor must ensure that compare(x, y)==0 implies that sgn(compare(x, z))==sgn(compare(y, z)) <span class="keyword">for</span> all z.</div><div class="line"></div><div class="line">It is generally the <span class="keyword">case</span>, but not strictly required that (compare(x, y)==0) == (x.equals(y)). Generally speaking, any comparator that violates this condition should clearly indicate this fact. The recommended language is <span class="string">"Note: this comparator imposes orderings that are inconsistent with equals."</span></div><div class="line"></div><div class="line">Parameters:</div><div class="line">o1 - the first object to be compared.</div><div class="line">o2 - the second object to be compared.</div><div class="line">Returns:</div><div class="line">a negative <span class="built_in">integer</span>, zero, or a positive <span class="built_in">integer</span> as the first argument is less than, equal to, or greater than the second.</div><div class="line">Throws:</div><div class="line">NullPointerException - <span class="keyword">if</span> an argument is null and this comparator does not permit null arguments</div><div class="line">ClassCastException - <span class="keyword">if</span> the arguments<span class="string">' types prevent them from being compared by this comparator.</span></div></pre></td></tr></table></figure></p>
<p>通过这个描述我们可以看出compare函数是对o1和o2进行对比，如果<code>o1&lt;o2</code>则返回负数, <code>o1==o2</code>返回0, <code>o1&gt;o2</code>返回正数.</p>
<p>在第二段中又描述到，<code>sgn(expression)</code>函数（数学上的符号函数, 取出一个数字的符号）定义了在上文中的正数要返回1，负数要返回-1，0则返回0.</p>
<p>接着说到，如果要实现这个函数则必须保证三点</p>
<ol>
<li>在所有的x和y下，<code>sgn(compare(x, y)) == -sgn(compare(y, x))</code>. 这意味着当且仅当<code>compare(y, x)</code>抛出异常的话,则<code>compare(x, y)</code>也必须抛出一个异常. </li>
<li>还必须要保证传递性, <code>((compare(x, y)&gt;0) &amp;&amp; (compare(y, z)&gt;0))</code>则必须<code>compare(x, z)&gt;0</code>.<br>3.最后还需要保证当<code>compare(x, y)==0</code>时则对于所有的z要<code>sgn(compare(x, z))==sgn(compare(y, z))</code>.</li>
</ol>
<p>最后阐述的是对<code>equals()</code>函数, compare函数并不严格要求要确保<code>(compare(x, y)==0) == (x.equals(y))</code>. </p>
<p>看了这么多, 那么那个bug是怎么发生的呢？</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/07/12/JavaSE/Java8 排序/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/07/12/JavaSE/Java8 排序/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/18/算法/基于递归实现的二叉树/" title="基于递归实现的二叉树" itemprop="url">基于递归实现的二叉树</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-06-18T07:00:00.000Z" itemprop="datePublished"> 发表于 2016-06-18</time>
    
  </p>
</header>
    <div class="article-content">
        
        <figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#-*- coding=utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span>:</span></div><div class="line">    key = <span class="number">0</span></div><div class="line">    value = <span class="number">0</span></div><div class="line">    left = <span class="number">0</span></div><div class="line">    right = <span class="number">0</span></div><div class="line">    size = <span class="number">0</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BST</span>:</span></div><div class="line">    root = Node</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">size</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.size(self.root)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">size</span><span class="params">(self, node)</span>:</span></div><div class="line">        <span class="keyword">return</span> node.size</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, key)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.get(self.root, key)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, node, key)</span>:</span></div><div class="line">        <span class="keyword">if</span> node == <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> key &lt; node.key:</div><div class="line">            <span class="keyword">return</span> self.get(node.left, key)</div><div class="line">        <span class="keyword">elif</span> key &gt; node.key:</div><div class="line">            <span class="keyword">return</span> self.get(node.right, key)</div><div class="line">        <span class="keyword">return</span> node.value</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, key, value)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.put(self.root, key, value)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, node, key, value)</span>:</span></div><div class="line">        <span class="keyword">if</span> key &lt; node.key:</div><div class="line">            self.put(node.left, key, value)</div><div class="line">        <span class="keyword">elif</span> key &gt; node.key:</div><div class="line">            self.put(node.right, key, value)</div><div class="line">        node.value = value</div><div class="line">        node.size = self.size(node.left) + self.size(node.right) + <span class="number">1</span></div><div class="line">        <span class="keyword">return</span> node</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">max</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.max(self.root)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">max</span><span class="params">(self, node)</span>:</span></div><div class="line">        <span class="keyword">if</span> node.right == <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span> node</div><div class="line">        <span class="keyword">return</span> self.max(node.right)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">min</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.min(self.root)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">min</span><span class="params">(self, node)</span>:</span></div><div class="line">        <span class="keyword">if</span> node.left == <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span> node</div><div class="line">        <span class="keyword">return</span> self.min(node.left)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">floor</span><span class="params">(self, key)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.floor(self.root, key)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">floor</span><span class="params">(self, node, key)</span>:</span></div><div class="line">        <span class="keyword">if</span> key == node.key:</div><div class="line">            <span class="keyword">return</span> node</div><div class="line"></div><div class="line">        <span class="keyword">if</span> key &lt; node.key:</div><div class="line">            <span class="keyword">return</span> self.floor(node.left, key)</div><div class="line"></div><div class="line">        <span class="keyword">if</span> node.right == <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span> node</div><div class="line"></div><div class="line">        nextNode = self.floor(node.right, key)</div><div class="line">        <span class="keyword">if</span> nextNode == <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span> node</div><div class="line"></div><div class="line">        <span class="keyword">return</span> nextNode</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ceiling</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">select</span><span class="params">(self, rank)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.select(self.root, rank)</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">select</span><span class="params">(self, node, rank)</span>:</span></div><div class="line">        size = self.size(node.left)</div><div class="line">        <span class="keyword">if</span> size &gt; rank:</div><div class="line">            <span class="keyword">return</span> self.select(node.left, rank)</div><div class="line">        <span class="keyword">elif</span> size &lt; rank:</div><div class="line">            <span class="keyword">return</span> self.select(node.right, rank - size <span class="number">-1</span>)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> rank</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">rank</span><span class="params">(self, key)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.rank(self.root, key)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">rank</span><span class="params">(self, node, key)</span>:</span></div><div class="line">        <span class="keyword">if</span> node.key &lt; key:</div><div class="line">            <span class="keyword">return</span> self.rank(node.left, key)</div><div class="line">        <span class="keyword">elif</span> node.key &gt; key:</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span> + self.size(node.left) + self.rank(node.right, key)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> self.size(node.left)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deleteMin</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.deleteMin(self.root)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deleteMin</span><span class="params">(self, node)</span>:</span></div><div class="line">        <span class="keyword">if</span> node.left == <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span> node.right</div><div class="line">        node.left = self.deleteMin(node.left)</div><div class="line">        node.size = self.size(node.left) + self.size(node.right) + <span class="number">1</span></div><div class="line">        <span class="keyword">return</span> node</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, key)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.delete(self.root, key)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, node, key)</span>:</span></div><div class="line">        <span class="keyword">if</span> key &lt; node.key:</div><div class="line">            node.left = self.delete(node.left, key)</div><div class="line">        <span class="keyword">elif</span> key &gt; node.key:</div><div class="line">            node.right = self.delete(node.right, key)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">if</span> node.right == <span class="keyword">None</span>:</div><div class="line">                <span class="keyword">return</span> node.left</div><div class="line">            <span class="keyword">if</span> node.left == <span class="keyword">None</span>:</div><div class="line">                <span class="keyword">return</span> node.right</div><div class="line"></div><div class="line">            tmpNode = node</div><div class="line">            node = self.min(tmpNode.right)</div><div class="line">            node.right = self.deleteMin(tmpNode.right)</div><div class="line">            node.left = tmpNode.left</div><div class="line">        node.size = self.size(node.left) + self.size(node.right) + <span class="number">1</span></div><div class="line"></div><div class="line">        <span class="keyword">return</span> node</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">keys</span><span class="params">(self)</span>:</span></div><div class="line">        queue = []</div><div class="line">        self.keys(self.root, queue, self.min(), self.max())</div><div class="line">        <span class="keyword">return</span> queue</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">keys</span><span class="params">(self, node, queue, lo, hi)</span>:</span></div><div class="line">        <span class="keyword">if</span> lo &lt; node.key:</div><div class="line">            self.keys(node.left, queue, lo, hi)</div><div class="line">        <span class="keyword">if</span> lo &lt;= node.key &amp; lo &gt;= node.key:</div><div class="line">            queue.append(node.key)</div><div class="line">        <span class="keyword">if</span> lo &gt; node.right:</div><div class="line">            self.keys(node.right, queue, lo, hi)</div></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/算法/">算法</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/06/18/算法/基于递归实现的二叉树/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/06/18/算法/基于递归实现的二叉树/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/15/JavaLibrary/Spring Cache/" title="Spring Cache" itemprop="url">Spring Cache</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-06-14T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-06-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="https://spring.io/guides/" target="_blank" rel="external">官方文档</a>学习</p>
<p>我们先看一段基准测试代码, 我们不开启缓存功能<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> testSpringCache;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.context.ConfigurableApplicationContext;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="meta">@SpringBootApplication</span>(scanBasePackages = <span class="string">"testSpringCache"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheApp</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		ConfigurableApplicationContext app = SpringApplication.run(CacheApp.class, args);</div><div class="line">		PrintService printService = app.getBean(<span class="string">"printService"</span>, PrintService.class);</div><div class="line">		printService.printTime(<span class="number">1</span>);</div><div class="line">		printService.printTime(<span class="number">1</span>);</div><div class="line">		printService.printTime(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintService</span> </span>&#123;</div><div class="line">	<span class="meta">@Autowired</span></div><div class="line">	TimeRepository timeRepository;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printTime</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line">		System.out.println(timeRepository.currentTimeMillis(type));</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeRepository</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">currentTimeMillis</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			TimeUnit.SECONDS.sleep(<span class="number">1</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</div><div class="line">		<span class="keyword">return</span> type + <span class="string">" : "</span> + System.currentTimeMillis();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后的时间输出为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1 : 1465959306110</div><div class="line">1 : 1465959307110</div><div class="line">1 : 1465959308110</div></pre></td></tr></table></figure></p>
<p>我们看到是每隔一秒输出的，然后我们加上Cache功能<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> testSpringCache;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.cache.annotation.Cacheable;</div><div class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</div><div class="line"><span class="keyword">import</span> org.springframework.context.ConfigurableApplicationContext;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="meta">@SpringBootApplication</span>(scanBasePackages = <span class="string">"testSpringCache"</span>)</div><div class="line"><span class="meta">@EnableCaching</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheApp</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		ConfigurableApplicationContext app = SpringApplication.run(CacheApp.class, args);</div><div class="line">		PrintService printService = app.getBean(<span class="string">"printService"</span>, PrintService.class);</div><div class="line">		printService.printTime(<span class="number">1</span>);</div><div class="line">		printService.printTime(<span class="number">1</span>);</div><div class="line">		printService.printTime(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintService</span> </span>&#123;</div><div class="line">	<span class="meta">@Autowired</span></div><div class="line">	TimeRepository timeRepository;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printTime</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line">		System.out.println(timeRepository.currentTimeMillis(type));</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeRepository</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Cacheable</span>(<span class="string">"currentTimeMillis"</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">currentTimeMillis</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			TimeUnit.SECONDS.sleep(<span class="number">1</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</div><div class="line">		<span class="keyword">return</span> type + <span class="string">" : "</span> + System.currentTimeMillis();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后再看一下时间输出<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1 : 1465959376657</div><div class="line">1 : 1465959376657</div><div class="line">1 : 1465959376657</div></pre></td></tr></table></figure></p>
<p>我们看到时间立马就输出了,也就是说下面俩次的请求其实是请求的是第一次的缓存结果，</p>
<p>也许你注意到了，我在代码里添加了一个变量称为type, 那么我为什么要添加它呢？其实这是为了测试是否取缓存的前提是请求的参数是否相同，也就是咱们的方法参数是否相同, 刚才我使用的都是1,1,1. 下面我修改为1,2,2看一下结果<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1 : 1465959531983</div><div class="line">2 : 1465959532983</div><div class="line">2 : 1465959532983</div></pre></td></tr></table></figure></p>
<p>好了结果很显而易见了， 当我们修改了参数之后，spring就不会再取缓存结果而是又重新获取了一遍</p>
<p>最后添加所需要的Maven依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gs-scheduling-tasks<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Spring/">Spring</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/06/15/JavaLibrary/Spring Cache/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/06/15/JavaLibrary/Spring Cache/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/14/JavaLibrary/ReflectASM 性能测试/" title="ReflectASM 性能测试" itemprop="url">ReflectASM 性能测试</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-06-13T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-06-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我们采用JMH测试ReflectASM 官网给出的几个示例的吞吐量.</p>
<p>我们的测试代码为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> testASM;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.esotericsoftware.reflectasm.ConstructorAccess;</div><div class="line"><span class="keyword">import</span> com.esotericsoftware.reflectasm.FieldAccess;</div><div class="line"><span class="keyword">import</span> com.esotericsoftware.reflectasm.MethodAccess;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.annotations.*;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.Runner;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.RunnerException;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.options.Options;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.options.OptionsBuilder;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="meta">@State</span>(Scope.Thread)</div><div class="line"><span class="meta">@BenchmarkMode</span>(Mode.AverageTime)</div><div class="line"><span class="meta">@OutputTimeUnit</span>(TimeUnit.NANOSECONDS)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestRelectASM</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RunnerException </span>&#123;</div><div class="line">        Options opt = <span class="keyword">new</span> OptionsBuilder()</div><div class="line">                .include(TestRelectASM.class.getSimpleName())</div><div class="line">                .warmupIterations(<span class="number">5</span>)</div><div class="line">                .measurementIterations(<span class="number">5</span>)</div><div class="line">                .forks(<span class="number">1</span>)</div><div class="line">                .build();</div><div class="line"></div><div class="line">        <span class="keyword">new</span> Runner(opt).run();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@BenchmarkMode</span>(Mode.Throughput)</div><div class="line">    <span class="meta">@OutputTimeUnit</span>(TimeUnit.SECONDS)</div><div class="line">    <span class="meta">@Benchmark</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">measureMethodAccess</span><span class="params">()</span> </span>&#123;</div><div class="line">        SomeClass someObject = <span class="keyword">new</span> SomeClass();</div><div class="line">        MethodAccess access = MethodAccess.get(SomeClass.class);</div><div class="line">        access.invoke(someObject, <span class="string">"setName"</span>, <span class="string">"Awesome McLovin"</span>);</div><div class="line">        String name = (String)access.invoke(someObject, <span class="string">"getName"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@BenchmarkMode</span>(Mode.Throughput)</div><div class="line">    <span class="meta">@OutputTimeUnit</span>(TimeUnit.SECONDS)</div><div class="line">    <span class="meta">@Benchmark</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">measureFieldAccess</span><span class="params">()</span> </span>&#123;</div><div class="line">        SomeClass someObject = <span class="keyword">new</span> SomeClass();</div><div class="line">        FieldAccess access = FieldAccess.get(SomeClass.class);</div><div class="line">        access.set(someObject, <span class="string">"age"</span>, <span class="number">18</span>);</div><div class="line">        Integer age = (Integer)access.get(someObject, <span class="string">"age"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@BenchmarkMode</span>(Mode.Throughput)</div><div class="line">    <span class="meta">@OutputTimeUnit</span>(TimeUnit.SECONDS)</div><div class="line">    <span class="meta">@Benchmark</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">measureConstructorAccess</span><span class="params">()</span> </span>&#123;</div><div class="line">        ConstructorAccess&lt;SomeClass&gt; access = ConstructorAccess.get(SomeClass.class);</div><div class="line">        SomeClass someObject = access.newInstance();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeClass</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>测试结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Warmup: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Measurement: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Timeout: 10 min per iteration</span></div><div class="line"><span class="comment"># Threads: 1 thread, will synchronize iterations</span></div><div class="line"><span class="comment"># Benchmark mode: Throughput, ops/time</span></div><div class="line"><span class="comment"># Benchmark: testASM.TestRelectASM.measureConstructorAccess</span></div><div class="line"></div><div class="line"><span class="comment"># Run progress: 0.00% complete, ETA 00:00:30</span></div><div class="line"><span class="comment"># Fork: 1 of 1</span></div><div class="line"><span class="comment"># Warmup Iteration   1: 146112.555 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   2: 399173.011 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   3: 452136.048 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   4: 450102.353 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   5: 446112.781 ops/s</span></div><div class="line">Iteration   1: 454817.511 ops/s</div><div class="line">Iteration   2: 444272.121 ops/s</div><div class="line">Iteration   3: 454354.750 ops/s</div><div class="line">Iteration   4: 449983.056 ops/s</div><div class="line">Iteration   5: 446149.202 ops/s</div><div class="line"></div><div class="line"></div><div class="line">Result <span class="string">"measureConstructorAccess"</span>:</div><div class="line">  449915.328 ±(99.9%) 18242.255 ops/s [Average]</div><div class="line">  (min, avg, max) = (444272.121, 449915.328, 454817.511), stdev = 4737.456</div><div class="line">  CI (99.9%): [431673.074, 468157.583] (assumes normal distribution)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Warmup: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Measurement: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Timeout: 10 min per iteration</span></div><div class="line"><span class="comment"># Threads: 1 thread, will synchronize iterations</span></div><div class="line"><span class="comment"># Benchmark mode: Throughput, ops/time</span></div><div class="line"><span class="comment"># Benchmark: testASM.TestRelectASM.measureFieldAccess</span></div><div class="line"></div><div class="line"><span class="comment"># Run progress: 33.33% complete, ETA 00:00:21</span></div><div class="line"><span class="comment"># Fork: 1 of 1</span></div><div class="line"><span class="comment"># Warmup Iteration   1: 483272.367 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   2: 638769.340 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   3: 643087.589 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   4: 654921.986 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   5: 646076.594 ops/s</span></div><div class="line">Iteration   1: 657034.718 ops/s</div><div class="line">Iteration   2: 651774.971 ops/s</div><div class="line">Iteration   3: 648118.383 ops/s</div><div class="line">Iteration   4: 647813.662 ops/s</div><div class="line">Iteration   5: 654691.279 ops/s</div><div class="line"></div><div class="line"></div><div class="line">Result <span class="string">"measureFieldAccess"</span>:</div><div class="line">  651886.603 ±(99.9%) 15542.738 ops/s [Average]</div><div class="line">  (min, avg, max) = (647813.662, 651886.603, 657034.718), stdev = 4036.400</div><div class="line">  CI (99.9%): [636343.865, 667429.341] (assumes normal distribution)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Warmup: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Measurement: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Timeout: 10 min per iteration</span></div><div class="line"><span class="comment"># Threads: 1 thread, will synchronize iterations</span></div><div class="line"><span class="comment"># Benchmark mode: Throughput, ops/time</span></div><div class="line"><span class="comment"># Benchmark: testASM.TestRelectASM.measureMethodAccess</span></div><div class="line"></div><div class="line"><span class="comment"># Run progress: 66.67% complete, ETA 00:00:10</span></div><div class="line"><span class="comment"># Fork: 1 of 1</span></div><div class="line"><span class="comment"># Warmup Iteration   1: 432894.585 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   2: 621680.095 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   3: 618783.228 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   4: 624738.576 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   5: 611762.568 ops/s</span></div><div class="line">Iteration   1: 625825.844 ops/s</div><div class="line">Iteration   2: 621933.920 ops/s</div><div class="line">Iteration   3: 644088.779 ops/s</div><div class="line">Iteration   4: 644729.889 ops/s</div><div class="line">Iteration   5: 615383.465 ops/s</div><div class="line"></div><div class="line"></div><div class="line">Result <span class="string">"measureMethodAccess"</span>:</div><div class="line">  630392.379 ±(99.9%) 51331.476 ops/s [Average]</div><div class="line">  (min, avg, max) = (615383.465, 630392.379, 644729.889), stdev = 13330.621</div><div class="line">  CI (99.9%): [579060.904, 681723.855] (assumes normal distribution)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Run complete. Total time: 00:00:31</span></div><div class="line"></div><div class="line">Benchmark                                        Mode  Cnt       Score       Error  Units</div><div class="line"><span class="built_in">test</span>ASM.TestRelectASM.measureConstructorAccess  thrpt    5  449915.328 ± 18242.255  ops/s</div><div class="line"><span class="built_in">test</span>ASM.TestRelectASM.measureFieldAccess        thrpt    5  651886.603 ± 15542.738  ops/s</div><div class="line"><span class="built_in">test</span>ASM.TestRelectASM.measureMethodAccess       thrpt    5  630392.379 ± 51331.476  ops/s</div></pre></td></tr></table></figure></p>
<p>接下来我们看一下JDK原生反射的性能<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> testASM;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.annotations.*;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.Runner;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.RunnerException;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.options.Options;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.options.OptionsBuilder;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Field;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="meta">@State</span>(Scope.Thread)</div><div class="line"><span class="meta">@BenchmarkMode</span>(Mode.AverageTime)</div><div class="line"><span class="meta">@OutputTimeUnit</span>(TimeUnit.NANOSECONDS)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJDKReflect</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RunnerException </span>&#123;</div><div class="line">        Options opt = <span class="keyword">new</span> OptionsBuilder()</div><div class="line">                .include(TestRelectASM.class.getSimpleName())</div><div class="line">                .warmupIterations(<span class="number">5</span>)</div><div class="line">                .measurementIterations(<span class="number">5</span>)</div><div class="line">                .forks(<span class="number">1</span>)</div><div class="line">                .build();</div><div class="line"></div><div class="line">        <span class="keyword">new</span> Runner(opt).run();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@BenchmarkMode</span>(Mode.Throughput)</div><div class="line">    <span class="meta">@OutputTimeUnit</span>(TimeUnit.SECONDS)</div><div class="line">    <span class="meta">@Benchmark</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">measureMethodAccess</span><span class="params">()</span> </span>&#123;</div><div class="line">        SomeClass someObject = <span class="keyword">new</span> SomeClass();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Method setNameMethod = SomeClass.class.getMethod(<span class="string">"setName"</span>);</div><div class="line">            setNameMethod.invoke(someObject, <span class="string">"Awesome McLovin"</span>);</div><div class="line">            Method getNameMethod = SomeClass.class.getMethod(<span class="string">"getName"</span>);</div><div class="line">            String name = (String)getNameMethod.invoke(someObject);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@BenchmarkMode</span>(Mode.Throughput)</div><div class="line">    <span class="meta">@OutputTimeUnit</span>(TimeUnit.SECONDS)</div><div class="line">    <span class="meta">@Benchmark</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">measureFieldAccess</span><span class="params">()</span> </span>&#123;</div><div class="line">        SomeClass someObject = <span class="keyword">new</span> SomeClass();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Field ageField = SomeClass.class.getField(<span class="string">"age"</span>);</div><div class="line">            ageField.set(someObject, <span class="number">18</span>);</div><div class="line">            Integer age = (Integer)ageField.get(someObject);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@BenchmarkMode</span>(Mode.Throughput)</div><div class="line">    <span class="meta">@OutputTimeUnit</span>(TimeUnit.SECONDS)</div><div class="line">    <span class="meta">@Benchmark</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">measureConstructorAccess</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Constructor&lt;SomeClass&gt; con = SomeClass.class.getConstructor();</div><div class="line">            SomeClass newInstance = con.newInstance();</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>测试结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Warmup: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Measurement: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Timeout: 10 min per iteration</span></div><div class="line"><span class="comment"># Threads: 1 thread, will synchronize iterations</span></div><div class="line"><span class="comment"># Benchmark mode: Throughput, ops/time</span></div><div class="line"><span class="comment"># Benchmark: testASM.TestRelectASM.measureConstructorAccess</span></div><div class="line"></div><div class="line"><span class="comment"># Run progress: 0.00% complete, ETA 00:00:30</span></div><div class="line"><span class="comment"># Fork: 1 of 1</span></div><div class="line"><span class="comment"># Warmup Iteration   1: 272071.065 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   2: 589448.060 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   3: 583306.327 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   4: 559099.151 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   5: 546514.262 ops/s</span></div><div class="line">Iteration   1: 603711.245 ops/s</div><div class="line">Iteration   2: 582218.187 ops/s</div><div class="line">Iteration   3: 561487.624 ops/s</div><div class="line">Iteration   4: 582646.831 ops/s</div><div class="line">Iteration   5: 612259.454 ops/s</div><div class="line"></div><div class="line"></div><div class="line">Result <span class="string">"measureConstructorAccess"</span>:</div><div class="line">  588464.668 ±(99.9%) 76995.468 ops/s [Average]</div><div class="line">  (min, avg, max) = (561487.624, 588464.668, 612259.454), stdev = 19995.478</div><div class="line">  CI (99.9%): [511469.200, 665460.136] (assumes normal distribution)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Warmup: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Measurement: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Timeout: 10 min per iteration</span></div><div class="line"><span class="comment"># Threads: 1 thread, will synchronize iterations</span></div><div class="line"><span class="comment"># Benchmark mode: Throughput, ops/time</span></div><div class="line"><span class="comment"># Benchmark: testASM.TestRelectASM.measureFieldAccess</span></div><div class="line"></div><div class="line"><span class="comment"># Run progress: 33.33% complete, ETA 00:00:21</span></div><div class="line"><span class="comment"># Fork: 1 of 1</span></div><div class="line"><span class="comment"># Warmup Iteration   1: 407799.239 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   2: 599419.421 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   3: 624838.592 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   4: 636293.822 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   5: 623880.225 ops/s</span></div><div class="line">Iteration   1: 600361.584 ops/s</div><div class="line">Iteration   2: 642029.016 ops/s</div><div class="line">Iteration   3: 613483.428 ops/s</div><div class="line">Iteration   4: 645823.284 ops/s</div><div class="line">Iteration   5: 632346.098 ops/s</div><div class="line"></div><div class="line"></div><div class="line">Result <span class="string">"measureFieldAccess"</span>:</div><div class="line">  626808.682 ±(99.9%) 74589.468 ops/s [Average]</div><div class="line">  (min, avg, max) = (600361.584, 626808.682, 645823.284), stdev = 19370.648</div><div class="line">  CI (99.9%): [552219.214, 701398.150] (assumes normal distribution)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Warmup: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Measurement: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Timeout: 10 min per iteration</span></div><div class="line"><span class="comment"># Threads: 1 thread, will synchronize iterations</span></div><div class="line"><span class="comment"># Benchmark mode: Throughput, ops/time</span></div><div class="line"><span class="comment"># Benchmark: testASM.TestRelectASM.measureMethodAccess</span></div><div class="line"></div><div class="line"><span class="comment"># Run progress: 66.67% complete, ETA 00:00:10</span></div><div class="line"><span class="comment"># Fork: 1 of 1</span></div><div class="line"><span class="comment"># Warmup Iteration   1: 397028.204 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   2: 602683.986 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   3: 576226.708 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   4: 602674.109 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   5: 591631.635 ops/s</span></div><div class="line">Iteration   1: 607990.169 ops/s</div><div class="line">Iteration   2: 586306.494 ops/s</div><div class="line">Iteration   3: 606049.775 ops/s</div><div class="line">Iteration   4: 583441.620 ops/s</div><div class="line">Iteration   5: 577363.527 ops/s</div><div class="line"></div><div class="line"></div><div class="line">Result <span class="string">"measureMethodAccess"</span>:</div><div class="line">  592230.317 ±(99.9%) 53519.265 ops/s [Average]</div><div class="line">  (min, avg, max) = (577363.527, 592230.317, 607990.169), stdev = 13898.783</div><div class="line">  CI (99.9%): [538711.052, 645749.582] (assumes normal distribution)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Run complete. Total time: 00:00:31</span></div><div class="line"></div><div class="line">Benchmark                                        Mode  Cnt       Score       Error  Units</div><div class="line"><span class="built_in">test</span>ASM.TestRelectASM.measureConstructorAccess  thrpt    5  588464.668 ± 76995.468  ops/s</div><div class="line"><span class="built_in">test</span>ASM.TestRelectASM.measureFieldAccess        thrpt    5  626808.682 ± 74589.468  ops/s</div><div class="line"><span class="built_in">test</span>ASM.TestRelectASM.measureMethodAccess       thrpt    5  592230.317 ± 53519.265  ops/s</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/06/14/JavaLibrary/ReflectASM 性能测试/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/06/14/JavaLibrary/ReflectASM 性能测试/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="yu66" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/JVM/" title="JVM">JVM<sup>13</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java/" title="Java">Java<sup>24</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java-Library/" title="Java Library">Java Library<sup>34</sup></a></li>
		  
		
		  
			<li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/NoSql/" title="NoSql">NoSql<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/数据库/" title="数据库">数据库<sup>7</sup></a></li>
		  
		
		  
			<li><a href="/categories/杂记/" title="杂记">杂记<sup>18</sup></a></li>
		  
		
		  
			<li><a href="/categories/算法/" title="算法">算法<sup>11</sup></a></li>
		  
		
		  
			<li><a href="/categories/编程语言/" title="编程语言">编程语言<sup>20</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Netty/" title="Netty">Netty<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/asm/" title="asm">asm<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Spring/" title="Spring">Spring<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Guice/" title="Guice">Guice<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://vertx.yu66.wang/" target="_blank" title="vertx3">vertx3</a>
            
          </li>
        
    </ul>
</div>

  

<div class="doubanshow">
<p class="asidetitle">豆瓣秀</p>
<div>
<script type="text/javascript" src="http://www.douban.com/service/badge/xxxyy/?show=collection&amp;n=12&amp;columns=3&amp;hidelogo=yes&amp;hideself=yes&amp;cat=book|movie" ></script>
</div>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=3253370782&verifier=e9ca895b&dpc=1"></iframe>
</div>


  

<div class="lofter">
<p class="asidetitle">Lofter</p>

 <iframe width="100%" height="39" class="share_self"  frameborder="0" scrolling="no" src="http://ming15.lofter.com/"></iframe>
</div>




</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 博客,我选择重构 <br/>
			重构使事情变得更美,更加正确</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/3253370782" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/yu66" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		<a href="https://www.douban.com/people/xxxyy" target="_blank" class="icon-douban" title="豆瓣"></a>
		
		
		<a href="http://www.zhihu.com/people/ming15" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="王玉">王玉</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"wanggnim"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F9e8fca440159a2125668804e46682db4' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
