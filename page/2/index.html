
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>·</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="王玉">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="·">
<meta property="og:url" content="http://www.yu66.wang/page/2/index.html">
<meta property="og:site_name" content="·">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="·">

    
    <link rel="alternative" href="/atom.xml" title="·" type="application/atom+xml">
    
    
    
    <link rel="apple-touch-icon" href="/img/author.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/author.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="·">·</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
						<form class="search" action="http://zhannei.baidu.com/cse/search" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= 17728547076946147000 ><input type="text" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/14/JavaSE/ClassFinder/" title="ClassFinder" itemprop="url">ClassFinder</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-06-13T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-06-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.net.JarURLConnection;</div><div class="line"><span class="keyword">import</span> java.net.MalformedURLException;</div><div class="line"><span class="keyword">import</span> java.net.URL;</div><div class="line"><span class="keyword">import</span> java.net.URLDecoder;</div><div class="line"><span class="keyword">import</span> java.util.*;</div><div class="line"><span class="keyword">import</span> java.util.jar.JarEntry;</div><div class="line"><span class="keyword">import</span> java.util.jar.JarFile;</div><div class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassFinder</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = Logger.getLogger(ClassFinder.class);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Class&gt; <span class="title">findClasses</span><span class="params">(String packageName, String suffix)</span> </span>&#123;</div><div class="line">        Collection&lt;String&gt; packageSet = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">        packageSet.add(packageName);</div><div class="line"></div><div class="line">        Collection&lt;String&gt; suffixSet = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">        suffixSet.add(suffix);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> findClasses(packageSet, suffixSet);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Class&gt; <span class="title">findClasses</span><span class="params">(Collection&lt;String&gt; packageNameColl, Collection&lt;String&gt; suffixColl)</span> </span>&#123;</div><div class="line">        logger.trace(<span class="string">"find classes from:"</span> + packageNameColl + <span class="string">" suffixes:"</span> + suffixColl);</div><div class="line">        List&lt;String&gt; classNameList = getAllClasseNames();</div><div class="line">        classNameList = filter(classNameList, packageNameColl, suffixColl);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> loadClasses(classNameList);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;Class&gt; <span class="title">loadClasses</span><span class="params">(List&lt;String&gt; classNames)</span> </span>&#123;</div><div class="line">        List&lt;Class&gt; retList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (String className : classNames) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Class clazz = Thread.currentThread().getContextClassLoader().loadClass(className);</div><div class="line">                retList.add(clazz);</div><div class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">                logger.error(<span class="string">"[can't load class:"</span> + className + <span class="string">"]"</span>, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> retList;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">filter</span><span class="params">(List&lt;String&gt; classNameList, Collection&lt;String&gt; packageNameColl, Collection&lt;String&gt; suffixColl)</span> </span>&#123;</div><div class="line">        List&lt;String&gt; retList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (String className : classNameList) &#123;</div><div class="line">            <span class="keyword">if</span> (isFit(className, packageNameColl, suffixColl))</div><div class="line">                retList.add(className);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> retList;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Collection&lt;URL&gt; <span class="title">getClassPathUrls</span><span class="params">()</span> </span>&#123;</div><div class="line">        String pathSeparator = System.getProperty(<span class="string">"path.separator"</span>, <span class="string">":"</span>);</div><div class="line">        String classpath = System.getProperty(<span class="string">"java.class.path"</span>, <span class="string">"."</span>);</div><div class="line">        String[] pathArray = classpath.split(pathSeparator);</div><div class="line">        Collection&lt;URL&gt; urls = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (String path : pathArray) &#123;</div><div class="line">            <span class="keyword">if</span> (path.endsWith(<span class="string">".jar"</span>)) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    URL jarUrl = <span class="keyword">new</span> URL(<span class="string">"jar:file:"</span> + path + <span class="string">"!/"</span>);</div><div class="line">                    urls.add(jarUrl);</div><div class="line">                &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</div><div class="line">                    logger.error(<span class="string">"[jarPath:"</span> + path + <span class="string">"]"</span>, e);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    URL fileUrl = <span class="keyword">new</span> URL(<span class="string">"file://"</span> + path);</div><div class="line">                    urls.add(fileUrl);</div><div class="line">                &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</div><div class="line">                    logger.error(<span class="string">"[path:"</span> + path + <span class="string">"]"</span>, e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> urls;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getAllClasseNames</span><span class="params">()</span> </span>&#123;</div><div class="line">        Collection&lt;URL&gt; urls = getClassPathUrls();</div><div class="line">        List&lt;String&gt; classNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (URL location : urls) &#123;</div><div class="line">            logger.trace(<span class="string">"find classes from:"</span> + location);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">if</span> (<span class="string">"jar"</span>.equals(location.getProtocol())) &#123;</div><div class="line">                    classNames.addAll(jar(location));</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"file"</span>.equals(location.getProtocol())) &#123;</div><div class="line">                    classNames.addAll(file(location));</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                logger.error(e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> classNames;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isFit</span><span class="params">(String className, Collection&lt;String&gt; packageNameColl, Collection&lt;String&gt; suffixColl)</span> </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> packageFlag = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">for</span> (String packageName : packageNameColl) &#123;</div><div class="line">            <span class="keyword">if</span> (className.startsWith(packageName)) &#123;</div><div class="line">                packageFlag = <span class="keyword">true</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!packageFlag)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> suffixFlag = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">for</span> (String suffix : suffixColl) &#123;</div><div class="line">            <span class="keyword">if</span> (className.endsWith(suffix)) &#123;</div><div class="line">                suffixFlag = <span class="keyword">true</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> suffixFlag;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">jar</span><span class="params">(URL location)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        List&lt;String&gt; classNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        JarURLConnection conn = (JarURLConnection) location.openConnection();</div><div class="line">        JarFile jarfile = conn.getJarFile();</div><div class="line"></div><div class="line">        Enumeration&lt;JarEntry&gt; jarEntrys = jarfile.entries();</div><div class="line">        <span class="keyword">while</span> (jarEntrys.hasMoreElements()) &#123;</div><div class="line">            JarEntry jarEntry = jarEntrys.nextElement();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (jarEntry.isDirectory() || !jarEntry.getName().endsWith(<span class="string">".class"</span>)) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            String className = jarEntry.getName();</div><div class="line">            className = className.replaceFirst(<span class="string">".class$"</span>, <span class="string">""</span>);</div><div class="line">            className = className.replace(<span class="string">'/'</span>, <span class="string">'.'</span>);</div><div class="line">            classNames.add(className);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> classNames;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">file</span><span class="params">(URL location)</span> </span>&#123;</div><div class="line">        List&lt;String&gt; classNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        File dir = <span class="keyword">new</span> File(URLDecoder.decode(location.getPath()));</div><div class="line">        <span class="keyword">if</span> (<span class="string">"META-INF"</span>.equals(dir.getName())) &#123;</div><div class="line">            dir = dir.getParentFile(); <span class="comment">// Scrape "META-INF" off</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (dir.isDirectory()) &#123;</div><div class="line">            scanDir(dir, classNames, <span class="string">""</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classNames;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scanDir</span><span class="params">(File dir, List&lt;String&gt; classNames, String packageName)</span> </span>&#123;</div><div class="line">        logger.trace(<span class="string">"scan dir: "</span> + dir);</div><div class="line">        File[] files = dir.listFiles();</div><div class="line">        <span class="keyword">for</span> (File file : files) &#123;</div><div class="line">            <span class="keyword">if</span> (file.isDirectory()) &#123;</div><div class="line">                scanDir(file, classNames, packageName + file.getName() + <span class="string">"."</span>);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (file.getName().endsWith(<span class="string">".class"</span>)) &#123;</div><div class="line">                String name = file.getName();</div><div class="line">                name = name.replaceFirst(<span class="string">".class$"</span>, <span class="string">""</span>);</div><div class="line">                classNames.add(packageName + name);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/06/14/JavaSE/ClassFinder/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/06/14/JavaSE/ClassFinder/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/14/JavaLibrary/ReflectASM 性能测试/" title="ReflectASM 性能测试" itemprop="url">ReflectASM 性能测试</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-06-13T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-06-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我们采用JMH测试ReflectASM 官网给出的几个示例的吞吐量.</p>
<p>我们的测试代码为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> testASM;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.esotericsoftware.reflectasm.ConstructorAccess;</div><div class="line"><span class="keyword">import</span> com.esotericsoftware.reflectasm.FieldAccess;</div><div class="line"><span class="keyword">import</span> com.esotericsoftware.reflectasm.MethodAccess;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.annotations.*;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.Runner;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.RunnerException;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.options.Options;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.options.OptionsBuilder;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="meta">@State</span>(Scope.Thread)</div><div class="line"><span class="meta">@BenchmarkMode</span>(Mode.AverageTime)</div><div class="line"><span class="meta">@OutputTimeUnit</span>(TimeUnit.NANOSECONDS)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestRelectASM</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RunnerException </span>&#123;</div><div class="line">        Options opt = <span class="keyword">new</span> OptionsBuilder()</div><div class="line">                .include(TestRelectASM.class.getSimpleName())</div><div class="line">                .warmupIterations(<span class="number">5</span>)</div><div class="line">                .measurementIterations(<span class="number">5</span>)</div><div class="line">                .forks(<span class="number">1</span>)</div><div class="line">                .build();</div><div class="line"></div><div class="line">        <span class="keyword">new</span> Runner(opt).run();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@BenchmarkMode</span>(Mode.Throughput)</div><div class="line">    <span class="meta">@OutputTimeUnit</span>(TimeUnit.SECONDS)</div><div class="line">    <span class="meta">@Benchmark</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">measureMethodAccess</span><span class="params">()</span> </span>&#123;</div><div class="line">        SomeClass someObject = <span class="keyword">new</span> SomeClass();</div><div class="line">        MethodAccess access = MethodAccess.get(SomeClass.class);</div><div class="line">        access.invoke(someObject, <span class="string">"setName"</span>, <span class="string">"Awesome McLovin"</span>);</div><div class="line">        String name = (String)access.invoke(someObject, <span class="string">"getName"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@BenchmarkMode</span>(Mode.Throughput)</div><div class="line">    <span class="meta">@OutputTimeUnit</span>(TimeUnit.SECONDS)</div><div class="line">    <span class="meta">@Benchmark</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">measureFieldAccess</span><span class="params">()</span> </span>&#123;</div><div class="line">        SomeClass someObject = <span class="keyword">new</span> SomeClass();</div><div class="line">        FieldAccess access = FieldAccess.get(SomeClass.class);</div><div class="line">        access.set(someObject, <span class="string">"age"</span>, <span class="number">18</span>);</div><div class="line">        Integer age = (Integer)access.get(someObject, <span class="string">"age"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@BenchmarkMode</span>(Mode.Throughput)</div><div class="line">    <span class="meta">@OutputTimeUnit</span>(TimeUnit.SECONDS)</div><div class="line">    <span class="meta">@Benchmark</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">measureConstructorAccess</span><span class="params">()</span> </span>&#123;</div><div class="line">        ConstructorAccess&lt;SomeClass&gt; access = ConstructorAccess.get(SomeClass.class);</div><div class="line">        SomeClass someObject = access.newInstance();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeClass</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>测试结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Warmup: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Measurement: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Timeout: 10 min per iteration</span></div><div class="line"><span class="comment"># Threads: 1 thread, will synchronize iterations</span></div><div class="line"><span class="comment"># Benchmark mode: Throughput, ops/time</span></div><div class="line"><span class="comment"># Benchmark: testASM.TestRelectASM.measureConstructorAccess</span></div><div class="line"></div><div class="line"><span class="comment"># Run progress: 0.00% complete, ETA 00:00:30</span></div><div class="line"><span class="comment"># Fork: 1 of 1</span></div><div class="line"><span class="comment"># Warmup Iteration   1: 146112.555 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   2: 399173.011 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   3: 452136.048 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   4: 450102.353 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   5: 446112.781 ops/s</span></div><div class="line">Iteration   1: 454817.511 ops/s</div><div class="line">Iteration   2: 444272.121 ops/s</div><div class="line">Iteration   3: 454354.750 ops/s</div><div class="line">Iteration   4: 449983.056 ops/s</div><div class="line">Iteration   5: 446149.202 ops/s</div><div class="line"></div><div class="line"></div><div class="line">Result <span class="string">"measureConstructorAccess"</span>:</div><div class="line">  449915.328 ±(99.9%) 18242.255 ops/s [Average]</div><div class="line">  (min, avg, max) = (444272.121, 449915.328, 454817.511), stdev = 4737.456</div><div class="line">  CI (99.9%): [431673.074, 468157.583] (assumes normal distribution)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Warmup: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Measurement: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Timeout: 10 min per iteration</span></div><div class="line"><span class="comment"># Threads: 1 thread, will synchronize iterations</span></div><div class="line"><span class="comment"># Benchmark mode: Throughput, ops/time</span></div><div class="line"><span class="comment"># Benchmark: testASM.TestRelectASM.measureFieldAccess</span></div><div class="line"></div><div class="line"><span class="comment"># Run progress: 33.33% complete, ETA 00:00:21</span></div><div class="line"><span class="comment"># Fork: 1 of 1</span></div><div class="line"><span class="comment"># Warmup Iteration   1: 483272.367 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   2: 638769.340 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   3: 643087.589 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   4: 654921.986 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   5: 646076.594 ops/s</span></div><div class="line">Iteration   1: 657034.718 ops/s</div><div class="line">Iteration   2: 651774.971 ops/s</div><div class="line">Iteration   3: 648118.383 ops/s</div><div class="line">Iteration   4: 647813.662 ops/s</div><div class="line">Iteration   5: 654691.279 ops/s</div><div class="line"></div><div class="line"></div><div class="line">Result <span class="string">"measureFieldAccess"</span>:</div><div class="line">  651886.603 ±(99.9%) 15542.738 ops/s [Average]</div><div class="line">  (min, avg, max) = (647813.662, 651886.603, 657034.718), stdev = 4036.400</div><div class="line">  CI (99.9%): [636343.865, 667429.341] (assumes normal distribution)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Warmup: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Measurement: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Timeout: 10 min per iteration</span></div><div class="line"><span class="comment"># Threads: 1 thread, will synchronize iterations</span></div><div class="line"><span class="comment"># Benchmark mode: Throughput, ops/time</span></div><div class="line"><span class="comment"># Benchmark: testASM.TestRelectASM.measureMethodAccess</span></div><div class="line"></div><div class="line"><span class="comment"># Run progress: 66.67% complete, ETA 00:00:10</span></div><div class="line"><span class="comment"># Fork: 1 of 1</span></div><div class="line"><span class="comment"># Warmup Iteration   1: 432894.585 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   2: 621680.095 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   3: 618783.228 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   4: 624738.576 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   5: 611762.568 ops/s</span></div><div class="line">Iteration   1: 625825.844 ops/s</div><div class="line">Iteration   2: 621933.920 ops/s</div><div class="line">Iteration   3: 644088.779 ops/s</div><div class="line">Iteration   4: 644729.889 ops/s</div><div class="line">Iteration   5: 615383.465 ops/s</div><div class="line"></div><div class="line"></div><div class="line">Result <span class="string">"measureMethodAccess"</span>:</div><div class="line">  630392.379 ±(99.9%) 51331.476 ops/s [Average]</div><div class="line">  (min, avg, max) = (615383.465, 630392.379, 644729.889), stdev = 13330.621</div><div class="line">  CI (99.9%): [579060.904, 681723.855] (assumes normal distribution)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Run complete. Total time: 00:00:31</span></div><div class="line"></div><div class="line">Benchmark                                        Mode  Cnt       Score       Error  Units</div><div class="line"><span class="built_in">test</span>ASM.TestRelectASM.measureConstructorAccess  thrpt    5  449915.328 ± 18242.255  ops/s</div><div class="line"><span class="built_in">test</span>ASM.TestRelectASM.measureFieldAccess        thrpt    5  651886.603 ± 15542.738  ops/s</div><div class="line"><span class="built_in">test</span>ASM.TestRelectASM.measureMethodAccess       thrpt    5  630392.379 ± 51331.476  ops/s</div></pre></td></tr></table></figure></p>
<p>接下来我们看一下JDK原生反射的性能<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> testASM;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.annotations.*;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.Runner;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.RunnerException;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.options.Options;</div><div class="line"><span class="keyword">import</span> org.openjdk.jmh.runner.options.OptionsBuilder;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Field;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="meta">@State</span>(Scope.Thread)</div><div class="line"><span class="meta">@BenchmarkMode</span>(Mode.AverageTime)</div><div class="line"><span class="meta">@OutputTimeUnit</span>(TimeUnit.NANOSECONDS)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJDKReflect</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RunnerException </span>&#123;</div><div class="line">        Options opt = <span class="keyword">new</span> OptionsBuilder()</div><div class="line">                .include(TestRelectASM.class.getSimpleName())</div><div class="line">                .warmupIterations(<span class="number">5</span>)</div><div class="line">                .measurementIterations(<span class="number">5</span>)</div><div class="line">                .forks(<span class="number">1</span>)</div><div class="line">                .build();</div><div class="line"></div><div class="line">        <span class="keyword">new</span> Runner(opt).run();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@BenchmarkMode</span>(Mode.Throughput)</div><div class="line">    <span class="meta">@OutputTimeUnit</span>(TimeUnit.SECONDS)</div><div class="line">    <span class="meta">@Benchmark</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">measureMethodAccess</span><span class="params">()</span> </span>&#123;</div><div class="line">        SomeClass someObject = <span class="keyword">new</span> SomeClass();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Method setNameMethod = SomeClass.class.getMethod(<span class="string">"setName"</span>);</div><div class="line">            setNameMethod.invoke(someObject, <span class="string">"Awesome McLovin"</span>);</div><div class="line">            Method getNameMethod = SomeClass.class.getMethod(<span class="string">"getName"</span>);</div><div class="line">            String name = (String)getNameMethod.invoke(someObject);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@BenchmarkMode</span>(Mode.Throughput)</div><div class="line">    <span class="meta">@OutputTimeUnit</span>(TimeUnit.SECONDS)</div><div class="line">    <span class="meta">@Benchmark</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">measureFieldAccess</span><span class="params">()</span> </span>&#123;</div><div class="line">        SomeClass someObject = <span class="keyword">new</span> SomeClass();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Field ageField = SomeClass.class.getField(<span class="string">"age"</span>);</div><div class="line">            ageField.set(someObject, <span class="number">18</span>);</div><div class="line">            Integer age = (Integer)ageField.get(someObject);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@BenchmarkMode</span>(Mode.Throughput)</div><div class="line">    <span class="meta">@OutputTimeUnit</span>(TimeUnit.SECONDS)</div><div class="line">    <span class="meta">@Benchmark</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">measureConstructorAccess</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Constructor&lt;SomeClass&gt; con = SomeClass.class.getConstructor();</div><div class="line">            SomeClass newInstance = con.newInstance();</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>测试结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Warmup: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Measurement: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Timeout: 10 min per iteration</span></div><div class="line"><span class="comment"># Threads: 1 thread, will synchronize iterations</span></div><div class="line"><span class="comment"># Benchmark mode: Throughput, ops/time</span></div><div class="line"><span class="comment"># Benchmark: testASM.TestRelectASM.measureConstructorAccess</span></div><div class="line"></div><div class="line"><span class="comment"># Run progress: 0.00% complete, ETA 00:00:30</span></div><div class="line"><span class="comment"># Fork: 1 of 1</span></div><div class="line"><span class="comment"># Warmup Iteration   1: 272071.065 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   2: 589448.060 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   3: 583306.327 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   4: 559099.151 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   5: 546514.262 ops/s</span></div><div class="line">Iteration   1: 603711.245 ops/s</div><div class="line">Iteration   2: 582218.187 ops/s</div><div class="line">Iteration   3: 561487.624 ops/s</div><div class="line">Iteration   4: 582646.831 ops/s</div><div class="line">Iteration   5: 612259.454 ops/s</div><div class="line"></div><div class="line"></div><div class="line">Result <span class="string">"measureConstructorAccess"</span>:</div><div class="line">  588464.668 ±(99.9%) 76995.468 ops/s [Average]</div><div class="line">  (min, avg, max) = (561487.624, 588464.668, 612259.454), stdev = 19995.478</div><div class="line">  CI (99.9%): [511469.200, 665460.136] (assumes normal distribution)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Warmup: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Measurement: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Timeout: 10 min per iteration</span></div><div class="line"><span class="comment"># Threads: 1 thread, will synchronize iterations</span></div><div class="line"><span class="comment"># Benchmark mode: Throughput, ops/time</span></div><div class="line"><span class="comment"># Benchmark: testASM.TestRelectASM.measureFieldAccess</span></div><div class="line"></div><div class="line"><span class="comment"># Run progress: 33.33% complete, ETA 00:00:21</span></div><div class="line"><span class="comment"># Fork: 1 of 1</span></div><div class="line"><span class="comment"># Warmup Iteration   1: 407799.239 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   2: 599419.421 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   3: 624838.592 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   4: 636293.822 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   5: 623880.225 ops/s</span></div><div class="line">Iteration   1: 600361.584 ops/s</div><div class="line">Iteration   2: 642029.016 ops/s</div><div class="line">Iteration   3: 613483.428 ops/s</div><div class="line">Iteration   4: 645823.284 ops/s</div><div class="line">Iteration   5: 632346.098 ops/s</div><div class="line"></div><div class="line"></div><div class="line">Result <span class="string">"measureFieldAccess"</span>:</div><div class="line">  626808.682 ±(99.9%) 74589.468 ops/s [Average]</div><div class="line">  (min, avg, max) = (600361.584, 626808.682, 645823.284), stdev = 19370.648</div><div class="line">  CI (99.9%): [552219.214, 701398.150] (assumes normal distribution)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Warmup: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Measurement: 5 iterations, 1 s each</span></div><div class="line"><span class="comment"># Timeout: 10 min per iteration</span></div><div class="line"><span class="comment"># Threads: 1 thread, will synchronize iterations</span></div><div class="line"><span class="comment"># Benchmark mode: Throughput, ops/time</span></div><div class="line"><span class="comment"># Benchmark: testASM.TestRelectASM.measureMethodAccess</span></div><div class="line"></div><div class="line"><span class="comment"># Run progress: 66.67% complete, ETA 00:00:10</span></div><div class="line"><span class="comment"># Fork: 1 of 1</span></div><div class="line"><span class="comment"># Warmup Iteration   1: 397028.204 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   2: 602683.986 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   3: 576226.708 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   4: 602674.109 ops/s</span></div><div class="line"><span class="comment"># Warmup Iteration   5: 591631.635 ops/s</span></div><div class="line">Iteration   1: 607990.169 ops/s</div><div class="line">Iteration   2: 586306.494 ops/s</div><div class="line">Iteration   3: 606049.775 ops/s</div><div class="line">Iteration   4: 583441.620 ops/s</div><div class="line">Iteration   5: 577363.527 ops/s</div><div class="line"></div><div class="line"></div><div class="line">Result <span class="string">"measureMethodAccess"</span>:</div><div class="line">  592230.317 ±(99.9%) 53519.265 ops/s [Average]</div><div class="line">  (min, avg, max) = (577363.527, 592230.317, 607990.169), stdev = 13898.783</div><div class="line">  CI (99.9%): [538711.052, 645749.582] (assumes normal distribution)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Run complete. Total time: 00:00:31</span></div><div class="line"></div><div class="line">Benchmark                                        Mode  Cnt       Score       Error  Units</div><div class="line"><span class="built_in">test</span>ASM.TestRelectASM.measureConstructorAccess  thrpt    5  588464.668 ± 76995.468  ops/s</div><div class="line"><span class="built_in">test</span>ASM.TestRelectASM.measureFieldAccess        thrpt    5  626808.682 ± 74589.468  ops/s</div><div class="line"><span class="built_in">test</span>ASM.TestRelectASM.measureMethodAccess       thrpt    5  592230.317 ± 53519.265  ops/s</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/06/14/JavaLibrary/ReflectASM 性能测试/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/06/14/JavaLibrary/ReflectASM 性能测试/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/13/JavaSE/Java Integer Parse String/" title="Integer Parse ValueOf" itemprop="url">Integer Parse ValueOf</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-06-12T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-06-13</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>今天使用FindBugs检查项目时，发现有这样一个提示<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Boxing/unboxing to parse a primitive</div><div class="line">A boxed primitive is created from a String, just to extract the unboxed primitive value. It is more efficient to just call the static parseXXX method.</div></pre></td></tr></table></figure></p>
<p>这句话的意思是说，我们正在讲一个String解析成一个boxed的原生类型，也就是Integer，Long这些等等，但是我们只需要将String解析成unboxed原生类型即可，也就是int，long这种。最后它推荐使用<code>parseXXX()</code>这样的静态方法.</p>
<p>于是很好奇<code>parseXXX()</code>和<code>valueOf()</code>有啥不同呢？打开源码看一看<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">valueOf</span><span class="params">(String s)</span> <span class="keyword">throws</span> NumberFormatException </span>&#123;</div><div class="line">      <span class="keyword">return</span> Integer.valueOf(parseInt(s, <span class="number">10</span>));</div><div class="line">  &#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">valueOf</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (i &gt;= IntegerCache.low &amp;&amp; i &lt;= IntegerCache.high)</div><div class="line">        <span class="keyword">return</span> IntegerCache.cache[i + (-IntegerCache.low)];</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Integer(i);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看到<code>valueOf()</code>内部也是调用了<code>parseInt()</code>方法. 从下面的<code>valueOf()</code>方法可以看出, <code>parseInt()</code>返回的是一个unboxed的原生类型数据. 因此在上面的场景中会有那样的提示.</p>
<p>但是看到这里还不算完, 看到这让我想起了一个以前碰到的面试题<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestIntegerValueOf</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Integer i1 = <span class="number">1</span>;</div><div class="line">		Integer i2 = <span class="number">1</span>;</div><div class="line">		System.out.println(i1 == i2);</div><div class="line"></div><div class="line">		Integer i3 = <span class="number">200</span>;</div><div class="line">		Integer i4 = <span class="number">200</span>;</div><div class="line">		System.out.println(i3 == i4);</div><div class="line"></div><div class="line">		Integer i5 = Integer.valueOf(<span class="number">100</span>);</div><div class="line">		Integer i6 = Integer.valueOf(<span class="number">100</span>);</div><div class="line">		System.out.println(i5 == i6);</div><div class="line"></div><div class="line">		Integer i7 = Integer.valueOf(<span class="number">200</span>);</div><div class="line">		Integer i8 = Integer.valueOf(<span class="number">200</span>);</div><div class="line">		System.out.println(i7 == i8);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="literal">true</span></div><div class="line"><span class="literal">false</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="literal">false</span></div></pre></td></tr></table></figure></p>
<p>我们看到在讲int强转为Interger的时候, 也是<code>valueOf()</code>的逻辑</p>
<p>除了Integer之外, 还有哪些基本原生类型是这样子的呢？先看看long<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title">valueOf</span><span class="params">(<span class="keyword">long</span> l)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> offset = <span class="number">128</span>;</div><div class="line">    <span class="keyword">if</span> (l &gt;= -<span class="number">128</span> &amp;&amp; l &lt;= <span class="number">127</span>) &#123; <span class="comment">// will cache</span></div><div class="line">        <span class="keyword">return</span> LongCache.cache[(<span class="keyword">int</span>)l + offset];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Long(l);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来是Short<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Short <span class="title">valueOf</span><span class="params">(<span class="keyword">short</span> s)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> offset = <span class="number">128</span>;</div><div class="line">    <span class="keyword">int</span> sAsInt = s;</div><div class="line">    <span class="keyword">if</span> (sAsInt &gt;= -<span class="number">128</span> &amp;&amp; sAsInt &lt;= <span class="number">127</span>) &#123; <span class="comment">// must cache</span></div><div class="line">        <span class="keyword">return</span> ShortCache.cache[sAsInt + offset];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Short(s);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来是Byte<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Byte <span class="title">valueOf</span><span class="params">(<span class="keyword">byte</span> b)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> offset = <span class="number">128</span>;</div><div class="line">    <span class="keyword">return</span> ByteCache.cache[(<span class="keyword">int</span>)b + offset];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来是Char<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Character <span class="title">valueOf</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (c &lt;= <span class="number">127</span>) &#123; <span class="comment">// must cache</span></div><div class="line">        <span class="keyword">return</span> CharacterCache.cache[(<span class="keyword">int</span>)c];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Character(c);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来是Float<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Float <span class="title">valueOf</span><span class="params">(<span class="keyword">float</span> f)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Float(f);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来是Double<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Double <span class="title">valueOf</span><span class="params">(<span class="keyword">double</span> d)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Double(d);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看到除了浮点型之外，都采用了缓存的原理。虽然我们从源码中看到了结果，可是求个心安，我们还是要写代码测试一下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Short s_1 = <span class="number">100</span>;</div><div class="line">		Short s_2 = <span class="number">100</span>;</div><div class="line">		System.out.println(s_1 == s_2);</div><div class="line"></div><div class="line">		Long l_1 = <span class="number">100l</span>;</div><div class="line">		Long l_2 = <span class="number">100l</span>;</div><div class="line">		System.out.println(l_1 == l_2);</div><div class="line"></div><div class="line">		Character c_1 = <span class="number">100</span>;</div><div class="line">		Character c_2 = <span class="number">100</span>;</div><div class="line">		System.out.println(c_1 == c_2);</div><div class="line"></div><div class="line">		Short s1 = <span class="number">200</span>;</div><div class="line">		Short s2 = <span class="number">200</span>;</div><div class="line">		System.out.println(s1 == s2);</div><div class="line"></div><div class="line">		Long l1 = <span class="number">200l</span>;</div><div class="line">		Long l2 = <span class="number">200l</span>;</div><div class="line">		System.out.println(l1 == l2);</div><div class="line"></div><div class="line">		Character c1 = <span class="number">200</span>;</div><div class="line">		Character c2 = <span class="number">200</span>;</div><div class="line">		System.out.println(c1 == c2);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="literal">true</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="literal">true</span></div><div class="line"><span class="literal">false</span></div><div class="line"><span class="literal">false</span></div><div class="line"><span class="literal">false</span></div></pre></td></tr></table></figure></p>
<p>好了，这下世界安静了</p>
<hr>
<p>后来在项目中发现有使用Gson转换中也会发生这种情况, 写个代码测试一下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestIntegerValueOf</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Obj obj = <span class="keyword">new</span> Obj();</div><div class="line">		obj.integer = <span class="number">200</span>;</div><div class="line">		Gson gson = <span class="keyword">new</span> Gson();</div><div class="line">		String str = gson.toJson(obj);</div><div class="line">		System.out.println(str);</div><div class="line">		Obj newObj1 = gson.fromJson(str, Obj.class);</div><div class="line">		Obj newObj2 = gson.fromJson(str, Obj.class);</div><div class="line">		System.out.println(newObj1.integer == newObj2.integer);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Obj</span> </span>&#123;</div><div class="line">		<span class="keyword">public</span> Integer integer;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="string">"integer"</span>:200&#125;</div><div class="line"><span class="literal">false</span></div></pre></td></tr></table></figure></p>
<p>看来在Gson中不是使用强转就是使用的<code>valueOf()</code></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/06/13/JavaSE/Java Integer Parse String/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/06/13/JavaSE/Java Integer Parse String/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/10/算法/选择排序/" title="选择排序" itemprop="url">选择排序</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-06-10T07:00:00.000Z" itemprop="datePublished"> 发表于 2016-06-10</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>假设我们有这样的一个数组 [10, 2, 5, 3, 6, 4]. 在选择排序算法时, 会进行如下操作</p>
<ol>
<li>10 与 2, 5, 3, 6, 4进行比较, 找到最小的值放到左边. 因此第一轮排序之后结果为 [2, 10, 5, 3, 6, 4]</li>
<li>10 与 5, 3, 6, 4进行比较, 找到最小的值放到左边. 因此第二轮排序之后结果为 [2, 3, 5, 10, 6, 4]</li>
<li>5 与 10, 6, 4进行比较, 找到最小的值放到左边. 因此第二轮排序之后结果为 [2, 3, 4, 10, 6, 5]</li>
<li>…以此类推</li>
</ol>
<p>我们看一下选择排序的实现<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#-*- coding=utf-8 -*-</span></div><div class="line"></div><div class="line">data = [<span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</div><div class="line"><span class="keyword">print</span> data</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sort</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(data)):</div><div class="line">        min  = i</div><div class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(i, len(data)):</div><div class="line">            <span class="keyword">if</span> data[j] &lt; data[min]:</div><div class="line">                min = j</div><div class="line"></div><div class="line">        tmp = data[i]</div><div class="line">        data[i] = data[min]</div><div class="line">        data[min] = tmp</div><div class="line">        <span class="keyword">print</span> str(data[i]) + <span class="string">" compore "</span> + str(data[j]) + <span class="string">" -&gt; "</span> + str(data)</div><div class="line"></div><div class="line">sort()</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[5, 4, 3, 2, 1]</div><div class="line">1 compore 5 -&gt; [1, 4, 3, 2, 5]</div><div class="line">2 compore 5 -&gt; [1, 2, 3, 4, 5]</div><div class="line">3 compore 5 -&gt; [1, 2, 3, 4, 5]</div><div class="line">4 compore 5 -&gt; [1, 2, 3, 4, 5]</div><div class="line">5 compore 5 -&gt; [1, 2, 3, 4, 5]</div></pre></td></tr></table></figure></p>
<p>选择排序的运行时间和输入没有关系. 因为在排序的过程中, 每一个位置的数字都会跟后边的数字比较一遍.所以哪怕数组是排序好的, 仍然会进行比较.</p>
<p>那么选择排序会比较多少次呢? 答案是<code>(N + (N - 1) + (N - 2) ... 1) = N^2/2</code>.</p>
<p>相关网站</p>
<ul>
<li><a href="http://visualgo.net" target="_blank" rel="external">visualgo</a></li>
<li><a href="http://www.sorting-algorithms.com/" target="_blank" rel="external">Sorting Algorithm</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/算法/">算法</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/06/10/算法/选择排序/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/06/10/算法/选择排序/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/10/算法/希尔排序/" title="希尔排序" itemprop="url">希尔排序</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-06-09T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-06-10</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>希尔排序是一种基于插入排序的算法.</p>
<p>插入排序的递增序列是1, 每次向前插入的时候都是和相邻的数组元素比较. 而希尔排序的递增是不固定的, 一般我们是选择一个算法, 算出递增. 希尔排序的思想是在间隔任意值h之间的数字是有序的, 这样的数组称为h有序数组. h有序数组是由h个互相独立的有序数组组成的一个大数组.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#-*- coding=utf-8 -*-</span></div><div class="line"></div><div class="line">data = [<span class="number">8</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</div><div class="line"><span class="keyword">print</span> data</div><div class="line"></div><div class="line">h = <span class="number">1</span></div><div class="line"><span class="keyword">while</span> h &lt; len(data)/<span class="number">3</span>:</div><div class="line">    h = <span class="number">3</span>*h + <span class="number">1</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sort</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">global</span> h</div><div class="line">    <span class="keyword">while</span> h &gt; <span class="number">0</span>:</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(data)):</div><div class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(i, <span class="number">0</span>, -h):</div><div class="line">                pre = j - h</div><div class="line">                <span class="keyword">if</span> data[j] &lt; data[pre]:</div><div class="line">                    tmp = data[pre]</div><div class="line">                    data[pre] = data[j]</div><div class="line">                    data[j] = tmp</div><div class="line"></div><div class="line">                <span class="keyword">print</span> str(h) + <span class="string">":   "</span> + str(data[j - h]) + <span class="string">" compore "</span> + str(data[j]) + <span class="string">" -&gt; "</span> + str(data)</div><div class="line">        h = h / <span class="number">3</span></div><div class="line">sort()</div></pre></td></tr></table></figure>
<p>运算结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">[8, 7, 6, 5, 4, 3, 2, 1]</div><div class="line">4:   3 compore 7 -&gt; [8, 7, 6, 5, 4, 3, 2, 1]</div><div class="line">4:   2 compore 6 -&gt; [8, 7, 6, 5, 4, 3, 2, 1]</div><div class="line">4:   1 compore 5 -&gt; [8, 7, 6, 5, 4, 3, 2, 1]</div><div class="line">4:   4 compore 8 -&gt; [4, 7, 6, 5, 8, 3, 2, 1]</div><div class="line">4:   3 compore 7 -&gt; [4, 3, 6, 5, 8, 7, 2, 1]</div><div class="line">4:   3 compore 7 -&gt; [4, 7, 6, 5, 8, 3, 2, 1]</div><div class="line">4:   2 compore 6 -&gt; [4, 7, 2, 5, 8, 3, 6, 1]</div><div class="line">4:   2 compore 6 -&gt; [4, 7, 6, 5, 8, 3, 2, 1]</div><div class="line">4:   1 compore 5 -&gt; [4, 7, 6, 1, 8, 3, 2, 5]</div><div class="line">4:   1 compore 5 -&gt; [4, 7, 6, 5, 8, 3, 2, 1]</div><div class="line">1:   4 compore 7 -&gt; [4, 7, 6, 5, 8, 3, 2, 1]</div><div class="line">1:   6 compore 7 -&gt; [4, 6, 7, 5, 8, 3, 2, 1]</div><div class="line">1:   4 compore 6 -&gt; [4, 6, 7, 5, 8, 3, 2, 1]</div><div class="line">1:   5 compore 7 -&gt; [4, 6, 5, 7, 8, 3, 2, 1]</div><div class="line">1:   5 compore 6 -&gt; [4, 5, 6, 7, 8, 3, 2, 1]</div><div class="line">1:   4 compore 5 -&gt; [4, 5, 6, 7, 8, 3, 2, 1]</div><div class="line">1:   7 compore 8 -&gt; [4, 5, 6, 7, 8, 3, 2, 1]</div><div class="line">1:   6 compore 7 -&gt; [4, 5, 6, 7, 8, 3, 2, 1]</div><div class="line">1:   5 compore 6 -&gt; [4, 5, 6, 7, 8, 3, 2, 1]</div><div class="line">1:   4 compore 5 -&gt; [4, 5, 6, 7, 8, 3, 2, 1]</div><div class="line">1:   3 compore 8 -&gt; [4, 5, 6, 7, 3, 8, 2, 1]</div><div class="line">1:   3 compore 7 -&gt; [4, 5, 6, 3, 7, 8, 2, 1]</div><div class="line">1:   3 compore 6 -&gt; [4, 5, 3, 6, 7, 8, 2, 1]</div><div class="line">1:   3 compore 5 -&gt; [4, 3, 5, 6, 7, 8, 2, 1]</div><div class="line">1:   3 compore 4 -&gt; [3, 4, 5, 6, 7, 8, 2, 1]</div><div class="line">1:   2 compore 8 -&gt; [3, 4, 5, 6, 7, 2, 8, 1]</div><div class="line">1:   2 compore 7 -&gt; [3, 4, 5, 6, 2, 7, 8, 1]</div><div class="line">1:   2 compore 6 -&gt; [3, 4, 5, 2, 6, 7, 8, 1]</div><div class="line">1:   2 compore 5 -&gt; [3, 4, 2, 5, 6, 7, 8, 1]</div><div class="line">1:   2 compore 4 -&gt; [3, 2, 4, 5, 6, 7, 8, 1]</div><div class="line">1:   2 compore 3 -&gt; [2, 3, 4, 5, 6, 7, 8, 1]</div><div class="line">1:   1 compore 8 -&gt; [2, 3, 4, 5, 6, 7, 1, 8]</div><div class="line">1:   1 compore 7 -&gt; [2, 3, 4, 5, 6, 1, 7, 8]</div><div class="line">1:   1 compore 6 -&gt; [2, 3, 4, 5, 1, 6, 7, 8]</div><div class="line">1:   1 compore 5 -&gt; [2, 3, 4, 1, 5, 6, 7, 8]</div><div class="line">1:   1 compore 4 -&gt; [2, 3, 1, 4, 5, 6, 7, 8]</div><div class="line">1:   1 compore 3 -&gt; [2, 1, 3, 4, 5, 6, 7, 8]</div><div class="line">1:   1 compore 2 -&gt; [1, 2, 3, 4, 5, 6, 7, 8]</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/算法/">算法</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/06/10/算法/希尔排序/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/06/10/算法/希尔排序/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/09/算法/插入排序/" title="插入排序" itemprop="url">插入排序</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-06-09T07:00:00.000Z" itemprop="datePublished"> 发表于 2016-06-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>插入排序和选择排序类似, 也是在每个数组元素左边的数据都是有序的, 但是不确定他们的最终位置在哪里. 都是排序完的结果都是升序, 但是选择排序是将每个数据向后比较, 上次的比较和交换结果对下次的比较交换并没有什么影响. 而插入排序就不一样了, 插入排序是向前比较, 而它前面的数据是已经排序好了的. 因此插入排序的结果是受数据输入的影响的.如果输入的数据是一个已经排序好的数组, 那么插入排序的时间复杂度仅仅是<code>O(N)</code>. 更多关于性能方面的介绍我会在最后给出, 下面我们看一个实现, 以及对一组简单数据排序后的结果:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#-*- coding=utf-8 -*-</span></div><div class="line"></div><div class="line">data = [<span class="number">10</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">4</span>]</div><div class="line"><span class="keyword">print</span> data</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sort</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(data)):</div><div class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(i, <span class="number">0</span>, <span class="number">-1</span>):</div><div class="line">            <span class="keyword">if</span> data[j] &lt; data[j - <span class="number">1</span>]:</div><div class="line">                tmp = data[j - <span class="number">1</span>]</div><div class="line">                data[j - <span class="number">1</span>] = data[j]</div><div class="line">                data[j] = tmp</div><div class="line">                </div><div class="line">            </div><div class="line"></div><div class="line">sort()</div></pre></td></tr></table></figure>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[10, 2, 5, 3, 6, 4]</div><div class="line">2 compore 10 -&gt; [2, 10, 5, 3, 6, 4]</div><div class="line">5 compore 10 -&gt; [2, 5, 10, 3, 6, 4]</div><div class="line">2 compore 5 -&gt; [2, 5, 10, 3, 6, 4]</div><div class="line">3 compore 10 -&gt; [2, 5, 3, 10, 6, 4]</div><div class="line">3 compore 5 -&gt; [2, 3, 5, 10, 6, 4]</div><div class="line">2 compore 3 -&gt; [2, 3, 5, 10, 6, 4]</div><div class="line">6 compore 10 -&gt; [2, 3, 5, 6, 10, 4]</div><div class="line">5 compore 6 -&gt; [2, 3, 5, 6, 10, 4]</div><div class="line">3 compore 5 -&gt; [2, 3, 5, 6, 10, 4]</div><div class="line">2 compore 3 -&gt; [2, 3, 5, 6, 10, 4]</div><div class="line">4 compore 10 -&gt; [2, 3, 5, 6, 4, 10]</div><div class="line">4 compore 6 -&gt; [2, 3, 5, 4, 6, 10]</div><div class="line">4 compore 5 -&gt; [2, 3, 4, 5, 6, 10]</div><div class="line">3 compore 4 -&gt; [2, 3, 4, 5, 6, 10]</div><div class="line">2 compore 3 -&gt; [2, 3, 4, 5, 6, 10]</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/算法/">算法</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/06/09/算法/插入排序/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/06/09/算法/插入排序/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/09/算法/冒泡排序/" title="冒泡排序" itemprop="url">冒泡排序</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-06-08T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-06-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#-*- coding=utf-8 -*-</span></div><div class="line"></div><div class="line">data = [<span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</div><div class="line"><span class="keyword">print</span> data</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sort</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(data)):</div><div class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(i, <span class="number">0</span>, <span class="number">-1</span>):</div><div class="line">            pre = j - <span class="number">1</span></div><div class="line">            <span class="keyword">if</span> data[j] &lt; data[pre]:</div><div class="line">                tmp = data[pre]</div><div class="line">                data[pre] = data[j]</div><div class="line">                data[j] = tmp</div><div class="line">                <span class="keyword">print</span> str(data[pre]) + <span class="string">" compore "</span> + str(data[j]) + <span class="string">" -&gt; "</span> + str(data)</div><div class="line"></div><div class="line">sort()</div></pre></td></tr></table></figure>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[5, 4, 3, 2, 1]</div><div class="line">4 compore 5 -&gt; [4, 5, 3, 2, 1]</div><div class="line">3 compore 5 -&gt; [4, 3, 5, 2, 1]</div><div class="line">3 compore 4 -&gt; [3, 4, 5, 2, 1]</div><div class="line">2 compore 5 -&gt; [3, 4, 2, 5, 1]</div><div class="line">2 compore 4 -&gt; [3, 2, 4, 5, 1]</div><div class="line">2 compore 3 -&gt; [2, 3, 4, 5, 1]</div><div class="line">1 compore 5 -&gt; [2, 3, 4, 1, 5]</div><div class="line">1 compore 4 -&gt; [2, 3, 1, 4, 5]</div><div class="line">1 compore 3 -&gt; [2, 1, 3, 4, 5]</div><div class="line">1 compore 2 -&gt; [1, 2, 3, 4, 5]</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/算法/">算法</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/06/09/算法/冒泡排序/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/06/09/算法/冒泡排序/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/07/JavaSE/Java  ThreadLocal/" title="ThreadLocal 实战" itemprop="url">ThreadLocal 实战</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-06-06T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-06-07</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><p>项目中使用了<code>java.text.SimpleDateFormat</code>, 但是却将其声明为<code>static</code>. 在Oracle的Java API文档中是这样说明的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Synchronization</div><div class="line"></div><div class="line">Date formats are not synchronized. It is recommended to create separate format instances <span class="keyword">for</span> each thread. If multiple threads access a format concurrently, it must be synchronized externally.</div></pre></td></tr></table></figure></p>
<p><code>Date</code>对象的format操作并不是同步进行的. 我们应该为每个线程都创建一个<code>SimpleDateFormat</code>对象, 或者为format操作进行加锁处理.</p>
<p>那么<code>ThreadLocal</code>就可以成为这种场景下的替代方案. 我们看一下替换后的代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;<span class="keyword">byte</span>[]&gt; simpleDateFormatThreadLocal = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> AtomicInteger count = <span class="keyword">new</span> AtomicInteger();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">5</span>; j++) &#123;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</div><div class="line">				Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">					<span class="keyword">byte</span>[] bytes = simpleDateFormatThreadLocal.get();</div><div class="line">					<span class="keyword">if</span> (bytes == <span class="keyword">null</span>) &#123;</div><div class="line">						bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">3</span>];</div><div class="line">						simpleDateFormatThreadLocal.set(bytes);</div><div class="line">						count.incrementAndGet();</div><div class="line">					&#125;</div><div class="line">				&#125;);</div><div class="line">				thread.start();</div><div class="line">				thread.join();</div><div class="line">			&#125;</div><div class="line">			System.out.println(<span class="string">"Active Thread Count : "</span> + Thread.activeCount());</div><div class="line">	        TimeUnit.MILLISECONDS.sleep(<span class="number">50</span>);</div><div class="line">		&#125;</div><div class="line">		System.out.println(<span class="string">"set count ; "</span> + count);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看到了ThreadLocal的使用很简单, 首先是分配一个ThreadLocal对象, 然后接下来就通关get, set进行操作就ok了</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><code>ThreadLocal</code>的实现是这样子的, 每个<code>Thread</code>对象内部有一个<code>ThreadLocal.ThreadLocalMap</code>实例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Thread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">	ThreadLocal.ThreadLocalMap threadLocals = <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而<code>ThreadLocal.ThreadLocalMap</code>里有一个Entry数组用于实际存储数据, 也就是说<code>ThreadLocal</code>本身是不存储数据的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalMap</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ThreadLocal</span>&lt;?&gt;&gt; </span>&#123;</div><div class="line">        Object value;</div><div class="line"></div><div class="line">        Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</div><div class="line">            <span class="keyword">super</span>(k);</div><div class="line">            value = v;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Entry[] table;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过下面<code>ThreadLocal</code>方法实现我们可以看到每个和线程相关的数据最终都是保存到了各自的线程对象<code>ThreadLocal.ThreadLocalMap</code>实例里, 然后使用<code>ThreadLocal</code>作为key存储.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocal</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">		Thread t = Thread.currentThread();</div><div class="line">		ThreadLocalMap map = getMap(t);</div><div class="line">		<span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</div><div class="line">			ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);</div><div class="line">			<span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">				T result = (T)e.value;</div><div class="line">				<span class="keyword">return</span> result;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> setInitialValue();</div><div class="line">	&#125;</div><div class="line">		</div><div class="line">	<span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>&#123;</div><div class="line">			<span class="keyword">return</span> t.threadLocals;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">	<span class="function"><span class="keyword">private</span> Entry <span class="title">getEntry</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> i = key.threadLocalHashCode &amp; (table.length - <span class="number">1</span>);</div><div class="line">		Entry e = table[i];</div><div class="line">		<span class="keyword">if</span> (e != <span class="keyword">null</span> &amp;&amp; e.get() == key)</div><div class="line">			<span class="keyword">return</span> e;</div><div class="line">		<span class="keyword">else</span></div><div class="line">			<span class="keyword">return</span> getEntryAfterMiss(key, i, e);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="内存溢出"><a href="#内存溢出" class="headerlink" title="内存溢出"></a>内存溢出</h2><p>上面我们说了一下应用和原理, 但是见<a href="http://www.codeceo.com/article/about-threadlocal-memory-leak.html" target="_blank" rel="external">网上有人说内存泄漏的问题</a>, 关键在于<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ThreadLocal</span>&lt;?&gt;&gt; </span>&#123;</div><div class="line">    Object value;</div><div class="line"></div><div class="line">    Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</div><div class="line">        <span class="keyword">super</span>(k);</div><div class="line">        value = v;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>Entry</code>是一个弱引用类型(<a href="http://www.yu66.wang/2016/05/05/jvm/Java%20%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/">Java 引用类型</a>). 当GC的时候, 如果weakReference的引用没有被强依赖的话, 则势必会被回收掉, 但是在ThreadLocal的时候则不然, 因为我们会一直保留ThreadLocal作为强引用依赖, 那么ThreadLocal则会一直被引用着, GC也不会回收它, Entry里面的value也就一直是可用的. 并不会发生ThreadLocal实例被回收, 而Entry里面value一直保存下来, 发生内存泄漏的情况.</p>
<p>第一个应用中就是我实际代码中使用的示例, 下面我使用<code>-Xmx10M -Xms10M -XX:+PrintGC</code>这几个JVM参数测试一下上面程序的内存泄漏问题, 结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">[GC (Allocation Failure)  2048K-&gt;905K(9728K), 0.0061875 secs]</div><div class="line">[GC (Allocation Failure)  7854K-&gt;7113K(9728K), 0.0011924 secs]</div><div class="line">[GC (Allocation Failure)  7113K-&gt;7129K(9728K), 0.0031599 secs]</div><div class="line">[Full GC (Allocation Failure)  7129K-&gt;873K(9728K), 0.0409086 secs]</div><div class="line">[GC (Allocation Failure)  7140K-&gt;7081K(9728K), 0.0311850 secs]</div><div class="line">[Full GC (Ergonomics)  7081K-&gt;1024K(9728K), 0.0355878 secs]</div><div class="line">[GC (Allocation Failure)  4150K-&gt;4128K(9728K), 0.0130218 secs]</div><div class="line">[GC (Allocation Failure)  4128K-&gt;4128K(8704K), 0.0009429 secs]</div><div class="line">[Full GC (Allocation Failure)  4128K-&gt;872K(8704K), 0.0158858 secs]</div><div class="line">[GC (Allocation Failure)  7057K-&gt;7112K(9216K), 0.0064885 secs]</div><div class="line">[Full GC (Ergonomics)  7112K-&gt;872K(9216K), 0.0088626 secs]</div><div class="line">[GC (Allocation Failure)  7057K-&gt;7112K(9216K), 0.0037829 secs]</div><div class="line">[Full GC (Ergonomics)  7112K-&gt;872K(9216K), 0.0174345 secs]</div><div class="line">[GC (Allocation Failure)  7057K-&gt;7048K(9216K), 0.0180387 secs]</div><div class="line">[Full GC (Ergonomics)  7048K-&gt;872K(9216K), 0.0508169 secs]</div><div class="line">[GC (Allocation Failure)  7057K-&gt;7080K(9216K), 0.0088642 secs]</div><div class="line">[Full GC (Ergonomics)  7080K-&gt;872K(9216K), 0.0328227 secs]</div><div class="line">Active Thread Count : 2</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">[Full GC (Ergonomics)  7050K-&gt;874K(9728K), 0.0055843 secs]</div><div class="line">[GC (Allocation Failure)  7100K-&gt;7050K(9728K), 0.0002894 secs]</div><div class="line">[Full GC (Ergonomics)  7050K-&gt;874K(9728K), 0.0209747 secs]</div><div class="line">[GC (Allocation Failure)  7100K-&gt;7114K(9728K), 0.0002878 secs]</div><div class="line">[Full GC (Ergonomics)  7114K-&gt;874K(9728K), 0.0034925 secs]</div><div class="line">[GC (Allocation Failure)  7100K-&gt;7082K(9728K), 0.0003256 secs]</div><div class="line">[Full GC (Ergonomics)  7082K-&gt;874K(9728K), 0.0057511 secs]</div><div class="line">[GC (Allocation Failure)  7100K-&gt;7082K(9728K), 0.0003378 secs]</div><div class="line">[Full GC (Ergonomics)  7082K-&gt;874K(9728K), 0.0037080 secs]</div><div class="line">[GC (Allocation Failure)  7100K-&gt;7050K(9728K), 0.0001761 secs]</div><div class="line">[Full GC (Ergonomics)  7050K-&gt;874K(9728K), 0.0040176 secs]</div><div class="line">[GC (Allocation Failure)  7120K-&gt;7050K(9728K), 0.0005024 secs]</div><div class="line">[Full GC (Ergonomics)  7050K-&gt;874K(9728K), 0.0051379 secs]</div><div class="line">[GC (Allocation Failure)  7100K-&gt;7082K(9728K), 0.0021276 secs]</div><div class="line">[Full GC (Ergonomics)  7082K-&gt;874K(9728K), 0.0060047 secs]</div><div class="line">Active Thread Count : 2</div><div class="line"><span class="built_in">set</span> count ; 250</div></pre></td></tr></table></figure></p>
<p>由于篇幅的原因, 我并没有将全部的日志输出, 但是通过上面的日志我们还是可以看出, 程序一共分配了250次内存, 每次分配给ThreadLocal里面的数据都被回收掉了, 因此对<code>ThreadLocal</code>的一个简单应用, 只要我们写的线程代码没有问题, 我们并不需要对内存泄漏担心太多.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/06/07/JavaSE/Java  ThreadLocal/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/06/07/JavaSE/Java  ThreadLocal/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/30/杂记/ttystudio/" title="终端生成GIF文件" itemprop="url">终端生成GIF文件</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-05-29T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-05-30</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="ttystudio"><a href="#ttystudio" class="headerlink" title="ttystudio"></a>ttystudio</h2><p><a href="https://github.com/chjj/ttystudio" target="_blank" rel="external">ttystudio</a>可以将命令行操作制作成gif文件.</p>
<p>安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install ttystudio</div></pre></td></tr></table></figure></p>
<p>全局安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install ttystudio -g</div></pre></td></tr></table></figure></p>
<p>使用<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ttystudio output.gif --log</div></pre></td></tr></table></figure></p>
<p>上面这个命令最终生成一个output.gif文件, 同时将生成的过程输出</p>
<p>除了上面简单的介绍外, 它还可以为我们添加边框, 录制部分帧</p>
<blockquote>
<p>还有其他的录制软件 <a href="https://asciinema.org" target="_blank" rel="external">asciinema</a></p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/杂记/">杂记</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/05/30/杂记/ttystudio/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/05/30/杂记/ttystudio/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/17/数据库/Mysql JSON Data Type/" title="Mysql JSON 支持" itemprop="url">Mysql JSON 支持</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-05-17T07:00:00.000Z" itemprop="datePublished"> 发表于 2016-05-17</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://dev.mysql.com/doc/refman/5.7/en/json.html" target="_blank" rel="external">官方文档</a>学习</p>
<p>在MySQL5.7版本中增加了对JSON的支持. 在SQL中进行JSON字段操作时都是通过使用函数完成的</p>
<h2 id="创建JSON字段"><a href="#创建JSON字段" class="headerlink" title="创建JSON字段"></a>创建JSON字段</h2><p>在Mysql中, JSON是通过字符串进行存储的.</p>
<p>下面的例子演示了创建JSON类型字段的表, 以及插入一个JSON串和插入一个非法的JSON串<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mysql&gt; CREATE TABLE t1 (jdoc JSON);</div><div class="line">Query OK, 0 rows affected (0.20 sec)</div><div class="line"></div><div class="line">mysql&gt; INSERT INTO t1 VALUES('&#123;"key1": "value1", "key2": "value2"&#125;');</div><div class="line">Query OK, 1 row affected (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; INSERT INTO t1 VALUES('[1, 2,');</div><div class="line">ERROR 3140 (22032) at line 2: Invalid JSON text: "Invalid value." at position 6 in value (or column) '[1, 2,'.</div></pre></td></tr></table></figure></p>
<blockquote>
<p><code>at position N</code>是从0 开始计算的</p>
</blockquote>
<h2 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h2><p>我们可以在JSON文档中通过<code>JSON_EXTRACT()</code>函数指定path来搜索出一个值.</p>
<p>在相关方法中使用表达式可以提取数据,或者修改JSON文档 以及进行其他的操作. 例如下面的操作就是从JSON文档中提取key为name的值.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT JSON_EXTRACT('&#123;"id": 14, "name": "Aztalan"&#125;', '$.name');</div><div class="line">+---------------------------------------------------------+</div><div class="line">| JSON_EXTRACT('&#123;"id": 14, "name": "Aztalan"&#125;', '$.name') |</div><div class="line">+---------------------------------------------------------+</div><div class="line">| "Aztalan"                                               |</div><div class="line">+---------------------------------------------------------+</div></pre></td></tr></table></figure></p>
<p>在Mysql中, 可以使用<code>$</code>加后缀的方式表示一个JSON文档. <code>$</code>后可以跟一个选择符来索引到JSON文档中任意的位置元素:</p>
<ul>
<li><code>$&quot;key&quot;</code> 表示在JSON文档中, key所对应的值. 注意key必须使用<code>&quot;&quot;</code>括起来.</li>
<li><code>[N]</code> 表示JSON数组文档中第N个位置的值(从0开始).</li>
<li>Paths 可以包含 <code>*</code>或者<code>**</code> 通配符.</li>
<li><code>.[*]</code> 找到JSON对象中所有的成员值</li>
<li><code>[*]</code> 找到JSON数组中所有的成员值</li>
<li><code>prefix**suffix</code> 匹配所有的以prefix开头, 以suffix结尾的path.</li>
</ul>
<p>下面我们创建出三个元素的数组, 然后假设 <code>$</code> 指向这个数组:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="number">3</span>, &#123;<span class="attr">"a"</span>: [<span class="number">5</span>, <span class="number">6</span>], <span class="attr">"b"</span>: <span class="number">10</span>&#125;, [<span class="number">99</span>, <span class="number">100</span>]]</div></pre></td></tr></table></figure></p>
<p>那么:</p>
<ul>
<li><code>$[0]</code> 求值为 3.</li>
<li><code>$[1]</code> 求值为 {“a”: [5, 6], “b”: 10}.</li>
<li><code>$[2]</code> 求值为[99, 100].</li>
<li><code>$[3]</code> 求值为 NULL (指向一个不存在的元素).</li>
</ul>
<p>因为 $[1] 和 $[2] 是非标量的值, 因此我们可以进一步的使用path表达式求出它内嵌的值. 例如:</p>
<ul>
<li><code>$[1].a</code> 求值为 [5, 6].</li>
<li><code>$[1].a[1]</code> 求值为 6.</li>
<li><code>$[1].b</code> 求值为 10.</li>
<li><code>$[2][0]</code> 求值为 99.</li>
</ul>
<p>刚才我们也提到了, path表达式的key必须被<code>&quot;&quot;</code>包含起来, 未被<code>&quot;&quot;</code>包含起来的key会被视为非法的.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"a fish"</span>: <span class="string">"shark"</span>, <span class="attr">"a bird"</span>: <span class="string">"sparrow"</span>&#125;</div></pre></td></tr></table></figure></p>
<p>这俩个key都包含了一个空格, 因此在path表达式中, 必须使用<code>&quot;&quot;</code>将key包含:</p>
<ul>
<li><code>$.&quot;a fish&quot;</code> 求值为 shark.</li>
<li><code>$.&quot;a bird&quot;</code> 求值为 to sparrow.</li>
</ul>
<p>如果在对数组求值时, path中的通配符会求值出多个结果.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT JSON_EXTRACT('&#123;"a": 1, "b": 2, "c": [3, 4, 5]&#125;', '$.*');</div><div class="line">+---------------------------------------------------------+</div><div class="line">| JSON_EXTRACT('&#123;"a": 1, "b": 2, "c": [3, 4, 5]&#125;', '$.*') |</div><div class="line">+---------------------------------------------------------+</div><div class="line">| [1, 2, [3, 4, 5]]                                       |</div><div class="line">+---------------------------------------------------------+</div><div class="line">mysql&gt; SELECT JSON_EXTRACT('&#123;"a": 1, "b": 2, "c": [3, 4, 5]&#125;', '$.c[*]');</div><div class="line">+------------------------------------------------------------+</div><div class="line">| JSON_EXTRACT('&#123;"a": 1, "b": 2, "c": [3, 4, 5]&#125;', '$.c[*]') |</div><div class="line">+------------------------------------------------------------+</div><div class="line">| [3, 4, 5]                                                  |</div><div class="line">+------------------------------------------------------------+</div></pre></td></tr></table></figure></p>
<p>在下面的例子中, <code>$**.b</code>会在多个path($.a.b 和 $.c.b)中进行求值, 然后将求值结果放到一个数组中:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT JSON_EXTRACT('&#123;"a": &#123;"b": 1&#125;, "c": &#123;"b": 2&#125;&#125;', '$**.b');</div><div class="line">+---------------------------------------------------------+</div><div class="line">| JSON_EXTRACT('&#123;"a": &#123;"b": 1&#125;, "c": &#123;"b": 2&#125;&#125;', '$**.b') |</div><div class="line">+---------------------------------------------------------+</div><div class="line">| [1, 2]                                                  |</div><div class="line">+---------------------------------------------------------+</div></pre></td></tr></table></figure></p>
<p>在MySQL 5.7.9 和以后的版本中, 你可以使用<code>column-&gt;path</code>代替方法<code>JSON_EXTRACT(column, path)</code>.</p>
<blockquote>
<p>更多参考See Section 13.16.3, “Functions That Search JSON Values” 以及 Section 14.1.18.6, “Secondary Indexes and Generated Virtual Columns”.</p>
</blockquote>
<p>在一些方法中, 会接受一个JSON文档, 然后对该JSON文档进行一些处理. 例如</p>
<ul>
<li><code>JSON_SET()</code></li>
<li><code>JSON_INSERT()</code></li>
<li><code>JSON_REPLACE()</code></li>
</ul>
<h2 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h2><p>我们生成一个JSON文档, 然后在下面的操作中使用这个文档:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SET @j = '["a", &#123;"b": [true, false]&#125;, [10, 20]]';</div></pre></td></tr></table></figure></p>
<p><code>JSON_SET()</code>会对已经存在的path替换, 不存在的进行添加:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT JSON_SET(@j, '$[1].b[0]', 1, '$[2][2]', 2);</div><div class="line">+--------------------------------------------+</div><div class="line">| JSON_SET(@j, '$[1].b[0]', 1, '$[2][2]', 2) |</div><div class="line">+--------------------------------------------+</div><div class="line">| ["a", &#123;"b": [1, false]&#125;, [10, 20, 2]]      |</div><div class="line">+--------------------------------------------+</div></pre></td></tr></table></figure></p>
<p>在上例中<code>$[1].b[0]</code>选择了一个已经存在的value，然后它被替换成了1. 但是<code>$[2][2]</code> 并不存在, 所以就在<code>$[2][2]</code>插入了值2.</p>
<p><code>JSON_INSERT()</code>向JSON文档中插入新的值, 但是如果path已经存在, 则会归一化处理, 不会覆盖原有的值:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT JSON_INSERT(@j, '$[1].b[0]', 1, '$[2][2]', 2);</div><div class="line">+-----------------------------------------------+</div><div class="line">| JSON_INSERT(@j, '$[1].b[0]', 1, '$[2][2]', 2) |</div><div class="line">+-----------------------------------------------+</div><div class="line">| ["a", &#123;"b": [true, false]&#125;, [10, 20, 2]]      |</div><div class="line">+-----------------------------------------------+</div></pre></td></tr></table></figure></p>
<h2 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h2><p><code>JSON_REPLACE()</code>执行替换操作, 但是如果path不存在的话, 不会进行插入操作:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT JSON_REPLACE(@j, '$[1].b[0]', 1, '$[2][2]', 2);</div><div class="line">+------------------------------------------------+</div><div class="line">| JSON_REPLACE(@j, '$[1].b[0]', 1, '$[2][2]', 2) |</div><div class="line">+------------------------------------------------+</div><div class="line">| ["a", &#123;"b": [1, false]&#125;, [10, 20]]             |</div><div class="line">+------------------------------------------------+</div></pre></td></tr></table></figure></p>
<blockquote>
<p><code>JSON_SET()</code>也会完成修改值的功能</p>
</blockquote>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><p><code>JSON_REMOVE()</code> 接受一个 JSON 文档以及一个或者多个要删除的path.  The return value is the original document minus the values selected by paths that exist within the document:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT JSON_REMOVE(@j, '$[2]', '$[1].b[1]', '$[1].b[1]');</div><div class="line">+---------------------------------------------------+</div><div class="line">| JSON_REMOVE(@j, '$[2]', '$[1].b[1]', '$[1].b[1]') |</div><div class="line">+---------------------------------------------------+</div><div class="line">| ["a", &#123;"b": [true]&#125;]                              |</div><div class="line">+---------------------------------------------------+</div></pre></td></tr></table></figure></p>
<p>这三个path产生了如下的效果</p>
<ul>
<li><code>$[2]</code>找到匹配[10, 20]值, 然后将其删除掉.</li>
<li>第一个<code>$[1].b[1]</code>匹配到了false值, 然后将其删除掉.</li>
<li>第二个<code>$[1].b[1]</code>没有匹配到任何值, 因此该操作不会有任何结果.</li>
</ul>
<h2 id="归一化处理"><a href="#归一化处理" class="headerlink" title="归一化处理"></a>归一化处理</h2><p>当一个字符串可以解析成一个有效的JSON文档, 它同时也会进行归一化处理. 当JSON中出现重复的Key时, 只会保留最开始的那个Key/Value, 接下来重复出现的都会抛弃掉.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT JSON_OBJECT('key1', 1, 'key2', 'abc', 'key1', 'def');</div><div class="line">+------------------------------------------------------+</div><div class="line">| JSON_OBJECT('key1', 1, 'key2', 'abc', 'key1', 'def') |</div><div class="line">+------------------------------------------------------+</div><div class="line">| &#123;"key1": 1, "key2": "abc"&#125;                           |</div><div class="line">+------------------------------------------------------+</div></pre></td></tr></table></figure></p>
<p>Mysql的归一化处理还会对JSON对象的key进行排序处理(以便查找时提供更好的性能). The result of this ordering is subject to change and not guaranteed to be consistent across releases. 另外, key或者value之间的空格会自动的被忽略掉.</p>
<p>同样的, Mysql中创建JSON的方法同样也都做了归一化处理.</p>
<p>当多个数组合并成一个数组时, 数组元素会依次存储进新的数组中, 如下面的<code>JSON_MERGE()</code>:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT JSON_MERGE('[1, 2]', '["a", "b"]', '[true, false]');</div><div class="line">+-----------------------------------------------------+</div><div class="line">| JSON_MERGE('[1, 2]', '["a", "b"]', '[true, false]') |</div><div class="line">+-----------------------------------------------------+</div><div class="line">| [1, 2, "a", "b", true, false]                       |</div><div class="line">+-----------------------------------------------------+</div></pre></td></tr></table></figure></p>
<h2 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h2><p>多个对象合并到一个对象中的时候, 如果多个对象中都出现了相同的key, 那么相同的key对应的value值会被放到该key对应的数组中.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT JSON_MERGE('&#123;"a": 1, "b": 2&#125;', '&#123;"c": 3, "a": 4&#125;');</div><div class="line">+----------------------------------------------------+</div><div class="line">| JSON_MERGE('&#123;"a": 1, "b": 2&#125;', '&#123;"c": 3, "a": 4&#125;') |</div><div class="line">+----------------------------------------------------+</div><div class="line">| &#123;"a": [1, 4], "b": 2, "c": 3&#125;                      |</div><div class="line">+----------------------------------------------------+</div></pre></td></tr></table></figure></p>
<p>当非数组类型的数据出现在要求数组为参数的上下文中时, 非数组类型的数据会自动被包装成数组类型(会自动在数据俩侧添加<code>[]</code>将其括起来). 在下面的例子中, 每一个参数都会被自动包装成([1], [2]), 然后产生一个新的数组.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT JSON_MERGE('1', '2');</div><div class="line">+----------------------+</div><div class="line">| JSON_MERGE('1', '2') |</div><div class="line">+----------------------+</div><div class="line">| [1, 2]               |</div><div class="line">+----------------------+</div></pre></td></tr></table></figure></p>
<p>当对象和数组进行合并时, 对象会自动的包装成一个数组, 然后将这俩个数组进行合并<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT JSON_MERGE('[10, 20]', '&#123;"a": "x", "b": "y"&#125;');</div><div class="line">+------------------------------------------------+</div><div class="line">| JSON_MERGE('[10, 20]', '&#123;"a": "x", "b": "y"&#125;') |</div><div class="line">+------------------------------------------------+</div><div class="line">| [10, 20, &#123;"a": "x", "b": "y"&#125;]                 |</div><div class="line">+------------------------------------------------+</div></pre></td></tr></table></figure></p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>在下面我们看一下除了增删改查之外的其他常用函数</p>
<h3 id="JSON-TYPE"><a href="#JSON-TYPE" class="headerlink" title="JSON_TYPE()"></a>JSON_TYPE()</h3><p><code>JSON_TYPE()</code>方法接受一个JSON串, 然后尝试解析它, 最后返回该JSON的数据类型<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT JSON_TYPE('["a", "b", 1]');</div><div class="line">+----------------------------+</div><div class="line">| JSON_TYPE('["a", "b", 1]') |</div><div class="line">+----------------------------+</div><div class="line">| ARRAY                      |</div><div class="line">+----------------------------+</div><div class="line"></div><div class="line">mysql&gt; SELECT JSON_TYPE('"hello"');</div><div class="line">+----------------------+</div><div class="line">| JSON_TYPE('"hello"') |</div><div class="line">+----------------------+</div><div class="line">| STRING               |</div><div class="line">+----------------------+</div><div class="line"></div><div class="line">mysql&gt; SELECT JSON_TYPE('hello');</div><div class="line">ERROR 3146 (22032): Invalid data type for JSON data in argument 1</div><div class="line">to function json_type; a JSON string or JSON type is required.</div></pre></td></tr></table></figure></p>
<p>MySQL 使用<code>utf8mb4</code>编码和<code>utf8mb4_bin</code>集合处理JSON 字符串内容. 其他的编码会被转换成utf8mb4编码. (ascii 和 utf8 编码并不会进行转换, 因为这俩个字符集是utf8mb4的子集.)</p>
<h3 id="创建JSON数组"><a href="#创建JSON数组" class="headerlink" title="创建JSON数组"></a>创建JSON数组</h3><p>除了使用字面量JSON串之外, Mysql还提供了很多创建JSON串的方法. 例如JSON_ARRAY()`函数接受一个参数列表(个数大于等于0), 然后返回一个JSON字符串数组.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT JSON_ARRAY('a', 1, NOW());</div><div class="line">+----------------------------------------+</div><div class="line">| JSON_ARRAY('a', 1, NOW())              |</div><div class="line">+----------------------------------------+</div><div class="line">| ["a", 1, "2015-07-27 09:43:47.000000"] |</div><div class="line">+----------------------------------------+</div></pre></td></tr></table></figure></p>
<h3 id="创建JSON对象"><a href="#创建JSON对象" class="headerlink" title="创建JSON对象"></a>创建JSON对象</h3><p><code>JSON_OBJECT()</code>接受一个key/value形式的参数列表, 返回一个包含那些元素的JSON对象:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT JSON_OBJECT('key1', 1, 'key2', 'abc');</div><div class="line">+---------------------------------------+</div><div class="line">| JSON_OBJECT('key1', 1, 'key2', 'abc') |</div><div class="line">+---------------------------------------+</div><div class="line">| &#123;"key1": 1, "key2": "abc"&#125;            |</div><div class="line">+---------------------------------------+</div></pre></td></tr></table></figure></p>
<h3 id="变量赋值"><a href="#变量赋值" class="headerlink" title="变量赋值"></a>变量赋值</h3><p>也可以将JSON赋给一个用户自定义的变量<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SET @j = JSON_OBJECT('key', 'value');</div><div class="line">mysql&gt; SELECT @j;</div><div class="line">+------------------+</div><div class="line">| @j               |</div><div class="line">+------------------+</div><div class="line">| &#123;"key": "value"&#125; |</div><div class="line">+------------------+</div></pre></td></tr></table></figure></p>
<p>在上例中, 尽管<code>JSON_OBJECT()</code>方法会返回一个JSON类型对象, 但是当将其赋给一个变量(<code>@j</code>)时, 它就被自动转换成了一个字符串类型.</p>
<p>JSON转换成的字符串, 它的编码是<code>utf8mb4</code>, 字符序为<code>utf8mb4_bin</code>:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT CHARSET(@j), COLLATION(@j);</div><div class="line">+-------------+---------------+</div><div class="line">| CHARSET(@j) | COLLATION(@j) |</div><div class="line">+-------------+---------------+</div><div class="line">| utf8mb4     | utf8mb4_bin   |</div><div class="line">+-------------+---------------+</div></pre></td></tr></table></figure></p>
<p>因为<code>utf8mb4_bin</code>是一种二进制的字符序, 因此在对比俩个JSON值是区分大小写的.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT JSON_ARRAY('x') = JSON_ARRAY('X');</div><div class="line">+-----------------------------------+</div><div class="line">| JSON_ARRAY('x') = JSON_ARRAY('X') |</div><div class="line">+-----------------------------------+</div><div class="line">|                                 0 |</div><div class="line">+-----------------------------------+</div></pre></td></tr></table></figure></p>
<h3 id="字面量"><a href="#字面量" class="headerlink" title="字面量"></a>字面量</h3><p>区分大小写同样支持JSON的<code>null</code>, <code>true</code>, <code>false</code>等字面量. 因此在引用他们的时候一定要小写.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT JSON_VALID('null'), JSON_VALID('Null'), JSON_VALID('NULL');</div><div class="line">+--------------------+--------------------+--------------------+</div><div class="line">| JSON_VALID('null') | JSON_VALID('Null') | JSON_VALID('NULL') |</div><div class="line">+--------------------+--------------------+--------------------+</div><div class="line">|                  1 |                  0 |                  0 |</div><div class="line">+--------------------+--------------------+--------------------+</div><div class="line"></div><div class="line">mysql&gt; SELECT CAST('null' AS JSON);</div><div class="line">+----------------------+</div><div class="line">| CAST('null' AS JSON) |</div><div class="line">+----------------------+</div><div class="line">| null                 |</div><div class="line">+----------------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure></p>
<h3 id="转换"><a href="#转换" class="headerlink" title="转换"></a>转换</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT CAST('NULL' AS JSON);</div><div class="line">ERROR 3141 (22032): Invalid JSON text in argument 1 to function cast_as_json:</div><div class="line">"Invalid value." at position 0 in 'NULL'.</div></pre></td></tr></table></figure>
<p>JSON字面量区分大小写与SQL中的不同. 在SQL中<code>NULL, TRUE, FALSE</code>等字面量可以写成由任意大小写组成:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT ISNULL(null), ISNULL(Null), ISNULL(NULL);</div><div class="line">+--------------+--------------+--------------+</div><div class="line">| ISNULL(null) | ISNULL(Null) | ISNULL(NULL) |</div><div class="line">+--------------+--------------+--------------+</div><div class="line">|            1 |            1 |            1 |</div><div class="line">+--------------+--------------+--------------+</div></pre></td></tr></table></figure></p>
<h2 id="比较和排序"><a href="#比较和排序" class="headerlink" title="比较和排序"></a>比较和排序</h2><p>JSON文档里面的value可以通过如下操作符进行比较操作</p>
<ul>
<li>=</li>
<li>&lt;</li>
<li>&lt;=</li>
<li>&gt;</li>
<li><blockquote>
<p>=</p>
</blockquote>
</li>
<li>&lt;&gt;</li>
<li>!=</li>
<li>&lt;=&gt;</li>
</ul>
<p>下面的比较操作符和方法并不支持JSON值</p>
<ul>
<li>BETWEEN</li>
<li>IN()</li>
<li>GREATEST()</li>
<li>LEAST()</li>
</ul>
<p>刚才列出的比较操作符和方法会将JSON值转换成MySQL原生的numeric或者string类型, 因此他们有一个consistent non-JSON扩展类型.</p>
<p>JSON值进行比较时会先根据JSON类型进行比较, 如果类型不同的话, 比较结果就决定于更高优先级的类型. 如果类型一样的话, 则会根据指定类型原则进行比较.</p>
<p>下面列出了JSON类型的优先级, 从高到低进行排序. 我们可以通过<code>JSON_TYPE()</code>来获取某个值得类型.</p>
<ul>
<li>BLOB</li>
<li>BIT</li>
<li>OPAQUE</li>
<li>DATETIME</li>
<li>TIME</li>
<li>DATE</li>
<li>BOOLEAN</li>
<li>ARRAY</li>
<li>OBJECT</li>
<li>STRING</li>
<li>INTEGER, DOUBLE</li>
<li>NULL<br>如果JSON值拥有相同的优先级的话, 那么不同的类型或根据下面介绍的规则进行比较:</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/数据库/">数据库</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/05/17/数据库/Mysql JSON Data Type/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/05/17/数据库/Mysql JSON Data Type/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/15/jvm/CRaSH 命令行/" title="CRaSH 安装启动" itemprop="url">CRaSH 安装启动</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-05-15T07:00:00.000Z" itemprop="datePublished"> 发表于 2016-05-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>CRaSH 的全名是 Common Reusable SHell . 网上对其介绍是: 基于 Java 发布提供与 JVM 进行交互的 SHELL 环境. 作为入门, 这篇文章介绍一下, 作为单独程序的使用.</p>
<p>我在mac上使用brew安装上里CRaSH, 大家可以根据自己的环境自行安装.</p>
<p>我启动了一个SpringBoot HTTP服务, 然后使用CRaSH连接到这个服务上.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</div><div class="line"></div><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="meta">@EnableAutoConfiguration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HTTPServer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="function">String <span class="title">home</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Hello World!"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        SpringApplication.run(HTTPServer.class, args);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后在命令行找到这个进程id<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">➜  ~ jps <span class="_">-l</span></div><div class="line">467</div><div class="line">488 org.jetbrains.idea.maven.server.RemoteMavenServer</div><div class="line">696 com.intellij.rt.execution.application.AppMain</div><div class="line">697 org.jetbrains.jps.cmdline.Launcher</div><div class="line">845 sun.tools.jps.Jps</div><div class="line">➜  ~ crash.sh 696</div><div class="line"></div><div class="line">   _____     ________                 _______    ____ ____</div><div class="line"> .<span class="string">'     `.  |        `.             .'</span>       `. |    |    | 1.3.0</div><div class="line">|    |    | |    |    |  .-------.  |    |    | |    |    |</div><div class="line">|    |____| |    `   .<span class="string">' |   _|    |  .    '</span>~_ ` |         |</div><div class="line">|    |    | |    .   `.  .~<span class="string">'      | | `~_    `| |         |</span></div><div class="line">|    |    | |    |    | |    |    | |    |    | |    |    |</div><div class="line"> `._____.'  |____|____| `.________|  `._____.<span class="string">'  |____|____|</span></div><div class="line"></div><div class="line">Follow and support the project on http://www.crashub.org</div><div class="line">Welcome to localhost + !</div><div class="line">It is Sun May 15 10:44:03 CST 2016 now</div><div class="line">%</div></pre></td></tr></table></figure></p>
<p>最后出现<code>%</code>说明我们已经连接到SpringBoot服务所在的虚拟机里了. 同样的在SpringBoot服务的日志里也有输出<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">2016-05-15 10:44:00.005  INFO 696 --- [Attach Listener] org.crsh.standalone.Agent                : CRaSH agent loaded</div><div class="line">2016-05-15 10:44:00.007  INFO 696 --- [Attach Listener] org.crsh.standalone.Agent                : Spawned CRaSH thread 23 <span class="keyword">for</span> further processing</div><div class="line">2016-05-15 10:44:00.097  INFO 696 --- [       Thread-3] org.crsh.standalone.Bootstrap            : Configuring property vfs.refresh_period=1 from properties</div><div class="line">2016-05-15 10:44:00.203  INFO 696 --- [       Thread-3] org.crsh.standalone.Bootstrap            : Configuring property ssh.port=2000 from properties</div><div class="line">2016-05-15 10:44:00.203  INFO 696 --- [       Thread-3] org.crsh.standalone.Bootstrap            : Configuring property ssh.auth_timeout=600000 from properties</div><div class="line">2016-05-15 10:44:00.204  INFO 696 --- [       Thread-3] org.crsh.standalone.Bootstrap            : Configuring property ssh.idle_timeout=600000 from properties</div><div class="line">2016-05-15 10:44:00.204  INFO 696 --- [       Thread-3] org.crsh.standalone.Bootstrap            : Configuring property ssh.default_encoding=UTF-8 from properties</div><div class="line">2016-05-15 10:44:00.204  INFO 696 --- [       Thread-3] org.crsh.standalone.Bootstrap            : Configuring property auth=simple from properties</div><div class="line">2016-05-15 10:44:00.204  INFO 696 --- [       Thread-3] org.crsh.standalone.Bootstrap            : Configuring property telnet.port=5000 from properties</div><div class="line">2016-05-15 10:44:00.204  INFO 696 --- [       Thread-3] org.crsh.standalone.Bootstrap            : Configuring property mail.debug=<span class="literal">false</span> from properties</div><div class="line">2016-05-15 10:44:00.205  INFO 696 --- [       Thread-3] org.crsh.standalone.Bootstrap            : Configuring property auth.simple.username=admin from properties</div><div class="line">2016-05-15 10:44:00.205  INFO 696 --- [       Thread-3] org.crsh.standalone.Bootstrap            : Configuring property auth.simple.password=admin from properties</div><div class="line">2016-05-15 10:44:02.111  INFO 696 --- [       Thread-6] net.wimpi.telnetd.net.PortListener       : Listening to Port 5,000 with a connectivity queue size of 5.</div><div class="line">2016-05-15 10:44:02.700  INFO 696 --- [       Thread-3] org.crsh.standalone.Agent                : Callback back remote on port 50656</div></pre></td></tr></table></figure></p>
<p>当我们在启动时, 还可以指定一些参数设置</p>
<ul>
<li><code>--cmd</code> : 这个选项用于指定, 我们要执行的命令所在的目录. 如果不指定的话, 会默认地从当前classpath下的<code>/crash/commands/</code>进行查找</li>
<li><code>--conf</code> : 用于指定配置文件所在的目录, 可以指定多个目录</li>
<li><code>--property</code> : <code>--cmd</code>可选参数, 可以覆盖配置文件中的配置, 示例<code>crash.sh --property crash.telnet.port=3000</code></li>
</ul>
<p>下面我们看一下在CRaSH中都可以使用哪些命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">% <span class="built_in">help</span></div><div class="line">Try one of these commands with the -h or --help switch:</div><div class="line"></div><div class="line">NAME      DESCRIPTION</div><div class="line">clock</div><div class="line">cron      manages the cron plugin</div><div class="line">dashboard a monitoring dashboard</div><div class="line">date      show the current time</div><div class="line">egrep     search file(s) <span class="keyword">for</span> lines that match a pattern</div><div class="line">env       display the term env</div><div class="line">filter    a filter <span class="keyword">for</span> a stream of map</div><div class="line">hello</div><div class="line">java      various java language commands</div><div class="line">jdbc      JDBC connection</div><div class="line">jmx       Java Management Extensions</div><div class="line">jndi      Java Naming and Directory Interface</div><div class="line">jpa       Java persistance API</div><div class="line">jul       java.util.logging commands</div><div class="line">jvm       JVM informations</div><div class="line">less      opposite of more</div><div class="line">mail      interact with emails</div><div class="line">man       format and display the on-line manual pages</div><div class="line">shell     shell related <span class="built_in">command</span></div><div class="line">sleep     sleep <span class="keyword">for</span> some time</div><div class="line">sort      sort a map</div><div class="line">system    vm system properties commands</div><div class="line">thread    JVM thread commands</div><div class="line"><span class="built_in">help</span>      provides basic <span class="built_in">help</span></div><div class="line">repl      list the repl or change the current repl</div></pre></td></tr></table></figure></p>
<p>CRaSH为我们提供了非常多的命令, 对于命令的具体用法, 大家可以使用<code>jvm --help</code>这样的用法具体看一下. CRaSH还提供了pipline, 我们可以使用<code>|</code>管道符使用多个命令.</p>
<p>具体的命令这篇文章就不再多介绍了, 下面我们看一下如何将CRaSH内嵌到Spring里. 为了简单, 我并没有直接使用CRaSH官网里介绍的那样, 使用xml配置Spring<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.crsh.spring.SpringBootstrap;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Properties;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        SpringBootstrap springBootstrap = <span class="keyword">new</span> SpringBootstrap();</div><div class="line">        Properties properties = <span class="keyword">new</span> Properties();</div><div class="line">        properties.setProperty(<span class="string">"crash.vfs.refresh_period"</span>, <span class="string">"1"</span>);</div><div class="line">        properties.setProperty(<span class="string">"crash.ssh.port"</span>, <span class="string">"2000"</span>);</div><div class="line">        properties.setProperty(<span class="string">"crash.ssh.idle_timeout"</span>, <span class="string">"3000000"</span>);</div><div class="line">        properties.setProperty(<span class="string">"crash.telnet.port"</span>, <span class="string">"5000"</span>);</div><div class="line">        properties.setProperty(<span class="string">"crash.ssh.auth_timeout"</span>, <span class="string">"300000"</span>);</div><div class="line">        properties.setProperty(<span class="string">"crash.auth"</span>, <span class="string">"simple"</span>);</div><div class="line">        properties.setProperty(<span class="string">"crash.auth.simple.username"</span>, <span class="string">"admin"</span>);</div><div class="line">        properties.setProperty(<span class="string">"crash.auth.simple.password"</span>, <span class="string">"admin"</span>);</div><div class="line">        springBootstrap.setConfig(properties);</div><div class="line"></div><div class="line">        TimeUnit.DAYS.sleep(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后启动一个客户端<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">➜  ~ telnet localhost 5000</div><div class="line">Trying ::1...</div><div class="line">Connected to localhost.</div><div class="line">Escape character is <span class="string">'^]'</span>.</div><div class="line"></div><div class="line">   _____     ________                 _______    ____ ____</div><div class="line"> .<span class="string">'     `.  |        `.             .'</span>       `. |    |    | 1.3.0</div><div class="line">|    |    | |    |    |  .-------.  |    |    | |    |    |</div><div class="line">|    |____| |    `   .<span class="string">' |   _|    |  .    '</span>~_ ` |         |</div><div class="line">|    |    | |    .   `.  .~<span class="string">'      | | `~_    `| |         |</span></div><div class="line">|    |    | |    |    | |    |    | |    |    | |    |    |</div><div class="line"> `._____.'  |____|____| `.________|  `._____.<span class="string">'  |____|____|</span></div><div class="line"></div><div class="line">Follow and support the project on http://www.crashub.org</div><div class="line">Welcome to localhost + !</div><div class="line">It is Sun May 15 11:29:56 CST 2016 now</div><div class="line"></div><div class="line">%</div></pre></td></tr></table></figure></p>
<p>通过telnet, 我们也成功连接进来了.</p>
<p>这个需要添加的CRaSH的maven依赖有<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- http://mvnrepository.com/artifact/org.crashub/crash.shell --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.crashub<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>crash.shell<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- http://mvnrepository.com/artifact/org.crashub/crash.cli --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.crashub<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>crash.cli<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- http://mvnrepository.com/artifact/org.crashub/crash.packaging --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.crashub<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>crash.packaging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- http://mvnrepository.com/artifact/org.crashub/crash.embed.spring --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.crashub<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>crash.embed.spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/05/15/jvm/CRaSH 命令行/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/05/15/jvm/CRaSH 命令行/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/12/JavaLibrary/log4j2/" title="Log4J2 笔记" itemprop="url">Log4J2 笔记</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-05-11T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-05-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>Log4J2会使用<code>ConfigurationFactory</code>从classpath上依次尝试加载下面的配置文件, 一旦找到就停止查找过程</p>
<ol>
<li>log4j.configurationFil</li>
<li>log4j2-test.properties</li>
<li>log4j2-test.yaml or log4j2-test.yml</li>
<li>log4j2-test.json or log4j2-test.jsn</li>
<li>log4j2-test.xml</li>
<li>log4j2.properties</li>
<li>log4j2.yaml or log4j2.yml</li>
<li>log4j2.json or log4j2.jsn</li>
<li>log4j2.xml<br>从上面的配置文件,我们可以看到Log4J2支持, JSON, YAML, properties, XML 等四种格式的配置文件.</li>
</ol>
<p>如果找不到配置文件的话, 就会使用默认的配置</p>
<ul>
<li>想root logger 关联一个ConsoleAppender (root logger的默认等级是Level.ERROR)</li>
<li>ConsoleAppender指定一个PatternLayout, 其格式内容为<code>%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n</code></li>
</ul>
<p>官网给出了一个简单的示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.foo.Bar;</div><div class="line"><span class="keyword">import</span> org.apache.logging.log4j.Logger;</div><div class="line"><span class="keyword">import</span> org.apache.logging.log4j.LogManager;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="comment">// Define a static logger variable so that it references the</span></div><div class="line">    <span class="comment">// Logger instance named "MyApp".</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LogManager.getLogger(MyApp.class);</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String... args)</span> </span>&#123;</div><div class="line"> </div><div class="line">        <span class="comment">// Set up a simple configuration that logs on the console.</span></div><div class="line"> </div><div class="line">        logger.trace(<span class="string">"Entering application."</span>);</div><div class="line">        Bar bar = <span class="keyword">new</span> Bar();</div><div class="line">        <span class="keyword">if</span> (!bar.doIt()) &#123;</div><div class="line">            logger.error(<span class="string">"Didn't do it."</span>);</div><div class="line">        &#125;</div><div class="line">        logger.trace(<span class="string">"Exiting application."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">package</span> com.foo;</div><div class="line"><span class="keyword">import</span> org.apache.logging.log4j.Logger;</div><div class="line"><span class="keyword">import</span> org.apache.logging.log4j.LogManager;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bar</span> </span>&#123;</div><div class="line">  <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LogManager.getLogger(Bar.class.getName());</div><div class="line"> </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">doIt</span><span class="params">()</span> </span>&#123;</div><div class="line">    logger.entry();</div><div class="line">    logger.error(<span class="string">"Did it again!"</span>);</div><div class="line">    <span class="keyword">return</span> logger.exit(<span class="keyword">false</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>配置文件为<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">status</span>=<span class="string">"WARN"</span> <span class="attr">monitorInterval</span>=<span class="string">"30"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"Console"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_OUT"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d&#123;HH:mm:ss.SSS&#125; [%t] %-5level %logger&#123;36&#125; - %msg%n"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">"error"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"Console"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>输出结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">17:13:01.540 [main] TRACE MyApp - Entering application.</div><div class="line">17:13:01.540 [main] TRACE com.foo.Bar - entry</div><div class="line">17:13:01.540 [main] ERROR com.foo.Bar - Did it again!</div><div class="line">17:13:01.540 [main] TRACE com.foo.Bar - <span class="built_in">exit</span> with (<span class="literal">false</span>)</div><div class="line">17:13:01.540 [main] ERROR MyApp - Didn<span class="string">'t do it.</span></div><div class="line">17:13:01.540 [main] TRACE MyApp - Exiting application.</div></pre></td></tr></table></figure></p>
<p>我们在配置里使用了一个<code>monitorInterval</code>属性, 这个属性是用来监控日志文件的, 每隔多少秒刷新一次.</p>
<p>下面我们展示一个只有<code>com.foo.Bar</code>才会trace全部日志, 而其他的日志则只会输出ERROR级别的.<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">status</span>=<span class="string">"WARN"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"Console"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_OUT"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"%d&#123;HH:mm:ss.SSS&#125; [%t] %-5level %logger&#123;36&#125; - %msg%n"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Logger</span> <span class="attr">name</span>=<span class="string">"com.foo.Bar"</span> <span class="attr">level</span>=<span class="string">"trace"</span> <span class="attr">additivity</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"Console"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Logger</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">"error"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"Console"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">17:13:01.540 [main] TRACE com.foo.Bar - entry</div><div class="line">17:13:01.540 [main] ERROR com.foo.Bar - Did it again!</div><div class="line">17:13:01.540 [main] TRACE com.foo.Bar - <span class="built_in">exit</span> (<span class="literal">false</span>)</div><div class="line">17:13:01.540 [main] ERROR MyApp - Didn<span class="string">'t do it.</span></div></pre></td></tr></table></figure></p>
<p>需要注意的是,我们在com.foo.Bar这个Logger后面添加了一个<code>additivity=&quot;false&quot;</code>的属性.</p>
<p>关于日志级别我们来测试一下, 我们写一个Java程序<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestLevel</span> </span>&#123;</div><div class="line">	<span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LogManager.getLogger(TestLookups.class.getName());</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"></div><div class="line">		logger.trace(<span class="string">"test"</span>);</div><div class="line">		logger.debug(<span class="string">"test"</span>);</div><div class="line">		logger.info(<span class="string">"test"</span>);</div><div class="line">		logger.warn(<span class="string">"test"</span>);</div><div class="line">		logger.error(<span class="string">"test"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>log4j2的配置文件为<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">status</span>=<span class="string">"WARN"</span> <span class="attr">monitorInterval</span>=<span class="string">"30"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"Console"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_OUT"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d %p %c&#123;1.&#125; [%t] $$&#123;ctx:loginId&#125; %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">"trace"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"Console"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">2016-05-12 18:29:55,570 TRACE t.TestLookups [main] <span class="variable">$&#123;ctx:loginId&#125;</span> <span class="built_in">test</span></div><div class="line">2016-05-12 18:29:55,571 DEBUG t.TestLookups [main] <span class="variable">$&#123;ctx:loginId&#125;</span> <span class="built_in">test</span></div><div class="line">2016-05-12 18:29:55,572 INFO t.TestLookups [main] <span class="variable">$&#123;ctx:loginId&#125;</span> <span class="built_in">test</span></div><div class="line">2016-05-12 18:29:55,572 WARN t.TestLookups [main] <span class="variable">$&#123;ctx:loginId&#125;</span> <span class="built_in">test</span></div><div class="line">2016-05-12 18:29:55,572 ERROR t.TestLookups [main] <span class="variable">$&#123;ctx:loginId&#125;</span> <span class="built_in">test</span></div></pre></td></tr></table></figure></p>
<p>级别改为debug后结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2016-05-12 18:30:13,574 DEBUG t.TestLookups [main] <span class="variable">$&#123;ctx:loginId&#125;</span> <span class="built_in">test</span></div><div class="line">2016-05-12 18:30:13,575 INFO t.TestLookups [main] <span class="variable">$&#123;ctx:loginId&#125;</span> <span class="built_in">test</span></div><div class="line">2016-05-12 18:30:13,575 WARN t.TestLookups [main] <span class="variable">$&#123;ctx:loginId&#125;</span> <span class="built_in">test</span></div><div class="line">2016-05-12 18:30:13,575 ERROR t.TestLookups [main] <span class="variable">$&#123;ctx:loginId&#125;</span> <span class="built_in">test</span></div></pre></td></tr></table></figure></p>
<p>级别改为info后结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">2016-05-12 18:30:43,042 INFO t.TestLookups [main] <span class="variable">$&#123;ctx:loginId&#125;</span> <span class="built_in">test</span></div><div class="line">2016-05-12 18:30:43,043 WARN t.TestLookups [main] <span class="variable">$&#123;ctx:loginId&#125;</span> <span class="built_in">test</span></div><div class="line">2016-05-12 18:30:43,044 ERROR t.TestLookups [main] <span class="variable">$&#123;ctx:loginId&#125;</span> <span class="built_in">test</span></div></pre></td></tr></table></figure></p>
<p>级别改为warn后结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">2016-05-12 18:31:18,095 WARN t.TestLookups [main] <span class="variable">$&#123;ctx:loginId&#125;</span> <span class="built_in">test</span></div><div class="line">2016-05-12 18:31:18,096 ERROR t.TestLookups [main] <span class="variable">$&#123;ctx:loginId&#125;</span> <span class="built_in">test</span></div></pre></td></tr></table></figure></p>
<p>级别改为error后结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2016-05-12 18:31:43,894 ERROR t.TestLookups [main] <span class="variable">$&#123;ctx:loginId&#125;</span> <span class="built_in">test</span></div></pre></td></tr></table></figure></p>
<p>如果出现重复日志输出, 多半原因因为, root收集到了子logger反馈的日志, 只需要将子logger设置为<code>additivity=&quot;false&quot;</code>就可以了,例如<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">status</span>=<span class="string">"WARN"</span> <span class="attr">monitorInterval</span>=<span class="string">"30"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"Console"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_OUT"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d %p %c&#123;1.&#125; [%t] $$&#123;ctx:loginId&#125; %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Logger</span> <span class="attr">name</span>=<span class="string">"stdout"</span> <span class="attr">level</span>=<span class="string">"info"</span> <span class="attr">additivity</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"Console"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">Logger</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">"trace"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"Console"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>动态修改日志级别<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> LoggerContext ctx = (LoggerContext) LogManager.getContext(<span class="keyword">false</span>);</div><div class="line"><span class="keyword">final</span> Configuration config = ctx.getConfiguration();</div><div class="line"></div><div class="line">LoggerConfig loggerConfig = config.getLoggerConfig(logger.getName());</div><div class="line">LoggerConfig specificConfig = loggerConfig;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!loggerConfig.getName().equals(logger.getName())) &#123;</div><div class="line">	specificConfig = <span class="keyword">new</span> LoggerConfig(logger.getName(), level, <span class="keyword">true</span>);</div><div class="line">	specificConfig.setParent(loggerConfig);</div><div class="line">	config.addLogger(logger.getName(), specificConfig);</div><div class="line">&#125;</div><div class="line">specificConfig.setLevel(level);</div><div class="line">ctx.updateLoggers();</div></pre></td></tr></table></figure></p>
<h2 id="Appender"><a href="#Appender" class="headerlink" title="Appender"></a>Appender</h2><p>Log4j2为我们提供了非常多的Appender, 我们就是通过Appender最终将日志输出到磁盘的.</p>
<ul>
<li>Async</li>
<li>Console</li>
<li>Failover</li>
<li>File</li>
<li>Flume</li>
<li>JDBC</li>
<li>JMS Queue</li>
<li>JMS Topic</li>
<li>JPA</li>
<li>Kafka</li>
<li>Memory Mapped File</li>
<li>NoSQL</li>
<li>Output Stream</li>
<li>Random Access File</li>
<li>Rewrite</li>
<li>Rolling File</li>
<li>Rolling Random Access File</li>
<li>Routing</li>
<li>SMTP</li>
<li>Socket</li>
<li>Syslog</li>
<li>ZeroMQ/JeroMQ</li>
</ul>
<h2 id="AsyncAppender"><a href="#AsyncAppender" class="headerlink" title="AsyncAppender"></a>AsyncAppender</h2><p>首先我们看一下AsyncAppender。 AsyncAppender通过一个单独的线程将LogEvent发送给它内部代理的其他的Appender，业务逻辑线程可以快速返回调用。AsyncAppender内部封装了一个<code>java.util.concurrent.ArrayBlockingQueue</code>用于接收日志事件。在多线程的情况下并不推荐使用这个Appender，因为BlockingQueue对于锁争夺是非常敏感的，在多线程并发写日志的时候，性能会下降。<br>官方推荐使用<a href="http://logging.apache.org/log4j/2.x/manual/async.html" target="_blank" rel="external">lock-free Async Loggers</a></p>
<p>下来我们看一下这个Appender的几个重点参数</p>
<ul>
<li>blocking：如果设置为tue的话(默认值), 当BlockingQueue满的时候，新的日志文件会一直阻塞, 直到可以入列为止. 如果为false的话, 不能入列的日志会被写到 error appender 里。</li>
<li>bufferSize：队列里的最大日志事件数量(默认是128)</li>
<li>errorRef：当没有Appender可用或者写日志发生错误或者队列满的时候，新的日志事件会被写到这个errorRef里。如果不设置的话，那些日志都会丢失<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">status</span>=<span class="string">"warn"</span> <span class="attr">name</span>=<span class="string">"MyApp"</span> <span class="attr">packages</span>=<span class="string">""</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">File</span> <span class="attr">name</span>=<span class="string">"MyFile"</span> <span class="attr">fileName</span>=<span class="string">"logs/app.log"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">PatternLayout</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Pattern</span>&gt;</span>%d %p %c&#123;1.&#125; [%t] %m%n<span class="tag">&lt;/<span class="name">Pattern</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">File</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Async</span> <span class="attr">name</span>=<span class="string">"Async"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"MyFile"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Async</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">"error"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"Async"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="MemoryMappedFileAppender"><a href="#MemoryMappedFileAppender" class="headerlink" title="MemoryMappedFileAppender"></a>MemoryMappedFileAppender</h2><p>MemoryMappedFileAppender是在2.1的版本是行新增加的。 其通过将指定的文件映射到内存，然后将日志直接写到映射内存里。这个Appender主要依赖于操作系统的虚拟内存将映射内存里的数据同步到磁盘上。相比与传统的通过系统调用方式将数据写到磁盘上，这里只是将数据同步到内存里。速度提升了很多倍。在大多数的操作系统里，memory region实际上映射的是内核区的page cache，这意味着，在用户空间之内就不需要再创建一份数据拷贝了。</p>
<p>但是将一个文件映射到内存里还是有一些消耗的，特别是映射一些特别大的文件(500M以上)，默认的region大小是32M。</p>
<p>和FileAppender和RandomAccessFileAppender很像，MemoryMappedFileAppender使用MemoryMappedFileManager来执行IO操作。</p>
<p>同样的来看几个比较重要的属相</p>
<ul>
<li>append：新的日志事件是否追加在日志文件末尾（如果不是原先的内容会被刷新掉）</li>
<li>regionLength：映射的region的大小，默认是32M。这个值必须在<code>256</code>和<code>1,073,741,824</code>字节之间。</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line">&lt;Configuration status="warn" name="MyApp" packages=""&gt;</div><div class="line">  &lt;Appenders&gt;</div><div class="line">    &lt;MemoryMappedFile name="MyFile" fileName="logs/app.log"&gt;</div><div class="line">      &lt;PatternLayout&gt;</div><div class="line">        &lt;Pattern&gt;%d %p %c&#123;1.&#125; [%t] %m%n&lt;/Pattern&gt;</div><div class="line">      &lt;/PatternLayout&gt;</div><div class="line">    &lt;/MemoryMappedFile&gt;</div><div class="line">  &lt;/Appenders&gt;</div><div class="line">  &lt;Loggers&gt;</div><div class="line">    &lt;Root level="error"&gt;</div><div class="line">      &lt;AppenderRef ref="MyFile"/&gt;</div><div class="line">    &lt;/Root&gt;</div><div class="line">  &lt;/Loggers&gt;</div><div class="line">&lt;/Configuration&gt;</div></pre></td></tr></table></figure>
<h2 id="RandomAccessFileAppender"><a href="#RandomAccessFileAppender" class="headerlink" title="RandomAccessFileAppender"></a>RandomAccessFileAppender</h2><p>RandomAccessFileAppender与标准的<code>FileAppender</code>非常像, 只不过RandomAccessFileAppender不能像FileAppender关闭缓冲功能。RandomAccessFileAppender内部使用<code>ByteBuffer</code> 和 <code>RandomAccessFile</code>实现(FileAppender基于BufferedOutputStream)</p>
<p>在官方的测试中RandomAccessFileAppender比开启了缓冲功能的FileAppender的性能提升了<code>20 ~ 200</code>倍.</p>
<ul>
<li>append:新的日志事件是否追加在日志文件末尾（如果不是原先的内容会被刷新掉）</li>
<li>immediateFlush: 设置为true的话(默认为true)，每一次写入都会强制执行一次flush, 这种情况下回保证数据肯定被写到磁盘上,但是对性能有消耗. 只有当使用同步logger的时候，每一次写入日志都flush才有意义。这是因为当使用异步logger或者Appender的时候，当events达到固定数量的时候回自动执行flush操作（即使immediateFlush为false,也会执行刷新），使用异步的方式同样保证数据会写入到磁盘而且更高效。</li>
<li>bufferSize：缓冲大小，默认是 262,144 bytes (256 * 1024).<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">status</span>=<span class="string">"warn"</span> <span class="attr">name</span>=<span class="string">"MyApp"</span> <span class="attr">packages</span>=<span class="string">""</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">RandomAccessFile</span> <span class="attr">name</span>=<span class="string">"MyFile"</span> <span class="attr">fileName</span>=<span class="string">"logs/app.log"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">PatternLayout</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Pattern</span>&gt;</span>%d %p %c&#123;1.&#125; [%t] %m%n<span class="tag">&lt;/<span class="name">Pattern</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">RandomAccessFile</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">"error"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"MyFile"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="异步日志"><a href="#异步日志" class="headerlink" title="异步日志"></a>异步日志</h2><p>采用异步的方式记录日志首先是AsyncLogger</p>
<ol>
<li>异步日志通过在单独的线程中记录日志，能快速地返回日志调用。通常来说如果所有的logger都采用异步的方式的话，能获得最好的性能</li>
<li>异步日志内部采用了Disruptor取代了java内部队列。这个特性能获得更高的吞吐量和更低的延迟。</li>
<li>异步日志通过缓存方式，批量将日志输出<br>尽管异步日志有诸多特性，但是有时候仍然是需要采用同步地方式记录日志。我们下来首先看一下异步日志的优点：</li>
<li>更高的吞吐量。异步日志与同步方式相比，它能提供6~68倍的日志输出量。当突然遇到日志洪峰时,采用异步方式能获得更快地日志响应</li>
<li>更低的延迟. 异步日志比同步方式记录日志和采用基于队列实现的异步日志方式都获得了更低的延迟。<br>下面我们再看看异步记录方式的缺点</li>
<li>当在写日志的时候，如果发生了问题或者抛出了异常，使用异步记录方式很难定位问题究竟是出现在哪里。因此在异步日志里推荐配置一个<code>ExceptionHandler</code>，但是哪怕配置了一个handler，仍然有可能出现日志丢失等问题。因为对于日志依赖严重的地方，推荐使用同步方式记录日志</li>
<li>在单核的情况下，异步日志并不能获得更好地性能。当然现在的服务器动辄就是16核，32核，这个情况一般就不考虑了。<br>最后我们看一下如果所有的日志都采用异步方式的配置方式<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-DLog4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector</div></pre></td></tr></table></figure>
</li>
</ol>
<p>当我们在java进程的启动脚本里进行了这样的配置后(我们也可以在程序启动后再系统属性里进行设置)，log4j会采用<code>AsyncLoggerContextSelector</code>进行异步日志输出。但是在配置文件里要使用<code>&lt;root&gt;</code>和<code>&lt;logger&gt;</code>,不能使用<code>&lt;asyncRoot&gt;</code>和<code>&lt;asyncLogger&gt;</code>, 因为这种异步的logger是为了在同步异步混合logger的时候使用的。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/05/12/JavaLibrary/log4j2/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/05/12/JavaLibrary/log4j2/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/11/JavaLibrary/Oracle Solaris Studio/" title="Oracle® Solaris Studio" itemprop="url">Oracle® Solaris Studio</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-05-10T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-05-11</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>在Centos上安装Oracle® Solaris Studio.  <a href="http://docs.oracle.com/cd/E27071_01/html/E26451/gemyt.html#scrolltoc" target="_blank" rel="external">中文教程</a></p>
<p>首先执行下列命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">yum install glibc</div><div class="line">yum install elfutils-libelf-devel</div><div class="line">yum install zlib</div><div class="line">yum install libstdc++</div><div class="line">yum install libgcc</div></pre></td></tr></table></figure></p>
<p>执行完之后, 会将下列依赖包安装完成<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">glibc</div><div class="line">glibc.i686</div><div class="line">glibc-devel</div><div class="line">glibc-devel.i686</div><div class="line">elfutils-libelf-devel </div><div class="line">elfutils-libelf-devel.i686</div><div class="line">zlib</div><div class="line">zlib.i686</div><div class="line">libstdc++</div><div class="line">libstdc++.i686</div><div class="line">libgcc</div><div class="line">libgcc.i686</div></pre></td></tr></table></figure></p>
<ol>
<li>在<a href="http://www.oracle.com/technetwork/server-storage/solarisstudio/downloads/index.html" target="_blank" rel="external">下载界面</a>下载Oracle Linux/ Red Hat Linux - RPM installer on x86 </li>
<li>运行命令解压<code>bzcat download_directory/SolarisStudio12.4-linux-x86-rpm.tar.bz2 | /bin/tar -xf -</code></li>
<li>进行安装<code>./solarisstudio.sh --non-interactive</code>(包含GUI, 也就是我们可以在Linux的桌面上打开Solaris Studio IDE)</li>
<li>验证是否安装成功<code>/opt/oracle/solarisstudio12.4/bin/analyzer -v</code></li>
</ol>
<p>安装完成后会显示<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Configuring the installer...</div><div class="line">Searching <span class="keyword">for</span> JVM on the system...</div><div class="line">Extracting installation data (can take a <span class="keyword">while</span>, please <span class="built_in">wait</span>)...</div><div class="line">Running the installer wizard...</div><div class="line">/tmp/ossi-c2x_<span class="built_in">test</span>-20160509142618.silent.log:</div><div class="line">[2016-05-09 14:26:18.764]: WARNING - Your OS distribution is not supported. The list of supported systems can be found <span class="keyword">in</span> the Oracle Solaris Studio documentation. While it might be possible to install Oracle Solaris Studio on your system, it might not <span class="keyword">function</span> properly.</div></pre></td></tr></table></figure></p>
<p>运行<code>analyzer -v</code>显示<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">analyzer: Oracle Solaris Studio 12.4 Performance Analyzer 12.4 Linux_x64 2014/10/21</div><div class="line">Java at /usr/java/jdk1.8.0_25/bin/java selected by PATH</div><div class="line">java version <span class="string">"1.8.0_25"</span></div><div class="line">Java(TM) SE Runtime Environment (build 1.8.0_25-b17)</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.25-b02, mixed mode)</div><div class="line">WARNING: Linux CentOS_6.7 system <span class="string">"c2x_test"</span> is not supported by the Performance tools.</div><div class="line">Running /usr/java/jdk1.8.0_25/bin/java -version</div><div class="line">/opt/oracle/solarisstudio12.4/bin/analyzer: ERROR: environment variable DISPLAY is not <span class="built_in">set</span></div></pre></td></tr></table></figure></p>
<p>额外事项</p>
<ol>
<li>卸载程序 <code>/opt/oracle/solarisstudio12.4/uninstall.sh --non-interactive</code></li>
<li>如果安装时不想要GUI, 只需要在后面加上<code>--libraries-only</code>就好了</li>
<li>设置环境变量 <code>vi /ect/profile</code> 修改<code>PATH=$PATH:/opt/oracle/solarisstudio12.4/bin/</code></li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/05/11/JavaLibrary/Oracle Solaris Studio/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/05/11/JavaLibrary/Oracle Solaris Studio/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/10/数据库/Mysql Secondary Indexes and Generated Virtual Columns/" title="Mysql 第二索引和虚拟列" itemprop="url">Mysql 第二索引和虚拟列</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-05-10T07:00:00.000Z" itemprop="datePublished"> 发表于 2016-05-10</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://dev.mysql.com/doc/refman/5.7/en/create-table-secondary-indexes-virtual-columns.html" target="_blank" rel="external">官方文档</a></p>
<h2 id="Generated-Columns"><a href="#Generated-Columns" class="headerlink" title="Generated Columns"></a>Generated Columns</h2><p>generated column是由普通column生成的列.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE sum (</div><div class="line">  num1 int,</div><div class="line">  num2 int,</div><div class="line">  sum int AS (num1 + num2)</div><div class="line">);</div><div class="line"></div><div class="line">INSERT INTO sum (num1, num2) VALUES(1,1),(3,4);</div><div class="line">mysql&gt; SELECT * FROM sum;</div><div class="line">+-------+-------+--------------------+</div><div class="line">| num1  | num2  | sum                |</div><div class="line">+-------+-------+--------------------+</div><div class="line">|     1 |     1 |                  2 |</div><div class="line">|     3 |     4 |                  7 |</div><div class="line">+-------+-------+--------------------+</div></pre></td></tr></table></figure></p>
<p>在上面的实例中我们首先创建了一个sum表，然后插入俩条数据数据 我们发现sum这一列上自动生成一个值</p>
<p>这种自动生成列的语法为为<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">col_name data_type [GENERATED ALWAYS] AS (expression)</div><div class="line">  [VIRTUAL | STORED] [UNIQUE [KEY]] [COMMENT comment]</div><div class="line">  [[NOT] NULL] [[PRIMARY] KEY]</div></pre></td></tr></table></figure></p>
<ul>
<li>VIRTUAL: 不存储值到磁盘上</li>
<li>STORED : 将值存储到磁盘上</li>
</ul>
<h2 id="Secondary-Indexes"><a href="#Secondary-Indexes" class="headerlink" title="Secondary Indexes"></a>Secondary Indexes</h2><p>从MySQL5.7.8开始, InnoDB引擎基于自生成(generated virtual columns)的虚拟列支持辅助索引索引(secondary indexes, 并不支持其他索引, 例如簇索引等).</p>
<p>secondary indexe可以基于一个, 多个, 组合virtual columns或者非generated virtual columns生成。当基于virtual column的secondary index可以由<code>UNIQUE</code>进行定义.</p>
<p>当基于generated virtual column创建的secondary index, generated column的值就体现在了这个secondary index的记录上. 如果这个索引是一个covering index, generated column值是从索引中已经生成的值进行索引, 而不是再自己计算一遍.</p>
<blockquote>
<p>covering index 查询时检索所有的column.</p>
</blockquote>
<p>在执行<code>INSERT</code>和<code>UPDATE</code>这样的写操作时, 如果用到了基于virtual column的辅助索引时, 那么生成virtual column时会产生额外的性能消耗. 甚至当使用STORED generated columns时, 写操作会带来更多的性能消耗, 还有更多的内存和磁盘消耗. 如果secondary index不是基于virtual column, 当产生读操作时会带来更多的性能消耗, 这是因为virtual column的值每当该column的列被检查时都会计算一次.</p>
<p>当发生回滚或者清除操作时, 被索引过的virtual column已经经过里MVCC-logged, 如此一来就可以以避免再计算一次. logged值的长度是由索引长度限制的, <code>COMPACT</code>和<code>REDUNDANT</code>是767字节, <code>DYNAMIC</code>和<code>COMPRESSED</code>是3072个字节.</p>
<p>在virtual column 上增加或者删除secondary index是一个内置的操作.</p>
<p>virtual column 上的secondary index不能成为外键的索引. 同样secondary index的virtual column也不能指向外键, 而且也不能使用如下的语句定义</p>
<ul>
<li>ON DELETE CASCADE</li>
<li>ON DELETE SET NULL</li>
<li>ON UPDATE CASCADE</li>
<li>ON UPDATE SET NULL.</li>
</ul>
<h2 id="Generated-Virtual-Column索引JSON-Column上"><a href="#Generated-Virtual-Column索引JSON-Column上" class="headerlink" title="Generated Virtual Column索引JSON Column上"></a>Generated Virtual Column索引JSON Column上</h2><p>JSON columns是不能被直接索引的. 但是我们可以通过创建一个generated column来间接为JSON columns生成一个索引, 如下例:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">mysql&gt; CREATE TABLE jemp (</div><div class="line">    -&gt;     c JSON,</div><div class="line">    -&gt;     g INT GENERATED ALWAYS AS (JSON_EXTRACT(c, '$.id')),</div><div class="line">    -&gt;     INDEX i (g)</div><div class="line">    -&gt; );</div><div class="line">Query OK, 0 rows affected (0.28 sec)</div><div class="line"></div><div class="line">mysql&gt; INSERT INTO jemp (c) VALUES</div><div class="line">     &gt;   ('&#123;"id": "1", "name": "Fred"&#125;'), ('&#123;"id": "2", "name": "Wilma"&#125;'),</div><div class="line">     &gt;   ('&#123;"id": "3", "name": "Barney"&#125;'), ('&#123;"id": "4", "name": "Betty"&#125;');</div><div class="line">Query OK, 4 rows affected (0.04 sec)</div><div class="line">Records: 4  Duplicates: 0  Warnings: 0</div><div class="line"></div><div class="line">mysql&gt; SELECT JSON_UNQUOTE(JSON_EXTRACT(c, '$.name')) AS name</div><div class="line">     &gt;     FROM jemp WHERE g &gt; 2;</div><div class="line">+--------+</div><div class="line">| name   |</div><div class="line">+--------+</div><div class="line">| Barney |</div><div class="line">| Betty  |</div><div class="line">+--------+</div><div class="line">2 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; EXPLAIN SELECT JSON_UNQUOTE(JSON_EXTRACT(c, '$.name')) AS name</div><div class="line">     &gt;    FROM jemp WHERE g &gt; 2\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: SIMPLE</div><div class="line">        table: jemp</div><div class="line">   partitions: NULL</div><div class="line">         type: range</div><div class="line">possible_keys: i</div><div class="line">          key: i</div><div class="line">      key_len: 5</div><div class="line">          ref: NULL</div><div class="line">         rows: 2</div><div class="line">     filtered: 100.00</div><div class="line">        Extra: Using where</div><div class="line">1 row in set, 1 warning (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SHOW WARNINGS\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">  Level: Note</div><div class="line">   Code: 1003</div><div class="line">Message: /* select#1 */ select json_unquote(json_extract(`test`.`jemp`.`c`,'$.name'))</div><div class="line">AS `name` from `test`.`jemp` where (`test`.`jemp`.`g` &gt; 2)</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure></p>
<blockquote>
<p>关于上例中创建表的更多信息参考 <a href="">Section 9.3.9, “Optimizer Use of Generated Column Indexes”</a></p>
</blockquote>
<p>在Mysql 5.7.9以后, 你可以使用<code>-&gt;</code>替代<code>JSON_EXTRACT()</code>作为path访问JSON列.</p>
<p>当你使用<code>EXPLAIN</code>的语句中包含了一个或者多个<code>-&gt;</code>操作符时, 它们会被<code>JSON_EXTRACT()</code>进行替换.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">mysql&gt; EXPLAIN SELECT c-&gt;"$.name"</div><div class="line">     &gt; FROM jemp WHERE g &gt; 2\G ORDER BY c-&gt;"$.name"</div><div class="line">*************************** 1. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: SIMPLE</div><div class="line">        table: jemp</div><div class="line">   partitions: NULL</div><div class="line">         type: range</div><div class="line">possible_keys: i</div><div class="line">          key: i</div><div class="line">      key_len: 5</div><div class="line">          ref: NULL</div><div class="line">         rows: 2</div><div class="line">     filtered: 100.00</div><div class="line">        Extra: Using where; Using filesort</div><div class="line">1 row in set, 1 warning (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SHOW WARNINGS\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">  Level: Note</div><div class="line">   Code: 1003</div><div class="line">Message: /* select#1 */ select json_extract(`test`.`jemp`.`c`,'$.name') AS</div><div class="line">`c-&gt;"$.name"` from `test`.`jemp` where (`test`.`jemp`.`g` &gt; 2) order by</div><div class="line">json_extract(`test`.`jemp`.`c`,'$.name')  </div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/数据库/">数据库</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/05/10/数据库/Mysql Secondary Indexes and Generated Virtual Columns/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/05/10/数据库/Mysql Secondary Indexes and Generated Virtual Columns/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/09/JavaLibrary/JMeter/" title="JMeter" itemprop="url">JMeter</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-05-08T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-05-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="Aggregate-report"><a href="#Aggregate-report" class="headerlink" title="Aggregate report"></a>Aggregate report</h2><p>使用JMeter压测服务器登录压力,首先给出几张图看一下我们的配置<br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/jmeter/JMeter1.png" alt=""><br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/jmeter/JMeter2.png" alt=""><br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/jmeter/JMeter3.png" alt=""><br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/jmeter/JMeter4.png" alt=""><br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/jmeter/JMeter5.png" alt=""></p>
<blockquote>
<p>最后一张图是概要结果, 测试GameCenter结果.csv 是聚合报告结果</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/yu66/blog-website/images/jmeter/JMeter6.png" alt=""><br>这个是我们要配置的统计结果, 我们只统计了延迟, 耗时以及消息的字节数.</p>
<p>下面我们看一下, JMeter官方对Aggregate report(聚合报告)的说明:</p>
<p>聚合报告为每个不同名的Sampler(注意是不同名的哦)都创建了一个结果记录. 在结果记录中不仅仅统计了请求响应信息, 还提供了对请求的数，最小延迟值，最大延迟值，平均延迟，请求产生的错误比，吞吐量以及每秒吞吐产生的字节数的统计。JMeter在统计时已经考虑了生成消息所消耗的时间. 如果其他的采样器以及定时器在同一个线程中, 那么这将会增加总的时间统计, 从而降低吞吐量. 因此俩个名称不相同的采样器产生的吞吐量加在一起才是总的吞吐量. </p>
<p>在聚合报告中, 计算Median和90% Line值需要消耗额外的内存. JMeter现在将耗时相同的采样都合并到了一起,如此一来可以尽量减少内存占用．然而在某些情况下，　可能还会产生大量消耗内存的情况，因此推荐的方式是使用listener，然后从CSV或者XML文件中重新加载结果进行计算.</p>
<ul>
<li>Label - 统计标签</li>
<li><h1 id="Samples-相同名称的标签下采样的次数"><a href="#Samples-相同名称的标签下采样的次数" class="headerlink" title="Samples - 相同名称的标签下采样的次数"></a>Samples - 相同名称的标签下采样的次数</h1></li>
<li>Average - 统计数据结果的平均耗时时间</li>
<li>Median - 统计数据中中间的耗时时间, 50%的采样不会超过这个时间. 剩下的则大于等于这个值.</li>
<li>90% Line - 统计结果中90%的不会超过这个时间.剩下的则大于等于这个值.</li>
<li>95% Line - 统计结果中95%的不会超过这个时间.剩下的则大于等于这个值.</li>
<li>99% Line - 统计结果中99%的不会超过这个时间.剩下的则大于等于这个值.</li>
<li>Min - 统计结果中最短的耗时时间. </li>
<li>Max - 统计结果中最长的耗时时间. </li>
<li>Error % - 统计结果中发生错误的百分比. </li>
<li>Throughput - 吞吐量是在可以通过second/minute/hour这三种单位进行测量. 通过选择不同的单位可以让结果值最小的可能也是1.0. 当吞吐量被存在CSV 文件时, 吞吐量是通过requests/second表示的, 例如30.0 requests/minute 就被保存为0.5.</li>
<li>Kb/sec - The throughput measured in Kilobytes per second</li>
</ul>
<h2 id="Summy-Report"><a href="#Summy-Report" class="headerlink" title="Summy Report"></a>Summy Report</h2><p>接下来我们看一下Summy Report<br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/jmeter/JMeter7.png" alt=""><br>summary 报告为每个不同名的请求(注意是不同名的哦)都创建了一个结果记录. 这个和聚合报告非常像, 但不同的是它所使用的内存要比聚合报告少.</p>
<ul>
<li>Label - 统计标签</li>
<li><h1 id="Samples-相同名称的标签下采样的次数-1"><a href="#Samples-相同名称的标签下采样的次数-1" class="headerlink" title="Samples - 相同名称的标签下采样的次数"></a>Samples - 相同名称的标签下采样的次数</h1></li>
<li>Average - 该组统计的平均耗时</li>
<li>Min - 该组采样中最短的耗时时间</li>
<li>Max - 该组采样中最长的耗时时间</li>
<li>Std. Dev. - 采样耗时的标准偏差(Standard Deviation )</li>
<li>Error % - 请求发生错误的百分比</li>
<li>Throughput -  吞吐量是在可以通过second/minute/hour这三种单位进行测量. 通过选择不同的单位可以让结果值最小的可能也是1.0. 当吞吐量被存在CSV 文件时, 吞吐量是通过requests/second表示的, 例如30.0 requests/minute 就被保存为0.5.</li>
<li>Kb/sec - The throughput measured in Kilobytes per second</li>
<li>Avg. Bytes - average size of the sample response in bytes. (in JMeter 2.2 it wrongly showed the value in kB)</li>
</ul>
<h2 id="SSL"><a href="#SSL" class="headerlink" title="SSL"></a>SSL</h2><p><img src="https://raw.githubusercontent.com/yu66/blog-website/images/jmeter/ssl.png" alt=""></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/05/09/JavaLibrary/JMeter/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/05/09/JavaLibrary/JMeter/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/08/数据库/Mysql 客户端/" title="Mysql 客户端" itemprop="url">Mysql 客户端</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-05-08T07:00:00.000Z" itemprop="datePublished"> 发表于 2016-05-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="mycli"><a href="#mycli" class="headerlink" title="mycli"></a>mycli</h2><p><a href="http://mycli.net/index" target="_blank" rel="external">MyCli</a> 是一个 MySQL 命令行工具，支持自动补全和语法高亮</p>
<h2 id="dbv"><a href="#dbv" class="headerlink" title="dbv"></a>dbv</h2><p>数据库版本控制系统 <a href="http://dbv.vizuina.com" target="_blank" rel="external">http://dbv.vizuina.com</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/数据库/">数据库</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/05/08/数据库/Mysql 客户端/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/05/08/数据库/Mysql 客户端/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/05/jvm/Java 引用类型/" title="Java 引用类型" itemprop="url">Java 引用类型</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-05-04T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-05-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>JDK1.2之后,java对引用的概念进行了拓充,将引用分为强引用,软引用,弱引用,虚引用</p>
<ol>
<li>强引用: 指的是在代码之中普遍存在的,类似<code>Object obj = new Object()</code> 这类的引用,只要强引用还存在,垃圾收集器永远不会回收掉被引用的对象</li>
<li>软引用: 用来描述一些还有用,但是并非重要的对象.对于软引用关联着的对象,在系统将要发生内存溢出之前,将会把这些对象列进回收范围之中并进行第二次回收.如果这次回收还是没有足够的内存,才会抛出内存溢出异常.</li>
<li>弱饮用: 当垃圾收集器工作时,无论是否内存足够,都将回收掉只被若饮用关联的对象</li>
<li>虚引用: 一个对象是否是有虚引用的存在,完全不会对其生成时间构成影响,也无法通过虚引用来取得一个对象实例.为一个对象设置虚引用关联的唯一目的是希望在其被收集器回收时收到一个系统通知.</li>
</ol>
<h2 id="强引用"><a href="#强引用" class="headerlink" title="强引用"></a>强引用</h2><p>JVM在GC的时候并不会释放强引用的堆实例, 因此当堆内GC后仍然不能获得足够的空间, 就会发生OOM<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">String str = <span class="keyword">new</span> String(<span class="string">"Hi"</span>);</div></pre></td></tr></table></figure></p>
<p>上面的例子中, 在栈中分配的<code>str</code>指向了堆中分配的String实例, 那么<code>str</code>引用就是这个实例的强引用.</p>
<blockquote>
<p>保存在数组和集合中以及Map中的引用都都算是强引用.</p>
</blockquote>
<h2 id="软引用"><a href="#软引用" class="headerlink" title="软引用"></a>软引用</h2><p>JVM在GC时不一定会释放软引用所引用的对象实例, 那什么时候会进行释放呢? 只有当JVM发现堆内存不足时, 才会在GC时将软引用的堆内存释放掉<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.lang.ref.Reference;</div><div class="line"><span class="keyword">import</span> java.lang.ref.ReferenceQueue;</div><div class="line"><span class="keyword">import</span> java.lang.ref.SoftReference;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSoft</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        ReferenceQueue&lt;User&gt; referenceQueue = <span class="keyword">new</span> ReferenceQueue&lt;&gt;();</div><div class="line">        User user = <span class="keyword">new</span> User();</div><div class="line">        SoftReference&lt;User&gt; softReference = <span class="keyword">new</span> SoftReference&lt;&gt;(user, referenceQueue);</div><div class="line">        user = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                Reference&lt;? extends User&gt; ref = referenceQueue.poll();</div><div class="line">                <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</div><div class="line">                    System.out.println(<span class="string">"Changed : "</span> + ref);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        t.setDaemon(<span class="keyword">true</span>);</div><div class="line">        t.start();</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"Before GC : "</span> + <span class="string">" "</span> + softReference.get());</div><div class="line"></div><div class="line">        System.gc();</div><div class="line">        System.out.println(<span class="string">"After GC : "</span> + softReference.get());</div><div class="line"></div><div class="line">        <span class="keyword">byte</span>[] array = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">920</span> * <span class="number">7</span>];</div><div class="line">        System.out.println(<span class="string">"Alocate : "</span> + softReference.get());</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> String name;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们指定虚拟机参数<code>-Xmx10M -Xms10M -XX:PrintGC</code>, 运行一下这个程序的结果为:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[GC (Allocation Failure)  2048K-&gt;836K(9728K), 0.0023890 secs]</div><div class="line">Before GC :  <span class="built_in">test</span>Ref.User@404b9385</div><div class="line">[GC (System.gc())  1145K-&gt;844K(9728K), 0.0013400 secs]</div><div class="line">[Full GC (System.gc())  844K-&gt;750K(9728K), 0.0085260 secs]</div><div class="line">After GC : <span class="built_in">test</span>Ref.User@404b9385</div><div class="line">[GC (Allocation Failure)  788K-&gt;782K(9728K), 0.0003760 secs]</div><div class="line">[GC (Allocation Failure)  782K-&gt;782K(9728K), 0.0002590 secs]</div><div class="line">[Full GC (Allocation Failure)  782K-&gt;750K(9728K), 0.0043290 secs]</div><div class="line">[GC (Allocation Failure)  750K-&gt;750K(9728K), 0.0004580 secs]</div><div class="line">[Full GC (Allocation Failure)  750K-&gt;692K(9728K), 0.0079430 secs]</div><div class="line">Changed : java.lang.ref.SoftReference@19366529</div><div class="line">Alocate : null</div></pre></td></tr></table></figure></p>
<p>我们在构建<code>SoftReference</code>实例对象时, 除了添加一个测试对象外, 还添加里一个<code>ReferenceQueue</code>实例对象, 当对象的可达状态发生改变时, <code>SoftReference</code>就会移动到<code>ReferenceQueue</code>队列里. 从最后的Poll  这个输出里我们可以看到, 已经看不到这个对象了.</p>
<h2 id="弱引用"><a href="#弱引用" class="headerlink" title="弱引用"></a>弱引用</h2><p>弱引用是一种比软饮用更加弱的引用, JVM在GC时只要发现弱引用, 都会对其引用的实例进行回收<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.lang.ref.Reference;</div><div class="line"><span class="keyword">import</span> java.lang.ref.ReferenceQueue;</div><div class="line"><span class="keyword">import</span> java.lang.ref.SoftReference;</div><div class="line"><span class="keyword">import</span> java.lang.ref.WeakReference;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSoft</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        ReferenceQueue&lt;User&gt; referenceQueue = <span class="keyword">new</span> ReferenceQueue&lt;&gt;();</div><div class="line">        User user = <span class="keyword">new</span> User();</div><div class="line">        WeakReference&lt;User&gt; softReference = <span class="keyword">new</span> WeakReference&lt;&gt;(user, referenceQueue);</div><div class="line">		<span class="comment">// 确定没有强引用</span></div><div class="line">        user = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                Reference&lt;? extends User&gt; ref = referenceQueue.poll();</div><div class="line">                <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</div><div class="line">                    System.out.println(<span class="string">"Changed : "</span> + ref);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        t.setDaemon(<span class="keyword">true</span>);</div><div class="line">        t.start();</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"Before GC : "</span> + <span class="string">" "</span> + softReference.get());</div><div class="line"></div><div class="line">        System.gc();</div><div class="line">        System.out.println(<span class="string">"After GC : "</span> + softReference.get());</div><div class="line"></div><div class="line">        <span class="keyword">byte</span>[] array = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">920</span> * <span class="number">7</span>];</div><div class="line">        System.out.println(<span class="string">"Alocate : "</span> + softReference.get());</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;&#125;</div></pre></td></tr></table></figure></p>
<p>我们指定虚拟机参数<code>-Xmx10M -Xms10M -XX:+PrintGC</code>, 运行一下这个程序的结果为:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[GC (Allocation Failure)  2048K-&gt;800K(9728K), 0.0031060 secs]</div><div class="line">Before GC :  null</div><div class="line">Changed : java.lang.ref.WeakReference@175fdc70[GC (System.gc())  1084K-&gt;824K(9728K), 0.0011480 secs]</div><div class="line">[Full GC (System.gc())  824K-&gt;748K(9728K), 0.0088060 secs]</div><div class="line"></div><div class="line">After GC : null</div><div class="line">[GC (Allocation Failure)  807K-&gt;812K(9728K), 0.0010100 secs]</div><div class="line">[GC (Allocation Failure)  812K-&gt;844K(9728K), 0.0004150 secs]</div><div class="line">[Full GC (Allocation Failure)  844K-&gt;748K(9728K), 0.0090930 secs]</div><div class="line">[GC (Allocation Failure)  748K-&gt;748K(9728K), 0.0003230 secs]</div><div class="line">[Full GC (Allocation Failure)  748K-&gt;690K(9728K), 0.0082600 secs]</div><div class="line">Alocate : null</div></pre></td></tr></table></figure></p>
<p>如果<code>WeakReference</code>是保存在一个对象实例里面是什么情况呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.lang.ref.WeakReference;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSoft</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		WeakReferenceCache weakReferenceCache = <span class="keyword">new</span> WeakReferenceCache();</div><div class="line">		weakReferenceCache.cache = <span class="keyword">new</span> WeakReference&lt;&gt;(<span class="keyword">new</span> User());</div><div class="line">		System.out.println(<span class="string">"Before GC : "</span> + weakReferenceCache.cache.get());</div><div class="line">		System.gc();</div><div class="line">		System.out.println(<span class="string">"After GC : "</span> + weakReferenceCache.cache.get());</div><div class="line">		<span class="keyword">byte</span>[] array = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">920</span> * <span class="number">7</span>];</div><div class="line">		System.out.println(<span class="string">"Alocate GC : "</span> + weakReferenceCache.cache.get());</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeakReferenceCache</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> WeakReference&lt;User&gt; cache;</div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>同样我们运行一下看一下结果<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Before GC : User@41629346</div><div class="line">After GC : null</div><div class="line">Alocate GC : null</div></pre></td></tr></table></figure></p>
<p>确实是, 每次GC都将其回收掉了</p>
<p>我们再实验一下, 如果将其存进一个列表里<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.lang.ref.WeakReference;</div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSoft</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		WeakReferenceCache weakReferenceCache = <span class="keyword">new</span> WeakReferenceCache();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">			WeakReference&lt;User&gt; softReference = <span class="keyword">new</span> WeakReference&lt;&gt;(<span class="keyword">new</span> User());</div><div class="line">			weakReferenceCache.cache.add(softReference);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		System.out.println(<span class="string">"Before GC : "</span>);</div><div class="line">		weakReferenceCache.cache.forEach(cache -&gt; &#123;</div><div class="line">			System.out.println(cache.get());</div><div class="line">		&#125;);</div><div class="line">		System.gc();</div><div class="line">		System.out.println(<span class="string">"After GC : "</span>);</div><div class="line">		weakReferenceCache.cache.forEach(cache -&gt; &#123;</div><div class="line">			System.out.println(cache.get());</div><div class="line">		&#125;);</div><div class="line">		<span class="keyword">byte</span>[] array = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">920</span> * <span class="number">7</span>];</div><div class="line">		System.out.println(<span class="string">"Alocate GC : "</span>);</div><div class="line">		weakReferenceCache.cache.forEach(cache -&gt; &#123;</div><div class="line">			System.out.println(cache.get());</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeakReferenceCache</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> List&lt;WeakReference&lt;User&gt;&gt; cache = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">Before GC : </div><div class="line">User@6433a2</div><div class="line">User@5910e440</div><div class="line">User@6267c3bb</div><div class="line">User@533ddba</div><div class="line">User@246b179d</div><div class="line">User@7a07c5b4</div><div class="line">User@26a1ab54</div><div class="line">User@3d646c37</div><div class="line">User@41cf53f9</div><div class="line">User@5a10411</div><div class="line">After GC : </div><div class="line">null</div><div class="line">null</div><div class="line">null</div><div class="line">null</div><div class="line">null</div><div class="line">null</div><div class="line">null</div><div class="line">null</div><div class="line">null</div><div class="line">null</div><div class="line">Alocate GC : </div><div class="line">null</div><div class="line">null</div><div class="line">null</div><div class="line">null</div><div class="line">null</div><div class="line">null</div><div class="line">null</div><div class="line">null</div><div class="line">null</div><div class="line">null</div></pre></td></tr></table></figure></p>
<p>即使是存储在数组里也一样被回收掉了</p>
<h2 id="虚引用"><a href="#虚引用" class="headerlink" title="虚引用"></a>虚引用</h2><p>虚引用是所有引用类型中最弱的一个, 一个被虚引用持有的对象跟没有被持有的效果基本上是一样的. 当我们从虚引用中get时, 总会获得一个空, 那既然如此还为什么要设计出一个这样的引用呢? 因为虚引用必须跟一个引用队列, 我们可以将一些资源性的东西放到虚引用中执行和记录.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.lang.ref.*;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSoft</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        ReferenceQueue&lt;User&gt; referenceQueue = <span class="keyword">new</span> ReferenceQueue&lt;&gt;();</div><div class="line">        User user = <span class="keyword">new</span> User();</div><div class="line">        PhantomReference&lt;User&gt; softReference = <span class="keyword">new</span> PhantomReference&lt;&gt;(user, referenceQueue);</div><div class="line">        user = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                Reference&lt;? extends User&gt; ref = referenceQueue.poll();</div><div class="line">                <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</div><div class="line">                    System.out.println(<span class="string">"Changed : "</span> + System.currentTimeMillis());</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        t.setDaemon(<span class="keyword">true</span>);</div><div class="line">        t.start();</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"Before GC : "</span> + System.currentTimeMillis() + <span class="string">" "</span> + softReference.get());</div><div class="line"></div><div class="line">        System.gc();</div><div class="line">        System.out.println(<span class="string">"After GC : "</span> + softReference.get());</div><div class="line"></div><div class="line">        <span class="keyword">byte</span>[] array = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">920</span> * <span class="number">7</span>];</div><div class="line">        System.out.println(<span class="string">"Alocate : "</span> + softReference.get());</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;&#125;</div></pre></td></tr></table></figure></p>
<p>我们指定虚拟机参数<code>-Xmx30M -Xms30M -XX:+PrintGC</code>, 运行一下这个程序的结果为:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Before GC : 1462461362835 null</div><div class="line">[GC (System.gc())  2806K-&gt;904K(29696K), 0.0033390 secs]</div><div class="line">[Full GC (System.gc())  904K-&gt;779K(29696K), 0.0095950 secs]</div><div class="line">Changed : 1462461362850</div><div class="line">After GC : null</div><div class="line">Alocate : null</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/05/05/jvm/Java 引用类型/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/05/05/jvm/Java 引用类型/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/27/zookeeper/ZooKeeper Curator 基本操作/" title="ZooKeeper Curator 基本操作" itemprop="url">ZooKeeper Curator 基本操作</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-04-27T07:00:00.000Z" itemprop="datePublished"> 发表于 2016-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>Curator的Framework API为我们操作Zookeeper提供了非常便捷的操作. 它在ZooKeeper API之上为我们增加里许多新的特性, 例如对ZooKeeper集群连接的管理以及重试操作等等. 下面就列举了一些特性:</p>
<ul>
<li>自动连接管理</li>
<li>Leader 选举</li>
<li>共享锁</li>
<li>路径缓存以及watch</li>
<li>分布式队列(以及分布式Priority队列)</li>
</ul>
<p>我们根据下面的例子看一下Curator Framework的增删改查操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</div><div class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</div><div class="line"><span class="keyword">import</span> org.apache.curator.utils.CloseableUtils;</div><div class="line"><span class="keyword">import</span> org.apache.zookeeper.CreateMode;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCurator</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		CuratorFramework client = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client = CuratorFrameworkFactory.newClient(<span class="string">"0.0.0.0:2181"</span>, <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</div><div class="line">			client.start();</div><div class="line"></div><div class="line">			<span class="comment">// 创建一个临时节点, 如果父节点不存在, 则将父节点也创建出来</span></div><div class="line">			client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(<span class="string">"/Servers/LoginServer"</span>);</div><div class="line"></div><div class="line">			<span class="comment">// 查看根节点下的所有节点, 但是不会对子节点进行递归查询</span></div><div class="line">			client.getChildren().forPath(<span class="string">"/"</span>).forEach(path -&gt; System.out.println(<span class="string">"Exist : "</span> + path));</div><div class="line"></div><div class="line">			<span class="comment">// 设置数据</span></div><div class="line">			client.setData().forPath(<span class="string">"/Servers/LoginServer"</span>, <span class="string">"192.168.15.15"</span>.getBytes());</div><div class="line"></div><div class="line">			<span class="comment">// 获取节点数据</span></div><div class="line">			System.out.println(<span class="string">"Data : "</span> + client.getData().forPath(<span class="string">"/Servers/LoginServer"</span>));</div><div class="line"></div><div class="line">			<span class="comment">// 将子节点和父节点一起删除</span></div><div class="line">			client.delete().deletingChildrenIfNeeded().forPath(<span class="string">"/Servers"</span>);</div><div class="line"></div><div class="line">			<span class="comment">// 验证最后还有哪些节点存在</span></div><div class="line">			client.getChildren().forPath(<span class="string">"/"</span>).forEach(path -&gt; System.out.println(<span class="string">"Exist : "</span> + path));</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			CloseableUtils.closeQuietly(client);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Exist : Servers</div><div class="line">Exist : zookeeper</div><div class="line">Data : [B@63753b6d</div></pre></td></tr></table></figure></p>
<blockquote>
<p>如果要异步执行的话, 只需要调用相关逻辑的background方法就好了</p>
</blockquote>
<p>我们使用的是Curator2.x版本<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>我们应该使用curator-framework, 而不是使用curator-client<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>curator-client是对Zookepper官方API的一个简单封装, 如果我们使用curator-client, 还需要自己处理一些底层问题, 例如失败重连等问题<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">RetryLoop retryLoop = client.newRetryLoop();</div><div class="line"><span class="keyword">while</span> ( retryLoop.shouldContinue() )</div><div class="line">&#123;</div><div class="line">   <span class="keyword">try</span></div><div class="line">   &#123;</div><div class="line">       <span class="comment">// perform your work</span></div><div class="line">       ...</div><div class="line">       <span class="comment">// it's important to re\-get the ZK instance as there may have been an error and the instance was re\-created</span></div><div class="line">       ZooKeeper      zk = client.getZookeeper();</div><div class="line">       retryLoop.markComplete();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">catch</span> ( Exception e )</div><div class="line">   &#123;</div><div class="line">       retryLoop.takeException(e);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">RetryLoop.callWithRetry(client, <span class="keyword">new</span> Callable&lt;Void&gt;()</div><div class="line">&#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> Void <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span></div><div class="line">      &#123;</div><div class="line">          <span class="comment">// do your work here - it will get retried if needed</span></div><div class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/ZooKeeper/">ZooKeeper</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/27/zookeeper/ZooKeeper Curator 基本操作/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/27/zookeeper/ZooKeeper Curator 基本操作/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/26/zookeeper/ZooKeeper Curator 事件监听/" title="ZooKeeper Curator 事件监听" itemprop="url">ZooKeeper Curator 事件监听</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-04-26T07:00:00.000Z" itemprop="datePublished"> 发表于 2016-04-26</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="监测时检查出已有节点"><a href="#监测时检查出已有节点" class="headerlink" title="监测时检查出已有节点"></a>监测时检查出已有节点</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> zk;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Date;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.cache.ChildData;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.cache.PathChildrenCache;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.cache.PathChildrenCacheEvent;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.cache.PathChildrenCacheListener;</div><div class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</div><div class="line"><span class="keyword">import</span> org.apache.curator.utils.CloseableUtils;</div><div class="line"><span class="keyword">import</span> org.apache.curator.utils.ZKPaths;</div><div class="line"><span class="keyword">import</span> org.apache.zookeeper.CreateMode;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathCacheExample</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line"></div><div class="line">		ZKClient zkClient1 = register(<span class="string">"Server1"</span>);</div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">10</span>);</div><div class="line"></div><div class="line">		ZKClient zkClient2 = register(<span class="string">"Server2"</span>);</div><div class="line">		ZKClient zkClient3 = register(<span class="string">"Server3"</span>);</div><div class="line"></div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">5</span>);</div><div class="line">		zkClient1.closeAllService();</div><div class="line">		zkClient2.closeAllService();</div><div class="line">		zkClient3.closeAllService();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZKClient <span class="title">register</span><span class="params">(String serverName)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		ZKClient zkClient = <span class="keyword">new</span> ZKClient(serverName);</div><div class="line">		Thread thread = <span class="keyword">new</span> Thread(zkClient);</div><div class="line">		thread.start();</div><div class="line">		<span class="keyword">return</span> zkClient;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZKClient</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"/ServersCache1"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> CuratorFramework client = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> PathChildrenCache cache = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> String servername = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeAllService</span><span class="params">()</span> </span>&#123;</div><div class="line">		closeCuratorFramework();</div><div class="line">		closePathChildrenCache();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeCuratorFramework</span><span class="params">()</span> </span>&#123;</div><div class="line">		CloseableUtils.closeQuietly(cache);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closePathChildrenCache</span><span class="params">()</span> </span>&#123;</div><div class="line">		CloseableUtils.closeQuietly(client);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ZKClient</span><span class="params">(String serverName)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.servername = serverName;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client = CuratorFrameworkFactory.newClient(<span class="string">"0.0.0.0:2181"</span>, <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</div><div class="line">			client.start();</div><div class="line">			cache = <span class="keyword">new</span> PathChildrenCache(client, PATH, <span class="keyword">true</span>);</div><div class="line">			cache.start();</div><div class="line">			addListener(cache);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		create(client, servername, servername);</div><div class="line">		setValue(client, servername, servername);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			TimeUnit.SECONDS.sleep(<span class="number">1</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(PathChildrenCache cache)</span> </span>&#123;</div><div class="line">		PathChildrenCacheListener listener = (client, event) -&gt; &#123;</div><div class="line">			<span class="keyword">switch</span> (event.getType()) &#123;</div><div class="line">				<span class="keyword">case</span> CHILD_ADDED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"added"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">case</span> CHILD_UPDATED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"changed"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">case</span> CHILD_REMOVED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"removed"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		cache.getListenable().addListener(listener);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printNodeStateChange</span><span class="params">(String type, String path)</span> </span>&#123;</div><div class="line">		System.out.println(servername + <span class="string">" Monitor Node "</span> + type + <span class="string">": "</span> + path + <span class="string">". "</span> + <span class="keyword">new</span> Date().toLocaleString());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(CuratorFramework client, String pathName)</span> </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.delete().deletingChildrenIfNeeded().forPath(path);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(CuratorFramework client, String pathName, String data)</span>  </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(path, data.getBytes());</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(CuratorFramework client, String pathName, String data)</span> </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.setData().forPath(path, data.getBytes());</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Server1 Monitor Node added: /ServersCache1/Server1. 2016-4-28 18:41:54</div><div class="line">Server1 Monitor Node added: /ServersCache1/Server2. 2016-4-28 18:42:04</div><div class="line">Server1 Monitor Node added: /ServersCache1/Server3. 2016-4-28 18:42:04</div><div class="line">Server3 Monitor Node added: /ServersCache1/Server1. 2016-4-28 18:42:04</div><div class="line">Server3 Monitor Node added: /ServersCache1/Server2. 2016-4-28 18:42:04</div><div class="line">Server3 Monitor Node added: /ServersCache1/Server3. 2016-4-28 18:42:04</div><div class="line">Server2 Monitor Node added: /ServersCache1/Server1. 2016-4-28 18:42:04</div><div class="line">Server2 Monitor Node added: /ServersCache1/Server2. 2016-4-28 18:42:04</div><div class="line">Server2 Monitor Node added: /ServersCache1/Server3. 2016-4-28 18:42:04</div><div class="line">Server3 Monitor Node removed: /ServersCache1/Server1. 2016-4-28 18:42:09</div><div class="line">Server2 Monitor Node removed: /ServersCache1/Server1. 2016-4-28 18:42:09</div><div class="line">Server3 Monitor Node removed: /ServersCache1/Server2. 2016-4-28 18:42:09</div></pre></td></tr></table></figure></p>
<h2 id="删除节点监测"><a href="#删除节点监测" class="headerlink" title="删除节点监测"></a>删除节点监测</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathCacheExample</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line"></div><div class="line">		ZKClient zkClient1 = register(<span class="string">"Server1"</span>);</div><div class="line"></div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		ZKClient zkClient2 = register(<span class="string">"Server2"</span>);</div><div class="line">		ZKClient zkClient3 = register(<span class="string">"Server3"</span>);</div><div class="line"></div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZKClient <span class="title">register</span><span class="params">(String serverName)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		ZKClient zkClient = <span class="keyword">new</span> ZKClient(serverName);</div><div class="line">		Thread thread = <span class="keyword">new</span> Thread(zkClient);</div><div class="line">		thread.start();</div><div class="line">		<span class="keyword">return</span> zkClient;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZKClient</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"/ServersCache5"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> CuratorFramework client = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> PathChildrenCache cache = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> String servername = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeAllService</span><span class="params">()</span> </span>&#123;</div><div class="line">		closeCuratorFramework();</div><div class="line">		closePathChildrenCache();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeCuratorFramework</span><span class="params">()</span> </span>&#123;</div><div class="line">		CloseableUtils.closeQuietly(client);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closePathChildrenCache</span><span class="params">()</span> </span>&#123;</div><div class="line">		CloseableUtils.closeQuietly(cache);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ZKClient</span><span class="params">(String serverName)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.servername = serverName;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client = CuratorFrameworkFactory.newClient(<span class="string">"0.0.0.0:2181"</span>, <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</div><div class="line">			client.start();</div><div class="line">			cache = <span class="keyword">new</span> PathChildrenCache(client, PATH, <span class="keyword">true</span>);</div><div class="line">			cache.start();</div><div class="line">			addListener(cache);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		create(client, servername, servername);</div><div class="line">		setValue(client, servername, servername);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		remove(client, servername);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(PathChildrenCache cache)</span> </span>&#123;</div><div class="line">		PathChildrenCacheListener listener = (client, event) -&gt; &#123;</div><div class="line">			<span class="keyword">switch</span> (event.getType()) &#123;</div><div class="line">				<span class="keyword">case</span> CHILD_ADDED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"added"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">case</span> CHILD_UPDATED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"changed"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">case</span> CHILD_REMOVED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"removed"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		cache.getListenable().addListener(listener);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printNodeStateChange</span><span class="params">(String type, String path)</span> </span>&#123;</div><div class="line">		System.out.println(servername + <span class="string">" Monitor Node "</span> + type + <span class="string">": "</span> + path + <span class="string">". "</span> + <span class="keyword">new</span> Date().toLocaleString());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(CuratorFramework client, String pathName)</span> </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.delete().forPath(path);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(CuratorFramework client, String pathName, String data)</span>  </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(path, data.getBytes());</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(CuratorFramework client, String pathName, String data)</span> </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.setData().forPath(path, data.getBytes());</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Server1 Monitor Node added: /ServersCache5/Server1. 2016-4-28 19:33:13</div><div class="line">Server1 Monitor Node added: /ServersCache5/Server2. 2016-4-28 19:33:16</div><div class="line">Server2 Monitor Node added: /ServersCache5/Server1. 2016-4-28 19:33:16</div><div class="line">Server1 Monitor Node added: /ServersCache5/Server3. 2016-4-28 19:33:16</div><div class="line">Server2 Monitor Node added: /ServersCache5/Server2. 2016-4-28 19:33:16</div><div class="line">Server2 Monitor Node added: /ServersCache5/Server3. 2016-4-28 19:33:16</div><div class="line">Server3 Monitor Node added: /ServersCache5/Server1. 2016-4-28 19:33:16</div><div class="line">Server3 Monitor Node added: /ServersCache5/Server2. 2016-4-28 19:33:16</div><div class="line">Server3 Monitor Node added: /ServersCache5/Server3. 2016-4-28 19:33:16</div><div class="line">Server2 Monitor Node removed: /ServersCache5/Server1. 2016-4-28 19:33:16</div><div class="line">Server1 Monitor Node removed: /ServersCache5/Server1. 2016-4-28 19:33:16</div><div class="line">Server3 Monitor Node removed: /ServersCache5/Server1. 2016-4-28 19:33:16</div><div class="line">Server1 Monitor Node removed: /ServersCache5/Server2. 2016-4-28 19:33:19</div><div class="line">Server3 Monitor Node removed: /ServersCache5/Server2. 2016-4-28 19:33:19</div><div class="line">Server2 Monitor Node removed: /ServersCache5/Server2. 2016-4-28 19:33:19</div><div class="line">Server3 Monitor Node removed: /ServersCache5/Server3. 2016-4-28 19:33:19</div><div class="line">Server1 Monitor Node removed: /ServersCache5/Server3. 2016-4-28 19:33:19</div><div class="line">Server2 Monitor Node removed: /ServersCache5/Server3. 2016-4-28 19:33:19</div></pre></td></tr></table></figure></p>
<h2 id="客户端网络断开监测"><a href="#客户端网络断开监测" class="headerlink" title="客户端网络断开监测"></a>客户端网络断开监测</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathCacheExample</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line"></div><div class="line">		ZKClient zkClient1 = register(<span class="string">"Server1"</span>);</div><div class="line"></div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		ZKClient zkClient2 = register(<span class="string">"Server2"</span>);</div><div class="line">		ZKClient zkClient3 = register(<span class="string">"Server3"</span>);</div><div class="line"></div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		zkClient1.closeCuratorFramework();</div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">1</span>);</div><div class="line">		zkClient2.closeCuratorFramework();</div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">1</span>);</div><div class="line">		zkClient3.closeCuratorFramework();</div><div class="line"></div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		zkClient1.closePathChildrenCache();</div><div class="line">		zkClient2.closePathChildrenCache();</div><div class="line">		zkClient3.closePathChildrenCache();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZKClient <span class="title">register</span><span class="params">(String serverName)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		ZKClient zkClient = <span class="keyword">new</span> ZKClient(serverName);</div><div class="line">		Thread thread = <span class="keyword">new</span> Thread(zkClient);</div><div class="line">		thread.start();</div><div class="line">		<span class="keyword">return</span> zkClient;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZKClient</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"/ServersCache4"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> CuratorFramework client = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> PathChildrenCache cache = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> String servername = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeAllService</span><span class="params">()</span> </span>&#123;</div><div class="line">		closeCuratorFramework();</div><div class="line">		closePathChildrenCache();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeCuratorFramework</span><span class="params">()</span> </span>&#123;</div><div class="line">		CloseableUtils.closeQuietly(client);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closePathChildrenCache</span><span class="params">()</span> </span>&#123;</div><div class="line">		CloseableUtils.closeQuietly(cache);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ZKClient</span><span class="params">(String serverName)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.servername = serverName;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client = CuratorFrameworkFactory.newClient(<span class="string">"0.0.0.0:2181"</span>, <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</div><div class="line">			client.start();</div><div class="line">			cache = <span class="keyword">new</span> PathChildrenCache(client, PATH, <span class="keyword">true</span>);</div><div class="line">			cache.start();</div><div class="line">			addListener(cache);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		create(client, servername, servername);</div><div class="line"><span class="comment">//		remove(client, servername);</span></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			TimeUnit.SECONDS.sleep(<span class="number">1</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(PathChildrenCache cache)</span> </span>&#123;</div><div class="line">		PathChildrenCacheListener listener = (client, event) -&gt; &#123;</div><div class="line">			<span class="keyword">switch</span> (event.getType()) &#123;</div><div class="line">				<span class="keyword">case</span> CHILD_ADDED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"added"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">case</span> CHILD_UPDATED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"changed"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">case</span> CHILD_REMOVED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"removed"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		cache.getListenable().addListener(listener);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printNodeStateChange</span><span class="params">(String type, String path)</span> </span>&#123;</div><div class="line">		System.out.println(servername + <span class="string">" Monitor Node "</span> + type + <span class="string">": "</span> + path + <span class="string">". "</span> + <span class="keyword">new</span> Date().toLocaleString());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(CuratorFramework client, String pathName)</span> </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.delete().deletingChildrenIfNeeded().forPath(path);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(CuratorFramework client, String pathName, String data)</span>  </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(path, data.getBytes());</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(CuratorFramework client, String pathName, String data)</span> </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.setData().forPath(path, data.getBytes());</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结果输出为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Server1 Monitor Node added: /ServersCache4/Server1. 2016-4-28 19:27:32</div><div class="line">Server1 Monitor Node added: /ServersCache4/Server2. 2016-4-28 19:27:35</div><div class="line">Server3 Monitor Node added: /ServersCache4/Server1. 2016-4-28 19:27:35</div><div class="line">Server1 Monitor Node added: /ServersCache4/Server3. 2016-4-28 19:27:35</div><div class="line">Server3 Monitor Node added: /ServersCache4/Server2. 2016-4-28 19:27:35</div><div class="line">Server3 Monitor Node added: /ServersCache4/Server3. 2016-4-28 19:27:35</div><div class="line">Server2 Monitor Node added: /ServersCache4/Server1. 2016-4-28 19:27:35</div><div class="line">Server2 Monitor Node added: /ServersCache4/Server2. 2016-4-28 19:27:35</div><div class="line">Server2 Monitor Node added: /ServersCache4/Server3. 2016-4-28 19:27:35</div><div class="line">Server2 Monitor Node removed: /ServersCache4/Server1. 2016-4-28 19:27:38</div><div class="line">Server1 Monitor Node removed: /ServersCache4/Server1. 2016-4-28 19:27:38</div><div class="line">Server3 Monitor Node removed: /ServersCache4/Server1. 2016-4-28 19:27:38</div><div class="line">Server2 Monitor Node removed: /ServersCache4/Server2. 2016-4-28 19:27:39</div><div class="line">Server3 Monitor Node removed: /ServersCache4/Server2. 2016-4-28 19:27:39</div><div class="line">Server3 Monitor Node removed: /ServersCache4/Server3. 2016-4-28 19:27:40</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/ZooKeeper/">ZooKeeper</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/26/zookeeper/ZooKeeper Curator 事件监听/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/26/zookeeper/ZooKeeper Curator 事件监听/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/26/JavaLibrary/Spring 任务调度/" title="Spring 任务调度" itemprop="url">Spring 任务调度</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-04-25T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-04-26</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="https://spring.io/guides/gs/scheduling-tasks/" target="_blank" rel="external">官方文档</a>学习</p>
<p>测试代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Date;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableScheduling;</div><div class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</div><div class="line"></div><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@EnableScheduling</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestScheduledTasks</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		SpringApplication.run(TestScheduledTasks.class);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScheduledTasks</span> </span>&#123;</div><div class="line">	<span class="comment">// 当任务完成之后, 再延迟fixedDelay毫秒后执行</span></div><div class="line">	<span class="meta">@Scheduled</span>(fixedDelay = <span class="number">3000</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fixedDelay</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		System.out.println(<span class="string">"fixedDelay : "</span> + <span class="keyword">new</span> Date());</div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 每三秒钟执行一次</span></div><div class="line">	<span class="meta">@Scheduled</span>(fixedRate = <span class="number">3000</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fixedRate</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		System.out.println(<span class="string">"fixedRate : "</span> + <span class="keyword">new</span> Date());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">fixedRate : Tue Apr 26 15:59:15 CST 2016</div><div class="line">fixedDelay : Tue Apr 26 15:59:15 CST 2016</div><div class="line">fixedRate : Tue Apr 26 15:59:21 CST 2016</div><div class="line">fixedRate : Tue Apr 26 15:59:24 CST 2016</div><div class="line">fixedRate : Tue Apr 26 15:59:27 CST 2016</div><div class="line">fixedDelay : Tue Apr 26 15:59:27 CST 2016</div></pre></td></tr></table></figure></p>
<p><code>Scheduled</code>的注解还有</p>
<ul>
<li>cron : 这个可以让我们使用cron表达式</li>
</ul>
<p>最后添加所需要的Maven依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gs-scheduling-tasks<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Spring/">Spring</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/26/JavaLibrary/Spring 任务调度/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/26/JavaLibrary/Spring 任务调度/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/3/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="yu66" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/JVM/" title="JVM">JVM<sup>17</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java/" title="Java">Java<sup>32</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java-Library/" title="Java Library">Java Library<sup>34</sup></a></li>
		  
		
		  
			<li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/NoSql/" title="NoSql">NoSql<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/数据库/" title="数据库">数据库<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/杂记/" title="杂记">杂记<sup>18</sup></a></li>
		  
		
		  
			<li><a href="/categories/算法/" title="算法">算法<sup>11</sup></a></li>
		  
		
		  
			<li><a href="/categories/编程语言/" title="编程语言">编程语言<sup>20</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Netty/" title="Netty">Netty<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/asm/" title="asm">asm<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Spring/" title="Spring">Spring<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Guice/" title="Guice">Guice<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://vertx.yu66.wang/" target="_blank" title="vertx3">vertx3</a>
            
          </li>
        
    </ul>
</div>

  

<div class="doubanshow">
<p class="asidetitle">豆瓣秀</p>
<div>
<script type="text/javascript" src="http://www.douban.com/service/badge/xxxyy/?show=collection&amp;n=12&amp;columns=3&amp;hidelogo=yes&amp;hideself=yes&amp;cat=book|movie" ></script>
</div>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=3253370782&verifier=e9ca895b&dpc=1"></iframe>
</div>


  

<div class="lofter">
<p class="asidetitle">Lofter</p>

 <iframe width="100%" height="39" class="share_self"  frameborder="0" scrolling="no" src="http://ming15.lofter.com/"></iframe>
</div>




</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 博客,我选择重构 <br/>
			重构使事情变得更美,更加正确</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/3253370782" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/yu66" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		<a href="https://www.douban.com/people/xxxyy" target="_blank" class="icon-douban" title="豆瓣"></a>
		
		
		<a href="http://www.zhihu.com/people/ming15" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="王玉">王玉</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"wanggnim"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F9e8fca440159a2125668804e46682db4' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
