
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>·</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="王玉">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="·">
<meta property="og:url" content="http://www.yu66.wang/page/4/index.html">
<meta property="og:site_name" content="·">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="·">

    
    <link rel="alternative" href="/atom.xml" title="·" type="application/atom+xml">
    
    
    
    <link rel="apple-touch-icon" href="/img/author.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/author.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="·">·</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
						<form class="search" action="http://zhannei.baidu.com/cse/search" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= 17728547076946147000 ><input type="text" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/04/杂记/java游戏服务器/" title="Java游戏服务器设计" itemprop="url">Java游戏服务器设计</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-03T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-03-04</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>从毕业就开始在游戏行业摸爬滚打,至今4年将至,今天特意总结一下这四年来的心得.</p>
<p>现在的游戏服务器大多采用Netty作为网络传输层,然后采用Reactor模型将消息转发到业务线程池中进行执行,然后在业务线程池中进行CPU计算,数据库IO操作,最后将结果返回给前端.</p>
<p>这样的游戏服务器在压测的时候在线玩家不会超过2000人,而且经常会出现比较大的延迟,因为有的IO操作真的很耗时. </p>
<p>在上个项目中我见到了这样一种设计,仍然是采用Netty完成网络层Socket数据读取发送工作,然后将解码出的数据扔到俩个消息队列里面去(采用Vertx的EventBus实现). 一个消息队列负责登录请求,一个消息队列负责整个游戏的业务逻辑. 这么着一来整个游戏的业务就不会出现数据竞争的情况. 然后再定时的将数据写到redis里面去. 这种设计在压测的时候达到了10000人的同时在线规模. (当然还有很多优化的地方, 例如在消息查找的时候采取ASM而不是低效的JDK反射, 但是并没有对JVM和Netty进行过特殊优化, 只是对JVM的新生代的分区将8:1:1改成了6:2:2)</p>
<p>前俩天和一些游戏团队的人聊了聊,他们一致认为这种设计方式没有能充分的利用上主机多核的优势, 但是在Reactor的模型中, 主线程池和工作线程池都是需要CPU来运算的, 如果所有的CPU运算都来支持业务逻辑, 那么玩家一样会感觉到卡顿. 而且我们还可以对刚才的设计进行优化, 将不同模块业务放到不同的线程进行. 例如在Thread1中进行玩家自己的业务逻辑运算, 在Thread2中进行公会模块的业务计算, 当公会对玩家本身数据产生影响的时候, 我们可以让公会线程给玩家的业务线程发送消息(同样的使用消息队列). 这么着也能最大可能的利用多核优势同时让开发人员少的思考数据竞争出现的问题, 现在大多数的开发人员在处理数据竞争的时候还是较多的使用synchronized这种加锁方式(有些底层的接口也有可能使用读写锁, 但是使用锁, 在大规模用户的情况下,真的比较耗时).</p>
<p>还有一点需要说的是, 在上个项目中,只使用到了很少的数据库表, 基本上玩家数据都存储到了一张表里, 当定时存储的时候,将玩家数据整个序列化成一个JSON串, 然后入库. 这么做有显而易见的好处,在分服的游戏中, 合服很容易而且在线上出现问题的时候,也很容易拿到一个玩家的数据进行问题排查. 而且在线上的时候也会出现因为异常而导致玩家刷材料等等, 因此如果在处理消息之前, 拿一个玩家备份的数据让玩家去操作,一旦出现数据异常也不会对玩家自己的数据造成影响. (需要考虑的是大量的序列号和反序列化会造成大量的GC操作.)</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/杂记/">杂记</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/04/杂记/java游戏服务器/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/04/杂记/java游戏服务器/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/02/nosql/jedis/" title="Jedis 初探" itemprop="url">Jedis 初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-02T08:00:00.000Z" itemprop="datePublished"> 发表于 2016-03-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="using-Jedis-in-a-multithreaded-environment"><a href="#using-Jedis-in-a-multithreaded-environment" class="headerlink" title="using Jedis in a multithreaded environment"></a>using Jedis in a multithreaded environment</h2><p>我们不应该在多线程的情况下使用同一个Jedis实例对象, 因为在Jedis本身不是线程安全的, 它可能会引发一些奇奇怪怪的问题. 但是如果我们在每个线程中都创建一个Jedis实例对象的话这也是不可取的, 因为每个Jedis对象的创建都意味着socket和网络连接的创建. 为了避免这种情况,我们应该使用<code>JedisPool</code>, 它是一个线程安全的网络连接池. 我们可以通过池子创建多个Jedis实例对象, 当使用完之后再将它返回给池子.</p>
<p>在下面的实例中我们初始化一个池子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">JedisPool pool = <span class="keyword">new</span> JedisPool(<span class="keyword">new</span> JedisPoolConfig(), <span class="string">"localhost"</span>);</div></pre></td></tr></table></figure></p>
<p>因为JedisPool是线程安全的, 因此我们可以将它缓存起来, 供所有线程使用.</p>
<p><code>JedisPoolConfig</code>包含了一个丰富有用的Redis连接配置参数. <code>JedisPoolConfig</code>基于<a href="http://commons.apache.org/proper/commons-pool/apidocs/org/apache/commons/pool2/impl/GenericObjectPoolConfig.html" target="_blank" rel="external">Commons Pool 2</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// Jedis implements Closable. Hence, the jedis instance will be auto-closed after the last statement.</span></div><div class="line"><span class="keyword">try</span> (Jedis jedis = pool.getResource()) &#123;</div><div class="line">  <span class="comment">/// ... do stuff here ... for example</span></div><div class="line">  jedis.set(<span class="string">"foo"</span>, <span class="string">"bar"</span>);</div><div class="line">  String foobar = jedis.get(<span class="string">"foo"</span>);</div><div class="line">  jedis.zadd(<span class="string">"sose"</span>, <span class="number">0</span>, <span class="string">"car"</span>); jedis.zadd(<span class="string">"sose"</span>, <span class="number">0</span>, <span class="string">"bike"</span>);</div><div class="line">  Set&lt;String&gt; sose = jedis.zrange(<span class="string">"sose"</span>, <span class="number">0</span>, -<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="comment">/// ... when closing your application:</span></div><div class="line">pool.destroy();</div></pre></td></tr></table></figure>
<p>如果你不喜欢<code>try-with-resource</code>这种语法, 那么你可以使用<code>Jedis.close()</code>.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Jedis jedis = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  jedis = pool.getResource();</div><div class="line">  <span class="comment">/// ... do stuff here ... for example</span></div><div class="line">  jedis.set(<span class="string">"foo"</span>, <span class="string">"bar"</span>);</div><div class="line">  String foobar = jedis.get(<span class="string">"foo"</span>);</div><div class="line">  jedis.zadd(<span class="string">"sose"</span>, <span class="number">0</span>, <span class="string">"car"</span>); jedis.zadd(<span class="string">"sose"</span>, <span class="number">0</span>, <span class="string">"bike"</span>);</div><div class="line">  Set&lt;String&gt; sose = jedis.zrange(<span class="string">"sose"</span>, <span class="number">0</span>, -<span class="number">1</span>);</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">  <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</div><div class="line">    jedis.close();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/// ... when closing your application:</span></div><div class="line">pool.destroy();</div></pre></td></tr></table></figure></p>
<p>If Jedis was borrowed from pool, it will be returned to pool with proper method since it already determines there was JedisConnectionException occurred. If Jedis wasn’t borrowed from pool, it will be disconnected and closed.</p>
<p>下来我们来看一段测试代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JedisTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        JedisPoolConfig jedisPoolConfig = <span class="keyword">new</span> JedisPoolConfig();</div><div class="line">        jedisPoolConfig.setMaxTotal(<span class="number">10</span>);</div><div class="line">        JedisPool pool = <span class="keyword">new</span> JedisPool(jedisPoolConfig, <span class="string">"10.1.4.110"</span>);</div><div class="line">        System.out.println(<span class="string">"begin : "</span> + pool.getNumActive());</div><div class="line">        System.out.println(<span class="string">"begin : "</span> + pool.getNumIdle());</div><div class="line">        System.out.println(<span class="string">"begin : "</span> + pool.getNumWaiters());</div><div class="line">        Jedis jedis = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            jedis = pool.getResource();</div><div class="line">            System.out.println(<span class="string">"borrow : "</span> + pool.getNumActive());</div><div class="line">            System.out.println(<span class="string">"borrow : "</span> + pool.getNumIdle());</div><div class="line">            System.out.println(<span class="string">"borrow : "</span> + pool.getNumWaiters());</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</div><div class="line">                jedis.close();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        System.out.println(<span class="string">"return : "</span> + pool.getNumActive());</div><div class="line">        System.out.println(<span class="string">"return : "</span> + pool.getNumIdle());</div><div class="line">        System.out.println(<span class="string">"return : "</span> + pool.getNumWaiters());</div><div class="line">        pool.destroy();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">begin : <span class="number">0</span></div><div class="line">begin : <span class="number">0</span></div><div class="line">begin : <span class="number">0</span></div><div class="line">borrow : <span class="number">1</span></div><div class="line">borrow : <span class="number">0</span></div><div class="line">borrow : <span class="number">0</span></div><div class="line"><span class="keyword">return</span> : <span class="number">0</span></div><div class="line"><span class="keyword">return</span> : <span class="number">1</span></div><div class="line"><span class="keyword">return</span> : <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>当调用<code>jedis.close();</code>后,池子里空闲的Jedis对象就多了1个, 可是如果我们注释掉这一行后的结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">begin : <span class="number">0</span></div><div class="line">begin : <span class="number">0</span></div><div class="line">begin : <span class="number">0</span></div><div class="line">borrow : <span class="number">1</span></div><div class="line">borrow : <span class="number">0</span></div><div class="line">borrow : <span class="number">0</span></div><div class="line"><span class="keyword">return</span> : <span class="number">1</span></div><div class="line"><span class="keyword">return</span> : <span class="number">0</span></div><div class="line"><span class="keyword">return</span> : <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>我们发现那个Jedis仍然处于激活状态, 在Jedis 2.8.0版本以前当我们从池子里借用一个Jedis之后还需要将其还回去<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Jedis resource)</span> </span>&#123;</div><div class="line">    jedisPool.returnResource(resource);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是现在已经不需要了, 而且Jedis已经将这个<code>returnResource()</code>的方法舍弃掉了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** <span class="doctag">@deprecated</span> */</span></div><div class="line"><span class="meta">@Deprecated</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnResource</span><span class="params">(Jedis resource)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span>(resource != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            resource.resetState();</div><div class="line">            <span class="keyword">this</span>.returnResourceObject(resource);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception var3) &#123;</div><div class="line">            <span class="keyword">this</span>.returnBrokenResource(resource);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JedisException(<span class="string">"Could not return the resource to the pool"</span>, var3);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来我们看一下多线程情况<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JedisTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        JedisPoolConfig jedisPoolConfig = <span class="keyword">new</span> JedisPoolConfig();</div><div class="line">        jedisPoolConfig.setMaxTotal(<span class="number">3</span>);</div><div class="line">        JedisPool pool = <span class="keyword">new</span> JedisPool(jedisPoolConfig, <span class="string">"10.1.4.110"</span>);</div><div class="line">        List&lt;Thread&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</div><div class="line">            Runnable runnable = () -&gt; &#123;</div><div class="line">                Jedis jedis = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    jedis = pool.getResource();</div><div class="line">                    <span class="keyword">int</span> sleep = <span class="keyword">new</span> Random().nextInt(<span class="number">5</span>);</div><div class="line">                    System.out.println(<span class="string">"sleep:"</span> + sleep + <span class="string">". time:"</span> + <span class="keyword">new</span> Date().toLocaleString() + <span class="string">". active: "</span> + pool.getNumActive() + <span class="string">". idle: "</span> + pool.getNumIdle());</div><div class="line"></div><div class="line">                    TimeUnit.SECONDS.sleep(sleep);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</div><div class="line">                        jedis.close();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line">            list.add(<span class="keyword">new</span> Thread(runnable));</div><div class="line">        &#125;</div><div class="line">        list.forEach(thread -&gt; thread.start());</div><div class="line"></div><div class="line">        Thread.currentThread().join();</div><div class="line">        pool.destroy();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sleep:<span class="number">4</span>. time:<span class="number">2016</span>-<span class="number">3</span>-<span class="number">4</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">03</span>. active: <span class="number">3</span>. idle: <span class="number">0</span></div><div class="line">sleep:<span class="number">4</span>. time:<span class="number">2016</span>-<span class="number">3</span>-<span class="number">4</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">03</span>. active: <span class="number">3</span>. idle: <span class="number">0</span></div><div class="line">sleep:<span class="number">3</span>. time:<span class="number">2016</span>-<span class="number">3</span>-<span class="number">4</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">03</span>. active: <span class="number">3</span>. idle: <span class="number">0</span></div><div class="line">sleep:<span class="number">3</span>. time:<span class="number">2016</span>-<span class="number">3</span>-<span class="number">4</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">06</span>. active: <span class="number">3</span>. idle: <span class="number">0</span></div><div class="line">sleep:<span class="number">3</span>. time:<span class="number">2016</span>-<span class="number">3</span>-<span class="number">4</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">07</span>. active: <span class="number">2</span>. idle: <span class="number">1</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/NoSql/">NoSql</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/02/nosql/jedis/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/02/nosql/jedis/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/02/22/JavaLibrary/Netty ServerBootstrap/" title="NettyServerBootstrap" itemprop="url">NettyServerBootstrap</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-02-21T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-02-22</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我们首先给出一个Netty上的一个Example示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="keyword">int</span> cpuSize = Runtime.getRuntime().availableProcessors();</div><div class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</div><div class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup(cpuSize);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();</div><div class="line">            b.group(bossGroup, workerGroup)</div><div class="line">                    .channel(NioServerSocketChannel.class)</div><div class="line">                    .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</div><div class="line">                    .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</div><div class="line">                    .option(ChannelOption.AUTO_READ, <span class="keyword">true</span>)</div><div class="line">                    .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> </span>&#123;</div><div class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> InHandler());</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line"></div><div class="line">            ChannelFuture f = b.bind(<span class="number">8881</span>).sync();</div><div class="line">            f.channel().closeFuture().sync();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            bossGroup.shutdownGracefully();</div><div class="line">            workerGroup.shutdownGracefully();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> </span>&#123;</div><div class="line">        ctx.write(msg);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</div><div class="line">        ctx.flush();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在这个示例中, 我们采用了主从Reactor线程模型, 然后将接受到的数据写回给客户端.</p>
<p>下来我们分析一下<code>ServerBootstrap</code>的源码. 我们从<code>bind()</code>方法入手.</p>
<p>由于<code>bind()</code>最终调用的是父类<code>AbstractBootstrap</code>的<code>doBind()</code>方法, 因此我们从父类入手<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ChannelFuture <span class="title">doBind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress)</span> </span>&#123;</div><div class="line">				<span class="comment">// 初始化NioServerSocketChannel, 并将其注册主Reactor线程池的IO多路复用器上</span></div><div class="line">        <span class="keyword">final</span> ChannelFuture regFuture = initAndRegister();</div><div class="line">        <span class="keyword">final</span> Channel channel = regFuture.channel();</div><div class="line">        <span class="keyword">if</span> (regFuture.isDone()) &#123;</div><div class="line">            ChannelPromise promise = channel.newPromise();</div><div class="line">            doBind0(regFuture, channel, localAddress, promise);</div><div class="line">            <span class="keyword">return</span> promise;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ...</div><div class="line">            <span class="keyword">return</span> promise;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>接下来我们看一下<code>AbstractBootstrap#initAndRegister()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> ChannelFuture <span class="title">initAndRegister</span><span class="params">()</span> </span>&#123;</div><div class="line">				<span class="comment">// 因为我们调用过channel(NioServerSocketChannel.class)方法, 因此下面这个Channel是NioServerSocketChannel类型</span></div><div class="line">        <span class="keyword">final</span> Channel channel = channelFactory().newChannel();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">					  <span class="comment">// init方法主要是对NioServerSocketChannel添加一个ServerBootstrapAcceptor的Handler(继承自ChannelInboundHandlerAdapter)</span></div><div class="line">            <span class="comment">// 当channel接受到网络连接的时候, 会生成NioSocketChannel, 将NioSocketChannel与从Reactor进行绑定</span></div><div class="line">            init(channel);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">				<span class="comment">// 将Reactor模型中的主Reactor线程注册到NioServerSocketChannel的Unsafe对象里.</span></div><div class="line">				<span class="comment">// 此时就将NioServerSocketChannel与Reactor主线程关联起来了</span></div><div class="line">				ChannelFuture regFuture = group().register(channel);</div><div class="line">        <span class="keyword">if</span> (regFuture.cause() != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (channel.isRegistered()) &#123;</div><div class="line">                channel.close();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                channel.unsafe().closeForcibly();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p><code>init()</code>的<code>ServerBootstrap</code>实现的. 这个方法主要是在<code>NioServerSocketChannel</code>的pipeline里增加一个<code>ServerBootstrapAcceptor</code>handler.<br>这个handler就是用于处理<code>NioMessageUnsafe#read()</code>方法调用<code>NioServerSocketChannel#doReadMessage()</code>方法后<code>List&lt;NioSocketChannel&gt;</code>的消息列表<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">			 <span class="comment">// 获取NioServerSocketChannel的Pipeline</span></div><div class="line">			 ChannelPipeline p = channel.pipeline();</div><div class="line">			 <span class="keyword">if</span> (handler() != <span class="keyword">null</span>) &#123;</div><div class="line">					 p.addLast(handler());</div><div class="line">			 &#125;</div><div class="line"></div><div class="line">			 <span class="keyword">final</span> EventLoopGroup currentChildGroup = childGroup;</div><div class="line">			 <span class="keyword">final</span> ChannelHandler currentChildHandler = childHandler;</div><div class="line">			 <span class="keyword">final</span> Entry&lt;ChannelOption&lt;?&gt;, Object&gt;[] currentChildOptions;</div><div class="line">			 <span class="keyword">final</span> Entry&lt;AttributeKey&lt;?&gt;, Object&gt;[] currentChildAttrs;</div><div class="line"></div><div class="line">			 p.addLast(<span class="keyword">new</span> ChannelInitializer&lt;Channel&gt;() &#123;</div><div class="line">					 <span class="meta">@Override</span></div><div class="line">					 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(Channel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">						 	 <span class="comment">// 这里主要是产生网络连接时将处理数据的channel与Reactor从线程关联起来</span></div><div class="line">							 ch.pipeline().addLast(<span class="keyword">new</span> ServerBootstrapAcceptor(</div><div class="line">											 currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));</div><div class="line">					 &#125;</div><div class="line">			 &#125;);</div><div class="line">	 &#125;</div></pre></td></tr></table></figure></p>
<p>我们看到<code>ServerBootstrapAcceptor</code>也是实现自<code>ChannelInboundHandlerAdapter</code>, 因此它也是一个handler. 在<code>NioMessageUnsafe#read()</code>方法里会遍历<br><code>List&lt;NioSocketChannel&gt;</code>这个消息列表后触发<code>NioServerSocketChannel</code>的pipeline的<code>fireChannelRead()</code>方法, 接着就会触发<code>ServerBootstrapAcceptor#channelRead()</code>,<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerBootstrapAcceptor</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> EventLoopGroup childGroup;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ChannelHandler childHandler;</div><div class="line">        ServerBootstrapAcceptor(</div><div class="line">                EventLoopGroup childGroup, ChannelHandler childHandler) &#123;</div><div class="line">            <span class="keyword">this</span>.childGroup = childGroup;</div><div class="line">            <span class="keyword">this</span>.childHandler = childHandler;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> </span>&#123;</div><div class="line">            <span class="comment">// msg实际是NioSocketChannel类型</span></div><div class="line">            <span class="keyword">final</span> Channel child = (Channel) msg;</div><div class="line">            child.pipeline().addLast(childHandler);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">							  <span class="comment">// 将处理数据的NioSocketChannel与主从Reactor模型中的从Reactor线程关联起来</span></div><div class="line">                childGroup.register(child).addListener(<span class="keyword">new</span> ChannelFutureListener());</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>然后我们看一下<code>NioEventLoop</code>的<code>register()</code>方法过程. 这个方法调用其实最终调用的是<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">SingleThreadEventLoop</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line">	 <span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">register</span><span class="params">(<span class="keyword">final</span> Channel channel, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">			 channel.unsafe().register(<span class="keyword">this</span>, promise);</div><div class="line">			 <span class="keyword">return</span> promise;</div><div class="line">	 &#125;</div></pre></td></tr></table></figure></p>
<p>然后后续调用到了<code>AbstractUnsafe</code>的<code>register()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(EventLoop eventLoop, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">              AbstractChannel.<span class="keyword">this</span>.eventLoop = eventLoop;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (eventLoop.inEventLoop()) &#123;</div><div class="line">                register0(promise);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    eventLoop.execute(<span class="keyword">new</span> OneTimeTask() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                            register0(promise);</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">				<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register0</span><span class="params">(ChannelPromise promise)</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                doRegister();</div><div class="line">                pipeline.fireChannelRegistered();</div><div class="line">                <span class="comment">// Only fire a channelActive if the channel has never been registered. This prevents firing</span></div><div class="line">                <span class="comment">// multiple channel actives if the channel is deregistered and re-registered.</span></div><div class="line">                <span class="keyword">if</span> (firstRegistration &amp;&amp; isActive()) &#123;</div><div class="line">                    pipeline.fireChannelActive();</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>接着调用<code>AbstractNioChannel</code>的<code>doRegister()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegister</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> selected = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                selectionKey = javaChannel().register(eventLoop().selector, <span class="number">0</span>, <span class="keyword">this</span>);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>最终我们看到了, 当前JDK里的Channel注册到了EventLoop的IO多路复用器上面</p>
<p>看到这里之后, 我们再接着返回到<code>doBind()</code>方法继续看<code>doBind0()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doBind0</span><span class="params">(</span></span></div><div class="line">            <span class="keyword">final</span> ChannelFuture regFuture, <span class="keyword">final</span> Channel channel,</div><div class="line">            <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise) &#123;</div><div class="line"></div><div class="line">        <span class="comment">// This method is invoked before channelRegistered() is triggered.  Give user handlers a chance to set up</span></div><div class="line">        <span class="comment">// the pipeline in its channelRegistered() implementation.</span></div><div class="line">        channel.eventLoop().execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (regFuture.isSuccess()) &#123;</div><div class="line">                    channel.bind(localAddress, promise).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    promise.setFailure(regFuture.cause());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>我们看到当在bind的时候也是调用的channel的bind(), 真实的bind是在<code>AbstractChannel</code>里发生的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> pipeline.bind(localAddress, promise);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后调用的是<code>DefaultChannelPipeline</code>的<code>bind()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"> <span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;</div><div class="line">		 <span class="keyword">return</span> tail.bind(localAddress, promise);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>再具体的bind的话, 就要参考<code>DeaultChannelPipeline</code>的实现了</p>
<p>最后我们总结一下</p>
<ol>
<li>首先将NioServerSocketChannel与主Reactor线程池的Selector进行注册绑定</li>
<li>当NioServerSocketChannel接收到网络连接的时候(doReadMessage())会生成一个<code>NioSocketChannel</code>的消息列表</li>
<li>然后<code>ServerBootstrapAcceptor</code>负责将<code>NioSocketChannel</code>与从Reactor的Selector进行注册绑定</li>
<li>最后由从Reactor线程池中的Selector进行IO调度, 读写网络数据</li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Netty/">Netty</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/02/22/JavaLibrary/Netty ServerBootstrap/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/02/22/JavaLibrary/Netty ServerBootstrap/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/02/03/JavaLibrary/MessagePack 初探/" title="MessagePack 初探" itemprop="url">MessagePack 初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-02-02T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-02-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>MessagePack 是一个高效的二进制数据序列化工具. 使用它可以让你像使用JSON那样在多种语言中进行数据交换, 但是它比JSON更加小巧,迅捷.</p>
<p>在Java中使用的话, 我们首先添加maven依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.msgpack<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>msgpack<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>首先看一个简单的示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.msgpack.MessagePack;</div><div class="line"><span class="keyword">import</span> org.msgpack.annotation.Message;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main1</span> </span>&#123;</div><div class="line">    <span class="meta">@Message</span> <span class="comment">// Annotation</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMessage</span> </span>&#123;</div><div class="line">        <span class="comment">// public fields are serialized.</span></div><div class="line">        <span class="keyword">public</span> String name;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">double</span> version;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        MyMessage src = <span class="keyword">new</span> MyMessage();</div><div class="line">        src.name = <span class="string">"msgpack"</span>;</div><div class="line">        src.version = <span class="number">0.6</span>;</div><div class="line"></div><div class="line">        MessagePack msgpack = <span class="keyword">new</span> MessagePack();</div><div class="line">        <span class="comment">// Serialize</span></div><div class="line">        <span class="keyword">byte</span>[] bytes = msgpack.write(src);</div><div class="line">        <span class="comment">// Deserialize</span></div><div class="line">        MyMessage dst = msgpack.read(bytes, MyMessage.class);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在上面的例子中我们看到将一个<code>MyMessage</code>序列化成byte数组, 同时又将其反序列化出来了. 但是如果我们要同时序列化多个对象呢？那么我们就可以使用<code>Packer</code>和<code>Unpacker</code>.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</div><div class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.msgpack.MessagePack;</div><div class="line"><span class="keyword">import</span> org.msgpack.annotation.Message;</div><div class="line"><span class="keyword">import</span> org.msgpack.packer.Packer;</div><div class="line"><span class="keyword">import</span> org.msgpack.unpacker.Unpacker;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main2</span> </span>&#123;</div><div class="line">    <span class="meta">@Message</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMessage</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> String name;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">double</span> version;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        MyMessage src1 = <span class="keyword">new</span> MyMessage();</div><div class="line">        src1.name = <span class="string">"msgpack"</span>;</div><div class="line">        src1.version = <span class="number">0.6</span>;</div><div class="line">        MyMessage src2 = <span class="keyword">new</span> MyMessage();</div><div class="line">        src2.name = <span class="string">"muga"</span>;</div><div class="line">        src2.version = <span class="number">10.0</span>;</div><div class="line">        MyMessage src3 = <span class="keyword">new</span> MyMessage();</div><div class="line">        src3.name = <span class="string">"frsyukik"</span>;</div><div class="line">        src3.version = <span class="number">1.0</span>;</div><div class="line"></div><div class="line">        MessagePack msgpack = <span class="keyword">new</span> MessagePack();</div><div class="line">        <span class="comment">// Serialize</span></div><div class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        Packer packer = msgpack.createPacker(out);</div><div class="line">        packer.write(src1);</div><div class="line">        packer.write(src2);</div><div class="line">        packer.write(src3);</div><div class="line">        <span class="keyword">byte</span>[] bytes = out.toByteArray();</div><div class="line"></div><div class="line">        <span class="comment">// Deserialize</span></div><div class="line">        ByteArrayInputStream in = <span class="keyword">new</span> ByteArrayInputStream(bytes);</div><div class="line">        Unpacker unpacker = msgpack.createUnpacker(in);</div><div class="line">        MyMessage dst1 = unpacker.read(MyMessage.class);</div><div class="line">        MyMessage dst2 = unpacker.read(MyMessage.class);</div><div class="line">        MyMessage dst3 = unpacker.read(MyMessage.class);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其实<code>Packer</code>和<code>Unpacker</code>内置了非常多了序列化类型<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</div><div class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</div><div class="line"><span class="keyword">import</span> java.math.BigInteger;</div><div class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.msgpack.MessagePack;</div><div class="line"><span class="keyword">import</span> org.msgpack.packer.Packer;</div><div class="line"><span class="keyword">import</span> org.msgpack.unpacker.Unpacker;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main3</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        MessagePack msgpack = <span class="keyword">new</span> MessagePack();</div><div class="line"></div><div class="line">        <span class="comment">// Serialization</span></div><div class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        Packer packer = msgpack.createPacker(out);</div><div class="line"></div><div class="line">        <span class="comment">// 对原生类型进行序列化</span></div><div class="line">        packer.write(<span class="keyword">true</span>); <span class="comment">// boolean value</span></div><div class="line">        packer.write(<span class="number">10</span>); <span class="comment">// int value</span></div><div class="line">        packer.write(<span class="number">10.5</span>); <span class="comment">// double value</span></div><div class="line"></div><div class="line">        <span class="comment">// 对原生包装类型进行序列化</span></div><div class="line">        packer.write(Boolean.TRUE);</div><div class="line">        packer.write(<span class="keyword">new</span> Integer(<span class="number">10</span>));</div><div class="line">        packer.write(<span class="keyword">new</span> Double(<span class="number">10.5</span>));</div><div class="line"></div><div class="line">        <span class="comment">// 对数组进行序列化</span></div><div class="line">        packer.write(<span class="keyword">new</span> <span class="keyword">int</span>[] &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span> &#125;);</div><div class="line">        packer.write(<span class="keyword">new</span> Double[] &#123; <span class="number">10.5</span>, <span class="number">20.5</span> &#125;);</div><div class="line">        packer.write(<span class="keyword">new</span> String[] &#123; <span class="string">"msg"</span>, <span class="string">"pack"</span>, <span class="string">"for"</span>, <span class="string">"java"</span> &#125;);</div><div class="line">        packer.write(<span class="keyword">new</span> <span class="keyword">byte</span>[] &#123; <span class="number">0x30</span>, <span class="number">0x31</span>, <span class="number">0x32</span> &#125;); <span class="comment">// byte array</span></div><div class="line"></div><div class="line">        <span class="comment">// 对其他引用类型进行序列化</span></div><div class="line">        packer.write(<span class="string">"MessagePack"</span>); <span class="comment">// String object</span></div><div class="line">        packer.write(ByteBuffer.wrap(<span class="keyword">new</span> <span class="keyword">byte</span>[] &#123; <span class="number">0x30</span>, <span class="number">0x31</span>, <span class="number">0x32</span> &#125;)); <span class="comment">// ByteBuffer object</span></div><div class="line">        packer.write(BigInteger.ONE); <span class="comment">// BigInteger object</span></div><div class="line"></div><div class="line">        <span class="comment">// 反序列化</span></div><div class="line">        <span class="keyword">byte</span>[] bytes = out.toByteArray();</div><div class="line">        ByteArrayInputStream in = <span class="keyword">new</span> ByteArrayInputStream(bytes);</div><div class="line">        Unpacker unpacker = msgpack.createUnpacker(in);</div><div class="line"></div><div class="line">        <span class="comment">// 反序列化出原生类型</span></div><div class="line">        <span class="keyword">boolean</span> b = unpacker.readBoolean(); <span class="comment">// boolean value</span></div><div class="line">        <span class="keyword">int</span> i = unpacker.readInt(); <span class="comment">// int value</span></div><div class="line">        <span class="keyword">double</span> d = unpacker.readDouble(); <span class="comment">// double value</span></div><div class="line"></div><div class="line">        <span class="comment">// 反序列化出原生包装类型</span></div><div class="line">        Boolean wb = unpacker.read(Boolean.class);</div><div class="line">        Integer wi = unpacker.read(Integer.class);</div><div class="line">        Double wd = unpacker.read(Double.class);</div><div class="line"></div><div class="line">        <span class="comment">// 反序列化出数组</span></div><div class="line">        <span class="keyword">int</span>[] ia = unpacker.read(<span class="keyword">int</span>[].class);</div><div class="line">        Double[] da = unpacker.read(Double[].class);</div><div class="line">        String[] sa = unpacker.read(String[].class);</div><div class="line">        <span class="keyword">byte</span>[] ba = unpacker.read(<span class="keyword">byte</span>[].class);</div><div class="line"></div><div class="line">        <span class="comment">// 反序列化出 String, ByteBuffer, BigInteger, List 和 Map</span></div><div class="line">        String ws = unpacker.read(String.class);</div><div class="line">        ByteBuffer buf = unpacker.read(ByteBuffer.class);</div><div class="line">        BigInteger bi = unpacker.read(BigInteger.class);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对于<code>List, Map</code>这俩种类型的序列化, 我们需要额外说明一下. 在序列化<code>List, Map</code>的时候, 我们需要使用<code>Template</code>对其进行转换.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</div><div class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</div><div class="line"><span class="keyword">import</span> java.util.*;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.msgpack.MessagePack;</div><div class="line"><span class="keyword">import</span> org.msgpack.packer.Packer;</div><div class="line"><span class="keyword">import</span> org.msgpack.template.Template;</div><div class="line"><span class="keyword">import</span> org.msgpack.unpacker.Unpacker;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.msgpack.template.Templates.tList;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.msgpack.template.Templates.tMap;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.msgpack.template.Templates.TString;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main4</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        MessagePack msgpack = <span class="keyword">new</span> MessagePack();</div><div class="line"></div><div class="line">		<span class="comment">// 创建序列化/反序列化 List 和 Map 对象的模板</span></div><div class="line">		Template&lt;List&lt;String&gt;&gt; listTmpl = tList(TString);</div><div class="line">		Template&lt;Map&lt;String, String&gt;&gt; mapTmpl = tMap(TString, TString);</div><div class="line"></div><div class="line">		<span class="comment">// 开始序列化</span></div><div class="line">		ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">		Packer packer = msgpack.createPacker(out);</div><div class="line"></div><div class="line">		<span class="comment">// 序列化 List 对象</span></div><div class="line">		List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">		list.add(<span class="string">"msgpack"</span>);</div><div class="line">		list.add(<span class="string">"for"</span>);</div><div class="line">		list.add(<span class="string">"java"</span>);</div><div class="line">		packer.write(list); <span class="comment">// List object</span></div><div class="line"></div><div class="line">		<span class="comment">// 序列化 Map 对象</span></div><div class="line">		Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line">		map.put(<span class="string">"sadayuki"</span>, <span class="string">"furuhashi"</span>);</div><div class="line">		map.put(<span class="string">"muga"</span>, <span class="string">"nishizawa"</span>);</div><div class="line">		packer.write(map); <span class="comment">// Map object</span></div><div class="line"></div><div class="line">		<span class="comment">// 开始反序列化</span></div><div class="line">		<span class="keyword">byte</span>[] bytes = out.toByteArray();</div><div class="line">		ByteArrayInputStream in = <span class="keyword">new</span> ByteArrayInputStream(bytes);</div><div class="line">		Unpacker unpacker = msgpack.createUnpacker(in);</div><div class="line"></div><div class="line">		<span class="comment">// 反序列化出 List 对象</span></div><div class="line">		List&lt;String&gt; dstList = unpacker.read(listTmpl);</div><div class="line"></div><div class="line">		<span class="comment">//  反序列化出 Map 对象</span></div><div class="line">		Map&lt;String, String&gt; dstMap = unpacker.read(mapTmpl);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>有时候我们可能没有办法将POJO类添加上<code>Message</code>注解(可能没有访问那个类的权限), 但是我们又想对其进行序列化, 那怎么办呢？<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">MessagePack msgpack = <span class="keyword">new</span> MessagePack();</div><div class="line">msgpack.<span class="keyword">register</span>(MyMessage2.<span class="keyword">class</span>);</div></pre></td></tr></table></figure></p>
<p>我们只要向需要序列化的类注册到<code>MessagePack</code>上就可以了.</p>
<p>有时候,我们可能不需要对某个属性进行序列化, 例如线上某个老版本里并没有A属性, 但是在新的版本里填上了A属性, 但是又要兼容老版本怎么办呢？我们可以使用<code>@Optional</code>注解<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Message</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMessage</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> String name;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">double</span> version;</div><div class="line"></div><div class="line">    <span class="comment">// new field</span></div><div class="line">    <span class="meta">@Optional</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> flag = <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>MessagePack还提供了动态类型特性.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.*;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.msgpack.MessagePack;</div><div class="line"><span class="keyword">import</span> org.msgpack.type.Value;</div><div class="line"><span class="keyword">import</span> org.msgpack.unpacker.Converter;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.msgpack.template.Templates.*;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main5</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// Create serialize objects.</span></div><div class="line">        List&lt;String&gt; src = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">        src.add(<span class="string">"msgpack"</span>);</div><div class="line">        src.add(<span class="string">"kumofs"</span>);</div><div class="line">        src.add(<span class="string">"viver"</span>);</div><div class="line"></div><div class="line">        MessagePack msgpack = <span class="keyword">new</span> MessagePack();</div><div class="line">        <span class="comment">// Serialize</span></div><div class="line">        <span class="keyword">byte</span>[] raw = msgpack.write(src);</div><div class="line"></div><div class="line">        <span class="comment">// Deserialize directly using a template</span></div><div class="line">        List&lt;String&gt; dst1 = msgpack.read(raw, tList(TString));</div><div class="line"></div><div class="line">        <span class="comment">// Or, Deserialze to Value then convert type.</span></div><div class="line">        Value dynamic = msgpack.read(raw);</div><div class="line">        List&lt;String&gt; dst2 = <span class="keyword">new</span> Converter(dynamic).read(tList(TString));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当从MessagePack里读取数据的时候, 我们可以先不指定其转换的类型,　使用<code>Value</code>来代替, 等后期我们再使用<code>Converter</code> 对其转换.</p>
<p>接下来我们对其与JSON进行对比<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">msgpack</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		MessagePack msgpack = <span class="keyword">new</span> MessagePack();</div><div class="line"></div><div class="line">		List&lt;SeObj&gt; list = list();</div><div class="line">		<span class="keyword">long</span> start1 = System.currentTimeMillis();</div><div class="line">		<span class="keyword">byte</span>[] bytes1 = msgpack.write(list);</div><div class="line">		<span class="keyword">long</span> end1 = System.currentTimeMillis();</div><div class="line">		System.out.println((end1 - start1) + <span class="string">" : "</span> + bytes1.length);</div><div class="line"></div><div class="line">		<span class="keyword">long</span> start2 = System.currentTimeMillis();</div><div class="line">		String json = JSON.toJSONString(list);</div><div class="line">		<span class="keyword">long</span> end2 = System.currentTimeMillis();</div><div class="line">		System.out.println((end2 - start2) + <span class="string">" : "</span> + json.getBytes().length);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;SeObj&gt; <span class="title">list</span><span class="params">()</span> </span>&#123;</div><div class="line">		List&lt;SeObj&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">		Random random = <span class="keyword">new</span> Random();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</div><div class="line">			SeObj seObj = <span class="keyword">new</span> SeObj();</div><div class="line">			seObj.id = random.nextInt(<span class="number">100000</span>);</div><div class="line">			seObj.tall = random.nextFloat();</div><div class="line">			seObj.name = <span class="string">"name"</span> + random.nextInt(<span class="number">100000</span>);</div><div class="line">			list.add(seObj);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> list;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Message</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SeObj</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> id;</div><div class="line">	<span class="keyword">public</span> String name;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">float</span> tall;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="number">100</span>的结果</div><div class="line"><span class="number">194</span> : <span class="number">1960</span></div><div class="line"><span class="number">50</span> : <span class="number">4947</span></div><div class="line"><span class="number">1000</span>的结果</div><div class="line"><span class="number">210</span> : <span class="number">19589</span></div><div class="line"><span class="number">70</span> : <span class="number">49424</span></div><div class="line"><span class="number">10000</span>的结果</div><div class="line"><span class="number">212</span> : <span class="number">195765</span></div><div class="line"><span class="number">160</span> : <span class="number">493987</span></div><div class="line"><span class="number">100000</span>的结果</div><div class="line"><span class="number">283</span> : <span class="number">1956964</span></div><div class="line"><span class="number">330</span> : <span class="number">4940270</span></div><div class="line"><span class="number">1000000</span>的结果</div><div class="line"><span class="number">649</span> : <span class="number">19573508</span></div><div class="line"><span class="number">1878</span> : <span class="number">49404120</span></div></pre></td></tr></table></figure></p>
<p>我们发现MessagePack的耗时相对来说是比较稳定的, 但是在生成的数据量上比JSON要强一倍多</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/02/03/JavaLibrary/MessagePack 初探/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/02/03/JavaLibrary/MessagePack 初探/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/02/02/JavaSE/Java volatile/" title="volatile 使用" itemprop="url">volatile 使用</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-02-01T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-02-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>在讲<code>volatile</code>的之前,我们先看一下java的内存模型. 我们知道当我们<code>new</code>出来一个对象的时候,这个对象会被直接分配到堆上(暂不考虑栈上分配等技术). 而程序的逻辑是在方法中定义的,方法运行在线程里也就是栈上. 因此JVM会将线程里使用的数据从堆上拷贝到线程的本地存储上. 这个过程涉及了下列8个操作</p>
<ol>
<li>lock: 将堆上的变量标志为某个线程独享的状态</li>
<li>unlock: 将堆上的变量释放出来, 以便被其他线程锁定</li>
<li>read: 将某个变量从堆上拷贝到线程的工作内存上</li>
<li>load: 将已经从堆上拷贝到线程的工作内存上的变量放入到变量副本中</li>
<li>use: 将线程变量副本中的变量传递给虚拟机执行引擎. (每当虚拟机遇到一个需要使用该变量的字节码指令时,都会执行该操作)</li>
<li>assign: 将虚拟机执行引擎返回的变量的值赋值到工作变量中</li>
<li>store: 将工作变量值传递到堆内存中.</li>
<li>write: 将从线程工作变量中接受到的值写入到主内存变量中</li>
</ol>
<p>当一个变量被<code>volatile</code>修饰后, 每次<code>load</code>操作都是从堆中获取值, <code>assign</code>的时候也是直接写回到堆中内存变量中, 而不是在线程本地变量中操作.</p>
<p>volatile变量具备俩种特性</p>
<ul>
<li>线程可见性: 某个线程修改了被<code>volatile</code>修饰的变量后,其他线程可以里面看见这个最新的值.</li>
<li>禁止指令重排序优化</li>
</ul>
<blockquote>
<p><code>volatile</code>最适用的场景是一个线程写,多个线程读的场景. 如果有多个线程同时写的话还是需要锁或者并发容器等等进行保护</p>
</blockquote>
<p>下面我们看一个指令重排序的例子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">			<span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">			<span class="keyword">while</span> (!stop) &#123;</div><div class="line">				i++;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		thread.start();</div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		stop = <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的这段代码会被优化成(这种优化也被称为提升优化)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">			<span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">			<span class="keyword">if</span> (!stop) &#123;</div><div class="line">				<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">					i++;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		thread.start();</div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		stop = <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是如果<code>stop</code>变量被<code>volatile</code>修饰后<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">			<span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">			<span class="keyword">while</span> (!stop) &#123;</div><div class="line">				i++;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		thread.start();</div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		stop = <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>程序就能正确的停止运行了</p>
<blockquote>
<p>Java中对于重排序是这样规定的, 只要在单线程环境中, 重排序前后代码的运行结果总是一致的, 那么这段代码的重排序就是合法的. 但是当在多线程的环境中, 重排序就会影响到程序的执行, 就像刚才我们的例子展示的那样. 例外还有一点值得说明的是, 当代码中运行时包含<code>native</code>方法时, 会打断编译器的重排序(例如<code>System.out.println()</code>或者<code>Threads.sleep()</code>)</p>
</blockquote>
<p><code>volatile</code>并不能解决并发写的情况, 正如我们开头所说的<code>volatile</code>最适用的场景是一个线程写,多个线程读的场景. 例如下面的程序, 无论我是否对<code>counter</code>进行<code>volatile</code>修饰都不能解决并发异常的问题<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> counter = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		List&lt;Thread&gt; threads = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</div><div class="line">			Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">				<span class="comment">// 并发写counter</span></div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					TimeUnit.MILLISECONDS.sleep(<span class="number">50</span>);</div><div class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">					e.printStackTrace();</div><div class="line">				&#125;</div><div class="line">				counter++;</div><div class="line">			&#125;);</div><div class="line"></div><div class="line">			thread.start();</div><div class="line">			threads.add(thread);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		threads.forEach(thread -&gt; &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				thread.join();</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		System.out.println(counter);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的程序最后的输出结果, 总是小于100000.</p>
<blockquote>
<p>还有一点需要说明的是,<code>volatile</code>修饰的数组,只能保证数组本身的内存可见性,但是对于其中的元素的修改是不会保证的.</p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/02/02/JavaSE/Java volatile/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/02/02/JavaSE/Java volatile/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/02/02/JavaLibrary/Netty ChannelPipeline/" title="Netty ChannelHandler 和 ChannelPipeline" itemprop="url">Netty ChannelHandler 和 ChannelPipeline</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-02-01T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-02-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="ChannelHandler"><a href="#ChannelHandler" class="headerlink" title="ChannelHandler"></a>ChannelHandler</h2><p>在写Netty Application的时候, 我们一般要做的就是俩件事</p>
<ol>
<li>使用ServerBootstrap构建一个启动器, 监听网络事件</li>
<li>实现ChannelHandler接口完成网络事件的decoder和encoder功能</li>
</ol>
<blockquote>
<p>之所以在提供了handle的接口之后还提供Adapter, 是因为如果我们直接实现handler接口的话, 那么我们就需要实现handler里的所有方法, 但是我们可能要在不同的handler里实现不同的功能, 而这些功能恰巧由不同的handler里的方法实现, 那么每个实现了handler接口的类都会有大量的冗余代码. 但是如果我们继承Adapter的话, 我们只需要重写需要实现功能的方法就可以了.</p>
</blockquote>
<p>今天就来看看ChannelHandler的写法和实现, 首先我们看一下<code>ChannelHandler</code>的继承结构<br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/netty/netty%20ChannelHadler.jpg" alt=""><br>我们用<code>ChannelInboundHandler</code>处理写入事件, 用<code>ChannelOutboundHandler</code>处理写出事件. 下面我们看一下如何自己实现一个inbound和outbound handler<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInboundHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Connected!"</span>);</div><div class="line">        ctx.fireChannelActive();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> clas MyOutboundHandler extends ChannelOutboundHandlerAdapter &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(ChannelHandlerContext ctx, ChannelPromise&#125; promise)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Closing .."</span>);</div><div class="line">        ctx.close(promise);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ChannelPipeline"><a href="#ChannelPipeline" class="headerlink" title="ChannelPipeline"></a>ChannelPipeline</h2><p>简单地介绍了一下<code>ChannelHandler</code>, 但是在说它之前, 还是不得不先介绍一下<code>ChannelPipeline</code>, 它是一个基于链表实现的<code>ChannelHandler</code>的集合, 用于处理或者截断<code>Channel</code>的<code>inbound events</code>和<code>outbound operations</code>. (<code>ChannelPipeline</code>是<a href="http://www.oracle.com/technetwork/java/interceptingfilter-142169.html" target="_blank" rel="external">Intercepting Filter</a>的一个高级实现, 它保证了用户对事件处理的完整控制权以及确保了<code>ChannelHandler</code>在pipeline中的运行方式.)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultChannelPipeline</span> <span class="keyword">implements</span> <span class="title">ChannelPipeline</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> AbstractChannelHandlerContext head;</div><div class="line">    <span class="keyword">final</span> AbstractChannelHandlerContext tail;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Channel channel;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">DefaultChannelPipeline</span><span class="params">(Channel channel)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.channel = ObjectUtil.checkNotNull(channel, <span class="string">"channel"</span>);</div><div class="line"></div><div class="line">        tail = <span class="keyword">new</span> TailContext(<span class="keyword">this</span>);</div><div class="line">        head = <span class="keyword">new</span> HeadContext(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">        head.next = tail;</div><div class="line">        tail.prev = head;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>每当创建一个<code>Channel</code>的时候, 都会创建出一个对应的<code>ChannelPipeline</code>, 也就是说每个<code>Channel</code>都有其自己的<code>ChannelPipeline</code>. 在<code>AbstractChannel</code>中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractChannel</span> <span class="keyword">extends</span> <span class="title">DefaultAttributeMap</span> <span class="keyword">implements</span> <span class="title">Channel</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Channel parent;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DefaultChannelPipeline pipeline;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">AbstractChannel</span><span class="params">(Channel parent)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.parent = parent;</div><div class="line">        pipeline = newChannelPipeline();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> DefaultChannelPipeline <span class="title">newChannelPipeline</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultChannelPipeline(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看到这里就需要点出一点了, 网络事件是从Channel中传递到Pipeline中, 然后在Pipeline中遍历ChannelHandler链表, 触发相应的方法.</p>
<p>当我们增加一个<code>ChannelHandler</code>时<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelPipeline <span class="title">addFirst</span><span class="params">(EventExecutorGroup group, <span class="keyword">final</span> String name, ChannelHandler handler)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        checkDuplicateName(name);</div><div class="line">        <span class="comment">// 我们将handler和ChannelPipeline, EventLoop封装到一个Context里</span></div><div class="line">        DefaultChannelHandlerContext newCtx = <span class="keyword">new</span> DefaultChannelHandlerContext(<span class="keyword">this</span>, group, name, handler);</div><div class="line">        addFirst0(name, newCtx);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addFirst0</span><span class="params">(String name, DefaultChannelHandlerContext newCtx)</span> </span>&#123;</div><div class="line">    checkMultiplicity(newCtx);</div><div class="line"></div><div class="line">    <span class="comment">// 我们将添加的handler放到链表的第一个位置上</span></div><div class="line">    DefaultChannelHandlerContext nextCtx = head.next;</div><div class="line">    newCtx.prev = head;</div><div class="line">    newCtx.next = nextCtx;</div><div class="line">    head.next = newCtx;</div><div class="line">    nextCtx.prev = newCtx;</div><div class="line"></div><div class="line">    name2ctx.put(name, newCtx);</div><div class="line"></div><div class="line">    callHandlerAdded(newCtx);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callHandlerAdded</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (ctx.channel().isRegistered() &amp;&amp; !ctx.executor().inEventLoop()) &#123;</div><div class="line">        <span class="comment">// 如果Channel已经注册到eventLoop上, 且当前线程与eventLoop中的线程不是同一个, 也就是说当前操作是多线程进行的,</span></div><div class="line">        <span class="comment">// 则将callHandlerAdded0()逻辑放到任务队列中进行执行</span></div><div class="line">        ctx.executor().execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                callHandlerAdded0(ctx);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    callHandlerAdded0(ctx);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callHandlerAdded0</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        ctx.handler().handlerAdded(ctx);</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看到最终的时候在<code>ChannelHandler</code>里添加了<code>ChannelHandlerContext</code>. 但是经过查看<code>ByteToMessageDecoder</code>, <code>ChannelInboundHandlerAdapter</code>, <code>ChannelHandlerAdapter</code><br>这个都是空实现, 也就是说, 如果用户自己没有重载的话, 那么这里不会有任何的逻辑产生.</p>
<blockquote>
<p>我们可以在任何时间在<code>ChannelPipeline</code>上添加或者移除<code>ChannelHandler</code>, 因为<code>ChannelPipeline</code>是线程安全的. 例如我们可以在线上环境中因为业务原因动态的添加或者移除handler.</p>
</blockquote>
<p>下面的图给出了IO事件是如何在<code>ChannelPipeline</code>里的<code>ChannelHandler</code>进行传递处理的. IO事件由<code>ChannelInboundHandler</code>或者<code>ChannelOutboundHandler</code>处理, 我们在handler中调用<code>ChannelHandlerContext</code>中的事件传播方法将event传播给下一个handler继续执行, 例如调用<code>ChannelHandlerContext#fireChannelRead(Object)</code>和<code>ChannelHandlerContext#write(Object)</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">                                               I/O Request</div><div class="line">                                          via Channel&#125; or</div><div class="line">                                      ChannelHandlerContext&#125;</div><div class="line">                                                    |</div><div class="line">+---------------------------------------------------+---------------+</div><div class="line">|                           ChannelPipeline         |               |</div><div class="line">|                                                  \|/              |</div><div class="line">|    +---------------------+            +-----------+----------+    |</div><div class="line">|    | Inbound Handler  N  |            | Outbound Handler  <span class="number">1</span>  |    |</div><div class="line">|    +----------+----------+            +-----------+----------+    |</div><div class="line">|              /|\                                  |               |</div><div class="line">|               |                                  \|/              |</div><div class="line">|    +----------+----------+            +-----------+----------+    |</div><div class="line">|    | Inbound Handler N-<span class="number">1</span> |            | Outbound Handler  <span class="number">2</span>  |    |</div><div class="line">|    +----------+----------+            +-----------+----------+    |</div><div class="line">|              /|\                                  .               |</div><div class="line">|               .                                   .               |</div><div class="line">| ChannelHandlerContext.fireIN_EVT() ChannelHandlerContext.OUT_EVT()|</div><div class="line">|        [ method call]                       [method call]         |</div><div class="line">|               .                                   .               |</div><div class="line">|               .                                  \|/              |</div><div class="line">|    +----------+----------+            +-----------+----------+    |</div><div class="line">|    | Inbound Handler  <span class="number">2</span>  |            | Outbound Handler M-<span class="number">1</span> |    |</div><div class="line">|    +----------+----------+            +-----------+----------+    |</div><div class="line">|              /|\                                  |               |</div><div class="line">|               |                                  \|/              |</div><div class="line">|    +----------+----------+            +-----------+----------+    |</div><div class="line">|    | Inbound Handler  <span class="number">1</span>  |            | Outbound Handler  M  |    |</div><div class="line">|    +----------+----------+            +-----------+----------+    |</div><div class="line">|              /|\                                  |               |</div><div class="line">+---------------+-----------------------------------+---------------+</div><div class="line">                |                                  \|/</div><div class="line">+---------------+-----------------------------------+---------------+</div><div class="line">|               |                                   |               |</div><div class="line">|       [ Socket.read() ]                    [ Socket.write() ]     |</div><div class="line">|                                                                   |</div><div class="line">|  Netty Internal I/<span class="function">O <span class="title">Threads</span> <span class="params">(Transport Implementation)</span>            |</span></div><div class="line">+-------------------------------------------------------------------+</div></pre></td></tr></table></figure></p>
<p>从上图中我们可以看出左边是<code>inbound</code>handler(从下向上进行处理), 右图是<code>outbound</code>流程(从上向下进行处理).<code>inbound</code>handler通常处理的是由IO线程生成的<code>inbound</code>数据(例如<code>SocketChannel#read(ByteBuffer)</code>).<br><code>outbound</code>handler一般由write请求生成或者转换传输数据. 如果<code>outbound</code>数据传输到上图的底部后, 它就会被绑定到<code>Channel</code>上的IO线程进行操作. IO线程一般会进行<code>SocketChannel#write(ByteBuffer)</code>数据输出操作.</p>
<blockquote>
<p>底层的<code>SocketChannel#read()</code>方法读取<code>ByteBuf</code>, 然后由IO线程<code>NioEventLoop</code>调用<code>ChannelPipeline#fireChannelRead()</code>方法,将消息<code>ByteBuf</code>传递到<code>ChannelPipeline</code>中.</p>
</blockquote>
<p>可以预想到的是, 用户在使用pipeline中肯定最少会有一个<code>ChannelHandler</code>用来接受IO事件(例如read操作)和响应IO操作(例如write和close). 例如一个标准的服务器在每个channel中的pipeline中会有如下的handler</p>
<ul>
<li>Protocol Decoder ： 将二进制的字节码(例如<code>ByteBuf</code>中的数据)解析成Java对象</li>
<li>Protocol Encoder :  将Java对象转换成二进制数据进行网络传输</li>
<li>Business Logic Handler : 执行真正的业务逻辑</li>
</ul>
<p>在下面的示例中我们分别在pipeline中添加俩个<code>inbound</code>handler和俩个<code>outbound</code>handler.(以<code>Inbound</code>开头的类名表示为一个<code>inbound</code>handler, 以<code>Outbound</code>开头的类名表示为一个<code>outbound</code>handler.)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ChannelPipeline p = ...;</div><div class="line">p.addLast(<span class="string">"1"</span>, <span class="keyword">new</span> InboundHandlerA());</div><div class="line">p.addLast(<span class="string">"2"</span>, <span class="keyword">new</span> InboundHandlerB());</div><div class="line">p.addLast(<span class="string">"3"</span>, <span class="keyword">new</span> OutboundHandlerA());</div><div class="line">p.addLast(<span class="string">"4"</span>, <span class="keyword">new</span> OutboundHandlerB());</div><div class="line">p.addLast(<span class="string">"5"</span>, <span class="keyword">new</span> InboundOutboundHandlerX());</div></pre></td></tr></table></figure></p>
<p>事件在<code>inbound</code>handler中的执行过程是<code>1, 2, 3, 4, 5</code>. 事件在<code>outbound</code>handler中的执行过程是<code>5, 4, 3, 2, 1</code>.</p>
<p>但是在真实的执行过程中, 由于<code>3, 4</code>并没有实现<code>ChannelInboundHandler</code>, 因此inbound流程中真正执行的handler只有<code>1, 2, 5</code>. 而由于<code>1, 2</code>并没有实现<code>ChannelOutboundHandler</code>因此在outbound流程中真正执行的handler只有<code>5, 4, 3</code>.<br>如果<code>5</code>都实现了<code>ChannelInboundHandler</code>和<code>ChannelOutboundHandler</code>, 那么事件的执行顺序分别是<code>125</code>和<code>543</code>.</p>
<h2 id="fireXXX"><a href="#fireXXX" class="headerlink" title="fireXXX"></a>fireXXX</h2><p>在<code>AbstractChannel</code>中持有一个<code>ChannelPipeline</code>的实例, 一般是由<code>Unsafe</code>里通过调用<code>ChannelPipeline</code>的<code>fireXXX()</code>方法时, 去调用<code>AbstractChannelHandlerContext</code>的<code>invokeChannelXXX</code>静态方法来完成ChannelHandler链表遍历, 这个遍历咋完成的呢？用<code>fireChannelActive()</code>举个例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">fireChannelActive</span><span class="params">()</span> </span>&#123;</div><div class="line">    AbstractChannelHandlerContext.invokeChannelActive(head);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在上面我们贴出了俩个方法, 下面我们看一下<code>fireChannelRead()</code>的处理流程.</p>
<p>在<code>AbstractChannelHandlerContext#fireChannelRead()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeChannelActive</span><span class="params">(<span class="keyword">final</span> AbstractChannelHandlerContext next)</span> </span>&#123;</div><div class="line">    EventExecutor executor = next.executor();</div><div class="line">    <span class="keyword">if</span> (executor.inEventLoop()) &#123;</div><div class="line">        next.invokeChannelActive();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        executor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                next.invokeChannelActive();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 进行处理, 是用当前Context的ChannelHandler处理真实逻辑,还是要继续遍历ChannelHandler链表,找下一个合适的ChannelHandler</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeChannelActive</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (invokeHandler()) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ((ChannelInboundHandler) handler()).channelActive(<span class="keyword">this</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            notifyHandlerException(t);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        fireChannelActive();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ChannelHandler链表遍历,　关键就是在这实现的</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelHandlerContext <span class="title">fireChannelActive</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> AbstractChannelHandlerContext next = findContextInbound();</div><div class="line">    invokeChannelActive(next);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 一直遍历整个链表直到找到inbound handler</span></div><div class="line"><span class="function"><span class="keyword">private</span> AbstractChannelHandlerContext <span class="title">findContextInbound</span><span class="params">()</span> </span>&#123;</div><div class="line">    AbstractChannelHandlerContext ctx = <span class="keyword">this</span>;</div><div class="line">    do &#123;</div><div class="line">        ctx = ctx.next;</div><div class="line">    &#125; <span class="keyword">while</span> (!ctx.inbound);</div><div class="line">    <span class="keyword">return</span> ctx;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里就直接找到了handler, 触发了我们最终自己实现的<code>channelRead()</code>方法.</p>
<p>也许你已经注意到了, 在handler中不得不调用<code>ChannelHandlerContext</code>的事件传播方法, 将事件传递给下一个handler. 下面的是能够触发<code>inbound</code>事件的方法(<code>ChannelInboundHandler</code>)</p>
<h3 id="channelRegistered"><a href="#channelRegistered" class="headerlink" title="channelRegistered"></a>channelRegistered</h3><p>Channel注册事件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">SingleThreadEventLoop<span class="comment">#register()  </span></div><div class="line">                ↓</div><div class="line">AbstractChannel<span class="comment">#AbstractUnsafe#register()</span></div><div class="line">                ↓</div><div class="line">AbstractChannel<span class="comment">#AbstractUnsafe#register0()</span></div><div class="line">                ↓				</div><div class="line">DefaultChannelPipeline<span class="comment">#fireChannelRegistered()</span></div><div class="line">                ↓</div><div class="line">ChannelInboundHandler<span class="comment">#channelRegistered()</span></div></pre></td></tr></table></figure></p>
<h3 id="channelActive"><a href="#channelActive" class="headerlink" title="channelActive"></a>channelActive</h3><p>TCP链路建立成功,Channel激活事件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">SingleThreadEventLoop<span class="comment">#register()  </span></div><div class="line">                ↓</div><div class="line">AbstractChannel<span class="comment">#AbstractUnsafe#register()</span></div><div class="line">                ↓</div><div class="line">AbstractChannel<span class="comment">#AbstractUnsafe#register0()</span></div><div class="line">                ↓				</div><div class="line">DefaultChannelPipeline<span class="comment">#fireChannelActive()</span></div><div class="line">                ↓</div><div class="line">ChannelInboundHandler<span class="comment">#channelActive()</span></div></pre></td></tr></table></figure></p>
<h3 id="channelRead"><a href="#channelRead" class="headerlink" title="channelRead"></a>channelRead</h3><p>读事件</p>
<h3 id="channelReadComplete"><a href="#channelReadComplete" class="headerlink" title="channelReadComplete"></a>channelReadComplete</h3><p>读操作完成通知事件</p>
<h3 id="exceptionCaught"><a href="#exceptionCaught" class="headerlink" title="exceptionCaught"></a>exceptionCaught</h3><p>异常通知事件</p>
<h3 id="userEventTriggered"><a href="#userEventTriggered" class="headerlink" title="userEventTriggered"></a>userEventTriggered</h3><p>用户自定义事件</p>
<h3 id="channelWritabilityChanged"><a href="#channelWritabilityChanged" class="headerlink" title="channelWritabilityChanged"></a>channelWritabilityChanged</h3><p>Channel的可写状态变化通知事件</p>
<h3 id="channelInactive"><a href="#channelInactive" class="headerlink" title="channelInactive"></a>channelInactive</h3><p>TCP链路关闭, 链路不可用通知事件</p>
<p>触发<code>outbound</code>事件的方法有(ChannelOutboundHandler)</p>
<h3 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h3><p>绑定本地地址事件</p>
<h3 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h3><p>连接服务端事件</p>
<h3 id="flush"><a href="#flush" class="headerlink" title="flush"></a>flush</h3><p>刷新事件</p>
<h3 id="read"><a href="#read" class="headerlink" title="read"></a>read</h3><p>读事件</p>
<h3 id="disconnect"><a href="#disconnect" class="headerlink" title="disconnect"></a>disconnect</h3><p>断开连接事件</p>
<h3 id="close"><a href="#close" class="headerlink" title="close"></a>close</h3><p>关闭当前Channel事件</p>
<h2 id="解码器"><a href="#解码器" class="headerlink" title="解码器"></a>解码器</h2><p>为了解决网络数据流的拆包粘包问题,Netty为我们内置了如下的解码器</p>
<ul>
<li>ByteToMessageDecoder</li>
<li>MessageToMessageDecoder</li>
<li>LineBasedFrameDecoder</li>
<li>StringDecoder</li>
<li>DelimiterBasedFrameDecoder</li>
<li>FixedLengthFrameDecoder</li>
<li>ProtoBufVarint32FrameDecoder</li>
<li>ProtobufDecoder</li>
<li>LengthFieldBasedFrameDecoder</li>
</ul>
<p>Netty还内置了如下的编码器</p>
<ul>
<li>ProtobufEncoder</li>
<li>MessageToByteEncoder</li>
<li>MessageToMessageEncoder</li>
<li>LengthFieldPrepender</li>
</ul>
<p>Netty还为我们提供HTTP相关的编解码器</p>
<ul>
<li><code>HttpRequestDecoder</code> : Http消息解码器</li>
<li><code>HttpObjectAggregator</code> : 将多个消息转换为单一的<code>FullHttpRequest</code>或者<code>FullHttpResponse</code></li>
<li><code>HttpResponseEncoder</code> : 对Http消息影响进行编码</li>
<li><code>ChunkedWriteHandler</code> : 异步大码流消息发送</li>
</ul>
<h3 id="ByteToMessageDecoder"><a href="#ByteToMessageDecoder" class="headerlink" title="ByteToMessageDecoder"></a>ByteToMessageDecoder</h3><p>如果我们自己想要实现自己的半包解码器,我们可以继承<code>ByteToMessageDecoder</code>, 实现更加复杂的半包解码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteToMessageDecoder</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span></span></div></pre></td></tr></table></figure></p>
<blockquote>
<p><a href="">ChannelInboundHandlerAdapter</a>参考</p>
</blockquote>
<p>我们只需要继承该类并实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception</span>;</div></pre></td></tr></table></figure></p>
<p>这个方法, 在这个方法里完成byte字节到java对象的转换, 也就是我们将<code>ByteBuf</code>解析成java对象然后抛给<code>List&lt;Object&gt; out</code>就可以了.</p>
<blockquote>
<p>需要注意的这个类没有实现粘包组包等情况, 这个就需要我们自己实现了.</p>
</blockquote>
<h3 id="MessageToMessageDecoder"><a href="#MessageToMessageDecoder" class="headerlink" title="MessageToMessageDecoder"></a>MessageToMessageDecoder</h3><p><code>MessageToMessageDecoder</code>一般作为二次解码器, 当我们在<code>ByteToMessageDecoder</code>将一个bytes数组转换成一个java对象的时候, 我们可能还需要将这个对象进行二次解码成其他对象, 我们就可以继承这个类,<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageToMessageDecoder</span>&lt;<span class="title">I</span>&gt; <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span></span></div></pre></td></tr></table></figure></p>
<p>然后实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, I msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception</span>;</div></pre></td></tr></table></figure></p>
<p>这个方法就可以了</p>
<h3 id="LineBasedFrameDecoder"><a href="#LineBasedFrameDecoder" class="headerlink" title="LineBasedFrameDecoder"></a>LineBasedFrameDecoder</h3><p><code>LineBasedFrameDecoder</code>的原理是从<code>ByteBuf</code>的可读字节中找到<code>\n</code>或者<code>\r\n</code>,找到之后就以此为结束,然后将当前读取到的数据组成一行. 如果我们设置每一行的最大长度, 但是当达到最大长度之后还没有找到结束符,就会抛出异常,同时将读取的数据舍弃掉.</p>
<p><code>LineBasedFrameDecoder</code>的用法很简单, 我们可以向其指定大小或者不指定大小<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">ch.pipline().addLast(<span class="keyword">new</span> LineBasedFrameDecoder());</div><div class="line">...</div><div class="line">或者</div><div class="line">...</div><div class="line">ch.pipline().addLast(<span class="keyword">new</span> LineBasedFrameDecoder(<span class="number">1024</span>));</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>它的源码也很简单<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf buffer)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="comment">// 找到 \n 的位置 (如果是\n\r的话, 则向前移动一位,只取\n)</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> eol = findEndOfLine(buffer);</div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="keyword">if</span> (!discarding) &#123;</div><div class="line">        <span class="keyword">if</span> (eol &gt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// 找到了 \n ，开始截取有效数据</span></div><div class="line">            <span class="keyword">final</span> ByteBuf frame;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> length = eol - buffer.readerIndex();</div><div class="line">            <span class="comment">// 如果分隔符是\n的话,分隔符长度是1, 如果分隔符是\n\r的话,则分隔符长度是2</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> delimLength = buffer.getByte(eol) == <span class="string">'\r'</span>? <span class="number">2</span> : <span class="number">1</span>;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (length &gt; maxLength) &#123;</div><div class="line">                <span class="comment">// 超过最大长度, 将读取的数据舍掉</span></div><div class="line">                buffer.readerIndex(eol + delimLength);</div><div class="line">                fail(ctx, length);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (stripDelimiter) &#123;</div><div class="line">                <span class="comment">// 读取数据不带分隔符, 读取有效数据后将分隔符去掉</span></div><div class="line">                frame = buffer.readRetainedSlice(length);</div><div class="line">                buffer.skipBytes(delimLength);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 有效数据中带有分隔符</span></div><div class="line">                frame = buffer.readRetainedSlice(length + delimLength);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> frame;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 没有找到分隔符, 返回null</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> length = buffer.readableBytes();</div><div class="line">            <span class="keyword">if</span> (length &gt; maxLength) &#123;</div><div class="line">                <span class="comment">// 如果数据超过最大长度, 则将多余的数据舍弃</span></div><div class="line">                discardedBytes = length;</div><div class="line">                buffer.readerIndex(buffer.writerIndex());</div><div class="line">                discarding = <span class="keyword">true</span>;</div><div class="line">                <span class="keyword">if</span> (failFast) &#123;</div><div class="line">                    fail(ctx, <span class="string">"over "</span> + discardedBytes);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (eol &gt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> length = discardedBytes + eol - buffer.readerIndex();</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> delimLength = buffer.getByte(eol) == <span class="string">'\r'</span>? <span class="number">2</span> : <span class="number">1</span>;</div><div class="line">            buffer.readerIndex(eol + delimLength);</div><div class="line">            discardedBytes = <span class="number">0</span>;</div><div class="line">            discarding = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (!failFast) &#123;</div><div class="line">                fail(ctx, length);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            discardedBytes += buffer.readableBytes();</div><div class="line">            buffer.readerIndex(buffer.writerIndex());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="DelimiterBasedFrameDecoder"><a href="#DelimiterBasedFrameDecoder" class="headerlink" title="DelimiterBasedFrameDecoder"></a>DelimiterBasedFrameDecoder</h3><p>使用<code>DelimiterBasedFrameDecoder</code>我们可以自定义设定分隔符<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">ByteBuf delimiter = Unpooled.copiedBuffer(<span class="string">"$_"</span>.getBytes());</div><div class="line">ch.pipline().addLast(<span class="keyword">new</span> DelimiterBasedFrameDecoder(<span class="number">1024</span>, delimiter));</div></pre></td></tr></table></figure></p>
<p>在上面的例子中我们使用了自定义的分隔符<code>$_</code>, 同样的如果在1024个字节中找不到<code>$_</code>, 也会抛出.</p>
<h3 id="FixedLengthFrameDecoder"><a href="#FixedLengthFrameDecoder" class="headerlink" title="FixedLengthFrameDecoder"></a>FixedLengthFrameDecoder</h3><p><code>FixedLengthFrameDecoder</code>为定长解码器, 它会按照指定长度对消息进行解码.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ch.pipline().addLast(<span class="keyword">new</span> FixedLengthFrameDecoder(<span class="number">1024</span>));</div></pre></td></tr></table></figure></p>
<p>上面的例子会每隔1024个长度之后进行消息解码,如果不足1024,则会将消息缓存起来,然后再进行解码</p>
<h3 id="ProtobufVarint32FrameDecoder"><a href="#ProtobufVarint32FrameDecoder" class="headerlink" title="ProtobufVarint32FrameDecoder"></a>ProtobufVarint32FrameDecoder</h3><p><code>ProtoBufVarint32FrameDecoder</code>是Netty为我们提供的Protobuf半包解码器, 通过它配合使用<code>ProtobufDecoder</code>和<code>ProtobufEncoder</code>我们就可以使用Protobuf进行通信了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ch.pipline().addLast(<span class="keyword">new</span> ProtobufVarint32FrameDecoder());</div><div class="line">ch.pipline().addLast(<span class="keyword">new</span> ProtobufDecoder());</div><div class="line">ch.pipline().addLast(<span class="keyword">new</span> ProtobufEncoder());</div></pre></td></tr></table></figure></p>
<h3 id="LengthFieldBasedFrameDecoder"><a href="#LengthFieldBasedFrameDecoder" class="headerlink" title="LengthFieldBasedFrameDecoder"></a>LengthFieldBasedFrameDecoder</h3><p><code>LengthFieldBasedFrameDecoder</code>是Netty为我们提供的通用半包解码器.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LengthFieldBasedFrameDecoder</span> <span class="keyword">extends</span> <span class="title">ByteToMessageDecoder</span></span></div></pre></td></tr></table></figure></p>
<p>这个类的半包读取策略由下面的属性控制</p>
<ul>
<li><code>lengthFieldOffset</code> : 标志长度字段的偏移量. 也就是在一个bytes字节流中,表示消息长度的字段是从流中哪个位置开始的.</li>
<li><code>lengthFieldLength</code> : 长度字段的长度(单位byte)</li>
<li><code>lengthAdjustment</code> : 当消息长度包含了消息头的长度的时候,需要使用这个变量进行校正, 例如lengthFieldOffset为0,lengthFieldLength为2, 那么消息正体在解析时就需要校正2个字节, 故这里为-2.</li>
<li><code>initialBytesToStrip</code>: 这个是当我们解析<code>ByteBuf</code>时要跳过的那些字段, (一般为lengthFieldOffset + lengthFieldLength)</li>
</ul>
<h3 id="MessageToByteEncoder"><a href="#MessageToByteEncoder" class="headerlink" title="MessageToByteEncoder"></a>MessageToByteEncoder</h3><p>该类负责将java对象编码成<code>ByteBuf</code>, 我们只需要继承该类然后实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, I msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception</span>;</div></pre></td></tr></table></figure></p>
<p>方法就可以了</p>
<h3 id="MessageToMessageEncoder"><a href="#MessageToMessageEncoder" class="headerlink" title="MessageToMessageEncoder"></a>MessageToMessageEncoder</h3><p>如果要将java对象不编码成<code>ByteBuf</code>, 而是编译成, 其他对象, 那我们可以继承这个类实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, I msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception</span>;</div></pre></td></tr></table></figure></p>
<p>这个方法就可以了</p>
<blockquote>
<p>这个类与<code>MessageToByteEncoder</code>的不同是, 将java对象放到一个<code>List&lt;Object&gt; out</code>, 而不是编码成<code>ByteBuf</code>发送</p>
</blockquote>
<h3 id="LengthFieldPrepender"><a href="#LengthFieldPrepender" class="headerlink" title="LengthFieldPrepender"></a>LengthFieldPrepender</h3><p><code>LengthFieldPrepender</code>是一个非常实用的工具类, 如果我们在发送消息的时候采用的是:消息长度字段+原始消息的形式, 那么我们就可以使用<code>LengthFieldPrepender</code>了. 这是因为<code>LengthFieldPrepender</code>可以将待发送消息的长度(二进制字节长度)写到<code>ByteBuf</code>的前俩个字节.例如:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Hello,World</div></pre></td></tr></table></figure></p>
<p>编码前是12个字节,但是经过<code>LengthFieldPrepender</code>编码后变成了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0x000E</span> Hello,World</div></pre></td></tr></table></figure></p>
<p>成为了14个字节</p>
<h3 id="HTTP解码器"><a href="#HTTP解码器" class="headerlink" title="HTTP解码器"></a>HTTP解码器</h3><blockquote>
<p>使用<code>HttpObjectAggregator</code>是因为在解码Http消息中会产生多个对象(<code>HttpRequest</code>, <code>HttpResponse</code>, <code>HttpContent</code>, <code>LastHttpContent</code>), 使用<code>HttpObjectAggregator</code>我们可以将这些对象都组合到一起去. 然后当我们自己在处理消息时就可以直接使用<code>FullHttpRequest了</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ch.pipline().addLast(<span class="string">"http-decoder"</span>, <span class="keyword">new</span> HttpRequestDecoder());</div><div class="line">ch.pipline().addLast(<span class="string">"http-aggregator"</span>, <span class="keyword">new</span> HttpObjectAggregator());</div><div class="line">ch.pipline().addLast(<span class="string">"http-encoder"</span>, <span class="keyword">new</span> HttpResponseEncoder());</div><div class="line">ch.pipline().addLast(<span class="string">"http-chunked"</span>, <span class="keyword">new</span> ChunkedWriteHandler());</div></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Netty/">Netty</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/02/02/JavaLibrary/Netty ChannelPipeline/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/02/02/JavaLibrary/Netty ChannelPipeline/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/30/JavaLibrary/Typesafe Config 初探/" title="Typesafe Config 初探" itemprop="url">Typesafe Config 初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-29T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-01-30</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>Typesafe Config 是为JVM平台语言提供的配置类库.</p>
<p>目前config只支持配置文件，如果想从数据库获取配置文件，需要自己diy。 config库很擅长合并配置。</p>
<p>我们可以直接使用maven方式依赖该库<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.typesafe<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>API示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.typesafe.config.ConfigFactory</div><div class="line"></div><div class="line">Config conf = ConfigFactory.load();</div><div class="line"><span class="keyword">int</span> bar1 = conf.getInt(<span class="string">"foo.bar"</span>);</div><div class="line">Config foo = conf.getConfig(<span class="string">"foo"</span>);</div><div class="line"><span class="keyword">int</span> bar2 = foo.getInt(<span class="string">"bar"</span>);</div></pre></td></tr></table></figure></p>
<p>在上面的例子中我们使用了最简单的方式<code>ConfigFactory.load()</code>加载出了一个配置类<code>Config</code>, config会自动去classPath中查找<code>reference.conf</code>. <code>ConfigFactory.load()</code>会按照下面的优先级依次从classpath中查找文件进行加载</p>
<ol>
<li><code>system properties</code></li>
<li><code>application.conf</code> (all resources on classpath with this name)</li>
<li><code>application.json</code> (all resources on classpath with this name)</li>
<li><code>application.properties</code> (all resources on classpath with this name)</li>
<li><code>reference.conf</code> (all resources on classpath with this name)<br>如果我们不想要使用上面的文件名或者我们将配置分配到多个文件中,那么我们可以使用<code>ConfigFactory.load(&quot;test.conf&quot;);</code></li>
</ol>
<p>当然如果你想自己创建<code>Config</code>也可以调用<code>ConfigFactory</code>的<code>parseXXX</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ConfigFactory.parseFile(<span class="keyword">new</span> File(<span class="string">""</span>));</div><div class="line">ConfigFactory.parseMap(<span class="keyword">new</span> HashMap&lt;&gt;());</div><div class="line">ConfigFactory.parseProperties(<span class="keyword">new</span> Properties());</div></pre></td></tr></table></figure></p>
<blockquote>
<p>需要注意的从<code>Config</code>实例中得到的<code>Config</code>, <code>ConfigParseOptions</code>, <code>ConfigResolveOptions</code>, <code>ConfigObject</code> 得到的对象都是不可变的.</p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/30/JavaLibrary/Typesafe Config 初探/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/30/JavaLibrary/Typesafe Config 初探/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/29/jvm/Classloader 示例/" title="使用Classloader加载类" itemprop="url">使用Classloader加载类</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-29T08:00:00.000Z" itemprop="datePublished"> 发表于 2016-01-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>类加载器不单单是用于实现类的加载动作, 对于任意一个类,都需要由加载它的类加载器和类本身一同确立其在java虚拟机中的唯一性.换句话说:比较俩个类是否相等,只有在这俩个类是由同一个类加载器加载的前提下才有意义. 否则即使来自同一个源文件,只要加载它们的类加载器不同,这俩个类就必定不相等.</p>
<blockquote>
<p>判断俩个类相等可以通过下面方法: <code>Class</code>对象的<code>equals()</code>方法, <code>isAssignbleFrom()</code>方法, <code>isInstance()</code>方法的返回结果, 也包括使用<code>instanceof</code>关键字做对象所属关系判断等. 不同的类加载器对<code>instanceof</code>关键字运算结果的影响</p>
</blockquote>
<h2 id="双亲委派模型"><a href="#双亲委派模型" class="headerlink" title="双亲委派模型"></a>双亲委派模型</h2><p><img src="https://raw.githubusercontent.com/ming15/blog-website/images/jvm/ClassLoader%E7%9A%84%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84.png" alt="ClassLoader的体系架构"><br>从JVM来角度讲, 只存在俩种不同的类加载器:</p>
<ul>
<li>启动类加载器: 使用C++语言实践,是虚拟机自身的一部分. </li>
<li>其他类加载器: 这些类加载器都由java语言实现,独立于虚拟机外部,并且全部都继承自抽象类:<code>java.lang.ClassLoader</code></li>
</ul>
<p>系统提供的类加载器</p>
<ul>
<li>启动类加载器 : 这个类加载器负责将<code>&lt;JAVA_HOME&gt;\lib</code>目录中的,或者<code>-Xbootclasspath</code>参数所指定的路径中的,并且是虚拟机识别的(仅按照文件名识别,如rt,jar,名字不符合的类库即使放在lib目录里也不会被加载)类库加载到虚拟机内存中,启动类加载器无法被java程序直接使用.</li>
<li>扩展类加载器 : 这个类加载器由<code>sun.misc.Launcher$ExtClassLoader</code>实现,负责加载<code>&lt;JAVA_HOME&gt;\lib\ext</code>目录中的,或者被<code>java.ext.dirs</code>系统变量所指定的路径中的所有类库, 开发者可以直接使用扩展类加载器.</li>
<li>应用程序加载器 : 这个类加载器由<code>sun.misc.Launcher$AppClassLoader</code>来实现. 由于类加载器是<code>ClassLoader</code>中<code>getSystemClassLoader()</code>方法的返回值,所以一般也称它为系统类加载器. 它负责加载用户类路径(ClassPath)上所指定的类库,开发者可以直接使用这个类加载器,如果应用程序中没有自定义过自己的类加载器,一般情况下就是程序中默认的类加载器.</li>
</ul>
<p>类加载器收到类加载请求,它不会自己去尝试加载这个类,而把这个请求委派给父类加载器去完成,每一个层次的类加载都是如此,因此所有的类加请求最终都应该传送到顶层的启动类加载器中,只有当父加载器反馈自己无法完成这个加载请求(它的搜索范围中没有找到所需的类)时,子类加载器才会尝试自己去加载.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</div><div class="line">       <span class="keyword">throws</span> ClassNotFoundException</div><div class="line">   &#123;</div><div class="line">       <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</div><div class="line">           <span class="comment">// 第一步检查被加载的类是否已经被加载进入了虚拟机</span></div><div class="line">           Class&lt;?&gt; c = findLoadedClass(name);</div><div class="line">           <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// 如果没有被加载进虚拟机中则进行加载</span></div><div class="line">               <span class="keyword">long</span> t0 = System.nanoTime();</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">				<span class="comment">// 优先从父类加载器中进行加载, 所有的类加请求最终都应该传送到顶层的启动类加载器中</span></div><div class="line">                   <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</div><div class="line">                       c = parent.loadClass(name, <span class="keyword">false</span>);</div><div class="line">                   &#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// </span></div><div class="line">                       c = findBootstrapClassOrNull(name);</div><div class="line">                   &#125;</div><div class="line">               &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">                   <span class="comment">// ClassNotFoundException thrown if class not found</span></div><div class="line">                   <span class="comment">// from the non-null parent class loader</span></div><div class="line">               &#125;</div><div class="line">			</div><div class="line">               <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</div><div class="line">                   <span class="comment">// 父类加载器找不到则调用自己的findClass(name)找到类然后进行加载</span></div><div class="line">                   <span class="keyword">long</span> t1 = System.nanoTime();</div><div class="line">                   c = findClass(name);</div><div class="line"></div><div class="line">                   <span class="comment">// this is the defining class loader; record the stats</span></div><div class="line">                   sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</div><div class="line">                   sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</div><div class="line">                   sun.misc.PerfCounter.getFindClasses().increment();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (resolve) &#123;</div><div class="line">               resolveClass(c);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> c;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>使用双亲委派模型来组织类加载之间的关系, 可以确保我们自己JVM的安全. 因为当我们自己写一个 <code>java.lang.Object</code>, 这个类虽然能够被正常编译, 但是它永远不会被加载器虚拟机中, 因为这个类会在启动类加载器中完成了加载.</p>
</blockquote>
<p>在刚才的<code>loadClass()</code>方法中我们看到最终我们自己实现类加载的逻辑是在<code>findClass()</code>中进行的, 这是为了向前兼容,JDK1.2之后添加的方法.JDK1.2之后已不提倡用户再去覆盖<code>loadClass()</code>方法,而在<code>loadClass()</code>方法的逻辑里如果父类加载失败,则会调用自己的<code>findClass()</code>方法来完成加载,这样就可以保证新写出来的类加载器是符合双亲委派规则的.</p>
<blockquote>
<p>为了解决各个类加载器的基础类调用用户代码, java设计团队引入了这样一个设计:线程上下文类加载器,这个类加载器可以通过<code>java.lang.Thread</code>类的<code>setContextClassLoaser()</code>方法进行设置,如果创建线程时还未设置,它将会从父线程中继承一个:如果在应用程序的全局范围内都没有设置过,那么这个类加载器默认就是应用程序类加载器.有了线程上下文类加载器,JNDI服务使用这个线程上下文类加载器去加载所需要的SPI代码,也就是父类加载器请求子类加载器去完成类加载的动作,这种行为实际就是打通了双亲委派模型的层次结构来逆向使用类加载器,已经违背了双亲委派模型的一般性原则.</p>
</blockquote>
<p>上面所说只完成了类加载的动作, 但是如果我们想要实现热更代码的这种功能的话,就不能单纯依赖重写<code>findClass(name)</code>了，而是要重写<code>loadClass(String name)</code>了，这是因为在<code>ClassLoader</code>中的<code>loadClass(String name)</code>方法当发现已经加载过的类就不会再重新加载了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Field;</div><div class="line"><span class="keyword">import</span> java.net.URL;</div><div class="line"><span class="keyword">import</span> java.net.URLClassLoader;</div><div class="line"><span class="keyword">import</span> java.util.Random;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.*;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClassLoader</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">		URL url = <span class="keyword">new</span> File(<span class="string">"."</span>).toURL();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; <span class="number">5</span>; i++) &#123;</div><div class="line">			MyClassLoader myLoader = <span class="keyword">new</span> MyClassLoader(<span class="keyword">new</span> URL[]&#123;url&#125;);</div><div class="line">			Class&lt;?&gt; obj = myLoader.loadClass(<span class="string">"Mesurable"</span>);</div><div class="line">			<span class="keyword">for</span> (Field field : obj.getFields()) &#123;</div><div class="line">				System.out.println(field.getName());</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MyClassLoader</span><span class="params">(URL[] urls)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(urls);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">		Class&lt;?&gt; loadClass = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">if</span> (name.contains(<span class="string">"java.lang.Object"</span>)) &#123;</div><div class="line">			<span class="comment">// 因为我们的父类是java.lang.Object, 因此我们要调用父类加载器进行加载</span></div><div class="line">			loadClass = <span class="keyword">super</span>.loadClass(name);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			loadClass = findLoadedClass(name);</div><div class="line">			<span class="keyword">if</span> (loadClass != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">return</span> loadClass;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">byte</span>[] bytes = generateClass();</div><div class="line">			loadClass = defineClass(name, bytes, <span class="number">0</span>, bytes.length);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> loadClass;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">byte</span>[] generateClass() &#123;</div><div class="line">		ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</div><div class="line">		cw.visit(V1_8,											<span class="comment">// 指定class文件版本号, 我们将其设置为java8</span></div><div class="line">				ACC_PUBLIC,	<span class="comment">// 设置接口的修饰符</span></div><div class="line">				<span class="string">"Mesurable"</span>,								<span class="comment">// 我们设置classname, 需要在这里指定全限定名</span></div><div class="line">				<span class="keyword">null</span>,											<span class="comment">// 设置泛型信息, 因为我们的接口是非泛化的, 因此我们将其设置为null</span></div><div class="line">				<span class="string">"java/lang/Object"</span>,							<span class="comment">// 设置父类, 同时需要设定全限定名</span></div><div class="line">				<span class="keyword">null</span>);			<span class="comment">// 设置接口, 同样需要设置全限定名</span></div><div class="line"></div><div class="line">		cw.visitField(</div><div class="line">				ACC_PUBLIC,	<span class="comment">// 设置字段的修饰符</span></div><div class="line">				<span class="string">"LESS__"</span> + random.nextInt(<span class="number">100</span>),										<span class="comment">// 设置字段名</span></div><div class="line">				<span class="string">"I"</span>,										<span class="comment">// 设置字段类型</span></div><div class="line">				<span class="keyword">null</span>,										<span class="comment">// 设置泛型信息</span></div><div class="line">				<span class="keyword">new</span> Long(-<span class="number">1</span>))							<span class="comment">// 设置字面量值.</span></div><div class="line">				.visitEnd();</div><div class="line"></div><div class="line">		cw.visitEnd();</div><div class="line">		<span class="keyword">return</span> cw.toByteArray();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Random random = <span class="keyword">new</span> Random();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p><code>URLClassLoader</code>根据<code>URL</code>指定的路径从<code>JAR</code>文件或者目录里加载<code>class</code>文件或者其他资源文件. 如果<code>URL</code>以<code>/</code>结束,就表示到某个目录里进行加载. 否则就表示到某个<code>JAR</code>文件里进行加载. 线程里用于创建<code>URLClassLoader</code>实例的<code>AccessControlContext</code>会在加载类文件以及资源文件时使用到. <code>URLClassLoader</code>实例创建好之后会根据默认的授权权限依据指定的<code>URL</code>来进行加载类.</p>
</blockquote>
<p>从文件中加载class<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.*;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"><span class="keyword">import</span> java.net.URL;</div><div class="line"><span class="keyword">import</span> java.net.URLClassLoader;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; <span class="number">5</span>; i++) &#123;</div><div class="line">			MyClassLoader myLoader = <span class="keyword">new</span> MyClassLoader(<span class="keyword">new</span> URL[]&#123;&#125;);</div><div class="line">			Class&lt;?&gt; obj = myLoader.loadClass(<span class="string">"D:\\ming\\test\\target\\classes\\Test.class"</span>);</div><div class="line">			<span class="keyword">for</span> (Method method : obj.getMethods()) &#123;</div><div class="line">				<span class="keyword">if</span> (method.getName().equals(<span class="string">"printTime"</span>)) &#123;</div><div class="line">					method.invoke(<span class="keyword">null</span>);</div><div class="line">					TimeUnit.SECONDS.sleep(<span class="number">10</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printTime</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="number">123</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MyClassLoader</span><span class="params">(URL[] urls)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(urls);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">		Class&lt;?&gt; loadClass = findLoadedClass(name);</div><div class="line">		<span class="keyword">if</span> (loadClass != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span> loadClass;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">byte</span>[] bytes = loadClassFromFile(name);</div><div class="line">			<span class="keyword">int</span> idx = name.lastIndexOf(<span class="string">"\\"</span>);</div><div class="line">			name = name.substring(idx + <span class="number">1</span>);</div><div class="line">			name = name.split(<span class="string">"\\.class"</span>)[<span class="number">0</span>];</div><div class="line">			loadClass = defineClass(name, bytes, <span class="number">0</span>, bytes.length);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			loadClass = <span class="keyword">super</span>.loadClass(name);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> loadClass;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">byte</span>[] loadClassFromFile(String fileName) <span class="keyword">throws</span> Exception &#123;</div><div class="line">		InputStream input = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(fileName));</div><div class="line">		<span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[input.available()];</div><div class="line">		input.read(bytes);</div><div class="line">		<span class="keyword">return</span> bytes;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>同一个类加载器不同加载同一个类俩次, 例如我们利用上面的<code>MyClassLoader</code>进行加载<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		MyClassLoader myLoader1 = <span class="keyword">new</span> MyClassLoader(<span class="keyword">new</span> URL[]&#123;&#125;);</div><div class="line">		Class&lt;?&gt; obj1 = myLoader1.loadClass(<span class="string">"D:\\ming\\test\\target\\classes\\Test.class"</span>);</div><div class="line">		MyClassLoader myLoader2 = <span class="keyword">new</span> MyClassLoader(<span class="keyword">new</span> URL[]&#123;&#125;);</div><div class="line">		Class&lt;?&gt; obj2 = myLoader2.loadClass(<span class="string">"D:\\ming\\test\\target\\classes\\Test.class"</span>);</div><div class="line">		System.out.println(obj1.equals(obj2));</div><div class="line">		Class&lt;?&gt; obj3 = myLoader2.loadClass(<span class="string">"D:\\ming\\test\\target\\classes\\Test.class"</span>);</div><div class="line">		System.out.println(obj2.equals(obj3));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>会产生异常<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">false</div><div class="line">Exception in thread "main" java.lang.LinkageError: loader (instance of  MyClassLoader): attempted  duplicate class definition for name: "Test"</div><div class="line">	at java.lang.ClassLoader.defineClass1(Native Method)</div><div class="line">	at java.lang.ClassLoader.defineClass(ClassLoader.java:763)</div><div class="line">	at java.lang.ClassLoader.defineClass(ClassLoader.java:642)</div><div class="line">	at MyClassLoader.loadClass(Test.java:37)</div><div class="line">	at Test.main(Test.java:15)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</div><div class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</div><div class="line">	at java.lang.reflect.Method.invoke(Method.java:498)</div><div class="line">	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:144)</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/29/jvm/Classloader 示例/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/29/jvm/Classloader 示例/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/20/JavaLibrary/Retrofit/" title="Retrofit 初探" itemprop="url">Retrofit 初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-19T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-01-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>首先添加Maven依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.retrofit2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>retrofit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意我们使用的是retrofit2</p>
</blockquote>
<h2 id="Get请求"><a href="#Get请求" class="headerlink" title="Get请求"></a>Get请求</h2><p>Retrofit 将HTTP API转换为了接口形式, 如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitHubService</span> </span>&#123;</div><div class="line">  <span class="meta">@GET</span>(<span class="string">"users/&#123;user&#125;/repos"</span>)</div><div class="line">  Call&lt;List&lt;Repo&gt;&gt; listRepos(<span class="meta">@Path</span>(<span class="string">"user"</span>) String user);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后<code>Retrofit</code>会自动完成其实现类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">    .baseUrl(<span class="string">"https://api.github.com"</span>)</div><div class="line">    .build();</div><div class="line"></div><div class="line">GitHubService service = retrofit.create(GitHubService.class);</div></pre></td></tr></table></figure></p>
<p>在上面的示例中我们完成了一个<code>Get</code>请求, 然后使用<code>@Path</code>进行参数替换</p>
<h2 id="Post请求"><a href="#Post请求" class="headerlink" title="Post请求"></a>Post请求</h2><p>上面我们展示的是一个<code>Get</code>请求, 下面我们再看一个<code>Post</code>请求的示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@POST</span>(<span class="string">"users/new"</span>)</div><div class="line"><span class="function">Call&lt;User&gt; <span class="title">createUser</span><span class="params">(@Body User user)</span></span>;</div></pre></td></tr></table></figure></p>
<p><code>@Body</code>注解会将<code>User</code>对象转换为请求体</p>
<h2 id="form-encoded"><a href="#form-encoded" class="headerlink" title="form-encoded"></a>form-encoded</h2><p>我们我们想要将格式转换为<code>form-encoded</code>形式, 参考如下示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@FormUrlEncoded</span></div><div class="line"><span class="meta">@POST</span>(<span class="string">"user/edit"</span>)</div><div class="line"><span class="function">Call&lt;User&gt; <span class="title">updateUser</span><span class="params">(@Field(<span class="string">"first_name"</span>)</span> String first, @<span class="title">Field</span><span class="params">(<span class="string">"last_name"</span>)</span> String last)</span>;</div></pre></td></tr></table></figure></p>
<p><code>@Field</code>注解会组成一个个字典结构的数据进行发送.</p>
<h2 id="HEADER"><a href="#HEADER" class="headerlink" title="HEADER"></a>HEADER</h2><p>有时候我们也许想要设置其他的消息头, 我们可以如此做<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Headers</span>(<span class="string">"Cache-Control: max-age=640000"</span>)</div><div class="line"><span class="meta">@GET</span>(<span class="string">"widget/list"</span>)</div><div class="line">Call&lt;List&lt;Widget&gt;&gt; widgetList();</div></pre></td></tr></table></figure></p>
<h2 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h2><p>我们在<code>Call</code>对象中分别可以调用异步和同步方法进行通信<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">		.baseUrl(<span class="string">"https://api.github.com"</span>)</div><div class="line">		.build();</div><div class="line"></div><div class="line">GitHubService service = retrofit.create(GitHubService.class);</div><div class="line"></div><div class="line">Call&lt;List&lt;String&gt;&gt; repos = service.listRepos(<span class="string">"octocat"</span>);</div><div class="line">	<span class="comment">// 同步调用</span></div><div class="line">	Response&lt;List&lt;String&gt;&gt; result = repos.execute();</div><div class="line"></div><div class="line">	<span class="comment">// 异步调用</span></div><div class="line">	repos.enqueue(<span class="keyword">new</span> Callback() &#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Response response)</span> </span>&#123;</div><div class="line"></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line"></div><div class="line">		&#125;</div><div class="line">	&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>在我的windows的机器上进行测试, 只是测试一下Retrofit的性能消耗<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIte1Minite</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">	<span class="keyword">long</span> start = System.currentTimeMillis();</div><div class="line">	<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">		<span class="keyword">long</span> end = System.currentTimeMillis();</div><div class="line">		<span class="keyword">if</span> ((end - start) &gt; <span class="number">1000</span> * <span class="number">60</span>) &#123;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">				.baseUrl(<span class="string">"http://192.168.15.20:9091"</span>)</div><div class="line">				.addConverterFactory(GsonConverterFactory.create())</div><div class="line">				.build();</div><div class="line">		ServerListService loginServerPushService = retrofit.create(ServerListService.class);</div><div class="line">		loginServerPushService.serverlist().execute().body();</div><div class="line">		count++;</div><div class="line">	&#125;</div><div class="line">	System.out.println(count);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServerListService</span> </span>&#123;</div><div class="line">	<span class="meta">@GET</span>(<span class="string">"server/serverlist"</span>)</div><div class="line">	<span class="function">Call&lt;MyServer&gt; <span class="title">serverlist</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServer</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> List&lt;Map&lt;String, String&gt;&gt; serverlist;</div><div class="line">	<span class="keyword">public</span> List&lt;Map&lt;String, String&gt;&gt; serverlogin;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果如图<br><img src="" alt=""><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIte1Minite</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">	<span class="keyword">long</span> start = System.currentTimeMillis();</div><div class="line">	Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">			.baseUrl(<span class="string">"http://192.168.15.20:9091"</span>)</div><div class="line">			.addConverterFactory(GsonConverterFactory.create())</div><div class="line">			.build();</div><div class="line">	<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">		<span class="keyword">long</span> end = System.currentTimeMillis();</div><div class="line">		<span class="keyword">if</span> ((end - start) &gt; <span class="number">1000</span> * <span class="number">60</span>) &#123;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		ServerListService loginServerPushService = retrofit.create(ServerListService.class);</div><div class="line">		loginServerPushService.serverlist().execute().body();</div><div class="line">		count++;</div><div class="line">	&#125;</div><div class="line">	System.out.println(count);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果如图<br><img src="" alt=""><br>这俩次的结果都能达到每分钟13000个请求, 吞吐量和性能消耗是差不多.</p>
<h2 id="Converter"><a href="#Converter" class="headerlink" title="Converter"></a>Converter</h2><p>Retrofit2为我们提供了多种转换器</p>
<ul>
<li>Gson: com.squareup.retrofit2:converter-gson</li>
<li>Jackson: com.squareup.retrofit2:converter-jackson</li>
<li>Moshi: com.squareup.retrofit2:converter-moshi</li>
<li>Protobuf: com.squareup.retrofit2:converter-protobuf</li>
<li>Wire: com.squareup.retrofit2:converter-wire</li>
<li>Simple XML: com.squareup.retrofit2:converter-simplexml</li>
<li>Scalars (primitives, boxed, and String): com.squareup.retrofit2:converter-scalars<br>在使用Retrofit2的时候, 必须指定Converter, 否则程序在运行中会报错. Scalars 只是支持String和基本类型的装包和拆包</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/20/JavaLibrary/Retrofit/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/20/JavaLibrary/Retrofit/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/19/JavaLibrary/OWNER 初探/" title="OWNER 初探" itemprop="url">OWNER 初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-18T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-01-19</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>OWNER是一个Java库，目标是最大限度的减少应用程序中处理Java properties的代码。</p>
<p>主要功能</p>
<ul>
<li>加载策略：OWNER通过匹配接口类名和properties文件名自动解析并映射；也可以通过注解定制properties文件名。</li>
<li>导入properties：另外一种加载properties文件到映射接口的方法。</li>
<li>参数化properties：另外一个实用功能，给接口方法提供参数，通过参数配置。</li>
<li>类型转换：支持从String类型到基本类型和枚举类型的转换。</li>
<li>变量扩展：引用properties中的其他属性。</li>
<li>热加载：支持热加载。</li>
<li>可访问和可变：可以继承Config的子接口Accessible或者Mutable实现属性的可访问和可变。</li>
<li>调试：支持调试功能。</li>
<li>禁用功能：可禁用引起问题的功能。</li>
<li>配置ConfigFactory：ConfigFactory也是可配置的。</li>
<li>XML支持：支持XML配置。</li>
<li>事件支持：OWNER实现了功能丰富的事件系统，使你知道热加载的发生和属性变化。</li>
<li>单例模式：配置信息在一个应用中是单例的。</li>
</ul>
<p>OWNER同样是开源的, 我们可以使用maven来引用它<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aeonbits.owner<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>owner<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>或者使用java8版本<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aeonbits.owner<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>owner-java8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><p>我们现在在MAVEN项目中测试一下<br>首先我们在<code>test\src\main\java\ownerTest</code>目录下创建一个配置类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> ownerTest;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.aeonbits.owner.Config;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServerConfig</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">port</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">String <span class="title">hostname</span><span class="params">()</span></span>;</div><div class="line">	<span class="meta">@DefaultValue</span>(<span class="string">"42"</span>)</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">maxThreads</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后在<code>test\src\main\resources\ownerTest</code>目录下创建配置文件<code>ServerConfig.properties</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">port=<span class="number">80</span></div><div class="line">hostname=foobar.com</div><div class="line">maxThreads=<span class="number">100</span></div></pre></td></tr></table></figure></p>
<p>然后我们书写一个测试类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> ownerTest;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.aeonbits.owner.ConfigFactory;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		ServerConfig cfg = ConfigFactory.create(ServerConfig.class);</div><div class="line">		System.out.println(<span class="string">"Server "</span> + cfg.hostname() + <span class="string">":"</span> + cfg.port() + <span class="string">" will run "</span> + cfg.maxThreads());</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这时OWNER会自动地将<code>ServerConfig.properties</code>配置文件匹配到<code>ServerConfig</code>上, 输出结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Server foobar.com:<span class="number">80</span> will run <span class="number">100</span></div></pre></td></tr></table></figure></p>
<p>我们看到在<code>ServerConfig</code>里我们使用了一个<code>@DefaultValue</code>注解, 当在配置文件里找不到这个值的时候, 这个注解值会为我们设置上注解里的默认值.</p>
<blockquote>
<p>如果在配置文件里找不到这个设置也没有添加<code>@DefaultValue</code>会产生一个空指针异常</p>
</blockquote>
<p>有时候我们在配置文件里会使用<code>server.http.port=80</code>的配置, 那么这种情况下我们就在使用<code>@Key</code>注解<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> ownerTest;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.aeonbits.owner.Config;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServerConfig</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line">	<span class="meta">@Key</span>(<span class="string">"server.http.port"</span>)</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">port</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">	<span class="meta">@Key</span>(<span class="string">"server.host.name"</span>)</div><div class="line">	<span class="function">String <span class="title">hostname</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">	<span class="meta">@Key</span>(<span class="string">"server.max.threads"</span>)</div><div class="line">	<span class="meta">@DefaultValue</span>(<span class="string">"42"</span>)</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">maxThreads</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们的配置文件如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">server.http.port=<span class="number">80</span></div><div class="line">server.host.name=foobar.com</div><div class="line">server.max.threads=<span class="number">100</span></div></pre></td></tr></table></figure></p>
<h2 id="加载策略"><a href="#加载策略" class="headerlink" title="加载策略"></a>加载策略</h2><p>正如上文所说, OWNER是按照classpath去自动匹配配置类和配置文件的, 但是其实我们可以自定义配置文件的加载策略, 如下例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Sources</span>(&#123; <span class="string">"file:~/.myapp.config"</span>,</div><div class="line">           <span class="string">"file:/etc/myapp.config"</span>,</div><div class="line">           <span class="string">"classpath:foo/bar/baz.properties"</span> &#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServerConfig</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line">    <span class="meta">@Key</span>(<span class="string">"server.http.port"</span>)</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">port</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Key</span>(<span class="string">"server.host.name"</span>)</div><div class="line">    <span class="function">String <span class="title">hostname</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Key</span>(<span class="string">"server.max.threads"</span>);</div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"42"</span>)</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">maxThreads</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们使用了<code>@Sources</code>指定配置文件的路径, 按照上面的代码, 它依次按照下面的流程进行文件匹配,一旦匹配成功就进行加载忽略后面的文件</p>
<ol>
<li><code>file:~/.myapp.config</code>  从home目录开始查找</li>
<li><code>file:/etc/myapp.config</code>  从绝对目录进行查找</li>
<li><code>classpath:foo/bar/baz.properties</code>  classpath从classpath中查找</li>
</ol>
<p>其实上面的加载策略称为<code>LoadType.FIRST</code>(完整注解<code>@LoadPolicy(LoadType.FIRST)</code>). 我们还有其他选择<code>LoadType.MERGE</code>, 示例如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@LoadPolicy</span>(LoadType.MERGE)</div><div class="line"><span class="meta">@Sources</span>(&#123; <span class="string">"file:~/.myapp.config"</span>,</div><div class="line">           <span class="string">"file:/etc/myapp.config"</span>,</div><div class="line">           <span class="string">"classpath:foo/bar/baz.properties"</span> &#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServerConfig</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的加载策略是, 不管当前路径下是否找到了都会进行路径下查找, 但与<code>LoadType.FIRST</code>不同的是, 当找到之后它会替换之前知道的配置文件.</p>
<blockquote>
<p>TODO 是局部替换还是整个文件一起替换呢？</p>
</blockquote>
<h2 id="参数化"><a href="#参数化" class="headerlink" title="参数化"></a>参数化</h2><p>我们还可以向配置里传递参数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Sample</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"Hello Mr. %s!"</span>)</div><div class="line">    <span class="function">String <span class="title">helloMr</span><span class="params">(String name)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Sample cfg = ConfigFactory.create(Sample.class);</div><div class="line">print(cfg.helloMr(<span class="string">"Luigi"</span>)); <span class="comment">// will println 'Hello Mr. Luigi!'</span></div></pre></td></tr></table></figure></p>
<blockquote>
<p>OWNER还为我们提供了<code>@DisableFeature</code>注解, 让我们关闭参数化功能. 这个注解可以用在类或者方法的级别上</p>
</blockquote>
<h2 id="自定义类型"><a href="#自定义类型" class="headerlink" title="自定义类型"></a>自定义类型</h2><p>当我们使用OWNER的时候, 不仅仅可以使用原生类型, 还可以使用数组, 集合甚至是自定义类型</p>
<p>下来我们自定义一个类型<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<p>下面我们定义一个数组和集合<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfig</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@DefaultValue</span>(<span class="string">"apple, pear, orange"</span>)</div><div class="line">  <span class="keyword">public</span> String[] fruit();</div><div class="line"></div><div class="line">  <span class="meta">@Separator</span>(<span class="string">";"</span>)</div><div class="line">  <span class="meta">@DefaultValue</span>(<span class="string">"0; 1; 1; 2; 3; 5; 8; 13; 21; 34; 55"</span>)</div><div class="line">  <span class="keyword">public</span> <span class="keyword">int</span>[] fibonacci();</div><div class="line"></div><div class="line">  <span class="meta">@DefaultValue</span>(<span class="string">"1, 2, 3, 4"</span>)</div><div class="line">  <span class="function">List&lt;Integer&gt; <span class="title">ints</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="meta">@DefaultValue</span>(</div><div class="line">    <span class="string">"http://aeonbits.org, http://github.com, http://google.com"</span>)</div><div class="line">  <span class="function">MyOwnCollection&lt;URL&gt; <span class="title">myBookmarks</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">// Concrete class are allowed (in this case java.util.Stack)</span></div><div class="line">  <span class="comment">// when type is not specified &lt;String&gt; is assumed as default</span></div><div class="line">  <span class="meta">@DefaultValue</span>(</div><div class="line">    <span class="string">"The Lord of the Rings,The Little Prince,The Da Vinci Code"</span>)</div><div class="line">  <span class="function">Stack <span class="title">books</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>OWNER默认使用<code>,</code>分割元素. 但是我们可以通过<code>@Separator(&quot;;&quot;)</code>指定使用<code>;</code>进行切割, 需要注意的是OWNER只支持数组, 集合, Java原生类型, 并不支持<code>Map</code>.</p>
<blockquote>
<p>支持的集合有<code>Collection, List, Set, SortedSet</code></p>
</blockquote>
<p>虽然我们可以使用<code>@Separator(&quot;;&quot;)</code>进行切割, 但是如果我们有更复杂的切割逻辑的话, 这可能就不再符合需求了, 我们可以使用<code>@TokenizerClass</code>来实现更复杂的切割逻辑<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfig</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Separator</span>(<span class="string">";"</span>)</div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"0; 1; 1; 2; 3; 5; 8; 13; 21; 34; 55"</span>)</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] fibonacci();</div><div class="line"></div><div class="line">    <span class="meta">@TokenizerClass</span>(CustomDashTokenizer.class)</div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"foo-bar-baz"</span>)</div><div class="line">    <span class="keyword">public</span> String[] withSeparatorClass();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomDashTokenizer</span> <span class="keyword">implements</span> <span class="title">Tokenizer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// this logic can be as much complex as you need</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> String[] tokens(String values) &#123;</div><div class="line">        <span class="keyword">return</span> values.split(<span class="string">"-"</span>, -<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>虽然 <code>@Separator(&quot;;&quot;)</code> 和  <code>@TokenizerClass(CustomDashTokenizer.class)</code>都可以在方法和类的级别上进行注解, 但是他们不允许同时出现在同一个级别上, 而且当分别出现在了方法和类的级别上后, 方法上的注解会替换类上的注解.</p>
</blockquote>
<p>OWNER还提供了<code>@ConverterClass</code>注解来实现更加复杂的转换逻辑<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MyConfig</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"foobar.com:8080"</span>)</div><div class="line">    <span class="meta">@ConverterClass</span>(ServerConverter.class)</div><div class="line">    <span class="function">Server <span class="title">server</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@DefaultValue</span>(</div><div class="line">      <span class="string">"google.com, yahoo.com:8080, owner.aeonbits.org:4000"</span>)</div><div class="line">    <span class="meta">@ConverterClass</span>(ServerConverter.class)</div><div class="line">    Server[] servers();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer port;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">(String name, Integer port)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.port = port;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConverter</span> <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">Server</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> Server <span class="title">convert</span><span class="params">(Method targetMethod, String text)</span> </span>&#123;</div><div class="line">        String[] split = text.split(<span class="string">":"</span>, -<span class="number">1</span>);</div><div class="line">        String name = split[<span class="number">0</span>];</div><div class="line">        Integer port = <span class="number">80</span>;</div><div class="line">        <span class="keyword">if</span> (split.length &gt;= <span class="number">2</span>)</div><div class="line">            port = Integer.valueOf(split[<span class="number">1</span>]);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Server(name, port);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">MyConfig cfg = ConfigFactory.create(MyConfig.class);</div><div class="line">Server s = cfg.server(); <span class="comment">// will return a single server</span></div><div class="line">Server[] ss = cfg.servers(); <span class="comment">// it works also with collections</span></div></pre></td></tr></table></figure></p>
<p>OWNER 支持的全部自动转换类型</p>
<ul>
<li>原生类型: boolean, byte, short, integer, long, float, double.</li>
<li>枚举</li>
<li>java.lang.String</li>
<li>java.net.URL, java.net.URI.</li>
<li>java.io.File</li>
<li>java.lang.Class</li>
<li>公有构造器只有一个<code>java.lang.String</code>的类</li>
<li>公有构造器只有一个<code>java.lang.Object</code>的类</li>
<li>被<code>public static</code>修饰, 签名为<code>valueOf(java.lang.String)</code>返回自身的方法</li>
<li>带有上述元素的数组</li>
<li>带有上述类的集合(<code>Set, List, SortedSet or concrete implementations like LinkedHashSet</code>). Map and sub-interfaces are not supported.</li>
</ul>
<h2 id="变量表达式"><a href="#变量表达式" class="headerlink" title="变量表达式"></a>变量表达式</h2><p>OWNER还提供了一个非常霸道的功能 —— 变量表达式, 参考如下配置文件<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attr">story=The</span> $&#123;animal&#125; jumped over the $&#123;target&#125;</div><div class="line"><span class="attr">animal=quick</span> $&#123;color&#125; fox</div><div class="line"><span class="attr">target=$&#123;target.attribute&#125;</span> dog</div><div class="line">target.<span class="attr">attribute=lazy</span></div><div class="line"><span class="attr">color=brown</span></div></pre></td></tr></table></figure></p>
<p>然后定义一个配置类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigWithExpansion</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">story</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>猜猜会输出什么, 对了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">The quick brown fox jumped over the lazy dog</div></pre></td></tr></table></figure></p>
<p>我们可以在配置文件里引用其他的配置</p>
<p>同样的我们还可以在配置类完成这样的功能<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigWithExpansion</span></span></div><div class="line">        <span class="keyword">extends</span> <span class="title">Config</span> &#123;</div><div class="line"></div><div class="line">    <span class="meta">@DefaultValue</span>(</div><div class="line">        <span class="string">"The $&#123;animal&#125; jumped over the $&#123;target&#125;"</span>)</div><div class="line">    <span class="function">String <span class="title">story</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"quick $&#123;color&#125; fox"</span>)</div><div class="line">    <span class="function">String <span class="title">animal</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"$&#123;target.attribute&#125; dog"</span>)</div><div class="line">    <span class="function">String <span class="title">target</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Key</span>(<span class="string">"target.attribute"</span>)</div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"lazy"</span>)</div><div class="line">    <span class="function">String <span class="title">targetAttribute</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"brown"</span>)</div><div class="line">    <span class="function">String <span class="title">color</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">ConfigWithExpansion conf = ConfigFactory</div><div class="line">    .create(ConfigWithExpansion.class);</div><div class="line"></div><div class="line">String story = conf.story();</div></pre></td></tr></table></figure></p>
<p>如果我们不需要开启变量表达式的话, 我们可以使用<code>@DisableFeature(VARIABLE_EXPANSION)</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Sample</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"Earth"</span>)</div><div class="line">    <span class="function">String <span class="title">world</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@DisableFeature</span>(VARIABLE_EXPANSION)</div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"Hello $&#123;world&#125;."</span>)</div><div class="line"></div><div class="line">    <span class="comment">// will return the string "Hello $&#123;world&#125;."</span></div><div class="line">    <span class="function">String <span class="title">sayHello</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/19/JavaLibrary/OWNER 初探/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/19/JavaLibrary/OWNER 初探/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/14/JavaLibrary/ASM Core(5) 工具/" title="ASM Core(5) 工具" itemprop="url">ASM Core(5) 工具</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-13T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-01-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>ASM通过<code>org.objectweb.asm.util</code>对<code>ClassVisitor, ClassReader, ClassWriter</code>提供非常多有帮助的类，通过这些类可以帮助开发者简化字节码的操作过程.</p>
<h2 id="Type"><a href="#Type" class="headerlink" title="Type"></a>Type</h2><p>在前面的文章中我们看到ASM API暴露了存储在字节码中的类型信息等等, 但是上文中的信息我们看到了可读性比较差, 因此ASM提供了<code>Type</code>这个工具类,让我们可以像源码中那样看到可读性更高的类型信息.</p>
<p>每个<code>Type</code>对象都代表着一个java类型, 我们可以通过类型描述符或者<code>Class</code>对象中构建出一个<code>Type</code>对象. 另外<code>Type</code>中还包含一些静态成员属性用于表示原生类型, 例如<code>e Type.INT_TYPE</code>就表示int类型.</p>
<p><code>getInternalName</code>方法用于获取类型的全限定名, 例如<code>Type.getType(String.class).getInternalName()</code>我们会得到一个<code>&quot;java/lang/String&quot;.</code>值, 需要注意的是这个方法只能用在class或者interface类型上.</p>
<p><code>getDescriptor</code>方法返回一个类型的描述符. 例如<code>&quot;Ljava/lang/String;&quot;</code>代表一个字符串类型, 但是我们可以在代码中使用<code>Type.getType(String.class).getDescriptor()</code>替代这种写法, 来换取更高的可读性. </p>
<p><code>Type</code>对象还可以表示一个方法类型. 方法类型的<code>Type</code>对象可以通过方法描述符或者<code>Method</code>对象构建出来. 同样的除了我们可以使用<code>getDescriptor</code>方法外,还可以使用<code>getArgumentTypes</code>和<code>getReturnType</code>来获取方法的参数或者返回值类型. 例如<code>Type.getArgumentTypes(&quot;(I)V&quot;)</code>和<code>Type.getReturnType(&quot;(I)V&quot;)</code>来获得更好的可读性.</p>
<h2 id="TraceClassVisitor"><a href="#TraceClassVisitor" class="headerlink" title="TraceClassVisitor"></a>TraceClassVisitor</h2><p>我们使用<code>ClassWriter</code>生成的新的class字节码是一个byte数组, 这种东西根本不具有可读性,因此ASM为我们提供了<code>TraceClassVisitor</code>, 它同样是继承自<code>ClassVisitor</code>, 他会输出一个文本格式的可读的新的类出来. 下面的例子中我们同时使用了<code>ClassWriter</code>和<code>TraceClassVisitor</code>, <code>TraceClassVisitor</code>代理了<code>ClassWriter</code>的全部方法调用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</div><div class="line">TraceClassVisitor cv = <span class="keyword">new</span> TraceClassVisitor(cw, printWriter);</div><div class="line">cv.visit(...);</div><div class="line">...</div><div class="line">cv.visitEnd();</div><div class="line"><span class="keyword">byte</span> b[] = cw.toByteArray();</div></pre></td></tr></table></figure></p>
<h2 id="CheckClassAdapter"><a href="#CheckClassAdapter" class="headerlink" title="CheckClassAdapter"></a>CheckClassAdapter</h2><p><code>ClassWriter</code>并不会检查生成的方法在调用的时候是顺序且参数是否都是正确的. 因此当JVM加载类进行验证的时候可能会抛出异常. 因此当我们秉持着错误越早发现越好, ASM为我们提供了<code>CheckClassAdapter</code>, 这个工具类会为我们检查上述问题. 同样的<code>CheckClassAdapter</code>继承自<code>ClassWriter.</code>, 它可以代理<code>TraceClassVisitor</code>或者<code>ClassWriter</code>的全部方法. 下面我们给出一个示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</div><div class="line">TraceClassVisitor tcv = <span class="keyword">new</span> TraceClassVisitor(cw, printWriter);</div><div class="line">CheckClassAdapter cv = <span class="keyword">new</span> CheckClassAdapter(tcv);</div><div class="line">cv.visit(...);</div><div class="line">...</div><div class="line">cv.visitEnd();</div><div class="line"><span class="keyword">byte</span> b[] = cw.toByteArray();</div></pre></td></tr></table></figure></p>
<p>注意, 我们要确定visitor之间的顺序关系, 如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</div><div class="line">CheckClassAdapter cca = <span class="keyword">new</span> CheckClassAdapter(cw);</div><div class="line">TraceClassVisitor cv = <span class="keyword">new</span> TraceClassVisitor(cca, printWriter);</div></pre></td></tr></table></figure></p>
<p>上面的例子是先进行文本输出然后再进行方法检查, 这是因为相当于<code>TraceClassVisitor</code>最终代理了所有的方法调用</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/asm/">asm</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/14/JavaLibrary/ASM Core(5) 工具/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/14/JavaLibrary/ASM Core(5) 工具/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/13/JavaLibrary/ASM Core(3) Methods/" title="ASM Core(3) Methods" itemprop="url">ASM Core(3) Methods</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-12T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-01-13</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://download.forge.objectweb.org/asm/asm4-guide.pdf" target="_blank" rel="external">asm4-guide</a>学习心得</p>
<p>本文主要是讲述如何通过ASM CORE API来生成和转换编译好的方法.</p>
<h2 id="执行模型"><a href="#执行模型" class="headerlink" title="执行模型"></a>执行模型</h2><p>在讲解字节码结构之前我们要首先讲解一下JVM的执行模型.</p>
<p>java代码都是在线程中执行. 每一个线程都有它自己执行栈, 每个执行栈都是由N个栈帧组成. 每个栈帧都代表着一个方法调用, 每当我们调用一个方法的时候, 就会向当前执行栈(活动线程)中push一个栈帧. 当方法结束(return或者抛出异常)时就会将当前栈帧出栈. 然后继续调用下一个方法.</p>
<p>每一个栈帧都有俩部分组成</p>
<ul>
<li>local variables 本地变量</li>
<li>operand stack  操作数栈</li>
</ul>
<p>我们通过索引来访问local variables. operand stack存储的是操作数, 正如其名, 它也是一个栈结构, 因此我们通过Last In First Out对其进行访问.</p>
<p>local variables和 operand stack的大小取决于方法的大小. 这些大小是在编译期进行计算, 而且也是进行单独存储的.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/asm/">asm</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/13/JavaLibrary/ASM Core(3) Methods/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/13/JavaLibrary/ASM Core(3) Methods/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/12/JavaLibrary/ASM Core(2) 操作/" title="ASM Core(2) Class的增删改查" itemprop="url">ASM Core(2) Class的增删改查</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-11T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-01-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://download.forge.objectweb.org/asm/asm4-guide.pdf" target="_blank" rel="external">asm4-guide</a>学习心得</p>
<h2 id="获取class信息"><a href="#获取class信息" class="headerlink" title="获取class信息"></a>获取class信息</h2><p>下来的示例中我们通过重写<code>ClassVisitor</code>相关函数然后依次打印出类型信息, 字段信息和函数信息.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassPrinter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClassPrinter</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(Opcodes.ASM4);</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> version, <span class="keyword">int</span> access, String name, String signature, String superName, String[] interfaces)</span> </span>&#123;</div><div class="line">		System.out.println(name + <span class="string">" extends "</span> + superName + <span class="string">" &#123;"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitSource</span><span class="params">(String source, String debug)</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitOuterClass</span><span class="params">(String owner, String name, String desc)</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> AnnotationVisitor <span class="title">visitAnnotation</span><span class="params">(String desc, <span class="keyword">boolean</span> visible)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitAttribute</span><span class="params">(Attribute attr)</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitInnerClass</span><span class="params">(String name, String outerName, String innerName, <span class="keyword">int</span> access)</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> FieldVisitor <span class="title">visitField</span><span class="params">(<span class="keyword">int</span> access, String name, String desc, String signature, Object value)</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">" "</span> + desc + <span class="string">" "</span> + name);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> access, String name, String desc, String signature, String[] exceptions)</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">" "</span> + name + desc);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"&#125;"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后我们写一段运行代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		<span class="comment">// 读取解析二进制字节流</span></div><div class="line">		ClassReader cr = <span class="keyword">new</span> ClassReader(<span class="string">"Test"</span>);</div><div class="line">		ClassPrinter cp = <span class="keyword">new</span> ClassPrinter();</div><div class="line">		<span class="comment">// 开始处理字节流信息</span></div><div class="line">		cr.accept(cp, <span class="number">0</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Test extends java/lang/Object &#123;</div><div class="line"> &lt;init&gt;()<span class="function">V</span></div><div class="line"> <span class="title">main</span><span class="params">([Ljava/lang/String;)</span>V</div><div class="line"> lambda$main$22<span class="params">(Ljava/lang/Integer;)</span>V</div><div class="line"> lambda$main$21<span class="params">(Ljava/lang/Integer;Ljava/lang/Integer;)</span>I</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在测试代码中我们首先创建了一个<code>ClassReader</code>实例用于读取<code>Test</code>字节码. 然后由<code>accept()</code>方法依次调用<code>ClassPrinter</code>的方法</p>
<h2 id="动态生成Class"><a href="#动态生成Class" class="headerlink" title="动态生成Class"></a>动态生成Class</h2><p>我们仅仅使用<code>ClassWriter</code>就可以生成一个类, 例如我们要生成一个如下的接口<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> pkg;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Comparable</span> <span class="keyword">extends</span> <span class="title">Mesurable</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> LESS = -<span class="number">1</span>;</div><div class="line">	<span class="keyword">int</span> EQUAL = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> GREATER = <span class="number">1</span>;</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Object o)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们仅仅需要调用<code>ClassVisitor</code>的六个方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</div><div class="line">		cw.visit(V1_8,											<span class="comment">// 指定class文件版本号, 我们将其设置为java8</span></div><div class="line">				ACC_PUBLIC + ACC_ABSTRACT + ACC_INTERFACE,	<span class="comment">// 设置接口的修饰符, 需要指出的是由于interface是不可实例化的,</span></div><div class="line">																<span class="comment">// 因此我们将其设置为ACC_ABSTRACT的</span></div><div class="line">				<span class="string">"pkg/Comparable"</span>,								<span class="comment">// 我们设置classname, 需要在这里指定全限定名</span></div><div class="line">				<span class="keyword">null</span>,											<span class="comment">// 设置泛型信息, 因为我们的接口是非泛化的, 因此我们将其设置为null</span></div><div class="line">				<span class="string">"java/lang/Object"</span>,							<span class="comment">// 设置父类, 同时需要设定全限定名</span></div><div class="line">				<span class="keyword">new</span> String[] &#123; <span class="string">"pkg/Mesurable"</span> &#125;);			<span class="comment">// 设置接口, 同样需要设置全限定名</span></div><div class="line"></div><div class="line">		cw.visitField(</div><div class="line">				ACC_PUBLIC + ACC_FINAL + ACC_STATIC,	<span class="comment">// 设置字段的修饰符</span></div><div class="line">				<span class="string">"LESS"</span>,										<span class="comment">// 设置字段名</span></div><div class="line">				<span class="string">"I"</span>,										<span class="comment">// 设置字段类型</span></div><div class="line">				<span class="keyword">null</span>,										<span class="comment">// 设置泛型信息</span></div><div class="line">				<span class="keyword">new</span> Integer(-<span class="number">1</span>))							<span class="comment">// 设置字面量值. (如果这个字段是常量值的话,例如 final static,</span></div><div class="line">																					<span class="comment">// 那么我们就必须设置这个值)</span></div><div class="line">				.visitEnd();</div><div class="line"></div><div class="line">		cw.visitMethod(ACC_PUBLIC + ACC_ABSTRACT,		<span class="comment">// 设置字段的修饰符</span></div><div class="line">				<span class="string">"compareTo"</span>,								<span class="comment">// 设置方法名</span></div><div class="line">				<span class="string">"(Ljava/lang/Object;)I"</span>,					<span class="comment">// 设置返回值类型</span></div><div class="line">				<span class="keyword">null</span>,										<span class="comment">// 设置泛型信息</span></div><div class="line">				<span class="keyword">null</span>)										<span class="comment">// 设置异常信息</span></div><div class="line">				.visitEnd();</div><div class="line"></div><div class="line">		cw.visitEnd();</div><div class="line">		<span class="keyword">byte</span>[] b = cw.toByteArray();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="使用生成的类"><a href="#使用生成的类" class="headerlink" title="使用生成的类"></a>使用生成的类</h2><p>记下来我们自定义一个<code>ClassLoader</code>来加载生成的字节码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> Class <span class="title">defineClass</span><span class="params">(String name, <span class="keyword">byte</span>[] b)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> defineClass(name, b, <span class="number">0</span>, b.length);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后使用它<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">byte</span>[] bytes = genComparableInterface();</div><div class="line">MyClassLoader myClassLoader = <span class="keyword">new</span> MyClassLoader();</div><div class="line">Class c = myClassLoader.defineClass(<span class="string">"pkg.Comparable"</span>, bytes);</div></pre></td></tr></table></figure></p>
<p>我们直接使用<code>defineClass</code>函数来加载这个类.</p>
<p>另外我们还可以重写<code>findClass</code>这个函数来动态的生成我们所需要的类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StubClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> Class <span class="title">findClass</span><span class="params">(String name)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</div><div class="line">		<span class="keyword">if</span> (name.endsWith(<span class="string">"_Stub"</span>)) &#123;</div><div class="line">			ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</div><div class="line">			...</div><div class="line">			<span class="keyword">byte</span>[] b = cw.toByteArray();</div><div class="line">			<span class="keyword">return</span> defineClass(name, b, <span class="number">0</span>, b.length);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.findClass(name);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="修改已存在的Class"><a href="#修改已存在的Class" class="headerlink" title="修改已存在的Class"></a>修改已存在的Class</h2><p>在上篇文章中我们只是单独的使用了<code>ClassReader</code>和<code>ClassWriter</code>,但是更多的应用其实应该是将其组合到一起使用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">byte</span>[] b1 = ...;</div><div class="line">ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</div><div class="line">ClassReader cr = <span class="keyword">new</span> ClassReader(b1);</div><div class="line">cr.accept(cw, <span class="number">0</span>);</div><div class="line"><span class="keyword">byte</span>[] b2 = cw.toByteArray(); <span class="comment">// b2 represents the same class as b1</span></div></pre></td></tr></table></figure></p>
<p>这个例子中我们什么都没有做, 只不过完成了一个copy字节码的功能, 接下来我们在这俩个过程中加入<code>ClassVisitor</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">byte</span>[] b1 = ...;</div><div class="line">ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</div><div class="line"><span class="comment">// cv forwards all events to cw</span></div><div class="line">ClassVisitor cv = <span class="keyword">new</span> ClassVisitor(ASM4, cw) &#123; &#125;;</div><div class="line">ClassReader cr = <span class="keyword">new</span> ClassReader(b1);</div><div class="line">cr.accept(cv, <span class="number">0</span>);</div><div class="line"><span class="keyword">byte</span>[] b2 = cw.toByteArray(); <span class="comment">// b2 represents the same class as b1</span></div></pre></td></tr></table></figure></p>
<p>这段代码的处理流程如下图<img src="https://raw.githubusercontent.com/yu66/blog-website/images/asm/transformation%20chain.jpg" alt=""></p>
<blockquote>
<p>方框代表我们的核心组件, 箭头代表我们的数据流.</p>
</blockquote>
<p>下面我们给出一个<code>ClassVisitor</code>小例子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeVersionAdapter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ChangeVersionAdapter</span><span class="params">(ClassVisitor cv)</span> </span>&#123;</div><div class="line">		<span class="comment">// ASM4为ASM的版本号</span></div><div class="line">		<span class="keyword">super</span>(ASM4, cv);</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> version, <span class="keyword">int</span> access, String name,</span></span></div><div class="line">					  String signature, String superName, String[] interfaces) &#123;</div><div class="line">		<span class="comment">// 修改class信息</span></div><div class="line">		cv.visit(V1_5,			<span class="comment">// 改变class的版本号</span></div><div class="line">				access,			<span class="comment">// 改变class的标识符</span></div><div class="line">				name,			<span class="comment">// 改变类名</span></div><div class="line">				signature,		<span class="comment">// 泛型信息</span></div><div class="line">				superName,		<span class="comment">// 父类信息</span></div><div class="line">				interfaces);	<span class="comment">// 接口信息</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在上面的实现中,除了调用<code>visit</code>函数(修改类本身函数, 将class版本号转化为1.5), 其他的方法都没有重写,因此他们什么改变都不会做. 下来我们给出这个类执行的时序图<br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/asm/Sequence%20diagram%20for%20the%20ChangeVersionAdapter.jpg" alt=""><br>从这个时序图中我们可以看出, 用户调用了<code>accept</code>方法之后, 有ASM自动调用<code>ClassReader</code>的<code>visti(version)</code>方法, 接着调用<code>ChangeVersionAdapter</code>的<code>visti(1.5)</code>方法, 最后调用<code>ClassWriter</code>的相关方法. 从这个模式中我们可以看出, ASM的调用模式是链式调用的, 先调用visit, 然后调用责任链中所有的<code>ClassVisitor</code>的vist最后调用<code>ClassWriter</code>的完结方法. 当<code>visit</code>调用完之后再调用<code>visitSource</code>责任链流程, 依次类推下去.</p>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>在上述的代码中, 其实代码的运行效率并不是高效进行的. 这是因为当<code>b1</code>字节码被<code>ClassReader</code>读取并通过<code>ClassVisitor</code>将其执行转换的时候, 我们可能只改变了class的版本号, 其他部分并没有转换, 但是在实际的执行中其他的部分也都被执行了一边, 那这就浪费了cpu计算和内存空间的占用, 其实只需要将不需要改变的字节从<code>b1</code>直接拷贝到<code>b2</code>就好了.  </p>
<p>好在ASM为我们内部构建了这种优化过程.<br>*</p>
<h2 id="删除成员"><a href="#删除成员" class="headerlink" title="删除成员"></a>删除成员</h2><p>如果我们想将class中的某个成员删除掉, 那么只需在执行asm责任链调用时, 中断调用过程(不调用super或者直接return)就可以了.</p>
<p>例如我们下面的例子我们将类中的内部类和外部类以及编译成该class的源文件信息删除掉<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RemoveDebugAdapter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">RemoveDebugAdapter</span><span class="params">(ClassVisitor cv)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(ASM4, cv);</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitSource</span><span class="params">(String source, String debug)</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitOuterClass</span><span class="params">(String owner, String name, String desc)</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitInnerClass</span><span class="params">(String name, String outerName, String innerName, <span class="keyword">int</span> access)</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看,就是如此简单, 我们在这三个方法内部什么都不做(不进行super调用)就轻松地完成了我们需要的功能, 但是这种做法却并不适合<br>字段和方法的删除, 因为在字段和方法的删除中除了不进行super调用之外还需要return null, 如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RemoveMethodAdapter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> String mName;</div><div class="line">	<span class="keyword">private</span> String mDesc;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">RemoveMethodAdapter</span><span class="params">(</span></span></div><div class="line">			ClassVisitor cv, String mName, String mDesc) &#123;</div><div class="line">		<span class="keyword">super</span>(ASM4, cv);</div><div class="line">		<span class="keyword">this</span>.mName = mName;</div><div class="line">		<span class="keyword">this</span>.mDesc = mDesc;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> access, String name,</span></span></div><div class="line">									 String desc, String signature, String[] exceptions) &#123;</div><div class="line">		<span class="keyword">if</span> (name.equals(mName) &amp;&amp; desc.equals(mDesc)) &#123;</div><div class="line">			<span class="comment">// do not delegate to next visitor -&gt; this removes the method</span></div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> cv.visitMethod(access, name, desc, signature, exceptions);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="添加成员"><a href="#添加成员" class="headerlink" title="添加成员"></a>添加成员</h2><p>当我们中断方法调用的时候,会删除成员. 但是当我们在责任链中的原生方法调用(<code>visitXxx</code>方法)中新增加一些方法调用的话, 会增加成员.</p>
<p>例如如果你想要增加一个字段, 那么你必须在<code>visitXxx</code>方法中增加一个<code>visitField</code>方法调用. 需要注意的是<code>visitXxx</code>方法只包含<code>visitInnerClass,visitField, visitMethod,visitEnd</code>这四个方法, 这是因为<code>visit,visitSource,visitOuterClass,visitAnnotation,visitAttribute</code> 这些方法正如我们在第一篇文章中给出那些顺序一样, <code>visitField</code>方法只能在这些方法之后调用.</p>
<blockquote>
<p>需要注意的是,由于<code>visitInnerClass,visitField, visitMethod</code>这些方法会进行多次调用, 因此有可能会添加N个相同的成员, 因此我们建议在<code>visitEnd</code>的时候进行成员添加, 这是因为这个方法总会有且只有一次调用.</p>
</blockquote>
<p>如下例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddFieldAdapter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> fAcc;</div><div class="line">	<span class="keyword">private</span> String fName;</div><div class="line">	<span class="keyword">private</span> String fDesc;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> isFieldPresent;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">AddFieldAdapter</span><span class="params">(ClassVisitor cv, <span class="keyword">int</span> fAcc, String fName, String fDesc)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(ASM4, cv);</div><div class="line">		<span class="keyword">this</span>.fAcc = fAcc;</div><div class="line">		<span class="keyword">this</span>.fName = fName;</div><div class="line">		<span class="keyword">this</span>.fDesc = fDesc;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> FieldVisitor <span class="title">visitField</span><span class="params">(<span class="keyword">int</span> access, String name, String desc, String signature, Object value)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (name.equals(fName)) &#123;</div><div class="line">			isFieldPresent = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> cv.visitField(access, name, desc, signature, value);</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (!isFieldPresent) &#123;</div><div class="line">			FieldVisitor fv = cv.visitField(fAcc, fName, fDesc, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">			<span class="keyword">if</span> (fv != <span class="keyword">null</span>) &#123;</div><div class="line">				fv.visitEnd();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		cv.visitEnd();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/asm/">asm</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/12/JavaLibrary/ASM Core(2) 操作/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/12/JavaLibrary/ASM Core(2) 操作/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/11/JavaLibrary/ASM Core(1) 初探/" title="ASM Core(1) 初探" itemprop="url">ASM Core(1) 初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-10T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-01-11</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://download.forge.objectweb.org/asm/asm4-guide.pdf" target="_blank" rel="external">asm4-guide</a>学习心得<br> ASM是一种小巧轻便的 Java 字节码操控框架，它能方便地生成和改造 Java 代码</p>
<p>ASM通过<code>ClassVisitor</code>来生成和转换class字节码. <code>ClassVisitor</code>中的每个方法都对应着class数据结构, 你可以通过每个方法名轻松的判断出这个方法对应的是哪个数据结构. </p>
<p><code>ClassVisitor</code>内的方法调用顺序如下:</p>
<ol>
<li>visit  : 调用<code>visit</code>方法(有且仅有调用一次)</li>
<li>visitSource?  : 调用<code>visitSource</code>函数(最多调用一次)</li>
<li>visitOuterClass?  : 调用<code>visitOuterClass</code>函数(最多调用一次)</li>
<li>( visitAnnotation | visitAttribute )* : 调用<code>visitAnnotation</code>和<code>visitAttribute</code>函数, 这俩个函数的调用可调用任意次且不分前后顺序</li>
<li>( visitInnerClass | visitField | visitMethod )* : 调用<code>visitInnerClass</code>,<code>visitField</code>和<code>visitMethod</code>函数, 同样对这三个函数的调用不限制次数以及不分前后顺序</li>
<li>visitEnd : 调用<code>visitEnd</code>函数(有且仅有调用一次),调用这个函数用于结束整个过程.</li>
</ol>
<p>ASM通过基于<code>ClassVisitor</code>的三个API来生成和转换class字节码</p>
<ul>
<li><code>ClassReader</code>: 用于解析一个给定的class二进制字节数组, 然后按照上文介绍的顺序依次调用<code>accept()</code>的<code>ClassVisitor</code>参数的方法.</li>
<li><code>ClassWriter</code> : 一个<code>ClassVisitor</code>的子类, 用于直接生成二进制的字节码. </li>
<li><code>ClassVisitor</code> : 代理了全部的字节码相关的方法调用. 它接收另一个<code>ClassVisitor</code>对象形成责任链模式调用.</li>
</ul>
<p>我们通过<code>ClassReader</code>来解析一个二进制的class结构数据, 然后<code>ClassReader</code>按照一定的顺序调用<code>ClassVisitor</code> 来改变class结构数据, 最后通过<code>ClassVisitor</code>生成新的class二进制数据.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/asm/">asm</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/11/JavaLibrary/ASM Core(1) 初探/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/11/JavaLibrary/ASM Core(1) 初探/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/16/编程语言/PHP 语法初探/" title="PHP 语法初探" itemprop="url">PHP 语法初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2015-12-16T08:00:00.000Z" itemprop="datePublished"> 发表于 2015-12-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>PHP 脚本以 <code>&lt;?php 开头，以 ?&gt;</code> 结尾：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">// 此处是 PHP 代码</span></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">// 定义一个变量</span></div><div class="line">$x=<span class="number">5</span>;</div><div class="line"><span class="comment">// 调用echo函数输出变量x的值</span></div><div class="line"><span class="keyword">echo</span> $x;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>PHP 有三种不同的变量作用域：</p>
<ul>
<li>local : 函数里定义的变量,只能在函数内部访问,函数外部不可访问</li>
<li>global: 函数外部定义的变量,只能在函数外部访问,函数内部不可访问</li>
<li>static: 当变量脱离它的作用域之后,并不会被删除掉,而是缓存起来</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$x=<span class="number">5</span>; <span class="comment">// 全局作用域</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">socpePrint</span><span class="params">()</span> </span>&#123;</div><div class="line">  $y=<span class="number">10</span>; <span class="comment">// 局部作用域</span></div><div class="line">  <span class="keyword">echo</span> $y;</div><div class="line">  <span class="keyword">echo</span> $x;</div><div class="line">&#125; </div><div class="line"></div><div class="line">myTest();</div><div class="line"></div><div class="line"><span class="keyword">echo</span> $y;</div><div class="line"><span class="keyword">echo</span> $x;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>刚才我们只是介绍了<code>global</code>这个作用域,其实还有<code>global</code>关键字,这个关键字是在函数内部定义一个全局变量,让函数外访问函数内部的变量<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">socpePrint</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">global</span> $x=<span class="number">10</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">socpePrint();</div><div class="line"><span class="keyword">echo</span> $x;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>php里有如下的数据类型</p>
<ul>
<li>字符串</li>
<li>整数</li>
<li>浮点数</li>
<li>逻辑</li>
<li>数组</li>
<li>对象</li>
<li>NULL<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$stringVar=<span class="string">"this is a string"</span>;	<span class="comment">// 定义一个字符串</span></div><div class="line">$numVar=<span class="number">10</span>;	<span class="comment">// 定义一个整数</span></div><div class="line">$floatVar=<span class="number">1.0</span>;	<span class="comment">// 定义一个浮点数</span></div><div class="line">$boolVar=<span class="keyword">true</span>;		<span class="comment">// 定义一个布尔值</span></div><div class="line">$arrayVar=<span class="keyword">array</span>(<span class="number">1</span>,<span class="number">2</span>);	<span class="comment">// 定义一个数组</span></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>数组相关操作<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$arrayVar=<span class="keyword">array</span>(<span class="number">1</span>,<span class="number">2</span>);	<span class="comment">// 定义一个数组</span></div><div class="line">$ele1=$arrayVar[<span class="number">0</span>];	<span class="comment">// 访问数组第一个元素</span></div><div class="line">$arrayCount=count($arrayVar);	<span class="comment">// 求数组长度</span></div><div class="line">$arrayVar[<span class="number">2</span>]=<span class="number">3</span>;		<span class="comment">// 向数组中追加元素</span></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>下面我们定义了一个求和函数, 这个函数定义了俩个参数<code>x, y</code>, 其中y是一个默认参数,它有一个默认值, 最后我们还定义了一个函数返回值.<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span><span class="params">($x,$y=<span class="number">5</span>)</span> </span>&#123;</div><div class="line">  $z=$x+$y;</div><div class="line">  <span class="keyword">return</span> $z;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">echo</span> sum(<span class="number">5</span>,<span class="number">10</span>);</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="常量函数"><a href="#常量函数" class="headerlink" title="常量函数"></a>常量函数</h3><p>在php中,我们如果想要定义一个常量,则必须使用常量函数<code>define()</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">define(<span class="string">"constant"</span>, <span class="string">"I am constant"</span>, <span class="keyword">true</span>);</div><div class="line"><span class="keyword">echo</span> CONSTANT;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>最后一个参数是一个可选参数,如果设置为true,则说明访问常量的时候是不区分大小写的. 访问常量则不需要<code>$</code>符号</p>
<h3 id="日期函数"><a href="#日期函数" class="headerlink" title="日期函数"></a>日期函数</h3><p>我们使用<code>date(format,timestamp)</code>函数来获得系统的时间, 第二个参数是可选的,如果不填则是当前时间. 第一个参数则是格式化时间戳的格式, 有如下选项</p>
<ul>
<li><code>d</code> - 表示月里的某天（01-31）</li>
<li><code>m</code> - 表示月（01-12）</li>
<li><code>Y</code> - 表示年（四位数）</li>
<li><code>1</code> - 表示周里的某天</li>
<li><code>h</code> - 带有首位零的 12 小时小时格式</li>
<li><code>i</code> - 带有首位零的分钟</li>
<li><code>s</code> - 带有首位零的秒（00 -59）</li>
<li><code>a</code> - 小写的午前和午后（am 或 pm）<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">&lt;?php</span> </div><div class="line">$now = date(<span class="string">"Y-m-d h:i:sa"</span>);</div><div class="line"><span class="keyword">echo</span> $now;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h2><h3 id="if-else"><a href="#if-else" class="headerlink" title="if else"></a>if else</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">define(<span class="string">"TEN"</span>, <span class="number">10</span>);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (TEN&lt;<span class="string">"20"</span>) &#123;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"10 &lt; 20"</span>;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">	<span class="keyword">echo</span> <span class="string">"ERROR"</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>如果还有其他条件的话我们可以采用<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">define(<span class="string">"TEN"</span>, <span class="number">10</span>);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (TEN&lt;<span class="number">20</span>) &#123;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"10 &lt; 20"</span>;</div><div class="line">&#125; <span class="keyword">elseif</span> (TEN==<span class="number">20</span>) &#123;</div><div class="line">  <span class="keyword">echo</span> <span class="string">"ERROR"</span>;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">	<span class="keyword">echo</span> <span class="string">"ERROR"</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">switch</span> ($x)</div><div class="line">&#123;</div><div class="line"><span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">  <span class="keyword">echo</span> <span class="string">"Number 1"</span>;</div><div class="line">  <span class="keyword">break</span>;</div><div class="line"><span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">  <span class="keyword">echo</span> <span class="string">"Number 2"</span>;</div><div class="line">  <span class="keyword">break</span>;</div><div class="line"><span class="keyword">default</span>:</div><div class="line">  <span class="keyword">echo</span> <span class="string">"No number between 1 and 3"</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<h3 id="while"><a href="#while" class="headerlink" title="while"></a>while</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> </div><div class="line">$x=<span class="number">1</span>; </div><div class="line"><span class="keyword">while</span>($x&lt;=<span class="number">5</span>) &#123;</div><div class="line">  <span class="keyword">echo</span> <span class="string">"这个数字是：$x &lt;br&gt;"</span>;</div><div class="line">  $x++;</div><div class="line">&#125; </div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<h3 id="for"><a href="#for" class="headerlink" title="for"></a>for</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> </div><div class="line"><span class="keyword">for</span> ($x=<span class="number">0</span>; $x&lt;=<span class="number">10</span>; $x++) &#123;</div><div class="line">  <span class="keyword">echo</span> $x;</div><div class="line">&#125; </div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>另外还有一种适用于数组的foreach<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> </div><div class="line">$colors = <span class="keyword">array</span>(<span class="string">"red"</span>,<span class="string">"green"</span>,<span class="string">"blue"</span>,<span class="string">"yellow"</span>); </div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($colors <span class="keyword">as</span> $value) &#123;</div><div class="line">  <span class="keyword">echo</span> <span class="string">"$value"</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>如果我们遍历数组的时候,数组的元素是一个键值对的话, 我们可以这样处理<br>&lt;?php<br>$colors = array(“red:555”,”green:123”,”blue:856”); </p>
<p>foreach ($colors as $colerKey =&gt; $colorValue) {<br>  echo “$colerKey  is $colorValue”;<br>}<br>?&gt;<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="code">`=&gt;`</span>就表示一个键值对</div><div class="line"></div><div class="line"><span class="section">## 文件</span></div><div class="line">我们使用<span class="code">`fopen(fileName, openMode)`</span>函数打开文件, 第一个参数是文件名, 第二个参数打开模式</div><div class="line"><span class="bullet">* </span><span class="code">`r`</span>:	打开文件为只读。文件指针在文件的开头开始。</div><div class="line"><span class="bullet">* </span><span class="code">`w`</span>:	打开文件为只写。删除文件的内容或创建一个新的文件，如果它不存在。文件指针在文件的开头开始。</div><div class="line"><span class="bullet">* </span><span class="code">`a`</span>:	打开文件为只写。文件中的现有数据会被保留。文件指针在文件结尾开始。创建新的文件，如果文件不存在。</div><div class="line"><span class="bullet">* </span><span class="code">`x`</span>:	创建新文件为只写。返回 FALSE 和错误，如果文件已存在。</div><div class="line"><span class="bullet">* </span><span class="code">`r+`</span>:	打开文件为读/写、文件指针在文件开头开始。</div><div class="line"><span class="bullet">* </span><span class="code">`w+`</span>:	打开文件为读/写。删除文件内容或创建新文件，如果它不存在。文件指针在文件开头开始。</div><div class="line"><span class="bullet">* </span><span class="code">`a+`</span>:	打开文件为读/写。文件中已有的数据会被保留。文件指针在文件结尾开始。创建新文件，如果它不存在。</div><div class="line"><span class="bullet">* </span><span class="code">`x+`</span>:	创建新文件为读/写。返回 FALSE 和错误，如果文件已存在。</div><div class="line"><span class="code">```php</span></div><div class="line">&lt;?php</div><div class="line">$demofile = fopen("demo.txt", "r") or die("Unable to open file!");</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p>读取文件内容, <code>fread()</code>函数会读取整个文件内容<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> </div><div class="line">$demofile = fopen(<span class="string">"demo.txt"</span>, <span class="string">"r"</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Unable to open file!"</span>);</div><div class="line">fread($demofile,filesize(<span class="string">"demo.txt"</span>));</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>按行读取<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$demofile = fopen(<span class="string">"demo.txt"</span>, <span class="string">"r"</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Unable to open file!"</span>);</div><div class="line"><span class="keyword">while</span>(!feof($demofile)) &#123;	<span class="comment">// 如果文件没有到达结尾的话,则继续读取</span></div><div class="line">  <span class="keyword">echo</span> fgets($demofile);	<span class="comment">// 读取一行</span></div><div class="line">&#125;</div><div class="line">fclose($myfile);		<span class="comment">// 关闭文件</span></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>向文件中写入数据<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> </div><div class="line">$demofile = fopen(<span class="string">"demo.txt"</span>, <span class="string">"w"</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Unable to open file!"</span>);</div><div class="line">fwrite($demofile, <span class="string">"hello world"</span>);</div><div class="line">fclose($myfile);</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h2><p>建立连接<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> </div><div class="line"><span class="comment">// 建立mysql连接</span></div><div class="line">$con = mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</div><div class="line"><span class="keyword">if</span> (!$con) &#123;</div><div class="line">  <span class="keyword">die</span>(<span class="string">'Could not connect: '</span> . mysql_error());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 选择数据库</span></div><div class="line">mysql_select_db(<span class="string">"my_db"</span>, $con);</div><div class="line"></div><div class="line"><span class="comment">// 执行sql语句</span></div><div class="line">$result = mysql_query(<span class="string">"SELECT * FROM Persons"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 遍历结果</span></div><div class="line"><span class="keyword">while</span>($row = mysql_fetch_array($result)) &#123;</div><div class="line">	<span class="comment">// 输出某个列元素</span></div><div class="line">  <span class="keyword">echo</span> $row[<span class="string">'FirstName'</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 关闭连接</span></div><div class="line">mysql_close($con);</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/12/16/编程语言/PHP 语法初探/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/12/16/编程语言/PHP 语法初探/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/09/JavaLibrary/lombok/" title="Lombok初探" itemprop="url">Lombok初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2015-12-08T16:00:00.000Z" itemprop="datePublished"> 发表于 2015-12-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>参考文档<a href="https://projectlombok.org/features/index.html" target="_blank" rel="external">lombok</a><br>在使用lombok的时候, 我们需要在IDE上安装上lombok插件以及引用相关的jar包依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>lombok其实帮我们做的事情是, 在编译java源码的时候,会根据相关注解编译出相关的代码. 例如如果我们使用<code>@Setter</code>注解的话,那么在编译的会在class文件中添加相应的setter代码</p>
<h2 id="val"><a href="#val" class="headerlink" title="val"></a>val</h2><p>下来我们看一个小例子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">val example = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">example.add(<span class="string">"Hello, World!"</span>);</div><div class="line">val foo = example.get(<span class="number">0</span>);</div><div class="line">System.out.println(foo.equals(<span class="string">"Hello, World!"</span>));</div></pre></td></tr></table></figure></p>
<p>上面这个例子我们使用val代替了<code>ArrayList</code>类型. 插件会只能地帮我们识别出这个真正的类型是什么.</p>
<blockquote>
<p>注意, <code>new ArrayList&lt;String&gt;()</code>菱形符里应该指定类型,否则我们既可以在example上添加String又可以添加int,会带来类型上的不安全</p>
</blockquote>
<h2 id="NonNull"><a href="#NonNull" class="headerlink" title="NonNull"></a>NonNull</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestNonNull</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		print(<span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(@NonNull String content)</span> </span>&#123;</div><div class="line">		System.out.println(content);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个注解很简单就是检查参数非null,如果传进的参数为null的就抛出<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Exception in thread <span class="string">"main"</span> java.lang.NullPointerException: content</div><div class="line">	at Lombok.TestNonNull.print(TestNonNull.java:<span class="number">13</span>)</div><div class="line">	at Lombok.TestNonNull.main(TestNonNull.java:<span class="number">10</span>)</div></pre></td></tr></table></figure></p>
<h2 id="Cleanup"><a href="#Cleanup" class="headerlink" title="Cleanup"></a>Cleanup</h2><p>这个注解会在资源在其作用域离开之后,自动将资源关闭掉<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Cleanup</span> BufferedReader fileReader1 = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(<span class="string">"D://hazelcast-documentation-3.5.3.pdf"</span>));</div></pre></td></tr></table></figure></p>
<h2 id="Getter-Setter"><a href="#Getter-Setter" class="headerlink" title="Getter Setter"></a>Getter Setter</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestGetterSetter</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		A a = <span class="keyword">new</span> A();</div><div class="line">		a.getA2();</div><div class="line">		a.getA3();</div><div class="line">		a.setA1(<span class="string">"a1"</span>);</div><div class="line">		a.setA3(<span class="string">"a3"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Setter</span> <span class="keyword">private</span> String a1;</div><div class="line">	<span class="meta">@Getter</span> <span class="keyword">private</span> String a2;</div><div class="line">	<span class="meta">@Setter</span> <span class="meta">@Getter</span> <span class="keyword">private</span> String a3;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>@Getter</code>和<code>@Setter</code>注解有一点需要说明的是,我们可以指定他们的访问级别<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Setter</span>(value = AccessLevel.MODULE) <span class="keyword">private</span> String a1;</div></pre></td></tr></table></figure></p>
<p>可设置的级别有:</p>
<ul>
<li>PUBLIC,</li>
<li>MODULE,</li>
<li>PROTECTED,</li>
<li>PACKAGE,</li>
<li>PRIVATE,</li>
<li>NONE;</li>
</ul>
<h2 id="ToString"><a href="#ToString" class="headerlink" title="ToString"></a>ToString</h2><p><code>@ToString</code>注解既可以用在类上可以用在方法上, 这个注解会修改类的<code>toString()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestToString</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		C c = <span class="keyword">new</span> C();</div><div class="line">		c.c1 = <span class="string">"c_1"</span>;</div><div class="line">		c.c2 = <span class="string">"c_2"</span>;</div><div class="line">		c.b1 = <span class="string">"b_1"</span>;</div><div class="line">		c.b2 = <span class="string">"b_2"</span>;</div><div class="line">		System.out.println(c);</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// toString()中不包含b1和b2这俩个属性</span></div><div class="line"><span class="meta">@ToString</span>(exclude=&#123;<span class="string">"b1"</span>, <span class="string">"b2"</span>&#125;)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> String b1;</div><div class="line">	<span class="keyword">public</span> String b2;</div><div class="line">	<span class="keyword">public</span> String b3;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 调用父类的toString和在输出时包含字段名称</span></div><div class="line"><span class="meta">@ToString</span>(callSuper=<span class="keyword">true</span>, includeFieldNames = <span class="keyword">true</span>)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">extends</span> <span class="title">B</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> String c1;</div><div class="line">	<span class="keyword">public</span> String c2;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码输出为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">C(<span class="keyword">super</span>=B(b2=<span class="keyword">null</span>), c1=<span class="keyword">null</span>, c2=<span class="keyword">null</span>)</div><div class="line">B(b2=<span class="keyword">null</span>)</div><div class="line">C(<span class="keyword">super</span>=B(b2=b_2), c1=c_1, c2=c_2)</div></pre></td></tr></table></figure></p>
<h2 id="EqualsAndHashCode"><a href="#EqualsAndHashCode" class="headerlink" title="EqualsAndHashCode"></a>EqualsAndHashCode</h2><p>这个注解人如其名, 会为我们生成俩个规范的<code>equals()</code>和<code>hashCode()</code>方法, 至于什么是规范的,参考Effective java这本书<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@EqualsAndHashCode</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> </span>&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h2><p><code>@Data</code>注解是<code>@ToString, @EqualsAndHashCode, @Getter / @Setter and @RequiredArgsConstructor</code>这些注解的一个集合. 它会默认地为我们使用那些注解.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Data</span> <span class="class"><span class="keyword">class</span> <span class="title">Simple</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">		setId(<span class="number">123</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Value"><a href="#Value" class="headerlink" title="Value"></a>Value</h2><p><code>@Value</code>是<code>@Data</code>注解的一个变种, 它是在<code>@Data</code>注解的基础将,将类成为不可变的.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Value</span> <span class="class"><span class="keyword">class</span> <span class="title">E</span> </span>&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Builder"><a href="#Builder" class="headerlink" title="Builder"></a>Builder</h2><p><code>@Builder</code>将类修改成Builder模式(同样参考Effective Java).</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestBuilder</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		F f = F.builder().f1(<span class="string">"fff"</span>).fAB(<span class="number">123</span>).build();</div><div class="line">		System.out.println(f.getF1());</div><div class="line">		System.out.println(f.getFABs().size());</div><div class="line"></div><div class="line">		G g = G.GBuilder().buildG();</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Builder</span> <span class="class"><span class="keyword">class</span> <span class="title">F</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Getter</span> <span class="keyword">private</span> String f1;</div><div class="line"></div><div class="line">	<span class="meta">@Singular</span> <span class="meta">@Getter</span> <span class="keyword">private</span> Set&lt;Integer&gt; fABs;</div><div class="line">	<span class="meta">@Singular</span> <span class="meta">@Getter</span> <span class="keyword">private</span> Set&lt;Integer&gt; fAsBs;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Builder</span>(builderClassName = <span class="string">"GBuilder"</span>, buildMethodName = <span class="string">"buildG"</span>, builderMethodName = <span class="string">"GBuilder"</span>)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">G</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printG</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"GGG"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用<code>@Singular</code>注解的集合属性名必须使用<code>s</code>结尾, lombok会将属性名结尾的<code>s</code>去掉,剩余的名字会作为方法名, 向这个集合中添加元素</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/12/09/JavaLibrary/lombok/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/12/09/JavaLibrary/lombok/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/09/JavaLibrary/mybatis-guice/" title="Guice Mybatis 使用笔记" itemprop="url">Guice Mybatis 使用笔记</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2015-12-08T16:00:00.000Z" itemprop="datePublished"> 发表于 2015-12-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>参考文档<a href="http://mybatis.org/guice/index.html" target="_blank" rel="external">mybatis-guice</a></p>
<p>mybatis-guice需要依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.inject<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guice<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-guice<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.inject.extensions<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guice-multibindings<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.37<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>表结构<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user`</span> (</div><div class="line">  <span class="string">`userId`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span></div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</div></pre></td></tr></table></figure></p>
<p>我们首先定义使用到的model类和mapper类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> String userId;</div><div class="line">    <span class="keyword">public</span> String name;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</div><div class="line">    <span class="meta">@Select</span>(<span class="string">"SELECT * FROM user WHERE userId = #&#123;userId&#125;"</span>)</div><div class="line">    <span class="function">User <span class="title">getUser</span><span class="params">(@Param(<span class="string">"userId"</span>)</span> String userId)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后我们实现Guice对Mybatis的注解管理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySqlManager</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Injector injector;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        injector = Guice.createInjector(JdbcHelper.MySQL, <span class="keyword">new</span> MysqlModule());</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MySqlManager</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getInstance</span><span class="params">(Class&lt;T&gt; var1)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> injector.getInstance(var1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MysqlModule</span> <span class="keyword">extends</span> <span class="title">MyBatisModule</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</div><div class="line">            bindDataSourceProviderType(PooledDataSourceProvider.class);</div><div class="line">            bindTransactionFactoryType(JdbcTransactionFactory.class);</div><div class="line">            Names.bindProperties(binder(), createUnpooledProperties());</div><div class="line"></div><div class="line">            addMapperClass();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 添加映射类</span></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addMapperClass</span><span class="params">()</span> </span>&#123;</div><div class="line">            addMapperClass(UserMapper.class);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> Properties <span class="title">createUnpooledProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">            Properties myBatisProperties = <span class="keyword">new</span> Properties();</div><div class="line">            myBatisProperties.setProperty(<span class="string">"mybatis.environment.id"</span>, <span class="string">"test"</span>);</div><div class="line">            myBatisProperties.setProperty(<span class="string">"JDBC.schema"</span>, <span class="string">"test"</span>);</div><div class="line"><span class="comment">//			myBatisProperties.setProperty("JDBC.url", "localhost");</span></div><div class="line"><span class="comment">//			myBatisProperties.setProperty("JDBC.driver", "");</span></div><div class="line">            myBatisProperties.setProperty(<span class="string">"JDBC.username"</span>, <span class="string">"root"</span>);</div><div class="line">            myBatisProperties.setProperty(<span class="string">"JDBC.password"</span>, <span class="string">"root"</span>);</div><div class="line">            myBatisProperties.setProperty(<span class="string">"JDBC.loginTimeout"</span>, <span class="string">"10"</span>);</div><div class="line">            myBatisProperties.setProperty(<span class="string">"JDBC.autoCommit"</span>, <span class="string">"false"</span>);</div><div class="line">            myBatisProperties.setProperty(<span class="string">"derby.create"</span>, <span class="string">"true"</span>);</div><div class="line">            <span class="keyword">return</span> myBatisProperties;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后我们写一个测试类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GettingStarted</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        UserMapper user = MySqlManager.getInstance(UserMapper.class);</div><div class="line">        User user1 = user.getUser(<span class="string">"1"</span>);</div><div class="line">        System.out.println(user1.name);</div><div class="line">		</div><div class="line">		UserMapper userMapper = <span class="keyword">new</span> UserMapper();</div><div class="line">		injector.injectMembers(userMapper);</div><div class="line">		System.out.println(userMapper.name);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>MyBatisModule</code>还为我们提供了下述功能的接口</p>
<ul>
<li>添加自己的拦截器 : <code>addInterceptorClass(MySqlInterceptor.class);</code></li>
<li>添加自己的类型转换器 : <code>handleType()</code></li>
<li>添加别名 : <code>addSimpleAlias(User.class);</code>或者<code>addAlias(&quot;AUser&quot;).to(User.class);</code></li>
</ul>
<h2 id="开启事务"><a href="#开启事务" class="headerlink" title="开启事务"></a>开启事务</h2><p>我们在<code>FooServiceMapperImpl</code>中还能定义开启事务<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 开启事务</span></div><div class="line"><span class="meta">@Transactional</span>(</div><div class="line">        executorType = ExecutorType.BATCH,</div><div class="line">        isolation = Isolation.READ_UNCOMMITTED,</div><div class="line"><span class="comment">//		rethrowExceptionsAs = MyDaoException.class,</span></div><div class="line">        exceptionMessage = <span class="string">"Something went wrong"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(String userId)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.userMapper.getUser(userId);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="定义自己的连接池"><a href="#定义自己的连接池" class="headerlink" title="定义自己的连接池"></a>定义自己的连接池</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addPooledProperties</span><span class="params">(Binder binder)</span> </span>&#123;</div><div class="line">    <span class="comment">// 连接池并发访问数据的连接数, 默认为10</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"mybatis.pooled.maximumActiveConnections"</span>)).to(<span class="number">10</span>);</div><div class="line">    <span class="comment">// 在被强制返回之前，池中连接被检查的时间</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"mybatis.pooled.maximumCheckoutTime"</span>)).to(<span class="number">20000</span>);</div><div class="line">    <span class="comment">// 连接池里空闲连接数, 默认为5</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"mybatis.pooled.maximumIdleConnections"</span>)).to(<span class="number">5</span>);</div><div class="line">    <span class="comment">// 由于数据库会检查连接达到8小时(默认值)闲置会单方面断开连接, 而客户端如果继续使用已经断开的连接,则会产生异常.</span></div><div class="line">    <span class="comment">// mybatis里内带了ping机制, 设置该值为true的话, 就开启了ping机制</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"mybatis.pooled.pingEnabled"</span>)).to(<span class="keyword">false</span>);</div><div class="line">    <span class="comment">// 设置空闲连接ping时间间隔, 如果超时就进行ping,查看连接是否有效</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"mybatis.pooled.pingConnectionsNotUsedFor"</span>)).to(<span class="number">3600000</span>);</div><div class="line">    <span class="comment">// 执行ping时执行的语句</span></div><div class="line">	<span class="comment">//	binder.bindConstant().annotatedWith(Names.named("mybatis.pooled.pingQuery")).to("");</span></div><div class="line">    <span class="comment">// 这是一个低层设置，如果获取连接花费的相当长的时间，它会给连接池打印日志并重新尝试获取一个连接的机会（避免在误配置的情况下一直安静的失败），默认值：20000 毫秒（即 20 秒）。</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"mybatis.pooled.timeToWait"</span>)).to(<span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addC3P0Properties</span><span class="params">(Binder binder)</span> </span>&#123;</div><div class="line">    <span class="comment">// 当连接池中的的连接耗尽的时候c3p0一次同时获取的连接数，但是池中最大数不会超过maxPoolSize</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.acquireIncrement"</span>)).to(<span class="number">1</span>);</div><div class="line">    <span class="comment">// 从数据库请求连接失败之后,尝试的次数</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.acquireRetryAttempts"</span>)).to(<span class="number">1</span>);</div><div class="line">    <span class="comment">// 连接池耗尽, 连续获得俩个连接直接的间隔时间. 单位ms</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.acquireRetryDelay"</span>)).to(<span class="number">1000</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.automaticTestTable"</span>)).to(<span class="string">"test"</span>);</div><div class="line">    <span class="comment">// 如果为true，则当连接获取失败时自动关闭数据源</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.breakAfterAcquireFailure"</span>)).to(<span class="keyword">false</span>);</div><div class="line">    <span class="comment">// 连接池所有连接耗尽时,应用程序获得新的连接的等待时间. 为0则无限等待直至有其他连接释放或者创建新的连接，</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.checkoutTimeout"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.connectionCustomizerClassName"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.connectionTesterClassName"</span>)).to(<span class="number">1</span>);</div><div class="line">    <span class="comment">// 检查所有连接池中的空闲连接的时间间隔, 单位秒</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.idleConnectionTestPeriod"</span>)).to(<span class="number">900</span>);</div><div class="line">    <span class="comment">// 连接池初始化时创建的连接数,default : 3</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.initialPoolSize"</span>)).to(<span class="number">3</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.maxAdministrativeTaskTime"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.maxConnectionAge"</span>)).to(<span class="number">1</span>);</div><div class="line">    <span class="comment">// 池中连接最大空闲时长,如果超时则断开这个连接. 单位是秒</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.maxIdleTime"</span>)).to(<span class="number">600</span>);</div><div class="line"></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.maxIdleTimeExcessConnections"</span>)).to(<span class="number">1</span>);</div><div class="line">    <span class="comment">// 接池中拥有的最大连接数，如果获得新连接时会使连接总数超过这个值则不会再获取新连接，而是等待其他连接释放</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.maxPoolSize"</span>)).to(<span class="number">15</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.maxStatements"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.maxStatementsPerConnection"</span>)).to(<span class="number">1</span>);</div><div class="line">    <span class="comment">// 连接池保持的最小连接数</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.minPoolSize"</span>)).to(<span class="number">3</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.preferredTestQuery"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.propertyCycle"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.testConnectionOnCheckin"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.testConnectionOnCheckout"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.unreturnedConnectionTimeout"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.usesTraditionalReflectiveProxies"</span>)).to(<span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们还可以采用配置文件的方式设置<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.mybatis.guice.XMLMyBatisModule;</div><div class="line"><span class="keyword">import</span> org.mybatis.guice.datasource.helper.JdbcHelper;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.inject.Guice;</div><div class="line"><span class="keyword">import</span> com.google.inject.Injector;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisManager</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Injector injector;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        injector = Guice.createInjector(JdbcHelper.MySQL, <span class="keyword">new</span> MysqlModule());</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MybatisManager</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getInstance</span><span class="params">(Class&lt;T&gt; var1)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> injector.getInstance(var1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MysqlModule</span> <span class="keyword">extends</span> <span class="title">XMLMyBatisModule</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</div><div class="line">            setClassPathResource(<span class="string">"configuration.xml"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/12/09/JavaLibrary/mybatis-guice/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/12/09/JavaLibrary/mybatis-guice/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/08/JavaLibrary/guice/" title="Guice 笔记" itemprop="url">Guice 笔记</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2015-12-07T16:00:00.000Z" itemprop="datePublished"> 发表于 2015-12-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>Google Guice 是一个轻量级的依赖注入框架</p>
<p>在Guice的依赖注入中我们使用如下API进行注入</p>
<ul>
<li><code>Binder</code></li>
<li><code>Injector</code></li>
<li><code>Module</code></li>
<li><code>Guice</code><br>直接看例子<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CarModule</span> <span class="keyword">implements</span> <span class="title">Module</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Binder binder)</span> </span>&#123;</div><div class="line">		binder.bind(Car.class).to(Benci.class);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Car</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Benci</span> <span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"Benci Run"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>测试代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Injector injector = Guice.createInjector(<span class="keyword">new</span> CarModule());</div><div class="line">Car benci = injector.getInstance(Car.class);</div><div class="line">benci.run();</div></pre></td></tr></table></figure></p>
<h2 id="ImplementedBy"><a href="#ImplementedBy" class="headerlink" title="ImplementedBy"></a>ImplementedBy</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LunYu</span> <span class="keyword">implements</span> <span class="title">Book</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">content</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"Lunyu"</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@ImplementedBy</span>(LunYu.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Book</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">content</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadBook</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readLunyu</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(book.content());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="keyword">private</span> Book book;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Injector intjector = Guice.createInjector();</div><div class="line">Book lunyu = intjector.getInstance(Book.class);</div><div class="line">System.out.println(lunyu.content());</div></pre></td></tr></table></figure></p>
<h2 id="Inject"><a href="#Inject" class="headerlink" title="Inject"></a>Inject</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Man</span> <span class="keyword">implements</span> <span class="title">People</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"Tom"</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">People</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PeopleModule</span> <span class="keyword">implements</span> <span class="title">Module</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Binder binder)</span> </span>&#123;</div><div class="line">		binder.bind(People.class).to(Man.class);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrintName</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(man.name());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="keyword">private</span> People man;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Injector intjector = Guice.createInjector(<span class="keyword">new</span> PeopleModule());</div><div class="line">PrintName pn = intjector.getInstance(PrintName.class);</div><div class="line">pn.print();</div></pre></td></tr></table></figure></p>
<h2 id="Scopes"><a href="#Scopes" class="headerlink" title="Scopes"></a>Scopes</h2><p>默认的,Guice每次在<code>getInstance()</code>的时候都会返回一个新的对象.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestScopes</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		AbstractModule module1 = <span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				bind(A.class);</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		Injector injector = Guice.createInjector(module1);</div><div class="line">		A a = injector.getInstance(A.class);</div><div class="line">		A b = injector.getInstance(A.class);</div><div class="line">		System.out.println(a.equals(b));</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"A"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出结果为false, 但是我们可以使用Singleton注解采用单例方式创建全局唯一的对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSingleton</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				bind(A.class).to(B.class);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		A b1 = injector.getInstance(A.class);</div><div class="line">		A b2 = injector.getInstance(A.class);</div><div class="line">		System.out.println(b1 == b2);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Singleton</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出结果为<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">true</div></pre></td></tr></table></figure></p>
<p>我们使用<code>Singleton</code>注解可以得到一个全局唯一的B实例, 每次注解B实例时, 都是同一个实例.</p>
<p>另外,我们还可以在绑定的时候进行设置<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ABCModule</span> <span class="keyword">extends</span> <span class="title">AbstractModule</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">		bind(A.class).to(B.class).in(Singleton.class);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="注入"><a href="#注入" class="headerlink" title="注入"></a>注入</h2><h2 id="构造器注入"><a href="#构造器注入" class="headerlink" title="构造器注入"></a>构造器注入</h2><p>对构造器进行注入<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestInject</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				<span class="comment">// A类型的变量都使用B的实例值进行注入. 也就是说当我们对A类型的变量注入值的时候, 其实注入的是B类型</span></div><div class="line">				<span class="comment">// B一定要继承A或者实现A接口</span></div><div class="line">				bind(A.class).to(B.class);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		</div><div class="line">		Print print = injector.getInstance(Print.class);</div><div class="line">		print.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"A"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span></span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> A a;</div><div class="line"></div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	Print(A a) &#123;</div><div class="line">		<span class="keyword">this</span>.a = a;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		a.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出结果为B, 注入成功</p>
<h2 id="方法参数注入"><a href="#方法参数注入" class="headerlink" title="方法参数注入"></a>方法参数注入</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestInject</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> ABCModule());</div><div class="line">		Print print = injector.getInstance(Print.class);</div><div class="line">		print.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> A a;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setA</span><span class="params">(A a)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.a = a;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		a.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果同样是B</p>
<h2 id="方法注入"><a href="#方法注入" class="headerlink" title="方法注入"></a>方法注入</h2><p>当一个方法使用<code>Inject</code>注解时, 如果getInstance该类的实例就会调用该方法一次<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestStaticInjection</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		Print b1 = injector.getInstance(Print.class);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"Hello world"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="成员属性注入"><a href="#成员属性注入" class="headerlink" title="成员属性注入"></a>成员属性注入</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestInject</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> ABCModule());</div><div class="line">		Print print = injector.getInstance(Print.class);</div><div class="line">		print.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="keyword">private</span> A a;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		a.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ABCModule</span> <span class="keyword">extends</span> <span class="title">AbstractModule</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">		bind(A.class).to(B.class);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Guice会对被<code>Inject</code>注解过的属性赋值</p>
<h2 id="Optional-Injections"><a href="#Optional-Injections" class="headerlink" title="Optional Injections"></a>Optional Injections</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestInject</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> ABCModule());</div><div class="line">		Print print = injector.getInstance(Print.class);</div><div class="line">		print.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="meta">@Inject</span>(optional=<span class="keyword">true</span>)</div><div class="line">	<span class="keyword">private</span> A a;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		a.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ABCModule</span> <span class="keyword">extends</span> <span class="title">AbstractModule</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="comment">//		bind(A.class).to(B.class);</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果我将要被<code>Inject</code>注解的属性设置为<code>optional=true</code>的话,当我注释掉绑定代码,在运行代码时会产生一个空指针异常,这是因为当找不到绑定的时候,就不进行注解<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java<span class="selector-class">.lang</span><span class="selector-class">.NullPointerException</span></div></pre></td></tr></table></figure></p>
<p>但是如果我将<code>Inject</code>注解的属性设置为<code>optional=false</code>的话,在运行代码会产生<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Exception in thread <span class="string">"main"</span> com.google.inject.ConfigurationException: Guice configuration errors:</div><div class="line"></div><div class="line"><span class="number">1</span>) No implementation <span class="keyword">for</span> guice.A was bound.</div><div class="line">  <span class="keyword">while</span> locating guice.A</div><div class="line">    <span class="keyword">for</span> field at guice.Print.a(TestInject.java:<span class="number">37</span>)</div><div class="line">  <span class="keyword">while</span> locating guice.Print</div></pre></td></tr></table></figure></p>
<p>说明如果可选值如果是false的话就必须对其进行绑定</p>
<h2 id="静态属性注入"><a href="#静态属性注入" class="headerlink" title="静态属性注入"></a>静态属性注入</h2><p>对类中的静态字段进行注入<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestStaticInjection</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				requestStaticInjection(Print.class);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		Print b1 = injector.getInstance(Print.class);</div><div class="line">		b1.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"A"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> A a;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		a.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是我们应该避免静态属性注入</p>
<h2 id="绑定"><a href="#绑定" class="headerlink" title="绑定"></a>绑定</h2><h3 id="单绑定"><a href="#单绑定" class="headerlink" title="单绑定"></a>单绑定</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestBindings</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				bind(BindingA.class);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		BindingA a = injector.getInstance(BindingA.class);</div><div class="line">		a.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BindingA</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"A"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果为<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">A</div></pre></td></tr></table></figure></p>
<p>我们可以将<code>BindingA</code>绑定到Guice里, 当我们getInstance时会直接获得该实例</p>
<blockquote>
<p>注意如果单邦定时, BindingA必须为class, 如果为接口的话会产生No implementation for testGuice.BindingA was bound.异常</p>
<p>参考@ImplementedBy or @ProvidedBy</p>
</blockquote>
<h3 id="链式绑定"><a href="#链式绑定" class="headerlink" title="链式绑定"></a>链式绑定</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestBindings</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				bind(BindingA.class).to(BindingB.class);</div><div class="line">				bind(BindingB.class).to(BindingC.class);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line"></div><div class="line">		BindingC c = injector.getInstance(BindingC.class);</div><div class="line">		c.print();</div><div class="line">		BindingB b = injector.getInstance(BindingB.class);</div><div class="line">		b.print();</div><div class="line">		BindingA a = injector.getInstance(BindingA.class);</div><div class="line">		a.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BindingA</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"A"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BindingB</span> <span class="keyword">extends</span> <span class="title">BindingA</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BindingC</span> <span class="keyword">extends</span> <span class="title">BindingB</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"c"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码的最后调用结果都是<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">c</div><div class="line">c</div><div class="line">c</div></pre></td></tr></table></figure></p>
<p>这就是Guice的Linked Bindings, 当binding形成一条链之后,会以最终的绑定为最终绑定</p>
<blockquote>
<p>注意绑定关系必须是继承关系</p>
</blockquote>
<h3 id="命名绑定"><a href="#命名绑定" class="headerlink" title="命名绑定"></a>命名绑定</h3><p>这种特性是为了,当某个接口有多种实现时,我们可以通过<code>@Named</code>指定我们具体使用哪种实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestNamedBindings</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				bind(A.class).annotatedWith(Names.named(<span class="string">"BType"</span>)).to(B.class);</div><div class="line">				bind(A.class).annotatedWith(Names.named(<span class="string">"CType"</span>)).to(C.class);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		Print print = injector.getInstance(Print.class);</div><div class="line">		print.printB();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"C"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printB</span><span class="params">()</span> </span>&#123;</div><div class="line">		b.print();</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printC</span><span class="params">()</span> </span>&#123;</div><div class="line">		c.print();</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="meta">@Named</span>(<span class="string">"BType"</span>)</div><div class="line">	<span class="keyword">private</span> A b;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="meta">@Named</span>(<span class="string">"CType"</span>)</div><div class="line">	<span class="keyword">private</span> A c;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出结果为<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">B</div><div class="line">C</div><div class="line">B</div></pre></td></tr></table></figure></p>
<p>我们还可以使用<code>BindingAnnotation</code>来实现相同的功能<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestNamedBindings</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				bind(A.class).annotatedWith(BType.class).to(B.class);</div><div class="line">				bind(A.class).annotatedWith(CType.class).to(C.class);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		Print print = injector.getInstance(Print.class);</div><div class="line">		print.printB();</div><div class="line">		print.printC();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"C"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@BindingAnnotation</span></div><div class="line"><span class="meta">@Target</span>(&#123; FIELD, PARAMETER, METHOD &#125;) <span class="meta">@Retention</span>(RUNTIME)</div><div class="line"><span class="meta">@interface</span> BType &#123;&#125;</div><div class="line"></div><div class="line"><span class="meta">@BindingAnnotation</span></div><div class="line"><span class="meta">@Target</span>(&#123; FIELD, PARAMETER, METHOD &#125;) <span class="meta">@Retention</span>(RUNTIME)</div><div class="line"><span class="meta">@interface</span> CType &#123;&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printB</span><span class="params">()</span> </span>&#123;</div><div class="line">		b.print();</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printC</span><span class="params">()</span> </span>&#123;</div><div class="line">		c.print();</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="meta">@BType</span></div><div class="line">	<span class="keyword">private</span> A b;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="meta">@CType</span></div><div class="line">	<span class="keyword">private</span> A c;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="多模块绑定"><a href="#多模块绑定" class="headerlink" title="多模块绑定"></a>多模块绑定</h3><p>我们可以在不同的模块里绑定实现不同的绑定<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMultipleModules</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		AbstractModule module1 = <span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				bind(A.class).to(B.class);</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line"></div><div class="line">		AbstractModule module2 = <span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				bind(B.class).to(C.class);</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		Injector injector = Guice.createInjector(module1, module2);</div><div class="line">		A a = injector.getInstance(A.class);</div><div class="line">		B b = injector.getInstance(B.class);</div><div class="line">		a.print();</div><div class="line">		b.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"A"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">extends</span> <span class="title">B</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"C"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="keyword">private</span> A a;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		a.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">C</div><div class="line">C</div></pre></td></tr></table></figure></p>
<blockquote>
<p>module1和module2里对A只能进行相同的绑定,也就是说即使在不同的module里也不能即A绑定到B又绑定到C</p>
</blockquote>
<h3 id="Provides绑定"><a href="#Provides绑定" class="headerlink" title="Provides绑定"></a>Provides绑定</h3><p>我们可以使用<code>Provides</code>注解替代<code>configure()</code>实现的绑定.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestProvidesMethods</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="meta">@Provides</span></div><div class="line">			<span class="function"><span class="keyword">public</span> A <span class="title">provideA</span><span class="params">()</span> </span>&#123;</div><div class="line">				B b = <span class="keyword">new</span> B();</div><div class="line">				<span class="keyword">return</span> b;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		A print = injector.getInstance(A.class);</div><div class="line">		print.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"A"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们在module实现里添加了<code>@Provides</code>注释, 当我们在测试代码里要获取某种类型的对象的时候, Guice会根据返回某种类型的方法调用.</p>
<blockquote>
<p><code>@Provides</code>注释下的名字可以是任意的. 但是我们还是建议采用provideXXX的形式</p>
</blockquote>
<p>需要注意的是, 返回的类型必须是唯一的, 如果我们添加下面的代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="title">implementsA</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"c"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Provides</span></div><div class="line"><span class="function"><span class="keyword">public</span> A <span class="title">provideC</span><span class="params">()</span> </span>&#123;</div><div class="line">	C b = <span class="keyword">new</span> C();</div><div class="line">	<span class="keyword">return</span> b;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>guice会产生异常<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Exception in thread <span class="string">"main"</span> com.google.inject.CreationException: Unable to create injector, see the following errors:</div><div class="line"></div><div class="line"><span class="number">1</span>) A binding to guice.A was already configured at guice.ABCModule.provideA().</div></pre></td></tr></table></figure></p>
<p>还有一点需要注意的是,如果<code>@Provides</code>已经使用过某种类型,那么在<code>config()</code>方法里就不能再次使用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">	bind(A.class).to(C.class);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>同样会产生异常<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Exception in thread <span class="string">"main"</span> com.google.inject.CreationException: Unable to create injector, see the following errors:</div><div class="line"></div><div class="line"><span class="number">1</span>) A binding to guice.A was already configured at guice.ABCModule.provideA().</div></pre></td></tr></table></figure></p>
<p>如果我们的<code>provide</code>方法很复杂,我们可以将其抽取到一个类里<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestLinkedBindings</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> ABCModule());</div><div class="line">		A print = injector.getInstance(A.class);</div><div class="line">		print.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BProvider</span> <span class="keyword">implements</span> <span class="title">Provider</span>&lt;<span class="title">A</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> A <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> B();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ABCModule</span> <span class="keyword">extends</span> <span class="title">AbstractModule</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">		bind(A.class).toProvider(BProvider.class);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Guice/">Guice</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/12/08/JavaLibrary/guice/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/12/08/JavaLibrary/guice/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/24/jvm/instrument/" title="Instrumentation" itemprop="url">Instrumentation</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2015-11-23T16:00:00.000Z" itemprop="datePublished"> 发表于 2015-11-24</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>利用 <code>java.lang.instrument</code> 做动态 Instrumentation 是 Java SE 5 的新特性, 它把 Java 的 instrument 功能从本地代码中解放出来,使之可以用 Java 代码的方式解决问题.</p>
<p>使用 Instrumentation,开发者可以构建一个独立于应用程序的代理程序(Agent),用来监测和协助运行在 JVM 上的程序,甚至能够替换和修改某些类的定义.有了这样的功能,开发者就可以实现更为灵活的运行时虚拟机监控和 Java 类操作了,这样的特性实际上提供了一种虚拟机级别支持的 AOP 实现方式,使得开发者无需对 JDK 做任何升级和改动,就可以实现某些 AOP 的功能了.</p>
<p>在 Java SE 6 里面,instrumentation 包被赋予了更强大的功能：启动后的 instrument、本地代码(native code)instrument,以及动态改变 classpath 等等.这些改变,意味着 Java 具有了更强的动态控制、解释能力,它使得 Java 语言变得更加灵活多变.</p>
<p>在 Java SE6 里面,最大的改变使运行时的 Instrumentation 成为可能.在 Java SE 5 中,Instrument 要求在运行前利用命令行参数或者系统参数来设置代理类,在实际的运行之中,虚拟机在初始化之时(在绝大多数的 Java 类库被载入之前),instrumentation 的设置已经启动,并在虚拟机中设置了回调函数,检测特定类的加载情况,并完成实际工作.但是在实际的很多的情况下,我们没有办法在虚拟机启动之时就为其设定代理,这样实际上限制了 instrument 的应用.而 Java SE 6 的新特性改变了这种情况,通过 Java Tool API 中的 attach 方式,我们可以很方便地在运行过程中动态地设置加载代理类,以达到 instrumentation 的目的.</p>
<p>另外,对 native 的 Instrumentation 也是 Java SE 6 的一个崭新的功能,这使以前无法完成的功能 —— 对 native 接口的 instrumentation 可以在 Java SE 6 中,通过一个或者一系列的 prefix 添加而得以完成.<br>最后,Java SE 6 里的 Instrumentation 也增加了动态添加 class path 的功能.所有这些新的功能,都使得 instrument 包的功能更加丰富,从而使 Java 语言本身更加强大.</p>
<p><code>java.lang.instrument</code>包的具体实现,依赖于 JVMTI. JVMTI(Java Virtual Machine Tool Interface)是一套由 Java 虚拟机提供的,为 JVM 相关的工具提供的本地编程接口集合. JVMTI 是从 Java SE 5 开始引入,整合和取代了以前使用的 Java Virtual Machine Profiler Interface (JVMPI) 和 the Java Virtual Machine Debug Interface (JVMDI),而在 Java SE 6 中,JVMPI 和 JVMDI 已经消失了.JVMTI 提供了一套”代理”程序机制,可以支持第三方工具程序以代理的方式连接和访问 JVM,并利用 JVMTI 提供的丰富的编程接口,完成很多跟 JVM 相关的功能.事实上,java.lang.instrument 包的实现,也就是基于这种机制的：在 Instrumentation 的实现当中,存在一个 JVMTI 的代理程序,通过调用 JVMTI 当中 Java 类相关的函数来完成 Java 类的动态操作.除开 Instrumentation 功能外,JVMTI 还在虚拟机内存管理,线程控制,方法和变量操作等等方面提供了大量有价值的函数.关于 JVMTI 的详细信息,请参考 Java SE 6 文档(请参见 参考资源)当中的介绍.<br>Instrumentation 的最大作用,就是类定义动态改变和操作.在 Java SE 5 及其后续版本当中,开发者可以在一个普通 Java 程序(带有 main 函数的 Java 类)运行时,通过 – javaagent参数指定一个特定的 jar 文件(包含 Instrumentation 代理)来启动 Instrumentation 的代理程序.</p>
<p>使用 Instrumentation,开发者可以构建一个独立于应用程序的代理程序(Agent),用来监测和协助运行在 JVM 上的程序,甚至能够替换和修改某些类的定义.</p>
<p>Instrumentation提供了这样的功能：</p>
<ul>
<li>获取某个对象的大小</li>
<li>热加载class文件</li>
<li>获取JVM信息</li>
</ul>
<blockquote>
<p>要知道一个对象所使用的内存量,需要将所有实例变量使用的内存和对象本身的开销(一般是16字节)相加.这些开销包括一个指向对象的类的引用,垃圾收集信息和同步信息.另外一般内存的使用会被填充为8字节的倍数.</p>
</blockquote>
<h2 id="Premain"><a href="#Premain" class="headerlink" title="Premain"></a>Premain</h2><p>premain函数是JavaSE5中实现instrument的方式.</p>
<p>使用premain我们要自定义MANIFEST.MF文件, 定义Premain-Class<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Manifest-Version: <span class="number">1.0</span></div><div class="line">Premain-Class: wang.yu66.instrument.core.Premain</div></pre></td></tr></table></figure></p>
<p>然后我们在maven文件中输出该文件<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">archive</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">manifestFile</span>&gt;</span></div><div class="line">                        src/main/resources/META-INF/MANIFEST.MF</div><div class="line">                    <span class="tag">&lt;/<span class="name">manifestFile</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">addClasspath</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addClasspath</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">classpathPrefix</span>&gt;</span>lib/<span class="tag">&lt;/<span class="name">classpathPrefix</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="获取对象大小"><a href="#获取对象大小" class="headerlink" title="获取对象大小"></a>获取对象大小</h4><p>首先我们要写一个代理文件出来(该文件放在<code>core-1.0-SNAPSHOT.jar</code>中)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Premain</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Instrumentation instrumentation;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span> </span>&#123;</div><div class="line">		instrumentation = inst;</div><div class="line">	&#125;;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Instrumentation <span class="title">getInstrumentation</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> instrumentation;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后在自己的应用程序中引用该文件(在<code>examples-1.0-SNAPSHOT.jar</code>中)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrintObjectSize</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"Hello world, App"</span>);</div><div class="line"></div><div class="line">		objectSize();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">objectSize</span><span class="params">()</span> </span>&#123;</div><div class="line">		Instrumentation inst = Premain.getInstrumentation();</div><div class="line">		String str = <span class="string">"123456789"</span>;</div><div class="line">		<span class="keyword">long</span> size = inst.getObjectSize(str);</div><div class="line">		System.out.println(str + <span class="string">" 对象大小: "</span> + size);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后执行命令<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -javaagent:../instrument/target/core-<span class="number">1.0</span>-SNAPSHOT.jar -cp ./target/examples-<span class="number">1.0</span>-SNAPSHOT.jar wang.yu66.instrument.examples.PrintObjectSize</div></pre></td></tr></table></figure></p>
<p>然后就会获得对象的大小<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Hello world, App</div><div class="line"><span class="number">123456789</span> 对象大小: <span class="number">24</span></div></pre></td></tr></table></figure></p>
<h4 id="加载jar包"><a href="#加载jar包" class="headerlink" title="加载jar包"></a>加载jar包</h4><p>我们在Premain类中增加一个动态向系统cp加载jar的功能<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendJarToSystemClassLoader</span><span class="params">(String path)</span> </span>&#123;</div><div class="line">	JarFile jarFile = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		jarFile = <span class="keyword">new</span> JarFile(path);</div><div class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;</div><div class="line">	instrumentation.appendToSystemClassLoaderSearch(jarFile);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendJarToBootstrapClassLoader</span><span class="params">(Instrumentation inst, String path)</span> </span>&#123;</div><div class="line">	JarFile jarFile = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		jarFile = <span class="keyword">new</span> JarFile(path);</div><div class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;</div><div class="line">	inst.appendToBootstrapClassLoaderSearch(jarFile);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后我们写一个测试类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJarLoader</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">120</span>; i++) &#123;</div><div class="line">			Premain.appendJarToSystemClassLoader(args[<span class="number">0</span>]);</div><div class="line">			Print.print();</div><div class="line"></div><div class="line">			Stream.of(Premain.getInstrumentation().getAllLoadedClasses())</div><div class="line">					.filter(clazz -&gt; clazz.getName().contains(<span class="string">"Print"</span>))</div><div class="line">					.forEach(aClass -&gt; System.out.println(aClass.getName() + <span class="string">"  "</span> + aClass.getMethods().length));</div><div class="line"></div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				TimeUnit.SECONDS.sleep(<span class="number">5</span>);</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后执行命令<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -javaagent:../instrument/target/core-<span class="number">1.0</span>-SNAPSHOT.jar -cp ./target/examples-<span class="number">1.0</span>-SNAPSHOT.jar wang.yu66.instrument.examples.TestJarLoader D:/workspace/idea/instrument/trunk/print/target/print-<span class="number">1.0</span>-SNAPSHOT.jar</div></pre></td></tr></table></figure></p>
<p>结果输出为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Now Time is Thu Dec <span class="number">31</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">39</span> CST <span class="number">2015</span></div><div class="line"></div><div class="line">wang.yu66.instrument.print.Print  <span class="number">11</span></div><div class="line">java.io.PrintStream  <span class="number">44</span></div><div class="line">Now Time is Thu Dec <span class="number">31</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">44</span> CST <span class="number">2015</span></div><div class="line"></div><div class="line">wang.yu66.instrument.print.Print  <span class="number">11</span></div><div class="line">java.io.PrintStream  <span class="number">44</span></div></pre></td></tr></table></figure></p>
<h4 id="热加载"><a href="#热加载" class="headerlink" title="热加载"></a>热加载</h4><ul>
<li><code>redefineClasses()</code>使用新的字节码全部替换原先存在的Class字节码. (它并不会触发初始化操作, 也不会抛出初始化时的异常. 因此一些静态属性并不会被重新赋值)</li>
<li><code>retransformClasses()</code> 修改原先存在的Class字节码.</li>
</ul>
<blockquote>
<p>对于已经在栈帧中的字节码, 他们会继续执行下去, 但是当方法再次调用的时候,则会使用刚刚加载完成的新的字节码. 在重新加载类的时候, 该类已经实例化出的对象同时也不会受到影响.</p>
</blockquote>
<p>该方法的操作过程是一个基于操作集合的, 也就是说在redefine的时候, 可能有A B俩个类都进行, 而且A依赖于B, 那么在redefine的时候这俩个操作是同时完成的, 类似于原子操作.</p>
<p>redefine 操作可以改变修改如下字节码</p>
<ul>
<li>方法体</li>
<li>常量池</li>
<li>属性<br>但是redefine过程不能产生如下影响</li>
<li>对方法进行增加,删除,重命名的操作</li>
<li>对属性进行增加,删除,重命名的操作</li>
<li>不能修改方法签名以及修改继承关系.</li>
</ul>
<p>在redefine过程中,一旦抛出异常, 那么此过程执已经redefine成功的class也会被会滚成原来的.</p>
<p>想使用这个功能我们需要在MANIFEST.MF文件中增加这样一行<code>Can-Redefine-Classes: true</code>, 然后我们在Premain中增加一个load方法, 用于重新加载某个文件夹下所有的文件<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.*;</div><div class="line"><span class="keyword">import</span> java.lang.instrument.ClassDefinition;</div><div class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</div><div class="line"><span class="keyword">import</span> java.security.MessageDigest;</div><div class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</div><div class="line"><span class="keyword">import</span> java.util.zip.ZipEntry;</div><div class="line"><span class="keyword">import</span> java.util.zip.ZipFile;</div><div class="line"><span class="keyword">import</span> java.util.zip.ZipInputStream;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 实现服务器局部代码热加载功能</div><div class="line"> *      目前只支持方法体代码热更以及对属性值的改变</div><div class="line"> *      但是不能修改类的继承结构, 不能修改方法签名, 不能增加删除方法以及属性成员</div><div class="line"> *</div><div class="line"> *  使用方法</div><div class="line"> *      java -javaagent:D:\premain\target\agent-1.0-SNAPSHOT.jar -cp .;./* MainServerStart</div><div class="line"> *      只需要将该项目打包出来然后参照上面的例子进行代理处理就好了, 然后正常启动游戏服就好</div><div class="line"> *</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Premain</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(Premain.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Instrumentation instrumentation;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span> </span>&#123;</div><div class="line">        instrumentation = inst;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> classSize = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 遍历某个目录加载所有的class文件</div><div class="line">     * <span class="doctag">@param</span> directionPath</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadFromDirection</span><span class="params">(String directionPath)</span> </span>&#123;</div><div class="line">        loadFromDirection(<span class="keyword">new</span> File(directionPath), <span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadFromDirection</span><span class="params">(File dir, String parantName)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">for</span> (File file : dir.listFiles()) &#123;</div><div class="line">                <span class="keyword">if</span> (file.isFile() &amp;&amp; !file.getName().endsWith(<span class="string">".class"</span>)) &#123;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (file.isDirectory()) &#123;</div><div class="line">                    String fileName = file.getName();</div><div class="line">                    <span class="keyword">if</span> (parantName != <span class="keyword">null</span> &amp;&amp; !parantName.equals(<span class="string">""</span>)) &#123;</div><div class="line">                        fileName = parantName + <span class="string">"."</span> + fileName;</div><div class="line">                    &#125;</div><div class="line">                    loadFromDirection(file, fileName);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">try</span>(InputStream input = <span class="keyword">new</span> FileInputStream(file);) &#123;</div><div class="line">                    String fileName = file.getPath();</div><div class="line">                    String className = findClassName(fileName);</div><div class="line">                    <span class="keyword">if</span> (parantName != <span class="keyword">null</span> &amp;&amp; !parantName.equals(<span class="string">""</span>)) &#123;</div><div class="line">                        className = parantName + <span class="string">"."</span> + className;</div><div class="line">                    &#125;</div><div class="line">                    redefineClassesFromBytes(input, className, <span class="keyword">null</span>);</div><div class="line">                &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 从jar包或者ZIP里加载所有的class文件</div><div class="line">     * <span class="doctag">@param</span> jarPath</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadFromZipFile</span><span class="params">(String jarPath, String prfixName)</span> </span>&#123;</div><div class="line">		Class[] allLoadClasses = instrumentation.getAllLoadedClasses();</div><div class="line">		Map&lt;String, Class&gt; allLoadClassesMap = <span class="keyword">new</span> HashMap&lt;&gt;(classSize);</div><div class="line">		<span class="keyword">for</span> (Class loadedClass : allLoadClasses) &#123;</div><div class="line">			<span class="keyword">if</span> (loadedClass.getName().startsWith(prfixName)) &#123;</div><div class="line">				allLoadClassesMap.put(loadedClass.getName(), loadedClass);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 加载的类我们不会主动去卸载它, 因此, 我们记录下来上次更新时的类的数量, 下次就根据这个数量直接分配, 避免动态扩容</span></div><div class="line">		classSize = allLoadClassesMap.size();</div><div class="line"></div><div class="line">		<span class="keyword">try</span>(InputStream in = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(jarPath)));</div><div class="line">            ZipInputStream zin = <span class="keyword">new</span> ZipInputStream(in);) &#123;</div><div class="line">            ZipEntry ze;</div><div class="line">            <span class="keyword">while</span> ((ze = zin.getNextEntry()) != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (ze.isDirectory()) &#123;</div><div class="line">                    <span class="comment">// TODO 检查是否还有其他操作要做</span></div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">long</span> size = ze.getSize();</div><div class="line">                    <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</div><div class="line">                        String fileName = ze.getName();</div><div class="line">                        <span class="keyword">if</span> (!fileName.endsWith(<span class="string">".class"</span>)) &#123;</div><div class="line">                            <span class="keyword">continue</span>;</div><div class="line">                        &#125;</div><div class="line">                        ZipFile zf = <span class="keyword">new</span> ZipFile(jarPath);</div><div class="line">                        InputStream input = zf.getInputStream(ze);</div><div class="line">                        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</div><div class="line">                            logger.error(<span class="string">"Code Reload cant find file : "</span> + fileName);</div><div class="line">                            <span class="keyword">continue</span>;</div><div class="line">                        &#125;</div><div class="line">                        redefineClassesFromBytes(input, fileName, allLoadClassesMap);</div><div class="line">                        input.close();</div><div class="line">                        zf.close();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">findClassName</span><span class="params">(String fileName)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> idx = fileName.lastIndexOf(<span class="string">"\\"</span>);</div><div class="line">        fileName = fileName.substring(idx + <span class="number">1</span>);</div><div class="line">        fileName = fileName.split(<span class="string">"\\.class"</span>)[<span class="number">0</span>];</div><div class="line">        <span class="keyword">return</span> fileName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* 使用instrumentation将读取的class byte数组加载进虚拟机</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">redefineClassesFromBytes</span><span class="params">(InputStream input, String fileName, Map&lt;String, Class&gt; allLoadClassesMap)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">        	String className = getClassName(fileName);</div><div class="line">            logger.info(<span class="string">"Start Hot Reload Class : "</span> + fileName + <span class="string">"  ("</span> + className + <span class="string">")"</span>);</div><div class="line">	        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[input.available()];</div><div class="line">    	    input.read(bytes);</div><div class="line">			Class loadedClass = allLoadClassesMap.get(className);</div><div class="line">			<span class="keyword">if</span> (loadedClass != <span class="keyword">null</span>) &#123;</div><div class="line">				instrumentation.redefineClasses(<span class="keyword">new</span> ClassDefinition(loadedClass, bytes));</div><div class="line">			&#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</div><div class="line">            logger.error(<span class="string">"Code Reload Failed : "</span> + fileName, e);</div><div class="line">        &#125; <span class="keyword">catch</span> (Error error) &#123;</div><div class="line">			logger.error(<span class="string">"Code Reload Failed : "</span> + fileName, error);</div><div class="line">		&#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getClassName</span><span class="params">(String fileName)</span> </span>&#123;</div><div class="line">        fileName = fileName.split(<span class="string">"\\.class"</span>)[<span class="number">0</span>];</div><div class="line">        fileName = fileName.replace(<span class="string">"\\\\"</span>, <span class="string">"."</span>);</div><div class="line">        fileName = fileName.replace(<span class="string">"/"</span>, <span class="string">"."</span>);</div><div class="line">        <span class="keyword">return</span> fileName;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>然后我们写一个测试类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestReload</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        fromDirection();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fromJar</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">300</span>; i++) &#123;</div><div class="line">            Premain.loadFromJarFile(<span class="string">"D:\\ming\\test\\target\\test-1.0-SNAPSHOT.jar"</span>);</div><div class="line">            TestReload.printTime();</div><div class="line">            <span class="keyword">new</span> TestReload().printNewTime();</div><div class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fromDirection</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">300</span>; i++) &#123;</div><div class="line">            Premain.loadFromDirection(<span class="string">"D:\\ming\\test\\target\\classes"</span>);</div><div class="line">            TestReload.printTime();</div><div class="line">            <span class="keyword">new</span> TestReload().printNewTime();</div><div class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printTime</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="number">2</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printNewTime</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="number">2</span>);</div><div class="line">        System.out.println(id);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> id = <span class="number">2</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们不断地修改printTime()和printNewTime()以及Id的值, 最后成功输出<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">2</span></div></pre></td></tr></table></figure></p>
<blockquote>
<p>在上面的实现中我分别实现了从目录和jar包对class文件进行热加载</p>
</blockquote>
<p>下面我们测试一下,如果增加了属性和方法成员, 看看有什么变化(下面只列出了TestReload.java的新增以及修改部分)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestReload</span> </span>&#123;</div><div class="line"></div><div class="line">	...</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printNewTime</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(id);</div><div class="line">        printName();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> id = <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> String name = <span class="string">"abc"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printName</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(name);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当我们再次重新加载的时候就会抛出异常<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">D:\ming\test\target&gt;java -javaagent:D:\premain\target\agent-1.0-SNAPSHOT.jar -cp .;./* TestReload</div><div class="line">1</div><div class="line">1</div><div class="line">2</div><div class="line">2</div><div class="line">2</div><div class="line">2</div><div class="line">java.lang.UnsupportedOperationException: class redefinition failed: attempted to change the schema (add/remove fields)</div><div class="line">	at sun.instrument.InstrumentationImpl.redefineClasses0(Native Method)</div><div class="line">	at sun.instrument.InstrumentationImpl.redefineClasses(Unknown Source)</div><div class="line">	at Premain.redefineClassesFromBytes(Premain.java:44)</div><div class="line">	at Premain.loadFromDirection(Premain.java:24)</div><div class="line">	at TestReload.fromDirection(TestReload.java:19)</div><div class="line">	at TestReload.main(TestReload.java:6)</div><div class="line">2</div><div class="line">java.lang.UnsupportedOperationException: class redefinition failed: attempted to change the schema (add/remove fields)</div><div class="line">	at sun.instrument.InstrumentationImpl.redefineClasses0(Native Method)</div><div class="line">	at sun.instrument.InstrumentationImpl.redefineClasses(Unknown Source)</div><div class="line">	at Premain.redefineClassesFromBytes(Premain.java:44)</div><div class="line">	at Premain.loadFromDirection(Premain.java:24)</div><div class="line">	at TestReload.fromDirection(TestReload.java:19)</div><div class="line">	at TestReload.main(TestReload.java:6)</div><div class="line">2</div></pre></td></tr></table></figure></p>
<p>完整项目<a href="https://github.com/yu66/JVM-reload" target="_blank" rel="external">JVM-reload</a></p>
<h2 id="Agentmain"><a href="#Agentmain" class="headerlink" title="Agentmain"></a>Agentmain</h2><p>在 Java SE 5 中premain 所作的 Instrumentation 也仅限与 main 函数执行前,这样的方式存在一定的局限性.Java SE 6 针对这种状况做出了改进,开发者可以在 main 函数开始执行以后,再启动自己的 Instrumentation 程序.在 Java SE 6 的 Instrumentation 当中,有一个跟 premain“并驾齐驱”的“agentmain”方法,可以在 main 函数开始运行之后再运行.</p>
<p>首先我们还是需要修改MANIFEST.MF文件, 在其中添加<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Manifest-Version: <span class="number">1.0</span></div><div class="line">Agent-Class: AgentMain</div><div class="line">Can-Redefine-Classes: <span class="keyword">true</span></div></pre></td></tr></table></figure></p>
<p>然后我们写一个代理类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> javax.xml.transform.Transformer;</div><div class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</div><div class="line"><span class="keyword">import</span> java.lang.instrument.UnmodifiableClassException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentMain</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span></span></div><div class="line">            <span class="keyword">throws</span> ClassNotFoundException, UnmodifiableClassException,</div><div class="line">            InterruptedException &#123;</div><div class="line">        <span class="keyword">for</span> (Class clazz : inst.getAllLoadedClasses()) &#123;</div><div class="line">            System.out.println(<span class="string">"Loaded Class : "</span> + clazz.getName());</div><div class="line">        &#125;</div><div class="line">        Printer.printTime();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Printer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printTime</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"now is "</span> + <span class="keyword">new</span> Date());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后写一个启动类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachine;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.management.ManagementFactory;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentLoader</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        String name = ManagementFactory.getRuntimeMXBean().getName();</div><div class="line">        String pid = name.split(<span class="string">"@"</span>)[<span class="number">0</span>];</div><div class="line">        System.out.println(pid);</div><div class="line">        VirtualMachine vm = VirtualMachine.attach(pid);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</div><div class="line"><span class="comment">//            vm.loadAgent("D:\\ming\\test\\target\\test-1.0-SNAPSHOT.jar");</span></div><div class="line">            vm.loadAgentPath(<span class="string">"D:\\ming\\test\\target\\test-1.0-SNAPSHOT.jar"</span>);</div><div class="line">            System.out.println(<span class="string">"Load Agent Over!!!"</span>);</div><div class="line">            TimeUnit.SECONDS.sleep(<span class="number">10</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打包后, 执行命令<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -cp .;.<span class="comment">/* AgentLoader</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/24/jvm/instrument/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/11/24/jvm/instrument/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/23/JavaLibrary/Netty Channel/" title="Netty Channel" itemprop="url">Netty Channel</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2015-11-22T16:00:00.000Z" itemprop="datePublished"> 发表于 2015-11-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><code>Channel</code>是Netty网络抽象类. 它的功能包括网络IO的读写,链路的连接和关闭, 通信双方的通信地址等.<br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/netty/channel.jpg" alt=""></p>
<p>下面我们看一下Channel提供的API</p>
<ul>
<li><code>parent()</code> : 获取父Channel</li>
<li><code>unsafe()</code> :</li>
<li><code>localAddress()</code> : 当前Channel的本地绑定地址</li>
<li><code>eventLoop()</code> : 当前Channel注册到的EventLoop对象</li>
<li><code>config()</code> : 获取当前Channel的配置信息</li>
<li><code>remoteAddress()</code> : 当前Channel通信的远程Socket地址</li>
<li><code>metadata()</code> : 当前Channel的元数据描述信息,例如TCP参数等等</li>
<li><code>isOpen()</code> : 判断当初Channel是否已经打开</li>
<li><code>isWritable()</code> : 当前Channel是否可写</li>
<li><code>isRegistered()</code> : 是否注册当EventLoop上</li>
<li><code>isActive()</code> : 当前Channel是否处于激活状态</li>
<li><code>pipeline()</code> : 当前Channel的ChannelPipeline对象</li>
</ul>
<p>下面的网络IO操作会直接调用ChannelPipeline里的方法, 在ChannelPipeline里进行事件传播</p>
<ul>
<li><code>read()</code> : 从Channel中读取数据到inbound缓冲区</li>
<li><code>write()</code> : 将消息通过ChannelPipeline写入到目标Channel中</li>
<li><code>close()</code> : 主动关闭与网络对端的连接</li>
<li><code>flush()</code> : 将之前写到环形队列里的消息全部写到目标Channel中,发送给网络对端</li>
<li><code>connect()</code> : 与网络对端发起连接请求(一般由客户端调用这个方法)</li>
<li><code>bind()</code> :</li>
<li><code>disconnect()</code> : 请求关闭与网络对端的连接.</li>
</ul>
<h2 id="AbstractChannel"><a href="#AbstractChannel" class="headerlink" title="AbstractChannel"></a>AbstractChannel</h2><p>我们首先看一下<code>AbstractChannel</code>里定义的成员<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 链路已经关闭异常</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> ClosedChannelException CLOSED_CHANNEL_EXCEPTION = <span class="keyword">new</span> ClosedChannelException();</div><div class="line"><span class="comment">// 链路尚未连接异常</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> NotYetConnectedException NOT_YET_CONNECTED_EXCEPTION = <span class="keyword">new</span> NotYetConnectedException();</div><div class="line"></div><div class="line"><span class="keyword">static</span> &#123;</div><div class="line">    CLOSED_CHANNEL_EXCEPTION.setStackTrace(EmptyArrays.EMPTY_STACK_TRACE);</div><div class="line">    NOT_YET_CONNECTED_EXCEPTION.setStackTrace(EmptyArrays.EMPTY_STACK_TRACE);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 用于预测下一个报文的大小.</span></div><div class="line"><span class="keyword">private</span> MessageSizeEstimator.Handle estimatorHandle;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Channel parent;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Unsafe unsafe;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelPipeline pipeline;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelFuture succeededFuture = <span class="keyword">new</span> SucceededChannelFuture(<span class="keyword">this</span>, <span class="keyword">null</span>);</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> VoidChannelPromise voidPromise = <span class="keyword">new</span> VoidChannelPromise(<span class="keyword">this</span>, <span class="keyword">true</span>);</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> VoidChannelPromise unsafeVoidPromise = <span class="keyword">new</span> VoidChannelPromise(<span class="keyword">this</span>, <span class="keyword">false</span>);</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> CloseFuture closeFuture = <span class="keyword">new</span> CloseFuture(<span class="keyword">this</span>);</div><div class="line"></div><div class="line"><span class="comment">// 本地IP地址</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> SocketAddress localAddress;</div><div class="line"><span class="comment">// 网络通信对端的IP地址</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> SocketAddress remoteAddress;</div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> EventLoop eventLoop;</div><div class="line"><span class="comment">// Channel是否注册到了EventLoop上</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> registered;</div><div class="line"></div><div class="line"><span class="comment">/** Cache for the string representation of this channel */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> strValActive;</div><div class="line"><span class="keyword">private</span> String strVal;</div></pre></td></tr></table></figure></p>
<p><code>AbstractChannel</code>聚合了所有Channel使用到的能力的对象. 如果某个功能和子类相关则定义抽象方法,由子类去实现.</p>
<p>在这里我们主要关注三个变量</p>
<ul>
<li><code>unsafe</code> : 真实网络IO的操作类</li>
<li><code>pipeline</code> : 当前Channel对应的ChannelPipeline. 负责</li>
<li><code>eventLoop</code> : 该Channel注册到的EventLoop<br>在实例化的时候, 会对<code>pipeline</code>和<code>unsafe</code>进行赋值.<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">AbstractChannel</span><span class="params">(Channel parent)</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>.parent = parent;</div><div class="line">      unsafe = newUnsafe();</div><div class="line">      pipeline = <span class="keyword">new</span> DefaultChannelPipeline(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>unsafe实例化由子类实现, 这是因为unsafe的类型是个Unsafe接口, 而且AbstractChannel的内部类AbstractUnsafe是个抽象类, 那么我们就不知道如果要实例化这个类型究竟要使用哪个类型, 因此让AbstractChannel的子类继续实现自己的Unsafe接口的内部类和newUnsafe()方法, unsafe实质类型就有很大的可扩展性</p>
</blockquote>
<p>我们看到每一个Channel都有一个自己的<code>pipeline</code>和<code>unsafe</code>. <code>eventLoop</code>是在<code>AbstractUnsafe</code>中<code>register()</code>方法调用时进行赋值的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(EventLoop eventLoop, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">        AbstractChannel.<span class="keyword">this</span>.eventLoop = eventLoop;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>AbstractChannel</code>完成的功能很少, 只是实现了一些初始化的工作, 然后将网络相关的建立,数据读写操作等交给<code>pipeline</code>来完成.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">disconnect</span><span class="params">(ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> pipeline.disconnect(promise);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">close</span><span class="params">(ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> pipeline.close(promise);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> pipeline.bind(localAddress, promise);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">connect</span><span class="params">(SocketAddress remoteAddress, ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> pipeline.connect(remoteAddress, promise);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">Override</span></div><div class="line"><span class="keyword">public</span> Channel <span class="title">read</span><span class="params">()</span> &#123;</div><div class="line">    pipeline.read();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">write</span><span class="params">(Object msg)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> pipeline.write(msg);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>还提供了一个<code>unsafe()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Unsafe <span class="title">unsafe</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> unsafe;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看一下<code>AbstractUnsafe</code>的定义<code>protected abstract class AbstractUnsafe implements Unsafe</code>, 它是作为一个<code>AbstractChannel</code>的抽象内部类, 这种关系也很容易让<code>AbstractUnsafe</code>访问<code>AbstractChannel</code>定义的一些空实现方法. 例如<code>AbstractUnsafe</code>中调用<code>AbstractChannel</code>的方法如下</p>
<ul>
<li><code>beginRead()</code> -&gt; <code>doBeginRead()</code></li>
<li><code>doBind()</code> -&gt; <code>doBind()</code></li>
<li><code>doDisconnect()</code> -&gt; <code>doDisconnect()()</code></li>
<li><code>doClose()</code> -&gt; <code>doClose()</code></li>
<li><code>register()</code> -&gt; <code>doRegister()</code>以及调用pipeline的相关方法(fireChannelRegistered()和fireChannelActive())</li>
</ul>
<h2 id="AbstractNioChannel"><a href="#AbstractNioChannel" class="headerlink" title="AbstractNioChannel"></a>AbstractNioChannel</h2><p><code>AbstractNioChannel</code>主要是实现了<code>AbstractChannel</code>的<code>doRegister(), doDeregister(), doBeginRead()</code>方法. 通过下面的变量我们也可以看出这个类主要是为了完成<code>SelectableChannel</code>向<code>Selector</code>的注册功能.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> SelectableChannel ch;</div><div class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> readInterestOp;</div><div class="line"><span class="keyword">volatile</span> SelectionKey selectionKey;</div></pre></td></tr></table></figure></p>
<p><code>java.nio.channels.ServerSocketChannel</code>和<code>java.nio.channels.SocketChannel</code>都是实现了<code>java.nio.channels.SelectableChannel</code>接口. 而<code>NioSocketChannel</code>和<code>NioServerSocketChannel</code>实现了<code>AbstractNioChannel</code>接口, 因此我们在<code>AbstractNioChannel</code>内定义了一个<code>SelectableChannel</code>成员用于实现<code>ServerSocketChannel</code>和<code>SocketChannel</code>的共用</p>
<p>然后我们看一下<code>doRegister()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegister</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> selected = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">for</span> (;;) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">// 我们将ServerSocketChannel或者SocketChannel注册到NioEventLoop里的Selector上</span></div><div class="line">			<span class="comment">// 0表示我们对任何事件Channel里的任何事件都不感兴趣</span></div><div class="line">			<span class="comment">// 同时我们将this作为附件传送进去,</span></div><div class="line">            selectionKey = javaChannel().register(eventLoop().selector, <span class="number">0</span>, <span class="keyword">this</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123;</div><div class="line">            <span class="keyword">if</span> (!selected) &#123;</div><div class="line">                <span class="comment">// Force the Selector to select now as the "canceled" SelectionKey may still be</span></div><div class="line">                <span class="comment">// cached and not removed because no Select.select(..) operation was called yet.</span></div><div class="line">                eventLoop().selectNow();</div><div class="line">                selected = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// We forced a select operation on the selector before but the SelectionKey is still cached</span></div><div class="line">                <span class="comment">// for whatever reason. JDK bug ?</span></div><div class="line">                <span class="keyword">throw</span> e;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后我们看一下<code>doBeginRead()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doBeginRead</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="comment">// Channel.read() or ChannelHandlerContext.read() was called</span></div><div class="line">    <span class="keyword">if</span> (inputShutdown) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> SelectionKey selectionKey = <span class="keyword">this</span>.selectionKey;</div><div class="line">    <span class="keyword">if</span> (!selectionKey.isValid()) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    readPending = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 获取selectionKey的操作位</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> interestOps = selectionKey.interestOps();</div><div class="line">    <span class="keyword">if</span> ((interestOps &amp; readInterestOp) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// 如果slectionKey不对读事件感兴趣, 那么就修改selectionKey的操作位, 开始设置对读事件感兴趣</span></div><div class="line">        selectionKey.interestOps(interestOps | readInterestOp);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>还记得在<code>AbstractChannel</code>中的<code>AbstractUnsafe</code>吗?里面有个<code>beginRead()</code>, 这个<code>doBeginRead()</code>正是由其调用的.</p>
<h2 id="AbstractNioByteChannel"><a href="#AbstractNioByteChannel" class="headerlink" title="AbstractNioByteChannel"></a>AbstractNioByteChannel</h2><p><code>AbstractNioByteChannel</code>内部只有一个<code>Runnable</code>类型的<code>flushTask</code>属性, 它是用来写半包的, 当我们使用到它的时候,我们再具体分析. 我们来重点看一下<code>doWrite()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doWrite</span><span class="params">(ChannelOutboundBuffer in)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       <span class="keyword">int</span> writeSpinCount = -<span class="number">1</span>;</div><div class="line"></div><div class="line">       <span class="keyword">for</span> (;;) &#123;</div><div class="line">           <span class="comment">// 从环形数组ChannelOutboundBuffer中弹出一个消息对象</span></div><div class="line">           Object msg = in.current();</div><div class="line">           <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="comment">// 如果全部消息都发送完毕累,则清除半包标志, clearOpWrite() 内部操作 TODO ???</span></div><div class="line">               clearOpWrite();</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> ByteBuf) &#123;</div><div class="line">               ByteBuf buf = (ByteBuf) msg;</div><div class="line">               <span class="keyword">int</span> readableBytes = buf.readableBytes();</div><div class="line">               <span class="keyword">if</span> (readableBytes == <span class="number">0</span>) &#123;</div><div class="line">                   <span class="comment">// 当前消息没有可读内容, 也就是没有内容需要向外发送,</span></div><div class="line">                   <span class="comment">// 则将其从还行数组中删除, 然后继续处理下一个消息</span></div><div class="line">                   in.remove();</div><div class="line">                   <span class="keyword">continue</span>;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="comment">//设置半包标志</span></div><div class="line">               <span class="keyword">boolean</span> setOpWrite = <span class="keyword">false</span>;</div><div class="line">               <span class="comment">// 设置消息是否发送完毕</span></div><div class="line">               <span class="keyword">boolean</span> done = <span class="keyword">false</span>;</div><div class="line">               <span class="comment">// 设置消息发送的总得数量</span></div><div class="line">               <span class="keyword">long</span> flushedAmount = <span class="number">0</span>;</div><div class="line">               <span class="keyword">if</span> (writeSpinCount == -<span class="number">1</span>) &#123;</div><div class="line">                   <span class="comment">// 从配置中我们获取每次写半包消息进行的最大次数. 也即是如果环形数组里的消息一次性发送</span></div><div class="line">                   <span class="comment">// 不完, 需要循环发送的次数,至于为什么不一直发送, 这是因为如果网络阻塞或者对方接受数据很慢,可能会造成网络IO线程假死</span></div><div class="line">                   writeSpinCount = config().getWriteSpinCount();</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = writeSpinCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i --) &#123;</div><div class="line">                   <span class="comment">// 将buf内部的数据进行发送, 返回值是数据发送量</span></div><div class="line">                   <span class="keyword">int</span> localFlushedAmount = doWriteBytes(buf);</div><div class="line">                   <span class="keyword">if</span> (localFlushedAmount == <span class="number">0</span>) &#123;</div><div class="line">                       <span class="comment">// 数量为0,说明一个数据都没有发送出去, 可能是TCP缓冲区满了. 因此设置写半包标志</span></div><div class="line">                       <span class="comment">// 同时退出写循环,这是因为下次写数据还可能TCP缓冲区处于已满状态,导致IO线程空循环</span></div><div class="line">                       setOpWrite = <span class="keyword">true</span>;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   <span class="comment">// 数据发送成功, 将发送的数据量累加到flushedAmount上.</span></div><div class="line">                   flushedAmount += localFlushedAmount;</div><div class="line">                   <span class="keyword">if</span> (!buf.isReadable()) &#123;</div><div class="line">                       <span class="comment">// 当前消息里的数据已经发送完毕, 退出buf发送循环,继续处理环形队列中下一个消息</span></div><div class="line">                       done = <span class="keyword">true</span>;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="comment">// 将发送的数据量同步到环形队列中</span></div><div class="line">               in.progress(flushedAmount);</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (done) &#123;</div><div class="line">                   <span class="comment">// buf数据已经发送完, 则将该消息从环形队列中删除</span></div><div class="line">                   in.remove();</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="comment">// 在写半包消息最大循环次数之内都没有将buf数据写完, 可能是数据量太多或者TCP缓冲区已满</span></div><div class="line">                   <span class="comment">// 释放当前IO线程,让其进行其他工作.</span></div><div class="line">                   incompleteWrite(setOpWrite);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> FileRegion) &#123;</div><div class="line">               FileRegion region = (FileRegion) msg;</div><div class="line">               <span class="keyword">boolean</span> done = region.transfered() &gt;= region.count();</div><div class="line">               <span class="keyword">boolean</span> setOpWrite = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (!done) &#123;</div><div class="line">                   <span class="keyword">long</span> flushedAmount = <span class="number">0</span>;</div><div class="line">                   <span class="keyword">if</span> (writeSpinCount == -<span class="number">1</span>) &#123;</div><div class="line">                       writeSpinCount = config().getWriteSpinCount();</div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> i = writeSpinCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">                       <span class="keyword">long</span> localFlushedAmount = doWriteFileRegion(region);</div><div class="line">                       <span class="keyword">if</span> (localFlushedAmount == <span class="number">0</span>) &#123;</div><div class="line">                           setOpWrite = <span class="keyword">true</span>;</div><div class="line">                           <span class="keyword">break</span>;</div><div class="line">                       &#125;</div><div class="line"></div><div class="line">                       flushedAmount += localFlushedAmount;</div><div class="line">                       <span class="keyword">if</span> (region.transfered() &gt;= region.count()) &#123;</div><div class="line">                           done = <span class="keyword">true</span>;</div><div class="line">                           <span class="keyword">break</span>;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   in.progress(flushedAmount);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (done) &#123;</div><div class="line">                   in.remove();</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   incompleteWrite(setOpWrite);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="comment">// Should not reach here.</span></div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> Error();</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p><code>doWrite()</code>方法是由<code>AbstractUnsafe</code>的<code>flush()</code>调用的. 从<code>AbstractUnsafe</code>我们可以看到每个Unsafe类都有一个<code>ChannelOutboundBuffer</code>属性.</p>
<p>下来我们看一下<code>incompleteWrite()</code>方法实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">incompleteWrite</span><span class="params">(<span class="keyword">boolean</span> setOpWrite)</span> </span>&#123;</div><div class="line">        <span class="comment">// 从doWrite()方法中可以看到只有当TCP缓冲区已满的时候才会设置写半包操作</span></div><div class="line">        <span class="keyword">if</span> (setOpWrite) &#123;</div><div class="line">            <span class="comment">// 设置累写半包的话,则将SelectionKey注册为OP_WRITE, 让多路复用器不断的轮训对应的Channel,</span></div><div class="line">            <span class="comment">// 继续处理没有发送完的消息</span></div><div class="line">            setOpWrite();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 如果没有半包,则让eventLoop继续执行写半包操作</span></div><div class="line">            Runnable flushTask = <span class="keyword">this</span>.flushTask;</div><div class="line">            <span class="keyword">if</span> (flushTask == <span class="keyword">null</span>) &#123;</div><div class="line">                flushTask = <span class="keyword">this</span>.flushTask = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        flush();</div><div class="line">                    &#125;</div><div class="line">                &#125;;</div><div class="line">            &#125;</div><div class="line">            eventLoop().execute(flushTask);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h2 id="AbstractNioMessageChannel"><a href="#AbstractNioMessageChannel" class="headerlink" title="AbstractNioMessageChannel"></a>AbstractNioMessageChannel</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doWrite</span><span class="params">(ChannelOutboundBuffer in)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       <span class="keyword">final</span> SelectionKey key = selectionKey();</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> interestOps = key.interestOps();</div><div class="line"></div><div class="line">       <span class="keyword">for</span> (;;) &#123;</div><div class="line">           <span class="comment">// 从环形队列中获取一条消息</span></div><div class="line">           Object msg = in.current();</div><div class="line">           <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="comment">// 消息为空,说明所有的消息都已经发送出去了. TODO</span></div><div class="line">               <span class="keyword">if</span> ((interestOps &amp; SelectionKey.OP_WRITE) != <span class="number">0</span>) &#123;</div><div class="line">                   key.interestOps(interestOps &amp; ~SelectionKey.OP_WRITE);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               <span class="keyword">boolean</span> done = <span class="keyword">false</span>;</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = config().getWriteSpinCount() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">                   <span class="comment">// 在配置的最大次数下,将msg发送出去</span></div><div class="line">                   <span class="keyword">if</span> (doWriteMessage(msg, in)) &#123;</div><div class="line">                       done = <span class="keyword">true</span>;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (done) &#123;</div><div class="line">                   <span class="comment">// 如果消息发送完毕累, 则将其从环形数组中删除</span></div><div class="line">                   in.remove();</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="comment">//  如果没有发送完毕, 则设置SelectionKey为写操作位, 让多路复用器不断的轮训channel,发送剩余的数据</span></div><div class="line">                   <span class="keyword">if</span> ((interestOps &amp; SelectionKey.OP_WRITE) == <span class="number">0</span>) &#123;</div><div class="line">                       key.interestOps(interestOps | SelectionKey.OP_WRITE);</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">               <span class="keyword">if</span> (continueOnWriteError()) &#123;</div><div class="line">                   in.remove(e);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="keyword">throw</span> e;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h2 id="NioServerSocketChannel"><a href="#NioServerSocketChannel" class="headerlink" title="NioServerSocketChannel"></a>NioServerSocketChannel</h2><p><code>NioServerSocketChannel</code>的主要作用是接受客户端连接<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">doReadMessages</span><span class="params">(List&lt;Object&gt; buf)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       SocketChannel ch = javaChannel().accept();</div><div class="line"></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">if</span> (ch != <span class="keyword">null</span>) &#123;</div><div class="line">               buf.add(<span class="keyword">new</span> NioSocketChannel(<span class="keyword">this</span>, ch));</div><div class="line">               <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">           logger.warn(<span class="string">"Failed to create a new channel from an accepted socket."</span>, t);</div><div class="line"></div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               ch.close();</div><div class="line">           &#125; <span class="keyword">catch</span> (Throwable t2) &#123;</div><div class="line">               logger.warn(<span class="string">"Failed to close a socket."</span>, t2);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这个方法调用主要是由<code>NioMessageUnsafe</code>的<code>read()</code>方法调用</p>
<h2 id="NioSocketChannel"><a href="#NioSocketChannel" class="headerlink" title="NioSocketChannel"></a>NioSocketChannel</h2>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Netty/">Netty</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/23/JavaLibrary/Netty Channel/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/11/23/JavaLibrary/Netty Channel/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/3/"><span></span>Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/5/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="yu66" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/JVM/" title="JVM">JVM<sup>17</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java/" title="Java">Java<sup>32</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java-Library/" title="Java Library">Java Library<sup>34</sup></a></li>
		  
		
		  
			<li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/NoSql/" title="NoSql">NoSql<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/数据库/" title="数据库">数据库<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/杂记/" title="杂记">杂记<sup>18</sup></a></li>
		  
		
		  
			<li><a href="/categories/算法/" title="算法">算法<sup>11</sup></a></li>
		  
		
		  
			<li><a href="/categories/编程语言/" title="编程语言">编程语言<sup>20</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Netty/" title="Netty">Netty<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/asm/" title="asm">asm<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Spring/" title="Spring">Spring<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Guice/" title="Guice">Guice<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://vertx.yu66.wang/" target="_blank" title="vertx3">vertx3</a>
            
          </li>
        
    </ul>
</div>

  

<div class="doubanshow">
<p class="asidetitle">豆瓣秀</p>
<div>
<script type="text/javascript" src="http://www.douban.com/service/badge/xxxyy/?show=collection&amp;n=12&amp;columns=3&amp;hidelogo=yes&amp;hideself=yes&amp;cat=book|movie" ></script>
</div>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=3253370782&verifier=e9ca895b&dpc=1"></iframe>
</div>


  

<div class="lofter">
<p class="asidetitle">Lofter</p>

 <iframe width="100%" height="39" class="share_self"  frameborder="0" scrolling="no" src="http://ming15.lofter.com/"></iframe>
</div>




</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 博客,我选择重构 <br/>
			重构使事情变得更美,更加正确</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/3253370782" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/yu66" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		<a href="https://www.douban.com/people/xxxyy" target="_blank" class="icon-douban" title="豆瓣"></a>
		
		
		<a href="http://www.zhihu.com/people/ming15" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="王玉">王玉</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"wanggnim"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F9e8fca440159a2125668804e46682db4' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
