
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>王玉</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="王玉">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="王玉">
<meta property="og:url" content="http://www.yu66.wang/page/4/index.html">
<meta property="og:site_name" content="王玉">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="王玉">

    
    <link rel="alternative" href="/atom.xml" title="王玉" type="application/atom+xml">
    
    
    
    <link rel="apple-touch-icon" href="/img/author.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/author.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="王玉" title="王玉"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="王玉">王玉</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
						<form class="search" action="http://zhannei.baidu.com/cse/search" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= 17728547076946147000 ><input type="text" name="q" size="30" placeholder="Search"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/14/JavaLibrary/Netty NioEventLoop/" title="Netty NioEventLoop" itemprop="url">Netty NioEventLoop</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-14T07:00:00.000Z" itemprop="datePublished"> Published 2016-03-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>在真实的业务环境中, 我们都是使用主从Reactor线程模型. 在Netty中主从线程池都是使用的<code>NioEventLoopGroup</code>, 它实现了<br><code>java.util.concurrent.Executor</code>. 虽然在编程中我们使用的是<code>NioEventLoopGroup</code>, 但是主要的逻辑确是在<code>MultithreadEventExecutorGroup</code>里实现的.<br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/netty/NioEventLoopGroup.jpg" alt=""><br>下来我们首先看一下<code>MultithreadEventExecutorGroup</code>的数据成员<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> EventExecutor[] children;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> EventExecutorChooser chooser;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">MultithreadEventExecutorGroup</span><span class="params">(<span class="keyword">int</span> nThreads, ThreadFactory threadFactory, Object... args)</span> </span>&#123;</div><div class="line">        children = <span class="keyword">new</span> SingleThreadEventExecutor[nThreads];</div><div class="line">        <span class="keyword">if</span> (isPowerOfTwo(children.length)) &#123;</div><div class="line">            chooser = <span class="keyword">new</span> PowerOfTwoEventExecutorChooser();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            chooser = <span class="keyword">new</span> GenericEventExecutorChooser();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nThreads; i ++) &#123;</div><div class="line">            <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                children[i] = newChild(threadFactory, args);</div><div class="line">                success = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                <span class="comment">// <span class="doctag">TODO:</span> Think about if this is a good exception type</span></div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"failed to create a child event loop"</span>, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>我们看到了<code>NioEventLoopGroup</code>内部聚合了一个<code>EventExecutor</code>的数组. 这个数组就构成了主从线程池. 线程的选择由<code>EventExecutorChooser chooser</code>来实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> EventExecutor <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> chooser.next();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PowerOfTwoEventExecutorChooser</span> <span class="keyword">implements</span> <span class="title">EventExecutorChooser</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EventExecutor <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> children[childIndex.getAndIncrement() &amp; children.length - <span class="number">1</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericEventExecutorChooser</span> <span class="keyword">implements</span> <span class="title">EventExecutorChooser</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EventExecutor <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> children[Math.abs(childIndex.getAndIncrement() % children.length)];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而<code>newChild()</code>的方法实现是由子类来确定的, 我们来直接看一下<code>NioEventLoopGroup</code>的内部实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> EventExecutor <span class="title">newChild</span><span class="params">(ThreadFactory threadFactory, Object... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NioEventLoop(<span class="keyword">this</span>, threadFactory, (SelectorProvider) args[<span class="number">0</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>它是直接生成了一个<code>NioEventLoop</code>的实例出来. 下来我们看一下<code>NioEventLoop</code>的实现<br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/netty/NioEventLoop.jpg" alt=""><br>我们看一下<code>NioEventLoop</code>的属性成员<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 多路选择复用器</span></div><div class="line">Selector selector;</div><div class="line"><span class="comment">// Netty优化过的SelectedSelectionKeys</span></div><div class="line"><span class="keyword">private</span> SelectedSelectionKeySet selectedKeys;</div><div class="line"><span class="comment">// SelectorProvider.provider()提供, 在NioEventLoopGroup构造器中实现</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> SelectorProvider provider;</div></pre></td></tr></table></figure></p>
<p>我们看到<code>NioEventLoop</code>主要是实现了IO多路复用, 它的任务执行是由父类<code>SingleThreadEventExecutor</code>实现的, 下面我们从它的构造器来追溯到<code>SingleThreadEventExecutor</code>上<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">NioEventLoop(NioEventLoopGroup parent, ThreadFactory threadFactory, SelectorProvider selectorProvider) &#123;</div><div class="line">    <span class="keyword">super</span>(parent, threadFactory, <span class="keyword">false</span>);</div><div class="line">    <span class="keyword">if</span> (selectorProvider == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"selectorProvider"</span>);</div><div class="line">    &#125;</div><div class="line">    provider = selectorProvider;</div><div class="line">    selector = openSelector();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>SingleThreadEventExecutor</code>这个类主要是实现了主从线程池中的线程功能, 所有的任务都在单线程中执行, 因此将这个线程池串行化, 可以将其看待成一个线程. 在<code>SingleThreadEventExecutor</code>中的构造器中,添加向任务队列中添加一个调用<code>NioEventLoop</code>的<code>run()</code>方法的任务<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">SingleThreadEventExecutor</span><span class="params">(</span></span></div><div class="line">            EventExecutorGroup parent, ThreadFactory threadFactory, <span class="keyword">boolean</span> addTaskWakesUp) &#123;</div><div class="line">        thread = threadFactory.newThread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</div><div class="line">                updateLastExecutionTime();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    SingleThreadEventExecutor.<span class="keyword">this</span>.run();</div><div class="line">                    success = <span class="keyword">true</span>;</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    <span class="keyword">for</span> (;;) &#123;</div><div class="line">                        <span class="keyword">int</span> oldState = STATE_UPDATER.get(SingleThreadEventExecutor.<span class="keyword">this</span>);</div><div class="line">                        <span class="keyword">if</span> (oldState &gt;= ST_SHUTTING_DOWN || STATE_UPDATER.compareAndSet(</div><div class="line">                                SingleThreadEventExecutor.<span class="keyword">this</span>, oldState, ST_SHUTTING_DOWN)) &#123;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// Check if confirmShutdown() was called at the end of the loop.</span></div><div class="line">                    <span class="keyword">if</span> (success &amp;&amp; gracefulShutdownStartTime == <span class="number">0</span>) &#123;</div><div class="line">                        logger.error(<span class="string">"Buggy "</span> + EventExecutor.class.getSimpleName());</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="comment">// Run all remaining tasks and shutdown hooks.</span></div><div class="line">                        <span class="keyword">for</span> (;;) &#123;</div><div class="line">                            <span class="keyword">if</span> (confirmShutdown()) &#123;</div><div class="line">                                <span class="keyword">break</span>;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            cleanup();</div><div class="line">                        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                            STATE_UPDATER.set(SingleThreadEventExecutor.<span class="keyword">this</span>, ST_TERMINATED);</div><div class="line">                            threadLock.release();</div><div class="line">                            terminationFuture.setSuccess(<span class="keyword">null</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        taskQueue = newTaskQueue();</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>我们看到了一行关键性代码<code>SingleThreadEventExecutor.this.run()</code>, 它调用了自己的<code>run()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure></p>
<p>而这个方法是在<code>NioEventLoop</code>中实现的,也是我们要重点分析的代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">boolean</span> oldWakenUp = wakenUp.getAndSet(<span class="keyword">false</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// 查看taskQueue里是否有任务, 如果有任务的话, 则直接selector.selectNow();</span></div><div class="line">                <span class="keyword">if</span> (hasTasks()) &#123;</div><div class="line">                    selectNow();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    select(oldWakenUp);</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (wakenUp.get()) &#123;</div><div class="line">                        selector.wakeup();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                cancelledKeys = <span class="number">0</span>;</div><div class="line">                needsToSelectAgain = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> ioRatio = <span class="keyword">this</span>.ioRatio;</div><div class="line">                <span class="comment">// 如果当前线程是百分百执行的话, 则直接处理所有的任务</span></div><div class="line">                <span class="keyword">if</span> (ioRatio == <span class="number">100</span>) &#123;</div><div class="line">                    processSelectedKeys();</div><div class="line">                    runAllTasks();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">long</span> ioStartTime = System.nanoTime();</div><div class="line"></div><div class="line">                    processSelectedKeys();</div><div class="line"></div><div class="line">                    <span class="keyword">final</span> <span class="keyword">long</span> ioTime = System.nanoTime() - ioStartTime;</div><div class="line">                    runAllTasks(ioTime * (<span class="number">100</span> - ioRatio) / ioRatio);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">//</span></div><div class="line">                <span class="keyword">if</span> (isShuttingDown()) &#123;</div><div class="line">                    closeAll();</div><div class="line">                    <span class="keyword">if</span> (confirmShutdown()) &#123;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>上面的<code>run()</code>就是不断的轮询当前<code>NioEventLoop</code>里是否有任务. 然后处理Selector上已经就绪的Channel和任务队列里的任务.<br>然后我们接着往下看<code>processSelectedKeys()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processSelectedKeys</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (selectedKeys != <span class="keyword">null</span>) &#123;</div><div class="line">           processSelectedKeysOptimized(selectedKeys.flip());</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           processSelectedKeysPlain(selector.selectedKeys());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processSelectedKeysPlain</span><span class="params">(Set&lt;SelectionKey&gt; selectedKeys)</span> </span>&#123;</div><div class="line">           <span class="comment">// check if the set is empty and if so just return to not create garbage by</span></div><div class="line">           <span class="comment">// creating a new Iterator every time even if there is nothing to process.</span></div><div class="line">           <span class="comment">// See https://github.com/netty/netty/issues/597</span></div><div class="line">           <span class="keyword">if</span> (selectedKeys.isEmpty()) &#123;</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           Iterator&lt;SelectionKey&gt; i = selectedKeys.iterator();</div><div class="line">           <span class="keyword">for</span> (;;) &#123;</div><div class="line">               <span class="keyword">final</span> SelectionKey k = i.next();</div><div class="line">               <span class="comment">// 取出SelectionKey的附件</span></div><div class="line">               <span class="keyword">final</span> Object a = k.attachment();</div><div class="line">               i.remove();</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (a <span class="keyword">instanceof</span> AbstractNioChannel) &#123;</div><div class="line">                 <span class="comment">// a有可能是NioServerSocketChannel或者NioSocketChannel</span></div><div class="line">                   processSelectedKey(k, (AbstractNioChannel) a);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="comment">// 如果a不是Channel的话, 那就是NioTask了</span></div><div class="line">                   <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">                   NioTask&lt;SelectableChannel&gt; task = (NioTask&lt;SelectableChannel&gt;) a;</div><div class="line">                   processSelectedKey(k, task);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (!i.hasNext()) &#123;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (needsToSelectAgain) &#123;</div><div class="line">                   selectAgain();</div><div class="line">                   selectedKeys = selector.selectedKeys();</div><div class="line"></div><div class="line">                   <span class="comment">// Create the iterator again to avoid ConcurrentModificationException</span></div><div class="line">                   <span class="keyword">if</span> (selectedKeys.isEmpty()) &#123;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   &#125; <span class="keyword">else</span> &#123;</div><div class="line">                       i = selectedKeys.iterator();</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<p>然后咱们接着往下看对Channel的处理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">processSelectedKey</span><span class="params">(SelectionKey k, AbstractNioChannel ch)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> NioUnsafe unsafe = ch.unsafe();</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">int</span> readyOps = k.readyOps();</div><div class="line">        <span class="comment">// Also check for readOps of 0 to workaround possible JDK bug which may otherwise lead</span></div><div class="line">        <span class="comment">// to a spin loop</span></div><div class="line">        <span class="keyword">if</span> ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != <span class="number">0</span> || readyOps == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// 如果是读事件或者连接的事件,则直接调用read方法</span></div><div class="line">            unsafe.read();</div><div class="line">            <span class="keyword">if</span> (!ch.isOpen()) &#123;</div><div class="line">                <span class="comment">// Connection already closed - no need to handle write.</span></div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> ((readyOps &amp; SelectionKey.OP_WRITE) != <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// 如果是写操作位, 则说明有半包消息没有写完, 需要继续</span></div><div class="line">            ch.unsafe().forceFlush();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> ((readyOps &amp; SelectionKey.OP_CONNECT) != <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// remove OP_CONNECT as otherwise Selector.select(..) will always return without blocking</span></div><div class="line">            <span class="comment">// See https://github.com/netty/netty/issues/924</span></div><div class="line">            <span class="keyword">int</span> ops = k.interestOps();</div><div class="line">            ops &amp;= ~SelectionKey.OP_CONNECT;</div><div class="line">            k.interestOps(ops);</div><div class="line"></div><div class="line">            unsafe.finishConnect();</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (CancelledKeyException ignored) &#123;</div><div class="line">        unsafe.close(unsafe.voidPromise());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>在unsafe的多态这我们要多说一些, 我们知道NioEventLoop内部处理的Channel其实是有俩种类型的, 一个是<code>NioServerScoketChannel</code>一个是<code>NioSocketChannel</code>.</p>
<p><code>NioServerSocketChannel</code>继承自<code>AbstractNioMessageChannel</code>, 而这个父类实现了一个<code>NioMessageUnsafe</code>的一个内部类, 这个内部类的<code>read()</code>方法会调用Channel里的<code>doReadMessage()</code>方法. 父类的<code>doReadMessage()</code>方法是由子类来具体实现的. 在<code>NioServerScoketChannel</code>中是生成了一个<code>NioSocketChannel</code>的列表作为消息返回, 然后再让<code>ServerBootstrapAcceptor</code>将<code>NioSocketChannel</code>绑定到从Reactor上.</p>
<p><code>NioSocketChannel</code>继承自<code>AbstractNioByteChannel</code>, 这个父类实现了一个<code>NioByteUnsafe</code>, 这个Unsafe就负责创建ByteBuf, 接受真正的网络数据了.</p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Netty/">Netty</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/14/JavaLibrary/Netty NioEventLoop/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/14/JavaLibrary/Netty NioEventLoop/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/12/算法/环形队列/" title="环形队列" itemprop="url">环形队列</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-12T08:00:00.000Z" itemprop="datePublished"> Published 2016-03-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#-*- coding=utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="comment"># 环形队列实现</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CircleQueue</span>:</span></div><div class="line">    <span class="comment"># 队列头</span></div><div class="line">    queueHead = <span class="number">0</span></div><div class="line">    <span class="comment"># 队列尾</span></div><div class="line">    queueTail = <span class="number">0</span></div><div class="line">    <span class="comment"># 队列容量</span></div><div class="line">    queueCacity = <span class="number">0</span></div><div class="line">    <span class="comment"># 队列当前长度</span></div><div class="line">    queueLength = <span class="number">0</span></div><div class="line">    <span class="comment"># 队列容器</span></div><div class="line">    queue = []</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, capacity)</span>:</span></div><div class="line">        self.queueCacity = capacity</div><div class="line">        self.queue = [<span class="number">0</span>] * capacity</div><div class="line"></div><div class="line">    <span class="comment"># 入列</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enqueue</span><span class="params">(self, obj)</span>:</span></div><div class="line">        <span class="keyword">if</span>(self.isFull()):</div><div class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"Queue is Full"</span>)</div><div class="line"></div><div class="line">        self.queue[self.queueTail] = obj</div><div class="line">        self.queueTail += <span class="number">1</span></div><div class="line">        <span class="comment"># 为了让队列头一直在环形队列中进行变化, 因此进行取余操作,</span></div><div class="line">        <span class="comment"># 当队列头达到最大容量时,再增长就回到初始队列头的位置</span></div><div class="line">        self.queueTail = self.queueTail % self.queueCacity</div><div class="line">        self.queueLength += <span class="number">1</span></div><div class="line"></div><div class="line">        <span class="keyword">return</span> self.queueLength</div><div class="line"></div><div class="line">    <span class="comment"># 出列</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dequeue</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">if</span>(self.isEmpoty()):</div><div class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"Queue is Empoty"</span>)</div><div class="line">        obj = self.queue[self.queueHead]</div><div class="line">        self.queueHead += <span class="number">1</span></div><div class="line">        self.queueHead = self.queueHead % self.queueCacity</div><div class="line">        self.queueLength -= <span class="number">1</span></div><div class="line">        <span class="keyword">return</span> obj</div><div class="line"></div><div class="line">    <span class="comment"># 判断队列是否为空</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isEmpoty</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.queueLength == <span class="number">0</span></div><div class="line"></div><div class="line">    <span class="comment"># 判断队列是否已满</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isFull</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.queueLength == self.queueCacity</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 测试</span></div><div class="line">circleQueue = CircleQueue(<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="comment"># 入列5个元素</span></div><div class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">1</span>) == <span class="number">1</span></div><div class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">2</span>) == <span class="number">2</span></div><div class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">3</span>) == <span class="number">3</span></div><div class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">4</span>) == <span class="number">4</span></div><div class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">5</span>) == <span class="number">5</span></div><div class="line"></div><div class="line"><span class="comment"># 现在队列的长度为5, 且队列尾已经和队列头重合了</span></div><div class="line"><span class="keyword">assert</span> circleQueue.queueLength == <span class="number">5</span></div><div class="line"><span class="keyword">assert</span> circleQueue.queueTail == <span class="number">0</span></div><div class="line"><span class="keyword">assert</span> circleQueue.queueHead == <span class="number">0</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> circleQueue.dequeue() == <span class="number">1</span></div><div class="line"><span class="keyword">assert</span> circleQueue.dequeue() == <span class="number">2</span></div><div class="line"><span class="keyword">assert</span> circleQueue.dequeue() == <span class="number">3</span></div><div class="line"><span class="keyword">assert</span> circleQueue.dequeue() == <span class="number">4</span></div><div class="line"><span class="keyword">assert</span> circleQueue.dequeue() == <span class="number">5</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> circleQueue.queueTail == <span class="number">0</span></div><div class="line"><span class="keyword">assert</span> circleQueue.queueHead == <span class="number">0</span></div><div class="line"></div><div class="line"><span class="comment"># 再入列一个数据,当前长度为1,且队列头为0,队列尾为1</span></div><div class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">6</span>) == <span class="number">1</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> circleQueue.queueTail == <span class="number">1</span></div><div class="line"><span class="keyword">assert</span> circleQueue.queueHead == <span class="number">0</span></div></pre></td></tr></table></figure>
<p>环形队列的关键是能让头索引和尾索引能够在整个环形队列中自己循环</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/算法/">算法</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/12/算法/环形队列/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/12/算法/环形队列/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/06/nginx/nginx负载均衡/" title="Nginx负载均衡实战" itemprop="url">Nginx负载均衡实战</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-06T08:00:00.000Z" itemprop="datePublished"> Published 2016-03-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我们测试一次Nginx的负载均衡配置.</p>
<p>首先我们使用python启动俩个HTTP服务器<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> BaseHTTPServer</div><div class="line"><span class="keyword">import</span> urlparse</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line">port = sys.argv[<span class="number">1</span>]</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WebRequestHandler</span><span class="params">(BaseHTTPServer.BaseHTTPRequestHandler)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        """</div><div class="line">        <span class="keyword">print</span> port</div><div class="line"></div><div class="line">server = BaseHTTPServer.HTTPServer((<span class="string">'0.0.0.0'</span>,int(sys.argv[<span class="number">1</span>])), WebRequestHandler)</div><div class="line">server.serve_forever()</div></pre></td></tr></table></figure></p>
<p>然后在命令行分别启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">python ./PyHttpServer.py 8091</div><div class="line">python ./PyHttpServer.py 8092</div></pre></td></tr></table></figure></p>
<p>然后我们配置nginx.conf文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">#user  nobody;</div><div class="line">worker_processes  1;</div><div class="line"></div><div class="line">pid        logs/nginx.pid;</div><div class="line"></div><div class="line">events &#123;</div><div class="line">    worker_connections  1024;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">http &#123;</div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line"></div><div class="line">    sendfile        on;</div><div class="line">    upstream big_server_com &#123;</div><div class="line">      server 127.0.0.1:8091 weight=5;</div><div class="line">      server 127.0.0.1:8092 weight=5;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen       8090;</div><div class="line">        server_name  localhost;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">            root   html;</div><div class="line">            index  index.html index.htm;</div><div class="line">            proxy_pass      http://big_server_com;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">            root   html;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们让nginx在8090端口上监听, 然后将其反向代理到<code>8091</code>和<code>8092</code>端口上.</p>
<blockquote>
<p>还有一点很重要的是, 要代理的服务必须在Nginx启动之前都启动完毕, 否则Nginx没办法完成代理工作.</p>
</blockquote>
<p>最后我们在浏览器上发送HTTP请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost:8090</div></pre></td></tr></table></figure></p>
<p>我们发现那俩个python的HTTP服务器果真都有输出了.</p>
<p>但是我们发现, 就是那俩个服务器同时都有输出, 而不是应该只有其中一个有输出. 所以下来还需要研究一下如何配置Upstream, 看看如何让其真正实现负载均衡和单点失败</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/06/nginx/nginx负载均衡/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/06/nginx/nginx负载均衡/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/06/nginx/nginx文件服务器/" title="Nginx 静态资源服务" itemprop="url">Nginx 静态资源服务</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-06T08:00:00.000Z" itemprop="datePublished"> Published 2016-03-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>修改nginx.conf文件<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">       listen       8000;</div><div class="line"></div><div class="line">       autoindex on;             #开启索引功能</div><div class="line">       autoindex_exact_size off; # 关闭计算文件确切大小（单位bytes），只显示大概大小（单位kb、mb、gb）</div><div class="line">       autoindex_localtime on;   # 显示本机时间而非 GMT 时间</div><div class="line"></div><div class="line">       root /home/files/;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>然后在地址栏里访问<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.15.20:8000/</div></pre></td></tr></table></figure></p>
<p>我们就能看见文件列表了.</p>
<h2 id="403异常"><a href="#403异常" class="headerlink" title="403异常"></a>403异常</h2><p>产生了403异常的话, 说明nginx没有访问该目录, 也就是<code>/home/files/</code>的权限, 需要将nginx用户添加到这个目录的用户组里.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">usermod -G groupname username</div></pre></td></tr></table></figure></p>
<p>然后查看用户组<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat /etc/group | grep groupname</div></pre></td></tr></table></figure></p>
<p>然后nginx用户要有要访问目录的上层所有父目录的可执行权限, 要有访问目录的读权限</p>
<p>最后nginx用户是在nginx.conf配置里<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#user  nobody;</span></div><div class="line">user  www www;</div><div class="line">worker_processes  4;</div></pre></td></tr></table></figure></p>
<p>user就是了</p>
<h2 id="禁止访问目录"><a href="#禁止访问目录" class="headerlink" title="禁止访问目录"></a>禁止访问目录</h2><p>跟Apache的Deny from all类似，nginx有deny all指令来实现。</p>
<p>禁止对叫dirdeny目录的访问并返回403 Forbidden，可以使用下面的配置:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location /dirdeny &#123;</div><div class="line">      deny all;</div><div class="line">      return 403;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/06/nginx/nginx文件服务器/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/06/nginx/nginx文件服务器/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/06/nginx/nginx安装与命令/" title="Nginx安装与启动,关闭" itemprop="url">Nginx安装与启动,关闭</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-06T08:00:00.000Z" itemprop="datePublished"> Published 2016-03-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>在MAC上安装Nginx</p>
<p>使用命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">brew install nginx</div></pre></td></tr></table></figure></p>
<p>homebrew会自动为我们安装. 程序会安装在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/Cellar/nginx/1.6.2</div></pre></td></tr></table></figure></p>
<p>nginx的配置文件在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd /usr/local/etc/nginx</div></pre></td></tr></table></figure></p>
<blockquote>
<p>一般通过Homebrew安装的程序都会放在<code>/usr/local/Cellar/</code>里, 而配置文件会存储在<code>/usr/local/etc/</code>里</p>
</blockquote>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>我们可以通过下面这个简单的命令直接启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/nginx</div></pre></td></tr></table></figure></p>
<p>或者使用一个经过配置化的参数启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/nginx -t -c ~/mynginx.conf -g &quot;pid /var/run/nginx.pid; worker_processes 2;&quot;</div></pre></td></tr></table></figure></p>
<h2 id="关闭"><a href="#关闭" class="headerlink" title="关闭"></a>关闭</h2><p>一般我们可以通过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/nginx -s stop</div></pre></td></tr></table></figure></p>
<p>但是我们还可以通过想Nginx 主进程发送信号的方式来关闭它.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kill -QUIT $( cat /usr/local/nginx/logs/nginx.pid )</div></pre></td></tr></table></figure></p>
<p>一般我们推荐第二种方式, 让Nginx自己去停掉所有的主从进程</p>
<p>Nginx还接受如下参数</p>
<ul>
<li>TERM, INT    : Quick shutdown</li>
<li>QUIT :    Graceful shutdown</li>
<li>KILL :    Halts a stubborn process</li>
<li>HUP : Configuration reload, Start the new worker processes with a new configuration, Gracefully shutdown the old worker processes</li>
<li>USR1 :    Reopen the log files</li>
<li>USR2 :    Upgrade Executable on the fly</li>
<li>WINCH :    Gracefully shutdown the worker processes</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/06/nginx/nginx安装与命令/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/06/nginx/nginx安装与命令/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/05/JavaSE/Java ListVSMap/" title="List VS Map" itemprop="url">List VS Map</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-05T08:00:00.000Z" itemprop="datePublished"> Published 2016-03-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>在日常的使用中, 使用的最多的结构就是List和Map了. 其中又以ArrayList和HashMap使用的最多. 今天特意找了一些时间来看一下他们各自的实现以及添加索引数据时的性能.</p>
<p>首先看一下ArrayList.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">transient</span> Object[] elementData;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">    ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!!</span></div><div class="line">    elementData[size++] = e;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">    rangeCheck(index);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> elementData(index);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>它的内部就是一个Object类型的数组, 在添加数据时首先确保数组不会越界, 如果会产生越界则内部进行数组扩容拷贝操作.</p>
<p>对于<code>HashMap</code>它的Javadoc中是如此说的:</p>
<p><code>HashMap</code>是hash table的一个实现。它与<code>HashTable</code>不同之处就是它是非同步的而且键值都支持null.对于put和get操作，HashMap的耗时都是固定的，不会因为Map的大小而变化。因为hash函数会将元素分配到不同的bucket里面取. HashMap的迭代操作与它的容量（bucket数量+键值对数量）成正比关系.</p>
<p>一般情况下, load factor的默认值0.75, 这个值在空间和时间上找到较为平衡的查找性能。 如果高于这个值的话，会减少空间占用但是会增加查询的消耗(这点反应在了大多数的hashMap操作中，包括get和put操作).</p>
<p>下来我们首先看一下它的数据成员<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// load factor 默认值</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</div><div class="line"></div><div class="line"><span class="comment">// hash表存储数据的数据结构, 每个Node都是一个散列桶, 每个桶里是一个链表</span></div><div class="line"><span class="keyword">transient</span> Node&lt;K,V&gt;[] table;</div><div class="line"></div><div class="line"><span class="comment">// hash表散列桶的大小阀值, 如果超过这个值就对hash表进行拓容 (大小为: capacity * load factor)</span></div><div class="line"><span class="keyword">int</span> threshold;</div><div class="line"></div><div class="line"><span class="comment">// hash表使用的loadFactor</span></div><div class="line"><span class="keyword">final</span> <span class="keyword">float</span> loadFactor;</div></pre></td></tr></table></figure></p>
<p>然后我们看一下<code>put()</code>方法的实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,                    <span class="keyword">boolean</span> evict)</span> </span>&#123;</div><div class="line">        Node&lt;K,V&gt;[] tab;</div><div class="line">        Node&lt;K,V&gt; p;</div><div class="line">        <span class="keyword">int</span> n, i;</div><div class="line">        <span class="comment">// 如果table不存在或者table大小为0, 则重新生成一个table</span></div><div class="line">        <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</div><div class="line">            n = (tab = resize()).length;</div><div class="line">        <span class="comment">// 根据与hash值与操作找到要插入的元素所在的散列桶的位置</span></div><div class="line">        <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</div><div class="line">            <span class="comment">// 发现当前位置上的散列桶上没有Node则,重新生成一个Node</span></div><div class="line">            tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 发现当前散列桶已经有元素了</span></div><div class="line">            Node&lt;K,V&gt; e; K k;</div><div class="line">            <span class="comment">// 判断插入key是否与找到的Node的key是否相等, 如果相等则将p赋值给e, 进行value的赋值操作</span></div><div class="line">            <span class="keyword">if</span> (p.hash == hash &amp;&amp; ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">                e = p;</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</div><div class="line">                e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 插入的key与散列桶链表中的第一个元素不相符, 则遍历整个链表</span></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</div><div class="line">                    <span class="comment">// 在连表中找不到存在的元素, 则生成一个新的Node插入进来</span></div><div class="line">                    <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</div><div class="line">                        p.next = newNode(hash, key, value, <span class="keyword">null</span>);</div><div class="line">                        <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></div><div class="line">                            treeifyBin(tab, hash);</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// 找到了与要插入的key相等的散列表的元素, 则停止继续查找</span></div><div class="line">                    <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    p = e;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// 在散列表里找到了相同的key的hash值, 就直接插入了, 不再需要进行下面的hash表拓容操作</span></div><div class="line">            <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></div><div class="line">                V oldValue = e.value;</div><div class="line">                <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</div><div class="line">                    e.value = value;</div><div class="line">                afterNodeAccess(e);</div><div class="line">                <span class="keyword">return</span> oldValue;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ++modCount;</div><div class="line">        <span class="comment">// 占有了一个新的hash桶, 判断如果超过了Hash表散列桶的阀值,则对hash表进行拓容</span></div><div class="line">        <span class="keyword">if</span> (++size &gt; threshold)</div><div class="line">            resize();</div><div class="line">        afterNodeInsertion(evict);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>从上面的逻辑我们可以看出,<code>HashMap</code>在插入元素的时候,首先是根据key的hash值找到散列桶的位置, 然后再根据key与散列桶中的散列表的数据进行便利查找.</p>
<p>因此我们应该尽量的调大HashMap的容量, 尽可能的让桶的容量大于元素的个数, 同时尽可能的保证key值hash函数的正确性, 否则如果元素过多但是桶的数量太少, 会将hash 表退化到链表结构, 将O(1)的查找复杂度变成O(N). 说完HashMap的查找复杂度, 我们再来看一下HashMap的内存占有, 每当我们插入一个新的元素的时候都会生成一个<code>Node</code>对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hash;</div><div class="line">    <span class="keyword">final</span> K key;</div><div class="line">    V value;</div><div class="line">    Node&lt;K,V&gt; next;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/05/JavaSE/Java ListVSMap/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/05/JavaSE/Java ListVSMap/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/05/nginx/nginx配置/" title="Nginx配置大全" itemprop="url">Nginx配置大全</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-05T08:00:00.000Z" itemprop="datePublished"> Published 2016-03-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>下面我们看一下Nginx官方给出的nginx.config可有的全部配置内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line">user       www www;  ## Default: nobody</div><div class="line"># 在Nginx启动的时候会启动一个Master进程,和N个worker进程,Master讲接收到的任务分配给worker进程执行. worker进程数一般与主机的CPU的核心数相等</div><div class="line">worker_processes  5;  ## Default: 1</div><div class="line"># 错误日志的输出位置. (TODO 错误日志指的是哪些?)</div><div class="line">error_log  logs/error.log;</div><div class="line"># Nginx启动时的主进程ID</div><div class="line">pid        logs/nginx.pid;</div><div class="line"># worker进程能打开的最多的文件数(TODO 在正式环境中Nginx都会打开什么文件? 指的是Socket连接吗?)</div><div class="line">worker_rlimit_nofile 8192;</div><div class="line"></div><div class="line"># events模块, 包含nginx中所有处理连接的设置</div><div class="line">events &#123;</div><div class="line">  # worker进程能打开的最大的连接数 (小于worker_rlimit_nofile数)</div><div class="line">  worker_connections  4096;  ## Default: 1024</div><div class="line">&#125;</div><div class="line"></div><div class="line"># http模块, 用于处理http请求</div><div class="line">http &#123;</div><div class="line">  # 引用mime.types配置, 主要是配置HTTP请求中的mineType类型</div><div class="line">  include    conf/mime.types;</div><div class="line">  # 引用nginx的代理配置. (TODO)</div><div class="line">  include    /etc/nginx/proxy.conf;</div><div class="line">  # 为nginx引用cgi配置</div><div class="line">  include    /etc/nginx/fastcgi.conf;</div><div class="line">  # 指定当HTTP请求没有任何请求路径时展示的界面.</div><div class="line">  index    index.html index.htm index.php;</div><div class="line"></div><div class="line">  #</div><div class="line">  default_type application/octet-stream;</div><div class="line">  # log输出格式</div><div class="line">  log_format   main &apos;$remote_addr - $remote_user [$time_local]  $status &apos;</div><div class="line">    &apos;&quot;$request&quot; $body_bytes_sent &quot;$http_referer&quot; &apos;</div><div class="line">    &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</div><div class="line"></div><div class="line">  # 访问nginx时, 记录的http请求的日志存储位置 (TODO  如何以时间分割文件?)</div><div class="line">  access_log   logs/access.log  main;</div><div class="line">  # sendfile并不是发送文件, 而是设置磁盘和TCP Socket传输数据时直接通过系统缓存实现, 不再经过用户区的Read, write操作</div><div class="line">  sendfile     on;</div><div class="line">  # 设置在发送HTTP头文件时一次性全部发送, 而不是一个接一个的发送. (TODO)</div><div class="line">  tcp_nopush   on;</div><div class="line">  # TODO</div><div class="line">  server_names_hash_bucket_size 128; # this seems to be required for some vhosts</div><div class="line"></div><div class="line">  # 开启一个网络监听服务</div><div class="line">  server &#123; # php/fastcgi</div><div class="line">    # 该server监听的端口</div><div class="line">    listen       80;</div><div class="line">    # 绑定到的域名地址, 一般我们在主机都是使用localhost</div><div class="line">    server_name  domain1.com www.domain1.com;</div><div class="line">    # 该server生成的日志的保存地址</div><div class="line">    access_log   logs/domain1.access.log  main;</div><div class="line">    # 指定http请求中主机资源起始位置, 也就是`http://localhost:8090/`后面的位置</div><div class="line">    root         html;</div><div class="line"></div><div class="line">    # 所有请求以.php结尾的文件都到下面的代理地址中进行代理请求</div><div class="line">    location ~ \.php$ &#123;</div><div class="line">      fastcgi_pass   127.0.0.1:1025;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  # 再设置一个网络服务</div><div class="line">  server &#123; # simple reverse-proxy</div><div class="line">    listen       80;</div><div class="line">    server_name  domain2.com www.domain2.com;</div><div class="line">    access_log   logs/domain2.access.log  main;</div><div class="line"></div><div class="line">    # serve static files</div><div class="line">    location ~ ^/(images|javascript|js|css|flash|media|static)/  &#123;</div><div class="line">      root    /var/www/virtual/big.server.com/htdocs;</div><div class="line">      expires 30d;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    # 反向代理设置, 将/下所有的请求进行转发</div><div class="line">    location / &#123;</div><div class="line">      #设置反向代理的地址, 將80端口接受到的请求转发到localhost的8080端口上</div><div class="line">      proxy_pass      http://127.0.0.1:8080;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  # 设置反向代理</div><div class="line">  upstream big_server_com &#123;</div><div class="line">    # 按照权重将代理过来的请求代理到俩个代理服务器上</div><div class="line">    server 127.0.0.3:8000 weight=5;</div><div class="line">    server 127.0.0.3:8001 weight=5;</div><div class="line">    server 192.168.0.1:8000;</div><div class="line">    server 192.168.0.1:8001;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  server &#123; # simple load balancing</div><div class="line">    listen          80;</div><div class="line">    server_name     big.server.com;</div><div class="line">    access_log      logs/big.server.access.log main;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">      # 设置反向代理, 代理到big_server_com上(upstream刚刚定义的)</div><div class="line">      proxy_pass      http://big_server_com;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面谈到的location涉及到的内容较多, 我们单独介绍一下:</p>
<p>nginx location语法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">location [=|~|~*|^~] /uri/ &#123; … &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>=</code> 严格匹配。如果这个查询匹配，那么将停止搜索并立即处理此请求。</li>
<li><code>~</code> 为区分大小写匹配(可用正则表达式)</li>
<li><code>~*</code> 为不区分大小写匹配(可用正则表达式)</li>
<li><code>!~</code> 区分大小写不匹配</li>
<li><code>!~*</code> 不区分大小写不匹配</li>
<li><code>^~</code> 如果路径匹配那么不测试正则表达式。</li>
</ul>
<p>上面的配置引用里其他的配置文件,而且很多配置没有配置选项,下面是Nginx官网给出的另一种配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div></pre></td><td class="code"><pre><div class="line">user  www www;</div><div class="line">worker_processes  2;</div><div class="line">pid /var/run/nginx.pid;</div><div class="line"></div><div class="line"># [ debug | info | notice | warn | error | crit ]</div><div class="line">error_log  /var/log/nginx.error_log  info;</div><div class="line"></div><div class="line">events &#123;</div><div class="line">  worker_connections   2000;</div><div class="line">  # use [ kqueue | rtsig | epoll | /dev/poll | select | poll ] ;</div><div class="line">  use kqueue;</div><div class="line">&#125;</div><div class="line"></div><div class="line">http &#123;</div><div class="line">  include       conf/mime.types;</div><div class="line">  default_type  application/octet-stream;</div><div class="line"></div><div class="line">  log_format main      &apos;$remote_addr - $remote_user [$time_local]  &apos;</div><div class="line">    &apos;&quot;$request&quot; $status $bytes_sent &apos;</div><div class="line">    &apos;&quot;$http_referer&quot; &quot;$http_user_agent&quot; &apos;</div><div class="line">    &apos;&quot;$gzip_ratio&quot;&apos;;</div><div class="line"></div><div class="line">  log_format download  &apos;$remote_addr - $remote_user [$time_local]  &apos;</div><div class="line">    &apos;&quot;$request&quot; $status $bytes_sent &apos;</div><div class="line">    &apos;&quot;$http_referer&quot; &quot;$http_user_agent&quot; &apos;</div><div class="line">    &apos;&quot;$http_range&quot; &quot;$sent_http_content_range&quot;&apos;;</div><div class="line"></div><div class="line">  # HTTP请求,客户端相关设置</div><div class="line">  client_header_timeout  3m;</div><div class="line">  client_body_timeout    3m;</div><div class="line">  send_timeout           3m;</div><div class="line"></div><div class="line">  client_header_buffer_size    1k;</div><div class="line">  large_client_header_buffers  4 4k;</div><div class="line"></div><div class="line">  # 消息发送时开启gzip设置</div><div class="line">  gzip on;</div><div class="line">  gzip_min_length  1100;</div><div class="line">  gzip_buffers     4 8k;</div><div class="line">  gzip_types       text/plain;</div><div class="line"></div><div class="line">  output_buffers   1 32k;</div><div class="line">  postpone_output  1460;</div><div class="line"></div><div class="line">  sendfile         on;</div><div class="line">  tcp_nopush       on;</div><div class="line"></div><div class="line">  tcp_nodelay      on;</div><div class="line">  send_lowat       12000;</div><div class="line"></div><div class="line">  keepalive_timeout  75 20;</div><div class="line"></div><div class="line">  # lingering_time     30;</div><div class="line">  # lingering_timeout  10;</div><div class="line">  # reset_timedout_connection  on;</div><div class="line"></div><div class="line"></div><div class="line">  server &#123;</div><div class="line">    listen        one.example.com;</div><div class="line">    server_name   one.example.com  www.one.example.com;</div><div class="line"></div><div class="line">    access_log   /var/log/nginx.access_log  main;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">      proxy_pass         http://127.0.0.1/;</div><div class="line">      proxy_redirect     off;</div><div class="line"></div><div class="line">      proxy_set_header   Host             $host;</div><div class="line">      proxy_set_header   X-Real-IP        $remote_addr;</div><div class="line">      # proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;</div><div class="line"></div><div class="line">      client_max_body_size       10m;</div><div class="line">      client_body_buffer_size    128k;</div><div class="line"></div><div class="line">      client_body_temp_path      /var/nginx/client_body_temp;</div><div class="line"></div><div class="line">      proxy_connect_timeout      90;</div><div class="line">      proxy_send_timeout         90;</div><div class="line">      proxy_read_timeout         90;</div><div class="line">      proxy_send_lowat           12000;</div><div class="line"></div><div class="line">      proxy_buffer_size          4k;</div><div class="line">      proxy_buffers              4 32k;</div><div class="line">      proxy_busy_buffers_size    64k;</div><div class="line">      proxy_temp_file_write_size 64k;</div><div class="line"></div><div class="line">      proxy_temp_path            /var/nginx/proxy_temp;</div><div class="line"></div><div class="line">      charset  koi8-r;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    error_page  404  /404.html;</div><div class="line"></div><div class="line">    location /404.html &#123;</div><div class="line">      root  /spool/www;</div><div class="line"></div><div class="line">      charset         on;</div><div class="line">      source_charset  koi8-r;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location /old_stuff/ &#123;</div><div class="line">      rewrite   ^/old_stuff/(.*)$  /new_stuff/$1  permanent;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location /download/ &#123;</div><div class="line">      valid_referers  none  blocked  server_names  *.example.com;</div><div class="line"></div><div class="line">      if ($invalid_referer) &#123;</div><div class="line">        #rewrite   ^/   http://www.example.com/;</div><div class="line">        return   403;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      # rewrite_log  on;</div><div class="line">      # rewrite /download/*/mp3/*.any_ext to /download/*/mp3/*.mp3</div><div class="line">      rewrite ^/(download/.*)/mp3/(.*)\..*$ /$1/mp3/$2.mp3 break;</div><div class="line"></div><div class="line">      root         /spool/www;</div><div class="line">      # autoindex    on;</div><div class="line">      access_log   /var/log/nginx-download.access_log  download;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location ~* ^.+\.(jpg|jpeg|gif)$ &#123;</div><div class="line">      root         /spool/www;</div><div class="line">      access_log   off;</div><div class="line">      expires      30d;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/05/nginx/nginx配置/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/05/nginx/nginx配置/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/04/杂记/java游戏服务器/" title="Java游戏服务器设计" itemprop="url">Java游戏服务器设计</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-04T08:00:00.000Z" itemprop="datePublished"> Published 2016-03-04</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>从毕业就开始在游戏行业摸爬滚打,至今4年将至,今天特意总结一下这四年来的心得.</p>
<p>现在的游戏服务器大多采用Netty作为网络传输层,然后采用Reactor模型将消息转发到业务线程池中进行执行,然后在业务线程池中进行CPU计算,数据库IO操作,最后将结果返回给前端.</p>
<p>这样的游戏服务器在压测的时候在线玩家不会超过2000人,而且经常会出现比较大的延迟,因为有的IO操作真的很耗时. </p>
<p>在上个项目中我见到了这样一种设计,仍然是采用Netty完成网络层Socket数据读取发送工作,然后将解码出的数据扔到俩个消息队列里面去(采用Vertx的EventBus实现). 一个消息队列负责登录请求,一个消息队列负责整个游戏的业务逻辑. 这么着一来整个游戏的业务就不会出现数据竞争的情况. 然后再定时的将数据写到redis里面去. 这种设计在压测的时候达到了10000人的同时在线规模. (当然还有很多优化的地方, 例如在消息查找的时候采取ASM而不是低效的JDK反射, 但是并没有对JVM和Netty进行过特殊优化, 只是对JVM的新生代的分区将8:1:1改成了6:2:2)</p>
<p>前俩天和一些游戏团队的人聊了聊,他们一致认为这种设计方式没有能充分的利用上主机多核的优势, 但是在Reactor的模型中, 主线程池和工作线程池都是需要CPU来运算的, 如果所有的CPU运算都来支持业务逻辑, 那么玩家一样会感觉到卡顿. 而且我们还可以对刚才的设计进行优化, 将不同模块业务放到不同的线程进行. 例如在Thread1中进行玩家自己的业务逻辑运算, 在Thread2中进行公会模块的业务计算, 当公会对玩家本身数据产生影响的时候, 我们可以让公会线程给玩家的业务线程发送消息(同样的使用消息队列). 这么着也能最大可能的利用多核优势同时让开发人员少的思考数据竞争出现的问题, 现在大多数的开发人员在处理数据竞争的时候还是较多的使用synchronized这种加锁方式(有些底层的接口也有可能使用读写锁, 但是使用锁, 在大规模用户的情况下,真的比较耗时).</p>
<p>还有一点需要说的是, 在上个项目中,只使用到了很少的数据库表, 基本上玩家数据都存储到了一张表里, 当定时存储的时候,将玩家数据整个序列化成一个JSON串, 然后入库. 这么做有显而易见的好处,在分服的游戏中, 合服很容易而且在线上出现问题的时候,也很容易拿到一个玩家的数据进行问题排查. 而且在线上的时候也会出现因为异常而导致玩家刷材料等等, 因此如果在处理消息之前, 拿一个玩家备份的数据让玩家去操作,一旦出现数据异常也不会对玩家自己的数据造成影响. (需要考虑的是大量的序列号和反序列化会造成大量的GC操作.)</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/杂记/">杂记</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/04/杂记/java游戏服务器/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/04/杂记/java游戏服务器/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/02/nosql/jedis/" title="Jedis 初探" itemprop="url">Jedis 初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-02T08:00:00.000Z" itemprop="datePublished"> Published 2016-03-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="using-Jedis-in-a-multithreaded-environment"><a href="#using-Jedis-in-a-multithreaded-environment" class="headerlink" title="using Jedis in a multithreaded environment"></a>using Jedis in a multithreaded environment</h2><p>我们不应该在多线程的情况下使用同一个Jedis实例对象, 因为在Jedis本身不是线程安全的, 它可能会引发一些奇奇怪怪的问题. 但是如果我们在每个线程中都创建一个Jedis实例对象的话这也是不可取的, 因为每个Jedis对象的创建都意味着socket和网络连接的创建. 为了避免这种情况,我们应该使用<code>JedisPool</code>, 它是一个线程安全的网络连接池. 我们可以通过池子创建多个Jedis实例对象, 当使用完之后再将它返回给池子.</p>
<p>在下面的实例中我们初始化一个池子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">JedisPool pool = <span class="keyword">new</span> JedisPool(<span class="keyword">new</span> JedisPoolConfig(), <span class="string">"localhost"</span>);</div></pre></td></tr></table></figure></p>
<p>因为JedisPool是线程安全的, 因此我们可以将它缓存起来, 供所有线程使用.</p>
<p><code>JedisPoolConfig</code>包含了一个丰富有用的Redis连接配置参数. <code>JedisPoolConfig</code>基于<a href="http://commons.apache.org/proper/commons-pool/apidocs/org/apache/commons/pool2/impl/GenericObjectPoolConfig.html" target="_blank" rel="external">Commons Pool 2</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// Jedis implements Closable. Hence, the jedis instance will be auto-closed after the last statement.</span></div><div class="line"><span class="keyword">try</span> (Jedis jedis = pool.getResource()) &#123;</div><div class="line">  <span class="comment">/// ... do stuff here ... for example</span></div><div class="line">  jedis.set(<span class="string">"foo"</span>, <span class="string">"bar"</span>);</div><div class="line">  String foobar = jedis.get(<span class="string">"foo"</span>);</div><div class="line">  jedis.zadd(<span class="string">"sose"</span>, <span class="number">0</span>, <span class="string">"car"</span>); jedis.zadd(<span class="string">"sose"</span>, <span class="number">0</span>, <span class="string">"bike"</span>);</div><div class="line">  Set&lt;String&gt; sose = jedis.zrange(<span class="string">"sose"</span>, <span class="number">0</span>, -<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="comment">/// ... when closing your application:</span></div><div class="line">pool.destroy();</div></pre></td></tr></table></figure>
<p>如果你不喜欢<code>try-with-resource</code>这种语法, 那么你可以使用<code>Jedis.close()</code>.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Jedis jedis = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  jedis = pool.getResource();</div><div class="line">  <span class="comment">/// ... do stuff here ... for example</span></div><div class="line">  jedis.set(<span class="string">"foo"</span>, <span class="string">"bar"</span>);</div><div class="line">  String foobar = jedis.get(<span class="string">"foo"</span>);</div><div class="line">  jedis.zadd(<span class="string">"sose"</span>, <span class="number">0</span>, <span class="string">"car"</span>); jedis.zadd(<span class="string">"sose"</span>, <span class="number">0</span>, <span class="string">"bike"</span>);</div><div class="line">  Set&lt;String&gt; sose = jedis.zrange(<span class="string">"sose"</span>, <span class="number">0</span>, -<span class="number">1</span>);</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">  <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</div><div class="line">    jedis.close();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/// ... when closing your application:</span></div><div class="line">pool.destroy();</div></pre></td></tr></table></figure></p>
<p>If Jedis was borrowed from pool, it will be returned to pool with proper method since it already determines there was JedisConnectionException occurred. If Jedis wasn’t borrowed from pool, it will be disconnected and closed.</p>
<p>下来我们来看一段测试代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</div><div class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JedisTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        JedisPoolConfig jedisPoolConfig = <span class="keyword">new</span> JedisPoolConfig();</div><div class="line">        jedisPoolConfig.setMaxTotal(<span class="number">10</span>);</div><div class="line">        JedisPool pool = <span class="keyword">new</span> JedisPool(jedisPoolConfig, <span class="string">"10.1.4.110"</span>);</div><div class="line">        System.out.println(<span class="string">"begin : "</span> + pool.getNumActive());</div><div class="line">        System.out.println(<span class="string">"begin : "</span> + pool.getNumIdle());</div><div class="line">        System.out.println(<span class="string">"begin : "</span> + pool.getNumWaiters());</div><div class="line">        Jedis jedis = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            jedis = pool.getResource();</div><div class="line">            System.out.println(<span class="string">"borrow : "</span> + pool.getNumActive());</div><div class="line">            System.out.println(<span class="string">"borrow : "</span> + pool.getNumIdle());</div><div class="line">            System.out.println(<span class="string">"borrow : "</span> + pool.getNumWaiters());</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</div><div class="line">                jedis.close();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        System.out.println(<span class="string">"return : "</span> + pool.getNumActive());</div><div class="line">        System.out.println(<span class="string">"return : "</span> + pool.getNumIdle());</div><div class="line">        System.out.println(<span class="string">"return : "</span> + pool.getNumWaiters());</div><div class="line">        pool.destroy();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">begin : <span class="number">0</span></div><div class="line">begin : <span class="number">0</span></div><div class="line">begin : <span class="number">0</span></div><div class="line">borrow : <span class="number">1</span></div><div class="line">borrow : <span class="number">0</span></div><div class="line">borrow : <span class="number">0</span></div><div class="line"><span class="keyword">return</span> : <span class="number">0</span></div><div class="line"><span class="keyword">return</span> : <span class="number">1</span></div><div class="line"><span class="keyword">return</span> : <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>当调用<code>jedis.close();</code>后,池子里空闲的Jedis对象就多了1个, 可是如果我们注释掉这一行后的结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">begin : <span class="number">0</span></div><div class="line">begin : <span class="number">0</span></div><div class="line">begin : <span class="number">0</span></div><div class="line">borrow : <span class="number">1</span></div><div class="line">borrow : <span class="number">0</span></div><div class="line">borrow : <span class="number">0</span></div><div class="line"><span class="keyword">return</span> : <span class="number">1</span></div><div class="line"><span class="keyword">return</span> : <span class="number">0</span></div><div class="line"><span class="keyword">return</span> : <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>我们发现那个Jedis仍然处于激活状态, 在Jedis 2.8.0版本以前当我们从池子里借用一个Jedis之后还需要将其还回去<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Jedis resource)</span> </span>&#123;</div><div class="line">    jedisPool.returnResource(resource);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是现在已经不需要了, 而且Jedis已经将这个<code>returnResource()</code>的方法舍弃掉了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** <span class="doctag">@deprecated</span> */</span></div><div class="line"><span class="meta">@Deprecated</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnResource</span><span class="params">(Jedis resource)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span>(resource != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            resource.resetState();</div><div class="line">            <span class="keyword">this</span>.returnResourceObject(resource);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception var3) &#123;</div><div class="line">            <span class="keyword">this</span>.returnBrokenResource(resource);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JedisException(<span class="string">"Could not return the resource to the pool"</span>, var3);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来我们看一下多线程情况<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JedisTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        JedisPoolConfig jedisPoolConfig = <span class="keyword">new</span> JedisPoolConfig();</div><div class="line">        jedisPoolConfig.setMaxTotal(<span class="number">3</span>);</div><div class="line">        JedisPool pool = <span class="keyword">new</span> JedisPool(jedisPoolConfig, <span class="string">"10.1.4.110"</span>);</div><div class="line">        List&lt;Thread&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</div><div class="line">            Runnable runnable = () -&gt; &#123;</div><div class="line">                Jedis jedis = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    jedis = pool.getResource();</div><div class="line">                    <span class="keyword">int</span> sleep = <span class="keyword">new</span> Random().nextInt(<span class="number">5</span>);</div><div class="line">                    System.out.println(<span class="string">"sleep:"</span> + sleep + <span class="string">". time:"</span> + <span class="keyword">new</span> Date().toLocaleString() + <span class="string">". active: "</span> + pool.getNumActive() + <span class="string">". idle: "</span> + pool.getNumIdle());</div><div class="line"></div><div class="line">                    TimeUnit.SECONDS.sleep(sleep);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</div><div class="line">                        jedis.close();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line">            list.add(<span class="keyword">new</span> Thread(runnable));</div><div class="line">        &#125;</div><div class="line">        list.forEach(thread -&gt; thread.start());</div><div class="line"></div><div class="line">        Thread.currentThread().join();</div><div class="line">        pool.destroy();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sleep:<span class="number">4</span>. time:<span class="number">2016</span>-<span class="number">3</span>-<span class="number">4</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">03</span>. active: <span class="number">3</span>. idle: <span class="number">0</span></div><div class="line">sleep:<span class="number">4</span>. time:<span class="number">2016</span>-<span class="number">3</span>-<span class="number">4</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">03</span>. active: <span class="number">3</span>. idle: <span class="number">0</span></div><div class="line">sleep:<span class="number">3</span>. time:<span class="number">2016</span>-<span class="number">3</span>-<span class="number">4</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">03</span>. active: <span class="number">3</span>. idle: <span class="number">0</span></div><div class="line">sleep:<span class="number">3</span>. time:<span class="number">2016</span>-<span class="number">3</span>-<span class="number">4</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">06</span>. active: <span class="number">3</span>. idle: <span class="number">0</span></div><div class="line">sleep:<span class="number">3</span>. time:<span class="number">2016</span>-<span class="number">3</span>-<span class="number">4</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">07</span>. active: <span class="number">2</span>. idle: <span class="number">1</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/NoSql/">NoSql</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/02/nosql/jedis/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/02/nosql/jedis/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/02/22/JavaLibrary/Netty ServerBootstrap/" title="NettyServerBootstrap" itemprop="url">NettyServerBootstrap</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-02-22T08:00:00.000Z" itemprop="datePublished"> Published 2016-02-22</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我们首先给出一个Netty上的一个Example示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="keyword">int</span> cpuSize = Runtime.getRuntime().availableProcessors();</div><div class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</div><div class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup(cpuSize);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();</div><div class="line">            b.group(bossGroup, workerGroup)</div><div class="line">                    .channel(NioServerSocketChannel.class)</div><div class="line">                    .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</div><div class="line">                    .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</div><div class="line">                    .option(ChannelOption.AUTO_READ, <span class="keyword">true</span>)</div><div class="line">                    .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> </span>&#123;</div><div class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> InHandler());</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line"></div><div class="line">            ChannelFuture f = b.bind(<span class="number">8881</span>).sync();</div><div class="line">            f.channel().closeFuture().sync();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            bossGroup.shutdownGracefully();</div><div class="line">            workerGroup.shutdownGracefully();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> </span>&#123;</div><div class="line">        ctx.write(msg);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</div><div class="line">        ctx.flush();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在这个示例中, 我们采用了主从Reactor线程模型, 然后将接受到的数据写回给客户端.</p>
<p>下来我们分析一下<code>ServerBootstrap</code>的源码. 我们从<code>bind()</code>方法入手.</p>
<p>由于<code>bind()</code>最终调用的是父类<code>AbstractBootstrap</code>的<code>doBind()</code>方法, 因此我们从父类入手<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ChannelFuture <span class="title">doBind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress)</span> </span>&#123;</div><div class="line">				<span class="comment">// 初始化NioServerSocketChannel, 并将其注册主Reactor线程池的IO多路复用器上</span></div><div class="line">        <span class="keyword">final</span> ChannelFuture regFuture = initAndRegister();</div><div class="line">        <span class="keyword">final</span> Channel channel = regFuture.channel();</div><div class="line">        <span class="keyword">if</span> (regFuture.isDone()) &#123;</div><div class="line">            ChannelPromise promise = channel.newPromise();</div><div class="line">            doBind0(regFuture, channel, localAddress, promise);</div><div class="line">            <span class="keyword">return</span> promise;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ...</div><div class="line">            <span class="keyword">return</span> promise;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>接下来我们看一下<code>AbstractBootstrap#initAndRegister()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> ChannelFuture <span class="title">initAndRegister</span><span class="params">()</span> </span>&#123;</div><div class="line">				<span class="comment">// 因为我们调用过channel(NioServerSocketChannel.class)方法, 因此下面这个Channel是NioServerSocketChannel类型</span></div><div class="line">        <span class="keyword">final</span> Channel channel = channelFactory().newChannel();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">					  <span class="comment">// init方法主要是对NioServerSocketChannel添加一个ServerBootstrapAcceptor的Handler(继承自ChannelInboundHandlerAdapter)</span></div><div class="line">            <span class="comment">// 当channel接受到网络连接的时候, 会生成NioSocketChannel, 将NioSocketChannel与从Reactor进行绑定</span></div><div class="line">            init(channel);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">				<span class="comment">// 将Reactor模型中的主Reactor线程注册到NioServerSocketChannel的Unsafe对象里.</span></div><div class="line">				<span class="comment">// 此时就将NioServerSocketChannel与Reactor主线程关联起来了</span></div><div class="line">				ChannelFuture regFuture = group().register(channel);</div><div class="line">        <span class="keyword">if</span> (regFuture.cause() != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (channel.isRegistered()) &#123;</div><div class="line">                channel.close();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                channel.unsafe().closeForcibly();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p><code>init()</code>的<code>ServerBootstrap</code>实现的. 这个方法主要是在<code>NioServerSocketChannel</code>的pipeline里增加一个<code>ServerBootstrapAcceptor</code>handler.<br>这个handler就是用于处理<code>NioMessageUnsafe#read()</code>方法调用<code>NioServerSocketChannel#doReadMessage()</code>方法后<code>List&lt;NioSocketChannel&gt;</code>的消息列表<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">			 <span class="comment">// 获取NioServerSocketChannel的Pipeline</span></div><div class="line">			 ChannelPipeline p = channel.pipeline();</div><div class="line">			 <span class="keyword">if</span> (handler() != <span class="keyword">null</span>) &#123;</div><div class="line">					 p.addLast(handler());</div><div class="line">			 &#125;</div><div class="line"></div><div class="line">			 <span class="keyword">final</span> EventLoopGroup currentChildGroup = childGroup;</div><div class="line">			 <span class="keyword">final</span> ChannelHandler currentChildHandler = childHandler;</div><div class="line">			 <span class="keyword">final</span> Entry&lt;ChannelOption&lt;?&gt;, Object&gt;[] currentChildOptions;</div><div class="line">			 <span class="keyword">final</span> Entry&lt;AttributeKey&lt;?&gt;, Object&gt;[] currentChildAttrs;</div><div class="line"></div><div class="line">			 p.addLast(<span class="keyword">new</span> ChannelInitializer&lt;Channel&gt;() &#123;</div><div class="line">					 <span class="meta">@Override</span></div><div class="line">					 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(Channel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">						 	 <span class="comment">// 这里主要是产生网络连接时将处理数据的channel与Reactor从线程关联起来</span></div><div class="line">							 ch.pipeline().addLast(<span class="keyword">new</span> ServerBootstrapAcceptor(</div><div class="line">											 currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));</div><div class="line">					 &#125;</div><div class="line">			 &#125;);</div><div class="line">	 &#125;</div></pre></td></tr></table></figure></p>
<p>我们看到<code>ServerBootstrapAcceptor</code>也是实现自<code>ChannelInboundHandlerAdapter</code>, 因此它也是一个handler. 在<code>NioMessageUnsafe#read()</code>方法里会遍历<br><code>List&lt;NioSocketChannel&gt;</code>这个消息列表后触发<code>NioServerSocketChannel</code>的pipeline的<code>fireChannelRead()</code>方法, 接着就会触发<code>ServerBootstrapAcceptor#channelRead()</code>,<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerBootstrapAcceptor</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> EventLoopGroup childGroup;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ChannelHandler childHandler;</div><div class="line">        ServerBootstrapAcceptor(</div><div class="line">                EventLoopGroup childGroup, ChannelHandler childHandler) &#123;</div><div class="line">            <span class="keyword">this</span>.childGroup = childGroup;</div><div class="line">            <span class="keyword">this</span>.childHandler = childHandler;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> </span>&#123;</div><div class="line">            <span class="comment">// msg实际是NioSocketChannel类型</span></div><div class="line">            <span class="keyword">final</span> Channel child = (Channel) msg;</div><div class="line">            child.pipeline().addLast(childHandler);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">							  <span class="comment">// 将处理数据的NioSocketChannel与主从Reactor模型中的从Reactor线程关联起来</span></div><div class="line">                childGroup.register(child).addListener(<span class="keyword">new</span> ChannelFutureListener());</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>然后我们看一下<code>NioEventLoop</code>的<code>register()</code>方法过程. 这个方法调用其实最终调用的是<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">SingleThreadEventLoop</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line">	 <span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">register</span><span class="params">(<span class="keyword">final</span> Channel channel, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">			 channel.unsafe().register(<span class="keyword">this</span>, promise);</div><div class="line">			 <span class="keyword">return</span> promise;</div><div class="line">	 &#125;</div></pre></td></tr></table></figure></p>
<p>然后后续调用到了<code>AbstractUnsafe</code>的<code>register()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(EventLoop eventLoop, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">              AbstractChannel.<span class="keyword">this</span>.eventLoop = eventLoop;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (eventLoop.inEventLoop()) &#123;</div><div class="line">                register0(promise);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    eventLoop.execute(<span class="keyword">new</span> OneTimeTask() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                            register0(promise);</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">				<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register0</span><span class="params">(ChannelPromise promise)</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                doRegister();</div><div class="line">                pipeline.fireChannelRegistered();</div><div class="line">                <span class="comment">// Only fire a channelActive if the channel has never been registered. This prevents firing</span></div><div class="line">                <span class="comment">// multiple channel actives if the channel is deregistered and re-registered.</span></div><div class="line">                <span class="keyword">if</span> (firstRegistration &amp;&amp; isActive()) &#123;</div><div class="line">                    pipeline.fireChannelActive();</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>接着调用<code>AbstractNioChannel</code>的<code>doRegister()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegister</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> selected = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                selectionKey = javaChannel().register(eventLoop().selector, <span class="number">0</span>, <span class="keyword">this</span>);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>最终我们看到了, 当前JDK里的Channel注册到了EventLoop的IO多路复用器上面</p>
<p>看到这里之后, 我们再接着返回到<code>doBind()</code>方法继续看<code>doBind0()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doBind0</span><span class="params">(</span></span></div><div class="line">            <span class="keyword">final</span> ChannelFuture regFuture, <span class="keyword">final</span> Channel channel,</div><div class="line">            <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise) &#123;</div><div class="line"></div><div class="line">        <span class="comment">// This method is invoked before channelRegistered() is triggered.  Give user handlers a chance to set up</span></div><div class="line">        <span class="comment">// the pipeline in its channelRegistered() implementation.</span></div><div class="line">        channel.eventLoop().execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (regFuture.isSuccess()) &#123;</div><div class="line">                    channel.bind(localAddress, promise).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    promise.setFailure(regFuture.cause());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>我们看到当在bind的时候也是调用的channel的bind(), 真实的bind是在<code>AbstractChannel</code>里发生的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> pipeline.bind(localAddress, promise);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后调用的是<code>DefaultChannelPipeline</code>的<code>bind()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"> <span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;</div><div class="line">		 <span class="keyword">return</span> tail.bind(localAddress, promise);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>再具体的bind的话, 就要参考<code>DeaultChannelPipeline</code>的实现了</p>
<p>最后我们总结一下</p>
<ol>
<li>首先将NioServerSocketChannel与主Reactor线程池的Selector进行注册绑定</li>
<li>当NioServerSocketChannel接收到网络连接的时候(doReadMessage())会生成一个<code>NioSocketChannel</code>的消息列表</li>
<li>然后<code>ServerBootstrapAcceptor</code>负责将<code>NioSocketChannel</code>与从Reactor的Selector进行注册绑定</li>
<li>最后由从Reactor线程池中的Selector进行IO调度, 读写网络数据</li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Netty/">Netty</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/02/22/JavaLibrary/Netty ServerBootstrap/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/02/22/JavaLibrary/Netty ServerBootstrap/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/02/03/JavaLibrary/MessagePack 初探/" title="MessagePack 初探" itemprop="url">MessagePack 初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-02-03T08:00:00.000Z" itemprop="datePublished"> Published 2016-02-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>MessagePack 是一个高效的二进制数据序列化工具. 使用它可以让你像使用JSON那样在多种语言中进行数据交换, 但是它比JSON更加小巧,迅捷.</p>
<p>在Java中使用的话, 我们首先添加maven依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.msgpack<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>msgpack<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>首先看一个简单的示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.msgpack.MessagePack;</div><div class="line"><span class="keyword">import</span> org.msgpack.annotation.Message;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main1</span> </span>&#123;</div><div class="line">    <span class="meta">@Message</span> <span class="comment">// Annotation</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMessage</span> </span>&#123;</div><div class="line">        <span class="comment">// public fields are serialized.</span></div><div class="line">        <span class="keyword">public</span> String name;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">double</span> version;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        MyMessage src = <span class="keyword">new</span> MyMessage();</div><div class="line">        src.name = <span class="string">"msgpack"</span>;</div><div class="line">        src.version = <span class="number">0.6</span>;</div><div class="line"></div><div class="line">        MessagePack msgpack = <span class="keyword">new</span> MessagePack();</div><div class="line">        <span class="comment">// Serialize</span></div><div class="line">        <span class="keyword">byte</span>[] bytes = msgpack.write(src);</div><div class="line">        <span class="comment">// Deserialize</span></div><div class="line">        MyMessage dst = msgpack.read(bytes, MyMessage.class);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在上面的例子中我们看到将一个<code>MyMessage</code>序列化成byte数组, 同时又将其反序列化出来了. 但是如果我们要同时序列化多个对象呢？那么我们就可以使用<code>Packer</code>和<code>Unpacker</code>.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</div><div class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.msgpack.MessagePack;</div><div class="line"><span class="keyword">import</span> org.msgpack.annotation.Message;</div><div class="line"><span class="keyword">import</span> org.msgpack.packer.Packer;</div><div class="line"><span class="keyword">import</span> org.msgpack.unpacker.Unpacker;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main2</span> </span>&#123;</div><div class="line">    <span class="meta">@Message</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMessage</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> String name;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">double</span> version;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        MyMessage src1 = <span class="keyword">new</span> MyMessage();</div><div class="line">        src1.name = <span class="string">"msgpack"</span>;</div><div class="line">        src1.version = <span class="number">0.6</span>;</div><div class="line">        MyMessage src2 = <span class="keyword">new</span> MyMessage();</div><div class="line">        src2.name = <span class="string">"muga"</span>;</div><div class="line">        src2.version = <span class="number">10.0</span>;</div><div class="line">        MyMessage src3 = <span class="keyword">new</span> MyMessage();</div><div class="line">        src3.name = <span class="string">"frsyukik"</span>;</div><div class="line">        src3.version = <span class="number">1.0</span>;</div><div class="line"></div><div class="line">        MessagePack msgpack = <span class="keyword">new</span> MessagePack();</div><div class="line">        <span class="comment">// Serialize</span></div><div class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        Packer packer = msgpack.createPacker(out);</div><div class="line">        packer.write(src1);</div><div class="line">        packer.write(src2);</div><div class="line">        packer.write(src3);</div><div class="line">        <span class="keyword">byte</span>[] bytes = out.toByteArray();</div><div class="line"></div><div class="line">        <span class="comment">// Deserialize</span></div><div class="line">        ByteArrayInputStream in = <span class="keyword">new</span> ByteArrayInputStream(bytes);</div><div class="line">        Unpacker unpacker = msgpack.createUnpacker(in);</div><div class="line">        MyMessage dst1 = unpacker.read(MyMessage.class);</div><div class="line">        MyMessage dst2 = unpacker.read(MyMessage.class);</div><div class="line">        MyMessage dst3 = unpacker.read(MyMessage.class);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其实<code>Packer</code>和<code>Unpacker</code>内置了非常多了序列化类型<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</div><div class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</div><div class="line"><span class="keyword">import</span> java.math.BigInteger;</div><div class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.msgpack.MessagePack;</div><div class="line"><span class="keyword">import</span> org.msgpack.packer.Packer;</div><div class="line"><span class="keyword">import</span> org.msgpack.unpacker.Unpacker;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main3</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        MessagePack msgpack = <span class="keyword">new</span> MessagePack();</div><div class="line"></div><div class="line">        <span class="comment">// Serialization</span></div><div class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">        Packer packer = msgpack.createPacker(out);</div><div class="line"></div><div class="line">        <span class="comment">// 对原生类型进行序列化</span></div><div class="line">        packer.write(<span class="keyword">true</span>); <span class="comment">// boolean value</span></div><div class="line">        packer.write(<span class="number">10</span>); <span class="comment">// int value</span></div><div class="line">        packer.write(<span class="number">10.5</span>); <span class="comment">// double value</span></div><div class="line"></div><div class="line">        <span class="comment">// 对原生包装类型进行序列化</span></div><div class="line">        packer.write(Boolean.TRUE);</div><div class="line">        packer.write(<span class="keyword">new</span> Integer(<span class="number">10</span>));</div><div class="line">        packer.write(<span class="keyword">new</span> Double(<span class="number">10.5</span>));</div><div class="line"></div><div class="line">        <span class="comment">// 对数组进行序列化</span></div><div class="line">        packer.write(<span class="keyword">new</span> <span class="keyword">int</span>[] &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span> &#125;);</div><div class="line">        packer.write(<span class="keyword">new</span> Double[] &#123; <span class="number">10.5</span>, <span class="number">20.5</span> &#125;);</div><div class="line">        packer.write(<span class="keyword">new</span> String[] &#123; <span class="string">"msg"</span>, <span class="string">"pack"</span>, <span class="string">"for"</span>, <span class="string">"java"</span> &#125;);</div><div class="line">        packer.write(<span class="keyword">new</span> <span class="keyword">byte</span>[] &#123; <span class="number">0x30</span>, <span class="number">0x31</span>, <span class="number">0x32</span> &#125;); <span class="comment">// byte array</span></div><div class="line"></div><div class="line">        <span class="comment">// 对其他引用类型进行序列化</span></div><div class="line">        packer.write(<span class="string">"MessagePack"</span>); <span class="comment">// String object</span></div><div class="line">        packer.write(ByteBuffer.wrap(<span class="keyword">new</span> <span class="keyword">byte</span>[] &#123; <span class="number">0x30</span>, <span class="number">0x31</span>, <span class="number">0x32</span> &#125;)); <span class="comment">// ByteBuffer object</span></div><div class="line">        packer.write(BigInteger.ONE); <span class="comment">// BigInteger object</span></div><div class="line"></div><div class="line">        <span class="comment">// 反序列化</span></div><div class="line">        <span class="keyword">byte</span>[] bytes = out.toByteArray();</div><div class="line">        ByteArrayInputStream in = <span class="keyword">new</span> ByteArrayInputStream(bytes);</div><div class="line">        Unpacker unpacker = msgpack.createUnpacker(in);</div><div class="line"></div><div class="line">        <span class="comment">// 反序列化出原生类型</span></div><div class="line">        <span class="keyword">boolean</span> b = unpacker.readBoolean(); <span class="comment">// boolean value</span></div><div class="line">        <span class="keyword">int</span> i = unpacker.readInt(); <span class="comment">// int value</span></div><div class="line">        <span class="keyword">double</span> d = unpacker.readDouble(); <span class="comment">// double value</span></div><div class="line"></div><div class="line">        <span class="comment">// 反序列化出原生包装类型</span></div><div class="line">        Boolean wb = unpacker.read(Boolean.class);</div><div class="line">        Integer wi = unpacker.read(Integer.class);</div><div class="line">        Double wd = unpacker.read(Double.class);</div><div class="line"></div><div class="line">        <span class="comment">// 反序列化出数组</span></div><div class="line">        <span class="keyword">int</span>[] ia = unpacker.read(<span class="keyword">int</span>[].class);</div><div class="line">        Double[] da = unpacker.read(Double[].class);</div><div class="line">        String[] sa = unpacker.read(String[].class);</div><div class="line">        <span class="keyword">byte</span>[] ba = unpacker.read(<span class="keyword">byte</span>[].class);</div><div class="line"></div><div class="line">        <span class="comment">// 反序列化出 String, ByteBuffer, BigInteger, List 和 Map</span></div><div class="line">        String ws = unpacker.read(String.class);</div><div class="line">        ByteBuffer buf = unpacker.read(ByteBuffer.class);</div><div class="line">        BigInteger bi = unpacker.read(BigInteger.class);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对于<code>List, Map</code>这俩种类型的序列化, 我们需要额外说明一下. 在序列化<code>List, Map</code>的时候, 我们需要使用<code>Template</code>对其进行转换.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</div><div class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</div><div class="line"><span class="keyword">import</span> java.util.*;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.msgpack.MessagePack;</div><div class="line"><span class="keyword">import</span> org.msgpack.packer.Packer;</div><div class="line"><span class="keyword">import</span> org.msgpack.template.Template;</div><div class="line"><span class="keyword">import</span> org.msgpack.unpacker.Unpacker;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.msgpack.template.Templates.tList;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.msgpack.template.Templates.tMap;</div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.msgpack.template.Templates.TString;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main4</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        MessagePack msgpack = <span class="keyword">new</span> MessagePack();</div><div class="line"></div><div class="line">		<span class="comment">// 创建序列化/反序列化 List 和 Map 对象的模板</span></div><div class="line">		Template&lt;List&lt;String&gt;&gt; listTmpl = tList(TString);</div><div class="line">		Template&lt;Map&lt;String, String&gt;&gt; mapTmpl = tMap(TString, TString);</div><div class="line"></div><div class="line">		<span class="comment">// 开始序列化</span></div><div class="line">		ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">		Packer packer = msgpack.createPacker(out);</div><div class="line"></div><div class="line">		<span class="comment">// 序列化 List 对象</span></div><div class="line">		List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">		list.add(<span class="string">"msgpack"</span>);</div><div class="line">		list.add(<span class="string">"for"</span>);</div><div class="line">		list.add(<span class="string">"java"</span>);</div><div class="line">		packer.write(list); <span class="comment">// List object</span></div><div class="line"></div><div class="line">		<span class="comment">// 序列化 Map 对象</span></div><div class="line">		Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line">		map.put(<span class="string">"sadayuki"</span>, <span class="string">"furuhashi"</span>);</div><div class="line">		map.put(<span class="string">"muga"</span>, <span class="string">"nishizawa"</span>);</div><div class="line">		packer.write(map); <span class="comment">// Map object</span></div><div class="line"></div><div class="line">		<span class="comment">// 开始反序列化</span></div><div class="line">		<span class="keyword">byte</span>[] bytes = out.toByteArray();</div><div class="line">		ByteArrayInputStream in = <span class="keyword">new</span> ByteArrayInputStream(bytes);</div><div class="line">		Unpacker unpacker = msgpack.createUnpacker(in);</div><div class="line"></div><div class="line">		<span class="comment">// 反序列化出 List 对象</span></div><div class="line">		List&lt;String&gt; dstList = unpacker.read(listTmpl);</div><div class="line"></div><div class="line">		<span class="comment">//  反序列化出 Map 对象</span></div><div class="line">		Map&lt;String, String&gt; dstMap = unpacker.read(mapTmpl);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>有时候我们可能没有办法将POJO类添加上<code>Message</code>注解(可能没有访问那个类的权限), 但是我们又想对其进行序列化, 那怎么办呢？<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">MessagePack msgpack = <span class="keyword">new</span> MessagePack();</div><div class="line">msgpack.<span class="keyword">register</span>(MyMessage2.<span class="keyword">class</span>);</div></pre></td></tr></table></figure></p>
<p>我们只要向需要序列化的类注册到<code>MessagePack</code>上就可以了.</p>
<p>有时候,我们可能不需要对某个属性进行序列化, 例如线上某个老版本里并没有A属性, 但是在新的版本里填上了A属性, 但是又要兼容老版本怎么办呢？我们可以使用<code>@Optional</code>注解<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Message</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMessage</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> String name;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">double</span> version;</div><div class="line"></div><div class="line">    <span class="comment">// new field</span></div><div class="line">    <span class="meta">@Optional</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> flag = <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>MessagePack还提供了动态类型特性.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.*;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.msgpack.MessagePack;</div><div class="line"><span class="keyword">import</span> org.msgpack.type.Value;</div><div class="line"><span class="keyword">import</span> org.msgpack.unpacker.Converter;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.msgpack.template.Templates.*;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main5</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// Create serialize objects.</span></div><div class="line">        List&lt;String&gt; src = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">        src.add(<span class="string">"msgpack"</span>);</div><div class="line">        src.add(<span class="string">"kumofs"</span>);</div><div class="line">        src.add(<span class="string">"viver"</span>);</div><div class="line"></div><div class="line">        MessagePack msgpack = <span class="keyword">new</span> MessagePack();</div><div class="line">        <span class="comment">// Serialize</span></div><div class="line">        <span class="keyword">byte</span>[] raw = msgpack.write(src);</div><div class="line"></div><div class="line">        <span class="comment">// Deserialize directly using a template</span></div><div class="line">        List&lt;String&gt; dst1 = msgpack.read(raw, tList(TString));</div><div class="line"></div><div class="line">        <span class="comment">// Or, Deserialze to Value then convert type.</span></div><div class="line">        Value dynamic = msgpack.read(raw);</div><div class="line">        List&lt;String&gt; dst2 = <span class="keyword">new</span> Converter(dynamic).read(tList(TString));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当从MessagePack里读取数据的时候, 我们可以先不指定其转换的类型,　使用<code>Value</code>来代替, 等后期我们再使用<code>Converter</code> 对其转换.</p>
<p>接下来我们对其与JSON进行对比<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">msgpack</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		MessagePack msgpack = <span class="keyword">new</span> MessagePack();</div><div class="line"></div><div class="line">		List&lt;SeObj&gt; list = list();</div><div class="line">		<span class="keyword">long</span> start1 = System.currentTimeMillis();</div><div class="line">		<span class="keyword">byte</span>[] bytes1 = msgpack.write(list);</div><div class="line">		<span class="keyword">long</span> end1 = System.currentTimeMillis();</div><div class="line">		System.out.println((end1 - start1) + <span class="string">" : "</span> + bytes1.length);</div><div class="line"></div><div class="line">		<span class="keyword">long</span> start2 = System.currentTimeMillis();</div><div class="line">		String json = JSON.toJSONString(list);</div><div class="line">		<span class="keyword">long</span> end2 = System.currentTimeMillis();</div><div class="line">		System.out.println((end2 - start2) + <span class="string">" : "</span> + json.getBytes().length);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;SeObj&gt; <span class="title">list</span><span class="params">()</span> </span>&#123;</div><div class="line">		List&lt;SeObj&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">		Random random = <span class="keyword">new</span> Random();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</div><div class="line">			SeObj seObj = <span class="keyword">new</span> SeObj();</div><div class="line">			seObj.id = random.nextInt(<span class="number">100000</span>);</div><div class="line">			seObj.tall = random.nextFloat();</div><div class="line">			seObj.name = <span class="string">"name"</span> + random.nextInt(<span class="number">100000</span>);</div><div class="line">			list.add(seObj);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> list;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Message</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SeObj</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> id;</div><div class="line">	<span class="keyword">public</span> String name;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">float</span> tall;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="number">100</span>的结果</div><div class="line"><span class="number">194</span> : <span class="number">1960</span></div><div class="line"><span class="number">50</span> : <span class="number">4947</span></div><div class="line"><span class="number">1000</span>的结果</div><div class="line"><span class="number">210</span> : <span class="number">19589</span></div><div class="line"><span class="number">70</span> : <span class="number">49424</span></div><div class="line"><span class="number">10000</span>的结果</div><div class="line"><span class="number">212</span> : <span class="number">195765</span></div><div class="line"><span class="number">160</span> : <span class="number">493987</span></div><div class="line"><span class="number">100000</span>的结果</div><div class="line"><span class="number">283</span> : <span class="number">1956964</span></div><div class="line"><span class="number">330</span> : <span class="number">4940270</span></div><div class="line"><span class="number">1000000</span>的结果</div><div class="line"><span class="number">649</span> : <span class="number">19573508</span></div><div class="line"><span class="number">1878</span> : <span class="number">49404120</span></div></pre></td></tr></table></figure></p>
<p>我们发现MessagePack的耗时相对来说是比较稳定的, 但是在生成的数据量上比JSON要强一倍多</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/02/03/JavaLibrary/MessagePack 初探/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/02/03/JavaLibrary/MessagePack 初探/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/02/02/JavaLibrary/Netty ChannelPipeline/" title="Netty ChannelPipeline" itemprop="url">Netty ChannelPipeline</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-02-02T08:00:00.000Z" itemprop="datePublished"> Published 2016-02-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><code>ChannelPipeline</code>是一个<code>ChannelHandler</code>的集合, 用于处理或者截断<code>Channel</code>的<code>inbound events</code>和<code>outbound operations</code>. <code>ChannelPipeline</code>是<a href="http://www.oracle.com/technetwork/java/interceptingfilter-142169.html" target="_blank" rel="external">Intercepting Filter</a>的一个高级实现, 它保证了用户对事件处理的完整控制权以及确保了<code>ChannelHandler</code>在pipeline中的运行方式.</p>
<p>每当创建一个<code>Channel</code>的时候, 都会创建出一个对应的<code>ChannelPipeline</code>, 也就是说每个<code>Channel</code>都有其自己的<code>ChannelPipeline</code></p>
<p>下面的图给出了IO事件是如何在<code>ChannelPipeline</code>里的<code>ChannelHandler</code>进行传递处理的. IO事件由<code>ChannelInboundHandler</code>或者<code>ChannelOutboundHandler</code>处理, 我们在handler中调用<code>ChannelHandlerContext</code>中的事件传播方法将event传播给下一个handler继续执行, 例如调用<code>ChannelHandlerContext#fireChannelRead(Object)</code>和<code>ChannelHandlerContext#write(Object)</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">                                               I/O Request</div><div class="line">                                          via Channel&#125; or</div><div class="line">                                      ChannelHandlerContext&#125;</div><div class="line">                                                    |</div><div class="line">+---------------------------------------------------+---------------+</div><div class="line">|                           ChannelPipeline         |               |</div><div class="line">|                                                  \|/              |</div><div class="line">|    +---------------------+            +-----------+----------+    |</div><div class="line">|    | Inbound Handler  N  |            | Outbound Handler  <span class="number">1</span>  |    |</div><div class="line">|    +----------+----------+            +-----------+----------+    |</div><div class="line">|              /|\                                  |               |</div><div class="line">|               |                                  \|/              |</div><div class="line">|    +----------+----------+            +-----------+----------+    |</div><div class="line">|    | Inbound Handler N-<span class="number">1</span> |            | Outbound Handler  <span class="number">2</span>  |    |</div><div class="line">|    +----------+----------+            +-----------+----------+    |</div><div class="line">|              /|\                                  .               |</div><div class="line">|               .                                   .               |</div><div class="line">| ChannelHandlerContext.fireIN_EVT() ChannelHandlerContext.OUT_EVT()|</div><div class="line">|        [ method call]                       [method call]         |</div><div class="line">|               .                                   .               |</div><div class="line">|               .                                  \|/              |</div><div class="line">|    +----------+----------+            +-----------+----------+    |</div><div class="line">|    | Inbound Handler  <span class="number">2</span>  |            | Outbound Handler M-<span class="number">1</span> |    |</div><div class="line">|    +----------+----------+            +-----------+----------+    |</div><div class="line">|              /|\                                  |               |</div><div class="line">|               |                                  \|/              |</div><div class="line">|    +----------+----------+            +-----------+----------+    |</div><div class="line">|    | Inbound Handler  <span class="number">1</span>  |            | Outbound Handler  M  |    |</div><div class="line">|    +----------+----------+            +-----------+----------+    |</div><div class="line">|              /|\                                  |               |</div><div class="line">+---------------+-----------------------------------+---------------+</div><div class="line">                |                                  \|/</div><div class="line">+---------------+-----------------------------------+---------------+</div><div class="line">|               |                                   |               |</div><div class="line">|       [ Socket.read() ]                    [ Socket.write() ]     |</div><div class="line">|                                                                   |</div><div class="line">|  Netty Internal I/<span class="function">O <span class="title">Threads</span> <span class="params">(Transport Implementation)</span>            |</span></div><div class="line">+-------------------------------------------------------------------+</div></pre></td></tr></table></figure></p>
<p>从上图中我们可以看出左边是<code>inbound</code>handler(从下向上进行处理), 右图是<code>outbound</code>流程(从上向下进行处理).<code>inbound</code>handler通常处理的是由IO线程生成的<code>inbound</code>数据(例如<code>SocketChannel#read(ByteBuffer)</code>).<br><code>outbound</code>handler一般由write请求生成或者转换传输数据. 如果<code>outbound</code>数据传输到上图的底部后, 它就会被绑定到<code>Channel</code>上的IO线程进行操作. IO线程一般会进行<code>SocketChannel#write(ByteBuffer)</code>数据输出操作.</p>
<blockquote>
<p>底层的<code>SocketChannel#read()</code>方法读取<code>ByteBuf</code>, 然后由IO线程<code>NioEventLoop</code>调用<code>ChannelPipeline#fireChannelRead()</code>方法,将消息<code>ByteBuf</code>传递到<code>ChannelPipeline</code>中.</p>
</blockquote>
<h2 id="handler实现"><a href="#handler实现" class="headerlink" title="handler实现"></a>handler实现</h2><p>下面我们看一下如何自己实现一个inbound和outbound handler<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInboundHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Connected!"</span>);</div><div class="line">        ctx.fireChannelActive();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> clas MyOutboundHandler extends ChannelOutboundHandlerAdapter &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(ChannelHandlerContext ctx, ChannelPromise&#125; promise)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Closing .."</span>);</div><div class="line">        ctx.close(promise);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以预想到的是, 用户在使用pipeline中肯定最少会有一个<code>ChannelHandler</code>用来接受IO事件(例如read操作)和响应IO操作(例如write和close). 例如一个标准的服务器在每个channel中的pipeline中会有如下的handler</p>
<ul>
<li>Protocol Decoder ： 将二进制的字节码(例如<code>ByteBuf</code>中的数据)解析成Java对象</li>
<li>Protocol Encoder :  将Java对象转换成二进制数据进行网络传输</li>
<li>Business Logic Handler : 执行真正的业务逻辑</li>
</ul>
<p>下面我们将上面的流程转换成一个真实的示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> EventExecutorGroup group = <span class="keyword">new</span> DefaultEventExecutorGroup(<span class="number">16</span>);</div><div class="line">...</div><div class="line"></div><div class="line">ChannelPipeline&#125; pipeline = ch.pipeline();</div><div class="line"></div><div class="line">pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> MyProtocolDecoder());</div><div class="line">pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> MyProtocolEncoder());</div><div class="line"></div><div class="line"><span class="comment">// Tell the pipeline to run MyBusinessLogicHandler's event handler methods</span></div><div class="line"><span class="comment">// in a different thread than an I/O thread so that the I/O thread is not blocked by</span></div><div class="line"><span class="comment">// a time-consuming task.</span></div><div class="line"><span class="comment">// If your business logic is fully asynchronous or finished very quickly, you don't</span></div><div class="line"><span class="comment">// need to specify a group.</span></div><div class="line">pipeline.addLast(group, <span class="string">"handler"</span>, <span class="keyword">new</span> MyBusinessLogicHandler());</div></pre></td></tr></table></figure></p>
<p>我们可以在任何时间在<code>ChannelPipeline</code>上添加或者移除<code>ChannelHandler</code>, 因为<code>ChannelPipeline</code>是线程安全的. 例如我们可以在线上环境中因为业务原因动态的添加或者移除handler.</p>
<h2 id="事件处理过程"><a href="#事件处理过程" class="headerlink" title="事件处理过程"></a>事件处理过程</h2><p>在下面的示例中我们分别在pipeline中添加俩个<code>inbound</code>handler和俩个<code>outbound</code>handler.(以<code>Inbound</code>开头的类名表示为一个<code>inbound</code>handler, 以<code>Outbound</code>开头的类名表示为一个<code>outbound</code>handler.)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ChannelPipeline p = ...;</div><div class="line">p.addLast(<span class="string">"1"</span>, <span class="keyword">new</span> InboundHandlerA());</div><div class="line">p.addLast(<span class="string">"2"</span>, <span class="keyword">new</span> InboundHandlerB());</div><div class="line">p.addLast(<span class="string">"3"</span>, <span class="keyword">new</span> OutboundHandlerA());</div><div class="line">p.addLast(<span class="string">"4"</span>, <span class="keyword">new</span> OutboundHandlerB());</div><div class="line">p.addLast(<span class="string">"5"</span>, <span class="keyword">new</span> InboundOutboundHandlerX());</div></pre></td></tr></table></figure></p>
<p>事件在<code>inbound</code>handler中的执行过程是<code>1, 2, 3, 4, 5</code>. 事件在<code>outbound</code>handler中的执行过程是<code>5, 4, 3, 2, 1</code>.</p>
<p>但是在真实的执行过程中, 由于<code>3, 4</code>并没有实现<code>ChannelInboundHandler</code>, 因此inbound流程中真正执行的handler只有<code>1, 2, 5</code>. 而由于<code>1, 2</code>并没有实现<code>ChannelOutboundHandler</code>因此在outbound流程中真正执行的handler只有<code>5, 4, 3</code>.<br>如果<code>5</code>都实现了<code>ChannelInboundHandler</code>和<code>ChannelOutboundHandler</code>, 那么事件的执行顺序分别是<code>125</code>和<code>543</code>.</p>
<h2 id="源码剖析"><a href="#源码剖析" class="headerlink" title="源码剖析"></a>源码剖析</h2><p>下来我们看一下<code>ChannelPipeline</code>的默认实现<code>DefaultChannelPipeline</code>里的数据结构<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> AbstractChannel channel;</div><div class="line"></div><div class="line"><span class="keyword">final</span> DefaultChannelHandlerContext head;</div><div class="line"><span class="keyword">final</span> DefaultChannelHandlerContext tail;</div></pre></td></tr></table></figure></p>
<p><code>DefaultChannelPipeline</code>采用链式方式存储<code>ChannelHandlerContext</code>(内部存储的的是<code>ChannelHandler</code>). 在构造器中, 它将头尾相连了起来<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultChannelPipeline</span><span class="params">(AbstractChannel channel)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (channel == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"channel"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.channel = channel;</div><div class="line"></div><div class="line">        tail = <span class="keyword">new</span> TailContext(<span class="keyword">this</span>);</div><div class="line">        head = <span class="keyword">new</span> HeadContext(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 将链表首尾相连</span></div><div class="line">        head.next = tail;</div><div class="line">        tail.prev = head;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当我们增加一个<code>ChannelHandler</code>时<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelPipeline <span class="title">addFirst</span><span class="params">(EventExecutorGroup group, <span class="keyword">final</span> String name, ChannelHandler handler)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        checkDuplicateName(name);</div><div class="line">        <span class="comment">// 我们将handler和ChannelPipeline, EventLoop封装到一个Context里</span></div><div class="line">        DefaultChannelHandlerContext newCtx = <span class="keyword">new</span> DefaultChannelHandlerContext(<span class="keyword">this</span>, group, name, handler);</div><div class="line">        addFirst0(name, newCtx);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addFirst0</span><span class="params">(String name, DefaultChannelHandlerContext newCtx)</span> </span>&#123;</div><div class="line">    checkMultiplicity(newCtx);</div><div class="line"></div><div class="line">    <span class="comment">// 我们将添加的handler放到链表的第一个位置上</span></div><div class="line">    DefaultChannelHandlerContext nextCtx = head.next;</div><div class="line">    newCtx.prev = head;</div><div class="line">    newCtx.next = nextCtx;</div><div class="line">    head.next = newCtx;</div><div class="line">    nextCtx.prev = newCtx;</div><div class="line"></div><div class="line">    name2ctx.put(name, newCtx);</div><div class="line"></div><div class="line">    callHandlerAdded(newCtx);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callHandlerAdded</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (ctx.channel().isRegistered() &amp;&amp; !ctx.executor().inEventLoop()) &#123;</div><div class="line">        <span class="comment">// 如果Channel已经注册到eventLoop上, 且当前线程与eventLoop中的线程不是同一个, 也就是说当前操作是多线程进行的,</span></div><div class="line">        <span class="comment">// 则将callHandlerAdded0()逻辑放到任务队列中进行执行</span></div><div class="line">        ctx.executor().execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                callHandlerAdded0(ctx);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    callHandlerAdded0(ctx);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callHandlerAdded0</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        ctx.handler().handlerAdded(ctx);</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看到最终的时候在<code>ChannelHandler</code>里添加了<code>ChannelHandlerContext</code>. 但是经过查看<code>ByteToMessageDecoder</code>, <code>ChannelInboundHandlerAdapter</code>, <code>ChannelHandlerAdapter</code><br>这个都是空实现, 也就是说, 如果用户自己没有重载的话, 那么这里不会有任何的逻辑产生.</p>
<p>最终我们看到了, 在<code>DeaultChannelPipeline</code>的内部只是维持了一个链表头和链表尾.那么当<code>Unsafe</code>里调用<code>fireXXX()</code>相关的方法时就会由头或者尾context来触发<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ChannelPipeline <span class="title">fireChannelActive</span><span class="params">()</span> </span>&#123;</div><div class="line">        head.fireChannelActive();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (channel.config().isAutoRead()) &#123;</div><div class="line">            channel.read();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ChannelPipeline <span class="title">fireChannelRead</span><span class="params">(Object msg)</span> </span>&#123;</div><div class="line">        head.fireChannelRead(msg);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>在上面我们贴出了俩个方法, 下面我们看一下<code>fireChannelRead()</code>的处理流程.</p>
<p>在<code>AbstractChannelHandlerContext#fireChannelRead()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ChannelHandlerContext <span class="title">fireChannelRead</span><span class="params">(<span class="keyword">final</span> Object msg)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> AbstractChannelHandlerContext next = findContextInbound();</div><div class="line">        EventExecutor executor = next.executor();</div><div class="line">        <span class="keyword">if</span> (executor.inEventLoop()) &#123;</div><div class="line">            next.invokeChannelRead(msg);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            executor.execute(<span class="keyword">new</span> OneTimeTask() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    next.invokeChannelRead(msg);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> AbstractChannelHandlerContext <span class="title">findContextInbound</span><span class="params">()</span> </span>&#123;</div><div class="line">        AbstractChannelHandlerContext ctx = <span class="keyword">this</span>;</div><div class="line">        do &#123;</div><div class="line">            ctx = ctx.next;</div><div class="line">        &#125; <span class="keyword">while</span> (!ctx.inbound);</div><div class="line">        <span class="keyword">return</span> ctx;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>直接fireChannelRead() 会跳过第一个handler???</p>
</blockquote>
<p>上面的<code>fireChannelRead()</code>逻辑很简单, 我们接下来看一下<code>invokeChannelRead()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeChannelRead</span><span class="params">(Object msg)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ((ChannelInboundHandler) handler()).channelRead(<span class="keyword">this</span>, msg);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            notifyHandlerException(t);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这里就直接找到了handler, 触发了我们最终自己实现的<code>channelRead()</code>方法.</p>
<p>也许你已经注意到了, 在handler中不得不调用<code>ChannelHandlerContext</code>的事件传播方法, 将事件传递给下一个handler. 下面的是<br>能够触发<code>inbound</code>事件的方法</p>
<ul>
<li><code>ChannelHandlerContext#fireChannelRegistered()</code> Channel注册事件. (``触发)</li>
<li><code>ChannelHandlerContext#fireChannelActive()</code> TCP链路建立成功,Channel激活事件. (``触发)</li>
<li><code>ChannelHandlerContext#fireChannelRead(Object var1)</code> 读事件. (``触发)</li>
<li><code>ChannelHandlerContext#fireChannelReadComplete()</code> 读操作完成通知事件. (``触发)</li>
<li><code>ChannelHandlerContext#fireExceptionCaught(Throwable var1)</code> 异常通知事件. (``触发)</li>
<li><code>ChannelHandlerContext#fireUserEventTriggered(Object var1)</code> 用户自定义事件. (``触发)</li>
<li><code>ChannelHandlerContext#fireChannelWritabilityChanged()</code> Channel的可写状态变化通知事件. (``触发)</li>
<li><code>ChannelHandlerContext#fireChannelInactive()</code> TCP链路关闭, 链路不可用通知事件. (<code>`触发)
触发</code>outbound`事件的方法有</li>
<li><code>ChannelHandlerContext#bind(SocketAddress var1, ChannelPromise var2)</code> 绑定本地地址事件</li>
<li><code>ChannelHandlerContext#connect(SocketAddress var1, ChannelPromise var2)</code> 连接服务端事件</li>
<li><code>ChannelHandlerContext#flush()</code> 刷新事件</li>
<li><code>ChannelHandlerContext#read()</code> 读事件</li>
<li><code>ChannelHandlerContext#disconnect(ChannelPromise var1)</code> 断开连接事件</li>
<li><code>ChannelHandlerContext#close(ChannelPromise var1)</code> 关闭当前Channel事件</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Netty/">Netty</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/02/02/JavaLibrary/Netty ChannelPipeline/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/02/02/JavaLibrary/Netty ChannelPipeline/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/02/02/JavaSE/Java volatile/" title="volatile 使用" itemprop="url">volatile 使用</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-02-02T08:00:00.000Z" itemprop="datePublished"> Published 2016-02-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>在讲<code>volatile</code>的之前,我们先看一下java的内存模型. 我们知道当我们<code>new</code>出来一个对象的时候,这个对象会被直接分配到堆上(暂不考虑栈上分配等技术). 而程序的逻辑是在方法中定义的,方法运行在线程里也就是栈上. 因此JVM会将线程里使用的数据从堆上拷贝到线程的本地存储上. 这个过程涉及了下列8个操作</p>
<ol>
<li>lock: 将堆上的变量标志为某个线程独享的状态</li>
<li>unlock: 将堆上的变量释放出来, 以便被其他线程锁定</li>
<li>read: 将某个变量从堆上拷贝到线程的工作内存上</li>
<li>load: 将已经从堆上拷贝到线程的工作内存上的变量放入到变量副本中</li>
<li>use: 将线程变量副本中的变量传递给虚拟机执行引擎. (每当虚拟机遇到一个需要使用该变量的字节码指令时,都会执行该操作)</li>
<li>assign: 将虚拟机执行引擎返回的变量的值赋值到工作变量中</li>
<li>store: 将工作变量值传递到堆内存中.</li>
<li>write: 将从线程工作变量中接受到的值写入到主内存变量中</li>
</ol>
<p>当一个变量被<code>volatile</code>修饰后, 每次<code>load</code>操作都是从堆中获取值, <code>assign</code>的时候也是直接写回到堆中内存变量中, 而不是在线程本地变量中操作.</p>
<p>volatile变量具备俩种特性</p>
<ul>
<li>线程可见性: 某个线程修改了被<code>volatile</code>修饰的变量后,其他线程可以里面看见这个最新的值.</li>
<li>禁止指令重排序优化</li>
</ul>
<blockquote>
<p><code>volatile</code>最适用的场景是一个线程写,多个线程读的场景. 如果有多个线程同时写的话还是需要锁或者并发容器等等进行保护</p>
</blockquote>
<p>下面我们看一个指令重排序的例子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">			<span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">			<span class="keyword">while</span> (!stop) &#123;</div><div class="line">				i++;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		thread.start();</div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		stop = <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的这段代码会被优化成(这种优化也被称为提升优化)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">			<span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">			<span class="keyword">if</span> (!stop) &#123;</div><div class="line">				<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">					i++;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		thread.start();</div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		stop = <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是如果<code>stop</code>变量被<code>volatile</code>修饰后<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">			<span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">			<span class="keyword">while</span> (!stop) &#123;</div><div class="line">				i++;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		thread.start();</div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		stop = <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>程序就能正确的停止运行了</p>
<blockquote>
<p>Java中对于重排序是这样规定的, 只要在单线程环境中, 重排序前后代码的运行结果总是一致的, 那么这段代码的重排序就是合法的. 但是当在多线程的环境中, 重排序就会影响到程序的执行, 就像刚才我们的例子展示的那样. 例外还有一点值得说明的是, 当代码中运行时包含<code>native</code>方法时, 会打断编译器的重排序(例如<code>System.out.println()</code>或者<code>Threads.sleep()</code>)</p>
</blockquote>
<p><code>volatile</code>并不能解决并发写的情况, 正如我们开头所说的<code>volatile</code>最适用的场景是一个线程写,多个线程读的场景. 例如下面的程序, 无论我是否对<code>counter</code>进行<code>volatile</code>修饰都不能解决并发异常的问题<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> counter = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		List&lt;Thread&gt; threads = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</div><div class="line">			Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">				<span class="comment">// 并发写counter</span></div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					TimeUnit.MILLISECONDS.sleep(<span class="number">50</span>);</div><div class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">					e.printStackTrace();</div><div class="line">				&#125;</div><div class="line">				counter++;</div><div class="line">			&#125;);</div><div class="line"></div><div class="line">			thread.start();</div><div class="line">			threads.add(thread);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		threads.forEach(thread -&gt; &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				thread.join();</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		System.out.println(counter);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的程序最后的输出结果, 总是小于100000.</p>
<blockquote>
<p>还有一点需要说明的是,<code>volatile</code>修饰的数组,只能保证数组本身的内存可见性,但是对于其中的元素的修改是不会保证的.</p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/02/02/JavaSE/Java volatile/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/02/02/JavaSE/Java volatile/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/30/JavaLibrary/Typesafe Config 初探/" title="Typesafe Config 初探" itemprop="url">Typesafe Config 初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-30T08:00:00.000Z" itemprop="datePublished"> Published 2016-01-30</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>Typesafe Config 是为JVM平台语言提供的配置类库.</p>
<p>目前config只支持配置文件，如果想从数据库获取配置文件，需要自己diy。 config库很擅长合并配置。</p>
<p>我们可以直接使用maven方式依赖该库<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.typesafe<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>API示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.typesafe.config.ConfigFactory</div><div class="line"></div><div class="line">Config conf = ConfigFactory.load();</div><div class="line"><span class="keyword">int</span> bar1 = conf.getInt(<span class="string">"foo.bar"</span>);</div><div class="line">Config foo = conf.getConfig(<span class="string">"foo"</span>);</div><div class="line"><span class="keyword">int</span> bar2 = foo.getInt(<span class="string">"bar"</span>);</div></pre></td></tr></table></figure></p>
<p>在上面的例子中我们使用了最简单的方式<code>ConfigFactory.load()</code>加载出了一个配置类<code>Config</code>, config会自动去classPath中查找<code>reference.conf</code>. <code>ConfigFactory.load()</code>会按照下面的优先级依次从classpath中查找文件进行加载</p>
<ol>
<li><code>system properties</code></li>
<li><code>application.conf</code> (all resources on classpath with this name)</li>
<li><code>application.json</code> (all resources on classpath with this name)</li>
<li><code>application.properties</code> (all resources on classpath with this name)</li>
<li><code>reference.conf</code> (all resources on classpath with this name)<br>如果我们不想要使用上面的文件名或者我们将配置分配到多个文件中,那么我们可以使用<code>ConfigFactory.load(&quot;test.conf&quot;);</code></li>
</ol>
<p>当然如果你想自己创建<code>Config</code>也可以调用<code>ConfigFactory</code>的<code>parseXXX</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ConfigFactory.parseFile(<span class="keyword">new</span> File(<span class="string">""</span>));</div><div class="line">ConfigFactory.parseMap(<span class="keyword">new</span> HashMap&lt;&gt;());</div><div class="line">ConfigFactory.parseProperties(<span class="keyword">new</span> Properties());</div></pre></td></tr></table></figure></p>
<blockquote>
<p>需要注意的从<code>Config</code>实例中得到的<code>Config</code>, <code>ConfigParseOptions</code>, <code>ConfigResolveOptions</code>, <code>ConfigObject</code> 得到的对象都是不可变的.</p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/30/JavaLibrary/Typesafe Config 初探/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/30/JavaLibrary/Typesafe Config 初探/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/29/jvm/Classloader 示例/" title="使用Classloader加载类" itemprop="url">使用Classloader加载类</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-29T08:00:00.000Z" itemprop="datePublished"> Published 2016-01-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>类加载器不单单是用于实现类的加载动作, 对于任意一个类,都需要由加载它的类加载器和类本身一同确立其在java虚拟机中的唯一性.换句话说:比较俩个类是否相等,只有在这俩个类是由同一个类加载器加载的前提下才有意义. 否则即使来自同一个源文件,只要加载它们的类加载器不同,这俩个类就必定不相等.</p>
<blockquote>
<p>判断俩个类相等可以通过下面方法: <code>Class</code>对象的<code>equals()</code>方法, <code>isAssignbleFrom()</code>方法, <code>isInstance()</code>方法的返回结果, 也包括使用<code>instanceof</code>关键字做对象所属关系判断等. 不同的类加载器对<code>instanceof</code>关键字运算结果的影响</p>
</blockquote>
<h2 id="双亲委派模型"><a href="#双亲委派模型" class="headerlink" title="双亲委派模型"></a>双亲委派模型</h2><p><img src="https://raw.githubusercontent.com/ming15/blog-website/images/jvm/ClassLoader%E7%9A%84%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84.png" alt="ClassLoader的体系架构"><br>从JVM来角度讲, 只存在俩种不同的类加载器:</p>
<ul>
<li>启动类加载器: 使用C++语言实践,是虚拟机自身的一部分. </li>
<li>其他类加载器: 这些类加载器都由java语言实现,独立于虚拟机外部,并且全部都继承自抽象类:<code>java.lang.ClassLoader</code></li>
</ul>
<p>系统提供的类加载器</p>
<ul>
<li>启动类加载器 : 这个类加载器负责将<code>&lt;JAVA_HOME&gt;\lib</code>目录中的,或者<code>-Xbootclasspath</code>参数所指定的路径中的,并且是虚拟机识别的(仅按照文件名识别,如rt,jar,名字不符合的类库即使放在lib目录里也不会被加载)类库加载到虚拟机内存中,启动类加载器无法被java程序直接使用.</li>
<li>扩展类加载器 : 这个类加载器由<code>sun.misc.Launcher$ExtClassLoader</code>实现,负责加载<code>&lt;JAVA_HOME&gt;\lib\ext</code>目录中的,或者被<code>java.ext.dirs</code>系统变量所指定的路径中的所有类库, 开发者可以直接使用扩展类加载器.</li>
<li>应用程序加载器 : 这个类加载器由<code>sun.misc.Launcher$AppClassLoader</code>来实现. 由于类加载器是<code>ClassLoader</code>中<code>getSystemClassLoader()</code>方法的返回值,所以一般也称它为系统类加载器. 它负责加载用户类路径(ClassPath)上所指定的类库,开发者可以直接使用这个类加载器,如果应用程序中没有自定义过自己的类加载器,一般情况下就是程序中默认的类加载器.</li>
</ul>
<p>类加载器收到类加载请求,它不会自己去尝试加载这个类,而把这个请求委派给父类加载器去完成,每一个层次的类加载都是如此,因此所有的类加请求最终都应该传送到顶层的启动类加载器中,只有当父加载器反馈自己无法完成这个加载请求(它的搜索范围中没有找到所需的类)时,子类加载器才会尝试自己去加载.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</div><div class="line">       <span class="keyword">throws</span> ClassNotFoundException</div><div class="line">   &#123;</div><div class="line">       <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</div><div class="line">           <span class="comment">// 第一步检查被加载的类是否已经被加载进入了虚拟机</span></div><div class="line">           Class&lt;?&gt; c = findLoadedClass(name);</div><div class="line">           <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// 如果没有被加载进虚拟机中则进行加载</span></div><div class="line">               <span class="keyword">long</span> t0 = System.nanoTime();</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">				<span class="comment">// 优先从父类加载器中进行加载, 所有的类加请求最终都应该传送到顶层的启动类加载器中</span></div><div class="line">                   <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</div><div class="line">                       c = parent.loadClass(name, <span class="keyword">false</span>);</div><div class="line">                   &#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// </span></div><div class="line">                       c = findBootstrapClassOrNull(name);</div><div class="line">                   &#125;</div><div class="line">               &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">                   <span class="comment">// ClassNotFoundException thrown if class not found</span></div><div class="line">                   <span class="comment">// from the non-null parent class loader</span></div><div class="line">               &#125;</div><div class="line">			</div><div class="line">               <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</div><div class="line">                   <span class="comment">// 父类加载器找不到则调用自己的findClass(name)找到类然后进行加载</span></div><div class="line">                   <span class="keyword">long</span> t1 = System.nanoTime();</div><div class="line">                   c = findClass(name);</div><div class="line"></div><div class="line">                   <span class="comment">// this is the defining class loader; record the stats</span></div><div class="line">                   sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</div><div class="line">                   sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</div><div class="line">                   sun.misc.PerfCounter.getFindClasses().increment();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (resolve) &#123;</div><div class="line">               resolveClass(c);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> c;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>使用双亲委派模型来组织类加载之间的关系, 可以确保我们自己JVM的安全. 因为当我们自己写一个 <code>java.lang.Object</code>, 这个类虽然能够被正常编译, 但是它永远不会被加载器虚拟机中, 因为这个类会在启动类加载器中完成了加载.</p>
</blockquote>
<p>在刚才的<code>loadClass()</code>方法中我们看到最终我们自己实现类加载的逻辑是在<code>findClass()</code>中进行的, 这是为了向前兼容,JDK1.2之后添加的方法.JDK1.2之后已不提倡用户再去覆盖<code>loadClass()</code>方法,而在<code>loadClass()</code>方法的逻辑里如果父类加载失败,则会调用自己的<code>findClass()</code>方法来完成加载,这样就可以保证新写出来的类加载器是符合双亲委派规则的.</p>
<blockquote>
<p>为了解决各个类加载器的基础类调用用户代码, java设计团队引入了这样一个设计:线程上下文类加载器,这个类加载器可以通过<code>java.lang.Thread</code>类的<code>setContextClassLoaser()</code>方法进行设置,如果创建线程时还未设置,它将会从父线程中继承一个:如果在应用程序的全局范围内都没有设置过,那么这个类加载器默认就是应用程序类加载器.有了线程上下文类加载器,JNDI服务使用这个线程上下文类加载器去加载所需要的SPI代码,也就是父类加载器请求子类加载器去完成类加载的动作,这种行为实际就是打通了双亲委派模型的层次结构来逆向使用类加载器,已经违背了双亲委派模型的一般性原则.</p>
</blockquote>
<p>上面所说只完成了类加载的动作, 但是如果我们想要实现热更代码的这种功能的话,就不能单纯依赖重写<code>findClass(name)</code>了，而是要重写<code>loadClass(String name)</code>了，这是因为在<code>ClassLoader</code>中的<code>loadClass(String name)</code>方法当发现已经加载过的类就不会再重新加载了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Field;</div><div class="line"><span class="keyword">import</span> java.net.URL;</div><div class="line"><span class="keyword">import</span> java.net.URLClassLoader;</div><div class="line"><span class="keyword">import</span> java.util.Random;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.*;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClassLoader</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">		URL url = <span class="keyword">new</span> File(<span class="string">"."</span>).toURL();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; <span class="number">5</span>; i++) &#123;</div><div class="line">			MyClassLoader myLoader = <span class="keyword">new</span> MyClassLoader(<span class="keyword">new</span> URL[]&#123;url&#125;);</div><div class="line">			Class&lt;?&gt; obj = myLoader.loadClass(<span class="string">"Mesurable"</span>);</div><div class="line">			<span class="keyword">for</span> (Field field : obj.getFields()) &#123;</div><div class="line">				System.out.println(field.getName());</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MyClassLoader</span><span class="params">(URL[] urls)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(urls);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">		Class&lt;?&gt; loadClass = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">if</span> (name.contains(<span class="string">"java.lang.Object"</span>)) &#123;</div><div class="line">			<span class="comment">// 因为我们的父类是java.lang.Object, 因此我们要调用父类加载器进行加载</span></div><div class="line">			loadClass = <span class="keyword">super</span>.loadClass(name);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			loadClass = findLoadedClass(name);</div><div class="line">			<span class="keyword">if</span> (loadClass != <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="keyword">return</span> loadClass;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">byte</span>[] bytes = generateClass();</div><div class="line">			loadClass = defineClass(name, bytes, <span class="number">0</span>, bytes.length);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> loadClass;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">byte</span>[] generateClass() &#123;</div><div class="line">		ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</div><div class="line">		cw.visit(V1_8,											<span class="comment">// 指定class文件版本号, 我们将其设置为java8</span></div><div class="line">				ACC_PUBLIC,	<span class="comment">// 设置接口的修饰符</span></div><div class="line">				<span class="string">"Mesurable"</span>,								<span class="comment">// 我们设置classname, 需要在这里指定全限定名</span></div><div class="line">				<span class="keyword">null</span>,											<span class="comment">// 设置泛型信息, 因为我们的接口是非泛化的, 因此我们将其设置为null</span></div><div class="line">				<span class="string">"java/lang/Object"</span>,							<span class="comment">// 设置父类, 同时需要设定全限定名</span></div><div class="line">				<span class="keyword">null</span>);			<span class="comment">// 设置接口, 同样需要设置全限定名</span></div><div class="line"></div><div class="line">		cw.visitField(</div><div class="line">				ACC_PUBLIC,	<span class="comment">// 设置字段的修饰符</span></div><div class="line">				<span class="string">"LESS__"</span> + random.nextInt(<span class="number">100</span>),										<span class="comment">// 设置字段名</span></div><div class="line">				<span class="string">"I"</span>,										<span class="comment">// 设置字段类型</span></div><div class="line">				<span class="keyword">null</span>,										<span class="comment">// 设置泛型信息</span></div><div class="line">				<span class="keyword">new</span> Long(-<span class="number">1</span>))							<span class="comment">// 设置字面量值.</span></div><div class="line">				.visitEnd();</div><div class="line"></div><div class="line">		cw.visitEnd();</div><div class="line">		<span class="keyword">return</span> cw.toByteArray();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Random random = <span class="keyword">new</span> Random();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p><code>URLClassLoader</code>根据<code>URL</code>指定的路径从<code>JAR</code>文件或者目录里加载<code>class</code>文件或者其他资源文件. 如果<code>URL</code>以<code>/</code>结束,就表示到某个目录里进行加载. 否则就表示到某个<code>JAR</code>文件里进行加载. 线程里用于创建<code>URLClassLoader</code>实例的<code>AccessControlContext</code>会在加载类文件以及资源文件时使用到. <code>URLClassLoader</code>实例创建好之后会根据默认的授权权限依据指定的<code>URL</code>来进行加载类.</p>
</blockquote>
<p>从文件中加载class<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.*;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"><span class="keyword">import</span> java.net.URL;</div><div class="line"><span class="keyword">import</span> java.net.URLClassLoader;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; <span class="number">5</span>; i++) &#123;</div><div class="line">			MyClassLoader myLoader = <span class="keyword">new</span> MyClassLoader(<span class="keyword">new</span> URL[]&#123;&#125;);</div><div class="line">			Class&lt;?&gt; obj = myLoader.loadClass(<span class="string">"D:\\ming\\test\\target\\classes\\Test.class"</span>);</div><div class="line">			<span class="keyword">for</span> (Method method : obj.getMethods()) &#123;</div><div class="line">				<span class="keyword">if</span> (method.getName().equals(<span class="string">"printTime"</span>)) &#123;</div><div class="line">					method.invoke(<span class="keyword">null</span>);</div><div class="line">					TimeUnit.SECONDS.sleep(<span class="number">10</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printTime</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="number">123</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MyClassLoader</span><span class="params">(URL[] urls)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(urls);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">		Class&lt;?&gt; loadClass = findLoadedClass(name);</div><div class="line">		<span class="keyword">if</span> (loadClass != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span> loadClass;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">byte</span>[] bytes = loadClassFromFile(name);</div><div class="line">			<span class="keyword">int</span> idx = name.lastIndexOf(<span class="string">"\\"</span>);</div><div class="line">			name = name.substring(idx + <span class="number">1</span>);</div><div class="line">			name = name.split(<span class="string">"\\.class"</span>)[<span class="number">0</span>];</div><div class="line">			loadClass = defineClass(name, bytes, <span class="number">0</span>, bytes.length);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			loadClass = <span class="keyword">super</span>.loadClass(name);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> loadClass;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">byte</span>[] loadClassFromFile(String fileName) <span class="keyword">throws</span> Exception &#123;</div><div class="line">		InputStream input = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(fileName));</div><div class="line">		<span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[input.available()];</div><div class="line">		input.read(bytes);</div><div class="line">		<span class="keyword">return</span> bytes;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>同一个类加载器不同加载同一个类俩次, 例如我们利用上面的<code>MyClassLoader</code>进行加载<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		MyClassLoader myLoader1 = <span class="keyword">new</span> MyClassLoader(<span class="keyword">new</span> URL[]&#123;&#125;);</div><div class="line">		Class&lt;?&gt; obj1 = myLoader1.loadClass(<span class="string">"D:\\ming\\test\\target\\classes\\Test.class"</span>);</div><div class="line">		MyClassLoader myLoader2 = <span class="keyword">new</span> MyClassLoader(<span class="keyword">new</span> URL[]&#123;&#125;);</div><div class="line">		Class&lt;?&gt; obj2 = myLoader2.loadClass(<span class="string">"D:\\ming\\test\\target\\classes\\Test.class"</span>);</div><div class="line">		System.out.println(obj1.equals(obj2));</div><div class="line">		Class&lt;?&gt; obj3 = myLoader2.loadClass(<span class="string">"D:\\ming\\test\\target\\classes\\Test.class"</span>);</div><div class="line">		System.out.println(obj2.equals(obj3));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>会产生异常<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">false</div><div class="line">Exception in thread "main" java.lang.LinkageError: loader (instance of  MyClassLoader): attempted  duplicate class definition for name: "Test"</div><div class="line">	at java.lang.ClassLoader.defineClass1(Native Method)</div><div class="line">	at java.lang.ClassLoader.defineClass(ClassLoader.java:763)</div><div class="line">	at java.lang.ClassLoader.defineClass(ClassLoader.java:642)</div><div class="line">	at MyClassLoader.loadClass(Test.java:37)</div><div class="line">	at Test.main(Test.java:15)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</div><div class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</div><div class="line">	at java.lang.reflect.Method.invoke(Method.java:498)</div><div class="line">	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:144)</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/29/jvm/Classloader 示例/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/29/jvm/Classloader 示例/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/23/JavaLibrary/Netty ChannelHandler/" title="Netty ChannelHandler" itemprop="url">Netty ChannelHandler</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-23T08:00:00.000Z" itemprop="datePublished"> Published 2016-01-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>首先我们看一下<code>ChannelHandler</code>的继承结构<br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/netty/netty%20ChannelHadler.jpg" alt=""></p>
<ul>
<li><code>ChannelHandler</code></li>
<li><code>ChannelInboundHandler</code></li>
<li><code>ChannelOutboundHandler</code></li>
<li><code>ChannelInboundHandlerAdapter</code></li>
<li><code>ChannelOutboundHandlerAdapter</code></li>
<li><code>ChannelHandlerAdapter</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ChannelHandler</span></span></div><div class="line"><span class="title">public</span> <span class="title">interface</span> <span class="title">ChannelInboundHandler</span> <span class="keyword">extends</span> <span class="title">ChannelHandler</span></div><div class="line"><span class="title">public</span> <span class="title">interface</span> <span class="title">ChannelOutboundHandler</span> <span class="keyword">extends</span> <span class="title">ChannelHandler</span></div><div class="line"><span class="title">public</span> <span class="title">abstract</span> <span class="title">class</span> <span class="title">ChannelHandlerAdapter</span> <span class="keyword">implements</span> <span class="title">ChannelHandler</span></div><div class="line"><span class="title">public</span> <span class="title">class</span> <span class="title">ChannelInboundHandlerAdapter</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> <span class="keyword">implements</span> <span class="title">ChannelInboundHandler</span></div><div class="line"><span class="title">public</span> <span class="title">class</span> <span class="title">ChannelOutboundHandlerAdapter</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> <span class="keyword">implements</span> <span class="title">ChannelOutboundHandler</span></div></pre></td></tr></table></figure>
<p>之所以在提供了handle的接口之后还提供Adapter, 是因为如果我们直接实现handler接口的话, 那么我们就需要实现handler里的所有方法, 但是我们可能要在不同的handler里实现不同的功能, 而这些功能恰巧由不同的handler里的方法实现, 那么每个实现了handler接口的类都会有大量的冗余代码. 但是如果我们继承Adapter的话, 我们只需要重写需要实现功能的方法就可以了.</p>
<blockquote>
<p>IdleStateHandler</p>
</blockquote>
<h2 id="解码器"><a href="#解码器" class="headerlink" title="解码器"></a>解码器</h2><p>为了解决网络数据流的拆包粘包问题,Netty为我们内置了如下的解码器</p>
<ul>
<li>ByteToMessageDecoder</li>
<li>MessageToMessageDecoder</li>
<li>LineBasedFrameDecoder</li>
<li>StringDecoder</li>
<li>DelimiterBasedFrameDecoder</li>
<li>FixedLengthFrameDecoder</li>
<li>ProtoBufVarint32FrameDecoder</li>
<li>ProtobufDecoder</li>
<li>LengthFieldBasedFrameDecoder</li>
</ul>
<p>Netty还内置了如下的编码器</p>
<ul>
<li>ProtobufEncoder</li>
<li>MessageToByteEncoder</li>
<li>MessageToMessageEncoder</li>
<li>LengthFieldPrepender</li>
</ul>
<p>Netty还为我们提供HTTP相关的编解码器</p>
<ul>
<li><code>HttpRequestDecoder</code> : Http消息解码器</li>
<li><code>HttpObjectAggregator</code> : 将多个消息转换为单一的<code>FullHttpRequest</code>或者<code>FullHttpResponse</code></li>
<li><code>HttpResponseEncoder</code> : 对Http消息影响进行编码</li>
<li><code>ChunkedWriteHandler</code> : 异步大码流消息发送</li>
</ul>
<h2 id="ByteToMessageDecoder"><a href="#ByteToMessageDecoder" class="headerlink" title="ByteToMessageDecoder"></a>ByteToMessageDecoder</h2><p>如果我们自己想要实现自己的半包解码器,我们可以继承<code>ByteToMessageDecoder</code>, 实现更加复杂的半包解码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteToMessageDecoder</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span></span></div></pre></td></tr></table></figure></p>
<blockquote>
<p><a href="">ChannelInboundHandlerAdapter</a>参考</p>
</blockquote>
<p>我们只需要继承该类并实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception</span>;</div></pre></td></tr></table></figure></p>
<p>这个方法, 在这个方法里完成byte字节到java对象的转换, 也就是我们将<code>ByteBuf</code>解析成java对象然后抛给<code>List&lt;Object&gt; out</code>就可以了.</p>
<blockquote>
<p>需要注意的这个类没有实现粘包组包等情况, 这个就需要我们自己实现了.</p>
</blockquote>
<h2 id="MessageToMessageDecoder"><a href="#MessageToMessageDecoder" class="headerlink" title="MessageToMessageDecoder"></a>MessageToMessageDecoder</h2><p><code>MessageToMessageDecoder</code>一般作为二次解码器, 当我们在<code>ByteToMessageDecoder</code>将一个bytes数组转换成一个java对象的时候, 我们可能还需要将这个对象进行二次解码成其他对象, 我们就可以继承这个类,<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageToMessageDecoder</span>&lt;<span class="title">I</span>&gt; <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span></span></div></pre></td></tr></table></figure></p>
<p>然后实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, I msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception</span>;</div></pre></td></tr></table></figure></p>
<p>这个方法就可以了</p>
<h2 id="LineBasedFrameDecoder"><a href="#LineBasedFrameDecoder" class="headerlink" title="LineBasedFrameDecoder"></a>LineBasedFrameDecoder</h2><p><code>LineBasedFrameDecoder</code>的原理是从<code>ByteBuf</code>的可读字节中找到<code>\n</code>或者<code>\r\n</code>,找到之后就以此为结束,然后将当前读取到的数据组成一行.</p>
<p>如果我们设置每一行的最大长度, 但是当达到最大长度之后还没有找到结束符,就会抛出异常,同时将读取的数据舍弃掉.</p>
<p><code>LineBasedFrameDecoder</code>的用法很简单, 我们可以向其指定大小或者不指定大小<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">ch.pipline().addLast(<span class="keyword">new</span> LineBasedFrameDecoder());</div><div class="line">...</div><div class="line">或者</div><div class="line">...</div><div class="line">ch.pipline().addLast(<span class="keyword">new</span> LineBasedFrameDecoder(<span class="number">1024</span>));</div><div class="line">...</div></pre></td></tr></table></figure></p>
<h2 id="DelimiterBasedFrameDecoder"><a href="#DelimiterBasedFrameDecoder" class="headerlink" title="DelimiterBasedFrameDecoder"></a>DelimiterBasedFrameDecoder</h2><p>使用<code>DelimiterBasedFrameDecoder</code>我们可以自定义设定分隔符<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">ByteBuf delimiter = Unpooled.copiedBuffer(<span class="string">"$_"</span>.getBytes());</div><div class="line">ch.pipline().addLast(<span class="keyword">new</span> DelimiterBasedFrameDecoder(<span class="number">1024</span>, delimiter));</div></pre></td></tr></table></figure></p>
<p>在上面的例子中我们使用了自定义的分隔符<code>$_</code>, 同样的如果在1024个字节中找不到<code>$_</code>, 也会抛出.</p>
<h2 id="FixedLengthFrameDecoder"><a href="#FixedLengthFrameDecoder" class="headerlink" title="FixedLengthFrameDecoder"></a>FixedLengthFrameDecoder</h2><p><code>FixedLengthFrameDecoder</code>为定长解码器, 它会按照指定长度对消息进行解码.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ch.pipline().addLast(<span class="keyword">new</span> FixedLengthFrameDecoder(<span class="number">1024</span>));</div></pre></td></tr></table></figure></p>
<p>上面的例子会每隔1024个长度之后进行消息解码,如果不足1024,则会将消息缓存起来,然后再进行解码</p>
<h2 id="ProtobufVarint32FrameDecoder"><a href="#ProtobufVarint32FrameDecoder" class="headerlink" title="ProtobufVarint32FrameDecoder"></a>ProtobufVarint32FrameDecoder</h2><p><code>ProtoBufVarint32FrameDecoder</code>是Netty为我们提供的Protobuf半包解码器, 通过它配合使用<code>ProtobufDecoder</code>和<code>ProtobufEncoder</code>我们就可以使用Protobuf进行通信了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ch.pipline().addLast(<span class="keyword">new</span> ProtobufVarint32FrameDecoder());</div><div class="line">ch.pipline().addLast(<span class="keyword">new</span> ProtobufDecoder());</div><div class="line">ch.pipline().addLast(<span class="keyword">new</span> ProtobufEncoder());</div></pre></td></tr></table></figure></p>
<h2 id="LengthFieldBasedFrameDecoder"><a href="#LengthFieldBasedFrameDecoder" class="headerlink" title="LengthFieldBasedFrameDecoder"></a>LengthFieldBasedFrameDecoder</h2><p><code>LengthFieldBasedFrameDecoder</code>是Netty为我们提供的通用半包解码器.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LengthFieldBasedFrameDecoder</span> <span class="keyword">extends</span> <span class="title">ByteToMessageDecoder</span></span></div></pre></td></tr></table></figure></p>
<p>这个类的半包读取策略由下面的属性控制</p>
<ul>
<li><code>lengthFieldOffset</code> : 标志长度字段的偏移量. 也就是在一个bytes字节流中,表示消息长度的字段是从流中哪个位置开始的.</li>
<li><code>lengthFieldLength</code> : 长度字段的长度(单位byte)</li>
<li><code>lengthAdjustment</code> : 当消息长度包含了消息头的长度的时候,需要使用这个变量进行校正, 例如lengthFieldOffset为0,lengthFieldLength为2, 那么消息正体在解析时就需要校正2个字节, 故这里为-2.</li>
<li><code>initialBytesToStrip</code>: 这个是当我们解析<code>ByteBuf</code>时要跳过的那些字段, (一般为lengthFieldOffset + lengthFieldLength)</li>
</ul>
<h2 id="MessageToByteEncoder"><a href="#MessageToByteEncoder" class="headerlink" title="MessageToByteEncoder"></a>MessageToByteEncoder</h2><p>该类负责将java对象编码成<code>ByteBuf</code>, 我们只需要继承该类然后实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, I msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception</span>;</div></pre></td></tr></table></figure></p>
<p>方法就可以了</p>
<h2 id="MessageToMessageEncoder"><a href="#MessageToMessageEncoder" class="headerlink" title="MessageToMessageEncoder"></a>MessageToMessageEncoder</h2><p>如果要将java对象不编码成<code>ByteBuf</code>, 而是编译成, 其他对象, 那我们可以继承这个类实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, I msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception</span>;</div></pre></td></tr></table></figure></p>
<p>这个方法就可以了</p>
<blockquote>
<p>这个类与<code>MessageToByteEncoder</code>的不同是, 将java对象放到一个<code>List&lt;Object&gt; out</code>, 而不是编码成<code>ByteBuf</code>发送</p>
</blockquote>
<h2 id="LengthFieldPrepender"><a href="#LengthFieldPrepender" class="headerlink" title="LengthFieldPrepender"></a>LengthFieldPrepender</h2><p><code>LengthFieldPrepender</code>是一个非常实用的工具类, 如果我们在发送消息的时候采用的是:消息长度字段+原始消息的形式, 那么我们就可以使用<code>LengthFieldPrepender</code>了. 这是因为<code>LengthFieldPrepender</code>可以将待发送消息的长度(二进制字节长度)写到<code>ByteBuf</code>的前俩个字节.例如:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Hello,World</div></pre></td></tr></table></figure></p>
<p>编码前是12个字节,但是经过<code>LengthFieldPrepender</code>编码后变成了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0x000E</span> Hello,World</div></pre></td></tr></table></figure></p>
<p>成为了14个字节</p>
<h2 id="HTTP解码器"><a href="#HTTP解码器" class="headerlink" title="HTTP解码器"></a>HTTP解码器</h2><blockquote>
<p>使用<code>HttpObjectAggregator</code>是因为在解码Http消息中会产生多个对象(<code>HttpRequest</code>, <code>HttpResponse</code>, <code>HttpContent</code>, <code>LastHttpContent</code>), 使用<code>HttpObjectAggregator</code>我们可以将这些对象都组合到一起去. 然后当我们自己在处理消息时就可以直接使用<code>FullHttpRequest了</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ch.pipline().addLast(<span class="string">"http-decoder"</span>, <span class="keyword">new</span> HttpRequestDecoder());</div><div class="line">ch.pipline().addLast(<span class="string">"http-aggregator"</span>, <span class="keyword">new</span> HttpObjectAggregator());</div><div class="line">ch.pipline().addLast(<span class="string">"http-encoder"</span>, <span class="keyword">new</span> HttpResponseEncoder());</div><div class="line">ch.pipline().addLast(<span class="string">"http-chunked"</span>, <span class="keyword">new</span> ChunkedWriteHandler());</div></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Netty/">Netty</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/23/JavaLibrary/Netty ChannelHandler/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/23/JavaLibrary/Netty ChannelHandler/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/20/JavaLibrary/Retrofit/" title="Retrofit 初探" itemprop="url">Retrofit 初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-20T08:00:00.000Z" itemprop="datePublished"> Published 2016-01-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>首先添加Maven依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.retrofit2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>retrofit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意我们使用的是retrofit2</p>
</blockquote>
<h2 id="Get请求"><a href="#Get请求" class="headerlink" title="Get请求"></a>Get请求</h2><p>Retrofit 将HTTP API转换为了接口形式, 如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitHubService</span> </span>&#123;</div><div class="line">  <span class="meta">@GET</span>(<span class="string">"users/&#123;user&#125;/repos"</span>)</div><div class="line">  Call&lt;List&lt;Repo&gt;&gt; listRepos(<span class="meta">@Path</span>(<span class="string">"user"</span>) String user);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后<code>Retrofit</code>会自动完成其实现类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">    .baseUrl(<span class="string">"https://api.github.com"</span>)</div><div class="line">    .build();</div><div class="line"></div><div class="line">GitHubService service = retrofit.create(GitHubService.class);</div></pre></td></tr></table></figure></p>
<p>在上面的示例中我们完成了一个<code>Get</code>请求, 然后使用<code>@Path</code>进行参数替换</p>
<h2 id="Post请求"><a href="#Post请求" class="headerlink" title="Post请求"></a>Post请求</h2><p>上面我们展示的是一个<code>Get</code>请求, 下面我们再看一个<code>Post</code>请求的示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@POST</span>(<span class="string">"users/new"</span>)</div><div class="line"><span class="function">Call&lt;User&gt; <span class="title">createUser</span><span class="params">(@Body User user)</span></span>;</div></pre></td></tr></table></figure></p>
<p><code>@Body</code>注解会将<code>User</code>对象转换为请求体</p>
<h2 id="form-encoded"><a href="#form-encoded" class="headerlink" title="form-encoded"></a>form-encoded</h2><p>我们我们想要将格式转换为<code>form-encoded</code>形式, 参考如下示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@FormUrlEncoded</span></div><div class="line"><span class="meta">@POST</span>(<span class="string">"user/edit"</span>)</div><div class="line"><span class="function">Call&lt;User&gt; <span class="title">updateUser</span><span class="params">(@Field(<span class="string">"first_name"</span>)</span> String first, @<span class="title">Field</span><span class="params">(<span class="string">"last_name"</span>)</span> String last)</span>;</div></pre></td></tr></table></figure></p>
<p><code>@Field</code>注解会组成一个个字典结构的数据进行发送.</p>
<h2 id="HEADER"><a href="#HEADER" class="headerlink" title="HEADER"></a>HEADER</h2><p>有时候我们也许想要设置其他的消息头, 我们可以如此做<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Headers</span>(<span class="string">"Cache-Control: max-age=640000"</span>)</div><div class="line"><span class="meta">@GET</span>(<span class="string">"widget/list"</span>)</div><div class="line">Call&lt;List&lt;Widget&gt;&gt; widgetList();</div></pre></td></tr></table></figure></p>
<h2 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h2><p>我们在<code>Call</code>对象中分别可以调用异步和同步方法进行通信<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">		.baseUrl(<span class="string">"https://api.github.com"</span>)</div><div class="line">		.build();</div><div class="line"></div><div class="line">GitHubService service = retrofit.create(GitHubService.class);</div><div class="line"></div><div class="line">Call&lt;List&lt;String&gt;&gt; repos = service.listRepos(<span class="string">"octocat"</span>);</div><div class="line">	<span class="comment">// 同步调用</span></div><div class="line">	Response&lt;List&lt;String&gt;&gt; result = repos.execute();</div><div class="line"></div><div class="line">	<span class="comment">// 异步调用</span></div><div class="line">	repos.enqueue(<span class="keyword">new</span> Callback() &#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Response response)</span> </span>&#123;</div><div class="line"></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line"></div><div class="line">		&#125;</div><div class="line">	&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>在我的windows的机器上进行测试, 只是测试一下Retrofit的性能消耗<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIte1Minite</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">	<span class="keyword">long</span> start = System.currentTimeMillis();</div><div class="line">	<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">		<span class="keyword">long</span> end = System.currentTimeMillis();</div><div class="line">		<span class="keyword">if</span> ((end - start) &gt; <span class="number">1000</span> * <span class="number">60</span>) &#123;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">				.baseUrl(<span class="string">"http://192.168.15.20:9091"</span>)</div><div class="line">				.addConverterFactory(GsonConverterFactory.create())</div><div class="line">				.build();</div><div class="line">		ServerListService loginServerPushService = retrofit.create(ServerListService.class);</div><div class="line">		loginServerPushService.serverlist().execute().body();</div><div class="line">		count++;</div><div class="line">	&#125;</div><div class="line">	System.out.println(count);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServerListService</span> </span>&#123;</div><div class="line">	<span class="meta">@GET</span>(<span class="string">"server/serverlist"</span>)</div><div class="line">	<span class="function">Call&lt;MyServer&gt; <span class="title">serverlist</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServer</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> List&lt;Map&lt;String, String&gt;&gt; serverlist;</div><div class="line">	<span class="keyword">public</span> List&lt;Map&lt;String, String&gt;&gt; serverlogin;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果如图<br><img src="" alt=""><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIte1Minite</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">	<span class="keyword">long</span> start = System.currentTimeMillis();</div><div class="line">	Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">			.baseUrl(<span class="string">"http://192.168.15.20:9091"</span>)</div><div class="line">			.addConverterFactory(GsonConverterFactory.create())</div><div class="line">			.build();</div><div class="line">	<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">		<span class="keyword">long</span> end = System.currentTimeMillis();</div><div class="line">		<span class="keyword">if</span> ((end - start) &gt; <span class="number">1000</span> * <span class="number">60</span>) &#123;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		ServerListService loginServerPushService = retrofit.create(ServerListService.class);</div><div class="line">		loginServerPushService.serverlist().execute().body();</div><div class="line">		count++;</div><div class="line">	&#125;</div><div class="line">	System.out.println(count);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果如图<br><img src="" alt=""><br>这俩次的结果都能达到每分钟13000个请求, 吞吐量和性能消耗是差不多.</p>
<h2 id="Converter"><a href="#Converter" class="headerlink" title="Converter"></a>Converter</h2><p>Retrofit2为我们提供了多种转换器</p>
<ul>
<li>Gson: com.squareup.retrofit2:converter-gson</li>
<li>Jackson: com.squareup.retrofit2:converter-jackson</li>
<li>Moshi: com.squareup.retrofit2:converter-moshi</li>
<li>Protobuf: com.squareup.retrofit2:converter-protobuf</li>
<li>Wire: com.squareup.retrofit2:converter-wire</li>
<li>Simple XML: com.squareup.retrofit2:converter-simplexml</li>
<li>Scalars (primitives, boxed, and String): com.squareup.retrofit2:converter-scalars<br>在使用Retrofit2的时候, 必须指定Converter, 否则程序在运行中会报错. Scalars 只是支持String和基本类型的装包和拆包</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/20/JavaLibrary/Retrofit/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/20/JavaLibrary/Retrofit/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/19/JavaLibrary/OWNER 初探/" title="OWNER 初探" itemprop="url">OWNER 初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-19T08:00:00.000Z" itemprop="datePublished"> Published 2016-01-19</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>OWNER是一个Java库，目标是最大限度的减少应用程序中处理Java properties的代码。</p>
<p>主要功能</p>
<ul>
<li>加载策略：OWNER通过匹配接口类名和properties文件名自动解析并映射；也可以通过注解定制properties文件名。</li>
<li>导入properties：另外一种加载properties文件到映射接口的方法。</li>
<li>参数化properties：另外一个实用功能，给接口方法提供参数，通过参数配置。</li>
<li>类型转换：支持从String类型到基本类型和枚举类型的转换。</li>
<li>变量扩展：引用properties中的其他属性。</li>
<li>热加载：支持热加载。</li>
<li>可访问和可变：可以继承Config的子接口Accessible或者Mutable实现属性的可访问和可变。</li>
<li>调试：支持调试功能。</li>
<li>禁用功能：可禁用引起问题的功能。</li>
<li>配置ConfigFactory：ConfigFactory也是可配置的。</li>
<li>XML支持：支持XML配置。</li>
<li>事件支持：OWNER实现了功能丰富的事件系统，使你知道热加载的发生和属性变化。</li>
<li>单例模式：配置信息在一个应用中是单例的。</li>
</ul>
<p>OWNER同样是开源的, 我们可以使用maven来引用它<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aeonbits.owner<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>owner<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>或者使用java8版本<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aeonbits.owner<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>owner-java8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><p>我们现在在MAVEN项目中测试一下<br>首先我们在<code>test\src\main\java\ownerTest</code>目录下创建一个配置类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> ownerTest;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.aeonbits.owner.Config;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServerConfig</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">port</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">String <span class="title">hostname</span><span class="params">()</span></span>;</div><div class="line">	<span class="meta">@DefaultValue</span>(<span class="string">"42"</span>)</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">maxThreads</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后在<code>test\src\main\resources\ownerTest</code>目录下创建配置文件<code>ServerConfig.properties</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">port=<span class="number">80</span></div><div class="line">hostname=foobar.com</div><div class="line">maxThreads=<span class="number">100</span></div></pre></td></tr></table></figure></p>
<p>然后我们书写一个测试类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> ownerTest;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.aeonbits.owner.ConfigFactory;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		ServerConfig cfg = ConfigFactory.create(ServerConfig.class);</div><div class="line">		System.out.println(<span class="string">"Server "</span> + cfg.hostname() + <span class="string">":"</span> + cfg.port() + <span class="string">" will run "</span> + cfg.maxThreads());</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这时OWNER会自动地将<code>ServerConfig.properties</code>配置文件匹配到<code>ServerConfig</code>上, 输出结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Server foobar.com:<span class="number">80</span> will run <span class="number">100</span></div></pre></td></tr></table></figure></p>
<p>我们看到在<code>ServerConfig</code>里我们使用了一个<code>@DefaultValue</code>注解, 当在配置文件里找不到这个值的时候, 这个注解值会为我们设置上注解里的默认值.</p>
<blockquote>
<p>如果在配置文件里找不到这个设置也没有添加<code>@DefaultValue</code>会产生一个空指针异常</p>
</blockquote>
<p>有时候我们在配置文件里会使用<code>server.http.port=80</code>的配置, 那么这种情况下我们就在使用<code>@Key</code>注解<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> ownerTest;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.aeonbits.owner.Config;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServerConfig</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line">	<span class="meta">@Key</span>(<span class="string">"server.http.port"</span>)</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">port</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">	<span class="meta">@Key</span>(<span class="string">"server.host.name"</span>)</div><div class="line">	<span class="function">String <span class="title">hostname</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">	<span class="meta">@Key</span>(<span class="string">"server.max.threads"</span>)</div><div class="line">	<span class="meta">@DefaultValue</span>(<span class="string">"42"</span>)</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">maxThreads</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们的配置文件如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">server.http.port=<span class="number">80</span></div><div class="line">server.host.name=foobar.com</div><div class="line">server.max.threads=<span class="number">100</span></div></pre></td></tr></table></figure></p>
<h2 id="加载策略"><a href="#加载策略" class="headerlink" title="加载策略"></a>加载策略</h2><p>正如上文所说, OWNER是按照classpath去自动匹配配置类和配置文件的, 但是其实我们可以自定义配置文件的加载策略, 如下例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Sources</span>(&#123; <span class="string">"file:~/.myapp.config"</span>,</div><div class="line">           <span class="string">"file:/etc/myapp.config"</span>,</div><div class="line">           <span class="string">"classpath:foo/bar/baz.properties"</span> &#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServerConfig</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line">    <span class="meta">@Key</span>(<span class="string">"server.http.port"</span>)</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">port</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Key</span>(<span class="string">"server.host.name"</span>)</div><div class="line">    <span class="function">String <span class="title">hostname</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Key</span>(<span class="string">"server.max.threads"</span>);</div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"42"</span>)</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">maxThreads</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们使用了<code>@Sources</code>指定配置文件的路径, 按照上面的代码, 它依次按照下面的流程进行文件匹配,一旦匹配成功就进行加载忽略后面的文件</p>
<ol>
<li><code>file:~/.myapp.config</code>  从home目录开始查找</li>
<li><code>file:/etc/myapp.config</code>  从绝对目录进行查找</li>
<li><code>classpath:foo/bar/baz.properties</code>  classpath从classpath中查找</li>
</ol>
<p>其实上面的加载策略称为<code>LoadType.FIRST</code>(完整注解<code>@LoadPolicy(LoadType.FIRST)</code>). 我们还有其他选择<code>LoadType.MERGE</code>, 示例如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@LoadPolicy</span>(LoadType.MERGE)</div><div class="line"><span class="meta">@Sources</span>(&#123; <span class="string">"file:~/.myapp.config"</span>,</div><div class="line">           <span class="string">"file:/etc/myapp.config"</span>,</div><div class="line">           <span class="string">"classpath:foo/bar/baz.properties"</span> &#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServerConfig</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的加载策略是, 不管当前路径下是否找到了都会进行路径下查找, 但与<code>LoadType.FIRST</code>不同的是, 当找到之后它会替换之前知道的配置文件.</p>
<blockquote>
<p>TODO 是局部替换还是整个文件一起替换呢？</p>
</blockquote>
<h2 id="参数化"><a href="#参数化" class="headerlink" title="参数化"></a>参数化</h2><p>我们还可以向配置里传递参数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Sample</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"Hello Mr. %s!"</span>)</div><div class="line">    <span class="function">String <span class="title">helloMr</span><span class="params">(String name)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Sample cfg = ConfigFactory.create(Sample.class);</div><div class="line">print(cfg.helloMr(<span class="string">"Luigi"</span>)); <span class="comment">// will println 'Hello Mr. Luigi!'</span></div></pre></td></tr></table></figure></p>
<blockquote>
<p>OWNER还为我们提供了<code>@DisableFeature</code>注解, 让我们关闭参数化功能. 这个注解可以用在类或者方法的级别上</p>
</blockquote>
<h2 id="自定义类型"><a href="#自定义类型" class="headerlink" title="自定义类型"></a>自定义类型</h2><p>当我们使用OWNER的时候, 不仅仅可以使用原生类型, 还可以使用数组, 集合甚至是自定义类型</p>
<p>下来我们自定义一个类型<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<p>下面我们定义一个数组和集合<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfig</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@DefaultValue</span>(<span class="string">"apple, pear, orange"</span>)</div><div class="line">  <span class="keyword">public</span> String[] fruit();</div><div class="line"></div><div class="line">  <span class="meta">@Separator</span>(<span class="string">";"</span>)</div><div class="line">  <span class="meta">@DefaultValue</span>(<span class="string">"0; 1; 1; 2; 3; 5; 8; 13; 21; 34; 55"</span>)</div><div class="line">  <span class="keyword">public</span> <span class="keyword">int</span>[] fibonacci();</div><div class="line"></div><div class="line">  <span class="meta">@DefaultValue</span>(<span class="string">"1, 2, 3, 4"</span>)</div><div class="line">  <span class="function">List&lt;Integer&gt; <span class="title">ints</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="meta">@DefaultValue</span>(</div><div class="line">    <span class="string">"http://aeonbits.org, http://github.com, http://google.com"</span>)</div><div class="line">  <span class="function">MyOwnCollection&lt;URL&gt; <span class="title">myBookmarks</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">// Concrete class are allowed (in this case java.util.Stack)</span></div><div class="line">  <span class="comment">// when type is not specified &lt;String&gt; is assumed as default</span></div><div class="line">  <span class="meta">@DefaultValue</span>(</div><div class="line">    <span class="string">"The Lord of the Rings,The Little Prince,The Da Vinci Code"</span>)</div><div class="line">  <span class="function">Stack <span class="title">books</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>OWNER默认使用<code>,</code>分割元素. 但是我们可以通过<code>@Separator(&quot;;&quot;)</code>指定使用<code>;</code>进行切割, 需要注意的是OWNER只支持数组, 集合, Java原生类型, 并不支持<code>Map</code>.</p>
<blockquote>
<p>支持的集合有<code>Collection, List, Set, SortedSet</code></p>
</blockquote>
<p>虽然我们可以使用<code>@Separator(&quot;;&quot;)</code>进行切割, 但是如果我们有更复杂的切割逻辑的话, 这可能就不再符合需求了, 我们可以使用<code>@TokenizerClass</code>来实现更复杂的切割逻辑<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfig</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Separator</span>(<span class="string">";"</span>)</div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"0; 1; 1; 2; 3; 5; 8; 13; 21; 34; 55"</span>)</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] fibonacci();</div><div class="line"></div><div class="line">    <span class="meta">@TokenizerClass</span>(CustomDashTokenizer.class)</div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"foo-bar-baz"</span>)</div><div class="line">    <span class="keyword">public</span> String[] withSeparatorClass();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomDashTokenizer</span> <span class="keyword">implements</span> <span class="title">Tokenizer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// this logic can be as much complex as you need</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> String[] tokens(String values) &#123;</div><div class="line">        <span class="keyword">return</span> values.split(<span class="string">"-"</span>, -<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>虽然 <code>@Separator(&quot;;&quot;)</code> 和  <code>@TokenizerClass(CustomDashTokenizer.class)</code>都可以在方法和类的级别上进行注解, 但是他们不允许同时出现在同一个级别上, 而且当分别出现在了方法和类的级别上后, 方法上的注解会替换类上的注解.</p>
</blockquote>
<p>OWNER还提供了<code>@ConverterClass</code>注解来实现更加复杂的转换逻辑<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MyConfig</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"foobar.com:8080"</span>)</div><div class="line">    <span class="meta">@ConverterClass</span>(ServerConverter.class)</div><div class="line">    <span class="function">Server <span class="title">server</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@DefaultValue</span>(</div><div class="line">      <span class="string">"google.com, yahoo.com:8080, owner.aeonbits.org:4000"</span>)</div><div class="line">    <span class="meta">@ConverterClass</span>(ServerConverter.class)</div><div class="line">    Server[] servers();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer port;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">(String name, Integer port)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.port = port;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerConverter</span> <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">Server</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> Server <span class="title">convert</span><span class="params">(Method targetMethod, String text)</span> </span>&#123;</div><div class="line">        String[] split = text.split(<span class="string">":"</span>, -<span class="number">1</span>);</div><div class="line">        String name = split[<span class="number">0</span>];</div><div class="line">        Integer port = <span class="number">80</span>;</div><div class="line">        <span class="keyword">if</span> (split.length &gt;= <span class="number">2</span>)</div><div class="line">            port = Integer.valueOf(split[<span class="number">1</span>]);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Server(name, port);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">MyConfig cfg = ConfigFactory.create(MyConfig.class);</div><div class="line">Server s = cfg.server(); <span class="comment">// will return a single server</span></div><div class="line">Server[] ss = cfg.servers(); <span class="comment">// it works also with collections</span></div></pre></td></tr></table></figure></p>
<p>OWNER 支持的全部自动转换类型</p>
<ul>
<li>原生类型: boolean, byte, short, integer, long, float, double.</li>
<li>枚举</li>
<li>java.lang.String</li>
<li>java.net.URL, java.net.URI.</li>
<li>java.io.File</li>
<li>java.lang.Class</li>
<li>公有构造器只有一个<code>java.lang.String</code>的类</li>
<li>公有构造器只有一个<code>java.lang.Object</code>的类</li>
<li>被<code>public static</code>修饰, 签名为<code>valueOf(java.lang.String)</code>返回自身的方法</li>
<li>带有上述元素的数组</li>
<li>带有上述类的集合(<code>Set, List, SortedSet or concrete implementations like LinkedHashSet</code>). Map and sub-interfaces are not supported.</li>
</ul>
<h2 id="变量表达式"><a href="#变量表达式" class="headerlink" title="变量表达式"></a>变量表达式</h2><p>OWNER还提供了一个非常霸道的功能 —— 变量表达式, 参考如下配置文件<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attr">story=The</span> $&#123;animal&#125; jumped over the $&#123;target&#125;</div><div class="line"><span class="attr">animal=quick</span> $&#123;color&#125; fox</div><div class="line"><span class="attr">target=$&#123;target.attribute&#125;</span> dog</div><div class="line">target.<span class="attr">attribute=lazy</span></div><div class="line"><span class="attr">color=brown</span></div></pre></td></tr></table></figure></p>
<p>然后定义一个配置类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigWithExpansion</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">story</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>猜猜会输出什么, 对了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">The quick brown fox jumped over the lazy dog</div></pre></td></tr></table></figure></p>
<p>我们可以在配置文件里引用其他的配置</p>
<p>同样的我们还可以在配置类完成这样的功能<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigWithExpansion</span></span></div><div class="line">        <span class="keyword">extends</span> <span class="title">Config</span> &#123;</div><div class="line"></div><div class="line">    <span class="meta">@DefaultValue</span>(</div><div class="line">        <span class="string">"The $&#123;animal&#125; jumped over the $&#123;target&#125;"</span>)</div><div class="line">    <span class="function">String <span class="title">story</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"quick $&#123;color&#125; fox"</span>)</div><div class="line">    <span class="function">String <span class="title">animal</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"$&#123;target.attribute&#125; dog"</span>)</div><div class="line">    <span class="function">String <span class="title">target</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Key</span>(<span class="string">"target.attribute"</span>)</div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"lazy"</span>)</div><div class="line">    <span class="function">String <span class="title">targetAttribute</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"brown"</span>)</div><div class="line">    <span class="function">String <span class="title">color</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">ConfigWithExpansion conf = ConfigFactory</div><div class="line">    .create(ConfigWithExpansion.class);</div><div class="line"></div><div class="line">String story = conf.story();</div></pre></td></tr></table></figure></p>
<p>如果我们不需要开启变量表达式的话, 我们可以使用<code>@DisableFeature(VARIABLE_EXPANSION)</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Sample</span> <span class="keyword">extends</span> <span class="title">Config</span> </span>&#123;</div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"Earth"</span>)</div><div class="line">    <span class="function">String <span class="title">world</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@DisableFeature</span>(VARIABLE_EXPANSION)</div><div class="line">    <span class="meta">@DefaultValue</span>(<span class="string">"Hello $&#123;world&#125;."</span>)</div><div class="line"></div><div class="line">    <span class="comment">// will return the string "Hello $&#123;world&#125;."</span></div><div class="line">    <span class="function">String <span class="title">sayHello</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/19/JavaLibrary/OWNER 初探/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/19/JavaLibrary/OWNER 初探/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/14/asm/ASM Core(5) 工具/" title="ASM Core(5) 工具" itemprop="url">ASM Core(5) 工具</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-14T08:00:00.000Z" itemprop="datePublished"> Published 2016-01-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>ASM通过<code>org.objectweb.asm.util</code>对<code>ClassVisitor, ClassReader, ClassWriter</code>提供非常多有帮助的类，通过这些类可以帮助开发者简化字节码的操作过程.</p>
<h2 id="Type"><a href="#Type" class="headerlink" title="Type"></a>Type</h2><p>在前面的文章中我们看到ASM API暴露了存储在字节码中的类型信息等等, 但是上文中的信息我们看到了可读性比较差, 因此ASM提供了<code>Type</code>这个工具类,让我们可以像源码中那样看到可读性更高的类型信息.</p>
<p>每个<code>Type</code>对象都代表着一个java类型, 我们可以通过类型描述符或者<code>Class</code>对象中构建出一个<code>Type</code>对象. 另外<code>Type</code>中还包含一些静态成员属性用于表示原生类型, 例如<code>e Type.INT_TYPE</code>就表示int类型.</p>
<p><code>getInternalName</code>方法用于获取类型的全限定名, 例如<code>Type.getType(String.class).getInternalName()</code>我们会得到一个<code>&quot;java/lang/String&quot;.</code>值, 需要注意的是这个方法只能用在class或者interface类型上.</p>
<p><code>getDescriptor</code>方法返回一个类型的描述符. 例如<code>&quot;Ljava/lang/String;&quot;</code>代表一个字符串类型, 但是我们可以在代码中使用<code>Type.getType(String.class).getDescriptor()</code>替代这种写法, 来换取更高的可读性. </p>
<p><code>Type</code>对象还可以表示一个方法类型. 方法类型的<code>Type</code>对象可以通过方法描述符或者<code>Method</code>对象构建出来. 同样的除了我们可以使用<code>getDescriptor</code>方法外,还可以使用<code>getArgumentTypes</code>和<code>getReturnType</code>来获取方法的参数或者返回值类型. 例如<code>Type.getArgumentTypes(&quot;(I)V&quot;)</code>和<code>Type.getReturnType(&quot;(I)V&quot;)</code>来获得更好的可读性.</p>
<h2 id="TraceClassVisitor"><a href="#TraceClassVisitor" class="headerlink" title="TraceClassVisitor"></a>TraceClassVisitor</h2><p>我们使用<code>ClassWriter</code>生成的新的class字节码是一个byte数组, 这种东西根本不具有可读性,因此ASM为我们提供了<code>TraceClassVisitor</code>, 它同样是继承自<code>ClassVisitor</code>, 他会输出一个文本格式的可读的新的类出来. 下面的例子中我们同时使用了<code>ClassWriter</code>和<code>TraceClassVisitor</code>, <code>TraceClassVisitor</code>代理了<code>ClassWriter</code>的全部方法调用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</div><div class="line">TraceClassVisitor cv = <span class="keyword">new</span> TraceClassVisitor(cw, printWriter);</div><div class="line">cv.visit(...);</div><div class="line">...</div><div class="line">cv.visitEnd();</div><div class="line"><span class="keyword">byte</span> b[] = cw.toByteArray();</div></pre></td></tr></table></figure></p>
<h2 id="CheckClassAdapter"><a href="#CheckClassAdapter" class="headerlink" title="CheckClassAdapter"></a>CheckClassAdapter</h2><p><code>ClassWriter</code>并不会检查生成的方法在调用的时候是顺序且参数是否都是正确的. 因此当JVM加载类进行验证的时候可能会抛出异常. 因此当我们秉持着错误越早发现越好, ASM为我们提供了<code>CheckClassAdapter</code>, 这个工具类会为我们检查上述问题. 同样的<code>CheckClassAdapter</code>继承自<code>ClassWriter.</code>, 它可以代理<code>TraceClassVisitor</code>或者<code>ClassWriter</code>的全部方法. 下面我们给出一个示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</div><div class="line">TraceClassVisitor tcv = <span class="keyword">new</span> TraceClassVisitor(cw, printWriter);</div><div class="line">CheckClassAdapter cv = <span class="keyword">new</span> CheckClassAdapter(tcv);</div><div class="line">cv.visit(...);</div><div class="line">...</div><div class="line">cv.visitEnd();</div><div class="line"><span class="keyword">byte</span> b[] = cw.toByteArray();</div></pre></td></tr></table></figure></p>
<p>注意, 我们要确定visitor之间的顺序关系, 如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</div><div class="line">CheckClassAdapter cca = <span class="keyword">new</span> CheckClassAdapter(cw);</div><div class="line">TraceClassVisitor cv = <span class="keyword">new</span> TraceClassVisitor(cca, printWriter);</div></pre></td></tr></table></figure></p>
<p>上面的例子是先进行文本输出然后再进行方法检查, 这是因为相当于<code>TraceClassVisitor</code>最终代理了所有的方法调用</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/asm/">asm</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/14/asm/ASM Core(5) 工具/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/14/asm/ASM Core(5) 工具/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/13/asm/ASM Core(3) Methods/" title="ASM Core(3) Methods" itemprop="url">ASM Core(3) Methods</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-13T08:00:00.000Z" itemprop="datePublished"> Published 2016-01-13</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://download.forge.objectweb.org/asm/asm4-guide.pdf" target="_blank" rel="external">asm4-guide</a>学习心得</p>
<p>本文主要是讲述如何通过ASM CORE API来生成和转换编译好的方法.</p>
<h2 id="执行模型"><a href="#执行模型" class="headerlink" title="执行模型"></a>执行模型</h2><p>在讲解字节码结构之前我们要首先讲解一下JVM的执行模型.</p>
<p>java代码都是在线程中执行. 每一个线程都有它自己执行栈, 每个执行栈都是由N个栈帧组成. 每个栈帧都代表着一个方法调用, 每当我们调用一个方法的时候, 就会向当前执行栈(活动线程)中push一个栈帧. 当方法结束(return或者抛出异常)时就会将当前栈帧出栈. 然后继续调用下一个方法.</p>
<p>每一个栈帧都有俩部分组成</p>
<ul>
<li>local variables 本地变量</li>
<li>operand stack  操作数栈</li>
</ul>
<p>我们通过索引来访问local variables. operand stack存储的是操作数, 正如其名, 它也是一个栈结构, 因此我们通过Last In First Out对其进行访问.</p>
<p>local variables和 operand stack的大小取决于方法的大小. 这些大小是在编译期进行计算, 而且也是进行单独存储的.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/asm/">asm</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/13/asm/ASM Core(3) Methods/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/13/asm/ASM Core(3) Methods/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/3/"><span></span>Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/5/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github Card</p>
<div class="github-card" data-github="yu66" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
		
		  
			<li><a href="/categories/JVM/" title="JVM">JVM<sup>38</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java/" title="Java">Java<sup>42</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java-Library/" title="Java Library">Java Library<sup>42</sup></a></li>
		  
		
		  
		
		  
		
		  
		
		  
			<li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/NoSql/" title="NoSql">NoSql<sup>9</sup></a></li>
		  
		
		  
		
		  
			<li><a href="/categories/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/asm/" title="asm">asm<sup>4</sup></a></li>
		  
		
		  
		
		  
		
		  
		
		  
		
		  
			<li><a href="/categories/数据库/" title="数据库">数据库<sup>10</sup></a></li>
		  
		
		  
		
		  
			<li><a href="/categories/杂记/" title="杂记">杂记<sup>23</sup></a></li>
		  
		
		  
			<li><a href="/categories/算法/" title="算法">算法<sup>11</sup></a></li>
		  
		
		  
			<li><a href="/categories/编程语言/" title="编程语言">编程语言<sup>20</sup></a></li>
		  
		
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Netty/" title="Netty">Netty<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Guice/" title="Guice">Guice<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/Spring/" title="Spring">Spring<sup>5</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="http://vertx.yu66.wang/" target="_blank" title="vertx3">vertx3</a>
            
          </li>
        
    </ul>
</div>

  

<div class="doubanshow">
<p class="asidetitle">Douban Show</p>
<div>
<script type="text/javascript" src="http://www.douban.com/service/badge/xxxyy/?show=collection&amp;n=12&amp;columns=3&amp;hidelogo=yes&amp;hideself=yes&amp;cat=book|movie" ></script>
</div>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=3253370782&verifier=e9ca895b&dpc=1"></iframe>
</div>


  

<div class="lofter">
<p class="asidetitle">Lofter</p>

 <iframe width="100%" height="39" class="share_self"  frameborder="0" scrolling="no" src="http://ming15.lofter.com/"></iframe>
</div>




</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 博客,我选择重构 <br/>
			重构使事情变得更美,更加正确</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/3253370782" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/yu66" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		<a href="https://www.douban.com/people/xxxyy" target="_blank" class="icon-douban" title="豆瓣"></a>
		
		
		<a href="http://www.zhihu.com/people/ming15" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="王玉">王玉</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"wanggnim"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F9e8fca440159a2125668804e46682db4' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
