
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>大王玉的技术博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="大王玉">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="大王玉的技术博客">
<meta property="og:url" content="http://www.yu66.wang/page/4/index.html">
<meta property="og:site_name" content="大王玉的技术博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="大王玉的技术博客">

    
    <link rel="alternative" href="/atom.xml" title="大王玉的技术博客" type="application/atom+xml">
    
    
    
    <link rel="apple-touch-icon" href="/img/author.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/author.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="大王玉的技术博客">大王玉的技术博客</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜單">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
						<form class="search" action="http://zhannei.baidu.com/cse/search" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= 17728547076946147000 ><input type="text" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/13/JavaLibrary/ASM Core(3) Methods/" title="ASM Core(3) Methods" itemprop="url">ASM Core(3) Methods</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-12T16:00:00.000Z" itemprop="datePublished"> 發表於 2016-01-13</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://download.forge.objectweb.org/asm/asm4-guide.pdf" target="_blank" rel="external">asm4-guide</a>学习心得</p>
<p>本文主要是讲述如何通过ASM CORE API来生成和转换编译好的方法.</p>
<h2 id="执行模型"><a href="#执行模型" class="headerlink" title="执行模型"></a>执行模型</h2><p>在讲解字节码结构之前我们要首先讲解一下JVM的执行模型.</p>
<p>java代码都是在线程中执行. 每一个线程都有它自己执行栈, 每个执行栈都是由N个栈帧组成. 每个栈帧都代表着一个方法调用, 每当我们调用一个方法的时候, 就会向当前执行栈(活动线程)中push一个栈帧. 当方法结束(return或者抛出异常)时就会将当前栈帧出栈. 然后继续调用下一个方法.</p>
<p>每一个栈帧都有俩部分组成</p>
<ul>
<li>local variables 本地变量</li>
<li>operand stack  操作数栈</li>
</ul>
<p>我们通过索引来访问local variables. operand stack存储的是操作数, 正如其名, 它也是一个栈结构, 因此我们通过Last In First Out对其进行访问.</p>
<p>local variables和 operand stack的大小取决于方法的大小. 这些大小是在编译期进行计算, 而且也是进行单独存储的.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/asm/">asm</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/13/JavaLibrary/ASM Core(3) Methods/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/13/JavaLibrary/ASM Core(3) Methods/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/12/JavaLibrary/ASM Core(2) 操作/" title="ASM Core(2) Class的增删改查" itemprop="url">ASM Core(2) Class的增删改查</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-11T16:00:00.000Z" itemprop="datePublished"> 發表於 2016-01-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://download.forge.objectweb.org/asm/asm4-guide.pdf" target="_blank" rel="external">asm4-guide</a>学习心得</p>
<h2 id="获取class信息"><a href="#获取class信息" class="headerlink" title="获取class信息"></a>获取class信息</h2><p>下来的示例中我们通过重写<code>ClassVisitor</code>相关函数然后依次打印出类型信息, 字段信息和函数信息.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassPrinter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClassPrinter</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(Opcodes.ASM4);</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> version, <span class="keyword">int</span> access, String name, String signature, String superName, String[] interfaces)</span> </span>&#123;</div><div class="line">		System.out.println(name + <span class="string">" extends "</span> + superName + <span class="string">" &#123;"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitSource</span><span class="params">(String source, String debug)</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitOuterClass</span><span class="params">(String owner, String name, String desc)</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> AnnotationVisitor <span class="title">visitAnnotation</span><span class="params">(String desc, <span class="keyword">boolean</span> visible)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitAttribute</span><span class="params">(Attribute attr)</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitInnerClass</span><span class="params">(String name, String outerName, String innerName, <span class="keyword">int</span> access)</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> FieldVisitor <span class="title">visitField</span><span class="params">(<span class="keyword">int</span> access, String name, String desc, String signature, Object value)</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">" "</span> + desc + <span class="string">" "</span> + name);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> access, String name, String desc, String signature, String[] exceptions)</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">" "</span> + name + desc);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"&#125;"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后我们写一段运行代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		<span class="comment">// 读取解析二进制字节流</span></div><div class="line">		ClassReader cr = <span class="keyword">new</span> ClassReader(<span class="string">"Test"</span>);</div><div class="line">		ClassPrinter cp = <span class="keyword">new</span> ClassPrinter();</div><div class="line">		<span class="comment">// 开始处理字节流信息</span></div><div class="line">		cr.accept(cp, <span class="number">0</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Test extends java/lang/Object &#123;</div><div class="line"> &lt;init&gt;()<span class="function">V</span></div><div class="line"> <span class="title">main</span><span class="params">([Ljava/lang/String;)</span>V</div><div class="line"> lambda$main$22<span class="params">(Ljava/lang/Integer;)</span>V</div><div class="line"> lambda$main$21<span class="params">(Ljava/lang/Integer;Ljava/lang/Integer;)</span>I</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在测试代码中我们首先创建了一个<code>ClassReader</code>实例用于读取<code>Test</code>字节码. 然后由<code>accept()</code>方法依次调用<code>ClassPrinter</code>的方法</p>
<h2 id="动态生成Class"><a href="#动态生成Class" class="headerlink" title="动态生成Class"></a>动态生成Class</h2><p>我们仅仅使用<code>ClassWriter</code>就可以生成一个类, 例如我们要生成一个如下的接口<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> pkg;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Comparable</span> <span class="keyword">extends</span> <span class="title">Mesurable</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> LESS = -<span class="number">1</span>;</div><div class="line">	<span class="keyword">int</span> EQUAL = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> GREATER = <span class="number">1</span>;</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Object o)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们仅仅需要调用<code>ClassVisitor</code>的六个方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</div><div class="line">		cw.visit(V1_8,											<span class="comment">// 指定class文件版本号, 我们将其设置为java8</span></div><div class="line">				ACC_PUBLIC + ACC_ABSTRACT + ACC_INTERFACE,	<span class="comment">// 设置接口的修饰符, 需要指出的是由于interface是不可实例化的,</span></div><div class="line">																<span class="comment">// 因此我们将其设置为ACC_ABSTRACT的</span></div><div class="line">				<span class="string">"pkg/Comparable"</span>,								<span class="comment">// 我们设置classname, 需要在这里指定全限定名</span></div><div class="line">				<span class="keyword">null</span>,											<span class="comment">// 设置泛型信息, 因为我们的接口是非泛化的, 因此我们将其设置为null</span></div><div class="line">				<span class="string">"java/lang/Object"</span>,							<span class="comment">// 设置父类, 同时需要设定全限定名</span></div><div class="line">				<span class="keyword">new</span> String[] &#123; <span class="string">"pkg/Mesurable"</span> &#125;);			<span class="comment">// 设置接口, 同样需要设置全限定名</span></div><div class="line"></div><div class="line">		cw.visitField(</div><div class="line">				ACC_PUBLIC + ACC_FINAL + ACC_STATIC,	<span class="comment">// 设置字段的修饰符</span></div><div class="line">				<span class="string">"LESS"</span>,										<span class="comment">// 设置字段名</span></div><div class="line">				<span class="string">"I"</span>,										<span class="comment">// 设置字段类型</span></div><div class="line">				<span class="keyword">null</span>,										<span class="comment">// 设置泛型信息</span></div><div class="line">				<span class="keyword">new</span> Integer(-<span class="number">1</span>))							<span class="comment">// 设置字面量值. (如果这个字段是常量值的话,例如 final static,</span></div><div class="line">																					<span class="comment">// 那么我们就必须设置这个值)</span></div><div class="line">				.visitEnd();</div><div class="line"></div><div class="line">		cw.visitMethod(ACC_PUBLIC + ACC_ABSTRACT,		<span class="comment">// 设置字段的修饰符</span></div><div class="line">				<span class="string">"compareTo"</span>,								<span class="comment">// 设置方法名</span></div><div class="line">				<span class="string">"(Ljava/lang/Object;)I"</span>,					<span class="comment">// 设置返回值类型</span></div><div class="line">				<span class="keyword">null</span>,										<span class="comment">// 设置泛型信息</span></div><div class="line">				<span class="keyword">null</span>)										<span class="comment">// 设置异常信息</span></div><div class="line">				.visitEnd();</div><div class="line"></div><div class="line">		cw.visitEnd();</div><div class="line">		<span class="keyword">byte</span>[] b = cw.toByteArray();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="使用生成的类"><a href="#使用生成的类" class="headerlink" title="使用生成的类"></a>使用生成的类</h2><p>记下来我们自定义一个<code>ClassLoader</code>来加载生成的字节码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> Class <span class="title">defineClass</span><span class="params">(String name, <span class="keyword">byte</span>[] b)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> defineClass(name, b, <span class="number">0</span>, b.length);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后使用它<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">byte</span>[] bytes = genComparableInterface();</div><div class="line">MyClassLoader myClassLoader = <span class="keyword">new</span> MyClassLoader();</div><div class="line">Class c = myClassLoader.defineClass(<span class="string">"pkg.Comparable"</span>, bytes);</div></pre></td></tr></table></figure></p>
<p>我们直接使用<code>defineClass</code>函数来加载这个类.</p>
<p>另外我们还可以重写<code>findClass</code>这个函数来动态的生成我们所需要的类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StubClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> Class <span class="title">findClass</span><span class="params">(String name)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</div><div class="line">		<span class="keyword">if</span> (name.endsWith(<span class="string">"_Stub"</span>)) &#123;</div><div class="line">			ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</div><div class="line">			...</div><div class="line">			<span class="keyword">byte</span>[] b = cw.toByteArray();</div><div class="line">			<span class="keyword">return</span> defineClass(name, b, <span class="number">0</span>, b.length);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.findClass(name);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="修改已存在的Class"><a href="#修改已存在的Class" class="headerlink" title="修改已存在的Class"></a>修改已存在的Class</h2><p>在上篇文章中我们只是单独的使用了<code>ClassReader</code>和<code>ClassWriter</code>,但是更多的应用其实应该是将其组合到一起使用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">byte</span>[] b1 = ...;</div><div class="line">ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</div><div class="line">ClassReader cr = <span class="keyword">new</span> ClassReader(b1);</div><div class="line">cr.accept(cw, <span class="number">0</span>);</div><div class="line"><span class="keyword">byte</span>[] b2 = cw.toByteArray(); <span class="comment">// b2 represents the same class as b1</span></div></pre></td></tr></table></figure></p>
<p>这个例子中我们什么都没有做, 只不过完成了一个copy字节码的功能, 接下来我们在这俩个过程中加入<code>ClassVisitor</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">byte</span>[] b1 = ...;</div><div class="line">ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</div><div class="line"><span class="comment">// cv forwards all events to cw</span></div><div class="line">ClassVisitor cv = <span class="keyword">new</span> ClassVisitor(ASM4, cw) &#123; &#125;;</div><div class="line">ClassReader cr = <span class="keyword">new</span> ClassReader(b1);</div><div class="line">cr.accept(cv, <span class="number">0</span>);</div><div class="line"><span class="keyword">byte</span>[] b2 = cw.toByteArray(); <span class="comment">// b2 represents the same class as b1</span></div></pre></td></tr></table></figure></p>
<p>这段代码的处理流程如下图<img src="https://raw.githubusercontent.com/yu66/blog-website/images/asm/transformation%20chain.jpg" alt=""></p>
<blockquote>
<p>方框代表我们的核心组件, 箭头代表我们的数据流.</p>
</blockquote>
<p>下面我们给出一个<code>ClassVisitor</code>小例子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeVersionAdapter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ChangeVersionAdapter</span><span class="params">(ClassVisitor cv)</span> </span>&#123;</div><div class="line">		<span class="comment">// ASM4为ASM的版本号</span></div><div class="line">		<span class="keyword">super</span>(ASM4, cv);</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> version, <span class="keyword">int</span> access, String name,</span></span></div><div class="line">					  String signature, String superName, String[] interfaces) &#123;</div><div class="line">		<span class="comment">// 修改class信息</span></div><div class="line">		cv.visit(V1_5,			<span class="comment">// 改变class的版本号</span></div><div class="line">				access,			<span class="comment">// 改变class的标识符</span></div><div class="line">				name,			<span class="comment">// 改变类名</span></div><div class="line">				signature,		<span class="comment">// 泛型信息</span></div><div class="line">				superName,		<span class="comment">// 父类信息</span></div><div class="line">				interfaces);	<span class="comment">// 接口信息</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在上面的实现中,除了调用<code>visit</code>函数(修改类本身函数, 将class版本号转化为1.5), 其他的方法都没有重写,因此他们什么改变都不会做. 下来我们给出这个类执行的时序图<br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/asm/Sequence%20diagram%20for%20the%20ChangeVersionAdapter.jpg" alt=""><br>从这个时序图中我们可以看出, 用户调用了<code>accept</code>方法之后, 有ASM自动调用<code>ClassReader</code>的<code>visti(version)</code>方法, 接着调用<code>ChangeVersionAdapter</code>的<code>visti(1.5)</code>方法, 最后调用<code>ClassWriter</code>的相关方法. 从这个模式中我们可以看出, ASM的调用模式是链式调用的, 先调用visit, 然后调用责任链中所有的<code>ClassVisitor</code>的vist最后调用<code>ClassWriter</code>的完结方法. 当<code>visit</code>调用完之后再调用<code>visitSource</code>责任链流程, 依次类推下去.</p>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>在上述的代码中, 其实代码的运行效率并不是高效进行的. 这是因为当<code>b1</code>字节码被<code>ClassReader</code>读取并通过<code>ClassVisitor</code>将其执行转换的时候, 我们可能只改变了class的版本号, 其他部分并没有转换, 但是在实际的执行中其他的部分也都被执行了一边, 那这就浪费了cpu计算和内存空间的占用, 其实只需要将不需要改变的字节从<code>b1</code>直接拷贝到<code>b2</code>就好了.  </p>
<p>好在ASM为我们内部构建了这种优化过程.<br>*</p>
<h2 id="删除成员"><a href="#删除成员" class="headerlink" title="删除成员"></a>删除成员</h2><p>如果我们想将class中的某个成员删除掉, 那么只需在执行asm责任链调用时, 中断调用过程(不调用super或者直接return)就可以了.</p>
<p>例如我们下面的例子我们将类中的内部类和外部类以及编译成该class的源文件信息删除掉<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RemoveDebugAdapter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">RemoveDebugAdapter</span><span class="params">(ClassVisitor cv)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(ASM4, cv);</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitSource</span><span class="params">(String source, String debug)</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitOuterClass</span><span class="params">(String owner, String name, String desc)</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitInnerClass</span><span class="params">(String name, String outerName, String innerName, <span class="keyword">int</span> access)</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看,就是如此简单, 我们在这三个方法内部什么都不做(不进行super调用)就轻松地完成了我们需要的功能, 但是这种做法却并不适合<br>字段和方法的删除, 因为在字段和方法的删除中除了不进行super调用之外还需要return null, 如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RemoveMethodAdapter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> String mName;</div><div class="line">	<span class="keyword">private</span> String mDesc;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">RemoveMethodAdapter</span><span class="params">(</span></span></div><div class="line">			ClassVisitor cv, String mName, String mDesc) &#123;</div><div class="line">		<span class="keyword">super</span>(ASM4, cv);</div><div class="line">		<span class="keyword">this</span>.mName = mName;</div><div class="line">		<span class="keyword">this</span>.mDesc = mDesc;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> access, String name,</span></span></div><div class="line">									 String desc, String signature, String[] exceptions) &#123;</div><div class="line">		<span class="keyword">if</span> (name.equals(mName) &amp;&amp; desc.equals(mDesc)) &#123;</div><div class="line">			<span class="comment">// do not delegate to next visitor -&gt; this removes the method</span></div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> cv.visitMethod(access, name, desc, signature, exceptions);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="添加成员"><a href="#添加成员" class="headerlink" title="添加成员"></a>添加成员</h2><p>当我们中断方法调用的时候,会删除成员. 但是当我们在责任链中的原生方法调用(<code>visitXxx</code>方法)中新增加一些方法调用的话, 会增加成员.</p>
<p>例如如果你想要增加一个字段, 那么你必须在<code>visitXxx</code>方法中增加一个<code>visitField</code>方法调用. 需要注意的是<code>visitXxx</code>方法只包含<code>visitInnerClass,visitField, visitMethod,visitEnd</code>这四个方法, 这是因为<code>visit,visitSource,visitOuterClass,visitAnnotation,visitAttribute</code> 这些方法正如我们在第一篇文章中给出那些顺序一样, <code>visitField</code>方法只能在这些方法之后调用.</p>
<blockquote>
<p>需要注意的是,由于<code>visitInnerClass,visitField, visitMethod</code>这些方法会进行多次调用, 因此有可能会添加N个相同的成员, 因此我们建议在<code>visitEnd</code>的时候进行成员添加, 这是因为这个方法总会有且只有一次调用.</p>
</blockquote>
<p>如下例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddFieldAdapter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> fAcc;</div><div class="line">	<span class="keyword">private</span> String fName;</div><div class="line">	<span class="keyword">private</span> String fDesc;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> isFieldPresent;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">AddFieldAdapter</span><span class="params">(ClassVisitor cv, <span class="keyword">int</span> fAcc, String fName, String fDesc)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(ASM4, cv);</div><div class="line">		<span class="keyword">this</span>.fAcc = fAcc;</div><div class="line">		<span class="keyword">this</span>.fName = fName;</div><div class="line">		<span class="keyword">this</span>.fDesc = fDesc;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> FieldVisitor <span class="title">visitField</span><span class="params">(<span class="keyword">int</span> access, String name, String desc, String signature, Object value)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (name.equals(fName)) &#123;</div><div class="line">			isFieldPresent = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> cv.visitField(access, name, desc, signature, value);</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (!isFieldPresent) &#123;</div><div class="line">			FieldVisitor fv = cv.visitField(fAcc, fName, fDesc, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">			<span class="keyword">if</span> (fv != <span class="keyword">null</span>) &#123;</div><div class="line">				fv.visitEnd();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		cv.visitEnd();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/asm/">asm</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/12/JavaLibrary/ASM Core(2) 操作/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/12/JavaLibrary/ASM Core(2) 操作/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/11/JavaLibrary/ASM Core(1) 初探/" title="ASM Core(1) 初探" itemprop="url">ASM Core(1) 初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2016-01-10T16:00:00.000Z" itemprop="datePublished"> 發表於 2016-01-11</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://download.forge.objectweb.org/asm/asm4-guide.pdf" target="_blank" rel="external">asm4-guide</a>学习心得<br> ASM是一种小巧轻便的 Java 字节码操控框架，它能方便地生成和改造 Java 代码</p>
<p>ASM通过<code>ClassVisitor</code>来生成和转换class字节码. <code>ClassVisitor</code>中的每个方法都对应着class数据结构, 你可以通过每个方法名轻松的判断出这个方法对应的是哪个数据结构. </p>
<p><code>ClassVisitor</code>内的方法调用顺序如下:</p>
<ol>
<li>visit  : 调用<code>visit</code>方法(有且仅有调用一次)</li>
<li>visitSource?  : 调用<code>visitSource</code>函数(最多调用一次)</li>
<li>visitOuterClass?  : 调用<code>visitOuterClass</code>函数(最多调用一次)</li>
<li>( visitAnnotation | visitAttribute )* : 调用<code>visitAnnotation</code>和<code>visitAttribute</code>函数, 这俩个函数的调用可调用任意次且不分前后顺序</li>
<li>( visitInnerClass | visitField | visitMethod )* : 调用<code>visitInnerClass</code>,<code>visitField</code>和<code>visitMethod</code>函数, 同样对这三个函数的调用不限制次数以及不分前后顺序</li>
<li>visitEnd : 调用<code>visitEnd</code>函数(有且仅有调用一次),调用这个函数用于结束整个过程.</li>
</ol>
<p>ASM通过基于<code>ClassVisitor</code>的三个API来生成和转换class字节码</p>
<ul>
<li><code>ClassReader</code>: 用于解析一个给定的class二进制字节数组, 然后按照上文介绍的顺序依次调用<code>accept()</code>的<code>ClassVisitor</code>参数的方法.</li>
<li><code>ClassWriter</code> : 一个<code>ClassVisitor</code>的子类, 用于直接生成二进制的字节码. </li>
<li><code>ClassVisitor</code> : 代理了全部的字节码相关的方法调用. 它接收另一个<code>ClassVisitor</code>对象形成责任链模式调用.</li>
</ul>
<p>我们通过<code>ClassReader</code>来解析一个二进制的class结构数据, 然后<code>ClassReader</code>按照一定的顺序调用<code>ClassVisitor</code> 来改变class结构数据, 最后通过<code>ClassVisitor</code>生成新的class二进制数据.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/asm/">asm</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/11/JavaLibrary/ASM Core(1) 初探/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/01/11/JavaLibrary/ASM Core(1) 初探/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/16/编程语言/PHP 语法初探/" title="PHP 语法初探" itemprop="url">PHP 语法初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2015-12-15T16:00:00.000Z" itemprop="datePublished"> 發表於 2015-12-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>PHP 脚本以 <code>&lt;?php 开头，以 ?&gt;</code> 结尾：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">// 此处是 PHP 代码</span></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">// 定义一个变量</span></div><div class="line">$x=<span class="number">5</span>;</div><div class="line"><span class="comment">// 调用echo函数输出变量x的值</span></div><div class="line"><span class="keyword">echo</span> $x;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>PHP 有三种不同的变量作用域：</p>
<ul>
<li>local : 函数里定义的变量,只能在函数内部访问,函数外部不可访问</li>
<li>global: 函数外部定义的变量,只能在函数外部访问,函数内部不可访问</li>
<li>static: 当变量脱离它的作用域之后,并不会被删除掉,而是缓存起来</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$x=<span class="number">5</span>; <span class="comment">// 全局作用域</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">socpePrint</span><span class="params">()</span> </span>&#123;</div><div class="line">  $y=<span class="number">10</span>; <span class="comment">// 局部作用域</span></div><div class="line">  <span class="keyword">echo</span> $y;</div><div class="line">  <span class="keyword">echo</span> $x;</div><div class="line">&#125; </div><div class="line"></div><div class="line">myTest();</div><div class="line"></div><div class="line"><span class="keyword">echo</span> $y;</div><div class="line"><span class="keyword">echo</span> $x;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>刚才我们只是介绍了<code>global</code>这个作用域,其实还有<code>global</code>关键字,这个关键字是在函数内部定义一个全局变量,让函数外访问函数内部的变量<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">socpePrint</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">global</span> $x=<span class="number">10</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">socpePrint();</div><div class="line"><span class="keyword">echo</span> $x;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>php里有如下的数据类型</p>
<ul>
<li>字符串</li>
<li>整数</li>
<li>浮点数</li>
<li>逻辑</li>
<li>数组</li>
<li>对象</li>
<li>NULL<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$stringVar=<span class="string">"this is a string"</span>;	<span class="comment">// 定义一个字符串</span></div><div class="line">$numVar=<span class="number">10</span>;	<span class="comment">// 定义一个整数</span></div><div class="line">$floatVar=<span class="number">1.0</span>;	<span class="comment">// 定义一个浮点数</span></div><div class="line">$boolVar=<span class="keyword">true</span>;		<span class="comment">// 定义一个布尔值</span></div><div class="line">$arrayVar=<span class="keyword">array</span>(<span class="number">1</span>,<span class="number">2</span>);	<span class="comment">// 定义一个数组</span></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>数组相关操作<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$arrayVar=<span class="keyword">array</span>(<span class="number">1</span>,<span class="number">2</span>);	<span class="comment">// 定义一个数组</span></div><div class="line">$ele1=$arrayVar[<span class="number">0</span>];	<span class="comment">// 访问数组第一个元素</span></div><div class="line">$arrayCount=count($arrayVar);	<span class="comment">// 求数组长度</span></div><div class="line">$arrayVar[<span class="number">2</span>]=<span class="number">3</span>;		<span class="comment">// 向数组中追加元素</span></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>下面我们定义了一个求和函数, 这个函数定义了俩个参数<code>x, y</code>, 其中y是一个默认参数,它有一个默认值, 最后我们还定义了一个函数返回值.<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span><span class="params">($x,$y=<span class="number">5</span>)</span> </span>&#123;</div><div class="line">  $z=$x+$y;</div><div class="line">  <span class="keyword">return</span> $z;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">echo</span> sum(<span class="number">5</span>,<span class="number">10</span>);</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="常量函数"><a href="#常量函数" class="headerlink" title="常量函数"></a>常量函数</h3><p>在php中,我们如果想要定义一个常量,则必须使用常量函数<code>define()</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">define(<span class="string">"constant"</span>, <span class="string">"I am constant"</span>, <span class="keyword">true</span>);</div><div class="line"><span class="keyword">echo</span> CONSTANT;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>最后一个参数是一个可选参数,如果设置为true,则说明访问常量的时候是不区分大小写的. 访问常量则不需要<code>$</code>符号</p>
<h3 id="日期函数"><a href="#日期函数" class="headerlink" title="日期函数"></a>日期函数</h3><p>我们使用<code>date(format,timestamp)</code>函数来获得系统的时间, 第二个参数是可选的,如果不填则是当前时间. 第一个参数则是格式化时间戳的格式, 有如下选项</p>
<ul>
<li><code>d</code> - 表示月里的某天（01-31）</li>
<li><code>m</code> - 表示月（01-12）</li>
<li><code>Y</code> - 表示年（四位数）</li>
<li><code>1</code> - 表示周里的某天</li>
<li><code>h</code> - 带有首位零的 12 小时小时格式</li>
<li><code>i</code> - 带有首位零的分钟</li>
<li><code>s</code> - 带有首位零的秒（00 -59）</li>
<li><code>a</code> - 小写的午前和午后（am 或 pm）<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">&lt;?php</span> </div><div class="line">$now = date(<span class="string">"Y-m-d h:i:sa"</span>);</div><div class="line"><span class="keyword">echo</span> $now;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h2><h3 id="if-else"><a href="#if-else" class="headerlink" title="if else"></a>if else</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">define(<span class="string">"TEN"</span>, <span class="number">10</span>);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (TEN&lt;<span class="string">"20"</span>) &#123;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"10 &lt; 20"</span>;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">	<span class="keyword">echo</span> <span class="string">"ERROR"</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>如果还有其他条件的话我们可以采用<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">define(<span class="string">"TEN"</span>, <span class="number">10</span>);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (TEN&lt;<span class="number">20</span>) &#123;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"10 &lt; 20"</span>;</div><div class="line">&#125; <span class="keyword">elseif</span> (TEN==<span class="number">20</span>) &#123;</div><div class="line">  <span class="keyword">echo</span> <span class="string">"ERROR"</span>;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">	<span class="keyword">echo</span> <span class="string">"ERROR"</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">switch</span> ($x)</div><div class="line">&#123;</div><div class="line"><span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">  <span class="keyword">echo</span> <span class="string">"Number 1"</span>;</div><div class="line">  <span class="keyword">break</span>;</div><div class="line"><span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">  <span class="keyword">echo</span> <span class="string">"Number 2"</span>;</div><div class="line">  <span class="keyword">break</span>;</div><div class="line"><span class="keyword">default</span>:</div><div class="line">  <span class="keyword">echo</span> <span class="string">"No number between 1 and 3"</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<h3 id="while"><a href="#while" class="headerlink" title="while"></a>while</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> </div><div class="line">$x=<span class="number">1</span>; </div><div class="line"><span class="keyword">while</span>($x&lt;=<span class="number">5</span>) &#123;</div><div class="line">  <span class="keyword">echo</span> <span class="string">"这个数字是：$x &lt;br&gt;"</span>;</div><div class="line">  $x++;</div><div class="line">&#125; </div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<h3 id="for"><a href="#for" class="headerlink" title="for"></a>for</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> </div><div class="line"><span class="keyword">for</span> ($x=<span class="number">0</span>; $x&lt;=<span class="number">10</span>; $x++) &#123;</div><div class="line">  <span class="keyword">echo</span> $x;</div><div class="line">&#125; </div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>另外还有一种适用于数组的foreach<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> </div><div class="line">$colors = <span class="keyword">array</span>(<span class="string">"red"</span>,<span class="string">"green"</span>,<span class="string">"blue"</span>,<span class="string">"yellow"</span>); </div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($colors <span class="keyword">as</span> $value) &#123;</div><div class="line">  <span class="keyword">echo</span> <span class="string">"$value"</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>如果我们遍历数组的时候,数组的元素是一个键值对的话, 我们可以这样处理<br>&lt;?php<br>$colors = array(“red:555”,”green:123”,”blue:856”); </p>
<p>foreach ($colors as $colerKey =&gt; $colorValue) {<br>  echo “$colerKey  is $colorValue”;<br>}<br>?&gt;<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">`=&gt;`就表示一个键值对</div><div class="line"></div><div class="line">## 文件</div><div class="line">我们使用`fopen(fileName, openMode)`函数打开文件, 第一个参数是文件名, 第二个参数打开模式</div><div class="line">* `r`:	打开文件为只读。文件指针在文件的开头开始。</div><div class="line">* `w`:	打开文件为只写。删除文件的内容或创建一个新的文件，如果它不存在。文件指针在文件的开头开始。</div><div class="line">* `a`:	打开文件为只写。文件中的现有数据会被保留。文件指针在文件结尾开始。创建新的文件，如果文件不存在。</div><div class="line">* `x`:	创建新文件为只写。返回 FALSE 和错误，如果文件已存在。</div><div class="line">* `r+`:	打开文件为读/写、文件指针在文件开头开始。</div><div class="line">* `w+`:	打开文件为读/写。删除文件内容或创建新文件，如果它不存在。文件指针在文件开头开始。</div><div class="line">* `a+`:	打开文件为读/写。文件中已有的数据会被保留。文件指针在文件结尾开始。创建新文件，如果它不存在。</div><div class="line">* `x+`:	创建新文件为读/写。返回 FALSE 和错误，如果文件已存在。</div><div class="line">```php</div><div class="line">&lt;?php</div><div class="line">$demofile = fopen(<span class="string">"demo.txt"</span>, <span class="string">"r"</span>) or die(<span class="string">"Unable to open file!"</span>);</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p>读取文件内容, <code>fread()</code>函数会读取整个文件内容<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> </div><div class="line">$demofile = fopen(<span class="string">"demo.txt"</span>, <span class="string">"r"</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Unable to open file!"</span>);</div><div class="line">fread($demofile,filesize(<span class="string">"demo.txt"</span>));</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>按行读取<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$demofile = fopen(<span class="string">"demo.txt"</span>, <span class="string">"r"</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Unable to open file!"</span>);</div><div class="line"><span class="keyword">while</span>(!feof($demofile)) &#123;	<span class="comment">// 如果文件没有到达结尾的话,则继续读取</span></div><div class="line">  <span class="keyword">echo</span> fgets($demofile);	<span class="comment">// 读取一行</span></div><div class="line">&#125;</div><div class="line">fclose($myfile);		<span class="comment">// 关闭文件</span></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>向文件中写入数据<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> </div><div class="line">$demofile = fopen(<span class="string">"demo.txt"</span>, <span class="string">"w"</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Unable to open file!"</span>);</div><div class="line">fwrite($demofile, <span class="string">"hello world"</span>);</div><div class="line">fclose($myfile);</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h2><p>建立连接<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> </div><div class="line"><span class="comment">// 建立mysql连接</span></div><div class="line">$con = mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</div><div class="line"><span class="keyword">if</span> (!$con) &#123;</div><div class="line">  <span class="keyword">die</span>(<span class="string">'Could not connect: '</span> . mysql_error());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 选择数据库</span></div><div class="line">mysql_select_db(<span class="string">"my_db"</span>, $con);</div><div class="line"></div><div class="line"><span class="comment">// 执行sql语句</span></div><div class="line">$result = mysql_query(<span class="string">"SELECT * FROM Persons"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 遍历结果</span></div><div class="line"><span class="keyword">while</span>($row = mysql_fetch_array($result)) &#123;</div><div class="line">	<span class="comment">// 输出某个列元素</span></div><div class="line">  <span class="keyword">echo</span> $row[<span class="string">'FirstName'</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 关闭连接</span></div><div class="line">mysql_close($con);</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/12/16/编程语言/PHP 语法初探/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/12/16/编程语言/PHP 语法初探/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/09/JavaLibrary/lombok/" title="Lombok初探" itemprop="url">Lombok初探</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2015-12-08T16:00:00.000Z" itemprop="datePublished"> 發表於 2015-12-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>参考文档<a href="https://projectlombok.org/features/index.html" target="_blank" rel="external">lombok</a><br>在使用lombok的时候, 我们需要在IDE上安装上lombok插件以及引用相关的jar包依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>lombok其实帮我们做的事情是, 在编译java源码的时候,会根据相关注解编译出相关的代码. 例如如果我们使用<code>@Setter</code>注解的话,那么在编译的会在class文件中添加相应的setter代码</p>
<h2 id="val"><a href="#val" class="headerlink" title="val"></a>val</h2><p>下来我们看一个小例子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">val example = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">example.add(<span class="string">"Hello, World!"</span>);</div><div class="line">val foo = example.get(<span class="number">0</span>);</div><div class="line">System.out.println(foo.equals(<span class="string">"Hello, World!"</span>));</div></pre></td></tr></table></figure></p>
<p>上面这个例子我们使用val代替了<code>ArrayList</code>类型. 插件会只能地帮我们识别出这个真正的类型是什么.</p>
<blockquote>
<p>注意, <code>new ArrayList&lt;String&gt;()</code>菱形符里应该指定类型,否则我们既可以在example上添加String又可以添加int,会带来类型上的不安全</p>
</blockquote>
<h2 id="NonNull"><a href="#NonNull" class="headerlink" title="NonNull"></a>NonNull</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestNonNull</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		print(<span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(@NonNull String content)</span> </span>&#123;</div><div class="line">		System.out.println(content);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个注解很简单就是检查参数非null,如果传进的参数为null的就抛出<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Exception in thread <span class="string">"main"</span> java.lang.NullPointerException: content</div><div class="line">	at Lombok.TestNonNull.print(TestNonNull.java:<span class="number">13</span>)</div><div class="line">	at Lombok.TestNonNull.main(TestNonNull.java:<span class="number">10</span>)</div></pre></td></tr></table></figure></p>
<h2 id="Cleanup"><a href="#Cleanup" class="headerlink" title="Cleanup"></a>Cleanup</h2><p>这个注解会在资源在其作用域离开之后,自动将资源关闭掉<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Cleanup</span> BufferedReader fileReader1 = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(<span class="string">"D://hazelcast-documentation-3.5.3.pdf"</span>));</div></pre></td></tr></table></figure></p>
<h2 id="Getter-Setter"><a href="#Getter-Setter" class="headerlink" title="Getter Setter"></a>Getter Setter</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestGetterSetter</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		A a = <span class="keyword">new</span> A();</div><div class="line">		a.getA2();</div><div class="line">		a.getA3();</div><div class="line">		a.setA1(<span class="string">"a1"</span>);</div><div class="line">		a.setA3(<span class="string">"a3"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Setter</span> <span class="keyword">private</span> String a1;</div><div class="line">	<span class="meta">@Getter</span> <span class="keyword">private</span> String a2;</div><div class="line">	<span class="meta">@Setter</span> <span class="meta">@Getter</span> <span class="keyword">private</span> String a3;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>@Getter</code>和<code>@Setter</code>注解有一点需要说明的是,我们可以指定他们的访问级别<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Setter</span>(value = AccessLevel.MODULE) <span class="keyword">private</span> String a1;</div></pre></td></tr></table></figure></p>
<p>可设置的级别有:</p>
<ul>
<li>PUBLIC,</li>
<li>MODULE,</li>
<li>PROTECTED,</li>
<li>PACKAGE,</li>
<li>PRIVATE,</li>
<li>NONE;</li>
</ul>
<h2 id="ToString"><a href="#ToString" class="headerlink" title="ToString"></a>ToString</h2><p><code>@ToString</code>注解既可以用在类上可以用在方法上, 这个注解会修改类的<code>toString()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestToString</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		C c = <span class="keyword">new</span> C();</div><div class="line">		c.c1 = <span class="string">"c_1"</span>;</div><div class="line">		c.c2 = <span class="string">"c_2"</span>;</div><div class="line">		c.b1 = <span class="string">"b_1"</span>;</div><div class="line">		c.b2 = <span class="string">"b_2"</span>;</div><div class="line">		System.out.println(c);</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// toString()中不包含b1和b2这俩个属性</span></div><div class="line"><span class="meta">@ToString</span>(exclude=&#123;<span class="string">"b1"</span>, <span class="string">"b2"</span>&#125;)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> String b1;</div><div class="line">	<span class="keyword">public</span> String b2;</div><div class="line">	<span class="keyword">public</span> String b3;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 调用父类的toString和在输出时包含字段名称</span></div><div class="line"><span class="meta">@ToString</span>(callSuper=<span class="keyword">true</span>, includeFieldNames = <span class="keyword">true</span>)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">extends</span> <span class="title">B</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> String c1;</div><div class="line">	<span class="keyword">public</span> String c2;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码输出为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">C(<span class="keyword">super</span>=B(b2=<span class="keyword">null</span>), c1=<span class="keyword">null</span>, c2=<span class="keyword">null</span>)</div><div class="line">B(b2=<span class="keyword">null</span>)</div><div class="line">C(<span class="keyword">super</span>=B(b2=b_2), c1=c_1, c2=c_2)</div></pre></td></tr></table></figure></p>
<h2 id="EqualsAndHashCode"><a href="#EqualsAndHashCode" class="headerlink" title="EqualsAndHashCode"></a>EqualsAndHashCode</h2><p>这个注解人如其名, 会为我们生成俩个规范的<code>equals()</code>和<code>hashCode()</code>方法, 至于什么是规范的,参考Effective java这本书<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@EqualsAndHashCode</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> </span>&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h2><p><code>@Data</code>注解是<code>@ToString, @EqualsAndHashCode, @Getter / @Setter and @RequiredArgsConstructor</code>这些注解的一个集合. 它会默认地为我们使用那些注解.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Data</span> <span class="class"><span class="keyword">class</span> <span class="title">Simple</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">		setId(<span class="number">123</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Value"><a href="#Value" class="headerlink" title="Value"></a>Value</h2><p><code>@Value</code>是<code>@Data</code>注解的一个变种, 它是在<code>@Data</code>注解的基础将,将类成为不可变的.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Value</span> <span class="class"><span class="keyword">class</span> <span class="title">E</span> </span>&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Builder"><a href="#Builder" class="headerlink" title="Builder"></a>Builder</h2><p><code>@Builder</code>将类修改成Builder模式(同样参考Effective Java).</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestBuilder</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		F f = F.builder().f1(<span class="string">"fff"</span>).fAB(<span class="number">123</span>).build();</div><div class="line">		System.out.println(f.getF1());</div><div class="line">		System.out.println(f.getFABs().size());</div><div class="line"></div><div class="line">		G g = G.GBuilder().buildG();</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Builder</span> <span class="class"><span class="keyword">class</span> <span class="title">F</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Getter</span> <span class="keyword">private</span> String f1;</div><div class="line"></div><div class="line">	<span class="meta">@Singular</span> <span class="meta">@Getter</span> <span class="keyword">private</span> Set&lt;Integer&gt; fABs;</div><div class="line">	<span class="meta">@Singular</span> <span class="meta">@Getter</span> <span class="keyword">private</span> Set&lt;Integer&gt; fAsBs;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Builder</span>(builderClassName = <span class="string">"GBuilder"</span>, buildMethodName = <span class="string">"buildG"</span>, builderMethodName = <span class="string">"GBuilder"</span>)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">G</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printG</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"GGG"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用<code>@Singular</code>注解的集合属性名必须使用<code>s</code>结尾, lombok会将属性名结尾的<code>s</code>去掉,剩余的名字会作为方法名, 向这个集合中添加元素</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/12/09/JavaLibrary/lombok/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/12/09/JavaLibrary/lombok/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/09/JavaLibrary/mybatis-guice/" title="Guice Mybatis 使用笔记" itemprop="url">Guice Mybatis 使用笔记</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2015-12-08T16:00:00.000Z" itemprop="datePublished"> 發表於 2015-12-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>参考文档<a href="http://mybatis.org/guice/index.html" target="_blank" rel="external">mybatis-guice</a></p>
<p>mybatis-guice需要依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.inject<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guice<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-guice<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.inject.extensions<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guice-multibindings<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.37<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>表结构<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user`</span> (</div><div class="line">  <span class="string">`userId`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span></div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</div></pre></td></tr></table></figure></p>
<p>我们首先定义使用到的model类和mapper类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> String userId;</div><div class="line">    <span class="keyword">public</span> String name;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</div><div class="line">    <span class="meta">@Select</span>(<span class="string">"SELECT * FROM user WHERE userId = #&#123;userId&#125;"</span>)</div><div class="line">    <span class="function">User <span class="title">getUser</span><span class="params">(@Param(<span class="string">"userId"</span>)</span> String userId)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后我们实现Guice对Mybatis的注解管理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySqlManager</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Injector injector;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        injector = Guice.createInjector(JdbcHelper.MySQL, <span class="keyword">new</span> MysqlModule());</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MySqlManager</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getInstance</span><span class="params">(Class&lt;T&gt; var1)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> injector.getInstance(var1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MysqlModule</span> <span class="keyword">extends</span> <span class="title">MyBatisModule</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</div><div class="line">            bindDataSourceProviderType(PooledDataSourceProvider.class);</div><div class="line">            bindTransactionFactoryType(JdbcTransactionFactory.class);</div><div class="line">            Names.bindProperties(binder(), createUnpooledProperties());</div><div class="line"></div><div class="line">            addMapperClass();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 添加映射类</span></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addMapperClass</span><span class="params">()</span> </span>&#123;</div><div class="line">            addMapperClass(UserMapper.class);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> Properties <span class="title">createUnpooledProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">            Properties myBatisProperties = <span class="keyword">new</span> Properties();</div><div class="line">            myBatisProperties.setProperty(<span class="string">"mybatis.environment.id"</span>, <span class="string">"test"</span>);</div><div class="line">            myBatisProperties.setProperty(<span class="string">"JDBC.schema"</span>, <span class="string">"test"</span>);</div><div class="line"><span class="comment">//			myBatisProperties.setProperty("JDBC.url", "localhost");</span></div><div class="line"><span class="comment">//			myBatisProperties.setProperty("JDBC.driver", "");</span></div><div class="line">            myBatisProperties.setProperty(<span class="string">"JDBC.username"</span>, <span class="string">"root"</span>);</div><div class="line">            myBatisProperties.setProperty(<span class="string">"JDBC.password"</span>, <span class="string">"root"</span>);</div><div class="line">            myBatisProperties.setProperty(<span class="string">"JDBC.loginTimeout"</span>, <span class="string">"10"</span>);</div><div class="line">            myBatisProperties.setProperty(<span class="string">"JDBC.autoCommit"</span>, <span class="string">"false"</span>);</div><div class="line">            myBatisProperties.setProperty(<span class="string">"derby.create"</span>, <span class="string">"true"</span>);</div><div class="line">            <span class="keyword">return</span> myBatisProperties;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后我们写一个测试类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GettingStarted</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        UserMapper user = MySqlManager.getInstance(UserMapper.class);</div><div class="line">        User user1 = user.getUser(<span class="string">"1"</span>);</div><div class="line">        System.out.println(user1.name);</div><div class="line">		</div><div class="line">		UserMapper userMapper = <span class="keyword">new</span> UserMapper();</div><div class="line">		injector.injectMembers(userMapper);</div><div class="line">		System.out.println(userMapper.name);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>MyBatisModule</code>还为我们提供了下述功能的接口</p>
<ul>
<li>添加自己的拦截器 : <code>addInterceptorClass(MySqlInterceptor.class);</code></li>
<li>添加自己的类型转换器 : <code>handleType()</code></li>
<li>添加别名 : <code>addSimpleAlias(User.class);</code>或者<code>addAlias(&quot;AUser&quot;).to(User.class);</code></li>
</ul>
<h2 id="开启事务"><a href="#开启事务" class="headerlink" title="开启事务"></a>开启事务</h2><p>我们在<code>FooServiceMapperImpl</code>中还能定义开启事务<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 开启事务</span></div><div class="line"><span class="meta">@Transactional</span>(</div><div class="line">        executorType = ExecutorType.BATCH,</div><div class="line">        isolation = Isolation.READ_UNCOMMITTED,</div><div class="line"><span class="comment">//		rethrowExceptionsAs = MyDaoException.class,</span></div><div class="line">        exceptionMessage = <span class="string">"Something went wrong"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(String userId)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.userMapper.getUser(userId);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="定义自己的连接池"><a href="#定义自己的连接池" class="headerlink" title="定义自己的连接池"></a>定义自己的连接池</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addPooledProperties</span><span class="params">(Binder binder)</span> </span>&#123;</div><div class="line">    <span class="comment">// 连接池并发访问数据的连接数, 默认为10</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"mybatis.pooled.maximumActiveConnections"</span>)).to(<span class="number">10</span>);</div><div class="line">    <span class="comment">// 在被强制返回之前，池中连接被检查的时间</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"mybatis.pooled.maximumCheckoutTime"</span>)).to(<span class="number">20000</span>);</div><div class="line">    <span class="comment">// 连接池里空闲连接数, 默认为5</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"mybatis.pooled.maximumIdleConnections"</span>)).to(<span class="number">5</span>);</div><div class="line">    <span class="comment">// 由于数据库会检查连接达到8小时(默认值)闲置会单方面断开连接, 而客户端如果继续使用已经断开的连接,则会产生异常.</span></div><div class="line">    <span class="comment">// mybatis里内带了ping机制, 设置该值为true的话, 就开启了ping机制</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"mybatis.pooled.pingEnabled"</span>)).to(<span class="keyword">false</span>);</div><div class="line">    <span class="comment">// 设置空闲连接ping时间间隔, 如果超时就进行ping,查看连接是否有效</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"mybatis.pooled.pingConnectionsNotUsedFor"</span>)).to(<span class="number">3600000</span>);</div><div class="line">    <span class="comment">// 执行ping时执行的语句</span></div><div class="line">	<span class="comment">//	binder.bindConstant().annotatedWith(Names.named("mybatis.pooled.pingQuery")).to("");</span></div><div class="line">    <span class="comment">// 这是一个低层设置，如果获取连接花费的相当长的时间，它会给连接池打印日志并重新尝试获取一个连接的机会（避免在误配置的情况下一直安静的失败），默认值：20000 毫秒（即 20 秒）。</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"mybatis.pooled.timeToWait"</span>)).to(<span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addC3P0Properties</span><span class="params">(Binder binder)</span> </span>&#123;</div><div class="line">    <span class="comment">// 当连接池中的的连接耗尽的时候c3p0一次同时获取的连接数，但是池中最大数不会超过maxPoolSize</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.acquireIncrement"</span>)).to(<span class="number">1</span>);</div><div class="line">    <span class="comment">// 从数据库请求连接失败之后,尝试的次数</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.acquireRetryAttempts"</span>)).to(<span class="number">1</span>);</div><div class="line">    <span class="comment">// 连接池耗尽, 连续获得俩个连接直接的间隔时间. 单位ms</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.acquireRetryDelay"</span>)).to(<span class="number">1000</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.automaticTestTable"</span>)).to(<span class="string">"test"</span>);</div><div class="line">    <span class="comment">// 如果为true，则当连接获取失败时自动关闭数据源</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.breakAfterAcquireFailure"</span>)).to(<span class="keyword">false</span>);</div><div class="line">    <span class="comment">// 连接池所有连接耗尽时,应用程序获得新的连接的等待时间. 为0则无限等待直至有其他连接释放或者创建新的连接，</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.checkoutTimeout"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.connectionCustomizerClassName"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.connectionTesterClassName"</span>)).to(<span class="number">1</span>);</div><div class="line">    <span class="comment">// 检查所有连接池中的空闲连接的时间间隔, 单位秒</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.idleConnectionTestPeriod"</span>)).to(<span class="number">900</span>);</div><div class="line">    <span class="comment">// 连接池初始化时创建的连接数,default : 3</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.initialPoolSize"</span>)).to(<span class="number">3</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.maxAdministrativeTaskTime"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.maxConnectionAge"</span>)).to(<span class="number">1</span>);</div><div class="line">    <span class="comment">// 池中连接最大空闲时长,如果超时则断开这个连接. 单位是秒</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.maxIdleTime"</span>)).to(<span class="number">600</span>);</div><div class="line"></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.maxIdleTimeExcessConnections"</span>)).to(<span class="number">1</span>);</div><div class="line">    <span class="comment">// 接池中拥有的最大连接数，如果获得新连接时会使连接总数超过这个值则不会再获取新连接，而是等待其他连接释放</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.maxPoolSize"</span>)).to(<span class="number">15</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.maxStatements"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.maxStatementsPerConnection"</span>)).to(<span class="number">1</span>);</div><div class="line">    <span class="comment">// 连接池保持的最小连接数</span></div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.minPoolSize"</span>)).to(<span class="number">3</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.preferredTestQuery"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.propertyCycle"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.testConnectionOnCheckin"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.testConnectionOnCheckout"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.unreturnedConnectionTimeout"</span>)).to(<span class="number">1</span>);</div><div class="line">    binder.bindConstant().annotatedWith(Names.named(<span class="string">"c3p0.usesTraditionalReflectiveProxies"</span>)).to(<span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们还可以采用配置文件的方式设置<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.mybatis.guice.XMLMyBatisModule;</div><div class="line"><span class="keyword">import</span> org.mybatis.guice.datasource.helper.JdbcHelper;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.inject.Guice;</div><div class="line"><span class="keyword">import</span> com.google.inject.Injector;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisManager</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Injector injector;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        injector = Guice.createInjector(JdbcHelper.MySQL, <span class="keyword">new</span> MysqlModule());</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MybatisManager</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getInstance</span><span class="params">(Class&lt;T&gt; var1)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> injector.getInstance(var1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MysqlModule</span> <span class="keyword">extends</span> <span class="title">XMLMyBatisModule</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</div><div class="line">            setClassPathResource(<span class="string">"configuration.xml"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/12/09/JavaLibrary/mybatis-guice/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/12/09/JavaLibrary/mybatis-guice/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/08/JavaLibrary/guice/" title="Guice 笔记" itemprop="url">Guice 笔记</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2015-12-07T16:00:00.000Z" itemprop="datePublished"> 發表於 2015-12-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>Google Guice 是一个轻量级的依赖注入框架</p>
<p>在Guice的依赖注入中我们使用如下API进行注入</p>
<ul>
<li><code>Binder</code></li>
<li><code>Injector</code></li>
<li><code>Module</code></li>
<li><code>Guice</code><br>直接看例子<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CarModule</span> <span class="keyword">implements</span> <span class="title">Module</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Binder binder)</span> </span>&#123;</div><div class="line">		binder.bind(Car.class).to(Benci.class);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Car</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Benci</span> <span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"Benci Run"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>测试代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Injector injector = Guice.createInjector(<span class="keyword">new</span> CarModule());</div><div class="line">Car benci = injector.getInstance(Car.class);</div><div class="line">benci.run();</div></pre></td></tr></table></figure></p>
<h2 id="ImplementedBy"><a href="#ImplementedBy" class="headerlink" title="ImplementedBy"></a>ImplementedBy</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LunYu</span> <span class="keyword">implements</span> <span class="title">Book</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">content</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"Lunyu"</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@ImplementedBy</span>(LunYu.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Book</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">content</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadBook</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readLunyu</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(book.content());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="keyword">private</span> Book book;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Injector intjector = Guice.createInjector();</div><div class="line">Book lunyu = intjector.getInstance(Book.class);</div><div class="line">System.out.println(lunyu.content());</div></pre></td></tr></table></figure></p>
<h2 id="Inject"><a href="#Inject" class="headerlink" title="Inject"></a>Inject</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Man</span> <span class="keyword">implements</span> <span class="title">People</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"Tom"</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">People</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PeopleModule</span> <span class="keyword">implements</span> <span class="title">Module</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Binder binder)</span> </span>&#123;</div><div class="line">		binder.bind(People.class).to(Man.class);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrintName</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(man.name());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="keyword">private</span> People man;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Injector intjector = Guice.createInjector(<span class="keyword">new</span> PeopleModule());</div><div class="line">PrintName pn = intjector.getInstance(PrintName.class);</div><div class="line">pn.print();</div></pre></td></tr></table></figure></p>
<h2 id="Scopes"><a href="#Scopes" class="headerlink" title="Scopes"></a>Scopes</h2><p>默认的,Guice每次在<code>getInstance()</code>的时候都会返回一个新的对象.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestScopes</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		AbstractModule module1 = <span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				bind(A.class);</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		Injector injector = Guice.createInjector(module1);</div><div class="line">		A a = injector.getInstance(A.class);</div><div class="line">		A b = injector.getInstance(A.class);</div><div class="line">		System.out.println(a.equals(b));</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"A"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出结果为false, 但是我们可以使用Singleton注解采用单例方式创建全局唯一的对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSingleton</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				bind(A.class).to(B.class);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		A b1 = injector.getInstance(A.class);</div><div class="line">		A b2 = injector.getInstance(A.class);</div><div class="line">		System.out.println(b1 == b2);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Singleton</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出结果为<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">true</div></pre></td></tr></table></figure></p>
<p>我们使用<code>Singleton</code>注解可以得到一个全局唯一的B实例, 每次注解B实例时, 都是同一个实例.</p>
<p>另外,我们还可以在绑定的时候进行设置<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ABCModule</span> <span class="keyword">extends</span> <span class="title">AbstractModule</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">		bind(A.class).to(B.class).in(Singleton.class);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="注入"><a href="#注入" class="headerlink" title="注入"></a>注入</h2><h2 id="构造器注入"><a href="#构造器注入" class="headerlink" title="构造器注入"></a>构造器注入</h2><p>对构造器进行注入<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestInject</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				<span class="comment">// A类型的变量都使用B的实例值进行注入. 也就是说当我们对A类型的变量注入值的时候, 其实注入的是B类型</span></div><div class="line">				<span class="comment">// B一定要继承A或者实现A接口</span></div><div class="line">				bind(A.class).to(B.class);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		</div><div class="line">		Print print = injector.getInstance(Print.class);</div><div class="line">		print.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"A"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span></span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> A a;</div><div class="line"></div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	Print(A a) &#123;</div><div class="line">		<span class="keyword">this</span>.a = a;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		a.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出结果为B, 注入成功</p>
<h2 id="方法参数注入"><a href="#方法参数注入" class="headerlink" title="方法参数注入"></a>方法参数注入</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestInject</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> ABCModule());</div><div class="line">		Print print = injector.getInstance(Print.class);</div><div class="line">		print.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> A a;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setA</span><span class="params">(A a)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.a = a;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		a.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果同样是B</p>
<h2 id="方法注入"><a href="#方法注入" class="headerlink" title="方法注入"></a>方法注入</h2><p>当一个方法使用<code>Inject</code>注解时, 如果getInstance该类的实例就会调用该方法一次<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestStaticInjection</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		Print b1 = injector.getInstance(Print.class);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"Hello world"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="成员属性注入"><a href="#成员属性注入" class="headerlink" title="成员属性注入"></a>成员属性注入</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestInject</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> ABCModule());</div><div class="line">		Print print = injector.getInstance(Print.class);</div><div class="line">		print.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="keyword">private</span> A a;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		a.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ABCModule</span> <span class="keyword">extends</span> <span class="title">AbstractModule</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">		bind(A.class).to(B.class);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Guice会对被<code>Inject</code>注解过的属性赋值</p>
<h2 id="Optional-Injections"><a href="#Optional-Injections" class="headerlink" title="Optional Injections"></a>Optional Injections</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestInject</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> ABCModule());</div><div class="line">		Print print = injector.getInstance(Print.class);</div><div class="line">		print.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="meta">@Inject</span>(optional=<span class="keyword">true</span>)</div><div class="line">	<span class="keyword">private</span> A a;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		a.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ABCModule</span> <span class="keyword">extends</span> <span class="title">AbstractModule</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="comment">//		bind(A.class).to(B.class);</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果我将要被<code>Inject</code>注解的属性设置为<code>optional=true</code>的话,当我注释掉绑定代码,在运行代码时会产生一个空指针异常,这是因为当找不到绑定的时候,就不进行注解<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java<span class="selector-class">.lang</span><span class="selector-class">.NullPointerException</span></div></pre></td></tr></table></figure></p>
<p>但是如果我将<code>Inject</code>注解的属性设置为<code>optional=false</code>的话,在运行代码会产生<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Exception in thread <span class="string">"main"</span> com.google.inject.ConfigurationException: Guice configuration errors:</div><div class="line"></div><div class="line"><span class="number">1</span>) No implementation <span class="keyword">for</span> guice.A was bound.</div><div class="line">  <span class="keyword">while</span> locating guice.A</div><div class="line">    <span class="keyword">for</span> field at guice.Print.a(TestInject.java:<span class="number">37</span>)</div><div class="line">  <span class="keyword">while</span> locating guice.Print</div></pre></td></tr></table></figure></p>
<p>说明如果可选值如果是false的话就必须对其进行绑定</p>
<h2 id="静态属性注入"><a href="#静态属性注入" class="headerlink" title="静态属性注入"></a>静态属性注入</h2><p>对类中的静态字段进行注入<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestStaticInjection</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				requestStaticInjection(Print.class);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		Print b1 = injector.getInstance(Print.class);</div><div class="line">		b1.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"A"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> A a;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		a.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是我们应该避免静态属性注入</p>
<h2 id="绑定"><a href="#绑定" class="headerlink" title="绑定"></a>绑定</h2><h3 id="单绑定"><a href="#单绑定" class="headerlink" title="单绑定"></a>单绑定</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestBindings</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				bind(BindingA.class);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		BindingA a = injector.getInstance(BindingA.class);</div><div class="line">		a.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BindingA</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"A"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果为<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">A</div></pre></td></tr></table></figure></p>
<p>我们可以将<code>BindingA</code>绑定到Guice里, 当我们getInstance时会直接获得该实例</p>
<blockquote>
<p>注意如果单邦定时, BindingA必须为class, 如果为接口的话会产生No implementation for testGuice.BindingA was bound.异常</p>
<p>参考@ImplementedBy or @ProvidedBy</p>
</blockquote>
<h3 id="链式绑定"><a href="#链式绑定" class="headerlink" title="链式绑定"></a>链式绑定</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestBindings</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				bind(BindingA.class).to(BindingB.class);</div><div class="line">				bind(BindingB.class).to(BindingC.class);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line"></div><div class="line">		BindingC c = injector.getInstance(BindingC.class);</div><div class="line">		c.print();</div><div class="line">		BindingB b = injector.getInstance(BindingB.class);</div><div class="line">		b.print();</div><div class="line">		BindingA a = injector.getInstance(BindingA.class);</div><div class="line">		a.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BindingA</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"A"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BindingB</span> <span class="keyword">extends</span> <span class="title">BindingA</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BindingC</span> <span class="keyword">extends</span> <span class="title">BindingB</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"c"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码的最后调用结果都是<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">c</div><div class="line">c</div><div class="line">c</div></pre></td></tr></table></figure></p>
<p>这就是Guice的Linked Bindings, 当binding形成一条链之后,会以最终的绑定为最终绑定</p>
<blockquote>
<p>注意绑定关系必须是继承关系</p>
</blockquote>
<h3 id="命名绑定"><a href="#命名绑定" class="headerlink" title="命名绑定"></a>命名绑定</h3><p>这种特性是为了,当某个接口有多种实现时,我们可以通过<code>@Named</code>指定我们具体使用哪种实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestNamedBindings</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				bind(A.class).annotatedWith(Names.named(<span class="string">"BType"</span>)).to(B.class);</div><div class="line">				bind(A.class).annotatedWith(Names.named(<span class="string">"CType"</span>)).to(C.class);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		Print print = injector.getInstance(Print.class);</div><div class="line">		print.printB();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"C"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printB</span><span class="params">()</span> </span>&#123;</div><div class="line">		b.print();</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printC</span><span class="params">()</span> </span>&#123;</div><div class="line">		c.print();</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="meta">@Named</span>(<span class="string">"BType"</span>)</div><div class="line">	<span class="keyword">private</span> A b;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="meta">@Named</span>(<span class="string">"CType"</span>)</div><div class="line">	<span class="keyword">private</span> A c;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出结果为<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">B</div><div class="line">C</div><div class="line">B</div></pre></td></tr></table></figure></p>
<p>我们还可以使用<code>BindingAnnotation</code>来实现相同的功能<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestNamedBindings</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				bind(A.class).annotatedWith(BType.class).to(B.class);</div><div class="line">				bind(A.class).annotatedWith(CType.class).to(C.class);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		Print print = injector.getInstance(Print.class);</div><div class="line">		print.printB();</div><div class="line">		print.printC();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"C"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@BindingAnnotation</span></div><div class="line"><span class="meta">@Target</span>(&#123; FIELD, PARAMETER, METHOD &#125;) <span class="meta">@Retention</span>(RUNTIME)</div><div class="line"><span class="meta">@interface</span> BType &#123;&#125;</div><div class="line"></div><div class="line"><span class="meta">@BindingAnnotation</span></div><div class="line"><span class="meta">@Target</span>(&#123; FIELD, PARAMETER, METHOD &#125;) <span class="meta">@Retention</span>(RUNTIME)</div><div class="line"><span class="meta">@interface</span> CType &#123;&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printB</span><span class="params">()</span> </span>&#123;</div><div class="line">		b.print();</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printC</span><span class="params">()</span> </span>&#123;</div><div class="line">		c.print();</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="meta">@BType</span></div><div class="line">	<span class="keyword">private</span> A b;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="meta">@CType</span></div><div class="line">	<span class="keyword">private</span> A c;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="多模块绑定"><a href="#多模块绑定" class="headerlink" title="多模块绑定"></a>多模块绑定</h3><p>我们可以在不同的模块里绑定实现不同的绑定<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMultipleModules</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		AbstractModule module1 = <span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				bind(A.class).to(B.class);</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line"></div><div class="line">		AbstractModule module2 = <span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">				bind(B.class).to(C.class);</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		Injector injector = Guice.createInjector(module1, module2);</div><div class="line">		A a = injector.getInstance(A.class);</div><div class="line">		B b = injector.getInstance(B.class);</div><div class="line">		a.print();</div><div class="line">		b.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"A"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">extends</span> <span class="title">B</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"C"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="meta">@Inject</span></div><div class="line">	<span class="keyword">private</span> A a;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		a.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">C</div><div class="line">C</div></pre></td></tr></table></figure></p>
<blockquote>
<p>module1和module2里对A只能进行相同的绑定,也就是说即使在不同的module里也不能即A绑定到B又绑定到C</p>
</blockquote>
<h3 id="Provides绑定"><a href="#Provides绑定" class="headerlink" title="Provides绑定"></a>Provides绑定</h3><p>我们可以使用<code>Provides</code>注解替代<code>configure()</code>实现的绑定.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestProvidesMethods</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> AbstractModule() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="meta">@Provides</span></div><div class="line">			<span class="function"><span class="keyword">public</span> A <span class="title">provideA</span><span class="params">()</span> </span>&#123;</div><div class="line">				B b = <span class="keyword">new</span> B();</div><div class="line">				<span class="keyword">return</span> b;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		A print = injector.getInstance(A.class);</div><div class="line">		print.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"A"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们在module实现里添加了<code>@Provides</code>注释, 当我们在测试代码里要获取某种类型的对象的时候, Guice会根据返回某种类型的方法调用.</p>
<blockquote>
<p><code>@Provides</code>注释下的名字可以是任意的. 但是我们还是建议采用provideXXX的形式</p>
</blockquote>
<p>需要注意的是, 返回的类型必须是唯一的, 如果我们添加下面的代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="title">implementsA</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"c"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Provides</span></div><div class="line"><span class="function"><span class="keyword">public</span> A <span class="title">provideC</span><span class="params">()</span> </span>&#123;</div><div class="line">	C b = <span class="keyword">new</span> C();</div><div class="line">	<span class="keyword">return</span> b;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>guice会产生异常<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Exception in thread <span class="string">"main"</span> com.google.inject.CreationException: Unable to create injector, see the following errors:</div><div class="line"></div><div class="line"><span class="number">1</span>) A binding to guice.A was already configured at guice.ABCModule.provideA().</div></pre></td></tr></table></figure></p>
<p>还有一点需要注意的是,如果<code>@Provides</code>已经使用过某种类型,那么在<code>config()</code>方法里就不能再次使用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">	bind(A.class).to(C.class);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>同样会产生异常<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Exception in thread <span class="string">"main"</span> com.google.inject.CreationException: Unable to create injector, see the following errors:</div><div class="line"></div><div class="line"><span class="number">1</span>) A binding to guice.A was already configured at guice.ABCModule.provideA().</div></pre></td></tr></table></figure></p>
<p>如果我们的<code>provide</code>方法很复杂,我们可以将其抽取到一个类里<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestLinkedBindings</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Injector injector = Guice.createInjector(<span class="keyword">new</span> ABCModule());</div><div class="line">		A print = injector.getInstance(A.class);</div><div class="line">		print.print();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">A</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BProvider</span> <span class="keyword">implements</span> <span class="title">Provider</span>&lt;<span class="title">A</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> A <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> B();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ABCModule</span> <span class="keyword">extends</span> <span class="title">AbstractModule</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line">		bind(A.class).toProvider(BProvider.class);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Guice/">Guice</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/12/08/JavaLibrary/guice/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/12/08/JavaLibrary/guice/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/24/jvm/instrument/" title="Instrumentation" itemprop="url">Instrumentation</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2015-11-23T16:00:00.000Z" itemprop="datePublished"> 發表於 2015-11-24</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>利用 <code>java.lang.instrument</code> 做动态 Instrumentation 是 Java SE 5 的新特性, 它把 Java 的 instrument 功能从本地代码中解放出来,使之可以用 Java 代码的方式解决问题.</p>
<p>使用 Instrumentation,开发者可以构建一个独立于应用程序的代理程序(Agent),用来监测和协助运行在 JVM 上的程序,甚至能够替换和修改某些类的定义.有了这样的功能,开发者就可以实现更为灵活的运行时虚拟机监控和 Java 类操作了,这样的特性实际上提供了一种虚拟机级别支持的 AOP 实现方式,使得开发者无需对 JDK 做任何升级和改动,就可以实现某些 AOP 的功能了.</p>
<p>在 Java SE 6 里面,instrumentation 包被赋予了更强大的功能：启动后的 instrument、本地代码(native code)instrument,以及动态改变 classpath 等等.这些改变,意味着 Java 具有了更强的动态控制、解释能力,它使得 Java 语言变得更加灵活多变.</p>
<p>在 Java SE6 里面,最大的改变使运行时的 Instrumentation 成为可能.在 Java SE 5 中,Instrument 要求在运行前利用命令行参数或者系统参数来设置代理类,在实际的运行之中,虚拟机在初始化之时(在绝大多数的 Java 类库被载入之前),instrumentation 的设置已经启动,并在虚拟机中设置了回调函数,检测特定类的加载情况,并完成实际工作.但是在实际的很多的情况下,我们没有办法在虚拟机启动之时就为其设定代理,这样实际上限制了 instrument 的应用.而 Java SE 6 的新特性改变了这种情况,通过 Java Tool API 中的 attach 方式,我们可以很方便地在运行过程中动态地设置加载代理类,以达到 instrumentation 的目的.</p>
<p>另外,对 native 的 Instrumentation 也是 Java SE 6 的一个崭新的功能,这使以前无法完成的功能 —— 对 native 接口的 instrumentation 可以在 Java SE 6 中,通过一个或者一系列的 prefix 添加而得以完成.<br>最后,Java SE 6 里的 Instrumentation 也增加了动态添加 class path 的功能.所有这些新的功能,都使得 instrument 包的功能更加丰富,从而使 Java 语言本身更加强大.</p>
<p><code>java.lang.instrument</code>包的具体实现,依赖于 JVMTI. JVMTI(Java Virtual Machine Tool Interface)是一套由 Java 虚拟机提供的,为 JVM 相关的工具提供的本地编程接口集合. JVMTI 是从 Java SE 5 开始引入,整合和取代了以前使用的 Java Virtual Machine Profiler Interface (JVMPI) 和 the Java Virtual Machine Debug Interface (JVMDI),而在 Java SE 6 中,JVMPI 和 JVMDI 已经消失了.JVMTI 提供了一套”代理”程序机制,可以支持第三方工具程序以代理的方式连接和访问 JVM,并利用 JVMTI 提供的丰富的编程接口,完成很多跟 JVM 相关的功能.事实上,java.lang.instrument 包的实现,也就是基于这种机制的：在 Instrumentation 的实现当中,存在一个 JVMTI 的代理程序,通过调用 JVMTI 当中 Java 类相关的函数来完成 Java 类的动态操作.除开 Instrumentation 功能外,JVMTI 还在虚拟机内存管理,线程控制,方法和变量操作等等方面提供了大量有价值的函数.关于 JVMTI 的详细信息,请参考 Java SE 6 文档(请参见 参考资源)当中的介绍.<br>Instrumentation 的最大作用,就是类定义动态改变和操作.在 Java SE 5 及其后续版本当中,开发者可以在一个普通 Java 程序(带有 main 函数的 Java 类)运行时,通过 – javaagent参数指定一个特定的 jar 文件(包含 Instrumentation 代理)来启动 Instrumentation 的代理程序.</p>
<p>使用 Instrumentation,开发者可以构建一个独立于应用程序的代理程序(Agent),用来监测和协助运行在 JVM 上的程序,甚至能够替换和修改某些类的定义.</p>
<p>Instrumentation提供了这样的功能：</p>
<ul>
<li>获取某个对象的大小</li>
<li>热加载class文件</li>
<li>获取JVM信息</li>
</ul>
<blockquote>
<p>要知道一个对象所使用的内存量,需要将所有实例变量使用的内存和对象本身的开销(一般是16字节)相加.这些开销包括一个指向对象的类的引用,垃圾收集信息和同步信息.另外一般内存的使用会被填充为8字节的倍数.</p>
</blockquote>
<h2 id="Premain"><a href="#Premain" class="headerlink" title="Premain"></a>Premain</h2><p>premain函数是JavaSE5中实现instrument的方式.</p>
<p>使用premain我们要自定义MANIFEST.MF文件, 定义Premain-Class<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Manifest-Version: <span class="number">1.0</span></div><div class="line">Premain-Class: wang.yu66.instrument.core.Premain</div></pre></td></tr></table></figure></p>
<p>然后我们在maven文件中输出该文件<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">archive</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">manifestFile</span>&gt;</span></div><div class="line">                        src/main/resources/META-INF/MANIFEST.MF</div><div class="line">                    <span class="tag">&lt;/<span class="name">manifestFile</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">addClasspath</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addClasspath</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">classpathPrefix</span>&gt;</span>lib/<span class="tag">&lt;/<span class="name">classpathPrefix</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="获取对象大小"><a href="#获取对象大小" class="headerlink" title="获取对象大小"></a>获取对象大小</h4><p>首先我们要写一个代理文件出来(该文件放在<code>core-1.0-SNAPSHOT.jar</code>中)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Premain</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Instrumentation instrumentation;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span> </span>&#123;</div><div class="line">		instrumentation = inst;</div><div class="line">	&#125;;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Instrumentation <span class="title">getInstrumentation</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> instrumentation;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后在自己的应用程序中引用该文件(在<code>examples-1.0-SNAPSHOT.jar</code>中)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrintObjectSize</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"Hello world, App"</span>);</div><div class="line"></div><div class="line">		objectSize();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">objectSize</span><span class="params">()</span> </span>&#123;</div><div class="line">		Instrumentation inst = Premain.getInstrumentation();</div><div class="line">		String str = <span class="string">"123456789"</span>;</div><div class="line">		<span class="keyword">long</span> size = inst.getObjectSize(str);</div><div class="line">		System.out.println(str + <span class="string">" 对象大小: "</span> + size);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后执行命令<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -javaagent:../instrument/target/core-<span class="number">1.0</span>-SNAPSHOT.jar -cp ./target/examples-<span class="number">1.0</span>-SNAPSHOT.jar wang.yu66.instrument.examples.PrintObjectSize</div></pre></td></tr></table></figure></p>
<p>然后就会获得对象的大小<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Hello world, App</div><div class="line"><span class="number">123456789</span> 对象大小: <span class="number">24</span></div></pre></td></tr></table></figure></p>
<h4 id="加载jar包"><a href="#加载jar包" class="headerlink" title="加载jar包"></a>加载jar包</h4><p>我们在Premain类中增加一个动态向系统cp加载jar的功能<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendJarToSystemClassLoader</span><span class="params">(String path)</span> </span>&#123;</div><div class="line">	JarFile jarFile = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		jarFile = <span class="keyword">new</span> JarFile(path);</div><div class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;</div><div class="line">	instrumentation.appendToSystemClassLoaderSearch(jarFile);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendJarToBootstrapClassLoader</span><span class="params">(Instrumentation inst, String path)</span> </span>&#123;</div><div class="line">	JarFile jarFile = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		jarFile = <span class="keyword">new</span> JarFile(path);</div><div class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;</div><div class="line">	inst.appendToBootstrapClassLoaderSearch(jarFile);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后我们写一个测试类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJarLoader</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">120</span>; i++) &#123;</div><div class="line">			Premain.appendJarToSystemClassLoader(args[<span class="number">0</span>]);</div><div class="line">			Print.print();</div><div class="line"></div><div class="line">			Stream.of(Premain.getInstrumentation().getAllLoadedClasses())</div><div class="line">					.filter(clazz -&gt; clazz.getName().contains(<span class="string">"Print"</span>))</div><div class="line">					.forEach(aClass -&gt; System.out.println(aClass.getName() + <span class="string">"  "</span> + aClass.getMethods().length));</div><div class="line"></div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				TimeUnit.SECONDS.sleep(<span class="number">5</span>);</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后执行命令<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -javaagent:../instrument/target/core-<span class="number">1.0</span>-SNAPSHOT.jar -cp ./target/examples-<span class="number">1.0</span>-SNAPSHOT.jar wang.yu66.instrument.examples.TestJarLoader D:/workspace/idea/instrument/trunk/print/target/print-<span class="number">1.0</span>-SNAPSHOT.jar</div></pre></td></tr></table></figure></p>
<p>结果输出为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Now Time is Thu Dec <span class="number">31</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">39</span> CST <span class="number">2015</span></div><div class="line"></div><div class="line">wang.yu66.instrument.print.Print  <span class="number">11</span></div><div class="line">java.io.PrintStream  <span class="number">44</span></div><div class="line">Now Time is Thu Dec <span class="number">31</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">44</span> CST <span class="number">2015</span></div><div class="line"></div><div class="line">wang.yu66.instrument.print.Print  <span class="number">11</span></div><div class="line">java.io.PrintStream  <span class="number">44</span></div></pre></td></tr></table></figure></p>
<h4 id="热加载"><a href="#热加载" class="headerlink" title="热加载"></a>热加载</h4><ul>
<li><code>redefineClasses()</code>使用新的字节码全部替换原先存在的Class字节码. (它并不会触发初始化操作, 也不会抛出初始化时的异常. 因此一些静态属性并不会被重新赋值)</li>
<li><code>retransformClasses()</code> 修改原先存在的Class字节码.</li>
</ul>
<blockquote>
<p>对于已经在栈帧中的字节码, 他们会继续执行下去, 但是当方法再次调用的时候,则会使用刚刚加载完成的新的字节码. 在重新加载类的时候, 该类已经实例化出的对象同时也不会受到影响.</p>
</blockquote>
<p>该方法的操作过程是一个基于操作集合的, 也就是说在redefine的时候, 可能有A B俩个类都进行, 而且A依赖于B, 那么在redefine的时候这俩个操作是同时完成的, 类似于原子操作.</p>
<p>redefine 操作可以改变修改如下字节码</p>
<ul>
<li>方法体</li>
<li>常量池</li>
<li>属性<br>但是redefine过程不能产生如下影响</li>
<li>对方法进行增加,删除,重命名的操作</li>
<li>对属性进行增加,删除,重命名的操作</li>
<li>不能修改方法签名以及修改继承关系.</li>
</ul>
<p>在redefine过程中,一旦抛出异常, 那么此过程执已经redefine成功的class也会被会滚成原来的.</p>
<p>想使用这个功能我们需要在MANIFEST.MF文件中增加这样一行<code>Can-Redefine-Classes: true</code>, 然后我们在Premain中增加一个load方法, 用于重新加载某个文件夹下所有的文件<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.*;</div><div class="line"><span class="keyword">import</span> java.lang.instrument.ClassDefinition;</div><div class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</div><div class="line"><span class="keyword">import</span> java.security.MessageDigest;</div><div class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</div><div class="line"><span class="keyword">import</span> java.util.zip.ZipEntry;</div><div class="line"><span class="keyword">import</span> java.util.zip.ZipFile;</div><div class="line"><span class="keyword">import</span> java.util.zip.ZipInputStream;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 实现服务器局部代码热加载功能</div><div class="line"> *      目前只支持方法体代码热更以及对属性值的改变</div><div class="line"> *      但是不能修改类的继承结构, 不能修改方法签名, 不能增加删除方法以及属性成员</div><div class="line"> *</div><div class="line"> *  使用方法</div><div class="line"> *      java -javaagent:D:\premain\target\agent-1.0-SNAPSHOT.jar -cp .;./* MainServerStart</div><div class="line"> *      只需要将该项目打包出来然后参照上面的例子进行代理处理就好了, 然后正常启动游戏服就好</div><div class="line"> *</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Premain</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(Premain.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Instrumentation instrumentation;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span> </span>&#123;</div><div class="line">        instrumentation = inst;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> classSize = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 遍历某个目录加载所有的class文件</div><div class="line">     * <span class="doctag">@param</span> directionPath</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadFromDirection</span><span class="params">(String directionPath)</span> </span>&#123;</div><div class="line">        loadFromDirection(<span class="keyword">new</span> File(directionPath), <span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadFromDirection</span><span class="params">(File dir, String parantName)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">for</span> (File file : dir.listFiles()) &#123;</div><div class="line">                <span class="keyword">if</span> (file.isFile() &amp;&amp; !file.getName().endsWith(<span class="string">".class"</span>)) &#123;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (file.isDirectory()) &#123;</div><div class="line">                    String fileName = file.getName();</div><div class="line">                    <span class="keyword">if</span> (parantName != <span class="keyword">null</span> &amp;&amp; !parantName.equals(<span class="string">""</span>)) &#123;</div><div class="line">                        fileName = parantName + <span class="string">"."</span> + fileName;</div><div class="line">                    &#125;</div><div class="line">                    loadFromDirection(file, fileName);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">try</span>(InputStream input = <span class="keyword">new</span> FileInputStream(file);) &#123;</div><div class="line">                    String fileName = file.getPath();</div><div class="line">                    String className = findClassName(fileName);</div><div class="line">                    <span class="keyword">if</span> (parantName != <span class="keyword">null</span> &amp;&amp; !parantName.equals(<span class="string">""</span>)) &#123;</div><div class="line">                        className = parantName + <span class="string">"."</span> + className;</div><div class="line">                    &#125;</div><div class="line">                    redefineClassesFromBytes(input, className, <span class="keyword">null</span>);</div><div class="line">                &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 从jar包或者ZIP里加载所有的class文件</div><div class="line">     * <span class="doctag">@param</span> jarPath</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadFromZipFile</span><span class="params">(String jarPath, String prfixName)</span> </span>&#123;</div><div class="line">		Class[] allLoadClasses = instrumentation.getAllLoadedClasses();</div><div class="line">		Map&lt;String, Class&gt; allLoadClassesMap = <span class="keyword">new</span> HashMap&lt;&gt;(classSize);</div><div class="line">		<span class="keyword">for</span> (Class loadedClass : allLoadClasses) &#123;</div><div class="line">			<span class="keyword">if</span> (loadedClass.getName().startsWith(prfixName)) &#123;</div><div class="line">				allLoadClassesMap.put(loadedClass.getName(), loadedClass);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 加载的类我们不会主动去卸载它, 因此, 我们记录下来上次更新时的类的数量, 下次就根据这个数量直接分配, 避免动态扩容</span></div><div class="line">		classSize = allLoadClassesMap.size();</div><div class="line"></div><div class="line">		<span class="keyword">try</span>(InputStream in = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(jarPath)));</div><div class="line">            ZipInputStream zin = <span class="keyword">new</span> ZipInputStream(in);) &#123;</div><div class="line">            ZipEntry ze;</div><div class="line">            <span class="keyword">while</span> ((ze = zin.getNextEntry()) != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (ze.isDirectory()) &#123;</div><div class="line">                    <span class="comment">// TODO 检查是否还有其他操作要做</span></div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">long</span> size = ze.getSize();</div><div class="line">                    <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</div><div class="line">                        String fileName = ze.getName();</div><div class="line">                        <span class="keyword">if</span> (!fileName.endsWith(<span class="string">".class"</span>)) &#123;</div><div class="line">                            <span class="keyword">continue</span>;</div><div class="line">                        &#125;</div><div class="line">                        ZipFile zf = <span class="keyword">new</span> ZipFile(jarPath);</div><div class="line">                        InputStream input = zf.getInputStream(ze);</div><div class="line">                        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</div><div class="line">                            logger.error(<span class="string">"Code Reload cant find file : "</span> + fileName);</div><div class="line">                            <span class="keyword">continue</span>;</div><div class="line">                        &#125;</div><div class="line">                        redefineClassesFromBytes(input, fileName, allLoadClassesMap);</div><div class="line">                        input.close();</div><div class="line">                        zf.close();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">findClassName</span><span class="params">(String fileName)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> idx = fileName.lastIndexOf(<span class="string">"\\"</span>);</div><div class="line">        fileName = fileName.substring(idx + <span class="number">1</span>);</div><div class="line">        fileName = fileName.split(<span class="string">"\\.class"</span>)[<span class="number">0</span>];</div><div class="line">        <span class="keyword">return</span> fileName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* 使用instrumentation将读取的class byte数组加载进虚拟机</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">redefineClassesFromBytes</span><span class="params">(InputStream input, String fileName, Map&lt;String, Class&gt; allLoadClassesMap)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">        	String className = getClassName(fileName);</div><div class="line">            logger.info(<span class="string">"Start Hot Reload Class : "</span> + fileName + <span class="string">"  ("</span> + className + <span class="string">")"</span>);</div><div class="line">	        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[input.available()];</div><div class="line">    	    input.read(bytes);</div><div class="line">			Class loadedClass = allLoadClassesMap.get(className);</div><div class="line">			<span class="keyword">if</span> (loadedClass != <span class="keyword">null</span>) &#123;</div><div class="line">				instrumentation.redefineClasses(<span class="keyword">new</span> ClassDefinition(loadedClass, bytes));</div><div class="line">			&#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</div><div class="line">            logger.error(<span class="string">"Code Reload Failed : "</span> + fileName, e);</div><div class="line">        &#125; <span class="keyword">catch</span> (Error error) &#123;</div><div class="line">			logger.error(<span class="string">"Code Reload Failed : "</span> + fileName, error);</div><div class="line">		&#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getClassName</span><span class="params">(String fileName)</span> </span>&#123;</div><div class="line">        fileName = fileName.split(<span class="string">"\\.class"</span>)[<span class="number">0</span>];</div><div class="line">        fileName = fileName.replace(<span class="string">"\\\\"</span>, <span class="string">"."</span>);</div><div class="line">        fileName = fileName.replace(<span class="string">"/"</span>, <span class="string">"."</span>);</div><div class="line">        <span class="keyword">return</span> fileName;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>然后我们写一个测试类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestReload</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        fromDirection();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fromJar</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">300</span>; i++) &#123;</div><div class="line">            Premain.loadFromJarFile(<span class="string">"D:\\ming\\test\\target\\test-1.0-SNAPSHOT.jar"</span>);</div><div class="line">            TestReload.printTime();</div><div class="line">            <span class="keyword">new</span> TestReload().printNewTime();</div><div class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fromDirection</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">300</span>; i++) &#123;</div><div class="line">            Premain.loadFromDirection(<span class="string">"D:\\ming\\test\\target\\classes"</span>);</div><div class="line">            TestReload.printTime();</div><div class="line">            <span class="keyword">new</span> TestReload().printNewTime();</div><div class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printTime</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="number">2</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printNewTime</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="number">2</span>);</div><div class="line">        System.out.println(id);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> id = <span class="number">2</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们不断地修改printTime()和printNewTime()以及Id的值, 最后成功输出<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">2</span></div></pre></td></tr></table></figure></p>
<blockquote>
<p>在上面的实现中我分别实现了从目录和jar包对class文件进行热加载</p>
</blockquote>
<p>下面我们测试一下,如果增加了属性和方法成员, 看看有什么变化(下面只列出了TestReload.java的新增以及修改部分)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestReload</span> </span>&#123;</div><div class="line"></div><div class="line">	...</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printNewTime</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(id);</div><div class="line">        printName();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> id = <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> String name = <span class="string">"abc"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printName</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(name);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当我们再次重新加载的时候就会抛出异常<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">D:\ming\test\target&gt;java -javaagent:D:\premain\target\agent-1.0-SNAPSHOT.jar -cp .;./* TestReload</div><div class="line">1</div><div class="line">1</div><div class="line">2</div><div class="line">2</div><div class="line">2</div><div class="line">2</div><div class="line">java.lang.UnsupportedOperationException: class redefinition failed: attempted to change the schema (add/remove fields)</div><div class="line">	at sun.instrument.InstrumentationImpl.redefineClasses0(Native Method)</div><div class="line">	at sun.instrument.InstrumentationImpl.redefineClasses(Unknown Source)</div><div class="line">	at Premain.redefineClassesFromBytes(Premain.java:44)</div><div class="line">	at Premain.loadFromDirection(Premain.java:24)</div><div class="line">	at TestReload.fromDirection(TestReload.java:19)</div><div class="line">	at TestReload.main(TestReload.java:6)</div><div class="line">2</div><div class="line">java.lang.UnsupportedOperationException: class redefinition failed: attempted to change the schema (add/remove fields)</div><div class="line">	at sun.instrument.InstrumentationImpl.redefineClasses0(Native Method)</div><div class="line">	at sun.instrument.InstrumentationImpl.redefineClasses(Unknown Source)</div><div class="line">	at Premain.redefineClassesFromBytes(Premain.java:44)</div><div class="line">	at Premain.loadFromDirection(Premain.java:24)</div><div class="line">	at TestReload.fromDirection(TestReload.java:19)</div><div class="line">	at TestReload.main(TestReload.java:6)</div><div class="line">2</div></pre></td></tr></table></figure></p>
<p>完整项目<a href="https://github.com/yu66/JVM-reload" target="_blank" rel="external">JVM-reload</a></p>
<h2 id="Agentmain"><a href="#Agentmain" class="headerlink" title="Agentmain"></a>Agentmain</h2><p>在 Java SE 5 中premain 所作的 Instrumentation 也仅限与 main 函数执行前,这样的方式存在一定的局限性.Java SE 6 针对这种状况做出了改进,开发者可以在 main 函数开始执行以后,再启动自己的 Instrumentation 程序.在 Java SE 6 的 Instrumentation 当中,有一个跟 premain“并驾齐驱”的“agentmain”方法,可以在 main 函数开始运行之后再运行.</p>
<p>首先我们还是需要修改MANIFEST.MF文件, 在其中添加<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Manifest-Version: <span class="number">1.0</span></div><div class="line">Agent-Class: AgentMain</div><div class="line">Can-Redefine-Classes: <span class="keyword">true</span></div></pre></td></tr></table></figure></p>
<p>然后我们写一个代理类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> javax.xml.transform.Transformer;</div><div class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</div><div class="line"><span class="keyword">import</span> java.lang.instrument.UnmodifiableClassException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentMain</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span></span></div><div class="line">            <span class="keyword">throws</span> ClassNotFoundException, UnmodifiableClassException,</div><div class="line">            InterruptedException &#123;</div><div class="line">        <span class="keyword">for</span> (Class clazz : inst.getAllLoadedClasses()) &#123;</div><div class="line">            System.out.println(<span class="string">"Loaded Class : "</span> + clazz.getName());</div><div class="line">        &#125;</div><div class="line">        Printer.printTime();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Printer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printTime</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"now is "</span> + <span class="keyword">new</span> Date());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后写一个启动类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachine;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.management.ManagementFactory;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentLoader</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        String name = ManagementFactory.getRuntimeMXBean().getName();</div><div class="line">        String pid = name.split(<span class="string">"@"</span>)[<span class="number">0</span>];</div><div class="line">        System.out.println(pid);</div><div class="line">        VirtualMachine vm = VirtualMachine.attach(pid);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</div><div class="line"><span class="comment">//            vm.loadAgent("D:\\ming\\test\\target\\test-1.0-SNAPSHOT.jar");</span></div><div class="line">            vm.loadAgentPath(<span class="string">"D:\\ming\\test\\target\\test-1.0-SNAPSHOT.jar"</span>);</div><div class="line">            System.out.println(<span class="string">"Load Agent Over!!!"</span>);</div><div class="line">            TimeUnit.SECONDS.sleep(<span class="number">10</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打包后, 执行命令<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -cp .;.<span class="comment">/* AgentLoader</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/24/jvm/instrument/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/11/24/jvm/instrument/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/23/JavaLibrary/Netty Channel/" title="Netty Channel" itemprop="url">Netty Channel</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2015-11-22T16:00:00.000Z" itemprop="datePublished"> 發表於 2015-11-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><code>Channel</code>是Netty网络抽象类. 它的功能包括网络IO的读写,链路的连接和关闭, 通信双方的通信地址等.<br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/netty/channel.jpg" alt=""></p>
<p>下面我们看一下Channel提供的API</p>
<ul>
<li><code>parent()</code> : 获取父Channel</li>
<li><code>unsafe()</code> :</li>
<li><code>localAddress()</code> : 当前Channel的本地绑定地址</li>
<li><code>eventLoop()</code> : 当前Channel注册到的EventLoop对象</li>
<li><code>config()</code> : 获取当前Channel的配置信息</li>
<li><code>remoteAddress()</code> : 当前Channel通信的远程Socket地址</li>
<li><code>metadata()</code> : 当前Channel的元数据描述信息,例如TCP参数等等</li>
<li><code>isOpen()</code> : 判断当初Channel是否已经打开</li>
<li><code>isWritable()</code> : 当前Channel是否可写</li>
<li><code>isRegistered()</code> : 是否注册当EventLoop上</li>
<li><code>isActive()</code> : 当前Channel是否处于激活状态</li>
<li><code>pipeline()</code> : 当前Channel的ChannelPipeline对象</li>
</ul>
<p>下面的网络IO操作会直接调用ChannelPipeline里的方法, 在ChannelPipeline里进行事件传播</p>
<ul>
<li><code>read()</code> : 从Channel中读取数据到inbound缓冲区</li>
<li><code>write()</code> : 将消息通过ChannelPipeline写入到目标Channel中</li>
<li><code>close()</code> : 主动关闭与网络对端的连接</li>
<li><code>flush()</code> : 将之前写到环形队列里的消息全部写到目标Channel中,发送给网络对端</li>
<li><code>connect()</code> : 与网络对端发起连接请求(一般由客户端调用这个方法)</li>
<li><code>bind()</code> :</li>
<li><code>disconnect()</code> : 请求关闭与网络对端的连接.</li>
</ul>
<h2 id="AbstractChannel"><a href="#AbstractChannel" class="headerlink" title="AbstractChannel"></a>AbstractChannel</h2><p>我们首先看一下<code>AbstractChannel</code>里定义的成员<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 链路已经关闭异常</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> ClosedChannelException CLOSED_CHANNEL_EXCEPTION = <span class="keyword">new</span> ClosedChannelException();</div><div class="line"><span class="comment">// 链路尚未连接异常</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> NotYetConnectedException NOT_YET_CONNECTED_EXCEPTION = <span class="keyword">new</span> NotYetConnectedException();</div><div class="line"></div><div class="line"><span class="keyword">static</span> &#123;</div><div class="line">    CLOSED_CHANNEL_EXCEPTION.setStackTrace(EmptyArrays.EMPTY_STACK_TRACE);</div><div class="line">    NOT_YET_CONNECTED_EXCEPTION.setStackTrace(EmptyArrays.EMPTY_STACK_TRACE);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 用于预测下一个报文的大小.</span></div><div class="line"><span class="keyword">private</span> MessageSizeEstimator.Handle estimatorHandle;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Channel parent;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Unsafe unsafe;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelPipeline pipeline;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelFuture succeededFuture = <span class="keyword">new</span> SucceededChannelFuture(<span class="keyword">this</span>, <span class="keyword">null</span>);</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> VoidChannelPromise voidPromise = <span class="keyword">new</span> VoidChannelPromise(<span class="keyword">this</span>, <span class="keyword">true</span>);</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> VoidChannelPromise unsafeVoidPromise = <span class="keyword">new</span> VoidChannelPromise(<span class="keyword">this</span>, <span class="keyword">false</span>);</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> CloseFuture closeFuture = <span class="keyword">new</span> CloseFuture(<span class="keyword">this</span>);</div><div class="line"></div><div class="line"><span class="comment">// 本地IP地址</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> SocketAddress localAddress;</div><div class="line"><span class="comment">// 网络通信对端的IP地址</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> SocketAddress remoteAddress;</div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> EventLoop eventLoop;</div><div class="line"><span class="comment">// Channel是否注册到了EventLoop上</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> registered;</div><div class="line"></div><div class="line"><span class="comment">/** Cache for the string representation of this channel */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> strValActive;</div><div class="line"><span class="keyword">private</span> String strVal;</div></pre></td></tr></table></figure></p>
<p><code>AbstractChannel</code>聚合了所有Channel使用到的能力的对象. 如果某个功能和子类相关则定义抽象方法,由子类去实现.</p>
<p>在这里我们主要关注三个变量</p>
<ul>
<li><code>unsafe</code> : 真实网络IO的操作类</li>
<li><code>pipeline</code> : 当前Channel对应的ChannelPipeline. 负责</li>
<li><code>eventLoop</code> : 该Channel注册到的EventLoop<br>在实例化的时候, 会对<code>pipeline</code>和<code>unsafe</code>进行赋值.<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">AbstractChannel</span><span class="params">(Channel parent)</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>.parent = parent;</div><div class="line">      unsafe = newUnsafe();</div><div class="line">      pipeline = <span class="keyword">new</span> DefaultChannelPipeline(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>unsafe实例化由子类实现, 这是因为unsafe的类型是个Unsafe接口, 而且AbstractChannel的内部类AbstractUnsafe是个抽象类, 那么我们就不知道如果要实例化这个类型究竟要使用哪个类型, 因此让AbstractChannel的子类继续实现自己的Unsafe接口的内部类和newUnsafe()方法, unsafe实质类型就有很大的可扩展性</p>
</blockquote>
<p>我们看到每一个Channel都有一个自己的<code>pipeline</code>和<code>unsafe</code>. <code>eventLoop</code>是在<code>AbstractUnsafe</code>中<code>register()</code>方法调用时进行赋值的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(EventLoop eventLoop, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">        AbstractChannel.<span class="keyword">this</span>.eventLoop = eventLoop;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>AbstractChannel</code>完成的功能很少, 只是实现了一些初始化的工作, 然后将网络相关的建立,数据读写操作等交给<code>pipeline</code>来完成.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">disconnect</span><span class="params">(ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> pipeline.disconnect(promise);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">close</span><span class="params">(ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> pipeline.close(promise);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> pipeline.bind(localAddress, promise);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">connect</span><span class="params">(SocketAddress remoteAddress, ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> pipeline.connect(remoteAddress, promise);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">Override</span></div><div class="line"><span class="keyword">public</span> Channel <span class="title">read</span><span class="params">()</span> &#123;</div><div class="line">    pipeline.read();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">write</span><span class="params">(Object msg)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> pipeline.write(msg);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>还提供了一个<code>unsafe()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Unsafe <span class="title">unsafe</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> unsafe;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看一下<code>AbstractUnsafe</code>的定义<code>protected abstract class AbstractUnsafe implements Unsafe</code>, 它是作为一个<code>AbstractChannel</code>的抽象内部类, 这种关系也很容易让<code>AbstractUnsafe</code>访问<code>AbstractChannel</code>定义的一些空实现方法. 例如<code>AbstractUnsafe</code>中调用<code>AbstractChannel</code>的方法如下</p>
<ul>
<li><code>beginRead()</code> -&gt; <code>doBeginRead()</code></li>
<li><code>doBind()</code> -&gt; <code>doBind()</code></li>
<li><code>doDisconnect()</code> -&gt; <code>doDisconnect()()</code></li>
<li><code>doClose()</code> -&gt; <code>doClose()</code></li>
<li><code>register()</code> -&gt; <code>doRegister()</code>以及调用pipeline的相关方法(fireChannelRegistered()和fireChannelActive())</li>
</ul>
<h2 id="AbstractNioChannel"><a href="#AbstractNioChannel" class="headerlink" title="AbstractNioChannel"></a>AbstractNioChannel</h2><p><code>AbstractNioChannel</code>主要是实现了<code>AbstractChannel</code>的<code>doRegister(), doDeregister(), doBeginRead()</code>方法. 通过下面的变量我们也可以看出这个类主要是为了完成<code>SelectableChannel</code>向<code>Selector</code>的注册功能.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> SelectableChannel ch;</div><div class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> readInterestOp;</div><div class="line"><span class="keyword">volatile</span> SelectionKey selectionKey;</div></pre></td></tr></table></figure></p>
<p><code>java.nio.channels.ServerSocketChannel</code>和<code>java.nio.channels.SocketChannel</code>都是实现了<code>java.nio.channels.SelectableChannel</code>接口. 而<code>NioSocketChannel</code>和<code>NioServerSocketChannel</code>实现了<code>AbstractNioChannel</code>接口, 因此我们在<code>AbstractNioChannel</code>内定义了一个<code>SelectableChannel</code>成员用于实现<code>ServerSocketChannel</code>和<code>SocketChannel</code>的共用</p>
<p>然后我们看一下<code>doRegister()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegister</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> selected = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">for</span> (;;) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">// 我们将ServerSocketChannel或者SocketChannel注册到NioEventLoop里的Selector上</span></div><div class="line">			<span class="comment">// 0表示我们对任何事件Channel里的任何事件都不感兴趣</span></div><div class="line">			<span class="comment">// 同时我们将this作为附件传送进去,</span></div><div class="line">            selectionKey = javaChannel().register(eventLoop().selector, <span class="number">0</span>, <span class="keyword">this</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123;</div><div class="line">            <span class="keyword">if</span> (!selected) &#123;</div><div class="line">                <span class="comment">// Force the Selector to select now as the "canceled" SelectionKey may still be</span></div><div class="line">                <span class="comment">// cached and not removed because no Select.select(..) operation was called yet.</span></div><div class="line">                eventLoop().selectNow();</div><div class="line">                selected = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// We forced a select operation on the selector before but the SelectionKey is still cached</span></div><div class="line">                <span class="comment">// for whatever reason. JDK bug ?</span></div><div class="line">                <span class="keyword">throw</span> e;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后我们看一下<code>doBeginRead()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doBeginRead</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="comment">// Channel.read() or ChannelHandlerContext.read() was called</span></div><div class="line">    <span class="keyword">if</span> (inputShutdown) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> SelectionKey selectionKey = <span class="keyword">this</span>.selectionKey;</div><div class="line">    <span class="keyword">if</span> (!selectionKey.isValid()) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    readPending = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 获取selectionKey的操作位</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> interestOps = selectionKey.interestOps();</div><div class="line">    <span class="keyword">if</span> ((interestOps &amp; readInterestOp) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// 如果slectionKey不对读事件感兴趣, 那么就修改selectionKey的操作位, 开始设置对读事件感兴趣</span></div><div class="line">        selectionKey.interestOps(interestOps | readInterestOp);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>还记得在<code>AbstractChannel</code>中的<code>AbstractUnsafe</code>吗?里面有个<code>beginRead()</code>, 这个<code>doBeginRead()</code>正是由其调用的.</p>
<h2 id="AbstractNioByteChannel"><a href="#AbstractNioByteChannel" class="headerlink" title="AbstractNioByteChannel"></a>AbstractNioByteChannel</h2><p><code>AbstractNioByteChannel</code>内部只有一个<code>Runnable</code>类型的<code>flushTask</code>属性, 它是用来写半包的, 当我们使用到它的时候,我们再具体分析. 我们来重点看一下<code>doWrite()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doWrite</span><span class="params">(ChannelOutboundBuffer in)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       <span class="keyword">int</span> writeSpinCount = -<span class="number">1</span>;</div><div class="line"></div><div class="line">       <span class="keyword">for</span> (;;) &#123;</div><div class="line">           <span class="comment">// 从环形数组ChannelOutboundBuffer中弹出一个消息对象</span></div><div class="line">           Object msg = in.current();</div><div class="line">           <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="comment">// 如果全部消息都发送完毕累,则清除半包标志, clearOpWrite() 内部操作 TODO ???</span></div><div class="line">               clearOpWrite();</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> ByteBuf) &#123;</div><div class="line">               ByteBuf buf = (ByteBuf) msg;</div><div class="line">               <span class="keyword">int</span> readableBytes = buf.readableBytes();</div><div class="line">               <span class="keyword">if</span> (readableBytes == <span class="number">0</span>) &#123;</div><div class="line">                   <span class="comment">// 当前消息没有可读内容, 也就是没有内容需要向外发送,</span></div><div class="line">                   <span class="comment">// 则将其从还行数组中删除, 然后继续处理下一个消息</span></div><div class="line">                   in.remove();</div><div class="line">                   <span class="keyword">continue</span>;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="comment">//设置半包标志</span></div><div class="line">               <span class="keyword">boolean</span> setOpWrite = <span class="keyword">false</span>;</div><div class="line">               <span class="comment">// 设置消息是否发送完毕</span></div><div class="line">               <span class="keyword">boolean</span> done = <span class="keyword">false</span>;</div><div class="line">               <span class="comment">// 设置消息发送的总得数量</span></div><div class="line">               <span class="keyword">long</span> flushedAmount = <span class="number">0</span>;</div><div class="line">               <span class="keyword">if</span> (writeSpinCount == -<span class="number">1</span>) &#123;</div><div class="line">                   <span class="comment">// 从配置中我们获取每次写半包消息进行的最大次数. 也即是如果环形数组里的消息一次性发送</span></div><div class="line">                   <span class="comment">// 不完, 需要循环发送的次数,至于为什么不一直发送, 这是因为如果网络阻塞或者对方接受数据很慢,可能会造成网络IO线程假死</span></div><div class="line">                   writeSpinCount = config().getWriteSpinCount();</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = writeSpinCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i --) &#123;</div><div class="line">                   <span class="comment">// 将buf内部的数据进行发送, 返回值是数据发送量</span></div><div class="line">                   <span class="keyword">int</span> localFlushedAmount = doWriteBytes(buf);</div><div class="line">                   <span class="keyword">if</span> (localFlushedAmount == <span class="number">0</span>) &#123;</div><div class="line">                       <span class="comment">// 数量为0,说明一个数据都没有发送出去, 可能是TCP缓冲区满了. 因此设置写半包标志</span></div><div class="line">                       <span class="comment">// 同时退出写循环,这是因为下次写数据还可能TCP缓冲区处于已满状态,导致IO线程空循环</span></div><div class="line">                       setOpWrite = <span class="keyword">true</span>;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   <span class="comment">// 数据发送成功, 将发送的数据量累加到flushedAmount上.</span></div><div class="line">                   flushedAmount += localFlushedAmount;</div><div class="line">                   <span class="keyword">if</span> (!buf.isReadable()) &#123;</div><div class="line">                       <span class="comment">// 当前消息里的数据已经发送完毕, 退出buf发送循环,继续处理环形队列中下一个消息</span></div><div class="line">                       done = <span class="keyword">true</span>;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="comment">// 将发送的数据量同步到环形队列中</span></div><div class="line">               in.progress(flushedAmount);</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (done) &#123;</div><div class="line">                   <span class="comment">// buf数据已经发送完, 则将该消息从环形队列中删除</span></div><div class="line">                   in.remove();</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="comment">// 在写半包消息最大循环次数之内都没有将buf数据写完, 可能是数据量太多或者TCP缓冲区已满</span></div><div class="line">                   <span class="comment">// 释放当前IO线程,让其进行其他工作.</span></div><div class="line">                   incompleteWrite(setOpWrite);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> FileRegion) &#123;</div><div class="line">               FileRegion region = (FileRegion) msg;</div><div class="line">               <span class="keyword">boolean</span> done = region.transfered() &gt;= region.count();</div><div class="line">               <span class="keyword">boolean</span> setOpWrite = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (!done) &#123;</div><div class="line">                   <span class="keyword">long</span> flushedAmount = <span class="number">0</span>;</div><div class="line">                   <span class="keyword">if</span> (writeSpinCount == -<span class="number">1</span>) &#123;</div><div class="line">                       writeSpinCount = config().getWriteSpinCount();</div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> i = writeSpinCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">                       <span class="keyword">long</span> localFlushedAmount = doWriteFileRegion(region);</div><div class="line">                       <span class="keyword">if</span> (localFlushedAmount == <span class="number">0</span>) &#123;</div><div class="line">                           setOpWrite = <span class="keyword">true</span>;</div><div class="line">                           <span class="keyword">break</span>;</div><div class="line">                       &#125;</div><div class="line"></div><div class="line">                       flushedAmount += localFlushedAmount;</div><div class="line">                       <span class="keyword">if</span> (region.transfered() &gt;= region.count()) &#123;</div><div class="line">                           done = <span class="keyword">true</span>;</div><div class="line">                           <span class="keyword">break</span>;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   in.progress(flushedAmount);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (done) &#123;</div><div class="line">                   in.remove();</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   incompleteWrite(setOpWrite);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="comment">// Should not reach here.</span></div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> Error();</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p><code>doWrite()</code>方法是由<code>AbstractUnsafe</code>的<code>flush()</code>调用的. 从<code>AbstractUnsafe</code>我们可以看到每个Unsafe类都有一个<code>ChannelOutboundBuffer</code>属性.</p>
<p>下来我们看一下<code>incompleteWrite()</code>方法实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">incompleteWrite</span><span class="params">(<span class="keyword">boolean</span> setOpWrite)</span> </span>&#123;</div><div class="line">        <span class="comment">// 从doWrite()方法中可以看到只有当TCP缓冲区已满的时候才会设置写半包操作</span></div><div class="line">        <span class="keyword">if</span> (setOpWrite) &#123;</div><div class="line">            <span class="comment">// 设置累写半包的话,则将SelectionKey注册为OP_WRITE, 让多路复用器不断的轮训对应的Channel,</span></div><div class="line">            <span class="comment">// 继续处理没有发送完的消息</span></div><div class="line">            setOpWrite();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 如果没有半包,则让eventLoop继续执行写半包操作</span></div><div class="line">            Runnable flushTask = <span class="keyword">this</span>.flushTask;</div><div class="line">            <span class="keyword">if</span> (flushTask == <span class="keyword">null</span>) &#123;</div><div class="line">                flushTask = <span class="keyword">this</span>.flushTask = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        flush();</div><div class="line">                    &#125;</div><div class="line">                &#125;;</div><div class="line">            &#125;</div><div class="line">            eventLoop().execute(flushTask);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h2 id="AbstractNioMessageChannel"><a href="#AbstractNioMessageChannel" class="headerlink" title="AbstractNioMessageChannel"></a>AbstractNioMessageChannel</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doWrite</span><span class="params">(ChannelOutboundBuffer in)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       <span class="keyword">final</span> SelectionKey key = selectionKey();</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> interestOps = key.interestOps();</div><div class="line"></div><div class="line">       <span class="keyword">for</span> (;;) &#123;</div><div class="line">           <span class="comment">// 从环形队列中获取一条消息</span></div><div class="line">           Object msg = in.current();</div><div class="line">           <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="comment">// 消息为空,说明所有的消息都已经发送出去了. TODO</span></div><div class="line">               <span class="keyword">if</span> ((interestOps &amp; SelectionKey.OP_WRITE) != <span class="number">0</span>) &#123;</div><div class="line">                   key.interestOps(interestOps &amp; ~SelectionKey.OP_WRITE);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               <span class="keyword">boolean</span> done = <span class="keyword">false</span>;</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = config().getWriteSpinCount() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">                   <span class="comment">// 在配置的最大次数下,将msg发送出去</span></div><div class="line">                   <span class="keyword">if</span> (doWriteMessage(msg, in)) &#123;</div><div class="line">                       done = <span class="keyword">true</span>;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (done) &#123;</div><div class="line">                   <span class="comment">// 如果消息发送完毕累, 则将其从环形数组中删除</span></div><div class="line">                   in.remove();</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="comment">//  如果没有发送完毕, 则设置SelectionKey为写操作位, 让多路复用器不断的轮训channel,发送剩余的数据</span></div><div class="line">                   <span class="keyword">if</span> ((interestOps &amp; SelectionKey.OP_WRITE) == <span class="number">0</span>) &#123;</div><div class="line">                       key.interestOps(interestOps | SelectionKey.OP_WRITE);</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">               <span class="keyword">if</span> (continueOnWriteError()) &#123;</div><div class="line">                   in.remove(e);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="keyword">throw</span> e;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h2 id="NioServerSocketChannel"><a href="#NioServerSocketChannel" class="headerlink" title="NioServerSocketChannel"></a>NioServerSocketChannel</h2><p><code>NioServerSocketChannel</code>的主要作用是接受客户端连接<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">doReadMessages</span><span class="params">(List&lt;Object&gt; buf)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       SocketChannel ch = javaChannel().accept();</div><div class="line"></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">if</span> (ch != <span class="keyword">null</span>) &#123;</div><div class="line">               buf.add(<span class="keyword">new</span> NioSocketChannel(<span class="keyword">this</span>, ch));</div><div class="line">               <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">           logger.warn(<span class="string">"Failed to create a new channel from an accepted socket."</span>, t);</div><div class="line"></div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               ch.close();</div><div class="line">           &#125; <span class="keyword">catch</span> (Throwable t2) &#123;</div><div class="line">               logger.warn(<span class="string">"Failed to close a socket."</span>, t2);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这个方法调用主要是由<code>NioMessageUnsafe</code>的<code>read()</code>方法调用</p>
<h2 id="NioSocketChannel"><a href="#NioSocketChannel" class="headerlink" title="NioSocketChannel"></a>NioSocketChannel</h2>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Netty/">Netty</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/23/JavaLibrary/Netty Channel/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/11/23/JavaLibrary/Netty Channel/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/20/JavaLibrary/Netty ByteBuf/" title="Netty ByteBuf" itemprop="url">Netty ByteBuf</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2015-11-19T16:00:00.000Z" itemprop="datePublished"> 發表於 2015-11-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>首先我们来看一下netty buffer包的继承结构<br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/netty/bytebuf.jpg" alt=""><br>接下来我会对几个类进行代码测试.</p>
<p>首先我们来看一下如何使用Netty提供的工具类构建一个ByteBuf<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">Assert.assertEquals(<span class="number">1024</span>, buf.capacity());</div></pre></td></tr></table></figure></p>
<p>我们使用<code>ByteBufAllocator</code>这个工具类构建了一个<code>1024</code>大小的<code>ByteBuf</code>出来.</p>
<p>ByteBuf提供了 <code>readerIndex</code> 和 <code>writerIndex</code> 进行缓冲区的顺序读写操作.</p>
<ul>
<li><code>readerIndex</code>标志读取索引</li>
<li><code>writerIndex</code>标志写入索引</li>
<li>[0, readerIndex] 已经读取多的缓冲区区间</li>
<li>[readerIndex, writerIndex] 可读的缓冲区区间</li>
<li>[writerIndex, capacity]  可写的缓冲区区间</li>
</ul>
<blockquote>
<p>每个索引移动的单位是<code>bytes</code>, 在下例中我们向ByteBuf写入一个int数值, <code>writerIdex</code>会移动4个<code>bytes</code></p>
</blockquote>
<h2 id="ByteBuf-API"><a href="#ByteBuf-API" class="headerlink" title="ByteBuf API"></a>ByteBuf API</h2><p>我们首先看一下ByteBuf提供的API</p>
<h3 id="ByteBuf-write"><a href="#ByteBuf-write" class="headerlink" title="ByteBuf write"></a>ByteBuf write</h3><p>接下来我们看一下向ByteBuf缓冲区写入数据的API</p>
<h4 id="writeInt"><a href="#writeInt" class="headerlink" title="writeInt"></a>writeInt</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWriteInt</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeInt(<span class="number">1</span>);</div><div class="line">	<span class="comment">// 写入一个Int数值, writerIndex向后移动4个字节</span></div><div class="line">	Assert.assertEquals(<span class="number">4</span>, buf.writerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="writeChar"><a href="#writeChar" class="headerlink" title="writeChar"></a>writeChar</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWriteChar</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeChar(<span class="string">'a'</span>);</div><div class="line">	<span class="comment">// 写入一个Char字符, writerIndex向后移动2个字节</span></div><div class="line">	Assert.assertEquals(<span class="number">2</span>, buf.writerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="writeBytes"><a href="#writeBytes" class="headerlink" title="writeBytes"></a>writeBytes</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWriteBytes</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	<span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">100</span>&#125;;</div><div class="line">	buf.writeBytes(bytes);</div><div class="line">	<span class="comment">// 写入一个byte数组, 由于byte数组只有一个元素, writerIndex向后移动1个字节</span></div><div class="line">	Assert.assertEquals(<span class="number">1</span>, buf.writerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="writeBytes-1"><a href="#writeBytes-1" class="headerlink" title="writeBytes"></a>writeBytes</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWriteBytesWithStartEndIndex</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	<span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">100</span>, <span class="number">1</span>, <span class="number">3</span>&#125;;</div><div class="line">	buf.writeBytes(bytes, <span class="number">1</span>, <span class="number">1</span>);</div><div class="line">	<span class="comment">// 我们将三个元素的byte数组写入ByteBuf中,但是在写入的时候我们指定了开始索引和结束索引,</span></div><div class="line">	<span class="comment">// 由于我们的开始索引和结束索引相等, 因此ByteBuf中只写入了1这个元素</span></div><div class="line">	Assert.assertEquals(<span class="number">1</span>, buf.writerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="writeBytes-2"><a href="#writeBytes-2" class="headerlink" title="writeBytes"></a>writeBytes</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWriteBytes3</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	ByteBuf buf1 = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf1.writeInt(<span class="number">1</span>);</div><div class="line">	buf.writeBytes(buf1);</div><div class="line">	<span class="comment">// 我们向ByteBuf中写入另一个ByteBuf, 它的索引仍然是增长4. ByteBuf不仅仅可以写入BuyeBuf,还可以写入InputStream和ByteBuffer</span></div><div class="line">	Assert.assertEquals(<span class="number">4</span>, buf.writerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="writeFloat"><a href="#writeFloat" class="headerlink" title="writeFloat"></a>writeFloat</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWriteFloat</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeFloat(<span class="number">0.1f</span>);</div><div class="line">	<span class="comment">// 写入一个float, 由于float也是占用4个字节, 因此writerIndex向后移动4个字节</span></div><div class="line">	Assert.assertEquals(<span class="number">4</span>, buf.writerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="writeByte"><a href="#writeByte" class="headerlink" title="writeByte"></a>writeByte</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWriteByte</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeByte(<span class="number">1</span>);</div><div class="line">	Assert.assertEquals(<span class="number">1</span>, buf.writerIndex());</div><div class="line">	buf.writeByte(<span class="number">1000</span>);</div><div class="line">	<span class="comment">// 写入一个byte, writerIndex向后移动1个字节,至于写进去的数字大于128,会发生什么,我们在read的时候看一下结果</span></div><div class="line">	Assert.assertEquals(<span class="number">2</span>, buf.writerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="writeShort"><a href="#writeShort" class="headerlink" title="writeShort"></a>writeShort</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWriteShort</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeShort(<span class="number">1000</span>);</div><div class="line">	<span class="comment">// 写入一个short, writerIndex向后移动2个字节</span></div><div class="line">	Assert.assertEquals(<span class="number">2</span>, buf.writerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="writeDouble"><a href="#writeDouble" class="headerlink" title="writeDouble"></a>writeDouble</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWriteDouble</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeDouble(<span class="number">1000.0</span>d);</div><div class="line">	<span class="comment">// 写入一个double, writerIndex向后移动8个字节</span></div><div class="line">	Assert.assertEquals(<span class="number">8</span>, buf.writerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="writeBoolean"><a href="#writeBoolean" class="headerlink" title="writeBoolean"></a>writeBoolean</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWriteBoolean</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeBoolean(<span class="keyword">false</span>);</div><div class="line">	<span class="comment">// 写入一个boolean, writerIndex向后移动1个字节</span></div><div class="line">	Assert.assertEquals(<span class="number">1</span>, buf.writerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="writeLong"><a href="#writeLong" class="headerlink" title="writeLong"></a>writeLong</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWriteLong</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeLong(<span class="number">100l</span>);</div><div class="line">	<span class="comment">// 写入一个long, writerIndex向后移动8个字节</span></div><div class="line">	Assert.assertEquals(<span class="number">8</span>, buf.writerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="writeBytes-3"><a href="#writeBytes-3" class="headerlink" title="writeBytes"></a>writeBytes</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWriteOverLoadMaxCapacity</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">5</span>);</div><div class="line">	buf.writeBytes(<span class="string">"123456"</span>.getBytes());</div><div class="line">	<span class="comment">// 虽然在分配的时候我们只分配了5个字节大小的缓冲区,但是我们写入6个字节它也并不报错,</span></div><div class="line">	<span class="comment">// 而且我们观察到writerIndex确实增长到了6,说明ByteBuf会进行自动拓容.</span></div><div class="line">	Assert.assertEquals(<span class="number">6</span>, buf.writerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ByteBuf-read"><a href="#ByteBuf-read" class="headerlink" title="ByteBuf read"></a>ByteBuf read</h3><p>刚才我们看了向ByteBuf缓冲区写入数据的API,接下来我们看一下从ByteBuf缓冲区读取数据的API</p>
<h4 id="readInt"><a href="#readInt" class="headerlink" title="readInt"></a>readInt</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadInt</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeInt(<span class="number">1</span>);</div><div class="line">	<span class="keyword">int</span> read = buf.readInt();</div><div class="line">	<span class="comment">// 读取Int, readerIndex向后移动4字节</span></div><div class="line">	Assert.assertEquals(<span class="number">4</span>, buf.readerIndex());</div><div class="line">	Assert.assertEquals(<span class="number">1</span>, read);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="readChar"><a href="#readChar" class="headerlink" title="readChar"></a>readChar</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadChar</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeChar(<span class="string">'1'</span>);</div><div class="line">	<span class="keyword">char</span> read = buf.readChar();</div><div class="line">	<span class="comment">// 读取Char, readerIndex向后移动2字节</span></div><div class="line">	Assert.assertEquals(<span class="number">2</span>, buf.readerIndex());</div><div class="line">	Assert.assertEquals(<span class="string">'1'</span>, read);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="readBytes"><a href="#readBytes" class="headerlink" title="readBytes"></a>readBytes</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadBytes</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeBytes(<span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>&#125;);</div><div class="line">	<span class="keyword">byte</span>[] read = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">10</span>];</div><div class="line">	buf.readBytes(read);</div><div class="line">	<span class="comment">// 读取byte数组, 这里需要注意的是, read字节数组的长度不能大于ByteBuf的readerIndex的值,否则会产生数组越界</span></div><div class="line">	Assert.assertEquals(<span class="number">10</span>, buf.readerIndex());</div><div class="line">	Assert.assertEquals(<span class="number">0</span>, read[<span class="number">9</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadBytesWithStartEndIndex</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeBytes(<span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>&#125;);</div><div class="line">	<span class="keyword">byte</span>[] read = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">10</span>];</div><div class="line">	buf.readBytes(read, <span class="number">2</span>, <span class="number">3</span>);</div><div class="line">	<span class="comment">// 从第三个索引开始读取到第4个索引的位置, 读取2个字节, readerIndex移动到第4个索引位置上</span></div><div class="line">	Assert.assertEquals(<span class="number">3</span>, buf.readerIndex());</div><div class="line">	Assert.assertEquals(<span class="number">3</span>, read[<span class="number">0</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRead3Bytes</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeBytes(<span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>&#125;);</div><div class="line">	buf.readBytes(<span class="number">3</span>);</div><div class="line">	<span class="comment">// 读取3个字节, readerIndex向后移动3字节</span></div><div class="line">	Assert.assertEquals(<span class="number">3</span>, buf.readerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="readFloat"><a href="#readFloat" class="headerlink" title="readFloat"></a>readFloat</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadFloat</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeFloat(<span class="number">10.0f</span>);</div><div class="line">	<span class="keyword">float</span> read = buf.readFloat();</div><div class="line">	<span class="comment">// 读取Float, readerIndex向后移动4字节</span></div><div class="line">	Assert.assertEquals(<span class="number">4</span>, buf.readerIndex());</div><div class="line">	Assert.assertEquals(<span class="number">10</span>.f, read);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="readLong"><a href="#readLong" class="headerlink" title="readLong"></a>readLong</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadLong</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeLong(<span class="number">10l</span>);</div><div class="line">	buf.readLong();</div><div class="line">	<span class="comment">// 读取long, readerIndex向后移动8字节</span></div><div class="line">	Assert.assertEquals(<span class="number">8</span>, buf.readerIndex());</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="readByte"><a href="#readByte" class="headerlink" title="readByte"></a>readByte</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadByte</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeBytes(<span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>&#125;);</div><div class="line">	buf.readByte();</div><div class="line">	<span class="comment">// 读取byte, readerIndex向后移动1字节</span></div><div class="line">	Assert.assertEquals(<span class="number">1</span>, buf.readerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="readShort"><a href="#readShort" class="headerlink" title="readShort"></a>readShort</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadShort</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeShort(<span class="number">10</span>);</div><div class="line">	buf.readShort();</div><div class="line">	<span class="comment">// 读取short, readerIndex向后移动2字节</span></div><div class="line">	Assert.assertEquals(<span class="number">2</span>, buf.readerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="readBoolean"><a href="#readBoolean" class="headerlink" title="readBoolean"></a>readBoolean</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadBoolean</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeBoolean(<span class="keyword">true</span>);</div><div class="line">	buf.readBoolean();</div><div class="line">	<span class="comment">// 读取boolean, readerIndex向后移动1字节</span></div><div class="line">	Assert.assertEquals(<span class="number">1</span>, buf.readerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="readDouble"><a href="#readDouble" class="headerlink" title="readDouble"></a>readDouble</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadDouble</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeDouble(<span class="number">10.0</span>d);</div><div class="line">	buf.readDouble();</div><div class="line">	<span class="comment">// 读取double, readerIndex向后移动8字节</span></div><div class="line">	Assert.assertEquals(<span class="number">8</span>, buf.readerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="readUnsignedByte"><a href="#readUnsignedByte" class="headerlink" title="readUnsignedByte"></a>readUnsignedByte</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadUnsignedByte</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeByte(-<span class="number">10</span>);</div><div class="line">	<span class="keyword">short</span> read = buf.readUnsignedByte();</div><div class="line">	<span class="comment">// 读取无符号byte, readerIndex向后移动1字节</span></div><div class="line">	Assert.assertEquals(<span class="number">1</span>, buf.readerIndex());</div><div class="line">	Assert.assertEquals(<span class="number">246</span>, read);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="readUnsignedShort"><a href="#readUnsignedShort" class="headerlink" title="readUnsignedShort"></a>readUnsignedShort</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadUnsignedShort</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeShort(-<span class="number">1024</span>);</div><div class="line">	<span class="comment">// 我们首先读取出-1024,这个负数,然后转化成无符号数字64512</span></div><div class="line">	<span class="keyword">int</span> read = buf.readUnsignedShort();</div><div class="line">	<span class="comment">// 读取无符号Short, readerIndex向后移动2字节</span></div><div class="line">	Assert.assertEquals(<span class="number">2</span>, buf.readerIndex());</div><div class="line">	Assert.assertEquals(<span class="number">64512</span>, read);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="readerIndex"><a href="#readerIndex" class="headerlink" title="readerIndex"></a>readerIndex</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReaderIndex</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeBytes(<span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>&#125;);</div><div class="line">	Assert.assertEquals(<span class="number">0</span>, buf.readerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="readByte-1"><a href="#readByte-1" class="headerlink" title="readByte"></a>readByte</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadableBytes</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeBytes(<span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>&#125;);</div><div class="line">	Assert.assertEquals(<span class="number">10</span>, buf.readableBytes());</div><div class="line">	buf.readByte();</div><div class="line">	<span class="comment">// 我们读取一个byte之后, 可读取字节变成了9个字节</span></div><div class="line">	Assert.assertEquals(<span class="number">9</span>, buf.readableBytes());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="readUnsignedInt"><a href="#readUnsignedInt" class="headerlink" title="readUnsignedInt"></a>readUnsignedInt</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadUnsignedInt</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeInt(<span class="number">10</span>);</div><div class="line">	<span class="keyword">long</span> read = buf.readUnsignedInt();</div><div class="line">	Assert.assertEquals(<span class="number">4</span>, buf.readerIndex());</div><div class="line">	Assert.assertEquals(<span class="number">10</span>, read);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="readSlice"><a href="#readSlice" class="headerlink" title="readSlice"></a>readSlice</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadSlice</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeBytes(<span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>&#125;);</div><div class="line">	ByteBuf read = buf.readSlice(<span class="number">5</span>);</div><div class="line">	<span class="comment">// slice出来的ByteBuf与原ByteBuf共享缓冲区</span></div><div class="line">	Assert.assertEquals(<span class="number">5</span>, buf.readerIndex());</div><div class="line">	Assert.assertEquals(<span class="number">1</span>, read.readByte());</div><div class="line">	Assert.assertEquals(<span class="number">6</span>, buf.readByte());</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="readInt-1"><a href="#readInt-1" class="headerlink" title="readInt"></a>readInt</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWriteBytesReadInt</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</div><div class="line">	buf.writeBytes(<span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>&#125;);</div><div class="line">	<span class="keyword">int</span> read = buf.readInt();</div><div class="line">	<span class="comment">// 从一个byte数组中读取一个int, 会读取出1, 2, 3, 4这四个byte转换成int为16909060</span></div><div class="line">	Assert.assertEquals(<span class="number">16909060</span>, read);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="discard-bytes"><a href="#discard-bytes" class="headerlink" title="discard bytes"></a>discard bytes</h3><p>在前面的测试中我们看到了,当向ByteBuf写入数据时,当超出分配内存大小时,ByteBuf会进行自动拓容(重新生成一个数组缓冲区,然后将原先的缓冲区内容拷贝到新的缓冲区中),这样一来ByteBuf占用的内从会越来越大. 我们可以是<code>discardReadBytes()</code>这个方法重用以前的缓冲区, 它会将[0, readerIndex]区间的内存舍弃掉(内部也是数组复制), 这么着就节间的重用了以前的缓冲区,但是这种方式有一点就是如果频繁的调用这个方法会带来性能问题.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">50</span>);</div><div class="line">buf.writeBytes(<span class="string">"123456789"</span>.getBytes());</div><div class="line">buf.readBytes(<span class="number">3</span>);	<span class="comment">// 读取三个字节</span></div><div class="line">System.out.println(buf.readerIndex());		<span class="comment">// readerIndex位置 : 3</span></div><div class="line">System.out.println(buf.writerIndex());		<span class="comment">// writerIndex位置: 9</span></div><div class="line">System.out.println(buf.readableBytes());	<span class="comment">// 可读字节 9 - 3 = 6</span></div><div class="line">System.out.println(buf.writableBytes());	<span class="comment">// 可写字节 50 - 9 = 41</span></div><div class="line"></div><div class="line"><span class="comment">// 舍弃已读字节, readerIndex重置为0</span></div><div class="line">buf.discardReadBytes();</div><div class="line">System.out.println(buf.readerIndex());		<span class="comment">// readerIndex位置 : 0</span></div><div class="line">System.out.println(buf.writerIndex());		<span class="comment">// writerIndex位置: 6</span></div><div class="line">System.out.println(buf.readableBytes());	<span class="comment">// 可读字节 6</span></div><div class="line">System.out.println(buf.writableBytes());	<span class="comment">// 可写字节 50 - 6 = 44</span></div></pre></td></tr></table></figure></p>
<h3 id="clear"><a href="#clear" class="headerlink" title="clear"></a>clear</h3><p>这个操作并不会情况缓冲区的内容只是用来将readerIndex和writerIndex重置为0. 但是缓冲区的内容我们是仍然可以读到的.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">50</span>);</div><div class="line">buf.writeBytes(<span class="string">"123456789"</span>.getBytes());</div><div class="line">buf.readBytes(<span class="number">3</span>);	<span class="comment">// 读取三个字节</span></div><div class="line">System.out.println(buf.readerIndex());		<span class="comment">// readerIndex位置 : 3</span></div><div class="line">System.out.println(buf.writerIndex());		<span class="comment">// writerIndex位置: 9</span></div><div class="line">System.out.println(buf.readableBytes());	<span class="comment">// 可读字节 9 - 3 = 6</span></div><div class="line">System.out.println(buf.writableBytes());	<span class="comment">// 可写字节 50 - 9 = 41</span></div><div class="line"></div><div class="line"><span class="comment">// 重置readerIndex和writerIndex</span></div><div class="line">buf.clear();</div><div class="line">System.out.println(buf.readerIndex());		<span class="comment">// readerIndex位置 : 0</span></div><div class="line">System.out.println(buf.writerIndex());		<span class="comment">// writerIndex位置: 0</span></div><div class="line">System.out.println(buf.readableBytes());	<span class="comment">// 可读字节 readerIndex = 0</span></div><div class="line">System.out.println(buf.writableBytes());	<span class="comment">// 可写字节 capacity - writerIndex = 50</span></div><div class="line"><span class="comment">// 设置writerIndex</span></div><div class="line">buf.writerIndex(<span class="number">6</span>);</div><div class="line">System.out.println(buf.readerIndex());		<span class="comment">// readerIndex位置 : 0</span></div><div class="line">System.out.println(buf.writerIndex());		<span class="comment">// writerIndex位置: 6</span></div><div class="line">System.out.println(buf.readableBytes());	<span class="comment">// 可读字节 writerIndex - readerIndex = 6</span></div><div class="line">System.out.println(buf.writableBytes());	<span class="comment">// 可写字节 44</span></div><div class="line">System.out.println(buf.readByte());</div></pre></td></tr></table></figure></p>
<h3 id="mark-reset"><a href="#mark-reset" class="headerlink" title="mark reset"></a>mark reset</h3><p>mark reset相关的四个方法也是对指针位置的操作</p>
<ul>
<li><code>markReaderIndex()</code> 记录readerIndex</li>
<li><code>markWriterIndex()</code> 记录writerIndex</li>
<li><code>resetReaderIndex()</code>  将记录的readerIndex重置到当前的readerIndex值</li>
<li><code>resetWriterIndex()</code>  将记录的writerIndex重置到当前的writerIndex值</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReaderIndex</span><span class="params">()</span> </span>&#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">50</span>);</div><div class="line">	buf.writeBytes(<span class="string">"123456789"</span>.getBytes());</div><div class="line">	buf.readBytes(<span class="number">3</span>);</div><div class="line">	buf.markReaderIndex();</div><div class="line">	buf.readBytes(<span class="number">1</span>);</div><div class="line">	Assert.assertEquals(<span class="number">4</span>, buf.readerIndex());</div><div class="line">	buf.resetReaderIndex();</div><div class="line">	Assert.assertEquals(<span class="number">3</span>, buf.readerIndex());</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">```<span class="function">java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWriterIndex</span><span class="params">()</span> &#123;</div><div class="line">	ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">50</span>);</div><div class="line">	buf.writeBytes(<span class="string">"123456789"</span>.getBytes());</div><div class="line">	buf.markWriterIndex();</div><div class="line">	buf.writeByte(<span class="number">1</span>);</div><div class="line">	Assert.assertEquals(<span class="number">10</span>, buf.writerIndex());</div><div class="line">	buf.resetWriterIndex();</div><div class="line">	Assert.assertEquals(<span class="number">9</span>, buf.writerIndex());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h3><p>ByteBuf提供丰富的API让我查找某个Byte<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">50</span>);</div><div class="line">buf.writeBytes(<span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span> ,<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 在指定的范围内查找某个byte</span></div><div class="line"><span class="keyword">int</span> idx = buf.indexOf(<span class="number">0</span>, buf.writerIndex(), (<span class="keyword">byte</span>)<span class="number">2</span>);</div><div class="line">System.out.println(idx);	<span class="comment">// 1</span></div><div class="line"></div><div class="line">idx = buf.indexOf(<span class="number">3</span>, buf.writerIndex(), (<span class="keyword">byte</span>)<span class="number">2</span>);</div><div class="line">System.out.println(idx);	<span class="comment">// -1</span></div><div class="line"></div><div class="line"><span class="comment">// 在[readerIndex, writerIndex]之间查找值</span></div><div class="line">idx = buf.bytesBefore((<span class="keyword">byte</span>)<span class="number">2</span>);</div><div class="line">System.out.println(idx);  <span class="comment">// 4</span></div><div class="line"></div><div class="line">buf.readBytes(<span class="number">3</span>);</div><div class="line">idx = buf.bytesBefore((<span class="keyword">byte</span>)<span class="number">2</span>);</div><div class="line">System.out.println(idx); <span class="comment">// -1</span></div><div class="line"></div><div class="line"><span class="comment">// 在[readerIndex, writerIndex]之间遍历查找值</span></div><div class="line">idx = buf.forEachByte(b -&gt; b == (<span class="keyword">byte</span>) <span class="number">6</span>);</div><div class="line">System.out.println(idx); <span class="comment">// 3</span></div></pre></td></tr></table></figure></p>
<h3 id="derived-buffers"><a href="#derived-buffers" class="headerlink" title="derived buffers"></a>derived buffers</h3><p>ByteBuf提供多种API用于创建某个ByteBuf的视图或者复制版本</p>
<ul>
<li><code>duplicate()</code> 复制ByteBuf对象, 俩个对象共享同一个缓冲区,但是各自维护自己的索引(readerIndex, writerIndex)</li>
<li><code>copy()</code> 复制ByteBuf对象, 俩个对象共享有自己的缓冲区, 缓冲区和索引都不共享</li>
<li><code>slice()</code>  复制Bytebuf对象,但是只复制[readerIndex, writerIndex]区间的缓冲区, 俩个对象的缓冲区是共享的,但是维护各自的索引</li>
</ul>
<h3 id="get-set"><a href="#get-set" class="headerlink" title="get set"></a>get set</h3><p>ByteBuf不仅仅支持read, write的顺序读写还支持get,set的随机读取。 但是get/set不会进行自动拓容.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(<span class="number">50</span>);</div><div class="line">buf.writeBytes(<span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span> ,<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;);</div><div class="line"></div><div class="line"><span class="keyword">byte</span> b = buf.getByte(<span class="number">2</span>);</div><div class="line">System.out.println(buf.readableBytes());	<span class="comment">// 9</span></div><div class="line">System.out.println(buf.readerIndex());		<span class="comment">// 0</span></div><div class="line">System.out.println(b);		<span class="comment">// 3</span></div></pre></td></tr></table></figure></p>
<h2 id="内存池"><a href="#内存池" class="headerlink" title="内存池"></a>内存池</h2><p>Netty的内存池由<code>PoolArea</code>. <code>PoolArea</code>由多个<code>PoolChunk</code>组成. </p>
<h2 id="ButeBuf-类型"><a href="#ButeBuf-类型" class="headerlink" title="ButeBuf 类型"></a>ButeBuf 类型</h2><p>看完ByteBuf的API操作我们来看一下ByteBuf的分类,在内存使用种类上ByteBuf分为以下俩类</p>
<ul>
<li>DirectByteBuf : 使用JVM堆外内存分配. 虽然分配和回收速度慢一些,但是从SocketChannel中写入或者读取数据由于少了一次内存复制,因此速度较快.(SocketIO通信时适合使用)</li>
<li>HeapByteBuf: 使用JVM堆内内存分配. 内存分配和回收速度较快,但是读写Socket IO的时候由于会额外进行一次内存复制,堆内存对应的缓冲区复制到内核Channel中,性能会有下降.(后端业务在编解码时适合使用)</li>
</ul>
<p>在内存使用种类上由分为以下俩类</p>
<ul>
<li>PooledByteBuf: 基于内存对象池的ByteBuf, </li>
<li>UnpooledByteBuf: </li>
</ul>
<blockquote>
<p>UnpooledDirectByteBuf, UnpooledHeapByteBuf, UnpooledUnsafeDirectByteBuf ,PooledDirectByteBuf, PooledHeapByteBuf</p>
</blockquote>
<h2 id="AbstractByteBuf"><a href="#AbstractByteBuf" class="headerlink" title="AbstractByteBuf"></a>AbstractByteBuf</h2><p><code>AbstractByteBuf</code>继承自<code>ByteBuf</code>, 它内部并没有定义ByteBuf的缓冲区实现,只是通过定义<code>readerIndex</code>, <code>writerIndex</code>, <code>capacity</code>等实现ByteBuf接口中的各种API, 具体的缓冲区实现则由子类实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> ResourceLeakDetector&lt;ByteBuf&gt; leakDetector = <span class="keyword">new</span> ResourceLeakDetector&lt;ByteBuf&gt;(ByteBuf.class);</div><div class="line"></div><div class="line"><span class="keyword">int</span> readerIndex;</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> writerIndex;</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> markedReaderIndex;</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> markedWriterIndex;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> maxCapacity;</div><div class="line"></div><div class="line"><span class="keyword">private</span> SwappedByteBuf swappedBuf;</div></pre></td></tr></table></figure></p>
<p>除了操作具体缓冲区API没有实现之外 <code>AbstractByteBuf</code>为我们实现了大量的API,首先我们看一下读数据的API<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">readBytes</span><span class="params">(<span class="keyword">byte</span>[] dst, <span class="keyword">int</span> dstIndex, <span class="keyword">int</span> length)</span> </span>&#123;</div><div class="line">	<span class="comment">// 检查当前缓冲区中的可读数据是否满足length长度</span></div><div class="line">    checkReadableBytes(length);</div><div class="line">    <span class="comment">// 将当前缓冲区的数据从readerIndex开始读取length个长度到目标dst缓冲区中. </span></div><div class="line">    <span class="comment">// 这个方法也就是拷贝一部分数据到新的缓冲区中,但是并不会改变当前缓冲区的readerIndex和writerIndex</span></div><div class="line">    getBytes(readerIndex, dst, dstIndex, length);</div><div class="line">    readerIndex += length;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下面我们看一下写数据的API实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">writeBytes</span><span class="params">(<span class="keyword">byte</span>[] src, <span class="keyword">int</span> srcIndex, <span class="keyword">int</span> length)</span> </span>&#123;</div><div class="line">    ensureWritable(length);</div><div class="line">    setBytes(writerIndex, src, srcIndex, length);</div><div class="line">    writerIndex += length;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>同样的<code>setBytes();</code>是由子类具体实现, 我们着重看一下<code>ensureWritable()</code>方法实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">ensureWritable</span><span class="params">(<span class="keyword">int</span> minWritableBytes)</span> </span>&#123;</div><div class="line">	<span class="comment">// 如果要写入数据的字节小于0的话, 则直接抛出异常</span></div><div class="line">    <span class="keyword">if</span> (minWritableBytes &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(</div><div class="line">                <span class="string">"minWritableBytes: %d (expected: &gt;= 0)"</span>, minWritableBytes));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">// minWritableBytes &lt;= capacity() - writerIndex, 要写入的字节数小于可写的字节数则直接返回</span></div><div class="line">    <span class="keyword">if</span> (minWritableBytes &lt;= writableBytes()) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (minWritableBytes &gt; maxCapacity - writerIndex) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(String.format(</div><div class="line">                <span class="string">"writerIndex(%d) + minWritableBytes(%d) exceeds maxCapacity(%d): %s"</span>,</div><div class="line">                writerIndex, minWritableBytes, maxCapacity, <span class="keyword">this</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Normalize the current capacity to the power of 2.</span></div><div class="line">    <span class="keyword">int</span> newCapacity = calculateNewCapacity(writerIndex + minWritableBytes);</div><div class="line"></div><div class="line">    <span class="comment">// Adjust to the new capacity.</span></div><div class="line">    capacity(newCapacity);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="ResourceLeakDetector"><a href="#ResourceLeakDetector" class="headerlink" title="ResourceLeakDetector"></a>ResourceLeakDetector</h3><p><code>ResourceLeakDetector</code>用于检测内存泄漏. 它被所有ByteBuf实例共享.</p>
<h3 id="SwappedByteBuf"><a href="#SwappedByteBuf" class="headerlink" title="SwappedByteBuf"></a>SwappedByteBuf</h3><h2 id="AbstractReferenceCountedByteBuf"><a href="#AbstractReferenceCountedByteBuf" class="headerlink" title="AbstractReferenceCountedByteBuf"></a>AbstractReferenceCountedByteBuf</h2><h2 id="UnPooledHeapByteBuf"><a href="#UnPooledHeapByteBuf" class="headerlink" title="UnPooledHeapByteBuf"></a>UnPooledHeapByteBuf</h2><p>不使用对象池的基于堆内存分配的字节缓冲区. 每次IO读写的时候都会创建一个新的UnPooledHeapByteBuf.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Netty/">Netty</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/20/JavaLibrary/Netty ByteBuf/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/11/20/JavaLibrary/Netty ByteBuf/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/19/nosql/Redis事务/" title="Redis事务" itemprop="url">Redis事务</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2015-11-18T16:00:00.000Z" itemprop="datePublished"> 發表於 2015-11-19</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="普通事务"><a href="#普通事务" class="headerlink" title="普通事务"></a>普通事务</h2><p>首先介绍普通事务<code>MULTI</code>，<code>EXEC</code>，<code>DISCARD</code>:</p>
<ul>
<li><code>MULTI</code>告诉 redis 服务器开启一个事务</li>
<li><code>EXEC</code>告诉 redis 开始执行事务</li>
<li><code>DISCARD</code>告诉 redis 取消事务</li>
</ul>
<p><code>MULTI</code>命令执行后, redis进入事务状态,redis会持续缓存某个客户端的命令(其他客户端处于饥饿状态).<br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/redis/redis-multi.png" alt=""><br>当redis接受到客户端的<code>EXEC</code>命令后会开始执行刚才缓存在事务队列里的任务. <code>DISCARD</code> 会将事务队列清空.<br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/redis/redis-tranactions.png" alt=""><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; MULTI</div><div class="line">OK</div><div class="line">redis 127.0.0.1:7006&gt; SET a ""redis 127.0.0.1:7006&gt; SET a ""</div><div class="line">QUEUED</div><div class="line">redis 127.0.0.1:7006&gt; SET a "a"</div><div class="line">QUEUED</div><div class="line">redis 127.0.0.1:7006&gt;  EXEC</div><div class="line">1) OK</div><div class="line">2) OK</div><div class="line">redis 127.0.0.1:7006&gt; SET b "b"</div><div class="line">OK</div><div class="line">redis 127.0.0.1:7006&gt; EXEC</div><div class="line">(error) ERR EXEC without MULTI</div><div class="line">redis 127.0.0.1:7006&gt; MULTI</div><div class="line">OK</div><div class="line">redis 127.0.0.1:7006&gt; SET n "n"</div><div class="line">QUEUED</div><div class="line">redis 127.0.0.1:7006&gt; EXEC</div><div class="line">1) OK</div><div class="line">redis 127.0.0.1:7006&gt; MULTI</div><div class="line">OK</div><div class="line">redis 127.0.0.1:7006&gt; SET c "c"</div><div class="line">QUEUED</div><div class="line">redis 127.0.0.1:7006&gt; DISCARD</div><div class="line">OK</div><div class="line">redis 127.0.0.1:7006&gt; GET a</div><div class="line">"a"</div><div class="line">redis 127.0.0.1:7006&gt; GET b</div><div class="line">"b"</div><div class="line">redis 127.0.0.1:7006&gt; Get c</div><div class="line">(error) ERR Operation against a key holding the wrong kind of value</div><div class="line">redis 127.0.0.1:7006&gt; GET n</div><div class="line">"n"</div><div class="line">redis 127.0.0.1:7006&gt;</div></pre></td></tr></table></figure></p>
<ol>
<li>使用<code>MULTI</code>命令开启事务</li>
<li>输入一个错误的命令,点击回车,redis并没有报错,说明这个命令确实是被缓存起来了没有执行</li>
<li>使用<code>SET</code>命令将a设置为”a”</li>
<li>然后执行事务,我们看到俩条事务都执行完了,但是第一条命令并没有报错</li>
<li>然后再次使用<code>SET</code>命令将b设置为”b”</li>
<li>再次执行事务, 并不成功,提示我们要开启事务,说明事务一旦执行完就自动退出了</li>
<li>再次开启事务,然后使用<code>SET</code>命令将n设置为”n”</li>
<li>退出事务</li>
<li>接下来我们依次使用<code>GET</code>命令获取值,但是n取不到,说明退出事务确实没有执行事务队列里的命令<br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/redis/redis_transaction.png" alt=""></li>
</ol>
<h2 id="watch机制"><a href="#watch机制" class="headerlink" title="watch机制"></a>watch机制</h2><p>下来我们来看一下redis的watch机制<br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/redis/watch1.png" alt=""><br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/redis/watch2.png" alt=""><br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/redis/watch3.png" alt=""><br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/redis/watch4.png" alt=""><br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/redis/redis_watched_keys.png" alt=""></p>
<h2 id="pipline机制"><a href="#pipline机制" class="headerlink" title="pipline机制"></a>pipline机制</h2><p>参考文章</p>
<ul>
<li><a href="http://redisbook.readthedocs.org/en/latest/feature/transaction.html" target="_blank" rel="external"></a></li>
<li><a href="http://ju.outofmemory.cn/entry/81786" target="_blank" rel="external"></a></li>
<li><a href="http://redisdoc.com/topic/transaction.html#id2" target="_blank" rel="external"></a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/NoSql/">NoSql</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/19/nosql/Redis事务/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/11/19/nosql/Redis事务/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/18/nosql/Memcache/" title="memcached" itemprop="url">memcached</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2015-11-17T16:00:00.000Z" itemprop="datePublished"> 發表於 2015-11-18</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>memcached是一个高性能内存对象缓存系统. 它基于libevent,可方便地拓展为任意大小, 而且对防止内存swap和使用非阻塞IO做了大量优化工作.</p>
<p>memcached内存分配：<br><img src="https://raw.githubusercontent.com/yu66/blog-website/images/memcached/20120314163538_438.png" alt=""><br>memcached默认情况下采用了名为Slab Allocator的机制分配、管理内存.</p>
<p>如果我们在启动memcached时没有指定<code>-m</code>参数的话, 那么memcached能使用的最大内存为默认的64M,但是memcached启动的时候并不会一次性就都分配出来,而是当发现memcached已被分配的内存不够用的时候才会进行申请. memcached申请内存时一次会申请一个Slab(默认为1M). 然后会将这一个Slab分成不同的Class, 每个Class内部都有N个大小相等的Chunk.每个chunk中都保存了一个item结构体、一对key value键值对.</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>Memcached依赖libevent,所以我们首先需要安装libevent<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wget http://jaist.dl.sourceforge.net/project/levent/libevent/libevent-2.0/libevent-2.0.22-stable.tar.gz</div><div class="line">tar -zxvf libevent-2.0.22-stable.tar.gz</div><div class="line">cd libevent-2.0.22-stable</div><div class="line">./configure --prefix=/usr &amp;&amp; make &amp;&amp; make install</div></pre></td></tr></table></figure></p>
<p>接下来安装Memcached<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wget http://memcached.org/latest</div><div class="line">tar -zxvf memcached-1.x.x.tar.gz</div><div class="line">cd memcached-1.x.x</div><div class="line">./configure --with-libevent=/usr &amp;&amp; make &amp;&amp; make test &amp;&amp; sudo make install</div></pre></td></tr></table></figure></p>
<h2 id="memcached命令选项"><a href="#memcached命令选项" class="headerlink" title="memcached命令选项"></a><code>memcached</code>命令选项</h2><p>网络相关</p>
<ul>
<li><code>-s &lt;file&gt;</code> : Unix socket path to listen on (disables network support).</li>
<li><code>-a &lt;perms&gt;</code> : 当通过s选项创建socket的时候,我们可以通过-a选项指定创建socket使用的权限(权限为八进制).</li>
<li><code>-l &lt;ip_addr&gt;</code> : 监听的主机地址. 默认是本机任何可用的地址.</li>
<li><code>-d</code> : 以后台进程方式运行memcached</li>
<li><code>-u &lt;username&gt;</code> : memcached不能以root用户运行，如果当前用户为root, 我们需要通过该参数指定用户为root</li>
<li><code>-c &lt;num&gt;</code> : 设置最大同时连接数.(默认是1024).</li>
<li><code>-C</code> : 关闭CAS. (每个对象都会减少8bytes大小).</li>
<li><code>-p &lt;num&gt;</code> : 设置监听TCP端口号, 默认是11211.</li>
<li><code>-P</code> : 设置pid存储文件.</li>
<li><code>-U &lt;num&gt;</code> : 设置监听UDP端口号, 默认是11211, 0 表示关闭UDP监听.</li>
<li><code>-r</code> : 将最大的核心文件大小限制提升到允许的最大值.</li>
<li><code>-v</code> : 设置为verbose 同时会输出发生的errors 和warnings.</li>
<li><code>-i</code> : 打印memcached 和libevent 授权.</li>
<li><code>-R &lt;num&gt;</code> : 这个选项是设置服务器可以处理一个独立客户端连接顺序请求的数量,以防止产生其他客户端饥饿的情况. 一旦设置了这个值当服务器处理一个连接超过20个(默认值)请求之后,就会尝试处理其他的连接请求.</li>
</ul>
<p>内存相关</p>
<ul>
<li><code>-m &lt;num&gt;</code> : 设置对象存储能使用的最大内存(单位是MB,默认是64M)</li>
<li><code>-M</code> : 关闭对象存储所需内存超过最大内存时,自动删除缓存对象的功能. 如果memcached的配置内存达到最大值就不可再存储新的对象.</li>
<li><code>-f &lt;factor&gt;</code> : Class的成长因子(默认是1.25). 也就是说如果Class1是100B,那么Class2就是125B.</li>
<li><code>-n &lt;size&gt;</code> : key, value, and flags分配到的最小字节数(默认是48字节). 如果你的键值对的值都很小,你可以调低这个值来达到更高的性能. 如果你的成长因子比较大,那么你可以调高这个值,提升命中率.</li>
<li><code>-t &lt;threads&gt;</code> : 处理请求的线程数(默认是4). 这个选项只有memcached被编译的时候指定了线程开启才有用.</li>
<li><code>-k</code> : 锁定所有的分页内存. 在巨大的缓存系统中,使用这个选项是非常危险的,使用的使用要参考README文件和memcached homepage进行配置.</li>
<li><code>-L</code> : 尝试使用尽可能使用到的内存叶. 增加内存叶大小可以减少TLB未命中和提供性能. 为了可以从OS获得更大的内存页,memcached会在一个巨大的chunk上分配所有的item</li>
<li><code>-I &lt;size&gt;</code> : 指定slab page大小(默认是1mb,最小是1k, 最大是128m). 改变这个值会增加每个item大小的值.  使用-vv来查看更改后的值</li>
<li><code>-F</code> : 关闭<code>flush_all</code>命令.</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">memcached  -d -p 10021 -l 10.234.10.12 -u root -c 1024  -P ./memcached1.pid</div></pre></td></tr></table></figure>
<h2 id="java使用"><a href="#java使用" class="headerlink" title="java使用"></a>java使用</h2><p>我们使用spymemcached作为java客户端连接memcached. 在Maven项目中添加以下依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.spy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spymemcached<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>然后连接memcached<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MemcachedClient client = <span class="keyword">new</span> MemcachedClient(<span class="keyword">new</span> InetSocketAddress(<span class="string">"10.234.10.12"</span>, <span class="number">10021</span>));</div></pre></td></tr></table></figure></p>
<p>通过这一行我们就成功的连接上了memcached.然后我们就可以使用spymemcached提供的大量api来操作memcached</p>
<h2 id="memcached信息统计"><a href="#memcached信息统计" class="headerlink" title="memcached信息统计"></a>memcached信息统计</h2><p>我们可以使用telnet命令直接连接memcached<code>telnet 127.0.0.1 10021</code>,然后输入下列命令查看相关信息</p>
<h3 id="stats"><a href="#stats" class="headerlink" title="stats"></a>stats</h3><p>统计memcached的各种信息</p>
<ul>
<li><code>STAT pid 20401</code> memcache服务器的进程ID</li>
<li><code>STAT uptime 47</code>  服务器已经运行的秒数</li>
<li><code>STAT time 1447835371</code> 服务器当前的unix时间戳</li>
<li><code>STAT version 1.4.24</code>  memcache版本</li>
<li><code>STAT libevent 2.0.22-stable</code> libevent版本</li>
<li><code>STAT pointer_size 64</code> 当前操作系统的指针大小（32位系统一般是32bit）</li>
<li><code>STAT rusage_user 0.002999</code> 进程的累计用户时间</li>
<li><code>STAT rusage_system 0.001999</code> 进程的累计系统时间</li>
<li><code>STAT curr_connections 10</code> 当前打开着的连接数</li>
<li><code>STAT total_connections 11</code> 从服务器启动以后曾经打开过的连接数</li>
<li><code>STAT connection_structures 11</code> 服务器分配的连接构造数</li>
<li><code>STAT reserved_fds 20</code></li>
<li><code>STAT cmd_get 0</code>  get命令（获取）总请求次数</li>
<li><code>STAT cmd_set 0</code>  set命令（保存）总请求次数</li>
<li><code>STAT cmd_flush 0</code></li>
<li><code>STAT cmd_touch 0</code></li>
<li><code>STAT get_hits 0</code>  总命中次数</li>
<li><code>STAT get_misses 0</code> 总未命中次数</li>
<li><code>STAT delete_misses 0</code> delete命令未命中次数</li>
<li><code>STAT delete_hits 0</code>  delete命令命中次数</li>
<li><code>STAT incr_misses 0</code>  incr命令未命中次数</li>
<li><code>STAT incr_hits 0</code>  incr命令命中次数</li>
<li><code>STAT decr_misses 0</code>  decr命令未命中次数</li>
<li><code>STAT decr_hits 0</code>  decr命令命中次数</li>
<li><code>STAT cas_misses 0</code>  cas命令未命中次数</li>
<li><code>STAT cas_hits 0</code>  cas命令命中次数</li>
<li><code>STAT cas_badval 0</code></li>
<li><code>STAT touch_hits 0</code>  touch命令命中次数</li>
<li><code>STAT touch_misses 0</code>  touch命令未命中次数</li>
<li><code>STAT auth_cmds 0</code></li>
<li><code>STAT auth_errors 0</code></li>
<li><code>STAT bytes_read 7</code> 总读取字节数（请求字节数）</li>
<li><code>STAT bytes_written 0</code> 总发送字节数（结果字节数）</li>
<li><code>STAT limit_maxbytes 67108864</code>   分配给memcache的内存大小（字节）</li>
<li><code>STAT accepting_conns 1</code></li>
<li><code>STAT listen_disabled_num 0</code></li>
<li><code>STAT threads 4</code>     当前线程数</li>
<li><code>STAT conn_yields 0</code></li>
<li><code>STAT hash_power_level 16</code>  hash等级</li>
<li><code>STAT hash_bytes 524288</code>  hash字节数</li>
<li><code>STAT hash_is_expanding 0</code>    </li>
<li><code>STAT malloc_fails 0</code>  分配失败次数</li>
<li><code>STAT bytes 0</code>   当前服务器存储items占用的字节数</li>
<li><code>STAT curr_items 0</code> 服务器当前存储的items数量</li>
<li><code>STAT total_items 0</code> 从服务器启动以后存储的items总数量</li>
<li><code>STAT expired_unfetched 0</code></li>
<li><code>STAT evicted_unfetched 0</code></li>
<li><code>STAT evictions 0</code> 为获取空闲内存而删除的items数（分配给memcache的空间用满后需</li>
<li><code>STAT reclaimed 0</code></li>
<li><code>STAT crawler_reclaimed 0</code></li>
<li><code>STAT crawler_items_checked 0</code></li>
<li><code>STAT lrutail_reflocked 0</code></li>
</ul>
<p>我们也可以使用java获取这些信息<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">MemcachedClient client = <span class="keyword">new</span> MemcachedClient(<span class="keyword">new</span> InetSocketAddress(<span class="string">"10.234.10.12"</span>, <span class="number">10021</span>));</div><div class="line">client.getStats().entrySet().stream().forEach(entry -&gt; &#123;</div><div class="line">	System.out.println(<span class="string">"Node : "</span> + entry.getKey());</div><div class="line">	entry.getValue().entrySet().stream().forEach(value -&gt; &#123;</div><div class="line">		System.out.println(<span class="string">"    "</span> + value.getKey() + <span class="string">" : "</span> + value.getValue());</div><div class="line">	&#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h3 id="stats-reset"><a href="#stats-reset" class="headerlink" title="stats reset"></a>stats reset</h3><p>重新统计数据</p>
<h3 id="stats-slabs"><a href="#stats-slabs" class="headerlink" title="stats slabs"></a>stats slabs</h3><p>显示slabs信息，可以详细看到数据的分段存储情况</p>
<ul>
<li><code>STAT active_slabs 0</code></li>
<li><code>STAT total_malloced 0</code></li>
</ul>
<h3 id="stats-items"><a href="#stats-items" class="headerlink" title="stats items"></a>stats items</h3><p>显示slab中的item数目</p>
<h3 id="stats-cachedump-1-0"><a href="#stats-cachedump-1-0" class="headerlink" title="stats cachedump 1 0"></a>stats cachedump 1 0</h3><p>列出slabs第一段里存的KEY值</p>
<h3 id="STAT-evictions-0"><a href="#STAT-evictions-0" class="headerlink" title="STAT evictions 0"></a>STAT evictions 0</h3><p>表示要腾出新空间给新的item而移动的合法item数目</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/NoSql/">NoSql</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/18/nosql/Memcache/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/11/18/nosql/Memcache/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/16/nosql/Redis_SortedSet/" title="Redis SortedSet" itemprop="url">Redis SortedSet</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2015-11-15T16:00:00.000Z" itemprop="datePublished"> 發表於 2015-11-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <blockquote>
<p>在命令行中使用Redis客户端连接Redis服务器： <code>redis-cli -h 127.0.0.1 -p 7000</code></p>
</blockquote>
<h2 id="增加成员"><a href="#增加成员" class="headerlink" title="增加成员"></a>增加成员</h2><h3 id="ZADD"><a href="#ZADD" class="headerlink" title="ZADD"></a>ZADD</h3><p>语法：<code>ZADD key score member [[score member] [score member] ...]</code>.   </p>
<ul>
<li><code>ZADD</code> redis命令</li>
<li><code>key</code> 有序集合名</li>
<li><code>score</code>  值 (可以是整数值或双精度浮点数)</li>
<li><code>member</code> 键</li>
</ul>
<p>这个命令也就是将键值对(member score)插入到有序集合key中. 如果集合不存在就创建一个集合,如果键已经存在就代替原来的值.</p>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; ZADD test1 10 a</div><div class="line">(integer) 1</div></pre></td></tr></table></figure></p>
<h2 id="修改成员"><a href="#修改成员" class="headerlink" title="修改成员"></a>修改成员</h2><h3 id="ZINCRBY"><a href="#ZINCRBY" class="headerlink" title="ZINCRBY"></a>ZINCRBY</h3><p>语法<code>ZINCRBY key increment member</code></p>
<ul>
<li><code>ZINCRBY</code> redis命令</li>
<li><code>key</code> 有序集合名</li>
<li><code>increment</code>  score值的增量</li>
<li><code>member</code>  针对哪个成员进行改变</li>
</ul>
<p>这个命令就是对某个成员进行增加或者减少(通过负数实现). (member 成员的新 score 值,以字符串形式表示)</p>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; zadd test1 23 t</div><div class="line">(integer) 1</div><div class="line">redis 127.0.0.1:7006&gt; ZINCRBY test1 10 t</div><div class="line">"33"</div><div class="line">redis 127.0.0.1:7006&gt; zincrby test1 -20 t</div><div class="line">"13"</div></pre></td></tr></table></figure></p>
<h2 id="删除成员"><a href="#删除成员" class="headerlink" title="删除成员"></a>删除成员</h2><h3 id="ZREM"><a href="#ZREM" class="headerlink" title="ZREM"></a>ZREM</h3><p>语法<code>ZREM key member [member ...]</code></p>
<ul>
<li><code>ZREM</code> redis命令</li>
<li><code>key</code> 有序集合名</li>
<li><code>member</code> 成员名</li>
</ul>
<p>移除有序集 key 中的一个或多个成员,不存在的成员将被忽略.</p>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; zcard test1</div><div class="line">(integer) 7</div><div class="line">redis 127.0.0.1:7006&gt; zrem test1 a</div><div class="line">(integer) 1</div><div class="line">redis 127.0.0.1:7006&gt; zcard test1</div><div class="line">(integer) 6</div></pre></td></tr></table></figure></p>
<h3 id="ZREMRANGEBYRANK"><a href="#ZREMRANGEBYRANK" class="headerlink" title="ZREMRANGEBYRANK"></a>ZREMRANGEBYRANK</h3><p>语法<code>ZREMRANGEBYRANK key start stop</code></p>
<ul>
<li><code>ZREMRANGEBYRANK</code> redis命令</li>
<li><code>key</code> 有序集合名</li>
<li><code>start</code> 开始索引从0开始(默认闭区间,使用<code>(</code>表示开区间)</li>
<li><code>stop</code>  结束索引从0开始(默认闭区间,使用<code>(</code>表示开区间)</li>
</ul>
<p>移除有序集 key 中,指定排名(rank)区间内的所有成员.</p>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; ZREMRANGEBYRANK test1 1 2 # 将第二名和第三名移除</div><div class="line">(integer) 2</div></pre></td></tr></table></figure></p>
<h3 id="ZREMRANGEBYSCORE"><a href="#ZREMRANGEBYSCORE" class="headerlink" title="ZREMRANGEBYSCORE"></a>ZREMRANGEBYSCORE</h3><p>语法<code>ZREMRANGEBYSCORE key min max</code></p>
<ul>
<li><code>ZREMRANGEBYSCORE</code> redis命令</li>
<li><code>key</code> 有序集合名</li>
<li><code>min</code>最小值(默认闭区间,使用<code>(</code>表示开区间)</li>
<li><code>max</code> 最大值(默认闭区间,使用<code>(</code>表示开区间)</li>
</ul>
<p>将集合key里的score值区间为[min,max]的成员删除</p>
<blockquote>
<p><code>+</code>和<code>-</code>在 min 参数以及 max 参数中表示正无限和负无限.</p>
</blockquote>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; ZREMRANGEBYSCORE test1 10 20</div><div class="line">(integer) 1</div></pre></td></tr></table></figure></p>
<h2 id="合并集合"><a href="#合并集合" class="headerlink" title="合并集合"></a>合并集合</h2><h3 id="ZUNIONSTORE"><a href="#ZUNIONSTORE" class="headerlink" title="ZUNIONSTORE"></a>ZUNIONSTORE</h3><p>语法<code>ZUNIONSTORE destination numkeys key [key ...] [WEIGHTS weight [weight ...]] [AGGREGATE SUM|MIN|MAX]</code></p>
<ul>
<li><code>ZUNIONSTORE</code> redis命令</li>
<li><code>destination</code> 有序集合名</li>
<li><code>numkeys</code>  需要合并的集合数量</li>
<li><code>key</code>  需要合并的集合</li>
<li><code>WEIGHTS</code>  指定该值,则在合并的时候,对每个score值都乘以该元素</li>
<li><code>AGGREGATE</code> 指定并集的结果集的聚合方式</li>
</ul>
<p>对多个集合采取并集</p>
<blockquote>
<p>AGGREGATE有三种值：A. SUM,将相同的成员的score相加. MIN,取相同成员的最小score值. MAX,取相同成员的最大score值</p>
</blockquote>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; zadd a 10 a1 20 a2 30 a3 40 a4 50 a5</div><div class="line">(integer) 5</div><div class="line">redis 127.0.0.1:7006&gt; zadd b 11 b1 12 b2 13 b3 14 b4 15 b5</div><div class="line">(integer) 5</div><div class="line">redis 127.0.0.1:7006&gt; ZUNIONSTORE c 2 a b</div><div class="line">(integer) 10</div><div class="line">redis 127.0.0.1:7006&gt; ZRANGE c 0 -1 WITHSCORES</div><div class="line"> 1) "a1"</div><div class="line"> 2) "10"</div><div class="line"> 3) "b1"</div><div class="line"> 4) "11"</div><div class="line"> 5) "b2"</div><div class="line"> 6) "12"</div><div class="line"> 7) "b3"</div><div class="line"> 8) "13"</div><div class="line"> 9) "b4"</div><div class="line">10) "14"</div><div class="line">11) "b5"</div><div class="line">12) "15"</div><div class="line">13) "a2"</div><div class="line">14) "20"</div><div class="line">15) "a3"</div><div class="line">16) "30"</div><div class="line">17) "a4"</div><div class="line">18) "40"</div><div class="line">19) "a5"</div><div class="line">20) "50"</div><div class="line">redis 127.0.0.1:7006&gt; ZUNIONSTORE e 2 c a</div><div class="line">(integer) 10</div><div class="line">redis 127.0.0.1:7006&gt; ZRANGE e  0 -1 WITHSCORES</div><div class="line"> 1) "b1"</div><div class="line"> 2) "11"</div><div class="line"> 3) "b2"</div><div class="line"> 4) "12"</div><div class="line"> 5) "b3"</div><div class="line"> 6) "13"</div><div class="line"> 7) "b4"</div><div class="line"> 8) "14"</div><div class="line"> 9) "b5"</div><div class="line">10) "15"</div><div class="line">11) "a1"</div><div class="line">12) "20"</div><div class="line">13) "a2"</div><div class="line">14) "40"</div><div class="line">15) "a3"</div><div class="line">16) "60"</div><div class="line">17) "a4"</div><div class="line">18) "80"</div><div class="line">19) "a5"</div><div class="line">20) "100"</div></pre></td></tr></table></figure></p>
<h3 id="ZINTERSTORE"><a href="#ZINTERSTORE" class="headerlink" title="ZINTERSTORE"></a>ZINTERSTORE</h3><p>语法<code>ZINTERSTORE destination numkeys key [key ...] [WEIGHTS weight [weight ...]] [AGGREGATE SUM|MIN|MAX]</code></p>
<ul>
<li><code>ZINTERSTORE</code> redis命令</li>
<li><code>destination</code> 有序集合名</li>
<li><code>numkeys</code>  需要合并的集合数量</li>
<li><code>key</code>  需要合并的集合</li>
<li><code>WEIGHTS</code>  指定该值,则在合并的时候,对每个score值都乘以该元素</li>
<li><code>AGGREGATE</code> 指定并集的结果集的聚合方式</li>
</ul>
<p>对多个集合采取交集</p>
<blockquote>
<p>AGGREGATE有三种值：A. SUM,将相同的成员的score相加. MIN,取相同成员的最小score值. MAX,取相同成员的最大score值</p>
</blockquote>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; zadd h 1 a1 2 a2</div><div class="line">(integer) 2</div><div class="line">redis 127.0.0.1:7006&gt; ZINTERSTORE j 2 e h</div><div class="line">(integer) 2</div><div class="line">redis 127.0.0.1:7006&gt; zrange j 0 -1 WITHSCORES</div><div class="line">1) "a1"</div><div class="line">2) "21"</div><div class="line">3) "a2"</div><div class="line">4) "42"</div><div class="line">redis 127.0.0.1:7006&gt;</div></pre></td></tr></table></figure></p>
<h2 id="获取集合数量"><a href="#获取集合数量" class="headerlink" title="获取集合数量"></a>获取集合数量</h2><h3 id="ZCARD"><a href="#ZCARD" class="headerlink" title="ZCARD"></a>ZCARD</h3><p>语法<code>ZCARD key</code></p>
<ul>
<li><code>ZCARD</code> redis命令</li>
<li><code>key</code> 有序集合名</li>
</ul>
<p>获得集合大小</p>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; ZCARD test1</div><div class="line">(integer) 2</div></pre></td></tr></table></figure></p>
<h3 id="ZCOUNT"><a href="#ZCOUNT" class="headerlink" title="ZCOUNT"></a>ZCOUNT</h3><p>语法<code>ZCOUNT key min max</code></p>
<ul>
<li><code>ZCOUNT</code> redis命令</li>
<li><code>key</code> 有序集合名</li>
<li><code>min</code>最小值(默认闭区间,使用<code>(</code>表示开区间)</li>
<li><code>max</code> 最大值(默认闭区间,使用<code>(</code>表示开区间)<br>这个命令就是统计score 值在 min 和 max 之间(默认包括 score 值等于 min 或 max )的成员的数量<blockquote>
<p><code>+</code>和<code>-</code>在 min 参数以及 max 参数中表示正无限和负无限.</p>
</blockquote>
</li>
</ul>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; ZCOUNT test 10 50</div><div class="line">(integer) 6</div></pre></td></tr></table></figure></p>
<h2 id="获取集合列表"><a href="#获取集合列表" class="headerlink" title="获取集合列表"></a>获取集合列表</h2><h3 id="ZRANGE"><a href="#ZRANGE" class="headerlink" title="ZRANGE"></a>ZRANGE</h3><p>语法<code>ZRANGE key start stop [WITHSCORES]</code></p>
<ul>
<li><code>ZRANGE</code> redis命令</li>
<li><code>key</code> 有序集合名</li>
<li><code>start</code> 开始索引从0开始(默认闭区间,使用<code>(</code>表示开区间)</li>
<li><code>stop</code>  结束索引从0开始(默认闭区间,使用<code>(</code>表示开区间)</li>
<li><code>WITHSCORES</code>  同时也返回成员对应的值</li>
</ul>
<p>返回有序集key中指定区间内的成员,得到的成员是递增(从小到大)排序的.</p>
<blockquote>
<p>索引从0开始, 如果索引为负数则代表从倒序,即-1代表最后一个,-2代表倒数第二个. ( <code>ZRANGE test1 0 -1 WITHSCORES</code>显示整个有序集成员)</p>
</blockquote>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; zrange test1 0 3</div><div class="line">1) "a"</div><div class="line">2) "c"</div><div class="line">3) "t"</div><div class="line">4) "b"</div><div class="line">redis 127.0.0.1:7006&gt; zrange test1 0 3 WITHSCORES</div><div class="line">1) "a"</div><div class="line">2) "10"</div><div class="line">3) "c"</div><div class="line">4) "12"</div><div class="line">5) "t"</div><div class="line">6) "13"</div><div class="line">7) "b"</div><div class="line">8) "20"</div></pre></td></tr></table></figure></p>
<h3 id="ZREVRANGE"><a href="#ZREVRANGE" class="headerlink" title="ZREVRANGE"></a>ZREVRANGE</h3><p>语法<code>ZREVRANGE key start stop [WITHSCORES]</code></p>
<ul>
<li><code>ZREVRANGE</code> redis命令</li>
<li><code>key</code> 有序集合名</li>
<li><code>start</code> 开始索引从0开始(默认闭区间,使用<code>(</code>表示开区间)</li>
<li><code>stop</code>  结束索引从0开始(默认闭区间,使用<code>(</code>表示开区间)</li>
<li><code>WITHSCORES</code> 输出score值</li>
</ul>
<p>和<code>ZRANGE</code>命令不同的是它是从按 score 值递减(从大到小)来排列,其他和ZRANGE命令一样</p>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; ZREVRANGE test1 1 100</div><div class="line">1) "d"</div><div class="line">2) "f"</div></pre></td></tr></table></figure></p>
<h3 id="ZRANGEBYSCORE"><a href="#ZRANGEBYSCORE" class="headerlink" title="ZRANGEBYSCORE"></a>ZRANGEBYSCORE</h3><p>语法<code>ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT offset count]</code></p>
<ul>
<li><code>ZRANGEBYSCORE</code> redis命令</li>
<li><code>key</code> 有序集合名</li>
<li><code>min</code>最小值(默认闭区间,使用<code>(</code>表示开区间)</li>
<li><code>max</code> 最大值(默认闭区间,使用<code>(</code>表示开区间)</li>
<li><code>WITHSCORES</code> 输出score值</li>
<li><code>LIMIT offset count</code></li>
</ul>
<p>返回有序集key中,score值介于 [min, max]之间(闭区间)的成员,按 score 值递增(从小到大)次序排列</p>
<blockquote>
<p><code>+</code>和<code>-</code>在 min 参数以及 max 参数中表示正无限和负无限.</p>
</blockquote>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; ZRANGEBYSCORE test1 10 56 WITHSCORES	# 闭区间</div><div class="line"> 1) "a"</div><div class="line"> 2) "10"</div><div class="line"> 3) "c"</div><div class="line"> 4) "12"</div><div class="line"> 5) "t"</div><div class="line"> 6) "13"</div><div class="line"> 7) "b"</div><div class="line"> 8) "20"</div><div class="line"> 9) "f"</div><div class="line">10) "42"</div><div class="line">11) "d"</div><div class="line">12) "56"</div><div class="line">redis 127.0.0.1:7006&gt; ZRANGEBYSCORE test1 (10 (56 WITHSCORES # 开区间</div><div class="line">1) "c"</div><div class="line">2) "12"</div><div class="line">3) "t"</div><div class="line">4) "13"</div><div class="line">5) "b"</div><div class="line">6) "20"</div><div class="line">7) "f"</div><div class="line">8) "42"</div><div class="line">redis 127.0.0.1:7006&gt; ZRANGEBYSCORE test1 10 56 WITHSCORES LIMIT 0 3 # 从第一个成员开始选择三个成员</div><div class="line">1) "a"</div><div class="line">2) "10"</div><div class="line">3) "c"</div><div class="line">4) "12"</div><div class="line">5) "t"</div><div class="line">6) "13"</div></pre></td></tr></table></figure></p>
<h3 id="ZREVRANGEBYSCORE"><a href="#ZREVRANGEBYSCORE" class="headerlink" title="ZREVRANGEBYSCORE"></a>ZREVRANGEBYSCORE</h3><p>语法<code>ZREVRANGEBYSCORE key max min [WITHSCORES] [LIMIT offset count]</code></p>
<ul>
<li><code>ZREVRANGEBYSCORE</code> redis命令</li>
<li><code>key</code> 有序集合名</li>
<li><code>min</code>最小值(默认闭区间,使用<code>(</code>表示开区间)</li>
<li><code>max</code> 最大值(默认闭区间,使用<code>(</code>表示开区间)</li>
<li><code>WITHSCORES</code> 输出score值</li>
<li><code>LIMIT offset count</code>  </li>
</ul>
<p>除了成员按 score 值递减的次序排列这一点外, ZREVRANGEBYSCORE 命令的其他方面和 ZRANGEBYSCORE 命令一样.</p>
<blockquote>
<p><code>+</code>和<code>-</code>在 min 参数以及 max 参数中表示正无限和负无限.</p>
</blockquote>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; ZREVRANGE test1 1 100 WITHSCORES</div><div class="line"> 1) "f"</div><div class="line"> 2) "42"</div><div class="line"> 3) "d"</div><div class="line"> 4) "40"</div><div class="line"> 5) "c"</div><div class="line"> 6) "30"</div><div class="line"> 7) "b"</div><div class="line"> 8) "20"</div><div class="line"> 9) "a"</div><div class="line">10) "10"</div></pre></td></tr></table></figure></p>
<h3 id="ZRANGEBYLEX"><a href="#ZRANGEBYLEX" class="headerlink" title="ZRANGEBYLEX"></a>ZRANGEBYLEX</h3><p>语法<code>ZRANGEBYLEX key min max [LIMIT offset count]</code></p>
<ul>
<li><code>ZRANGEBYLEX</code> redis命令</li>
<li><code>key</code> 有序集合名</li>
<li><code>min</code>最小值(默认闭区间,使用<code>(</code>表示开区间)</li>
<li><code>max</code> 最大值(默认闭区间,使用<code>(</code>表示开区间)</li>
</ul>
<p>根据成员进行排序而不是根据score值排序,然后返回[min, max]区间内的成员</p>
<blockquote>
<p><code>+</code>和<code>-</code>在 min 参数以及 max 参数中表示正无限和负无限.</p>
</blockquote>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; ZRANGEBYLEX test1 10 30</div></pre></td></tr></table></figure></p>
<h2 id="查询某个成员"><a href="#查询某个成员" class="headerlink" title="查询某个成员"></a>查询某个成员</h2><h3 id="ZRANK"><a href="#ZRANK" class="headerlink" title="ZRANK"></a>ZRANK</h3><p>语法<code>ZRANK key member</code></p>
<ul>
<li><code>ZRANK</code> redis命令</li>
<li><code>key</code> 有序集合名</li>
<li><code>member</code>  成员值</li>
</ul>
<p>返回有序集 key 中成员 member 的排名.其中有序集成员按 score 值递增(从小到大)顺序排列.（排名从0开始）</p>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; ZRANK test1 d</div><div class="line">(integer) 5</div></pre></td></tr></table></figure></p>
<h3 id="ZREVRANK"><a href="#ZREVRANK" class="headerlink" title="ZREVRANK"></a>ZREVRANK</h3><p>语法<code>ZREVRANK key member</code></p>
<ul>
<li><code>ZREVRANK</code> redis命令</li>
<li><code>key</code> 有序集合名</li>
<li><code>member</code>  成员值<br>除了成员按 score 值递减的次序排列这一点外, ZREVRANK 命令的其他方面和 ZRANK 命令一样.</li>
</ul>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; ZREVRANK test1 c</div><div class="line">(integer) 3</div></pre></td></tr></table></figure></p>
<h3 id="ZSCORE"><a href="#ZSCORE" class="headerlink" title="ZSCORE"></a>ZSCORE</h3><p>语法<code>ZSCORE key member</code></p>
<ul>
<li><code>ZSCORE</code> redis命令</li>
<li><code>key</code> 有序集合名</li>
<li><code>member</code> 成员</li>
</ul>
<p>返回有序集 key 中,成员 member 的 score 值.</p>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:7006&gt; ZSCORE test1 a</div><div class="line">"10"</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/NoSql/">NoSql</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/16/nosql/Redis_SortedSet/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/11/16/nosql/Redis_SortedSet/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/15/算法/自旋锁/" title="自旋锁" itemprop="url">自旋锁</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2015-10-14T16:00:00.000Z" itemprop="datePublished"> 發表於 2015-10-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="自旋锁spinlock"><a href="#自旋锁spinlock" class="headerlink" title="自旋锁spinlock"></a>自旋锁spinlock</h1><p>自旋锁是指当一个线程尝试获取某个锁时，如果该锁已被其他线程占用，就一直循环检测锁是否被释放，而不是进入线程挂起或睡眠状态。<br>自旋锁适用于锁保护的临界区很小的情况，临界区很小的话，锁占用的时间就很短。<br>SimpleSpinLock里有一个owner属性持有锁当前拥有者的线程的引用，如果该引用为null，则表示锁未被占用，不为null则被占用。<br>这里用AtomicReference是为了使用它的原子性的compareAndSet方法（CAS操作），<br>解决了多线程并发操作导致数据不一致的问题，确保其他线程可以看到锁的真实状态。<br>缺点<br>CAS操作需要硬件的配合；<br>保证各个CPU的缓存（L1、L2、L3、跨CPU Socket、主存）的数据一致性，通讯开销很大，在多处理器系统上更严重；<br>没法保证公平性，不保证等待进程/线程按照FIFO顺序获得锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Spinlock</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> AtomicReference&lt;Thread&gt; owner = <span class="keyword">new</span> AtomicReference&lt;Thread&gt;();</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">		Thread currentThread = Thread.currentThread();</div><div class="line"></div><div class="line">		<span class="comment">// 如果锁未被占用，则设置当前线程为锁的拥有者</span></div><div class="line">		<span class="keyword">while</span> (owner.compareAndSet(<span class="keyword">null</span>, currentThread)) &#123;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</div><div class="line">		Thread currentThread = Thread.currentThread();</div><div class="line"></div><div class="line">		<span class="comment">// 只有锁的拥有者才能释放锁</span></div><div class="line">		owner.compareAndSet(currentThread, <span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="TicketSpinLock"><a href="#TicketSpinLock" class="headerlink" title="TicketSpinLock"></a>TicketSpinLock</h1><p>Ticket Lock 是为了解决上面的公平性问题，类似于现实中银行柜台的排队叫号：<br>锁拥有一个服务号，表示正在服务的线程，还有一个排队号；每个线程尝试获取锁之前先拿一个排队号，<br>然后不断轮询锁的当前服务号是否是自己的排队号，如果是，则表示自己拥有了锁，不是则继续轮询。</p>
<p>当线程释放锁时，将服务号加1，这样下一个线程看到这个变化，就退出自旋。<br>Ticket Lock 虽然解决了公平性的问题，但是多处理器系统上，每个进程/线程占用的处理器都在读写同一个变量serviceNum ，<br>每次读写操作都必须在多个处理器缓存之间进行缓存同步，这会导致繁重的系统总线和内存的流量，大大降低系统整体的性能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TicketSpinLock</span> </span>&#123;</div><div class="line">   <span class="keyword">private</span> AtomicInteger serviceNum = <span class="keyword">new</span> AtomicInteger(); <span class="comment">// 服务号</span></div><div class="line">   <span class="keyword">private</span> AtomicInteger ticketNum = <span class="keyword">new</span> AtomicInteger(); <span class="comment">// 排队号</span></div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">         <span class="comment">// 首先原子性地获得一个排队号</span></div><div class="line">         <span class="keyword">int</span> myTicketNum = ticketNum.getAndIncrement();</div><div class="line"></div><div class="line">              <span class="comment">// 只要当前服务号不是自己的就不断轮询</span></div><div class="line">       <span class="keyword">while</span> (serviceNum.get() != myTicketNum) &#123;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> myTicketNum;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">(<span class="keyword">int</span> myTicket)</span> </span>&#123;</div><div class="line">        <span class="comment">// 只有当前线程拥有者才能释放锁</span></div><div class="line">        <span class="keyword">int</span> next = myTicket + <span class="number">1</span>;</div><div class="line">        serviceNum.compareAndSet(myTicket, next);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="CLHSpinLock"><a href="#CLHSpinLock" class="headerlink" title="CLHSpinLock"></a>CLHSpinLock</h1><p>CLH锁也是一种基于链表的可扩展、高性能、公平的自旋锁，申请线程只在本地变量上自旋，<br>它不断轮询前驱的状态，如果发现前驱释放了锁就结束自旋。<br> <em><br>差异：
 </em><br> 从代码实现来看，CLH比MCS要简单得多。<br> 从自旋的条件来看，CLH是在本地变量上自旋，MCS是自旋在其他对象的属性。<br> 从链表队列来看，CLH的队列是隐式的，CLHNode并不实际持有下一个节点；MCS的队列是物理存在的。<br> CLH锁释放时只需要改变自己的属性，MCS锁释放则需要改变后继节点的属性。<br> 注意：这里实现的锁都是独占的，且不能重入的。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CLHSpinLock</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CLHNode</span> </span>&#123;</div><div class="line">		<span class="keyword">private</span> <span class="keyword">boolean</span> isLocked = <span class="keyword">true</span>; <span class="comment">// 默认是在等待锁</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</div><div class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> CLHNode tail;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicReferenceFieldUpdater&lt;CLHSpinLock, CLHNode&gt; UPDATER = AtomicReferenceFieldUpdater</div><div class="line">			.newUpdater(CLHSpinLock.class, CLHNode.class, <span class="string">"tail"</span>);</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">(CLHNode currentThread)</span> </span>&#123;</div><div class="line">		CLHNode preNode = UPDATER.getAndSet(<span class="keyword">this</span>, currentThread);</div><div class="line">		<span class="keyword">if</span> (preNode != <span class="keyword">null</span>) &#123;<span class="comment">// 已有线程占用了锁，进入自旋</span></div><div class="line">			<span class="keyword">while</span> (preNode.isLocked) &#123;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">(CLHNode currentThread)</span> </span>&#123;</div><div class="line">		<span class="comment">// 如果队列里只有当前线程，则释放对当前线程的引用（for GC）。</span></div><div class="line">		<span class="keyword">if</span> (!UPDATER.compareAndSet(<span class="keyword">this</span>, currentThread, <span class="keyword">null</span>)) &#123;</div><div class="line">			<span class="comment">// 还有后续线程</span></div><div class="line">			currentThread.isLocked = <span class="keyword">false</span>;<span class="comment">// 改变状态，让后续线程结束自旋</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="MCSSpinLock"><a href="#MCSSpinLock" class="headerlink" title="MCSSpinLock"></a>MCSSpinLock</h1><p>MCS Spinlock 是一种基于链表的可扩展、高性能、公平的自旋锁，申请线程只在本地变量上自旋，直接前驱负责通知其结束自旋，从而极大地减少了不必要的处理器缓存同步的次数，降低了总线和内存的开销。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MCSSpinLock</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MCSNode</span> </span>&#123;</div><div class="line">		<span class="keyword">volatile</span> MCSNode next;</div><div class="line">		<span class="keyword">volatile</span> <span class="keyword">boolean</span> isLocked = <span class="keyword">true</span>; <span class="comment">// 默认是在等待锁</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">volatile</span> MCSNode queue;<span class="comment">// 指向最后一个申请锁的MCSNode</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicReferenceFieldUpdater&lt;MCSSpinLock, MCSNode&gt; UPDATER = AtomicReferenceFieldUpdater</div><div class="line">			.newUpdater(MCSSpinLock.class, MCSNode.class, <span class="string">"queue"</span>);</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">(MCSNode currentThread)</span> </span>&#123;</div><div class="line">		MCSNode predecessor = UPDATER.getAndSet(<span class="keyword">this</span>, currentThread);<span class="comment">// step 1</span></div><div class="line">		<span class="keyword">if</span> (predecessor != <span class="keyword">null</span>) &#123;</div><div class="line">			predecessor.next = currentThread;<span class="comment">// step 2</span></div><div class="line"></div><div class="line">			<span class="keyword">while</span> (currentThread.isLocked) &#123;<span class="comment">// step 3</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">(MCSNode currentThread)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (UPDATER.get(<span class="keyword">this</span>) == currentThread) &#123;<span class="comment">// 锁拥有者进行释放锁才有意义</span></div><div class="line">			<span class="keyword">if</span> (currentThread.next == <span class="keyword">null</span>) &#123;<span class="comment">// 检查是否有人排在自己后面</span></div><div class="line">				<span class="keyword">if</span> (UPDATER.compareAndSet(<span class="keyword">this</span>, currentThread, <span class="keyword">null</span>)) &#123;<span class="comment">// step 4</span></div><div class="line">					<span class="comment">// compareAndSet返回true表示确实没有人排在自己后面</span></div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="comment">// 突然有人排在自己后面了，可能还不知道是谁，下面是等待后续者</span></div><div class="line">					<span class="comment">// 这里之所以要忙等是因为：step 1执行完后，step 2可能还没执行完</span></div><div class="line">					<span class="keyword">while</span> (currentThread.next == <span class="keyword">null</span>) &#123; <span class="comment">// step 5</span></div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			currentThread.next.isLocked = <span class="keyword">false</span>;</div><div class="line">			currentThread.next = <span class="keyword">null</span>;<span class="comment">// for GC</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/算法/">算法</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/10/15/算法/自旋锁/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/10/15/算法/自旋锁/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/12/算法/1_1_双线程锁/" title="双线程锁" itemprop="url">双线程锁</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2015-10-11T16:00:00.000Z" itemprop="datePublished"> 發表於 2015-10-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>所谓的双线程锁指的是这种锁适用于俩个线程运行的前提下. 下面我们依次给出了三种双线程锁解决方案：</p>
<p>双线程算法遵循以下俩点约定:</p>
<ol>
<li>线程标志为<code>0</code>或者<code>1</code>. 若当前线程调用者的标志为i,则另一方的调用者为1 - i</li>
<li>通过ThreadId.get()获取自己的标志</li>
</ol>
<ul>
<li>互斥: 俩个线程的临界区是没有重叠的,那么我们撑这俩个临界区是互斥的.</li>
<li>无死锁: 如果一个线程尝试获得一个锁,那么总会成功获得这个锁.</li>
<li>无饥饿：每一个尝试获得锁的线程都能成功. 当线程调用一个锁方法的时候,这个方法立即返回,我们便称这个锁是无饥饿的.</li>
</ul>
<h2 id="LockOne"><a href="#LockOne" class="headerlink" title="LockOne"></a>LockOne</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LockOne</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span>[] flags = <span class="keyword">new</span> <span class="keyword">boolean</span>[<span class="number">2</span>];</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> i = ThreadID.get();</div><div class="line">		<span class="keyword">int</span> j = <span class="number">1</span>- i;</div><div class="line">		flag[i] = <span class="keyword">true</span>;</div><div class="line">		<span class="keyword">while</span>(flag[j]) &#123;&#125;		</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> i = ThreadID.get();</div><div class="line">		flag[i] = <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>假设线程A对应flag[0]标志,线程B对应flag[1]标志,那么我们得出下面这一个流程:</p>
<ol>
<li><code>write_A(flag[0] = true) -&gt; read_A(flag[1] == false) -&gt; CS_A</code>这段话的意思是线程A将<code>flag[0]</code>的值置为true然后读取<code>flag[1]</code>的值,这个过程称为<code>CS_A</code>事件</li>
<li><code>write_B(flag[1] = true) -&gt; read_B(flag[0] == false) -&gt; CS_B</code>这段话的意思是线程B将<code>flag[1]</code>的值置为true然后读取<code>flag[0]</code>的值,这个过程称为<code>CS_B</code>事件</li>
</ol>
<blockquote>
<p>我们验证一下LockOne算法是否满足互斥<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">假设这个算法不是互斥的，也就是无法得到`CS_A -&gt; CS_B`且`CS_B -&gt; CS_A`.</div><div class="line">假设CS_A事件先于CS_B事件,那么有：</div><div class="line">write_A(flag[<span class="number">0</span>] = <span class="keyword">true</span>) -&gt; read_A(flag[<span class="number">1</span>] == <span class="keyword">false</span>) -&gt; write_B(flag[<span class="number">1</span>] = <span class="keyword">true</span>)</div><div class="line">=&gt;</div><div class="line">read_A(flag[<span class="number">1</span>] == <span class="keyword">false</span>) -&gt; write_B(flag[<span class="number">1</span>] = <span class="keyword">true</span>)</div><div class="line">可以看到这俩个事件是互斥的(它们的临界区是没有重叠的).</div></pre></td></tr></table></figure></p>
</blockquote>
<p>LockOne算法满足了互斥,但是如果俩个线程并发执行的话，就会进入死锁,同样我们来证明一下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">假设</div><div class="line">write_A(flag[<span class="number">0</span>] = <span class="keyword">true</span>) -&gt; write_B(flag[<span class="number">1</span>] = <span class="keyword">true</span>) -&gt; read_A(flag[<span class="number">1</span>] == <span class="keyword">false</span>) -&gt; read_B(flag[<span class="number">0</span>] == <span class="keyword">false</span>)</div><div class="line">那么`flag[<span class="number">0</span>]`和`flag[<span class="number">1</span>]`就都成为<span class="keyword">true</span>,也就是线程A和线程B进入了死锁.</div></pre></td></tr></table></figure></p>
<p>至于说为什么要使用<code>volatile</code>关键字,这是为了保证<code>flags</code>变量的内存可见性,因为Java会将这段代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span>(flag[j]) &#123;&#125;</div><div class="line">=&gt;</div><div class="line"><span class="keyword">if</span>(flag[j]) &#123;</div><div class="line">	<span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编译后的代码进行了提升优化,加上<code>volatile</code>关键字,就是告诉编译器,不要提升优化我的代码.</p>
<h2 id="LockTwo"><a href="#LockTwo" class="headerlink" title="LockTwo"></a>LockTwo</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LockTwo</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> lock;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> tid = ThreadID.get();</div><div class="line">		lock = tid;</div><div class="line">		<span class="keyword">while</span>(lock == tid)&#123;&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> tid = ThreadID.get();</div><div class="line">		lock = tid;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>同样我们假设有俩个事件发生</p>
<ol>
<li><code>write_A(lock = 1) -&gt; read_A(lock == 1) -&gt; CS_A</code></li>
<li><code>write_B(lock = 2) -&gt; read_B(lock == 2) -&gt; CS_B</code><br>很明显任何线程调用加锁操作都会造成死循环. 但是,如果锁调用交叉调用的话<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">write_A(lock = <span class="number">1</span>) -&gt; write_B(lock = <span class="number">2</span>) -&gt; read_A(lock == <span class="number">2</span>) -&gt; read_B(lock == <span class="number">2</span>)</div></pre></td></tr></table></figure>
</li>
</ol>
<p>直到A线程释放锁,B线程就一直在阻塞着. 因此只要这俩个事件并发执行就能完成互斥要求.</p>
<h2 id="Peterson"><a href="#Peterson" class="headerlink" title="Peterson"></a>Peterson</h2><p>算法实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Peterson</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> voliate <span class="keyword">boolean</span>[] flag = <span class="keyword">new</span> <span class="keyword">boolean</span>[<span class="number">2</span>];</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> lock;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> tid = ThreadID.get();</div><div class="line">		<span class="keyword">int</span> oid = <span class="number">1</span> - tid;</div><div class="line">		flag[oid] = <span class="keyword">true</span>;</div><div class="line">		lock = tid;</div><div class="line"></div><div class="line">		<span class="keyword">while</span>(flag[tid] &amp;&amp; lock == tid) &#123;&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> tid = ThreadID.get();</div><div class="line">		flag[tid] = <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>同样的我们看看俩个线程依次调用锁过程(假设线程A对应flag[0]标志,线程B对应flag[1]标志)：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">write_A(flag[<span class="number">1</span>] = <span class="keyword">true</span>) -&gt; write_A(lock = <span class="number">0</span>) -&gt; read_A(flag[<span class="number">0</span>] == <span class="keyword">false</span>) -&gt; read_A(lock == <span class="number">0</span>) -&gt; <span class="function">CS_A</span></div><div class="line"><span class="title">write_B</span><span class="params">(flag[<span class="number">0</span>] = <span class="keyword">true</span>)</span> -&gt; <span class="title">write_B</span><span class="params">(lock = <span class="number">1</span>)</span> -&gt; <span class="title">read_B</span><span class="params">(flag[<span class="number">1</span>] == <span class="keyword">true</span>)</span> -&gt; <span class="title">read_B</span><span class="params">(lock == <span class="number">1</span>)</span> -&gt; CS_B</div></pre></td></tr></table></figure></p>
<p>好，首先我们看一下</p>
<ul>
<li><code>CS_A</code>先于<code>CS_B</code>事件执行的话,那么B线程会进入锁等待.</li>
</ul>
<p><code>CS_A</code>和<code>CS_B</code>事件并发执行我们分俩种情况分析：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">write_A(flag[<span class="number">1</span>] = <span class="keyword">true</span>) -&gt; write_A(lock = <span class="number">0</span>) -&gt; write_B(flag[<span class="number">0</span>] = <span class="keyword">true</span>) -&gt; write_B(lock = <span class="number">1</span>) -&gt; read_A(flag[<span class="number">1</span>] == <span class="keyword">true</span>) -&gt; read_A(lock == <span class="number">0</span>) -&gt; read_B(flag[<span class="number">1</span>] == <span class="keyword">true</span>) -&gt; read_B(lock == <span class="number">1</span>)</div></pre></td></tr></table></figure></p>
<p>同样的A线程事件先于B线程事件,我们看到A线程并没有进入锁等待,而是B线程进入了锁等待<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">write_A(flag[<span class="number">1</span>] = <span class="keyword">true</span>) -&gt; write_A(lock = <span class="number">0</span>) -&gt; write_B(flag[<span class="number">0</span>] = <span class="keyword">true</span>) -&gt; write_B(lock = <span class="number">1</span>) -&gt; read_B(flag[<span class="number">1</span>] == <span class="keyword">true</span>) -&gt; read_B(lock == <span class="number">1</span>) -&gt; read_A(flag[<span class="number">1</span>] == <span class="keyword">true</span>) -&gt; read_A(lock == <span class="number">0</span>)</div></pre></td></tr></table></figure></p>
<p>我们发现这个锁算法仍然是有问题的.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/算法/">算法</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/10/12/算法/1_1_双线程锁/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/10/12/算法/1_1_双线程锁/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/08/数据库/Mysql 增删改查/" title="Mysql 增删改查" itemprop="url">Mysql 增删改查</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2015-10-07T16:00:00.000Z" itemprop="datePublished"> 發表於 2015-10-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql -h 主机地址 -u 用户名 －<span class="selector-tag">p</span> 用户密码 （注:u与root可以不用加空格，其它也一样）</div></pre></td></tr></table></figure>
<h2 id="用户操作"><a href="#用户操作" class="headerlink" title="用户操作"></a>用户操作</h2><p>创建用户<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'username'</span>@<span class="string">'host'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'password'</span>;</div></pre></td></tr></table></figure></p>
<p>授权:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">GRANT</span> <span class="keyword">privileges</span> <span class="keyword">ON</span> databasename.tablename <span class="keyword">TO</span> <span class="string">'username'</span>@<span class="string">'host'</span></div></pre></td></tr></table></figure></p>
<blockquote>
<p>privileges - 用户的操作权限,如SELECT,INSERT,UPDATE等.如果要授予所的权限则使用ALL;如果要授予该用户对所有数据库和表的相应操作权限则可用<em>表示, 如</em>.*. </p>
</blockquote>
<p>用以上命令授权的用户不能给其它用户授权,如果想让该用户可以授权,用以下命令:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">GRANT</span> <span class="keyword">privileges</span> <span class="keyword">ON</span> databasename.tablename <span class="keyword">TO</span> <span class="string">'username'</span>@<span class="string">'host'</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> <span class="keyword">OPTION</span>;</div></pre></td></tr></table></figure></p>
<p>设置与更改用户密码<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SET</span> <span class="keyword">PASSWORD</span> <span class="keyword">FOR</span> <span class="string">'username'</span>@<span class="string">'host'</span> = <span class="keyword">PASSWORD</span>(<span class="string">'newpassword'</span>);</div></pre></td></tr></table></figure></p>
<p>撤销用户权限<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">REVOKE</span> privilege <span class="keyword">ON</span> databasename.tablename <span class="keyword">FROM</span> <span class="string">'username'</span>@<span class="string">'host'</span>;</div></pre></td></tr></table></figure></p>
<p>删除用户<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> <span class="string">'username'</span>@<span class="string">'host'</span>;</div></pre></td></tr></table></figure></p>
<h2 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h2><ul>
<li>显示数据库：<code>SHOW databases</code>; </li>
<li>创建库：<code>CREATE DATABASE 库名</code>; </li>
<li>删除库：<code>DROP DATABASE 库名</code>; </li>
<li>使用库(选中库)：<code>USE 库名</code>; </li>
</ul>
<h2 id="表操作"><a href="#表操作" class="headerlink" title="表操作"></a>表操作</h2><ul>
<li>显示数据表：<code>SHOW tables</code></li>
<li>显示表结构：<code>DESC 表名</code></li>
<li>删除表：<code>DROP TABLE 表名</code>; </li>
<li>输入创建表的DDL语句 <code>SHOW CREATE TABLE 表名;</code></li>
<li>创建表：<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span>  </div><div class="line">    <span class="keyword">USER</span>  </div><div class="line">    (  </div><div class="line">        <span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </div><div class="line">        <span class="keyword">id</span> <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </div><div class="line">        stu_id <span class="built_in">INT</span>,  </div><div class="line">        phone <span class="built_in">VARCHAR</span>(<span class="number">20</span>),  </div><div class="line">        address <span class="built_in">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </div><div class="line">        age <span class="built_in">INT</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </div><div class="line">        PRIMARY <span class="keyword">KEY</span> (<span class="keyword">name</span>),  </div><div class="line">        <span class="keyword">CONSTRAINT</span> stu_id <span class="keyword">UNIQUE</span> (stu_id)  </div><div class="line">    )  </div><div class="line">    <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="表数据操作"><a href="#表数据操作" class="headerlink" title="表数据操作"></a>表数据操作</h3><ul>
<li>清空表数据<code>truncate table 表名;</code>. truncate删除后不记录mysql日志，不可以恢复数据。相当于保留mysql表的结构，重新创建了这个表，所有的状态都相当于新表。</li>
<li>清空表数据<code>delete from 表名</code>. delete的效果有点像将mysql表中所有记录一条一条删除到删完</li>
</ul>
<h3 id="修改表结构"><a href="#修改表结构" class="headerlink" title="修改表结构"></a>修改表结构</h3><ul>
<li>修改列名<code>alter table 表名称 change 字段名称 字段名称</code></li>
<li>修改表名<code>alter table 表名称 rename 表名称</code></li>
<li>修改某个表的字段类型及指定为空或非空<code>alter table 表名称 change 字段名称字段名称 字段类型 [null/not null];</code></li>
<li>修改某个表的字段名称及指定为空或非空<code>alter table 表名称 change 字段原名称字段新名称 字段类型 [null/not null];</code></li>
<li>增加一个字段(一列)<code>alter table table_name add column column_name type default value;</code> type指该字段的类型,value指该字段的默认值</li>
<li>更改一个字段名字(也可以改变类型和默认值)<code>alter table table_name change sorce_col_name dest_col_name type defaultvalue;</code> source_col_name指原来的字段名称,dest_col_name指改后的字段名称</li>
<li>改变一个字段的默认值<code>alter table table_name alter column_name set default value;</code></li>
<li>改变一个字段的数据类型<code>alter table table_name change column column_name column_name type;</code></li>
<li>向一个表中增加一个列做为主键<code>alter table table_name add column column_name type auto_increment PRIMARYKEY;</code></li>
<li>向一个表中增加一个列做为主键<code>alter table table_name add column column_name type auto_increment PRIMARYKEY;</code></li>
<li>删除字段<code>alter table form1 drop column 列名;</code></li>
</ul>
<h3 id="复制表"><a href="#复制表" class="headerlink" title="复制表"></a>复制表</h3><ul>
<li>含有主键等信息的完整表结构 <code>CREATE table 新表名 LIKE book;</code></li>
<li>只有表结构，没有主键等信息 `create table 新表名 select * from books;</li>
<li>将旧表中的数据灌入新表 <code>INSERT INTO 新表 SELECT * FROM 旧表；</code> 注：新表必须已经存在</li>
</ul>
<h3 id="导入导出数据库"><a href="#导入导出数据库" class="headerlink" title="导入导出数据库"></a>导入导出数据库</h3><ul>
<li>数据库某表的备份,在命令行中输入:<code>mysqldump -u root -p database_name table_name &gt; bak_file_name</code></li>
<li>导出数据<code>select_statment into outfile”dest_file”;</code></li>
<li>导入数据<code>load data infile”file_name” into table table_name;</code></li>
<li>将两个表里的数据拼接后插入到另一个表里<code>insert into tx select t1.com1,concat(t1.com2,t2.com1) from t1,t2;</code></li>
</ul>
<h3 id="查询表"><a href="#查询表" class="headerlink" title="查询表"></a>查询表</h3><p>mysql查询的五种子句 </p>
<h4 id="where-条件查询"><a href="#where-条件查询" class="headerlink" title="where(条件查询)"></a>where(条件查询)</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> <span class="keyword">id</span> &gt; <span class="number">100</span>;</div></pre></td></tr></table></figure>
<ul>
<li>数值谓词:<code>&gt;,=,&lt;,&lt;&gt;,!=,!&gt;,!&lt;,=&gt;,=&lt;</code></li>
<li>字符串谓词：<code>=，like</code></li>
<li>日期谓词：<code>=</code> (<code>SELECT * from t1 WHERE create_time = &#39;2011-04-08&#39;</code>)</li>
</ul>
<h4 id="having（筛选）"><a href="#having（筛选）" class="headerlink" title="having（筛选）"></a>having（筛选）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure>
<h4 id="group-by（分组）"><a href="#group-by（分组）" class="headerlink" title="group by（分组）"></a>group by（分组）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> player <span class="keyword">GROUP</span> <span class="keyword">BY</span> vip;</div></pre></td></tr></table></figure>
<h4 id="order-by（排序）"><a href="#order-by（排序）" class="headerlink" title="order by（排序）"></a>order by（排序）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> player <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span>;</div></pre></td></tr></table></figure>
<h4 id="limit（限制结果数）"><a href="#limit（限制结果数）" class="headerlink" title="limit（限制结果数）"></a>limit（限制结果数）</h4><p>查询前n条记录(默认从第0个开始)<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> player <span class="keyword">LIMIT</span> <span class="number">10</span>;</div></pre></td></tr></table></figure></p>
<p>从结果集中第1个开始查询, 查询10个<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> player <span class="keyword">LIMIT</span> <span class="number">1</span>, <span class="number">10</span>;</div></pre></td></tr></table></figure></p>
<h2 id="执行顺序"><a href="#执行顺序" class="headerlink" title="执行顺序"></a>执行顺序</h2><p>sql语句的执行顺序<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">(7)     <span class="keyword">SELECT</span> </div><div class="line">(<span class="number">8</span>)     <span class="keyword">DISTINCT</span> &lt;select_list&gt;</div><div class="line">(<span class="number">1</span>)     <span class="keyword">FROM</span> &lt;left_table&gt;</div><div class="line">(<span class="number">3</span>)     &lt;join_type&gt; <span class="keyword">JOIN</span> &lt;right_table&gt;</div><div class="line">(<span class="number">2</span>)     <span class="keyword">ON</span> &lt;join_condition&gt;</div><div class="line">(<span class="number">4</span>)     <span class="keyword">WHERE</span> &lt;where_condition&gt;</div><div class="line">(<span class="number">5</span>)     <span class="keyword">GROUP</span> <span class="keyword">BY</span> &lt;group_by_list&gt;</div><div class="line">(<span class="number">6</span>)     <span class="keyword">HAVING</span> &lt;having_condition&gt;</div><div class="line">(<span class="number">9</span>)     <span class="keyword">ORDER</span> <span class="keyword">BY</span> &lt;order_by_condition&gt;</div><div class="line">(<span class="number">10</span>)    <span class="keyword">LIMIT</span> &lt;limit_number&gt;</div></pre></td></tr></table></figure></p>
<p>也就是<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span>-&gt;<span class="keyword">ON</span>-&gt;<span class="keyword">JOIN</span>-&gt;<span class="keyword">WHERE</span>-&gt;<span class="keyword">GROUP</span> <span class="keyword">BY</span>-&gt;HAVING-&gt;<span class="keyword">SELECT</span>-&gt;<span class="keyword">DISTINCT</span>-&gt;<span class="keyword">ORDER</span> <span class="keyword">BY</span>-&gt;LIMIT</div></pre></td></tr></table></figure></p>
<h2 id="多表查询"><a href="#多表查询" class="headerlink" title="多表查询"></a>多表查询</h2><ul>
<li><code>SELECT * FROM a, b WHERE a.</code>id<code>=b.</code>id<code>;</code></li>
<li><code>SELECT * FROM a INNER JOIN b ON a.</code>id<code>=b.</code>id<code>;</code></li>
<li><code>SELECT * FROM a FULL JOIN b ON a.</code>id<code>=b.</code>id<code>;</code></li>
<li><code>SELECT * FROM a LEFT JOIN b ON a.</code>id<code>=b.</code>id<code>;</code></li>
<li><code>SELECT * FROM a RIGHT JOIN b ON a.</code>id<code>=b.</code>id<code>;</code></li>
<li><p><code>SELECT * FROM a CROSS JOIN b ON a.</code>id<code>=b.</code>id<code>;</code></p>
</li>
<li><p><code>SELECT * FROM a INNER JOIN b USING(id);</code></p>
</li>
<li><code>SELECT * FROM a FULL JOIN b USING(id);</code></li>
<li><code>SELECT * FROM a LEFT JOIN b USING(id);</code></li>
<li><code>SELECT * FROM a RIGHT JOIN b USING(id);</code></li>
<li><code>SELECT * FROM a CROSS JOIN b USING(id);</code></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/数据库/">数据库</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/10/08/数据库/Mysql 增删改查/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/10/08/数据库/Mysql 增删改查/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/08/编程语言/shell/" title="Shell 编程" itemprop="url">Shell 编程</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2015-10-07T16:00:00.000Z" itemprop="datePublished"> 發表於 2015-10-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>每个shell脚本文件第一行都要指定使用哪个shell,我们默认使用<code>#!/bin/bash</code></p>
<h1 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h1><h2 id="变量类型"><a href="#变量类型" class="headerlink" title="变量类型"></a>变量类型</h2><p>运行shell时，会同时存在三种变量：</p>
<ul>
<li>局部变量： 局部变量在脚本或命令中定义，仅在当前shell实例中有效，其他shell启动的程序不能访问局部变量。</li>
<li>环境变量：所有的程序，包括shell启动的程序，都能访问环境变量，有些程序需要环境变量来保证其正常运行。必要的时候shell脚本也可以定义环境变量。</li>
<li>shell变量：shell变量是由shell程序设置的特殊变量。shell变量中有一部分是环境变量，有一部分是局部变量，这些变量保证了shell的正常运行</li>
</ul>
<h2 id="变量声明"><a href="#变量声明" class="headerlink" title="变量声明"></a>变量声明</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">v1=123</div></pre></td></tr></table></figure>
<p>在上面的声明语法中我们需要注意以下几点</p>
<ul>
<li><code>=</code>左右不能用空格</li>
<li>变量的默认类型是字符串</li>
<li>该变量对当前以及子shell都有效</li>
</ul>
<h3 id="命令结果赋值"><a href="#命令结果赋值" class="headerlink" title="命令结果赋值"></a>命令结果赋值</h3><p>将命令执行的结果作为值传送给一个变量可以使用<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dirName=`date +%Y_%m_%d_%H_%M_%S`</div><div class="line"><span class="meta">#</span><span class="bash">或者</span></div><div class="line">dirName=$(date +%Y_%m_%d_%H_%M_%S)</div></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Group_port=18080</div><div class="line"></div><div class="line">port_name=Group</div><div class="line">port=\$$&#123;port_name&#125;"_port"</div><div class="line"></div><div class="line">port1=`eval echo $port`</div><div class="line">echo $&#123;port&#125;</div><div class="line">echo $&#123;port1&#125;</div><div class="line"></div><div class="line">echo $&#123;Group_port&#125;</div></pre></td></tr></table></figure>
<h2 id="变量引用"><a href="#变量引用" class="headerlink" title="变量引用"></a>变量引用</h2><p>我们通过使用<code>$</code>或者<code>${}</code>符号可以引用一个变量<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">v=1</div><div class="line">echo $v</div><div class="line">echo $&#123;v&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>需要注意的是, <code>$()</code>是用来做命令替换的(<code>\</code>`<code>也是用来做命令替换的), 而</code>${}<code>是用来做变量替换的(</code>$var<code>与</code>${var}`并没有啥不一样)</p>
</blockquote>
<h2 id="只读变量"><a href="#只读变量" class="headerlink" title="只读变量"></a>只读变量</h2><p><code>readonly</code> 命令可以将变量定义为只读变量<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">readonly myUrl</div></pre></td></tr></table></figure></p>
<h2 id="删除变量"><a href="#删除变量" class="headerlink" title="删除变量"></a>删除变量</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">unset  myUrl</div></pre></td></tr></table></figure>
<h2 id="特殊变量"><a href="#特殊变量" class="headerlink" title="特殊变量"></a>特殊变量</h2><ul>
<li><code>$0</code>:    当前脚本的文件名</li>
<li><code>$n</code>:    传递给脚本或函数的参数。(第一个参数是$1，第二个参数是$2)</li>
<li><code>$#</code>:    传递给脚本或函数的参数个数。</li>
<li><code>$*</code>:    传递给脚本或函数的所有参数。</li>
<li><code>$@</code>:    传递给脚本或函数的所有参数。被双引号(“ “)包含时，与 $* 稍有不同</li>
<li><code>$?</code>:    上个命令的退出状态，或函数的返回值。</li>
<li><code>$$</code>:    当前Shell进程ID。对于 Shell 脚本，就是这些脚本所在的进程ID。</li>
</ul>
<h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><h3 id="数组定义"><a href="#数组定义" class="headerlink" title="数组定义"></a>数组定义</h3><p>一对括号表示是数组，数组元素用“空格”符号分割开。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">array=(1 2 3 4 5)</div></pre></td></tr></table></figure></p>
<h3 id="数组长度"><a href="#数组长度" class="headerlink" title="数组长度"></a>数组长度</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash">&#123;<span class="comment">#数组名[@或*]&#125; : 可以得到数组长度</span></span></div><div class="line"><span class="meta">$</span><span class="bash">&#123;<span class="comment">#array[@]&#125;</span></span></div></pre></td></tr></table></figure>
<h3 id="索引数组成员"><a href="#索引数组成员" class="headerlink" title="索引数组成员"></a>索引数组成员</h3><p><code>${数组名[下标]}</code> : 下标是从0开始 (下标是：*或者@ 得到整个数组内容)<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash">&#123;array[2]&#125;</span></div></pre></td></tr></table></figure></p>
<h3 id="数组成员赋值"><a href="#数组成员赋值" class="headerlink" title="数组成员赋值"></a>数组成员赋值</h3><p><code>数组名[下标]</code>: 进行数组元素引用，如果下标不存在，自动添加新一个数组元素<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">array[1]=100</div></pre></td></tr></table></figure></p>
<h3 id="删除数组"><a href="#删除数组" class="headerlink" title="删除数组"></a>删除数组</h3><p><code>unset 数组[下标]</code>：删除下标相应的元素，不带下标，则删掉整个数组。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">unset array[1]</div></pre></td></tr></table></figure></p>
<h3 id="数组分片"><a href="#数组分片" class="headerlink" title="数组分片"></a>数组分片</h3><p><code>${数组名[@或*]:起始位置:长度}</code>： 切片数组，返回一个用“空格”分割元素的字符串</p>
<blockquote>
<p>如果加上<code>()</code>，将得到切片数组</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">c=($&#123;array[@]:1:4&#125;)</div></pre></td></tr></table></figure>
<h3 id="数组替换"><a href="#数组替换" class="headerlink" title="数组替换"></a>数组替换</h3><p><code>${数组名[@或*]/查找字符/替换字符}</code>: 该操作不会改变原先数组内容<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash">&#123;array[@]/old/new&#125;</span></div></pre></td></tr></table></figure></p>
<h1 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h1><h2 id="算术运算符"><a href="#算术运算符" class="headerlink" title="算术运算符"></a>算术运算符</h2><p>我们可以使用<code>expr</code>, <code>let</code>, <code>(())</code>, <code>[]</code>等四种方式进行算术运算</p>
<ul>
<li><code>+</code>:    加法    <code>(($a + $b))</code></li>
<li><code>-</code>:    减法<code>(($a - $b))</code></li>
<li><code>*</code>:    乘法    <code>(($a \* $b))</code></li>
<li><code>/</code>:    除法    <code>(($b / $a))</code></li>
<li><code>%</code>:    取余    <code>(($b % $a))</code></li>
<li><code>=</code>:    赋值    <code>a=$b</code></li>
<li><code>==</code>:    相等。用于比较两个数字，相同则返回 true。    <code>[ $a == $b ]</code> 返回 false。</li>
<li><code>!=</code>:    不相等。用于比较两个数字，不相同则返回 true。    <code>[ $a != $b ]</code> 返回 true。</li>
</ul>
<h2 id="关系运算符"><a href="#关系运算符" class="headerlink" title="关系运算符"></a>关系运算符</h2><p>关系运算符只支持数字，不支持字符串，除非字符串的值是数字。</p>
<ul>
<li><code>-eq</code>    检测两个数是否相等，相等返回 true。    <code>[ $a -eq $b ]</code> 返回 true。</li>
<li><code>-ne</code>    检测两个数是否相等，不相等返回 true。    <code>[ $a -ne $b ]</code> 返回 true。</li>
<li><code>-gt</code>    检测左边的数是否大于右边的，如果是，则返回 true。    <code>[ $a -gt $b ]</code> 返回 false。</li>
<li><code>-lt</code>    检测左边的数是否小于右边的，如果是，则返回 true。    <code>[ $a -lt $b ]</code> 返回 true。</li>
<li><code>-ge</code>    检测左边的数是否大等于右边的，如果是，则返回 true。    <code>[ $a -ge $b ]</code> 返回 false。</li>
<li><code>-le</code>    检测左边的数是否小于等于右边的，如果是，则返回 true。    <code>[ $a -le $b ]</code> 返回 true。</li>
</ul>
<h2 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h2><ul>
<li><code>!</code>    非运算，表达式为 true 则返回 false，否则返回 true。    <code>[ ! false ]</code> 返回 true。</li>
<li><code>-o</code>    或运算，有一个表达式为 true 则返回 true。    <code>[ $a -lt 20 -o $b -gt 100 ]</code> 返回 true。</li>
<li><code>-a</code>    与运算，两个表达式都为 true 才返回 true。    <code>[ $a -lt 20 -a $b -gt 100 ]</code> 返回 false。</li>
</ul>
<h2 id="字符串运算符"><a href="#字符串运算符" class="headerlink" title="字符串运算符"></a>字符串运算符</h2><ul>
<li><code>=</code>    检测两个字符串是否相等，相等返回 true。    <code>[ $a = $b ]</code> 返回 false。</li>
<li><code>!=</code>    检测两个字符串是否相等，不相等返回 true。    <code>[ $a != $b ]</code> 返回 true。</li>
<li><code>-z</code>    检测字符串长度是否为0，为0返回 true。    <code>[ -z $a</code>] 返回 false。</li>
<li><code>-n</code>    检测字符串长度是否为0，不为0返回 true。    <code>[ -z $a</code>] 返回 true。</li>
<li><code>str</code>    检测字符串是否为空，不为空返回 true。    <code>[ $a</code>] 返回 true。</li>
</ul>
<h2 id="文件测试运算符"><a href="#文件测试运算符" class="headerlink" title="文件测试运算符"></a>文件测试运算符</h2><ul>
<li><code>-b</code> 文件是否是块设备文件，如果是，则返回 true。    <code>[ -b $file</code>] 返回 false。</li>
<li><code>-c</code> 文件是否是字符设备文件，如果是，则返回 true。    <code>[ -b $file</code>] 返回 false。</li>
<li><code>-d</code> 文件是否是目录，如果是，则返回 true。    <code>[ -d $file</code>] 返回 false。</li>
<li><code>-f</code> 文件是否是普通文件（既不是目录，也不是设备文件），如果是，则返回 true。    <code>[ -f $file</code>] 返回 true。</li>
<li><code>-g</code> 文件是否设置了 SGID 位，如果是，则返回 true。    <code>[ -g $file</code>] 返回 false。</li>
<li><code>-k</code> 文件是否设置了粘着位(Sticky Bit)，如果是，则返回 true。    <code>[ -k $file</code>] 返回 false。</li>
<li><code>-p</code> 文件是否是具名管道，如果是，则返回 true。    <code>[ -p $file</code>] 返回 false。</li>
<li><code>-u</code> 文件是否设置了 SUID 位，如果是，则返回 true。    <code>[ -u $file</code>] 返回 false。</li>
<li><code>-r</code> 文件是否可读，如果是，则返回 true。    <code>[ -r $file</code>] 返回 true。</li>
<li><code>-w</code> 文件是否可写，如果是，则返回 true。    <code>[ -w $file</code>] 返回 true。</li>
<li><code>-x</code> 文件是否可执行，如果是，则返回 true。    <code>[ -x $file</code>] 返回 true。</li>
<li><code>-s</code> 文件是否为空（文件大小是否大于0），不为空返回 true。    <code>[ -s $file</code>] 返回 true。</li>
<li><code>-e</code> 文件（包括目录）是否存在，如果是，则返回 true。    <code>[ -e $file</code>] 返回 true。</li>
</ul>
<h1 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h1><p>shell流程控制包含：</p>
<ul>
<li>if</li>
<li>while</li>
<li>until</li>
<li>case</li>
<li>for</li>
</ul>
<p>同样的shell也支持<code>break</code>和<code>continue</code></p>
<h2 id="if"><a href="#if" class="headerlink" title="if"></a>if</h2><p>condition 可以使用 文件测试运算符 或者 关系运算符 进行条件判断</p>
<p>语法格式<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">if condition</div><div class="line">then</div><div class="line">    command1</div><div class="line">    command2</div><div class="line">    ...</div><div class="line">    commandN</div><div class="line">fi</div></pre></td></tr></table></figure></p>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></div><div class="line">v=123</div><div class="line">if [ -b $txt ];   </div><div class="line">then</div><div class="line">        echo "ok";</div><div class="line">fi</div></pre></td></tr></table></figure></p>
<p>我们一定要注意if前后的空格</p>
<p><code>if else</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">if condition</div><div class="line">then</div><div class="line">    command1</div><div class="line">    command2</div><div class="line">    ...</div><div class="line">    commandN</div><div class="line">else</div><div class="line">    command</div><div class="line">fi</div></pre></td></tr></table></figure></p>
<p><code>if else-if else</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">if condition1</div><div class="line">then</div><div class="line">    command1</div><div class="line">elif condition2</div><div class="line">    command2</div><div class="line">else</div><div class="line">    commandN</div><div class="line">fi</div></pre></td></tr></table></figure></p>
<h2 id="case"><a href="#case" class="headerlink" title="case"></a>case</h2><p> case语句为多选择语句<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">case 值 in</div><div class="line">模式1)</div><div class="line">    command1</div><div class="line">    command2</div><div class="line">    ...</div><div class="line">    commandN</div><div class="line">    ;;</div><div class="line">模式2）</div><div class="line">    command1</div><div class="line">    command2</div><div class="line">    ...</div><div class="line">    commandN</div><div class="line">    ;;</div><div class="line">esac</div></pre></td></tr></table></figure></p>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash">!/bin/bash</span></div><div class="line"></div><div class="line">for i in 1 2 3 4 5;</div><div class="line">do</div><div class="line">        case $i in</div><div class="line">                1)  echo '你选择了 1'</div><div class="line">                ;;</div><div class="line">                2)  echo '你选择了 2'</div><div class="line">                ;;</div><div class="line">                3)  echo '你选择了 3'</div><div class="line">                ;;</div><div class="line">                4)  echo '你选择了 4'</div><div class="line">                ;;</div><div class="line">                *)  echo '你没有输入 1 到 4 之间的数字'</div><div class="line">                ;;</div><div class="line">                esac</div><div class="line">done</div></pre></td></tr></table></figure></p>
<h2 id="for"><a href="#for" class="headerlink" title="for"></a>for</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">for var in item1 item2 ... itemN</div><div class="line">do</div><div class="line">    command1</div><div class="line">    command2</div><div class="line">    ...</div><div class="line">    commandN</div><div class="line">done</div></pre></td></tr></table></figure>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></div><div class="line"></div><div class="line">for i in 1 2 3 4;</div><div class="line">do</div><div class="line">        echo $i</div><div class="line">done</div></pre></td></tr></table></figure></p>
<h2 id="while"><a href="#while" class="headerlink" title="while"></a>while</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">while condition</div><div class="line">do</div><div class="line">    command</div><div class="line">done</div></pre></td></tr></table></figure>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></div><div class="line"></div><div class="line">i=1</div><div class="line">while(( $i&lt;=5 ))</div><div class="line">do</div><div class="line">        echo $i</div><div class="line">        ((i++))</div><div class="line">done</div></pre></td></tr></table></figure></p>
<h2 id="until"><a href="#until" class="headerlink" title="until"></a>until</h2><p>until循环执行一系列命令直至条件为真时停止。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">until condition</div><div class="line">do</div><div class="line">    command</div><div class="line">done</div></pre></td></tr></table></figure></p>
<p>示例<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></div><div class="line"></div><div class="line">i=1</div><div class="line">until(( $i&gt;3 ))</div><div class="line">do</div><div class="line">        echo $i</div><div class="line">        ((i++))</div><div class="line">done</div></pre></td></tr></table></figure></p>
<h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><p>调用函数不需要加<code>()</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">vi=123546789</div><div class="line">f() &#123;</div><div class="line">	echo $vi</div><div class="line">&#125;</div><div class="line">f</div></pre></td></tr></table></figure></p>
<h2 id="带参数的函数"><a href="#带参数的函数" class="headerlink" title="带参数的函数"></a>带参数的函数</h2><p>参数名是固定的<code>$n</code>, 如果参数大于10的话就需要<code>${10}</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">f() &#123;</div><div class="line">echo $1</div><div class="line">&#125;</div><div class="line">f 789</div></pre></td></tr></table></figure></p>
<h2 id="函数的返回值"><a href="#函数的返回值" class="headerlink" title="函数的返回值"></a>函数的返回值</h2><p>函数返回值在调用该函数后通过 <code>$?</code> 来获得<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">f() &#123;</div><div class="line">echo $1</div><div class="line">&#125;</div><div class="line">f 789</div><div class="line">echo $?</div></pre></td></tr></table></figure></p>
<p>如果不写<code>return</code>, 则直接返回0<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">f() &#123;</div><div class="line">echo $1</div><div class="line">return 569</div><div class="line">&#125;</div><div class="line">f 789</div><div class="line">echo $?</div></pre></td></tr></table></figure></p>
<h2 id="在当前shell里执行一个文件里的命令："><a href="#在当前shell里执行一个文件里的命令：" class="headerlink" title="在当前shell里执行一个文件里的命令："></a>在当前shell里执行一个文件里的命令：</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">source /home/user/file.name</div></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/10/08/编程语言/shell/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/10/08/编程语言/shell/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/08/编程语言/AWK/" title="AWK" itemprop="url">AWK</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2015-10-07T16:00:00.000Z" itemprop="datePublished"> 發表於 2015-10-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="AWK"><a href="#AWK" class="headerlink" title="AWK"></a>AWK</h1><p>awk就是把文件逐行的读入，以空格为默认分隔符将每行切片，切开的部分再进行各种分析处理。</p>
<p>语法<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk [-F  field-separator]  <span class="string">'commands'</span>  input-file(s)</div></pre></td></tr></table></figure></p>
<ul>
<li>-F: 域分隔符,由域分隔符分开的每一项称为一个域。通常，在不指名-F域分隔符的情况下，默认的域分隔符是空格。(我们指定:为分隔符<code>-F &#39;:&#39;</code>)</li>
<li>commands: ‘PATTERN{COMMAND}’. PATTERN为模式(正在表达式),COMMAND为要执行的命令.</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk  -F <span class="string">':'</span>  <span class="string">'BEGIN &#123;print "start"&#125;  &#123;print $1"&#125; END &#123;print "end"&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure>
<p>上面的例子是读取<code>txt</code>文件,然后使用<code>:</code>分割每一行数据,在开始处理的时候输出start，在处理过程中第一列数据，最后输出end。</p>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><h3 id="内置变量"><a href="#内置变量" class="headerlink" title="内置变量"></a>内置变量</h3><p>我们可以在AWK命令中直接使用以下内置变量<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ARGC               命令行参数个数</div><div class="line">ARGV               命令行参数排列</div><div class="line">ENVIRON            支持队列中系统环境变量的使用</div><div class="line">FILENAME           awk浏览的文件名</div><div class="line">FNR                浏览文件的记录数</div><div class="line">FS                 设置输入域分隔符，等价于命令行 -F选项</div><div class="line">NF                 浏览记录的域的个数</div><div class="line">NR                 已读的记录数</div><div class="line">OFS                输出域分隔符</div><div class="line">ORS                输出记录分隔符</div><div class="line">RS                 控制记录分隔符</div></pre></td></tr></table></figure></p>
<p>例如<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jps -l | awk <span class="string">'&#123;print ARGC&#125;'</span></div></pre></td></tr></table></figure></p>
<h3 id="自定义变量"><a href="#自定义变量" class="headerlink" title="自定义变量"></a>自定义变量</h3><p>我们通过赋值的方式直接定义一个变量<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jps -l | awk <span class="string">'BEGIN&#123;size=0;&#125; &#123;size=1+size&#125; &#123;print $1&#125; END&#123;print size&#125;'</span></div></pre></td></tr></table></figure></p>
<p>上面我们定义了一个数值型的size变量.</p>
<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><h1 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h1><ul>
<li><code>= += -= *= /= %= ^= **=</code>    赋值</li>
<li><code>?:</code>    C条件表达式</li>
<li><code>||</code>    逻辑或</li>
<li><code>&amp;&amp;</code>    逻辑与</li>
<li><code>~ ~!</code>    匹配正则表达式和不匹配正则表达式</li>
<li><code>&lt; &lt;= &gt; &gt;= != ==</code>    关系运算符</li>
<li><code>空格</code>    连接</li>
<li><code>+ -</code>    加，减</li>
<li><code>* / &amp;</code>    乘，除与求余</li>
<li><code>+ - !</code>    一元加，减和逻辑非</li>
<li><code>^ ***</code>    求幂</li>
<li><code>++ --</code>    增加或减少，作为前缀或后缀</li>
<li><code>$</code>    字段引用</li>
<li><code>in</code>    数组成员</li>
</ul>
<h1 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h1><h2 id="条件语句"><a href="#条件语句" class="headerlink" title="条件语句"></a>条件语句</h2><p>下面输出了大于10000的java进程号<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jps -l | awk <span class="string">'BEGIN&#123;size=0&#125; &#123;if($1&gt;10000) &#123;size++;print $1&#125;&#125; END&#123;print size&#125;'</span></div></pre></td></tr></table></figure></p>
<h2 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h2><p>awk中的循环语句借鉴于C语言，支持while、do/while、for、break、continue，这些关键字的语义和C语言中的语义完全相同。</p>
<h1 id="字符串处理"><a href="#字符串处理" class="headerlink" title="字符串处理"></a>字符串处理</h1><h2 id="sub函数"><a href="#sub函数" class="headerlink" title="sub函数"></a>sub函数</h2><p>匹配从左侧开始找到的第一个符合规则的字符串，然后使用替换字符串替换这些字符串<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jps -l | awk <span class="string">'&#123;sub(/moon/, "sun")&#125; &#123;print $2&#125;'</span></div></pre></td></tr></table></figure></p>
<p>上面这个例子就使用sun这个字符串替换了$2中的moon字符串。</p>
<p>我们还可以指定在哪列执行查找替换<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jps -l | awk <span class="string">'&#123;sub(/moon/, "sun", $1)&#125; &#123;print $2&#125;'</span></div></pre></td></tr></table></figure></p>
<p>上面的例子中我们只在第一列进行查找替换</p>
<h2 id="gsub函数"><a href="#gsub函数" class="headerlink" title="gsub函数"></a>gsub函数</h2><p>与sub函数不同的是，这个执行的是全局替换<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jps -l | awk <span class="string">'&#123;gsub(/moon/, "sun")&#125; &#123;print $2&#125;'</span></div></pre></td></tr></table></figure></p>
<h2 id="index函数"><a href="#index函数" class="headerlink" title="index函数"></a>index函数</h2><p>返回子字符串第一次被匹配的位置，偏移量从位置1开始<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jps -l | awk <span class="string">'&#123;print$2; $2=index($2, "moon")&#125; &#123;print $2&#125;'</span></div></pre></td></tr></table></figure></p>
<h2 id="length函数"><a href="#length函数" class="headerlink" title="length函数"></a>length函数</h2><p>返回记录的字符数<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jps -l | awk <span class="string">'&#123;print$2; $2=length($2)&#125; &#123;print $2&#125;'</span></div></pre></td></tr></table></figure></p>
<h2 id="substr函数"><a href="#substr函数" class="headerlink" title="substr函数"></a>substr函数</h2><p>返回从位置1开始的子字符串，如果指定长度超过实际长度，就返回整个字符串<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jps -l | awk <span class="string">'&#123;print substr($2, 2, 10)&#125; '</span></div></pre></td></tr></table></figure></p>
<p>上面的例子将$2字符串从第二个字符还是截取，截取10个长度的字符串出来</p>
<h2 id="toupper和tolower函数"><a href="#toupper和tolower函数" class="headerlink" title="toupper和tolower函数"></a>toupper和tolower函数</h2><p>可用于字符串大小间的转换<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'&#123;print toupper($2)&#125; '</span></div></pre></td></tr></table></figure></p>
<h2 id="split函数"><a href="#split函数" class="headerlink" title="split函数"></a>split函数</h2><p>可按给定的分隔符把字符串分割为一个数组<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jps -l | awk <span class="string">'&#123; split($2, array, "/"); print array[3]&#125; '</span></div></pre></td></tr></table></figure></p>
<p>上面的例子我们将$2这一列按照<code>/</code>进行分割,然后将分割出的数据存储到array数组里. 注意这里首先不需要转义</p>
<h1 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h1><h2 id=""><a href="#" class="headerlink" title="\"></a>\</h2><p>将下一字符标记为特殊字符、文本、反向引用或八进制转义符。例如，“n”匹配字符“n”。“\n”匹配换行符。序列“\”匹配“\”，“(”匹配“(”。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/\\/&#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<p>过滤出带有<code>\</code>的行</p>
<h2 id="-1"><a href="#-1" class="headerlink" title="^"></a>^</h2><p>匹配输入字符串与最左侧开始的位置的字符串。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/^\\n/&#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<p>找到所有以<code>\n</code>字符串开始的数据</p>
<h2 id="-2"><a href="#-2" class="headerlink" title="$"></a>$</h2><p>匹配输入字符串结尾的位置。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/)。$/&#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<p>过滤以<code>)。</code>结尾的行</p>
<h2 id="-3"><a href="#-3" class="headerlink" title="*"></a>*</h2><p>零次或多次匹配前面的字符或子表达式。例如，zo<em> 匹配“z”和“zoo”。</em> 等效于 {0,}。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/反向引用*/&#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<h2 id="-4"><a href="#-4" class="headerlink" title="+"></a>+</h2><p>一次或多次匹配前面的字符或子表达式。例如，“zo+”与“zo”和“zoo”匹配，但与“z”不匹配。+ 等效于 {1,}。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/反向引用+/&#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<h2 id="-5"><a href="#-5" class="headerlink" title="?"></a>?</h2><p>零次或一次匹配前面的字符或子表达式。例如，“do(es)?”匹配“do”或“does”中的“do”。? 等效于 {0,1}。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/反向引用?/&#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<h2 id="n"><a href="#n" class="headerlink" title="{n}"></a>{n}</h2><p>n 是非负整数。正好匹配 n 次。例如，“o{2}”与“Bob”中的“o”不匹配，但与“food”中的两个“o”匹配。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<h2 id="n-1"><a href="#n-1" class="headerlink" title="{n,}"></a>{n,}</h2><p>n 是非负整数。至少匹配 n 次。例如，“o{2,}”不匹配“Bob”中的“o”，而匹配“foooood”中的所有 o。“o{1,}”等效于“o+”。“o{0,}”等效于“o*”。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<h2 id="n-m"><a href="#n-m" class="headerlink" title="{n,m}"></a>{n,m}</h2><p>M 和 n 是非负整数，其中 n &lt;= m。匹配至少 n 次，至多 m 次。例如，“o{1,3}”匹配“fooooood”中的头三个 o。’o{0,1}’ 等效于 ‘o?’。注意：您不能将空格插入逗号和数字之间。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<h2 id="-6"><a href="#-6" class="headerlink" title="."></a>.</h2><p>匹配除“\n”之外的任何单个字符。若要匹配包括“\n”在内的任意字符，请使用诸如“[\s\S]”之类的模式。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<h2 id="pattern"><a href="#pattern" class="headerlink" title="(pattern)"></a>(pattern)</h2><p>匹配 pattern 并捕获该匹配的子表达式。可以使用 $0…$9 属性从结果“匹配”集合中检索捕获的匹配。若要匹配括号字符 ( )，请使用“(”或者“)”。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<h2 id="pattern-1"><a href="#pattern-1" class="headerlink" title="(?:pattern)"></a>(?:pattern)</h2><p>匹配 pattern 但不捕获该匹配的子表达式，即它是一个非捕获匹配，不存储供以后使用的匹配。这对于用“or”字符 (|) 组合模式部件的情况很有用。例如，’industr(?:y|ies) 是比 ‘industry|industries’ 更经济的表达式。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<h2 id="pattern-2"><a href="#pattern-2" class="headerlink" title="(?=pattern)"></a>(?=pattern)</h2><p>执行正向预测先行搜索的子表达式，该表达式匹配处于匹配 pattern 的字符串的起始点的字符串。它是一个非捕获匹配，即不能捕获供以后使用的匹配。例如，’Windows (?=95|98|NT|2000)’ 匹配“Windows 2000”中的“Windows”，但不匹配“Windows 3.1”中的“Windows”。预测先行不占用字符，即发生匹配后，下一匹配的搜索紧随上一匹配之后，而不是在组成预测先行的字符后。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<h2 id="pattern-3"><a href="#pattern-3" class="headerlink" title="(?!pattern)"></a>(?!pattern)</h2><p>执行反向预测先行搜索的子表达式，该表达式匹配不处于匹配 pattern 的字符串的起始点的搜索字符串。它是一个非捕获匹配，即不能捕获供以后使用的匹配。例如，’Windows (?!95|98|NT|2000)’ 匹配“Windows 3.1”中的 “Windows”，但不匹配“Windows 2000”中的“Windows”。预测先行不占用字符，即发生匹配后，下一匹配的搜索紧随上一匹配之后，而不是在组成预测先行的字符后。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<h2 id="x-y"><a href="#x-y" class="headerlink" title="x|y"></a>x|y</h2><p>匹配 x 或 y。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/换页符等|十六进制转义码必须正好是两位数长/ &#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<h2 id="xyz"><a href="#xyz" class="headerlink" title="[xyz]"></a>[xyz]</h2><p>匹配是否包含xyz中任意一个字符<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/[前面至少有]/ &#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<h2 id="xyz-1"><a href="#xyz-1" class="headerlink" title="[^xyz]"></a>[^xyz]</h2><p>匹配不能包含xyz任意一个字符<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/[^前面至少有]/ &#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<h2 id="a-z"><a href="#a-z" class="headerlink" title="[a-z]"></a>[a-z]</h2><p>与<code>[xyz]</code>规则相同,只不过这个模式提供了一个范围模式.例如[a-c]实际为匹配[abc]<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/[a-b]/ &#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<h2 id="a-z-1"><a href="#a-z-1" class="headerlink" title="[^a-z]"></a>[^a-z]</h2><p>反向范围字符。匹配不在指定的范围内的任何字符。例如，“[^a-z]”匹配任何不在“a”到“z”范围内的任何字符。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/[^a-z]/ &#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<p>需要注意的是’\t’会被匹配出来</p>
<h2 id="d"><a href="#d" class="headerlink" title="\d"></a>\d</h2><p>数字字符匹配。等效于 [0-9]。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/\d/ &#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<h2 id="D"><a href="#D" class="headerlink" title="\D"></a>\D</h2><p>非数字字符匹配。等效于 [^0-9]。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/\D/ &#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<h2 id="n-2"><a href="#n-2" class="headerlink" title="\n"></a>\n</h2><p>换行符匹配。等效于 \x0a 和 \cJ。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/\n/ &#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<h2 id="r"><a href="#r" class="headerlink" title="\r"></a>\r</h2><p>匹配一个回车符。等效于 \x0d 和 \cM。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/\t/ &#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<h2 id="s"><a href="#s" class="headerlink" title="\s"></a>\s</h2><p>匹配任何空白字符，包括空格、制表符、换页符等。与 [ \f\n\r\t\v] 等效。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/\s/ &#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<h2 id="S"><a href="#S" class="headerlink" title="\S"></a>\S</h2><p>匹配任何非空白字符。与 [^ \f\n\r\t\v] 等效。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/\S/ &#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<h2 id="w"><a href="#w" class="headerlink" title="\w"></a>\w</h2><p>匹配任何字类字符，包括下划线。与“[A-Za-z0-9_]”等效。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/\w/ &#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>
<h2 id="W"><a href="#W" class="headerlink" title="\W"></a>\W</h2><p>与任何非单词字符匹配。与“[^A-Za-z0-9_]”等效。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'/\W/ &#123;print $0&#125;'</span> .<span class="regexp">/txt</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/10/08/编程语言/AWK/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/10/08/编程语言/AWK/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/08/数据库/数据库事务/" title="MySQL事务" itemprop="url">MySQL事务</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2015-10-07T16:00:00.000Z" itemprop="datePublished"> 發表於 2015-10-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>事务（Transaction）是一个操作序列，它构成了并发执行的基本单元。事务的提出主要是为了解决并发情况下保持数据一致性。</p>
<p>数据库事务具有ACID特性,即</p>
<ul>
<li>原子性： 原子性体现在对事务的修改,要么全部执行要么都不执行</li>
<li>一致性： 保持数据的一致性,例如整数类型的数据大小不能溢出,字符型数据长度不能超过规定范围，保证数据的完整性.</li>
<li>隔离性： 如果数据库并发执行A,B俩个事务,那么在A事务执行完之前对B事务是不可见的,也就是说,B事务是看不见A事务的中间状态的.</li>
<li>持久性： 事务完成后,它对数据库的影响是永久的,即使数据库出现异常也是如此.</li>
</ul>
<p>隔离级别</p>
<ul>
<li><code>Read Uncommitted</code>: 读取未提交的数据,即其他事务已经提交修改但还未提交的数据(这是最低的隔离级别)</li>
<li><code>Read Committed</code>: 读取已经提交的数据,但是在一个事务中,对同一个项,前后俩次读取的结果可能不同.</li>
<li><code>Repetable Read</code>: 可重复读取,在一个事务中,对同一个项,确保前后俩次读取的结果一样</li>
<li><code>Serializable</code>: 可序列话,即数据库的事务是可串行执行的,就像一个事务执行的时候没有别的事务同时在执行<br>我们使用下面的语句来改变数据库的隔离级别<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SET</span> [<span class="keyword">SESSION</span>|<span class="keyword">GLOBAL</span>] <span class="keyword">TRANSACTION</span> <span class="keyword">ISOLATION</span> <span class="keyword">LEVEL</span> <span class="keyword">READ</span> UNCOMMITTED | <span class="keyword">READ</span> COMMITTED | REPEATABLE <span class="keyword">READ</span> | <span class="keyword">SERIALIZABLE</span></div></pre></td></tr></table></figure>
</li>
</ul>
<ol>
<li>不带<code>SESSION、GLOBAL</code>的SET命令,只对下一个事务有效</li>
<li><code>SET SESSION</code> 为当前会话设置隔离模式</li>
<li><code>SET GLOBAL</code>为以后新建的所有MYSQL连接设置隔离模式（当前连接不包括在内）</li>
</ol>
<p>读写异常</p>
<ul>
<li><code>Lost Update</code>: 俩个事务并发修改同一个数据,A事务提交成功,B事务提交失败回滚后,A事务的修改都可能会丢失</li>
<li><code>Dirty Reads</code>: A事务读取了B事务更新却没有提交的数据</li>
<li><code>Non-Repeatable Reads</code>: 一个事务对同一个数据项的多次读取可能得到不同的结果</li>
<li><code>Second Lost Updates</code>:俩个事务并发修改同一个数据, B事务可能会覆盖掉A事务的修改</li>
<li><code>Phantom Reads</code>: A事务进行前后俩次查询,但是在查询过程中出现了B事务向其中插入数据,那么A事务可能读取到未出现的数据</li>
</ul>
<p>隔离级别与读写异常的关系<br><figure class="highlight excel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">    LU  DR  NRR  SLU  PR</div><div class="line">RU  <span class="built_in">N</span>   Y   Y    Y    Y</div><div class="line">RC  <span class="built_in">N</span>   <span class="built_in">N</span>   Y    Y    Y</div><div class="line">RR  <span class="built_in">N</span>   <span class="built_in">N</span>   <span class="built_in">N</span>   <span class="built_in">N</span>     Y</div><div class="line">S   <span class="built_in">N</span>   <span class="built_in">N</span>   <span class="built_in">N</span>   <span class="built_in">N</span>     <span class="built_in">N</span></div></pre></td></tr></table></figure></p>
<h3 id="事务语句"><a href="#事务语句" class="headerlink" title="事务语句"></a>事务语句</h3><ul>
<li>开始事物：<code>BEGIN TRANSACTION</code></li>
<li>提交事物：<code>COMMIT TRANSACTION</code></li>
<li>回滚事务：<code>ROLLBACK TRANSACTION</code></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># 开启一个事务</div><div class="line">START TRANSACTION;</div><div class="line">INSERT INTO db1.`t1`(id) VALUES(1);</div><div class="line"># 提交事务</div><div class="line">COMMIT;</div><div class="line"></div><div class="line"># 开启事务</div><div class="line">START TRANSACTION;</div><div class="line">INSERT INTO db1.`t1`(id) VALUES(2);</div><div class="line"># 回滚刚才的事务</div><div class="line">ROLLBACK;</div></pre></td></tr></table></figure>
<h3 id="并发控制"><a href="#并发控制" class="headerlink" title="并发控制"></a>并发控制</h3><h4 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h4><h4 id="写时复制"><a href="#写时复制" class="headerlink" title="写时复制"></a>写时复制</h4><h4 id="多版本并发控制"><a href="#多版本并发控制" class="headerlink" title="多版本并发控制"></a>多版本并发控制</h4><p>Mysql InnoDB存储引擎,InnoDB对每一行维护了俩个隐含的列,一列用于存储行被修改的时间,另一列存储每一行被删除的时间.</p>
<blockquote>
<p>这里的时间并不是绝对时间,而是与时间对应的数据库系统的版本号,每当一个事务开始时,InnoDB都会给这个事务分配一个递增的版本号,所以版本号也可以被任务是事务好.对于每一行的查询语句,InnoDB都会把这个查询语句的版本号同这个查询雨具遇到的行的版本号进行对比,然后结合不同的事务隔离级别来决定是否返回改行.</p>
</blockquote>
<p>下面以SELECT,DELETE,INSERT,UPDATE为例:</p>
<h5 id="SELECT"><a href="#SELECT" class="headerlink" title="SELECT"></a>SELECT</h5><p>只有同时满足下面俩个条件的行才能被返回:</p>
<ol>
<li>行的版本号小于等于该事务的版本号</li>
<li>行的删除版本号要么没有定义,要么大于等于事务的版本号<br>如果行的修改或者删除版本号大于事务号,说明行是被该食物后面启动的事务修改或者删除的 </li>
</ol>
<h5 id="DELETE"><a href="#DELETE" class="headerlink" title="DELETE"></a>DELETE</h5><p>InnoDB直接把该行的删除版本号设置为当前的事务号,相当于标记为删除而不是物理删除</p>
<h5 id="INSERT"><a href="#INSERT" class="headerlink" title="INSERT"></a>INSERT</h5><p>对于新插入的行,行的修改版本号更新为该事务的事务号</p>
<h5 id="UPDATE"><a href="#UPDATE" class="headerlink" title="UPDATE"></a>UPDATE</h5><p>更新行的时候,InnoDB会把原来的行复制一份,并把当前的事务号作为改行的修改版本号</p>
<h3 id="事务异常"><a href="#事务异常" class="headerlink" title="事务异常"></a>事务异常</h3>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/数据库/">数据库</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/10/08/数据库/数据库事务/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/10/08/数据库/数据库事务/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/09/08/JavaSE/Java8 lambda/" title="java lambda" itemprop="url">java lambda</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="大王玉" target="_blank" itemprop="author">大王玉</a>
		
  <p class="article-time">
    <time datetime="2015-09-07T16:00:00.000Z" itemprop="datePublished"> 發表於 2015-09-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="函数接口"><a href="#函数接口" class="headerlink" title="函数接口"></a>函数接口</h2><h3 id="函数接口定义"><a href="#函数接口定义" class="headerlink" title="函数接口定义"></a>函数接口定义</h3><p>函数接口只是一个抽象方法的接口,用作lambda表达式类型.</p>
<p>注意, 上面这个定义有三个需要注意的地方</p>
<ol>
<li>函数接口是一个接口</li>
<li>函数接口有且只有一个抽象方法(只有一个表示数量上是唯一的,重载也是不可以)</li>
<li>函数接口用作lambda表达式类型</li>
</ol>
<h3 id="函数接口示例"><a href="#函数接口示例" class="headerlink" title="函数接口示例:"></a>函数接口示例:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 定义一个非泛型没有返回值没有参数的函数接口</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Run1</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFast</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 定义一个非泛型没有返回值有参数的函数接口</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Run2</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFast</span><span class="params">(<span class="keyword">int</span> seconds)</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 定义一个非泛型有返回值有参数的函数接口</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Run3</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">runFast</span><span class="params">(<span class="keyword">int</span> seconds)</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 定义一个泛型有返回值有参数的函数接口</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Run4</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">runFast</span><span class="params">(T t, <span class="keyword">int</span> seconds)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="默认方法"><a href="#默认方法" class="headerlink" title="默认方法"></a>默认方法</h3><p>我们知道java8对核心集合类进行了大幅度修改,例如<code>Collection</code>接口添加了<code>stream()</code>方法. 那么所有的<code>Collection</code>实现类都必须来实现该方法. 为了保持二进制接口的兼容性,java8提供了默认方法,来保证这一兼容性(例如来源在java1到jav7平台写出的代码仍然可以在java8平台上编译运行)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Run10</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFast</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">default</span> <span class="keyword">void</span> <span class="title">runAt9Clock</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"run10 runAt9Clock"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Run11</span>  <span class="keyword">extends</span> <span class="title">Run10</span> </span>&#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 调用</span></div><div class="line">Run11 run11 = () -&gt; &#123;</div><div class="line">	System.out.println();</div><div class="line">&#125;;</div><div class="line">run11.runAt9Clock();</div></pre></td></tr></table></figure></p>
<p>那么所有的子类都可以来调用这个默认方法, 而不必实现它。</p>
<blockquote>
<p>如果接口中只有一个默认方法,那么这个接口就不是接口函数.</p>
</blockquote>
<h4 id="继承默认方法"><a href="#继承默认方法" class="headerlink" title="继承默认方法"></a>继承默认方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Run11</span> <span class="keyword">extends</span> <span class="title">Run10</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">default</span> <span class="keyword">void</span> <span class="title">runAt9Clock</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"run11 runAt9Clock"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Run12</span> <span class="keyword">implements</span> <span class="title">Run10</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFast</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runAt9Clock</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"run12 runAt9Clock"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上面的例子中我们可以看到如果接口<code>Run11</code>继承了接口<code>Run10</code>, 同时重载了默认方法, 那么<code>Run11</code>中的默认方法也必须含有<code>default</code>关键字. 但是在类中重载的话,就可以不必存在了.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Run11 run11 = () -&gt; &#123;</div><div class="line">	System.out.println();</div><div class="line">&#125;;</div><div class="line">run11.runAt9Clock();</div><div class="line"></div><div class="line">Run12 run12 = <span class="keyword">new</span> Run12();</div><div class="line">run12.runAt9Clock();</div><div class="line"></div><div class="line"><span class="comment">//result</span></div><div class="line">run11 runAt9Clock</div><div class="line">run12 runAt9Clock</div></pre></td></tr></table></figure></p>
<p>接着我们都调用默认方法,我们发现当调用默认方法时都会优先调用子类中的方法.</p>
<h4 id="多重继承"><a href="#多重继承" class="headerlink" title="多重继承"></a>多重继承</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Run10</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">default</span> <span class="keyword">void</span> <span class="title">runAt9Clock</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"run10 runAt9Clock"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Run13</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">default</span> <span class="keyword">void</span> <span class="title">runAt9Clock</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"run13 runAt9Clock"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Run14</span> <span class="keyword">implements</span> <span class="title">Run10</span>, <span class="title">Run13</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runAt9Clock</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在上面这个情况下,我们需要手动在<code>Run14</code>这个类中指定重载哪个方法, 否则会产生编译错误：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Run14</span> <span class="keyword">implements</span> <span class="title">Run10</span>, <span class="title">Run13</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runAt9Clock</span><span class="params">()</span> </span>&#123;</div><div class="line">		Run10.<span class="keyword">super</span>.runAt9Clock();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="接口静态方法"><a href="#接口静态方法" class="headerlink" title="接口静态方法"></a>接口静态方法</h3><p>我们定义一个接口静态方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Run1</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFast</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runSlowly</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"run1 run slowly"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//</span></div><div class="line">Run1.runSlowly();</div></pre></td></tr></table></figure></p>
<p>需要注意的是：</p>
<ul>
<li>接口静态方法不会被继承到子接口或者子类中</li>
</ul>
<h3 id="FunctionalInterface"><a href="#FunctionalInterface" class="headerlink" title="@FunctionalInterface"></a>@FunctionalInterface</h3><p>所有的函数接口都应该添加<code>@FunctionalInterface</code>注释. 该注释会强制检查javac检查一个接口是否符合函数接口的标准. 如果将这个注释添加给类，枚举，多个方法的接口都会产生编译错误.</p>
<h2 id="lambda表达式"><a href="#lambda表达式" class="headerlink" title="lambda表达式"></a>lambda表达式</h2><h3 id="lambda表达式定义"><a href="#lambda表达式定义" class="headerlink" title="lambda表达式定义"></a>lambda表达式定义</h3><p>接下来我们根据上面定义的函数接口来定义一下lambda表达式<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 不带参数的版本</span></div><div class="line">Run1 run1 = () -&gt; &#123;</div><div class="line">	System.out.println(<span class="string">"I am running"</span>);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 参数要指定</span></div><div class="line">Run2 run2 = seconds -&gt; &#123;</div><div class="line">	System.out.println(<span class="string">"I am running "</span> + seconds + <span class="string">" seconds"</span>);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 下面这个版本就必须要有个返回值了</span></div><div class="line">Run3 run3 = seconds -&gt; &#123;</div><div class="line">	System.out.println(<span class="string">"I am running"</span>);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 我们在下面的版本中指定了它的泛型信息</span></div><div class="line">Run4&lt;String&gt; run4 = (name, seconds) -&gt; &#123;</div><div class="line">	System.out.println(name + <span class="string">" is running"</span>);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h3 id="lambda表达式使用"><a href="#lambda表达式使用" class="headerlink" title="lambda表达式使用"></a>lambda表达式使用</h3><p>接下来我们使用上面定义的lambda表达式<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">run1.runFast();</div><div class="line">-&gt; I am running</div><div class="line"></div><div class="line">run2.runFast(<span class="number">10</span>);</div><div class="line">-&gt; I am running <span class="number">10</span> seconds</div><div class="line"></div><div class="line"><span class="keyword">int</span> result = run3.runFast(<span class="number">10</span>);</div><div class="line">-&gt; I am running</div><div class="line"></div><div class="line">run4.runFast(<span class="string">"小狗"</span>, <span class="number">10</span>); 小狗 is running</div><div class="line">-&gt;</div></pre></td></tr></table></figure></p>
<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><p>我们引用lambda表达式外部的一个变量<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">String name = <span class="string">"sam"</span>;</div><div class="line">Run1 run1 = () -&gt; &#123;</div><div class="line">	System.out.println(name + <span class="string">" am running"</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>编译运行通过没有问题,但是如果我们将name在lambda表达式内部重新赋值的话</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">String name = <span class="string">"sam"</span>;</div><div class="line">Run1 run1 = () -&gt; &#123;</div><div class="line">	name = <span class="string">""</span>;</div><div class="line">	System.out.println(name + <span class="string">" am running"</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>会提示<code>variable used in lambda expression shouble be final</code>, 这说明lambda其实内部引用的是值而不是变量.</p>
<p>好,接下来我们换种方式再次验证一下我们的结果：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">String name = <span class="string">"sam"</span>;</div><div class="line">name = <span class="string">"Jams"</span>;</div><div class="line">Run1 run1 = () -&gt; &#123;</div><div class="line">	System.out.println(name + <span class="string">" am running"</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>同样的产生了编译错误.</p>
<h4 id="java中重要的函数接口"><a href="#java中重要的函数接口" class="headerlink" title="java中重要的函数接口"></a>java中重要的函数接口</h4><ul>
<li><code>Predicate&lt;T&gt;</code>: <code>boolean test(T t)</code> 判断输入的对象是否符合某个条件</li>
<li><code>Consumer&lt;T&gt;</code>: <code>void accept(T t);</code>  接收一个输入参数并且没有返回值</li>
<li><code>Supplier&lt;T&gt;</code>: <code>T get();</code>  可以看成一个对象的工厂，每次调用返回一个给定类型的对象</li>
<li><code>UnaryOperator&lt;T&gt;</code>: ``</li>
<li><code>BinaryOperator&lt;T&gt;</code>: ``</li>
</ul>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>在Java8中什么是函数呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Run1 run1 = () -&gt; &#123;</div><div class="line">	System.out.println(<span class="string">"I am running"</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>上面<code>run1</code>这个就代表一个函数. 一般我们把属于某个类的函数称为方法, 而不依赖于类而存在的函数称之为方法.</p>
<h3 id="高阶函数"><a href="#高阶函数" class="headerlink" title="高阶函数"></a>高阶函数</h3><p>如果某个函数A作为函数B的参数或者返回值, 那么我们称函数B为高阶函数,像下面的<code>run6</code>就是一个高级函数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Run6</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(Run1 run1)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Run6 run6 = run1Param -&gt; &#123;</div><div class="line">			System.out.println(<span class="string">"run6"</span>);</div><div class="line">			run1Param.runFast();</div><div class="line">		&#125;;</div><div class="line"></div><div class="line">run6.run(run1);</div></pre></td></tr></table></figure></p>
<p>我们将<code>run1</code>这个函数作为方法传递给了<code>run6</code>.</p>
<h4 id="返回函数"><a href="#返回函数" class="headerlink" title="返回函数"></a>返回函数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Run8</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String name, <span class="keyword">int</span> second, <span class="keyword">int</span> mils)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Run9</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> Run8 <span class="title">run</span><span class="params">(Run8 run8)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Run8 run8 = (name, second, mils) -&gt; &#123;</div><div class="line">	System.out.println();</div><div class="line">&#125;;</div><div class="line"></div><div class="line">Run9 run9 = run8Param -&gt; &#123;</div><div class="line">	<span class="keyword">return</span> run8Param.run(<span class="string">"lily"</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>在上述的例子中产生了编译错误, 在<code>Haskell</code>这种纯FP语言中可以将一个调用函数但是参数不完整的函数从某个参数中返回或者定义一个参数不完整的函数值.</p>
<h3 id="重载解析"><a href="#重载解析" class="headerlink" title="重载解析"></a>重载解析</h3><p>我们使用函数接口作为方法参数,然后进行重载<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 定义函数接口</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Run1</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFast</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Run2</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFast</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 定义重载代码</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(Run1 run1)</span></span>&#123;</div><div class="line">		System.out.println(<span class="string">"run1"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(Run2 run2)</span></span>&#123;</div><div class="line">		System.out.println(<span class="string">"run2"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"><span class="comment">// 定义运行代码</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">	run(() -&gt; System.out.println());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当我们进行如上定义时,javac提示了编译错误：不确定的方法调用,<code>run(Run1 run1)</code>和<code>run(Run2 run2)</code>都符合.</p>
<p>但是如果<code>Run2</code>继承了<code>Run1</code>这个接口之后<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Run1</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFast</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Run2</span> <span class="keyword">extends</span> <span class="title">Run1</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFast</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当我们运行测试代码之后,我们发现输出的<code>run2</code>.</p>
<p>当Lambda表达式作为参数时,其类型由它的目标类型推导得出,推导过程遵循如下规则：</p>
<ul>
<li>如果只有一个可能的目标类型,由相应的函数接口里的参数类型推导得出</li>
<li>如果有多个可能的目标类型，由最具体的类型推导得出</li>
<li>如果有多个可能的目标类型且最具体的类型不明确，则需要人为指定类型</li>
</ul>
<h2 id="方法引用"><a href="#方法引用" class="headerlink" title="方法引用"></a>方法引用</h2><p>方法引用是简洁的Lambda表达式，能够用于已经拥有名称的方法。</p>
<ul>
<li>静态方法 (ClassName::methName)</li>
<li>对象实例方法 (instanceRef::methName)</li>
<li>类型的实例方法 (ClassName::methName, 引用时和静态方法是一样的，但这里的 methName 是个实例方法)</li>
<li>构造方法 (ClassName::new)</li>
<li>数组的构造方法 (TypeName[]::new)</li>
</ul>
<h3 id="静态方法引用"><a href="#静态方法引用" class="headerlink" title="静态方法引用"></a>静态方法引用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		F f = Print::p;</div><div class="line">		f.m();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">p</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"Print"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@FunctionalInterface</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">F</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">m</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="类型实例方法引用"><a href="#类型实例方法引用" class="headerlink" title="类型实例方法引用"></a>类型实例方法引用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		F f = String::length;</div><div class="line">		<span class="keyword">int</span> len = f.m(<span class="string">"12"</span>);</div><div class="line">		System.out.println(len);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@FunctionalInterface</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">F</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">m</span><span class="params">(String p)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="构造方法引用"><a href="#构造方法引用" class="headerlink" title="构造方法引用"></a>构造方法引用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		F f = Print::<span class="keyword">new</span>;</div><div class="line">		Print p = f.m();</div><div class="line">		System.out.println(p == <span class="keyword">null</span>);	<span class="comment">// 结果为null</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@FunctionalInterface</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">F</span> </span>&#123;</div><div class="line">	<span class="function">Print <span class="title">m</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h3><p>Java8还提供了闭包这个特性,虽然我不知道闭包这个特性有啥用,但是还是实验了一下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Java8</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		I i = () -&gt; &#123;</div><div class="line">			C c = <span class="keyword">new</span> C();</div><div class="line">			c.count = <span class="number">10</span>;</div><div class="line"></div><div class="line">			J j = () -&gt; &#123;</div><div class="line">				System.out.println(<span class="string">"J print c:"</span> + c.count);</div><div class="line">				<span class="keyword">return</span> c;</div><div class="line">			&#125;;</div><div class="line"></div><div class="line">			System.out.println(<span class="string">"I print c:"</span> + c.count);</div><div class="line">			<span class="keyword">return</span> j;</div><div class="line">		&#125;;</div><div class="line"></div><div class="line">		J j = i.r();</div><div class="line">		C c = j.c();</div><div class="line">		c.count = <span class="number">20</span>;</div><div class="line">		System.out.println(<span class="string">"main print c:"</span> + c.count);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">I</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> J <span class="title">r</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">J</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> C <span class="title">c</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> count;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们定义了俩个接口, <code>I</code>和<code>J</code>, 我们在I的lambada中调用J的lambada, 然后让J返回一个定义在I的对象C, 最后我们在main函数中成功的返回了这个对象.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/09/08/JavaSE/Java8 lambda/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/09/08/JavaSE/Java8 lambda/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/3/"><span></span>Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="顯示側邊欄"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隱藏側邊欄"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="yu66" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">分類</p>
		<ul>
		
		  
			<li><a href="/categories/JVM/" title="JVM">JVM<sup>13</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java/" title="Java">Java<sup>18</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java-Library/" title="Java Library">Java Library<sup>28</sup></a></li>
		  
		
		  
			<li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/NoSql/" title="NoSql">NoSql<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/数据库/" title="数据库">数据库<sup>7</sup></a></li>
		  
		
		  
			<li><a href="/categories/算法/" title="算法">算法<sup>11</sup></a></li>
		  
		
		  
			<li><a href="/categories/编程语言/" title="编程语言">编程语言<sup>20</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">標簽</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Netty/" title="Netty">Netty<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/asm/" title="asm">asm<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Guice/" title="Guice">Guice<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情鏈接</p>
    <ul>
        
          <li>
            
            	<a href="http://vertx.yu66.wang/" target="_blank" title="vertx3">vertx3</a>
            
          </li>
        
    </ul>
</div>

  

<div class="doubanshow">
<p class="asidetitle">豆瓣秀</p>
<div>
<script type="text/javascript" src="http://www.douban.com/service/badge/xxxyy/?show=collection&amp;n=12&amp;columns=3&amp;hidelogo=yes&amp;hideself=yes&amp;cat=book|movie" ></script>
</div>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 訂閱</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=3253370782&verifier=e9ca895b&dpc=1"></iframe>
</div>


  

<div class="lofter">
<p class="asidetitle">Lofter</p>

 <iframe width="100%" height="39" class="share_self"  frameborder="0" scrolling="no" src="http://ming15.lofter.com/"></iframe>
</div>




</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 博客,我选择重构 <br/>
			重构使事情变得更美,更加正确</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/3253370782" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/yu66" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		<a href="https://www.douban.com/people/xxxyy" target="_blank" class="icon-douban" title="豆瓣"></a>
		
		
		<a href="http://www.zhihu.com/people/ming15" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2017 
		
		<a href="/about" target="_blank" title="大王玉">大王玉</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"wanggnim"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F9e8fca440159a2125668804e46682db4' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回頂部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
