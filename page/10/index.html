
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>·</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="王玉">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="·">
<meta property="og:url" content="http://www.yu66.wang/page/10/index.html">
<meta property="og:site_name" content="·">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="·">

    
    <link rel="alternative" href="/atom.xml" title="·" type="application/atom+xml">
    
    
    
    <link rel="apple-touch-icon" href="/img/author.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/author.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="·">·</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
						<form class="search" action="http://zhannei.baidu.com/cse/search" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= 17728547076946147000 ><input type="text" name="q" size="30" placeholder="Search"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/09/04/jvm/JVM 方法调用/" title="JVM方法调用" itemprop="url">JVM方法调用</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-09-04T07:00:00.000Z" itemprop="datePublished"> Published 2014-09-04</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="动态连接"><a href="#动态连接" class="headerlink" title="动态连接"></a>动态连接</h2><p>每个栈帧内部都包含一个指向运行时常量池的引用来支持当前方法的代码实现动态连接.在Class文件中,描述一个方法调用其他方法,或者访问其他成员变量是通过符号引用来表示的.动态连接就是将这些符号引用所表示的方法转换为实际方法的直接引用.<br>类加载的过程中将要解析尚未被解析的符号引用, 并且将变量访问转换为访问这些变量的存储结构所在的运行时内存位置的正确偏移量.由于动态连接的存在,通过晚期绑定使用的其他类的方法和变量在发生变化时,将不会对调用他们的方法构成影响</p>
<p>每个栈帧都包含一个指向运行时常量池中该栈帧所属的方法引用,持有这个引用是为了支持调用过程中的<code>动态连接</code>.Class文件的常量池中存有大量的符号引用,字节码中的方法调用指令就以常量池中指向方法的符号引用为参数. 这些符号引用一部分会在类加载阶段或第一次使用的时候转化为直接引用,这种转化称为静态解析. 另外一部分将在每一次的运行期间转化为直接引用,这部分称为动态连接</p>
<h2 id="方法正常调用完成"><a href="#方法正常调用完成" class="headerlink" title="方法正常调用完成"></a>方法正常调用完成</h2><p>当前栈帧承担着恢复调用者状态的责任, 其状态包括调用这的局部变量表, 操作数栈以及被正确增加用来表示执行了该方法调用指令的程序计数器等。使得调用者的代码能在被调用的方法返回并且返回值被压入调用者栈帧的操作数栈后继续正常执行</p>
<h2 id="方法调用非正常完成"><a href="#方法调用非正常完成" class="headerlink" title="方法调用非正常完成"></a>方法调用非正常完成</h2><p>指的是在方法调用过程了,某些指令导致了虚拟机抛出异常,而且虚拟机抛出的异常在该方法中没办法处理,或者在执行过程中遇到athrow字节码指令抛出的显式异常,同时在方法内部没有捕获异常</p>
<h2 id="方法返回地址"><a href="#方法返回地址" class="headerlink" title="方法返回地址"></a>方法返回地址</h2><p>当一个方法执行后,有俩个方式退出这个地址.第一种方式是执行引擎遇到任意一个方法返回的字节码指令,这时候可能会有返回值传递给上层的方法调用者(调用当前方法的方法称为调用者),是否有返回值和返回值的类型将根据遇到何种方法返回指令来决定,这种退出方法的方式为正常完成出口.</p>
<p>另一种退出的方法是,在方法执行过程中遇到了异常,并且这个异常没有在方法体内得到处理,无论虚拟机内部产生的异常,还是代码中使用athrow字节码之类产生的异常,只要在本方法的异常表中没有搜索到匹配的异常处理器,就会导致方法退出,这种退出方法的方式称为异常完成出口.一个方法使用异常完成出口的方式退出,是不会给它的上层调用者产生任何返回值的.</p>
<p>无论采用何种退出方法,在方法退出之后,都需要返回到方法被调用的位置,程序才能继续执行,方法返回时可能需要在栈帧中保存一些信息,用来帮助恢复它的上层方法的执行状态.一般来说,方法正常退出时,调用者的PC计数器的值就可以作为返回地址,栈帧中很可能会保存这个计数器值.而方法异常退出时,返回地址是要通过异常处理器表来确定的,栈帧中一般不会保存这部分信息.</p>
<p>方法退出的过程实际上等同于把当前栈帧出栈,因此退出时可能执行的操作有:回复上层方法的局部变量表和操作数栈,把返回值(如果有的话)压入调用者栈帧的操作数栈中,调整PC计数器的值以执行方法调用指令后面的一条指令等.</p>
<h2 id="方法调用"><a href="#方法调用" class="headerlink" title="方法调用"></a>方法调用</h2><p>方法调用并不等于方法执行,方法调用阶段唯一的任务就是确定方法的版本号(即调用哪个方法),暂时还不涉及方法内部的具体运行过程.在承运运行时,进行方法调用是最普遍,最频繁的的操作,单前面已经讲过,Class文件的编译过程中不包含传统编译的连接步骤,一切方法调用在Class文件里面存储的都只是符号引用,而不是方法在实际运行时内存布局中的入口地址(相当于之前的所说的直接引用).这个特性给java带来了更加强大的动态拓展能力,但也使得java方法的调用过程变得相对复杂起来,需要在类加载期间甚至到运行期间才能确定目标方法的直接引用.</p>
<h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><p>继续前面关于方法调用的话题,所有方法调用中的目标方法在Class文件里面都是一个常量池中的符号引用,在类加载的解析极端,会将其中的一部分符号引用转化为直接引用,这种解析能够成立的前提是:方法在程序真正运行之前就有一个可确定的调用版本,并且这个方法在运行期是不可改变的.换句话说,调用目标在程序代码写好,编译器进行编译时就必须确定下来.这类方法的调用称为<code>解析(Resolution)</code>.</p>
<p>在java语言中,符合”编译器可知,运行期不可变”这个要求的方法主要是有静态方法和私有方法俩大类,前者与类型直接关联,后者在外部不可被访问,这俩种方法都不可能通过继承或别的方式重写出其他版本,因此他们都适合在类加载阶段进行解析.</p>
<p>与之对应的是,在java虚拟机里面提供了四条方法调用字节码指令:</p>
<ul>
<li><code>invokestatic</code>: 调用静态方法</li>
<li><code>invokespecial</code>:调用实例构造器<code>&lt;init&gt;</code>方法,私有方法和父类方法</li>
<li><code>invokevirtual</code>:调用所有的虚方法</li>
<li><code>invokeinterface</code>:调用接口方法,会在运行时再确定一个实现此接口的对象</li>
</ul>
<p>只要能被<code>invokestatic</code>, <code>invokespecial</code>指令调用的方法,都可以在解析阶段确定唯一的版本,符合这个条件的有静态方法,私有方法,实例构造器和父类方法四类,他们在类加载的时候就会把符号引用解析为该方法的直接引用.这些方法可以称为<code>非虚方法</code>,与此相反,其他方法就称为<code>虚方法</code>(除了final方法).下面的例子中最常见的解析调用的例子,此样例中,静态方法<code>sayHello()</code>只可能属于类型<code>StaticResolution</code>,没有任何手段可以覆盖或者隐藏这个方法.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticResolution</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"hello"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        StaticResolution.sayHello();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过javap查看字节码:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public static void main(java.lang.String[]);</div><div class="line">   descriptor: ([Ljava/lang/String;)V</div><div class="line">   flags: ACC_PUBLIC, ACC_STATIC</div><div class="line">   Code:</div><div class="line">     stack=0, locals=1, args_size=1</div><div class="line">        0: invokestatic  #5                  // Method sayHello:()V</div><div class="line">        3: return</div><div class="line">     LineNumberTable:</div><div class="line">       line 9: 0</div><div class="line">       line 10: 3</div></pre></td></tr></table></figure></p>
<p>java中的非虚方法除了使用<code>invokestatic</code>和<code>invokespecial</code>调用的方法之外还有一种,就是被<code>final</code>修饰的方法.虽然<code>final</code>方法是使用<code>invokespecial</code>指令来调用的,但是由于它无法被覆盖,没有其他版本,所以也无须对方法接受者进行多态选择,又或者说多态选择的结果是唯一的.在java语言规范中明确说明了final方法是一种非虚方法.</p>
<p>解析调用一定是个静态过程,在编译期间就完全确定,在类装载的解析阶段就会把涉及的符号引用全部转变为可确定的直接引用,不会延迟到运行期再去完成.而分派调用则可能是静态的也可能是动态的,根据分派依据的宗数量可分为单分派和多分派.这俩类分派方式俩俩组合就构成了静态单分派,静态多分派,动态单分派,动态多分派.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/09/04/jvm/JVM 方法调用/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/09/04/jvm/JVM 方法调用/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/09/03/jvm/JVM 栈/" title="JVM栈" itemprop="url">JVM栈</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-09-03T07:00:00.000Z" itemprop="datePublished"> Published 2014-09-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>JVM栈和常用的数据结构很相似,都是一种先进后出的数据结构. JVM栈是每个线程私有的内存空间.线程的基本行为就是方法调用, 而方法调用就是通过JVM栈传递的.每当我们创建一个线程对象的的时候, 都会创建一个JVM栈. 它的生命周期与线程相同.</p>
<p>JVM栈是由JVM栈帧组成的, 每次方法调用都会有一个JVM栈帧进入JVM栈,也称入栈, 当方法执行完(不管是return还是异常),栈帧都会被弹出JVM栈,也称出栈. 栈帧包含如下结构:</p>
<ul>
<li>PC寄存器</li>
<li>本地方法栈</li>
<li>局部变量表</li>
<li>操作数栈</li>
<li>动态连接</li>
<li>方法出口</li>
</ul>
<p>在java虚拟机中.对这个区域规定了俩种异常情况:</p>
<ol>
<li>如果请求的栈深度大于虚拟机所允许的深度,抛出<code>StackOverflowError</code></li>
<li>如果虚拟机可以动态扩展,当拓展时无法申请到足够的内存时会抛出<code>OutOfMemoryError</code>异常</li>
</ol>
<h2 id="PC寄存器"><a href="#PC寄存器" class="headerlink" title="PC寄存器"></a>PC寄存器</h2><p>每当我们创建一个线程的时候, 都会JVM都会附带着创建一个本线程私有的PC寄存器和虚拟机栈. PC寄存器用于存放当前线程执行的字节码指令(线程当前方法)地址. 字节码解释器通过修改寄存器里的值使线程完成下一个指令的执行. 分支,循环,跳转,异常处理,线程恢复等基础功能都需要依赖这个寄存器完成. 在一个单CPU的环境中, 一个多线程的程序通过轮流切换线程完成多线程运行. 那么在切换线程的时候, 被切换的线程对应的寄存器里的值被保存了下来, 当线程再切换回来的时候,线程得以继续运行.</p>
<blockquote>
<p>PC寄存器是唯一一个在java虚拟机规范中没有规定任何<code>OutOfMemoryError</code>情况的区域.</p>
</blockquote>
<h2 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h2><ul>
<li>用来支持native方法</li>
</ul>
<h2 id="操作数栈"><a href="#操作数栈" class="headerlink" title="操作数栈"></a>操作数栈</h2><p>每个栈帧内部都包含一个称为操作数栈的先进后出栈. 同局部变量表一样,操作数栈的最大深度也是在编译的时候被写入到Code属性的max_stacks数据项之中的.操作数栈的每一个元素都可以是任意的java数据类型,包括long和double(一个long或者double类型的数据会占用俩个单位的栈深度, 其他类型占用一个单位的栈深度). 32位的数据类型所占的栈容量为1,64位数据类型所占的栈容量为2.在方法执行的时候,操作数栈的深度都不会超过在max_stacks数据项中设定的最大值. </p>
<p>栈帧在刚创建的时候, 操作数栈是空的, JVM提供了一系列指令从局部变量表或者对象实例的字段中复制常量或变量值到操作数栈中.也提供了一些列指令从操作数栈取走, 操作数据, 以及把结果重新入栈. 也就是入栈和出栈操作.例如:在做算术运算的时候是通过操作数栈来进行的,又或者在调用其他方法的时候是通过操作数栈来进行参数传递的.参考<a href="http://www.ming15.wang/2014/09/08/jvm/%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4/" target="_blank" rel="external">字节码指令</a></p>
<p>例如,整数加法的字节码指令iadd在运行的时候要求操作数栈中最接近栈顶的俩个元素已经存入了俩个int型的数值,当执行这个指令时,会将这俩个int值出栈并相加,然后将相加的结果入栈.</p>
<p>另外,在概念模型中,俩个栈帧为虚拟机栈的元素,相互之间是完全独立的.但是大多数虚拟机的实现里都会做一些优化处理,令俩个栈帧出现一部分重叠.让下面栈帧的部分操作数栈与上面栈帧的部分局部变量表重叠在一起,这样在进行方法调用时就可以共有一部分数据,而无需进行额外的参数复制传递:</p>
<h2 id="局部变量表"><a href="#局部变量表" class="headerlink" title="局部变量表"></a>局部变量表</h2><p>局部变量表存放基本类型的数据和对象的引用,但对象本身不存放在栈中,而是存放在堆中.</p>
<ul>
<li>其长度在编译器决定</li>
<li>一个局部变量称为一个Slot.每个Slot只可以保存一个<code>boolean, byte, char, short, int, float, reference,returnAddress</code>类型的数据.<code>long</code>或者<code>double</code>需要俩个Slot保存.</li>
<li>局部变量表来完成方法调用时的参数传递. (如果是实例方法, 第0个局部变量是用来存储调用实例方法的对象的引用)</li>
</ul>
<p>局部变量表中的Slot是可重用的, 我们看下面的例子:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CollectSlot</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">byte</span>[] byes3m = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">3</span> * <span class="number">1024</span> * <span class="number">1024</span>];</div><div class="line">		System.gc();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行一下上面的程序, 我们得到下面的结果<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">ζ java -XX:+PrintGCDetails -XX:MaxNewSize=1m -Xmx10M -Xms10M CollectSlot</div><div class="line">[GC (Allocation Failure) [PSYoungGen: 509K-&gt;488K(1024K)] 509K-&gt;504K(9728K), 0.0004559 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">[GC (System.gc()) [PSYoungGen: 745K-&gt;488K(1024K)] 3833K-&gt;3656K(9728K), 0.0005722 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">[Full GC (System.gc()) [PSYoungGen: 488K-&gt;0K(1024K)] [ParOldGen: 3168K-&gt;3614K(8704K)] 3656K-&gt;3614K(9728K), [Metaspace: 2572K-&gt;2572K(1056768K)], 0.0045062 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">Heap</div><div class="line"> PSYoungGen      total 1024K, used 10K [0x00000000ffe80000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 512K, 2% used [0x00000000ffe80000,0x00000000ffe82a68,0x00000000fff00000)</div><div class="line">  from space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 8704K, used 3614K [0x00000000ff600000, 0x00000000ffe80000, 0x00000000ffe80000)</div><div class="line">  object space 8704K, 41% used [0x00000000ff600000,0x00000000ff987840,0x00000000ffe80000)</div><div class="line"> Metaspace       used 2578K, capacity 4486K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 287K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">Java HotSpot(TM) 64-Bit Server VM warning: NewSize (1536k) is greater than the MaxNewSize (1024k). A new max generation size of 1536k will be used.</div></pre></td></tr></table></figure></p>
<p>在启动程序的时候, 我们将JVM堆内存设置为10M, 新生代为1M, 当我们在应用程序中分配3M内存的时候, byes3m这个对象就直接分配在了老年代中. 从GC日志的第一条中我们也可以看出, <code>[PSYoungGen: 509K-&gt;488K(1024K)]</code> 新生代已经使用了509k, 回收后488K, 总共1024k. 当调用<code>System.gc()</code>我们发现永久代的内存并没有回收掉，这也正是我们的预期</p>
<p>然后我们修改一下那个程序<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CollectSlot</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">byte</span>[] byes3m = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">3</span> * <span class="number">1024</span> * <span class="number">1024</span>];</div><div class="line">		byes3m = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">byte</span>[] byes3m_ = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">3</span> * <span class="number">1024</span> * <span class="number">1024</span>];</div><div class="line">		System.gc();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们将byes3m置为null, 看看其占用的内存会不会回收掉<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">ζ java -XX:+PrintGCDetails -XX:MaxNewSize=1m -Xmx10M -Xms10M CollectSlot</div><div class="line">[GC (Allocation Failure) [PSYoungGen: 509K-&gt;496K(1024K)] 509K-&gt;528K(9728K), 0.0005626 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">[GC (System.gc()) [PSYoungGen: 753K-&gt;488K(1024K)] 6929K-&gt;6744K(9728K), 0.0006016 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">[Full GC (System.gc()) [PSYoungGen: 488K-&gt;0K(1024K)] [ParOldGen: 6256K-&gt;3614K(8704K)] 6744K-&gt;3614K(9728K), [Metaspace: 2572K-&gt;2572K(1056768K)], 0.0045914 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">Heap</div><div class="line"> PSYoungGen      total 1024K, used 10K [0x00000000ffe80000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 512K, 2% used [0x00000000ffe80000,0x00000000ffe82a68,0x00000000fff00000)</div><div class="line">  from space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 8704K, used 3614K [0x00000000ff600000, 0x00000000ffe80000, 0x00000000ffe80000)</div><div class="line">  object space 8704K, 41% used [0x00000000ff600000,0x00000000ff987840,0x00000000ffe80000)</div><div class="line"> Metaspace       used 2578K, capacity 4486K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 287K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">Java HotSpot(TM) 64-Bit Server VM warning: NewSize (1536k) is greater than the MaxNewSize (1024k). A new max generation size of 1536k will be used.</div></pre></td></tr></table></figure></p>
<p>好，我们看到了<code>ParOldGen: 6256K-&gt;3614K(8704K)</code> 这句话, 说明已经有3M的内存被回收掉了。 </p>
<blockquote>
<p>赋null值的操作在经过虚拟机JIT编译器优化之后会被消除掉,这时候将变量设置为null实际上是没有意义的.因为我们的方法调用还没有达到JIT编译的次数, 因此在上面的例子中, 赋null值还是管用的, 但是在平时编码时,我们还是尽量不要依赖这种null赋值的操作</p>
</blockquote>
<p>下面我们再修改一下程序, 将其放在代码块中，这样placeholder1的slot就会被placeholder2复用,<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CollectSlot</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">byte</span>[] byes3m = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">3</span> * <span class="number">1024</span> * <span class="number">1024</span>];</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">byte</span>[] byes3m1 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">3</span> * <span class="number">1024</span> * <span class="number">1024</span>];</div><div class="line">		System.gc();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">ζ java -XX:+PrintGCDetails -XX:MaxNewSize=1m -Xmx10M -Xms10M CollectSlot</div><div class="line">[GC (Allocation Failure) [PSYoungGen: 509K-&gt;472K(1024K)] 509K-&gt;472K(9728K), 0.0006416 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">[GC (System.gc()) [PSYoungGen: 729K-&gt;488K(1024K)] 6873K-&gt;6752K(9728K), 0.0038950 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">[Full GC (System.gc()) [PSYoungGen: 488K-&gt;0K(1024K)] [ParOldGen: 6264K-&gt;3614K(8704K)] 6752K-&gt;3614K(9728K), [Metaspace: 2572K-&gt;2572K(1056768K)], 0.0045731 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">Heap</div><div class="line"> PSYoungGen      total 1024K, used 10K [0x00000000ffe80000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 512K, 2% used [0x00000000ffe80000,0x00000000ffe82a68,0x00000000fff00000)</div><div class="line">  from space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 8704K, used 3614K [0x00000000ff600000, 0x00000000ffe80000, 0x00000000ffe80000)</div><div class="line">  object space 8704K, 41% used [0x00000000ff600000,0x00000000ff987840,0x00000000ffe80000)</div><div class="line"> Metaspace       used 2578K, capacity 4486K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 287K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">Java HotSpot(TM) 64-Bit Server VM warning: NewSize (1536k) is greater than the MaxNewSize (1024k). A new max generation size of 1536k will be used.</div></pre></td></tr></table></figure></p>
<p>在上面的GC日志中,我们同样看到<code>ParOldGen: 6264K-&gt;3614K(8704K)</code>说明在代码块里面的那3M内存也已经被回收掉了. 这段内存能被回收的关键就是byes3m1复用了byes3m局部变量表中的Slot.因此byes3m原来指向的堆内存就不存在引用了,在GC时,这段内存就被回收掉了.但是如果没有byes3m1这个对象创建的话,byes3m的虽然离开了其作用域,但是由于GCRoots还关联着对其的引用,因此也是不会被回收的.</p>
<p>这种代码在绝大部分情况下影响都非常小, 但是如果一个方法中有一些很耗时的操作, 同时又分配了很大的内存, 将这些不再使用的占大内存的变量放到代码块中就是一个比较好的操作了，所以我们应该以恰当的作用域来控制变量回收时间。</p>
<p>关于局部变量表,还有一点可能会对实际开发产生影响,就是局部变量表不像前面介绍的类变量那样存在”准备阶段”.类变量有俩次赋初始值的过程,一次在准备阶段,赋予系统初始值.另外一次在初始化阶段,赋予程序员定义的初始化. 因此即使在初始化阶段程序员没有为类变量赋值也没关系,类变量仍然具有一个确定的初始值. 但是局部变量就不一样了,如果一个局部变量定义了但没有赋初始值是不能使用的.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/09/03/jvm/JVM 栈/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/09/03/jvm/JVM 栈/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/09/02/jvm/JVM 方法区/" title="JVM 方法区" itemprop="url">JVM 方法区</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-09-02T07:00:00.000Z" itemprop="datePublished"> Published 2014-09-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ul>
<li>虚拟机启动时创建</li>
<li>供各个线程共享的运行时内存</li>
<li>存储了每个类的结构信息, 运行时常量池, 静态变量,即时编译器编译后的代码, 方法数据, 构造函数, 普通方法的字节码内容</li>
<li>java虚拟机规范对这个区域的限制非常宽松,除了和java堆一样不需要连续的内存外,和可以实现固定大小或者可拓展的之外,还可以选择不实现垃圾收集.(在HotSop虚拟机中一般喜欢称这个区域为永久代)并非数据进入永久代就像其名字一样”永久存在”. 这个区域的回收目标是针对常量池的回收和对类型的卸载.</li>
<li>当方法区无法满足内存分配需求时,将抛出OutOfMemoryError.</li>
</ul>
<p>运行时常量池是方法区的一部分.</p>
<p>Class文件中除了有类的版本,字段,方法,接口等信息外,还有一项信息是常量池,用于存储编译器产生的各种字面量和符号引用.这部分内容将在类加载后存放到方法区的运行时常量池中.</p>
<p>运行时常量池相对于Class文件常量池的另外一个重要特征是具备动态性,java语言并不要求常量一定只能在编译器产生,也就是并非预置入Class文件常量池的内容才能进入方法区运行时常量池,运行期间也可能将新的常量放入常量池,这种特性被用到比较多的便是<code>String#intern()</code>在加载类和接口到虚拟机后就创建对应的常量池,其是Class文件中每个类或者接口常量池表的运行时表示.</p>
<p>它包含了从编译期克制的数值字面量到必须到运行期解析后才能获得的方法或字段引用</p>
<p>java 中的常量池,是为了方便快捷地创建某些对象而出现的,当需要一个对象时,就可以从池中取一个出来(如果池中没有则创建一个)， 则在需要重复创建相等变量时节省了很多时间 . 常量池其实也就是一个内存空间,不同于使用 <code>new</code> 关键字创建的对象所在的堆空间 . 常量池用来存放在编译期间就可以确定的数据,比如字符串等类型</p>
<p>在新生代,常规应用进行一次垃圾收集,一般可以收回70%-95%的空间,而永久代(方法区)远低于此.</p>
<p>永久代的垃圾回收主要是回收俩部分内容:</p>
<ul>
<li>废弃常量: 回收废弃常量与回收java堆中的对象非常类似.以常量池字面量回收为例,如果一个字符串”ABC”已经进入了常量池,但是当前系统中没有任何一个String对象是叫做”ABC”的,换句话说也就是没有任何String对象引用这个字面量,也没有其他地方引用这个字面量,如果这个时候发生内存回收,而且必要的话,这个”ABC”常量会被清除出常量池.常量池中的其他类(皆苦),方法,字段的符号引用也与此类似.</li>
<li>无用的类</li>
</ul>
<p>判断一个类是否是无用的类条件要苛刻的多. 要同时满足下面三个条件:</p>
<ol>
<li>该类的所有实例都已经被回收,也就是java堆中不存在该类的实例.<br.></br.></li>
<li>加载该类的ClassLoader已经被回收.<br.></br.></li>
<li>该类对应的java.lang.Class对象没有在任何地方被引用,无法在任何地方通过反射访问该类.</li>
</ol>
<p>虚拟机可以对满足上面三个条件的类进行回收,这里说的仅仅是可以,而不是和对象一样,不使用了就必然回收.是否对类进行回收HotSpot虚拟机提供了-Xnoclassgc参数进行控制,还可以使用<code>-verbose:Class</code>及<br><code>-XX:+TraceClassLoading</code>,<code>-XX:+TraceClassUnLoading</code>查看类的加载和卸载信息.<code>-verbose:Class</code>和<code>-XX:+TraceClassLoading</code>可以在Product版的虚拟机中使用,但是<code>-XX:+TraceClassLoading</code>参数需要fastdebug版的虚拟机支持</p>
<p>静态存储里存放程序运行时一直存在的数据 . 可用关键字 static 来标识一个对象的特定元素是静态的,被static 修饰的成员变量和成员方法独立于该类的任何对象,它不依赖类特定的实例,被类的所有实例共享 . 但 JAVA 对象本身不会存放在静态存储空间里,而只是把对象中的一些特殊元素放置这里 .</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/09/02/jvm/JVM 方法区/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/09/02/jvm/JVM 方法区/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/09/02/jvm/JVM 直接内存/" title="JVM 直接内存" itemprop="url">JVM 直接内存</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-09-02T07:00:00.000Z" itemprop="datePublished"> Published 2014-09-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>直接内存并不是虚拟机运行时数据区的一部分,也不是java虚拟机规范中定义的内存区域,但是这部分内存也被频繁使用,而且也会导致OutOfMemoryError异常出现</p>
<p>在JDK1.4引入的NIO类,一种基于通道与缓冲区的I/O方式,它可以利用Native函数库直接分配堆外内存,然后通过一个存储在java堆里面的DirectByteBuffer对象作为这块内存的引用进行操作.这样能在一些场景中显著提高性能,因为避免了java堆和Native堆中来回复制数据.</p>
<p>显然本机直接内存的分配不会收到java堆大小的限制,但是既然是内存,则肯定会收到本机总内存(包括RAM及SWAP区或者分页文件)及处理器寻址空间的限制.一般在配置虚拟机参数时,会genuine实际内存设置-Xmx等参数信息,但经常会忽略掉直接内存,使得各个区域的总和大于物理内存限制,从而导致动态拓展时,出现OutOfMemoryError.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/09/02/jvm/JVM 直接内存/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/09/02/jvm/JVM 直接内存/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/09/02/jvm/JVM 堆内存/" title="JVM 堆内存" itemprop="url">JVM 堆内存</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-09-02T07:00:00.000Z" itemprop="datePublished"> Published 2014-09-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>我们首先看一下JVM堆内存的特点</p>
<ul>
<li>是供各个线程共享的运行时内存</li>
<li>所有类实例和数组对象分配内存的地方</li>
<li>存储了内存管理系统(GC)</li>
<li>堆内存可以处于物理上不连续的内存空间中,逻辑上是连续的即可.</li>
<li>如果在堆内中没有内存完成实例分配,而且堆无法再拓展时,会抛出OutOfMemoryError</li>
<li>随着JIT编译器的发展和逃逸分析技术的逐渐成熟,栈上分配,标量替换优化技术将会导致一些变化,所有的对象在堆上分配也不是那么绝对了</li>
</ul>
<p>然后我们看一下堆内存内部分配: 由于现在GC收集器基本都是采用的分代收集算法,所以java堆还可以细分为:新生代和老年代.分的再细一点还有Eden空间,From Survivor空间,To Sruvivor空间.</p>
<h2 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a>内存分配</h2><ol>
<li>新生代GC(<code>Minor GC</code>)：新生代GC, Java对象大多都朝生夕灭,所以<code>Minor GC</code>非常频繁,回收速度也比较快.</li>
<li>老年代GC(<code>Major GC/Full GC</code>)：老年代GC,出现了Major GC,经常会伴随至少一次的Minor GC. MajorGC的速度一般会比Minor GC慢10倍以上.</li>
</ol>
<h2 id="引用计数算法"><a href="#引用计数算法" class="headerlink" title="引用计数算法"></a>引用计数算法</h2><p>引用计数算法很难解决对象之间相互循环引用的问题<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceCountingGC</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> Object instance = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> _1MB = <span class="number">3</span> * <span class="number">1024</span> * <span class="number">1024</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">byte</span>[] bigSize = <span class="keyword">new</span> <span class="keyword">byte</span>[_1MB];</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		&#123;</div><div class="line">			ReferenceCountingGC obj1 = <span class="keyword">new</span> ReferenceCountingGC();</div><div class="line">			ReferenceCountingGC obj2 = <span class="keyword">new</span> ReferenceCountingGC();</div><div class="line"></div><div class="line">			obj1.instance = obj2;</div><div class="line">			obj2.instance = obj1;</div><div class="line">		&#125;</div><div class="line">		System.gc();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们运行<code>-XX:+PrintGCDetails -Xmx10M -Xms10M</code>得到结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[GC (System.gc()) [PSYoungGen: 1650K-&gt;504K(2560K)] 7794K-&gt;7001K(9728K), 0.0029060 secs] [Times: user=0.05 sys=0.00, real=0.00 secs]</div><div class="line">[Full GC (System.gc()) [PSYoungGen: 504K-&gt;0K(2560K)] [ParOldGen: 6497K-&gt;6952K(7168K)] 7001K-&gt;6952K(9728K), [Metaspace: 3051K-&gt;3051K(1056768K)], 0.0104574 secs] [Times: user=0.00 sys=0.00, real=0.01 secs]</div><div class="line">Heap</div><div class="line"> PSYoungGen      total 2560K, used 41K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 2048K, 2% used [0x00000000ffd00000,0x00000000ffd0a560,0x00000000fff00000)</div><div class="line">  from space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line"> ParOldGen       total 7168K, used 6952K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)</div><div class="line">  object space 7168K, 96% used [0x00000000ff600000,0x00000000ffcca158,0x00000000ffd00000)</div><div class="line"> Metaspace       used 3058K, capacity 4494K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 331K, capacity 386K, committed 512K, reserved 1048576K</div></pre></td></tr></table></figure></p>
<p>我们看到GC之后这块内存并没有回收掉</p>
<h2 id="根搜索算法"><a href="#根搜索算法" class="headerlink" title="根搜索算法"></a>根搜索算法</h2><p>这个算法的基本思想是:通过一系列的名为”GC Roots”的对象作为起始点, 从这些起始点开始向下搜索,搜索所走过的路径称为引用链,当一个对象到GC Roots没有任何引用链时,则证明这个对象是不可到达的.</p>
<p>在java中可作为GC Roots的对象包括以下几种:</p>
<ol>
<li>虚拟机栈(栈帧中的本地变量表)中的引用对象.</li>
<li>方法区中的类静态属性引用的对象.</li>
<li>方法区中的常量引用对象</li>
<li>本地方法栈中JNI的引用的对象</li>
</ol>
<h3 id="新生代"><a href="#新生代" class="headerlink" title="新生代"></a>新生代</h3><p>新生代分为Eden区和Survivor区(Eden有一个, Survivor有俩个). 大多数情况下,对象在新生代<code>Eden</code>区中分配.当<code>Eden</code>区没有足够的空间进行分配时,虚拟机将发起一次<code>Minor GC</code>, 将存活下来的对象移动到一个Survivor区中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> _1MB = <span class="number">1024</span> * <span class="number">1024</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * VM参数：-verbose:gc -Xms20M -Xmx20M -Xmn10M -XX:SurvivorRatio=8</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testAllocation</span><span class="params">()</span> </span>&#123;</div><div class="line">	    <span class="keyword">byte</span>[] allocation1, allocation2, allocation3, allocation4;</div><div class="line">	    allocation1 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span> * _1MB];</div><div class="line">	    allocation2 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span> * _1MB];</div><div class="line">	    allocation3 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span> * _1MB];</div><div class="line">	    allocation4 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span> * _1MB];  <span class="comment">// 出现一次Minor GC</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>分析如下：</p>
<ol>
<li>首先在堆中分配3个2MB大小和1个4MB大小的byte数组, 在运行时通过<code>-Xms20M、 -Xmx20M</code>和<code>-Xmn10M</code>这3个参数限制Java堆大小为20MB,且不可扩展,其中10MB分配给新生代,剩下的10MB分配给老年代.</li>
<li><code>-XX:SurvivorRatio=8</code>决定了新生代中Eden区与一个<code>Survivor</code>区的空间比例是8比1,从输出的结果也能清晰地看到<code>“eden space 8192K、from space 1024K、to space 1024K”</code>的信息,新生代总可用空间为<code>9216KB</code>(<code>Eden</code>区+1个<code>Survivor</code>区的总容量).</li>
<li>执行<code>testAllocation()</code>中分配<code>allocation4</code>对象的语句时会发生一次Minor GC,这次GC的结果是新生代6651KB变为148KB,而总内存占用量则几乎没有减少(因为allocation1、2、3三个对象都是存活的,虚拟机几乎没有找到可回收的对象).</li>
<li>这次GC发生的原因是给allocation4分配内存的时候,发现Eden已经被占用了6MB,剩余空间已不足以分配allocation4所需的4MB内存,因此发生Minor GC.GC期间虚拟机又发现已有的3个2MB大小的对象全部无法放入Survivor空间(Survivor空间只有1MB大小),所以只好通过分配担保机制提前转移到老年代去.</li>
<li>这次GC结束后,4MB的allocation4对象被顺利分配在Eden中.因此程序执行完的结果是Eden占用4MB(被allocation4占用),Survivor空闲,老年代被占用6MB(被allocation1、2、3占用)</li>
</ol>
<h3 id="老年代"><a href="#老年代" class="headerlink" title="老年代"></a>老年代</h3><p>大对象和长期存活的对象会进入老年代。所谓大对象就是指,需要大量连续内存空间的Java对象,最典型的大对象就是那种很长的字符串及数组. 如果连续出现多个大对象, 会导致老年代频繁发生<code>Full GC</code>, 因此在写程序时应该避免频繁出现大对象.</p>
<p>我们可以使用<code>-XX:PretenureSizeThreshold</code>参数令大于这个值的对象直接在老年代中分配. 这样做的目的是避免在Eden区及两个Survivor区之间发生大量的内存拷贝(新生代采用复制算法收集内存).</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> _1MB = <span class="number">1024</span> * <span class="number">1024</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * VM参数：-verbose:gc -Xms20M -Xmx20M -Xmn10M -XX:SurvivorRatio=8</div><div class="line">  * -XX:PretenureSizeThreshold=3145728</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testPretenureSizeThreshold</span><span class="params">()</span> </span>&#123;</div><div class="line">	　<span class="keyword">byte</span>[] allocation;</div><div class="line">	　allocation = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span> * _1MB];  <span class="comment">//直接分配在老年代中</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们看到Eden空间几乎没有被使用,而老年代10MB的空间被使用了40%,也就是4MB的allocation对象直接就分配在老年代中,这是因为<code>PretenureSizeThreshold</code>被设置为3MB(就是3145728B,这个参数不能与<code>-Xmx</code>之类的参数一样直接写3MB),因此超过3MB的对象都会直接在老年代中进行分配.</p>
<blockquote>
<p>注意<code>PretenureSizeThreshold</code>参数只对Serial和ParNew两款收集器有效,<code>Parallel Scavenge</code>收集器不认识这个参数,<code>Parallel Scavenge</code>收集器一般并不需要设置.如果遇到必须使用此参数的场合,可以考虑ParNew加CMS的收集器组合.</p>
</blockquote>
<p>虚拟机给每个对象定义了一个对象年龄(Age)计数器.如果对象在Eden出生并经过第一次Minor GC后仍然存活,    并且能被Survivor容纳的话,将被移动到Survivor空间中,并将对象年龄设为1.对象在Survivor区中每熬过一次Minor GC,年龄就增加1岁,当它的年龄增加到一定程度(默认为15岁)时,就会被晋升到老年代中.对象晋升老年代的年龄阈值,可以通过参数<code>-XX:MaxTenuringThreshold</code>来设置.</p>
<p>大家可以分别以<code>-XX:MaxTenuringThreshold=1</code>和<code>-XX:MaxTenuringThreshold=15</code>两种设置来执行刚才示例. 例子中allocation1对象需要256KB的内存空间,Survivor空间可以容纳.当MaxTenuringThreshold=1时,allocation1对象在第二次GC发生时进入老年代,新生代已使用的内存GC后会非常干净地变成0KB.而MaxTenuringThreshold=15时,第二次GC发生后,allocation1对象则还留在新生代Survivor空间,这时候新生代仍然有404KB的空间被占用.</p>
<p>实例代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> _1MB = <span class="number">1024</span> * <span class="number">1024</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * VM参数：-verbose:gc -Xms20M -Xmx20M -Xmn10M</div><div class="line">  * -XX:SurvivorRatio=8 -XX:MaxTenuringThreshold=1</div><div class="line">  * -XX:+PrintTenuringDistribution</div><div class="line">  */</div><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testTenuringThreshold</span><span class="params">()</span> </span>&#123;</div><div class="line">	 <span class="keyword">byte</span>[] allocation1, allocation2, allocation3;</div><div class="line">	 allocation1 = <span class="keyword">new</span> <span class="keyword">byte</span>[_1MB / <span class="number">4</span>];</div><div class="line">	  <span class="comment">// 什么时候进入老年代取决于XX:MaxTenuringThreshold设置</span></div><div class="line">	 allocation2 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span> * _1MB];</div><div class="line">	 allocation3 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span> * _1MB];</div><div class="line">	 allocation3 = <span class="keyword">null</span>;</div><div class="line">	 allocation3 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span> * _1MB];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="动态年龄判断"><a href="#动态年龄判断" class="headerlink" title="动态年龄判断"></a>动态年龄判断</h4><p>为了能更好地适应不同程序的内存状况,虚拟机并不总是要求对象的年龄必须达到<code>MaxTenuringThreshold</code>才能晋升老年代,如果在<code>Survivor</code>空间中相同年龄所有对象大小的总和大于<code>Survivor</code>空间的一半,年龄大于或等于该年龄的对象就可以直接进入老年代,无须等到<code>MaxTenuringThreshold</code>中要求的年龄.</p>
<p>例如下例中设置参数<code>-XX: MaxTenuringThreshold=15</code>,会发现运行结果中<code>Survivor</code>的空间占用仍然为0%,而老年代比预期增加了<code>6%</code>,也就是说<code>allocation1、allocation2</code>对象都直接进入了老年代,而没有等到15岁的临界年龄.因为这两个对象加起来已经达到了512KB,并且它们是同年的,满足同年对象达到Survivor空间的一半规则.我们只要注释掉其中一个对象的new操作,就会发现另外一个不会晋升到老年代中去了.</p>
<p>示例代码<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">private static final int _1MB = 1024 #### 1024;</div><div class="line"></div><div class="line">/**</div><div class="line">  * VM参数：-verbose:gc -Xms20M -Xmx20M -Xmn10M</div><div class="line">  * -XX:SurvivorRatio=8 -XX:MaxTenuringThreshold=15</div><div class="line">  * -XX:+PrintTenuringDistribution</div><div class="line">  */</div><div class="line">@SuppressWarnings("unused")</div><div class="line">public static void testTenuringThreshold2() &#123;</div><div class="line">	 byte[] allocation1, allocation2, allocation3, allocation4;</div><div class="line">	 allocation1 = new byte[_1MB / 4];</div><div class="line">	  // allocation1+allocation2大于survivor空间的一半</div><div class="line">	 allocation2 = new byte[_1MB / 4];</div><div class="line">	 allocation3 = new byte[4 #### _1MB];</div><div class="line">	 allocation4 = new byte[4 #### _1MB];</div><div class="line">	 allocation4 = null;</div><div class="line">	 allocation4 = new byte[4 #### _1MB];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="空间分配担保"><a href="#空间分配担保" class="headerlink" title="空间分配担保"></a>空间分配担保</h3><p>在发生Minor GC时,虚拟机会检测之前每次晋升到老年代的平均大小是否大于老年代的剩余空间大小,如果大于,则改为直接进行一次Full GC.如果小于,则查看HandlePromotionFailure设置是否允许担保失败;如果允许,那只会进行Minor GC;如果不允许,则也要改为进行一次Full GC.</p>
<p>前面提到过,新生代使用复制收集算法,但为了内存利用率,只使用其中一个Survivor空间来作为轮换备份,因此当出现大量对象在Minor GC后仍然存活的情况时(最极端就是内存回收后新生代中所有对象都存活),就需要老年代进行分配担保,让Survivor    无法容纳的对象直接进入老年代.与生活中的贷款担保类似,老年代要进行这样的担保,前提是老年代本身还有容纳这些对象的    剩余空间,一共有多少对象会活下来,在实际完成内存回收之前是无法明确知道的,所以只好取之前每一次回收晋升到老年代对象容量的平均大小值作为经验值,与老年代的剩余空间进行比较,决定是否进行Full GC来让老年代腾出更多空间.</p>
<p>取平均值进行比较其实仍然是一种动态概率的手段,也就是说如果某次Minor GC存活后的对象突增,远远高于平均值的话,依然会导致担保失败(Handle Promotion Failure).如果出现了HandlePromotionFailure失败,    那就只好在失败后重新发起一次Full GC.虽然担保失败时绕的圈子是最大的,但大部分情况下都还是会将    HandlePromotionFailure开关打开,避免Full GC过于频繁,</p>
<p>示例代码<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">private static final int _1MB = 1024 #### 1024;</div><div class="line"></div><div class="line">/**</div><div class="line">  * VM参数：-verbose:gc -Xms20M -Xmx20M -Xmn10M</div><div class="line">  * -XX:SurvivorRatio=8 -XX:-HandlePromotionFailure</div><div class="line">  */</div><div class="line">@SuppressWarnings("unused")</div><div class="line">public static void testHandlePromotion() &#123;</div><div class="line">	 byte[] allocation1, allocation2, allocation3,</div><div class="line">	 allocation4, allocation5, allocation6, allocation7;</div><div class="line">	 allocation1 = new byte[2 #### _1MB];</div><div class="line">	 allocation2 = new byte[2 #### _1MB];</div><div class="line">	 allocation3 = new byte[2 #### _1MB];</div><div class="line">	 allocation1 = null;</div><div class="line">	 allocation4 = new byte[2 #### _1MB];</div><div class="line">	 allocation5 = new byte[2 #### _1MB];</div><div class="line">	 allocation6 = new byte[2 #### _1MB];</div><div class="line">	 allocation4 = null;</div><div class="line">	 allocation5 = null;</div><div class="line">	 allocation6 = null;</div><div class="line">	 allocation7 = new byte[2 #### _1MB];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/09/02/jvm/JVM 堆内存/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/09/02/jvm/JVM 堆内存/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/09/01/jvm/JVM 参数 -- 内存设置/" title="JVM 参数 -- 内存设置" itemprop="url">JVM 参数 -- 内存设置</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-09-01T07:00:00.000Z" itemprop="datePublished"> Published 2014-09-01</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a>内存分配</h2><h3 id="Xmx"><a href="#Xmx" class="headerlink" title="Xmx"></a>Xmx</h3><p>这个参数设置可用的最大堆内存, 如果我们不使用这个参数,在Mac平台上,默认分配的堆内存为1431M.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] main)</span> </span>&#123;</div><div class="line">		<span class="keyword">long</span> maxMemory = Runtime.getRuntime().maxMemory();</div><div class="line"></div><div class="line">		System.out.println(maxMemory / <span class="number">1000</span> / <span class="number">1000</span> + <span class="string">"M"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当我们使用上<code>-Xmx1m</code>的时候,我们手动地将堆内存设置为1m, 通过刚才的程序输出,确实是最大的内存为1m.  在这个例子中我们还要注意到, 在JVM分配内存时候, 1M = 1000KBM, 而不是1024KBM</p>
<h3 id="Xss"><a href="#Xss" class="headerlink" title="Xss"></a>Xss</h3><p>这个参数用来分配线程最大的栈空间, 这个参数决定了方法调用的最大的次数. 如果我们不使用这个参数,在mac平台上大概能进行16000个方法调用. 这个参数可设置的最小值为160k. 当我们设置上160k的时候, 程序能调用818次的方法调用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> count = <span class="number">0</span>;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] main)</span> </span>&#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			invokeSelf();</div><div class="line">		&#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">			System.out.println(<span class="string">"invoke:"</span> + count);</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeSelf</span><span class="params">()</span> </span>&#123;</div><div class="line">		count++;</div><div class="line">		invokeSelf();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们知道在java的方法调用就是在栈帧不断地在java栈中出栈入栈, 因此栈帧的大小也影响着方法的调用次数.  栈帧是由局部变量表,操作数栈,和帧数据几个部分组成.</p>
<p>下面我们测试一下将上例的递归函数加入一个参数,看看调用次数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> count = <span class="number">0</span>;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] main)</span> </span>&#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			invokeSelf(count);</div><div class="line">		&#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">			System.out.println(<span class="string">"invoke:"</span> + count);</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeSelf</span><span class="params">(<span class="keyword">long</span> times)</span> </span>&#123;</div><div class="line">		count++;</div><div class="line">		invokeSelf(times);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这次的调用次数成了682次,说明局部变量表确实是在影响方法调用的次数.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> count = <span class="number">0</span>;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] main)</span> </span>&#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			invokeSelf(count);</div><div class="line">		&#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">			System.out.println(<span class="string">"invoke:"</span> + count);</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeSelf</span><span class="params">(<span class="keyword">long</span> times)</span> </span>&#123;</div><div class="line">		count++;</div><div class="line">		<span class="keyword">int</span> newCount = (<span class="keyword">int</span>)count;</div><div class="line">		invokeSelf(times);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这次我添加了一个中间过程,调用次数变成了629</p>
<p>本想这个次数是针对一个线程的设置还是个共享值, 但是在多线程的情况下,明显的出现了难以预料的结果,他的调用次数有了明显的提升<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> count = <span class="number">0</span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] main)</span> </span>&#123;</div><div class="line"></div><div class="line">        Runnable runnable = () -&gt; &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                invokeSelf(count);</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">                System.out.println(<span class="string">"invoke : "</span> + count);</div><div class="line">    <span class="comment">//            e.printStackTrace();</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        Runnable runnable2 = () -&gt; &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                invokeSelf2(count);</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">                System.out.println(<span class="string">"invoke : "</span> + count);</div><div class="line">                <span class="comment">//            e.printStackTrace();</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        Thread t = <span class="keyword">new</span> Thread(runnable);</div><div class="line">        Thread t2 = <span class="keyword">new</span> Thread(runnable2);</div><div class="line">        t.start();</div><div class="line">        t2.start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeSelf</span><span class="params">(<span class="keyword">long</span> times)</span> </span>&#123;</div><div class="line">        count++;</div><div class="line">        <span class="keyword">int</span> newCount = (<span class="keyword">int</span>)count;</div><div class="line">        invokeSelf(times);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeSelf2</span><span class="params">(<span class="keyword">long</span> times)</span> </span>&#123;</div><div class="line">        count++;</div><div class="line">        <span class="keyword">int</span> newCount = (<span class="keyword">int</span>)count;</div><div class="line">        invokeSelf2(times);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个很奇怪,<br>结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">invoke : <span class="number">1083</span></div><div class="line">invoke : <span class="number">1083</span></div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">invoke : <span class="number">650</span></div><div class="line">invoke : <span class="number">1300</span></div></pre></td></tr></table></figure></p>
<p>要不然次数是一样的,要不然次数是个倍数的关系</p>
<h3 id="MaxPermSize"><a href="#MaxPermSize" class="headerlink" title="MaxPermSize"></a>MaxPermSize</h3><p><code>-XX:MaxPermSize</code>:永久代的最大值</p>
<h3 id="ms"><a href="#ms" class="headerlink" title="ms"></a>ms</h3><p><code>-XX:ms</code>:初始堆大小</p>
<h3 id="mn"><a href="#mn" class="headerlink" title="mn"></a>mn</h3><p><code>-XX:</code>:设置年轻代大小.整个JVM内存大小=年轻代大小+年老代大小+持久代大小.(Xms必须大于Xmn)</p>
<h3 id="NewSize"><a href="#NewSize" class="headerlink" title="NewSize"></a>NewSize</h3><p><code>-XX:NewSize=2m</code>:新生代默认大小(单位是字节)</p>
<h3 id="MaxNewSize"><a href="#MaxNewSize" class="headerlink" title="MaxNewSize"></a>MaxNewSize</h3><p><code>-XX:MaxNewSize=size</code>:新生代最大值(单位字节)</p>
<h3 id="ThreadStackSize"><a href="#ThreadStackSize" class="headerlink" title="ThreadStackSize"></a>ThreadStackSize</h3><p><code>-XX:ThreadStackSize=512</code>:线程堆栈大小(单位Kbytes,0使用默认大小)</p>
<h3 id="SurvivorRatio"><a href="#SurvivorRatio" class="headerlink" title="SurvivorRatio"></a>SurvivorRatio</h3><p><code>-XX:SurvivorRatio=6</code>:新生代中Eden区和Survivor区的容量比值(默认为8)</p>
<h3 id="PretenureSizeThreshold"><a href="#PretenureSizeThreshold" class="headerlink" title="PretenureSizeThreshold"></a>PretenureSizeThreshold</h3><p><code>-XX:PretenureSizeThreshold</code>:直接晋升到老年代的对象大小,设置这个参数后,大于这个参数的对象将直接在老年代分配</p>
<h3 id="MaxTenuringThreshold"><a href="#MaxTenuringThreshold" class="headerlink" title="MaxTenuringThreshold"></a>MaxTenuringThreshold</h3><p><code>-XX:MaxTenuringThreshold</code>:晋升到老年代的对象年龄,每个对象在坚持过一次MinorGC之后,年龄就+1,当超过这个参数值时就进入老年代</p>
<h3 id="UseAdaptiveSizePolicy"><a href="#UseAdaptiveSizePolicy" class="headerlink" title="UseAdaptiveSizePolicy"></a>UseAdaptiveSizePolicy</h3><p><code>-XX:UseAdaptiveSizePolicy</code>:动态调整java堆中各个区域的大小及进入老年代的年龄</p>
<blockquote>
<p>吞吐量垃圾回收器利用了一种叫做自适应大小的特性，自适应大小是基于对象的分配和存活率来自动改变eden空间和survivor空间大小，目的是优化对象的岁数分布。自适应大小的企图是提供易用性，容易优化JVM，以致于提供可靠的吞吐量</p>
</blockquote>
<h3 id="HandlePromotionFailure"><a href="#HandlePromotionFailure" class="headerlink" title="HandlePromotionFailure"></a>HandlePromotionFailure</h3><p><code>-XX:HandlePromotionFailure</code>:是否允许分配担保失败,即老年代的剩余空间不足以应付新生代的整个Eden和Survivor区的所有对象都存活的极端情况</p>
<h3 id="UseTLAB"><a href="#UseTLAB" class="headerlink" title="UseTLAB"></a>UseTLAB</h3><p><code>-XX:UseTLAB</code>:优先在本地线程缓冲区中分配对象,避免分配内存时的锁定过程</p>
<h3 id="NewRatio"><a href="#NewRatio" class="headerlink" title="NewRatio"></a>NewRatio</h3><p><code>-XX:NewRatio=n</code>:老年代与新生代比例(默认是2).</p>
<h3 id="MaxHeapFreeRatio"><a href="#MaxHeapFreeRatio" class="headerlink" title="MaxHeapFreeRatio"></a>MaxHeapFreeRatio</h3><p><code>-XX:MaxHeapFreeRatio</code>:当Xmx值比Xms值大时,堆可以动态收缩和扩展,这个参数控制当堆空闲大于指定比率时自动收缩</p>
<h3 id="MinHeapFreeRatio"><a href="#MinHeapFreeRatio" class="headerlink" title="MinHeapFreeRatio"></a>MinHeapFreeRatio</h3><p><code>-XX:MinHeapFreeRatio</code>:当Xmx值比Xms值大时,堆可以动态收缩和扩展,这个参数控制当堆空闲小于指定比率时自动收缩</p>
<h2 id="设置GC"><a href="#设置GC" class="headerlink" title="设置GC"></a>设置GC</h2><h3 id="DisableExplicitGC"><a href="#DisableExplicitGC" class="headerlink" title="DisableExplicitGC"></a>DisableExplicitGC</h3><p><code>-XDisableExplicitGC</code> 忽略来自System.gc()方法触发的垃圾收集</p>
<h3 id="GCTimeRatio"><a href="#GCTimeRatio" class="headerlink" title="GCTimeRatio"></a>GCTimeRatio</h3><p><code>-XX:</code>:GC时间占总时间的比率.仅在使用ParallelScavenge收集器时生效</p>
<h3 id="MaxGCPauseMillis"><a href="#MaxGCPauseMillis" class="headerlink" title="MaxGCPauseMillis"></a>MaxGCPauseMillis</h3><p><code>-XX:</code>:设置GC最大停顿时间.仅在使用ParallelScavenge收集器时生效</p>
<h3 id="ScavengeBeforeFullGC"><a href="#ScavengeBeforeFullGC" class="headerlink" title="ScavengeBeforeFullGC"></a>ScavengeBeforeFullGC</h3><p><code>-XX:</code>:在FullGC发生之前触发一次MinorGC</p>
<h3 id="UseGCOverheadLimit"><a href="#UseGCOverheadLimit" class="headerlink" title="UseGCOverheadLimit"></a>UseGCOverheadLimit</h3><p><code>-XX:</code>:禁止GC过程无限制的执行,如果过于频繁,就直接发生OutOfMemory</p>
<h3 id="InitiatingHeapOccupancyPercent"><a href="#InitiatingHeapOccupancyPercent" class="headerlink" title="InitiatingHeapOccupancyPercent"></a>InitiatingHeapOccupancyPercent</h3><p><code>-XX:InitiatingHeapOccupancyPercent=n</code>:设置触发标记周期的Java堆占用率阈值.默认占用率是整个Java堆的45%.</p>
<h3 id="G1HeapRegionSize"><a href="#G1HeapRegionSize" class="headerlink" title="G1HeapRegionSize"></a>G1HeapRegionSize</h3><p><code>-XX:G1HeapRegionSize=n</code>:设置的G1区域的大小.值是2的幂,范围是1MB到32MB之间.目标是根据最小的Java堆大小划分出约2048个区域.</p>
<h3 id="G1ReservePercent"><a href="#G1ReservePercent" class="headerlink" title="G1ReservePercent"></a>G1ReservePercent</h3><p><code>-XX:G1ReservePercent=n</code>:设置作为空闲空间的预留内存百分比,以降低目标空间溢出的风险.默认值是10%.增加或减少百分比时,请确保对总的Java堆调整相同的量.JavaHotSpotVMbuild23中没有此设置.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/09/01/jvm/JVM 参数 -- 内存设置/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/09/01/jvm/JVM 参数 -- 内存设置/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/04/18/编程语言/Groovy JSON/" title="Groovy JSON" itemprop="url">Groovy JSON</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-04-18T07:00:00.000Z" itemprop="datePublished"> Published 2014-04-18</time>
    
  </p>
</header>
    <div class="article-content">
        
        <blockquote>
<p>本文是对Groovy部分官方文档进行了翻译</p>
</blockquote>
<p>Groovy 原生支持Groovy对象和JSON之间的转换. <code>groovy.json</code>包内的类用于JSON的序列化和解析功能</p>
<h2 id="JsonSlurper"><a href="#JsonSlurper" class="headerlink" title="JsonSlurper"></a>JsonSlurper</h2><p><code>JsonSlurper</code>用于将JSON文本或者其他数据内容解析成Groovy里的数据结构,例如<code>maps&lt;/code&gt;,</code>lists, 或者其他原生基本类型 <code>Integer&lt;/code&gt;,</code>Double, <code>Boolean&lt;/code&gt;,</code>String`。</p>
<p>这个类重载了很多方法, 而且还添加了一些特殊的方法, 例如<code>parseText&lt;/code&gt;,</code>parseFile<code>等.下面这个例子中我们使用了</code>parseText<code>方法, 它会解析一个JSON字符串, 然后递归地将它转换成</code>list, <code>map</code>结构. 一些其他的`parse* 方法和这个方法很类似, 都返回了JSON字符串, 只不过其他的方法接受的参数不一样.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> jsonSlurper = <span class="keyword">new</span> JsonSlurper()</div><div class="line"><span class="keyword">def</span> object = jsonSlurper.parseText(<span class="string">'&#123; "name": "John Doe" &#125; /* some comment */'</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> object <span class="keyword">instanceof</span> Map</div><div class="line"><span class="keyword">assert</span> object.name == <span class="string">'John Doe'</span></div></pre></td></tr></table></figure>
<p>需要注意的是, 产生的结果是一个纯map, 可以像一个普通的Groovy对象实例持有它. <code>JsonSlurper</code>根据<a href="http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf" target="_blank" rel="external">ECMA-404 JSON Interchange Standard</a>定义来解析JSON, 同时支持JavaScript的注释和时间类型.</p>
<p>除了支持maps之外, <code>JsonSlurper</code> 还支持将JSON数组解析成list的功能<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> jsonSlurper = <span class="keyword">new</span> JsonSlurper()</div><div class="line"><span class="keyword">def</span> object = jsonSlurper.parseText(<span class="string">'&#123; "myList": [4, 8, 15, 16, 23, 42] &#125;'</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> object <span class="keyword">instanceof</span> Map</div><div class="line"><span class="keyword">assert</span> object.myList <span class="keyword">instanceof</span> List</div><div class="line"><span class="keyword">assert</span> object.myList == [<span class="number">4</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">23</span>, <span class="number">42</span>]</div></pre></td></tr></table></figure></p>
<p>JSON标准上只支持下面这些原生数据类型：<code>string&lt;/code&gt;,</code>number, <code>object&lt;/code&gt;,</code>true, <code>false&lt;/code&gt;,</code>null. <code>JsonSlurper</code> 将那些JSON类型转换成Groovy类型.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> jsonSlurper = <span class="keyword">new</span> JsonSlurper()</div><div class="line"><span class="keyword">def</span> object = jsonSlurper.parseText <span class="string">'''</span></div><div class="line">    &#123; "simple": 123,</div><div class="line">      "fraction": 123.66,</div><div class="line">      "exponential": 123e12</div><div class="line">    &#125;'''</div><div class="line"></div><div class="line"><span class="keyword">assert</span> object <span class="keyword">instanceof</span> Map</div><div class="line"><span class="keyword">assert</span> object.simple.<span class="keyword">class</span> == Integer</div><div class="line"><span class="keyword">assert</span> object.fraction.<span class="keyword">class</span> == BigDecimal</div><div class="line"><span class="keyword">assert</span> object.exponential.<span class="keyword">class</span> == BigDecimal</div></pre></td></tr></table></figure></p>
<p><code>JsonSlurper</code> 生成的结果就是纯Groovy对象实例, 她的内部不会包含任何的JSON相关的类对象, 它的用法是相当透明的. 事实上<code>JsonSlurper</code>的结果遵循<code>GPath</code>表达式. <code>GPath</code>是一个非常强大的表达式语言, 它支持多种不同的数据格式(例如<code>XmlSlurper</code>支持<code>XML</code> 就是其中一个例子)</p>
<p>如果想要了解更多的内容, 你可以直接去<a href="http://docs.groovy-lang.org/latest/html/documentation/core-semantics.html#gpath_expressions" target="_blank" rel="external">GPath expressions</a>看一看.<br>下面给出了JSON类型与Groovy数据类型之间的对应关系.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">JSON			Groovy</div><div class="line">string			java.lang.String</div><div class="line">number			java.lang.BigDecimal or java.lang.Integer</div><div class="line">object			java.util.LinkedHashMap</div><div class="line">array			java.util.ArrayList</div><div class="line"><span class="literal">true</span>			<span class="literal">true</span></div><div class="line"><span class="literal">false</span>			<span class="literal">false</span></div><div class="line"><span class="literal">null</span>			<span class="literal">null</span></div><div class="line">date			java.util.Date based on the yyyy-MM-dd’T’<span class="string">HH:</span><span class="string">mm:</span>ssZ date format</div></pre></td></tr></table></figure></p>
<p>如果JSON中的一个值是<code>null&lt;/code&gt;,</code>JsonSlurper<code>支持它转换成Groovy中的</code>null.这就与其他JSON解析器形成了对比, 代表一个空值与库提供的单一对象。</p>
<h3 id="Parser-Variants"><a href="#Parser-Variants" class="headerlink" title="Parser Variants"></a>Parser Variants</h3><p>Groovy 有多个<code>JsonSlurper</code> 解析器实现. 每一个解析器都对应着不同的需求, 每一个特定的解析都能很好的处理特定需求, 所以默认的解析器并不是适应于所有的情况. 下面就对各个解析器做个简介:</p>
<p><code>JsonParserCharArray</code> 解析器接受一个JSON字符串, 然后其内部使用一个字节数组进行解析. During value conversion it copies character sub-arrays (a mechanism known as “chopping”) and operates on them.</p>
<ul>
<li><p><code>JsonFastParser</code>解析器是<code>JsonParserCharArray</code>解析器的变种, 它是最快的解析器. 尽管它是最快的,但是基于某些原因,它并不是默认的解析器. <code>JsonFastParser</code>解析器也被称为索引覆盖(index-overlay)解析器. 当解析给定JSON字符串的时候,该解析器会极力避免创建新的字节数组或者字符串实例. 它一直指向原生的字节数组。 另外, 它会尽可能的推迟对象的创建. If parsed maps are put into long-term caches care must be taken as the map objects might not be created and still consist of pointer to the original char buffer only. <code>JsonFastParser</code>采取了一种特殊的切割模型, 它会尽早地分割char buffer, 以便能维持一份对原生buffer比较小的拷贝. 如果你想使用<code>JsonFastParser&lt;/code&gt;, 那么给你的建议是保持</code>JsonFastParser`的JSON buffer在2MB左右, 而且时刻要保持长期缓存限制.</p>
</li>
<li><p><code>JsonParserLax</code> 是<code>JsonFastParser</code>的一个变种实现. 它与<code>JsonFastParser</code> 有一些相似的想能特点, 但是不同的是它不是仅仅依靠`ECMA-404 JSON grammar. 例如,在下面例子中它支持不带引号的字符串注释.</p>
</li>
</ul>
<p><code>JsonParserUsingCharacterSource</code> 用于解析非常大的文件. 它使用一种称为<code>“character windowing”</code>的技术去解析非常大(超过2MB)的JSON文件,而且性能上也非常稳定</p>
<p><code>JsonSlurper</code>的默认实现是 <code>JsonParserCharArray&lt;/code&gt;.</code>JsonParserType`包含了解析器种类的枚举类型:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Implementation					Constant</div><div class="line">JsonParserCharArray				JsonParserType#CHAR_BUFFER</div><div class="line">JsonFastParser					JsonParserType#INDEX_OVERLAY</div><div class="line">JsonParserLax					JsonParserType#LAX</div><div class="line">JsonParserUsingCharacterSource	JsonParserType#CHARACTER_SOURCE</div></pre></td></tr></table></figure>
<p>如果想要改变解析器的实现也非常简单, 只需要通过调用<code>JsonSlurper#setType()&lt;/code&gt;方法给</code>JsonParserType`设置上不同的值就可以了</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> jsonSlurper = <span class="keyword">new</span> JsonSlurper(<span class="string">type:</span> JsonParserType.INDEX_OVERLAY)</div><div class="line"><span class="keyword">def</span> object = jsonSlurper.parseText(<span class="string">'&#123; "myList": [4, 8, 15, 16, 23, 42] &#125;'</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> object <span class="keyword">instanceof</span> Map</div><div class="line"><span class="keyword">assert</span> object.myList <span class="keyword">instanceof</span> List</div><div class="line"><span class="keyword">assert</span> object.myList == [<span class="number">4</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">23</span>, <span class="number">42</span>]</div></pre></td></tr></table></figure>
<h3 id="JsonOutput"><a href="#JsonOutput" class="headerlink" title="JsonOutput"></a>JsonOutput</h3><p><code>JsonOutput</code>用于将Groovy对象序列化成JSON字符串.</p>
<p><code>JsonOutput</code> 重载了<code>toJson</code>静态方法. 每个不同的<code>toJson</code>方法都会接受一个不同的参数类型.</p>
<p><code>toJson</code>方法返回的是一个包含JSOn格式的字符串<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> json = JsonOutput.toJson([<span class="string">name:</span> <span class="string">'John Doe'</span>, <span class="string">age:</span> <span class="number">42</span>])</div><div class="line"></div><div class="line"><span class="keyword">assert</span> json == <span class="string">'&#123;"name":"John Doe","age":42&#125;'</span></div></pre></td></tr></table></figure></p>
<p><code>JsonOutput</code>不仅支持原生类型, map, list等类型序列化到JSON, 甚至还支持序列化`POGOs(一种比较老的Groovy对象)</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span> String name &#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> json = JsonOutput.toJson([ <span class="keyword">new</span> Person(<span class="string">name:</span> <span class="string">'John'</span>), <span class="keyword">new</span> Person(<span class="string">name:</span> <span class="string">'Max'</span>) ])</div><div class="line"></div><div class="line"><span class="keyword">assert</span> json == <span class="string">'[&#123;"name":"John"&#125;,&#123;"name":"Max"&#125;]'</span></div></pre></td></tr></table></figure>
<p>刚才那个例子中, JSON输出默认没有进行pretty输出. 因此<code>JsonSlurper</code>还提供了<code>prettyPrint</code>方法<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> json = JsonOutput.toJson([<span class="string">name:</span> <span class="string">'John Doe'</span>, <span class="string">age:</span> <span class="number">42</span>])</div><div class="line"></div><div class="line"><span class="keyword">assert</span> json == <span class="string">'&#123;"name":"John Doe","age":42&#125;'</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> JsonOutput.prettyPrint(json) == <span class="string">'''\</span></div><div class="line">&#123;</div><div class="line">    "name": "John Doe",</div><div class="line">    "age": 42</div><div class="line">&#125;'''.stripIndent()</div></pre></td></tr></table></figure></p>
<p><code>prettyPrint</code>方法只接受一个String类型的字符串, 它不能和<code>JsonOutput</code>里其他的方式结合起来使用, it can be applied on arbitrary JSON String instances.</p>
<p>在Groovy中还可以使用<code>JsonBuilder&lt;/code&gt;,</code>StreamingJsonBuilder<code>方式创建JSON. 这俩个构建起都提供了一个</code>DSL, 当构建器生成一个JSON的时候,可以制定一个对象图.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// an inclusive range</span></div><div class="line"><span class="keyword">def</span> range = <span class="string">'a'</span>..<span class="string">'d'</span></div><div class="line"><span class="keyword">assert</span> range.size() == <span class="number">4</span></div><div class="line"><span class="keyword">assert</span> range.get(<span class="number">2</span>) == <span class="string">'c'</span></div><div class="line"><span class="keyword">assert</span> range[<span class="number">2</span>] == <span class="string">'c'</span></div><div class="line"><span class="keyword">assert</span> range <span class="keyword">instanceof</span> java.util.List</div><div class="line"><span class="keyword">assert</span> range.contains(<span class="string">'a'</span>)</div><div class="line"><span class="keyword">assert</span> range.contains(<span class="string">'d'</span>)</div><div class="line"><span class="keyword">assert</span> !range.contains(<span class="string">'e'</span>)</div></pre></td></tr></table></figure>
<p>You can iterate on a range using a classic for loop:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.10</span>) &#123;</div><div class="line">    println <span class="string">"Hello $&#123;i&#125;"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>but alternatively you can achieve the same effect in a more Groovy idiomatic style, by iterating a range with each method:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(<span class="number">1.</span><span class="number">.10</span>).each &#123; i -&gt;</div><div class="line">    println <span class="string">"Hello $&#123;i&#125;"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Ranges can be also used in the switch statement:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">switch</span> (years) &#123;</div><div class="line">    <span class="keyword">case</span> <span class="number">1.</span><span class="number">.10</span>: interestRate = <span class="number">0.076</span>; <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> <span class="number">11.</span><span class="number">.25</span>: interestRate = <span class="number">0.052</span>; <span class="keyword">break</span>;</div><div class="line"><span class="symbol">    default:</span> interestRate = <span class="number">0.037</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/04/18/编程语言/Groovy JSON/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/04/18/编程语言/Groovy JSON/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/04/17/编程语言/Groovy ANT/" title="Groovy ANT" itemprop="url">Groovy ANT</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-04-17T07:00:00.000Z" itemprop="datePublished"> Published 2014-04-17</time>
    
  </p>
</header>
    <div class="article-content">
        
        <blockquote>
<p>本文是对Groovy部分官方文档进行了翻译</p>
</blockquote>
<p>虽然<code>Ant</code>只是一个构建工具, 但其提供了例如能够操作文件(包括zip文件), 拷贝, 资源管理等诸多实用功能. 然而如果你不喜欢使用<code>build.xml</code>文件或者<code>Jelly</code>脚本, 而是想要一种清晰简洁的构建方式, 那么你就可以试试使用Groovy编写构建过程.</p>
<p>Groovy提供了一个辅助类<code>AntBuilder</code>帮忙编写Ant构建任务. 它看起来很像一个不带尖括号的Ant’s XML的简洁版本. 因此你可以在脚本中混合和匹配标记. Ant本身是一组Jar文件的集合. 将这组jar文件添加到你的classpath上, 你就可以在Groovy中轻轻松松的使用它们.</p>
<p><code>AntBuilder</code>通过便捷的构造器语法直接暴露了Ant task. 下面是一个简单的示例, 它的功能是在标准输出上输出一条消息.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> ant = <span class="keyword">new</span> AntBuilder()          </div><div class="line">ant.echo(<span class="string">'hello from Ant!'</span>)</div></pre></td></tr></table></figure></p>
<ol>
<li>创建一个<code>AntBuilder</code>实例</li>
<li>执行<code>AntBuilder</code>实例的echo task</li>
</ol>
<p>假设,现在你需要创建一个ZIP文件：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> ant = <span class="keyword">new</span> AntBuilder()</div><div class="line">ant.zip(<span class="string">destfile:</span> <span class="string">'sources.zip'</span>, <span class="string">basedir:</span> <span class="string">'src'</span>)</div></pre></td></tr></table></figure></p>
<p>在下面的例子中, 我们将展示在Groovy中使用传统的Ant 模式通过<code>AntBuilder</code>拷贝一组文件.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lets just call one task</span></div><div class="line">ant.echo(<span class="string">"hello"</span>)</div><div class="line"></div><div class="line"><span class="comment">// here is an example of a block of Ant inside GroovyMarkup</span></div><div class="line">ant.sequential &#123;</div><div class="line">    echo(<span class="string">"inside sequential"</span>)</div><div class="line">    <span class="keyword">def</span> myDir = <span class="string">"target/AntTest/"</span></div><div class="line">    mkdir(<span class="string">dir:</span> myDir)</div><div class="line">    copy(<span class="string">todir:</span> myDir) &#123;</div><div class="line">        fileset(<span class="string">dir:</span> <span class="string">"src/test"</span>) &#123;</div><div class="line">            include(<span class="string">name:</span> <span class="string">"**/*.groovy"</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    echo(<span class="string">"done"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// now lets do some normal Groovy again</span></div><div class="line"><span class="keyword">def</span> file = <span class="keyword">new</span> File(ant.project.baseDir,<span class="string">"target/AntTest/groovy/util/AntTest.groovy"</span>)</div><div class="line"><span class="keyword">assert</span> file.exists()</div></pre></td></tr></table></figure></p>
<p>下面的例子是遍历一组文件, 然后将每个文件根据特殊模式进行匹配.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lets create a scanner of filesets</span></div><div class="line"><span class="keyword">def</span> scanner = ant.fileScanner &#123;</div><div class="line">    fileset(<span class="string">dir:</span><span class="string">"src/test"</span>) &#123;</div><div class="line">        include(<span class="string">name:</span><span class="string">"**/Ant*.groovy"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// now lets iterate over</span></div><div class="line"><span class="keyword">def</span> found = <span class="literal">false</span></div><div class="line"><span class="keyword">for</span> (f <span class="keyword">in</span> scanner) &#123;</div><div class="line">    println(<span class="string">"Found file $f"</span>)</div><div class="line">    found = <span class="literal">true</span></div><div class="line">    <span class="keyword">assert</span> f <span class="keyword">instanceof</span> File</div><div class="line">    <span class="keyword">assert</span> f.name.endsWith(<span class="string">".groovy"</span>)</div><div class="line">&#125;</div><div class="line"><span class="keyword">assert</span> found</div></pre></td></tr></table></figure></p>
<p>Or execute a JUnit test:</p>
<p>下面我们执行JUnit<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lets create a scanner of filesets</span></div><div class="line">ant.junit &#123;</div><div class="line">    test(<span class="string">name:</span><span class="string">'groovy.util.SomethingThatDoesNotExist'</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在, 让我们的步子迈地更大一点：在Groovy中编译然后执行一个Java文件.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ant.echo(<span class="string">file:</span><span class="string">'Temp.java'</span>, <span class="string">'''</span></div><div class="line">    class Temp &#123;</div><div class="line">        public static void main(String[] args) &#123;</div><div class="line">            System.out.println("Hello");</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">''')</div><div class="line">ant.javac(<span class="string">srcdir:</span><span class="string">'.'</span>, <span class="string">includes:</span><span class="string">'Temp.java'</span>, <span class="string">fork:</span><span class="string">'true'</span>)</div><div class="line">ant.java(<span class="string">classpath:</span><span class="string">'.'</span>, <span class="string">classname:</span><span class="string">'Temp'</span>, <span class="string">fork:</span><span class="string">'true'</span>)</div><div class="line">ant.echo(<span class="string">'Done'</span>)</div></pre></td></tr></table></figure></p>
<p>需要提及的是, <code>AntBuilder</code>是内嵌于<code>Gradle</code>中的. 你可以像在Groovy中那样, 在<code>Gradle</code>使用<code>AntBuilder</code></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/04/17/编程语言/Groovy ANT/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/04/17/编程语言/Groovy ANT/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/04/16/编程语言/Groovy 字符串/" title="Groovy 字符串" itemprop="url">Groovy 字符串</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-04-16T07:00:00.000Z" itemprop="datePublished"> Published 2014-04-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <blockquote>
<p>本文是对Groovy部分官方文档进行了翻译</p>
</blockquote>
<p>在Groovy文本字面量被称为String,这是以字符链的形式出现的. Groovy允许你实例化<code>java.lang.String</code>,像  GStrings (<code>groovy.lang.GString</code>)那样, (GString还被称为插值字符串)</p>
<h3 id="单引号字符"><a href="#单引号字符" class="headerlink" title="单引号字符"></a>单引号字符</h3><p>单引号字符串是通过单引号括起来的一列字符<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'a single quoted string'</span></div></pre></td></tr></table></figure></p>
<p>单引号字符和<code>java.lang.String</code>是同一个东西, 同时它也不允许插值的出现</p>
<h3 id="字符串连接"><a href="#字符串连接" class="headerlink" title="字符串连接"></a>字符串连接</h3><p>Groovy里所有的字符串都可以通过 <code>+</code> 连接起来<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> <span class="string">'ab'</span> == <span class="string">'a'</span> + <span class="string">'b'</span></div></pre></td></tr></table></figure></p>
<h3 id="三重单引号字符串"><a href="#三重单引号字符串" class="headerlink" title="三重单引号字符串"></a>三重单引号字符串</h3><p>三重单引号字符串 是通过三个单引号 包围起来的字符序列.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'''a triple single quoted string'''</span></div></pre></td></tr></table></figure></p>
<p>三重单引号字符串就是纯<code>java.lang.String</code> 而且不允许插值.<br>三重单引号字符串可以多行赋值.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> aMultilineString = <span class="string">'''line one</span></div><div class="line">line two</div><div class="line">line three'''</div></pre></td></tr></table></figure></p>
<p>如果你的代码进行了缩进, 例如类中的方法体, 那跨行的三重单引号字符串也会包含缩进. 不过可以调用<code>String#stripIndent()</code> 去除掉缩进. <code>String#stripMargin()</code>方法会通过分割符从字符串的开头<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> startingAndEndingWithANewline = <span class="string">'''</span></div><div class="line">line one</div><div class="line">line two</div><div class="line">line three</div><div class="line">'''</div></pre></td></tr></table></figure></p>
<p>你也许会注意到最终得到的字符串会包含一个换行符.It is possible to strip that character by escaping the newline with a backslash:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> strippedFirstNewline = <span class="string">'''\</span></div><div class="line">line one</div><div class="line">line two</div><div class="line">line three</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">assert</span> !strippedFirstNewline.startsWith(<span class="string">'\n'</span>)</div></pre></td></tr></table></figure></p>
<h4 id="更换特殊字符"><a href="#更换特殊字符" class="headerlink" title="更换特殊字符"></a>更换特殊字符</h4><p>可以通过<code>\</code>字符在<code>&#39;&#39;</code>继续引用<code>&#39;</code><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'an escaped single quote: \' needs a backslash'</span></div></pre></td></tr></table></figure></p>
<p>当然也可以通过<code>\</code>来引用它自身<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'an escaped escape character: \\ needs a double backslash'</span></div></pre></td></tr></table></figure></p>
<p>还有一些其他的特殊字符需要<code>\</code>来引用<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Escape sequence	Character</div><div class="line"><span class="string">'\t'</span>	tabulation</div><div class="line"><span class="string">'\b'</span>	backspace</div><div class="line"><span class="string">'\n'</span>	newline</div><div class="line"><span class="string">'\r'</span>	carriage <span class="keyword">return</span></div><div class="line"><span class="string">'\f'</span>	formfeed</div><div class="line"><span class="string">'\\'</span>	backslash</div><div class="line"><span class="string">'\''</span>	single quote (<span class="keyword">for</span> single quoted and triple single quoted strings)</div><div class="line"><span class="string">'\"'</span>	<span class="keyword">double</span> quote (<span class="keyword">for</span> <span class="keyword">double</span> quoted and triple <span class="keyword">double</span> quoted strings)</div></pre></td></tr></table></figure></p>
<h4 id="Unicode-转义序列"><a href="#Unicode-转义序列" class="headerlink" title="Unicode 转义序列"></a>Unicode 转义序列</h4><p>有一些字符并不能通过键盘输出, 那么此时就可以通过Unicode 转义序列来实现. 例如<code>backslash</code>, 在u后跟4个16进制数字即可.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'The Euro currency symbol: \u20AC'</span></div></pre></td></tr></table></figure>
<h3 id="双引号包含的-string"><a href="#双引号包含的-string" class="headerlink" title="双引号包含的 string"></a>双引号包含的 string</h3><p>通过双引号包括起来的字符串<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"a double quoted string"</span></div></pre></td></tr></table></figure></p>
<p>当双引号字符串内没有插值(<code>${}</code>)的时候, 那它就等同于<code>java.lang.String</code>, 当有插值的时候那么双引号字符串就是<code>groovy.lang.GString</code>的实例</p>
<h4 id="String-插值"><a href="#String-插值" class="headerlink" title="String 插值"></a>String 插值</h4><p>任何表达式都可以嵌入到除了单引号和三引号的所有字符串常量中. 当对字符串求值的时候, 插值会使用他的值来替换掉字符串里的占位符. 占位符表达式通过<code>${}</code> 或者 <code>$</code>来实现. 占位符里的表达式值会被转换成其字符串表示形式, 转换是通过调用表达式<code>toString()</code>方法,通过传递一个String参数.</p>
<p>下面的例子展示的是字符串里的占位符定位本地变量<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> name = <span class="string">'Guillaume'</span> <span class="comment">// a plain string</span></div><div class="line"><span class="keyword">def</span> greeting = <span class="string">"Hello $&#123;name&#125;"</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> greeting.toString() == <span class="string">'Hello Guillaume'</span></div></pre></td></tr></table></figure></p>
<p>但是并非所有的表达式都是合法的, 像下面我们列举的这个算术表达式</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> sum = <span class="string">"The sum of 2 and 3 equals $&#123;2 + 3&#125;"</span></div><div class="line"><span class="keyword">assert</span> sum.toString() == <span class="string">'The sum of 2 and 3 equals 5'</span></div></pre></td></tr></table></figure>
<p>其实并不是只有表达式允许出现在<code>${}</code>表达式里. Statements 同样可以在<code>${}</code> 占位符里出现, 但是statement的值会是null. 如果有N个statements出现在<code>${}</code>里,那么最后一个statement应该返回一个有效值,以便被插入到字符串里. 例如<code>&quot;The sum of 1 and 2 is equal to ${def a = 1; def b = 2; a + b}&quot;</code> 是允许的,而且也会像语法预期的那样执行, 但是习惯上,GString 占位符里应该更多的是使用简单表达式.<br>除了<code>${}</code>占位符之外, 我们也可以使用<code>$</code>标记前缀点缀表达式：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> person = [<span class="string">name:</span> <span class="string">'Guillaume'</span>, <span class="string">age:</span> <span class="number">36</span>]</div><div class="line"><span class="keyword">assert</span> <span class="string">"$person.name is $person.age years old"</span> == <span class="string">'Guillaume is 36 years old'</span></div></pre></td></tr></table></figure>
<p>但是仅仅一下形式的点缀表达式是合法的：a.b, a.b.c,etc.但是那些包含括号的表达式(例如方法调用,花括号为闭包,算术运算符)是无效的.<br>下面给出了一个定义成数字形式的变量.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> number = <span class="number">3.14</span></div></pre></td></tr></table></figure></p>
<p>下面的 statement 将会抛出一个<code>groovy.lang.MissingPropertyException</code> 异常,因为Groovy认为你正在尝试访问那个数字的不存在的toString属性.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">shouldFail(MissingPropertyException) &#123;</div><div class="line">    println <span class="string">"$number.toString()"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>你可以理解成解析器会将<code>&quot;$number.toString()&quot;</code> 解释成 <code>&quot;${number.toString}()&quot;</code>.如果你想要在GString中避免<code>$</code>或者<code>${}</code> 称为插值的话,只需要在它们前面加上<code>\</code>即可.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> <span class="string">'$&#123;name&#125;'</span> == <span class="string">"\$&#123;name&#125;"</span></div></pre></td></tr></table></figure>
<h4 id="特殊插值形式-闭包表达式"><a href="#特殊插值形式-闭包表达式" class="headerlink" title="特殊插值形式-闭包表达式"></a>特殊插值形式-闭包表达式</h4><p>到目前为止,我们看到可以在${}占位符里插入任何的表达式, 但还有一种特殊的表达式-闭包表达式. 当占位符内好汉一个箭头时<code>${→}</code>,这个表达式实际上就是一个闭包表达式.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> sParameterLessClosure = <span class="string">"1 + 2 == $&#123;-&gt; 3&#125;"</span> (<span class="number">1</span>)</div><div class="line"><span class="keyword">assert</span> sParameterLessClosure == <span class="string">'1 + 2 == 3'</span></div><div class="line"></div><div class="line"><span class="keyword">def</span> sOneParamClosure = <span class="string">"1 + 2 == $&#123; w -&gt; w &lt;&lt; 3&#125;"</span> (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> sOneParamClosure == <span class="string">'1 + 2 == 3'</span></div></pre></td></tr></table></figure>
<ol>
<li>由于闭包不用声明参数, 所以在使用闭包时,我们不必对其传参</li>
<li>上例中,闭包中使用了一个<code>java.io.StringWriter argument</code>参数, 我们可以使用<code>&lt;&lt;</code>操作符添加内容.不论任何情况, 占位符都被嵌入了闭包.</li>
</ol>
<p>上面的表达式看起来更像是使用了一个啰嗦的方式去定义插值表达式, 但是闭包有个有趣又高级的特性：惰性计算:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> number = <span class="number">1</span> (<span class="number">1</span>)</div><div class="line"><span class="keyword">def</span> eagerGString = <span class="string">"value == $&#123;number&#125;"</span></div><div class="line"><span class="keyword">def</span> lazyGString = <span class="string">"value == $&#123; -&gt; number &#125;"</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> eagerGString == <span class="string">"value == 1"</span> (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> lazyGString ==  <span class="string">"value == 1"</span> (<span class="number">3</span>)</div><div class="line"></div><div class="line">number = <span class="number">2</span> (<span class="number">4</span>)</div><div class="line"><span class="keyword">assert</span> eagerGString == <span class="string">"value == 1"</span> (<span class="number">5</span>)</div><div class="line"><span class="keyword">assert</span> lazyGString ==  <span class="string">"value == 2"</span> (<span class="number">6</span>)</div></pre></td></tr></table></figure>
<ol>
<li>我们定义了数值为1的number类型变量, 它稍后会作为插值出现在俩个GString中,</li>
<li>我们希望eagerGString 产生的字符串包含着相同的值 1</li>
<li>同样我们也希望lazyGString 产生的字符串包含着相同的值 1</li>
<li>然后我们将number改变一个值.</li>
<li>With a plain interpolated expression, the value was actually bound at the time of creation of the GString.</li>
<li>But with a closure expression, the closure is called upon each coercion of the GString into String, resulting in an updated string containing the new number value.</li>
</ol>
<p>An embedded closure expression taking more than one parameter will generate an exception at runtime. Only closures with zero or one parameters are allowed.</p>
<h4 id="Inteoperability-with-Java"><a href="#Inteoperability-with-Java" class="headerlink" title="Inteoperability with Java"></a>Inteoperability with Java</h4><p>当一个方法(不管是在Java还是在Groovy中定义的)带有一个<code>java.lang.String</code>参数, 但我们传递一个<code>groovy.lang.GString instance</code>实例, GString会自动调用toString()方法.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">String takeString(String message) &#123;         (<span class="number">4</span>)</div><div class="line">    <span class="keyword">assert</span> message <span class="keyword">instanceof</span> String        (<span class="number">5</span>)</div><div class="line">    <span class="keyword">return</span> message</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> message = <span class="string">"The message is $&#123;'hello'&#125;"</span>   (<span class="number">1</span>)</div><div class="line"><span class="keyword">assert</span> message <span class="keyword">instanceof</span> GString           (<span class="number">2</span>)</div><div class="line"></div><div class="line"><span class="keyword">def</span> result = takeString(message)            (<span class="number">3</span>)</div><div class="line"><span class="keyword">assert</span> result <span class="keyword">instanceof</span> String</div><div class="line"><span class="keyword">assert</span> result == <span class="string">'The message is hello'</span></div></pre></td></tr></table></figure>
<ol>
<li>首先我们创建一个GString变量</li>
<li>然后我们检查一下声明的变量是否是GString的实例</li>
<li>接着我们向一个方法(参数为String类型)传递GString类型变量</li>
<li>takeString()显式地指出了它唯一的参数为String</li>
<li>我们再次验证所需的参数是String 而不是GString</li>
</ol>
<h4 id="GString-and-String-hashCodes"><a href="#GString-and-String-hashCodes" class="headerlink" title="GString and String hashCodes"></a>GString and String hashCodes</h4><p>尽管插值字符串能被用来代替<code>Java strings</code>, 但是他们在某些地方并不是完全一样的—— 他们的hashCodes是不同的. Java Strig是<code>immutable</code>, 然而, GString通过它的内插值 生成的字符串是可以改变的. 即使生成完全一样的字符串, GStrings 和 Strings的 hashCode 仍然是不一样的.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> <span class="string">"one: $&#123;1&#125;"</span>.hashCode() != <span class="string">"one: 1"</span>.hashCode()</div></pre></td></tr></table></figure>
<p>GString 和 Strings 拥有不同的hashCode值, 在Map中应该避免使用GString作为key, 特别的,当我们想要检索值的之后应该使用String,而不是GString.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> key = <span class="string">"a"</span></div><div class="line"><span class="keyword">def</span> m = [<span class="string">"$&#123;key&#125;"</span>: <span class="string">"letter $&#123;key&#125;"</span>]     (<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> m[<span class="string">"a"</span>] == <span class="literal">null</span>                   (<span class="number">2</span>)</div></pre></td></tr></table></figure></p>
<ol>
<li>map使用一对键值被创建了出来,其key是GString类型</li>
<li>当我们通过一个String类型的key进行检索值的时候,我们会得到一个null的结果, 产生这样的现象正是由于String和GString拥有不同的hashCode</li>
</ol>
<h3 id="Triple-double-quoted-string"><a href="#Triple-double-quoted-string" class="headerlink" title="Triple double quoted string"></a>Triple double quoted string</h3><p>三重双引号字符串其使用和双引号字符串及其相像, 但与双引号字符串不同的一点是：它们是可以换行的(像三重单引号字符串那样)<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> name = <span class="string">'Groovy'</span></div><div class="line"><span class="keyword">def</span> template = <span class="string">"""</span></div><div class="line">    Dear Mr $&#123;name&#125;,</div><div class="line"></div><div class="line">    You're the winner of the lottery!</div><div class="line"></div><div class="line">    Yours sincerly,</div><div class="line"></div><div class="line">    Dave</div><div class="line">"""</div><div class="line"></div><div class="line"><span class="keyword">assert</span> template.toString().contains(<span class="string">'Groovy'</span>)</div></pre></td></tr></table></figure></p>
<p>在三重双引号字符串中,不管是双引号还是单引号都不需要escaped</p>
<h3 id="Slashy-string"><a href="#Slashy-string" class="headerlink" title="Slashy string"></a>Slashy string</h3><p>除了引号字符串, Groovy还提供了slashy字符串(使用/作为分隔符). Slashy字符串对定义正则表达式和正则模式是非常有用的.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> fooPattern = <span class="regexp">/.*foo.*/</span></div><div class="line"><span class="keyword">assert</span> fooPattern == <span class="string">'.*foo.*'</span></div></pre></td></tr></table></figure>
<p>只有在<code>/ slashes</code>中需要使用\ 来escaped<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> escapeSlash = <span class="regexp">/The character \/</span> is a forward slash/</div><div class="line"><span class="keyword">assert</span> escapeSlash == <span class="string">'The character / is a forward slash'</span></div></pre></td></tr></table></figure></p>
<p>Slashy字符串也可以是多行的<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> multilineSlashy = /one</div><div class="line">    two</div><div class="line">    three/</div><div class="line"></div><div class="line"><span class="keyword">assert</span> multilineSlashy.contains(<span class="string">'\n'</span>)</div></pre></td></tr></table></figure></p>
<p>Slashy字符串也可以插值形式出现(像GString一样)<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> color = <span class="string">'blue'</span></div><div class="line"><span class="keyword">def</span> interpolatedSlashy = <span class="regexp">/a $&#123;color&#125; car/</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> interpolatedSlashy == <span class="string">'a blue car'</span></div></pre></td></tr></table></figure></p>
<p>下面有一些常识方面的东西需要你知道：<br><code>//</code>不会被解释为空Slashy字符串,这代表着行注释.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> <span class="string">''</span> == <span class="comment">//</span></div></pre></td></tr></table></figure>
<h3 id="Dollar-slashy-string"><a href="#Dollar-slashy-string" class="headerlink" title="Dollar slashy string"></a>Dollar slashy string</h3><p>Dollar slashy字符串 通过<code>$/``/$</code> 来实现多行GString. 美元符作为转义字符, 而且它还能转义另一个美元符号, 或者一个 forward slash. 除了要实现像GString占位符和闭包美元符slashy的开头美元符之外, 美元符和forward slashes都不需要转义<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> name = <span class="string">"Guillaume"</span></div><div class="line"><span class="keyword">def</span> date = <span class="string">"April, 1st"</span></div><div class="line"></div><div class="line"><span class="keyword">def</span> dollarSlashy = <span class="string">$/</span></div><div class="line">    Hello $name,</div><div class="line">    today we're $&#123;date&#125;.</div><div class="line"></div><div class="line">    $ dollar sign</div><div class="line">    $$ escaped dollar sign</div><div class="line">    \ backslash</div><div class="line">    / forward slash</div><div class="line">    $/ escaped forward slash</div><div class="line">    $/$ escaped dollar slashy string delimiter</div><div class="line">/$</div><div class="line"></div><div class="line"><span class="keyword">assert</span> [</div><div class="line">    <span class="string">'Guillaume'</span>,</div><div class="line">    <span class="string">'April, 1st'</span>,</div><div class="line">    <span class="string">'$ dollar sign'</span>,</div><div class="line">    <span class="string">'$ escaped dollar sign'</span>,</div><div class="line">    <span class="string">'\\ backslash'</span>,</div><div class="line">    <span class="string">'/ forward slash'</span>,</div><div class="line">        <span class="string">'$/ escaped forward slash'</span>,</div><div class="line">        <span class="string">'/$ escaped dollar slashy string delimiter'</span></div><div class="line"></div><div class="line">        ].each &#123; dollarSlashy.contains(it) &#125;</div></pre></td></tr></table></figure></p>
<h3 id="Characters"><a href="#Characters" class="headerlink" title="Characters"></a>Characters</h3><p>不像java, Groovy里没有显式的字符字面量. 可以通过下面三种方式,显式地生成Groovy 字符变量<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> c1 = <span class="string">'A'</span> (<span class="number">1</span>)</div><div class="line"><span class="keyword">assert</span> c1 <span class="keyword">instanceof</span> Character</div><div class="line"></div><div class="line"><span class="keyword">def</span> c2 = <span class="string">'B'</span> <span class="keyword">as</span> <span class="keyword">char</span> (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> c2 <span class="keyword">instanceof</span> Character</div><div class="line"></div><div class="line"><span class="keyword">def</span> c3 = (<span class="keyword">char</span>)<span class="string">'C'</span> (<span class="number">3</span>)</div><div class="line"><span class="keyword">assert</span> c3 <span class="keyword">instanceof</span> Character</div></pre></td></tr></table></figure></p>
<ol>
<li>通过指定char类型来显式地声明一个character变量</li>
<li>通过操作符强制转换类型</li>
<li>通过强制转换成指定类型</li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/04/16/编程语言/Groovy 字符串/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/04/16/编程语言/Groovy 字符串/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/04/15/编程语言/Groovy 数字/" title="Groovy 数字" itemprop="url">Groovy 数字</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-04-15T07:00:00.000Z" itemprop="datePublished"> Published 2014-04-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <blockquote>
<p>本文是对Groovy部分官方文档进行了翻译</p>
</blockquote>
<p>Groovy支持多种不同的整数字面量和小数字面量 (通过依靠Java数字类型实现)</p>
<h3 id="Integral-literals"><a href="#Integral-literals" class="headerlink" title="Integral literals"></a>Integral literals</h3><p>The integral literal types are the same as in Java:</p>
<p>证书类型变量和Java里的一样</p>
<ul>
<li>byte</li>
<li>char</li>
<li>short</li>
<li>int</li>
<li>long</li>
<li>java.lang.BigInteger</li>
</ul>
<p>You can create integral numbers of those types with the following declarations:</p>
<p>可以通过以下声明方式创建整数类型变量<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// primitive types</span></div><div class="line"><span class="keyword">byte</span>  b = <span class="number">1</span></div><div class="line"><span class="keyword">char</span>  c = <span class="number">2</span></div><div class="line"><span class="keyword">short</span> s = <span class="number">3</span></div><div class="line"><span class="keyword">int</span>   i = <span class="number">4</span></div><div class="line"><span class="keyword">long</span>  l = <span class="number">5</span></div><div class="line"></div><div class="line"><span class="comment">// infinite precision</span></div><div class="line">BigInteger bi =  <span class="number">6</span></div></pre></td></tr></table></figure></p>
<p>如果使用<code>def</code>关键字, 整型类型会发生改变：它会自动适配成能够存储number类型的类型<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> a = <span class="number">1</span></div><div class="line"><span class="keyword">assert</span> a <span class="keyword">instanceof</span> Integer</div><div class="line"></div><div class="line"><span class="comment">// Integer.MAX_VALUE</span></div><div class="line"><span class="keyword">def</span> b = <span class="number">2147483647</span></div><div class="line"><span class="keyword">assert</span> b <span class="keyword">instanceof</span> Integer</div><div class="line"></div><div class="line"><span class="comment">// Integer.MAX_VALUE + 1</span></div><div class="line"><span class="keyword">def</span> c = <span class="number">2147483648</span></div><div class="line"><span class="keyword">assert</span> c <span class="keyword">instanceof</span> Long</div><div class="line"></div><div class="line"><span class="comment">// Long.MAX_VALUE</span></div><div class="line"><span class="keyword">def</span> d = <span class="number">9223372036854775807</span></div><div class="line"><span class="keyword">assert</span> d <span class="keyword">instanceof</span> Long</div><div class="line"></div><div class="line"><span class="comment">// Long.MAX_VALUE + 1</span></div><div class="line"><span class="keyword">def</span> e = <span class="number">9223372036854775808</span></div><div class="line"><span class="keyword">assert</span> e <span class="keyword">instanceof</span> BigInteger</div></pre></td></tr></table></figure></p>
<p>As well as for negative numbers:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> na = <span class="number">-1</span></div><div class="line"><span class="keyword">assert</span> na <span class="keyword">instanceof</span> Integer</div><div class="line"></div><div class="line"><span class="comment">// Integer.MIN_VALUE</span></div><div class="line"><span class="keyword">def</span> nb = <span class="number">-2147483648</span></div><div class="line"><span class="keyword">assert</span> nb <span class="keyword">instanceof</span> Integer</div><div class="line"></div><div class="line"><span class="comment">// Integer.MIN_VALUE - 1</span></div><div class="line"><span class="keyword">def</span> nc = <span class="number">-2147483649</span></div><div class="line"><span class="keyword">assert</span> nc <span class="keyword">instanceof</span> Long</div><div class="line"></div><div class="line"><span class="comment">// Long.MIN_VALUE</span></div><div class="line"><span class="keyword">def</span> nd = <span class="number">-9223372036854775808</span></div><div class="line"><span class="keyword">assert</span> nd <span class="keyword">instanceof</span> Long</div><div class="line"></div><div class="line"><span class="comment">// Long.MIN_VALUE - 1</span></div><div class="line"><span class="keyword">def</span> ne = <span class="number">-9223372036854775809</span></div><div class="line"><span class="keyword">assert</span> ne <span class="keyword">instanceof</span> BigInteger</div></pre></td></tr></table></figure></p>
<h4 id="Alternative-non-base-10-representations"><a href="#Alternative-non-base-10-representations" class="headerlink" title="Alternative non-base 10 representations"></a>Alternative non-base 10 representations</h4><h5 id="Binary-literal"><a href="#Binary-literal" class="headerlink" title="Binary literal"></a>Binary literal</h5><p>在Java6以前和Groovy中,number类型可以是小数, 8进制和16进制. 但是在Java7和Groovy2中,可以使用0b前缀表示二进制数据.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> xInt = <span class="number">0b10101111</span></div><div class="line"><span class="keyword">assert</span> xInt == <span class="number">175</span></div><div class="line"></div><div class="line"><span class="keyword">short</span> xShort = <span class="number">0b11001001</span></div><div class="line"><span class="keyword">assert</span> xShort == <span class="number">201</span> <span class="keyword">as</span> <span class="keyword">short</span></div><div class="line"></div><div class="line"><span class="keyword">byte</span> xByte = <span class="number">0b11</span></div><div class="line"><span class="keyword">assert</span> xByte == <span class="number">3</span> <span class="keyword">as</span> <span class="keyword">byte</span></div><div class="line"></div><div class="line"><span class="keyword">long</span> xLong = <span class="number">0b101101101101</span></div><div class="line"><span class="keyword">assert</span> xLong == <span class="number">2925</span>l</div><div class="line"></div><div class="line">BigInteger xBigInteger = <span class="number">0b111100100001</span></div><div class="line"><span class="keyword">assert</span> xBigInteger == <span class="number">3873</span>g</div><div class="line"></div><div class="line"><span class="keyword">int</span> xNegativeInt = <span class="number">-0</span>b10101111</div><div class="line"><span class="keyword">assert</span> xNegativeInt == <span class="number">-175</span></div></pre></td></tr></table></figure></p>
<h5 id="Octal-literal"><a href="#Octal-literal" class="headerlink" title="Octal literal"></a>Octal literal</h5><p>8进制的电话,只需要开头是0后跟要表示的8进制数即可.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> xInt = <span class="number">077</span></div><div class="line"><span class="keyword">assert</span> xInt == <span class="number">63</span></div><div class="line"></div><div class="line"><span class="keyword">short</span> xShort = <span class="number">011</span></div><div class="line"><span class="keyword">assert</span> xShort == <span class="number">9</span> <span class="keyword">as</span> <span class="keyword">short</span></div><div class="line"></div><div class="line"><span class="keyword">byte</span> xByte = <span class="number">032</span></div><div class="line"><span class="keyword">assert</span> xByte == <span class="number">26</span> <span class="keyword">as</span> <span class="keyword">byte</span></div><div class="line"></div><div class="line"><span class="keyword">long</span> xLong = <span class="number">0246</span></div><div class="line"><span class="keyword">assert</span> xLong == <span class="number">166</span>l</div><div class="line"></div><div class="line">BigInteger xBigInteger = <span class="number">01111</span></div><div class="line"><span class="keyword">assert</span> xBigInteger == <span class="number">585</span>g</div><div class="line"></div><div class="line"><span class="keyword">int</span> xNegativeInt = <span class="number">-077</span></div><div class="line"><span class="keyword">assert</span> xNegativeInt == <span class="number">-63</span></div></pre></td></tr></table></figure></p>
<h5 id="Hexadecimal-literal"><a href="#Hexadecimal-literal" class="headerlink" title="Hexadecimal literal"></a>Hexadecimal literal</h5><p>Hexadecimal numbers are specified in the typical format of 0x followed by hex digits.</p>
<p>16进制的电话,只需要开头是0x后跟要表示的16进制数即可.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">int</span> xInt = <span class="number">0x77</span></div><div class="line"><span class="keyword">assert</span> xInt == <span class="number">119</span></div><div class="line"></div><div class="line"><span class="keyword">short</span> xShort = <span class="number">0xaa</span></div><div class="line"><span class="keyword">assert</span> xShort == <span class="number">170</span> <span class="keyword">as</span> <span class="keyword">short</span></div><div class="line"></div><div class="line"><span class="keyword">byte</span> xByte = <span class="number">0x3a</span></div><div class="line"><span class="keyword">assert</span> xByte == <span class="number">58</span> <span class="keyword">as</span> <span class="keyword">byte</span></div><div class="line"></div><div class="line"><span class="keyword">long</span> xLong = <span class="number">0xffff</span></div><div class="line"><span class="keyword">assert</span> xLong == <span class="number">65535</span>l</div><div class="line"></div><div class="line">BigInteger xBigInteger = <span class="number">0xaaaa</span></div><div class="line"><span class="keyword">assert</span> xBigInteger == <span class="number">43690</span>g</div><div class="line"></div><div class="line">Double xDouble = <span class="keyword">new</span> Double(<span class="string">'0x1.0p0'</span>)</div><div class="line"><span class="keyword">assert</span> xDouble == <span class="number">1.0</span>d</div><div class="line"></div><div class="line"><span class="keyword">int</span> xNegativeInt = <span class="number">-0x77</span></div><div class="line"><span class="keyword">assert</span> xNegativeInt == <span class="number">-119</span></div></pre></td></tr></table></figure></p>
<h3 id="Decimal-literals"><a href="#Decimal-literals" class="headerlink" title="Decimal literals"></a>Decimal literals</h3><p>小数字面量和在java 里一样</p>
<ul>
<li>float</li>
<li>double</li>
<li>java.lang.BigDecimal</li>
</ul>
<p>可以通过下面的方式创建小数类型的number<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// primitive types</span></div><div class="line"><span class="keyword">float</span>  f = <span class="number">1.234</span></div><div class="line"><span class="keyword">double</span> d = <span class="number">2.345</span></div><div class="line"></div><div class="line"><span class="comment">// infinite precision</span></div><div class="line">BigDecimal bd =  <span class="number">3.456</span></div></pre></td></tr></table></figure></p>
<p>Decimals can use exponents, with the e or E exponent letter, followed by an optional sign, and a integral number representing the exponent:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> <span class="number">1e3</span>  ==  <span class="number">1</span>_000<span class="number">.0</span></div><div class="line"><span class="keyword">assert</span> <span class="number">2E4</span>  == <span class="number">20</span>_000<span class="number">.0</span></div><div class="line"><span class="keyword">assert</span> <span class="number">3e+1</span> ==     <span class="number">30.0</span></div><div class="line"><span class="keyword">assert</span> <span class="number">4E-2</span> ==      <span class="number">0.04</span></div><div class="line"><span class="keyword">assert</span> <span class="number">5e-1</span> ==      <span class="number">0.5</span></div></pre></td></tr></table></figure>
<p>Conveniently for exact decimal number calculations, Groovy choses java.lang.BigDecimal as its decimal number type. In addition, both float and double are supported, but require an explicit type declaration, type coercion or suffix. Even if BigDecimal is the default for decimal numbers, such literals are accepted in methods or closures taking float or double as parameter types.</p>
<p>Decimal numbers can’t be represented using a binary, octal or hexadecimal representation.</p>
<h3 id="Underscore-in-literals"><a href="#Underscore-in-literals" class="headerlink" title="Underscore in literals"></a>Underscore in literals</h3><p>When writing long literal numbers, it’s harder on the eye to figure out how some numbers are grouped together, for example with groups of thousands, of words, etc. By allowing you to place underscore in number literals, it’s easier to spot those groups:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">long</span> creditCardNumber = <span class="number">1234</span>_5678_9012_3456L</div><div class="line"><span class="keyword">long</span> socialSecurityNumbers = <span class="number">999</span>_99_9999L</div><div class="line"><span class="keyword">double</span> monetaryAmount = <span class="number">12</span>_345_132<span class="number">.12</span></div><div class="line"><span class="keyword">long</span> hexBytes = <span class="number">0xFF</span>_EC_DE_5E</div><div class="line"><span class="keyword">long</span> hexWords = <span class="number">0xFFEC</span>_DE5E</div><div class="line"><span class="keyword">long</span> maxLong = <span class="number">0x7fff</span>_ffff_ffff_ffffL</div><div class="line"><span class="keyword">long</span> alsoMaxLong = <span class="number">9</span>_223_372_036_854_775_807L</div><div class="line"><span class="keyword">long</span> bytes = <span class="number">0b11010010</span>_01101001_10010100_10010010</div></pre></td></tr></table></figure>
<h3 id="Number-type-suffixes"><a href="#Number-type-suffixes" class="headerlink" title="Number type suffixes"></a>Number type suffixes</h3><p>我们可以通过添加后缀的方式强制指定一个数字的类型(包含二进制,八进制和十六进制)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Type			Suffix</div><div class="line">BigInteger		G or g</div><div class="line">Long			L or l</div><div class="line">Integer			I or i</div><div class="line">BigDecimal		G or g</div><div class="line">Double			D or d</div><div class="line">Float			F or f</div></pre></td></tr></table></figure></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> <span class="number">42</span>I == <span class="keyword">new</span> Integer(<span class="string">'42'</span>)</div><div class="line"><span class="keyword">assert</span> <span class="number">42</span>i == <span class="keyword">new</span> Integer(<span class="string">'42'</span>) <span class="comment">// lowercase i more readable</span></div><div class="line"><span class="keyword">assert</span> <span class="number">123</span>L == <span class="keyword">new</span> Long(<span class="string">"123"</span>) <span class="comment">// uppercase L more readable</span></div><div class="line"><span class="keyword">assert</span> <span class="number">2147483648</span> == <span class="keyword">new</span> Long(<span class="string">'2147483648'</span>) <span class="comment">// Long type used, value too large for an Integer</span></div><div class="line"><span class="keyword">assert</span> <span class="number">456</span>G == <span class="keyword">new</span> BigInteger(<span class="string">'456'</span>)</div><div class="line"><span class="keyword">assert</span> <span class="number">456</span>g == <span class="keyword">new</span> BigInteger(<span class="string">'456'</span>)</div><div class="line"><span class="keyword">assert</span> <span class="number">123.45</span> == <span class="keyword">new</span> BigDecimal(<span class="string">'123.45'</span>) <span class="comment">// default BigDecimal type used</span></div><div class="line"><span class="keyword">assert</span> <span class="number">1.200065</span>D == <span class="keyword">new</span> Double(<span class="string">'1.200065'</span>)</div><div class="line"><span class="keyword">assert</span> <span class="number">1.234</span>F == <span class="keyword">new</span> Float(<span class="string">'1.234'</span>)</div><div class="line"><span class="keyword">assert</span> <span class="number">1.23E23</span>D == <span class="keyword">new</span> Double(<span class="string">'1.23E23'</span>)</div><div class="line"><span class="keyword">assert</span> <span class="number">0b1111</span>L.<span class="keyword">class</span> == Long <span class="comment">// binary</span></div><div class="line"><span class="keyword">assert</span> <span class="number">0xFF</span>i.<span class="keyword">class</span> == Integer <span class="comment">// hexadecimal</span></div><div class="line"><span class="keyword">assert</span> <span class="number">034</span>G.<span class="keyword">class</span> == BigInteger <span class="comment">// octal</span></div></pre></td></tr></table></figure>
<h3 id="Math-operations"><a href="#Math-operations" class="headerlink" title="Math operations"></a>Math operations</h3><p>尽管接下来我们还要详细讨论操作符, 但是鉴于数学操作符的重要性, 现在我们还是要先讨论其行为和返回类型</p>
<ul>
<li>byte, char, short 和 int 之间的二进制计算返回的是int类型</li>
<li>byte, char, short 和 int 之间的二进制计算中涉及到long的话, 那么返回的就是long类型</li>
<li>BigInteger 与任何整数类型的二进制计算 返回的结果都是BigInteger类型</li>
<li>float, double 和 BigDecimal 之间的二进制计算返回的结果都是double类型</li>
<li>俩个BigDecimal之间的二进制运算返回的都是BigDecimal类型.</li>
</ul>
<p>由于Groovy提供了操作符重载功能, BigInteger和BigDecimal之间的算术运算也得以实现, 但是在Java中需要调用一些方法才能计算这些不同类型的数字.</p>
<h4 id="The-case-of-the-power-operator"><a href="#The-case-of-the-power-operator" class="headerlink" title="The case of the power operator"></a>The case of the power operator</h4><p>Groovy 里有一种强大的操作符<code>**</code>, 这个操作符带有base和exponent俩个参数. 这个操作符的结果依赖于它的操作数和操作结果.Groovy使用下面的规则来决定该操作符的返回类型</p>
<h5 id="如果exponent为小数类型"><a href="#如果exponent为小数类型" class="headerlink" title="如果exponent为小数类型"></a>如果exponent为小数类型</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>. 如果结果能表示为Integer类型,那就返回Integer类型</div><div class="line"><span class="number">2</span>. 否则如果结果能表示为Long类型,那就返回Long类型</div><div class="line"><span class="number">3</span>. 否则的话就返回Double</div></pre></td></tr></table></figure>
<h5 id="如果exponent为整数类型"><a href="#如果exponent为整数类型" class="headerlink" title="如果exponent为整数类型"></a>如果exponent为整数类型</h5><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="number">1.</span> 如果exponent负数负数, 那就返回Integer, Long 或者Double,</div><div class="line"><span class="number">2.</span> 如果exponent是正数或者<span class="number">0</span>, 那就要根据base来判断了</div><div class="line">	A. 如果base是 BigDecimal, 那就返回BigDecimal类型</div><div class="line">	B. 如果base是 BigInteger, 那就返回BigInteger类型</div><div class="line">	C. 如果base是 Integer, 那就返回Integer类型, 如果返回的值超过Integer范围的话,就返回BigInteger</div><div class="line">	D. 如果base是 Long, 那就返回Long类型, 如果返回的值超过Long范围的话,就返回BigInteger</div></pre></td></tr></table></figure>
<h5 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h5><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// base and exponent are ints and the result can be represented by an Integer</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">2</span>    **   <span class="number">3</span>    <span class="keyword">instanceof</span> Integer    <span class="comment">//  8</span></div><div class="line"><span class="keyword">assert</span>   <span class="number">10</span>    **   <span class="number">9</span>    <span class="keyword">instanceof</span> Integer    <span class="comment">//  1_000_000_000</span></div><div class="line"></div><div class="line"><span class="comment">// the base is a long, so fit the result in a Long</span></div><div class="line"><span class="comment">// (although it could have fit in an Integer)</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">5</span>L   **   <span class="number">2</span>    <span class="keyword">instanceof</span> Long       <span class="comment">//  25</span></div><div class="line"></div><div class="line"><span class="comment">// the result can't be represented as an Integer or Long, so return a BigInteger</span></div><div class="line"><span class="keyword">assert</span>  <span class="number">100</span>    **  <span class="number">10</span>    <span class="keyword">instanceof</span> BigInteger <span class="comment">//  10e20</span></div><div class="line"><span class="keyword">assert</span> <span class="number">1234</span>    ** <span class="number">123</span>    <span class="keyword">instanceof</span> BigInteger <span class="comment">//  170515806212727042875...</span></div><div class="line"></div><div class="line"><span class="comment">// the base is a BigDecimal and the exponent a negative int</span></div><div class="line"><span class="comment">// but the result can be represented as an Integer</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">0.5</span>  **  <span class="number">-2</span>    <span class="keyword">instanceof</span> Integer    <span class="comment">//  4</span></div><div class="line"></div><div class="line"><span class="comment">// the base is an int, and the exponent a negative float</span></div><div class="line"><span class="comment">// but again, the result can be represented as an Integer</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">1</span>    **  <span class="number">-0.3</span>f <span class="keyword">instanceof</span> Integer    <span class="comment">//  1</span></div><div class="line"></div><div class="line"><span class="comment">// the base is an int, and the exponent a negative int</span></div><div class="line"><span class="comment">// but the result will be calculated as a Double</span></div><div class="line"><span class="comment">// (both base and exponent are actually converted to doubles)</span></div><div class="line"><span class="keyword">assert</span>   <span class="number">10</span>    **  <span class="number">-1</span>    <span class="keyword">instanceof</span> Double     <span class="comment">//  0.1</span></div><div class="line"></div><div class="line"><span class="comment">// the base is a BigDecimal, and the exponent is an int, so return a BigDecimal</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">1.2</span>  **  <span class="number">10</span>    <span class="keyword">instanceof</span> BigDecimal <span class="comment">//  6.1917364224</span></div><div class="line"></div><div class="line"><span class="comment">// the base is a float or double, and the exponent is an int</span></div><div class="line"><span class="comment">// but the result can only be represented as a Double value</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">3.4</span>f **   <span class="number">5</span>    <span class="keyword">instanceof</span> Double     <span class="comment">//  454.35430372146965</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">5.6</span>d **   <span class="number">2</span>    <span class="keyword">instanceof</span> Double     <span class="comment">//  31.359999999999996</span></div><div class="line"></div><div class="line"><span class="comment">// the exponent is a decimal value</span></div><div class="line"><span class="comment">// and the result can only be represented as a Double value</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">7.8</span>  **   <span class="number">1.9</span>  <span class="keyword">instanceof</span> Double     <span class="comment">//  49.542708423868476</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">2</span>    **   <span class="number">0.1</span>f <span class="keyword">instanceof</span> Double     <span class="comment">//  1.0717734636432956</span></div></pre></td></tr></table></figure>
<h2 id="Booleans"><a href="#Booleans" class="headerlink" title="Booleans"></a>Booleans</h2><p>Boolean是一种特殊的数据类型, 他们的值只有俩种情况：true 和 false.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> myBooleanVariable = <span class="literal">true</span></div><div class="line"><span class="keyword">boolean</span> untypedBooleanVar = <span class="literal">false</span></div><div class="line">booleanField = <span class="literal">true</span></div></pre></td></tr></table></figure></p>
<p>true and false are the only two primitive boolean values. But more complex boolean expressions can be represented using logical operators.</p>
<p>In addition, Groovy has special rules (often referred to as Groovy Truth) for coercing non-boolean objects to a boolean value.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/04/15/编程语言/Groovy 数字/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/04/15/编程语言/Groovy 数字/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/04/11/编程语言/Groovy 集合/" title="Groovy 集合" itemprop="url">Groovy 集合</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-04-11T07:00:00.000Z" itemprop="datePublished"> Published 2014-04-11</time>
    
  </p>
</header>
    <div class="article-content">
        
        <blockquote>
<p>本文是对Groovy部分官方文档进行了翻译</p>
</blockquote>
<p>Groovy 语言层面上就支持多种集合类型,包括list, map, range. 大多数类型集合都是基于java的集合框架,而且Groovy development kit对这些集合内置很多快捷方法.</p>
<h3 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h3><p>Groovy使用了一种被<code>[]</code>括起来,值通过<code>,</code>分割的语法 定义list. Groovy list 采用的是 JDK里<code>java.util.List</code>的实现, 因为它自身并没有定义自己的集合类.<br>Groovy list 的默认实现是<code>java.util.ArrayList</code>, 在后面我们可以看到其他形式的list</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]         (<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> numbers <span class="keyword">instanceof</span> List  (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> numbers.size() == <span class="number">3</span>      (<span class="number">3</span>)</div></pre></td></tr></table></figure>
<ol>
<li>我们定义了一个Number类型的List,然后将这个list分配给一个变量</li>
<li>判断list是 Java’s <code>java.util.List</code> interface 的实例</li>
<li>list的大小可以通过size()来进行查询, 例子中也给我们展示了这个list确实包含3个元素</li>
</ol>
<p>在上面的list中,我们使用的是同类元素的list, 但其实Groovy list中的数据类型还可以不一样：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> heterogeneous = [<span class="number">1</span>, <span class="string">"a"</span>, <span class="literal">true</span>]  (<span class="number">1</span>)</div></pre></td></tr></table></figure></p>
<ol>
<li>我们定义了一个包含有number,string,boolean 三个类型的list</li>
</ol>
<p>在上面我们提到过, list实际上是<code>java.util.ArrayList</code>实例, 但其实list还可以是其他不同类型的实例, 下面我们通过操作符或者显式类型声明来强制指定 list使用不同的List实现<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> arrayList = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</div><div class="line"><span class="keyword">assert</span> arrayList <span class="keyword">instanceof</span> java.util.ArrayList</div><div class="line"></div><div class="line"><span class="keyword">def</span> linkedList = [<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>] <span class="keyword">as</span> LinkedList    (<span class="number">1</span>)</div><div class="line"><span class="keyword">assert</span> linkedList <span class="keyword">instanceof</span> java.util.LinkedList</div><div class="line"></div><div class="line">LinkedList otherLinked = [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]          (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> otherLinked <span class="keyword">instanceof</span> java.util.LinkedList</div></pre></td></tr></table></figure></p>
<ol>
<li>我们使用操作符强制将类型显式地声明为<code>java.util.LinkedList</code></li>
<li>我们使用显式声明方式, 将list声明为<code>java.util.LinkedList</code></li>
</ol>
<p>我们可以通过<code>[]</code>下标操作符来访问list中的元素(读写都可以). 下标既如果是正数的话,那就从左到右访问元素, 如果下标是负数那就从右到左访问元素. 我们好可以使用<code>&lt;&lt;</code>操作符向list里追加元素<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> letters = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>]</div><div class="line"></div><div class="line"><span class="keyword">assert</span> letters[<span class="number">0</span>] == <span class="string">'a'</span>     (<span class="number">1</span>)</div><div class="line"><span class="keyword">assert</span> letters[<span class="number">1</span>] == <span class="string">'b'</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> letters[<span class="number">-1</span>] == <span class="string">'d'</span>    (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> letters[<span class="number">-2</span>] == <span class="string">'c'</span></div><div class="line"></div><div class="line">letters[<span class="number">2</span>] = <span class="string">'C'</span>             (<span class="number">3</span>)</div><div class="line"><span class="keyword">assert</span> letters[<span class="number">2</span>] == <span class="string">'C'</span></div><div class="line"></div><div class="line">letters &lt;&lt; <span class="string">'e'</span>               (<span class="number">4</span>)</div><div class="line"><span class="keyword">assert</span> letters[ <span class="number">4</span>] == <span class="string">'e'</span></div><div class="line"><span class="keyword">assert</span> letters[<span class="number">-1</span>] == <span class="string">'e'</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> letters[<span class="number">1</span>, <span class="number">3</span>] == [<span class="string">'b'</span>, <span class="string">'d'</span>]         (<span class="number">5</span>)</div><div class="line"><span class="keyword">assert</span> letters[<span class="number">2.</span><span class="number">.4</span>] == [<span class="string">'C'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>]    (<span class="number">6</span>)</div></pre></td></tr></table></figure></p>
<ol>
<li>访问第一个元素(从这可以看出,list的下标是从0开始的)</li>
<li>通过-1 下标访问list中的最后一个元素.</li>
<li>使用下标对list中第三个元素重新赋值</li>
<li>使用<code>&lt;&lt;</code>向list尾部添加一个元素</li>
<li>一次性访问list中俩个元素,这个操作的结果是返回一个包含俩个元素的新的list</li>
<li>使用值域符来访问list中一定范围内的值.</li>
</ol>
<p>由于list支持多种不同类型的元素, 那么list中也可以包含list,这样就可以制造出多维list<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> multi = [[<span class="number">0</span>, <span class="number">1</span>], [<span class="number">2</span>, <span class="number">3</span>]]     (<span class="number">1</span>)</div><div class="line"><span class="keyword">assert</span> multi[<span class="number">1</span>][<span class="number">0</span>] == <span class="number">2</span>          (<span class="number">2</span>)</div></pre></td></tr></table></figure></p>
<ol>
<li>定义了一个包含Number类型list的list</li>
<li>访问外层的第二个元素(第二个list), 然后访问内部list的第一个元素(第二个list的第一个元素)</li>
</ol>
<h4 id="List-literals"><a href="#List-literals" class="headerlink" title="List literals"></a>List literals</h4><p>你可以像下面这样创建集合, 注意<code>[]</code>是空集合表达式.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> list = [<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</div><div class="line"><span class="keyword">assert</span> list.get(<span class="number">2</span>) == <span class="number">7</span></div><div class="line"><span class="keyword">assert</span> list[<span class="number">2</span>] == <span class="number">7</span></div><div class="line"><span class="keyword">assert</span> list <span class="keyword">instanceof</span> java.util.List</div><div class="line"></div><div class="line"><span class="keyword">def</span> emptyList = []</div><div class="line"><span class="keyword">assert</span> emptyList.size() == <span class="number">0</span></div><div class="line">emptyList.add(<span class="number">5</span>)</div><div class="line"><span class="keyword">assert</span> emptyList.size() == <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>每一个list表达式都是实现自<code>java.util.List</code></p>
<p>当然list也可以指定其具体的实现类型<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> list1 = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</div><div class="line"><span class="comment">//construct a new list, seeded with the same items as in list1</span></div><div class="line"><span class="keyword">def</span> list2 = <span class="keyword">new</span> ArrayList&lt;String&gt;(list1)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> list2 == list1 <span class="comment">// == checks that each corresponding element is the same</span></div><div class="line"></div><div class="line"><span class="comment">// clone() can also be called</span></div><div class="line"><span class="keyword">def</span> list3 = list1.clone()</div><div class="line"><span class="keyword">assert</span> list3 == list1</div></pre></td></tr></table></figure></p>
<p>list本质上是一个有序的对象集合.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> list = [<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</div><div class="line"><span class="keyword">assert</span> list.size() == <span class="number">4</span></div><div class="line"><span class="keyword">assert</span> list.getClass() == ArrayList     <span class="comment">// the specific kind of list being used</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> list[<span class="number">2</span>] == <span class="number">7</span>                     <span class="comment">// indexing starts at 0</span></div><div class="line"><span class="keyword">assert</span> list.getAt(<span class="number">2</span>) == <span class="number">7</span>               <span class="comment">// equivalent method to subscript operator []</span></div><div class="line"><span class="keyword">assert</span> list.get(<span class="number">2</span>) == <span class="number">7</span>                 <span class="comment">// alternative method</span></div><div class="line"></div><div class="line">list[<span class="number">2</span>] = <span class="number">9</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="number">5</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">8</span>,]           <span class="comment">// trailing comma OK</span></div><div class="line"></div><div class="line">list.putAt(<span class="number">2</span>, <span class="number">10</span>)                       <span class="comment">// equivalent method to [] when value being changed</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="number">5</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">8</span>]</div><div class="line"><span class="keyword">assert</span> list.set(<span class="number">2</span>, <span class="number">11</span>) == <span class="number">10</span>            <span class="comment">// alternative method that returns old value</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="number">5</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">8</span>]</div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="number">1</span>, <span class="string">'a'</span>, <span class="string">'a'</span>, <span class="number">2.5</span>, <span class="number">2.5</span>f, <span class="number">2.5</span>d, <span class="string">'hello'</span>, <span class="number">7</span>g, <span class="literal">null</span>, <span class="number">9</span> <span class="keyword">as</span> <span class="keyword">byte</span>]</div><div class="line"><span class="comment">//objects can be of different types; duplicates allowed</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>][<span class="number">-1</span>] == <span class="number">5</span>             <span class="comment">// use negative indices to count from the end</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>][<span class="number">-2</span>] == <span class="number">4</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>].getAt(<span class="number">-2</span>) == <span class="number">4</span>       <span class="comment">// getAt() available with negative index...</span></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>].get(<span class="number">-2</span>)                 <span class="comment">// but negative index not allowed with get()</span></div><div class="line">    <span class="keyword">assert</span> <span class="literal">false</span></div><div class="line">&#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">    <span class="keyword">assert</span> e <span class="keyword">instanceof</span> ArrayIndexOutOfBoundsException</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="List-as-a-boolean-expression"><a href="#List-as-a-boolean-expression" class="headerlink" title="List as a boolean expression"></a>List as a boolean expression</h4><p>list还可以计算出boolean表达式.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> ![]             <span class="comment">// an empty list evaluates as false</span></div><div class="line"></div><div class="line"><span class="comment">//all other lists, irrespective of contents, evaluate as true</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>] &amp;&amp; [<span class="string">'a'</span>] &amp;&amp; [<span class="number">0</span>] &amp;&amp; [<span class="number">0.0</span>] &amp;&amp; [<span class="literal">false</span>] &amp;&amp; [<span class="literal">null</span>]</div></pre></td></tr></table></figure></p>
<h4 id="Iterating-on-a-list"><a href="#Iterating-on-a-list" class="headerlink" title="Iterating on a list"></a>Iterating on a list</h4><p>可以通过<code>each</code>, <code>eachWithIndex</code>遍历整个集合.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].each &#123;</div><div class="line">    println <span class="string">"Item: $it"</span> <span class="comment">// `it` is an implicit parameter corresponding to the current element</span></div><div class="line">&#125;</div><div class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>].eachWithIndex &#123; it, i -&gt; <span class="comment">// `it` is the current element, while `i` is the index</span></div><div class="line">    println <span class="string">"$i: $it"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在遍历的时候,我们经常需要将遍历出来的值经过某些运算,然后再重新放进一个新的list中. 这种操作经常称为映射(mapping), 这种操作通过<code>collect</code>方法实现.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].collect &#123; it * <span class="number">2</span> &#125; == [<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>]</div><div class="line"></div><div class="line"><span class="comment">// shortcut syntax instead of collect</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]*.multiply(<span class="number">2</span>) == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].collect &#123; it.multiply(<span class="number">2</span>) &#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> list = [<span class="number">0</span>]</div><div class="line"><span class="comment">// it is possible to give `collect` the list which collects the elements</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].collect(list) &#123; it * <span class="number">2</span> &#125; == [<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>]</div><div class="line"><span class="keyword">assert</span> list == [<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>]</div></pre></td></tr></table></figure></p>
<h4 id="Manipulating-lists"><a href="#Manipulating-lists" class="headerlink" title="Manipulating lists"></a>Manipulating lists</h4><h5 id="Filtering-and-searching"><a href="#Filtering-and-searching" class="headerlink" title="Filtering and searching"></a>Filtering and searching</h5><p><a href="http://www.groovy-lang.org/gdk.html" target="_blank" rel="external">Groovy development kit</a>提供了许多强大有趣的方法用来强化标准集合:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].find &#123; it &gt; <span class="number">1</span> &#125; == <span class="number">2</span>           <span class="comment">// find 1st element matching criteria</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].findAll &#123; it &gt; <span class="number">1</span> &#125; == [<span class="number">2</span>, <span class="number">3</span>]   <span class="comment">// find all elements matching critieria</span></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>].findIndexOf &#123;      <span class="comment">// find index of 1st element matching criteria</span></div><div class="line">    it <span class="keyword">in</span> [<span class="string">'c'</span>, <span class="string">'e'</span>, <span class="string">'g'</span>]</div><div class="line">&#125; == <span class="number">2</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'c'</span>].indexOf(<span class="string">'c'</span>) == <span class="number">2</span>  <span class="comment">// index returned</span></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'c'</span>].indexOf(<span class="string">'z'</span>) == <span class="number">-1</span> <span class="comment">// index -1 means value not in list</span></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'c'</span>].lastIndexOf(<span class="string">'c'</span>) == <span class="number">4</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].every &#123; it &lt; <span class="number">5</span> &#125;               <span class="comment">// returns true if all elements match the predicate</span></div><div class="line"><span class="keyword">assert</span> ![<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].every &#123; it &lt; <span class="number">3</span> &#125;</div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].any &#123; it &gt; <span class="number">2</span> &#125;                 <span class="comment">// returns true if any element matches the predicate</span></div><div class="line"><span class="keyword">assert</span> ![<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].any &#123; it &gt; <span class="number">3</span> &#125;</div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>].sum() == <span class="number">21</span>                <span class="comment">// sum anything with a plus() method</span></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>].sum &#123;</div><div class="line">    it == <span class="string">'a'</span> ? 1 : it == <span class="string">'b'</span> ? 2 : it == <span class="string">'c'</span> ? 3 : it == <span class="string">'d'</span> ? 4 : it == <span class="string">'e'</span> ? 5 : <span class="number">0</span></div><div class="line">    <span class="comment">// custom value to use in sum</span></div><div class="line">&#125; == <span class="number">15</span></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>].sum &#123; ((<span class="keyword">char</span>) it) - ((<span class="keyword">char</span>) <span class="string">'a'</span>) &#125; == <span class="number">10</span></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>].sum() == <span class="string">'abcde'</span></div><div class="line"><span class="keyword">assert</span> [[<span class="string">'a'</span>, <span class="string">'b'</span>], [<span class="string">'c'</span>, <span class="string">'d'</span>]].sum() == [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>]</div><div class="line"></div><div class="line"><span class="comment">// an initial value can be provided</span></div><div class="line"><span class="keyword">assert</span> [].sum(<span class="number">1000</span>) == <span class="number">1000</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].sum(<span class="number">1000</span>) == <span class="number">1006</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].join(<span class="string">'-'</span>) == <span class="string">'1-2-3'</span>           <span class="comment">// String joining</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].inject(<span class="string">'counting: '</span>) &#123;</div><div class="line">    str, item -&gt; str + item                     <span class="comment">// reduce operation</span></div><div class="line">&#125; == <span class="string">'counting: 123'</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].inject(<span class="number">0</span>) &#123; count, item -&gt;</div><div class="line">    count + item</div><div class="line">&#125; == <span class="number">6</span></div></pre></td></tr></table></figure>
<p>下面这段代码是由Groovy语言支撑的在集合中找到最大和最小数的例子:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> list = [<span class="number">9</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">10</span>, <span class="number">5</span>]</div><div class="line"><span class="keyword">assert</span> list.max() == <span class="number">10</span></div><div class="line"><span class="keyword">assert</span> list.min() == <span class="number">2</span></div><div class="line"></div><div class="line"><span class="comment">// we can also compare single characters, as anything comparable</span></div><div class="line"><span class="keyword">assert</span> [<span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'a'</span>, <span class="string">'z'</span>].min() == <span class="string">'a'</span></div><div class="line"></div><div class="line"><span class="comment">// we can use a closure to specify the sorting behaviour</span></div><div class="line"><span class="keyword">def</span> list2 = [<span class="string">'abc'</span>, <span class="string">'z'</span>, <span class="string">'xyzuvw'</span>, <span class="string">'Hello'</span>, <span class="string">'321'</span>]</div><div class="line"><span class="keyword">assert</span> list2.max &#123; it.size() &#125; == <span class="string">'xyzuvw'</span></div><div class="line"><span class="keyword">assert</span> list2.min &#123; it.size() &#125; == <span class="string">'z'</span></div></pre></td></tr></table></figure></p>
<p>在闭包里,你还可以自定义一个比较规则.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Comparator mc = &#123; a, b -&gt; a == b ? 0 : (a &lt; b ? -1 : <span class="number">1</span>) &#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> list = [<span class="number">7</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">-6</span>, <span class="number">-1</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">-9</span>, <span class="number">5</span>, <span class="number">-13</span>]</div><div class="line"><span class="keyword">assert</span> list.max(mc) == <span class="number">11</span></div><div class="line"><span class="keyword">assert</span> list.min(mc) == <span class="number">-13</span></div><div class="line"></div><div class="line">Comparator mc2 = &#123; a, b -&gt; a == b ? 0 : (Math.abs(a) &lt; Math.abs(b)) ? -1 : <span class="number">1</span> &#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">assert</span> list.max(mc2) == <span class="number">-13</span></div><div class="line"><span class="keyword">assert</span> list.min(mc2) == <span class="number">-1</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> list.max &#123; a, b -&gt; a.equals(b) ? 0 : Math.abs(a) &lt; Math.abs(b) ? -1 : <span class="number">1</span> &#125; == <span class="number">-13</span></div><div class="line"><span class="keyword">assert</span> list.min &#123; a, b -&gt; a.equals(b) ? 0 : Math.abs(a) &lt; Math.abs(b) ? -1 : <span class="number">1</span> &#125; == <span class="number">-1</span></div></pre></td></tr></table></figure></p>
<h5 id="Adding-or-removing-elements"><a href="#Adding-or-removing-elements" class="headerlink" title="Adding or removing elements"></a>Adding or removing elements</h5><p>我们可以使用<code>[]</code>去声明一个新的空list, 然后使用<code>&lt;&lt;</code>向list追加元素<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> list = []</div><div class="line"><span class="keyword">assert</span> list.empty</div><div class="line"></div><div class="line">list &lt;&lt; <span class="number">5</span></div><div class="line"><span class="keyword">assert</span> list.size() == <span class="number">1</span></div><div class="line"></div><div class="line">list &lt;&lt; <span class="number">7</span> &lt;&lt; <span class="string">'i'</span> &lt;&lt; <span class="number">11</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="number">5</span>, <span class="number">7</span>, <span class="string">'i'</span>, <span class="number">11</span>]</div><div class="line"></div><div class="line">list &lt;&lt; [<span class="string">'m'</span>, <span class="string">'o'</span>]</div><div class="line"><span class="keyword">assert</span> list == [<span class="number">5</span>, <span class="number">7</span>, <span class="string">'i'</span>, <span class="number">11</span>, [<span class="string">'m'</span>, <span class="string">'o'</span>]]</div><div class="line"></div><div class="line"><span class="comment">//first item in chain of &lt;&lt; is target list</span></div><div class="line"><span class="keyword">assert</span> ([<span class="number">1</span>, <span class="number">2</span>] &lt;&lt; <span class="number">3</span> &lt;&lt; [<span class="number">4</span>, <span class="number">5</span>] &lt;&lt; <span class="number">6</span>) == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, [<span class="number">4</span>, <span class="number">5</span>], <span class="number">6</span>]</div><div class="line"></div><div class="line"><span class="comment">//using leftShift is equivalent to using &lt;&lt;</span></div><div class="line"><span class="keyword">assert</span> ([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] &lt;&lt; <span class="number">4</span>) == ([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].leftShift(<span class="number">4</span>))</div><div class="line">```groovy</div><div class="line">We can add to a list <span class="keyword">in</span> many <span class="string">ways:</span></div><div class="line">```groovy</div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>] + <span class="number">3</span> + [<span class="number">4</span>, <span class="number">5</span>] + <span class="number">6</span> == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</div><div class="line"><span class="comment">// equivalent to calling the `plus` method</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>].plus(<span class="number">3</span>).plus([<span class="number">4</span>, <span class="number">5</span>]).plus(<span class="number">6</span>) == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</div><div class="line"></div><div class="line"><span class="keyword">def</span> a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</div><div class="line">a += <span class="number">4</span>      <span class="comment">// creates a new list and assigns it to `a`</span></div><div class="line">a += [<span class="number">5</span>, <span class="number">6</span>]</div><div class="line"><span class="keyword">assert</span> a == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, *[<span class="number">222</span>, <span class="number">333</span>], <span class="number">456</span>] == [<span class="number">1</span>, <span class="number">222</span>, <span class="number">333</span>, <span class="number">456</span>]</div><div class="line"><span class="keyword">assert</span> [*[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]] == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, [<span class="number">2</span>, <span class="number">3</span>, [<span class="number">4</span>, <span class="number">5</span>], <span class="number">6</span>], <span class="number">7</span>, [<span class="number">8</span>, <span class="number">9</span>]].flatten() == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]</div><div class="line"></div><div class="line"><span class="keyword">def</span> list = [<span class="number">1</span>, <span class="number">2</span>]</div><div class="line">list.add(<span class="number">3</span>)</div><div class="line">list.addAll([<span class="number">5</span>, <span class="number">4</span>])</div><div class="line"><span class="keyword">assert</span> list == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>]</div><div class="line"></div><div class="line">list = [<span class="number">1</span>, <span class="number">2</span>]</div><div class="line">list.add(<span class="number">1</span>, <span class="number">3</span>) <span class="comment">// add 3 just before index 1</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>]</div><div class="line"></div><div class="line">list.addAll(<span class="number">2</span>, [<span class="number">5</span>, <span class="number">4</span>]) <span class="comment">//add [5,4] just before index 2</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">2</span>]</div><div class="line"></div><div class="line">list = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'z'</span>, <span class="string">'e'</span>, <span class="string">'u'</span>, <span class="string">'v'</span>, <span class="string">'g'</span>]</div><div class="line">list[<span class="number">8</span>] = <span class="string">'x'</span> <span class="comment">// the [] operator is growing the list as needed</span></div><div class="line"><span class="comment">// nulls inserted if required</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'z'</span>, <span class="string">'e'</span>, <span class="string">'u'</span>, <span class="string">'v'</span>, <span class="string">'g'</span>, <span class="literal">null</span>, <span class="string">'x'</span>]</div></pre></td></tr></table></figure></p>
<p>在list中<code>+</code>的语义并没有发生变化,这是何等的重要啊~~~ 与<code>&lt;&lt;</code>相比, <code>+</code>会创建一个新的list,  但是这个创建的list很可能不是你所预期的, 而且这种方式也可能会导致一些性能问题.</p>
<p><code>Groovy development kit</code>同样提供了很多便捷的方式从list里删除元素:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'b'</span>,<span class="string">'b'</span>] - <span class="string">'c'</span> == [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'b'</span>,<span class="string">'b'</span>]</div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'b'</span>,<span class="string">'b'</span>] - <span class="string">'b'</span> == [<span class="string">'a'</span>,<span class="string">'c'</span>]</div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'b'</span>,<span class="string">'b'</span>] - [<span class="string">'b'</span>,<span class="string">'c'</span>] == [<span class="string">'a'</span>]</div><div class="line"></div><div class="line"><span class="keyword">def</span> list = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>]</div><div class="line">list -= <span class="number">3</span>           <span class="comment">// creates a new list by removing `3` from the original one</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">1</span>]</div><div class="line"><span class="keyword">assert</span> ( list -= [<span class="number">2</span>,<span class="number">4</span>] ) == [<span class="number">1</span>,<span class="number">1</span>]</div></pre></td></tr></table></figure></p>
<p>同样,你也能通过索引的方式从list里删除元素.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> list = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>]</div><div class="line"><span class="keyword">assert</span> list.remove(<span class="number">2</span>) == <span class="number">3</span>          <span class="comment">// remove the third element, and return it</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>]</div></pre></td></tr></table></figure></p>
<p>假设,你如果从list中删除多个相同元素中的第一个, 那你可以调用<code>remove</code>方法.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> list= [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'b'</span>,<span class="string">'b'</span>]</div><div class="line"><span class="keyword">assert</span> list.remove(<span class="string">'c'</span>)             <span class="comment">// remove 'c', and return true because element removed</span></div><div class="line"><span class="keyword">assert</span> list.remove(<span class="string">'b'</span>)             <span class="comment">// remove first 'b', and return true because element removed</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> ! list.remove(<span class="string">'z'</span>)           <span class="comment">// return false because no elements removed</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'b'</span>]</div></pre></td></tr></table></figure></p>
<p>如果你想要将list清空的话,只需要调用<code>clear</code>方法即可<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> list= [<span class="string">'a'</span>,<span class="number">2</span>,<span class="string">'c'</span>,<span class="number">4</span>]</div><div class="line">list.clear()</div><div class="line"><span class="keyword">assert</span> list == []</div></pre></td></tr></table></figure></p>
<h5 id="Set-operations"><a href="#Set-operations" class="headerlink" title="Set operations"></a>Set operations</h5><p><code>Groovy development kit</code>还包含很多逻辑运算的方法<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> <span class="string">'a'</span> <span class="keyword">in</span> [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>]             <span class="comment">// returns true if an element belongs to the list</span></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>].contains(<span class="string">'a'</span>)      <span class="comment">// equivalent to the `contains` method in Java</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>].containsAll([<span class="number">1</span>,<span class="number">4</span>])       <span class="comment">// `containsAll` will check that all elements are found</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>].count(<span class="number">3</span>) == <span class="number">4</span>  <span class="comment">// count the number of elements which have some value</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>].count &#123;</div><div class="line">    it%<span class="number">2</span>==<span class="number">0</span>                             <span class="comment">// count the number of elements which match the predicate</span></div><div class="line">&#125; == <span class="number">2</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">8</span>,<span class="number">10</span>,<span class="number">12</span>].intersect([<span class="number">1</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">9</span>,<span class="number">12</span>]) == [<span class="number">1</span>,<span class="number">6</span>,<span class="number">12</span>]</div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].disjoint( [<span class="number">4</span>,<span class="number">6</span>,<span class="number">9</span>] )</div><div class="line"><span class="keyword">assert</span> ![<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].disjoint( [<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>] )</div></pre></td></tr></table></figure></p>
<h5 id="Sorting"><a href="#Sorting" class="headerlink" title="Sorting"></a>Sorting</h5><p>Groovy还提供了很多使用闭包比较器的排序操作<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> [<span class="number">6</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">5</span>].sort() == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">9</span>]</div><div class="line"></div><div class="line"><span class="keyword">def</span> list = [<span class="string">'abc'</span>, <span class="string">'z'</span>, <span class="string">'xyzuvw'</span>, <span class="string">'Hello'</span>, <span class="string">'321'</span>]</div><div class="line"><span class="keyword">assert</span> list.sort &#123;</div><div class="line">    it.size()</div><div class="line">&#125; == [<span class="string">'z'</span>, <span class="string">'abc'</span>, <span class="string">'321'</span>, <span class="string">'Hello'</span>, <span class="string">'xyzuvw'</span>]</div><div class="line"></div><div class="line"><span class="keyword">def</span> list2 = [<span class="number">7</span>, <span class="number">4</span>, <span class="number">-6</span>, <span class="number">-1</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">-9</span>, <span class="number">5</span>, <span class="number">-13</span>]</div><div class="line"><span class="keyword">assert</span> list2.sort &#123; a, b -&gt; a == b ? 0 : Math.abs(a) &lt; Math.abs(b) ? -1 : <span class="number">1</span> &#125; ==</div><div class="line">        [<span class="number">-1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">-6</span>, <span class="number">7</span>, <span class="number">-9</span>, <span class="number">11</span>, <span class="number">-13</span>]</div><div class="line"></div><div class="line">Comparator mc = &#123; a, b -&gt; a == b ? 0 : Math.abs(a) &lt; Math.abs(b) ? -1 : <span class="number">1</span> &#125;</div><div class="line"></div><div class="line"><span class="comment">// JDK 8+ only</span></div><div class="line"><span class="comment">// list2.sort(mc)</span></div><div class="line"><span class="comment">// assert list2 == [-1, 2, 3, 4, 5, -6, 7, -9, 11, -13]</span></div><div class="line"></div><div class="line"><span class="keyword">def</span> list3 = [<span class="number">6</span>, <span class="number">-3</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">-7</span>, <span class="number">1</span>, <span class="number">5</span>]</div><div class="line"></div><div class="line">Collections.sort(list3)</div><div class="line"><span class="keyword">assert</span> list3 == [<span class="number">-7</span>, <span class="number">-3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">9</span>]</div><div class="line"></div><div class="line">Collections.sort(list3, mc)</div><div class="line"><span class="keyword">assert</span> list3 == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">-3</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">-7</span>, <span class="number">9</span>]</div></pre></td></tr></table></figure></p>
<h5 id="Duplicating-elements"><a href="#Duplicating-elements" class="headerlink" title="Duplicating elements"></a>Duplicating elements</h5><p><code>roovy development kit</code>还通过重载操作符的方式, 内部提供了一些方法进行list元素复制.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] * <span class="number">3</span> == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].multiply(<span class="number">2</span>) == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</div><div class="line"><span class="keyword">assert</span> Collections.nCopies(<span class="number">3</span>, <span class="string">'b'</span>) == [<span class="string">'b'</span>, <span class="string">'b'</span>, <span class="string">'b'</span>]</div><div class="line"></div><div class="line"><span class="comment">// nCopies from the JDK has different semantics than multiply for lists</span></div><div class="line"><span class="keyword">assert</span> Collections.nCopies(<span class="number">2</span>, [<span class="number">1</span>, <span class="number">2</span>]) == [[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">1</span>, <span class="number">2</span>]] <span class="comment">//not [1,2,1,2]</span></div></pre></td></tr></table></figure></p>
<h3 id="Arrays"><a href="#Arrays" class="headerlink" title="Arrays"></a>Arrays</h3><p>Groovy 数组重用了list符号, 但是如果想要创建数组, 那么就必须强制地显式定义数组类型<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">String[] arrStr = [<span class="string">'Ananas'</span>, <span class="string">'Banana'</span>, <span class="string">'Kiwi'</span>]  (<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> arrStr <span class="keyword">instanceof</span> String[]    (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> !(arrStr <span class="keyword">instanceof</span> List)</div><div class="line"></div><div class="line"><span class="keyword">def</span> numArr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] <span class="keyword">as</span> <span class="keyword">int</span>[]      (<span class="number">3</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> numArr <span class="keyword">instanceof</span> <span class="keyword">int</span>[]       (<span class="number">4</span>)</div><div class="line"><span class="keyword">assert</span> numArr.size() == <span class="number">3</span></div></pre></td></tr></table></figure></p>
<ol>
<li>使用显式变量类型定义了一个字符串数组</li>
<li>断言刚才创建的数组是否是string类型</li>
<li>使用操作符定义一个int数组</li>
<li>断言刚才创建的数组是否是int类型</li>
</ol>
<p>我们也可以创建出一个多维数组<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> matrix3 = <span class="keyword">new</span> Integer[<span class="number">3</span>][<span class="number">3</span>]         (<span class="number">1</span>)</div><div class="line"><span class="keyword">assert</span> matrix3.size() == <span class="number">3</span></div><div class="line"></div><div class="line">Integer[][] matrix2                     (<span class="number">2</span>)</div><div class="line">matrix2 = [[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]]</div><div class="line"><span class="keyword">assert</span> matrix2 <span class="keyword">instanceof</span> Integer[][]</div></pre></td></tr></table></figure></p>
<ol>
<li>我们指定了新数组的边界</li>
<li>当然我们也可以不指定它的边界</li>
</ol>
<p>访问数组元素和访问list元素的方式相同<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">String[] names = [<span class="string">'Cédric'</span>, <span class="string">'Guillaume'</span>, <span class="string">'Jochen'</span>, <span class="string">'Paul'</span>]</div><div class="line"><span class="keyword">assert</span> names[<span class="number">0</span>] == <span class="string">'Cédric'</span>     (<span class="number">1</span>)</div><div class="line"></div><div class="line">names[<span class="number">2</span>] = <span class="string">'Blackdrag'</span>          (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> names[<span class="number">2</span>] == <span class="string">'Blackdrag'</span></div></pre></td></tr></table></figure></p>
<p>1    Retrieve the first element of the array<br>2    Set the value of the third element of the array to a new value</p>
<ol>
<li>检索数组中第一个元素</li>
<li>对数组中第三个元素重新赋值</li>
</ol>
<p>Groovy不支持Java数组初始化语法, 因为Java数组中的花括号可能被会Groovy无解成闭包</p>
<h3 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h3><p>有时候我们在其他语言中称map为 字典或者关联数组. Map将key和value关联起来, 在Groovy中map被<code>[]</code>括起来, 通过<code>,</code>分割键值对, 键值通过<code>:</code>分割<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> colors = [<span class="string">red:</span> <span class="string">'#FF0000'</span>, <span class="string">green:</span> <span class="string">'#00FF00'</span>, <span class="string">blue:</span> <span class="string">'#0000FF'</span>]   (<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> colors[<span class="string">'red'</span>] == <span class="string">'#FF0000'</span>    (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> colors.green  == <span class="string">'#00FF00'</span>    (<span class="number">3</span>)</div><div class="line"></div><div class="line">colors[<span class="string">'pink'</span>] = <span class="string">'#FF00FF'</span>           (<span class="number">4</span>)</div><div class="line">colors.yellow  = <span class="string">'#FFFF00'</span>           (<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> colors.pink == <span class="string">'#FF00FF'</span></div><div class="line"><span class="keyword">assert</span> colors[<span class="string">'yellow'</span>] == <span class="string">'#FFFF00'</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> colors <span class="keyword">instanceof</span> java.util.LinkedHashMap</div></pre></td></tr></table></figure></p>
<ol>
<li>我们定义了一个string类型的代表颜色名字的数组,</li>
<li>然后使用下标来检索map中是否包含red这个key</li>
<li>我们还可以直接使用<code>.</code>来索引到某个key</li>
<li>我们可以使用下标向map中添加一个新的键值对</li>
<li>我们也可以使用<code>.</code>添加一个新的键值对</li>
</ol>
<p>Groovy创建的map类型默认的是<code>java.util.LinkedHashMap</code></p>
<p>当你想要访问一个不存在的key时：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> colors.unknown == <span class="literal">null</span></div></pre></td></tr></table></figure></p>
<p>你将检索出一个null的结果</p>
<p>在上面的例子中我们使用的是以string作为key, 但是你还可以使用其他类型作为map的key：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> numbers = [<span class="number">1</span>: <span class="string">'one'</span>, <span class="number">2</span>: <span class="string">'two'</span>]</div><div class="line"></div><div class="line"><span class="keyword">assert</span> numbers[<span class="number">1</span>] == <span class="string">'one'</span></div></pre></td></tr></table></figure>
<p>我们使用了number作为了map新的key类型, number类型就会直接被解释为number类型, 因此Groovy不会像先前那样创建一个string类型的key. 但是假设你想要传递一个变量作为key,是变量的值作为key：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> key = <span class="string">'name'</span></div><div class="line"><span class="keyword">def</span> person = [<span class="string">key:</span> <span class="string">'Guillaume'</span>]      (<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> !person.containsKey(<span class="string">'name'</span>)   (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> person.containsKey(<span class="string">'key'</span>)     (<span class="number">3</span>)</div></pre></td></tr></table></figure>
<ol>
<li>与<code>\&#39;Guillaume&#39;</code> 关联的key实际上是<code>&quot;key&quot;</code>这个字符串, 而不是这个key的引用值<code>&#39;name&#39;</code></li>
<li>map中不包含<code>&#39;name&#39;</code>key</li>
<li>取而代之的是map中包含一个<code>&quot;key&quot;</code>的字符串</li>
</ol>
<p>你可以向map中传递一个引号字符串作为key,例如<code>[&quot;name&quot;: &quot;Guillaume&quot;]</code>.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">person = [(key): <span class="string">'Guillaume'</span>]        (<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> person.containsKey(<span class="string">'name'</span>)    (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> !person.containsKey(<span class="string">'key'</span>)    (<span class="number">3</span>)</div></pre></td></tr></table></figure>
<p>1    This time, we surround the key variable with parentheses, to instruct the parser we are passing a variable rather than defining a string key<br>2    The map does contain the name key<br>3    But the map doesn’t contain the key key as before<br>1.<br>2.<br>3.</p>
<h4 id="Map-literals"><a href="#Map-literals" class="headerlink" title="Map literals"></a>Map literals</h4><p>在Groovy中可以使用<code>[:]</code> 创建一个map.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> map = [<span class="string">name:</span> <span class="string">'Gromit'</span>, <span class="string">likes:</span> <span class="string">'cheese'</span>, <span class="string">id:</span> <span class="number">1234</span>]</div><div class="line"><span class="keyword">assert</span> map.get(<span class="string">'name'</span>) == <span class="string">'Gromit'</span></div><div class="line"><span class="keyword">assert</span> map.get(<span class="string">'id'</span>) == <span class="number">1234</span></div><div class="line"><span class="keyword">assert</span> map[<span class="string">'name'</span>] == <span class="string">'Gromit'</span></div><div class="line"><span class="keyword">assert</span> map[<span class="string">'id'</span>] == <span class="number">1234</span></div><div class="line"><span class="keyword">assert</span> map <span class="keyword">instanceof</span> java.util.Map</div><div class="line"></div><div class="line"><span class="keyword">def</span> emptyMap = [:]</div><div class="line"><span class="keyword">assert</span> emptyMap.size() == <span class="number">0</span></div><div class="line">emptyMap.put(<span class="string">"foo"</span>, <span class="number">5</span>)</div><div class="line"><span class="keyword">assert</span> emptyMap.size() == <span class="number">1</span></div><div class="line"><span class="keyword">assert</span> emptyMap.get(<span class="string">"foo"</span>) == <span class="number">5</span></div></pre></td></tr></table></figure></p>
<p>Map的key默认是<code>string</code>, 例如<code>[a:1]</code>等同于<code>[&#39;a&#39;:1]</code>. 比较荣誉造成疑惑的就是,如果你创建了一个变量a(值为b), 但是你将变量a<code>put</code>进map后, map的key会是a,而不是b. 如果你遇到了这个情况的话,那么你必须对使用<code>()</code>key进行转义了.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> a = <span class="string">'Bob'</span></div><div class="line"><span class="keyword">def</span> ages = [<span class="string">a:</span> <span class="number">43</span>]</div><div class="line"><span class="keyword">assert</span> ages[<span class="string">'Bob'</span>] == <span class="literal">null</span> <span class="comment">// `Bob` is not found</span></div><div class="line"><span class="keyword">assert</span> ages[<span class="string">'a'</span>] == <span class="number">43</span>     <span class="comment">// because `a` is a literal!</span></div><div class="line"></div><div class="line">ages = [(a): <span class="number">43</span>]            <span class="comment">// now we escape `a` by using parenthesis</span></div><div class="line"><span class="keyword">assert</span> ages[<span class="string">'Bob'</span>] == <span class="number">43</span>   <span class="comment">// and the value is found!</span></div></pre></td></tr></table></figure></p>
<p>通过下面的方式你可以轻松克隆一个map<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> map = [</div><div class="line">        <span class="string">simple :</span> <span class="number">123</span>,</div><div class="line"><span class="symbol">        complex:</span> [<span class="string">a:</span> <span class="number">1</span>, <span class="string">b:</span> <span class="number">2</span>]</div><div class="line">]</div><div class="line"><span class="keyword">def</span> map2 = map.clone()</div><div class="line"><span class="keyword">assert</span> map2.get(<span class="string">'simple'</span>) == map.get(<span class="string">'simple'</span>)</div><div class="line"><span class="keyword">assert</span> map2.get(<span class="string">'complex'</span>) == map.get(<span class="string">'complex'</span>)</div><div class="line">map2.get(<span class="string">'complex'</span>).put(<span class="string">'c'</span>, <span class="number">3</span>)</div><div class="line"><span class="keyword">assert</span> map.get(<span class="string">'complex'</span>).get(<span class="string">'c'</span>) == <span class="number">3</span></div></pre></td></tr></table></figure></p>
<h4 id="Map-property-notation"><a href="#Map-property-notation" class="headerlink" title="Map property notation"></a>Map property notation</h4><p>Maps和beans也是非常相像的, 所以你可以对map使用<code>get/set</code>操作元素,当然这也有个前提,那就是map中的key必须是符合Groovy标识符的key.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> map = [<span class="string">name:</span> <span class="string">'Gromit'</span>, <span class="string">likes:</span> <span class="string">'cheese'</span>, <span class="string">id:</span> <span class="number">1234</span>]</div><div class="line"><span class="keyword">assert</span> map.name == <span class="string">'Gromit'</span>     <span class="comment">// can be used instead of map.get('Gromit')</span></div><div class="line"><span class="keyword">assert</span> map.id == <span class="number">1234</span></div><div class="line"></div><div class="line"><span class="keyword">def</span> emptyMap = [:]</div><div class="line"><span class="keyword">assert</span> emptyMap.size() == <span class="number">0</span></div><div class="line">emptyMap.foo = <span class="number">5</span></div><div class="line"><span class="keyword">assert</span> emptyMap.size() == <span class="number">1</span></div><div class="line"><span class="keyword">assert</span> emptyMap.foo == <span class="number">5</span></div></pre></td></tr></table></figure>
<p>注意:<code>map.foo</code>总是会在map中查找key<code>foo</code>. 这意味着,<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> map = [<span class="string">name:</span> <span class="string">'Gromit'</span>, <span class="string">likes:</span> <span class="string">'cheese'</span>, <span class="string">id:</span> <span class="number">1234</span>]</div><div class="line"><span class="keyword">assert</span> map.<span class="keyword">class</span> == <span class="literal">null</span></div><div class="line"><span class="keyword">assert</span> map.get(<span class="string">'class'</span>) == <span class="literal">null</span></div><div class="line"><span class="keyword">assert</span> map.getClass() == LinkedHashMap <span class="comment">// this is probably what you want</span></div><div class="line"></div><div class="line">map = [<span class="number">1</span>      : <span class="string">'a'</span>,</div><div class="line">       (<span class="literal">true</span>) : <span class="string">'p'</span>,</div><div class="line">       (<span class="literal">false</span>): <span class="string">'q'</span>,</div><div class="line">       (<span class="literal">null</span>) : <span class="string">'x'</span>,</div><div class="line">       <span class="string">'null'</span> : <span class="string">'z'</span>]</div><div class="line"><span class="keyword">assert</span> map.containsKey(<span class="number">1</span>) <span class="comment">// 1 is not an identifier so used as is</span></div><div class="line"><span class="keyword">assert</span> map.<span class="literal">true</span> == <span class="literal">null</span></div><div class="line"><span class="keyword">assert</span> map.<span class="literal">false</span> == <span class="literal">null</span></div><div class="line"><span class="keyword">assert</span> map.get(<span class="literal">true</span>) == <span class="string">'p'</span></div><div class="line"><span class="keyword">assert</span> map.get(<span class="literal">false</span>) == <span class="string">'q'</span></div><div class="line"><span class="keyword">assert</span> map.<span class="literal">null</span> == <span class="string">'z'</span></div><div class="line"><span class="keyword">assert</span> map.get(<span class="literal">null</span>) == <span class="string">'x'</span></div></pre></td></tr></table></figure></p>
<h4 id="Iterating-on-maps"><a href="#Iterating-on-maps" class="headerlink" title="Iterating on maps"></a>Iterating on maps</h4><p><code>Groovy development kit</code>还提供了<code>eachWithIndex</code>方法遍历map.值得注意的是,map会保留put元素的顺序,也就是说,当你遍历一个map的时候,无论进行多少次,你获得的元素的顺序是一定的.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> map = [</div><div class="line">        <span class="string">Bob  :</span> <span class="number">42</span>,</div><div class="line"><span class="symbol">        Alice:</span> <span class="number">54</span>,</div><div class="line">        <span class="string">Max  :</span> <span class="number">33</span></div><div class="line">]</div><div class="line"></div><div class="line"><span class="comment">// `entry` is a map entry</span></div><div class="line">map.each &#123; entry -&gt;</div><div class="line">    println <span class="string">"Name: $entry.key Age: $entry.value"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// `entry` is a map entry, `i` the index in the map</span></div><div class="line">map.eachWithIndex &#123; entry, i -&gt;</div><div class="line">    println <span class="string">"$i - Name: $entry.key Age: $entry.value"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Alternatively you can use key and value directly</span></div><div class="line">map.each &#123; key, value -&gt;</div><div class="line">    println <span class="string">"Name: $key Age: $value"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Key, value and i as the index in the map</span></div><div class="line">map.eachWithIndex &#123; key, value, i -&gt;</div><div class="line">    println <span class="string">"$i - Name: $key Age: $value"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Manipulating-maps"><a href="#Manipulating-maps" class="headerlink" title="Manipulating maps"></a>Manipulating maps</h4><h5 id="Adding-or-removing-elements-1"><a href="#Adding-or-removing-elements-1" class="headerlink" title="Adding or removing elements"></a>Adding or removing elements</h5><p>向map中添加元素你可以使用<code>put</code>方法, <code>下标</code>, <code>putAll</code>方法.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> defaults = [<span class="number">1</span>: <span class="string">'a'</span>, <span class="number">2</span>: <span class="string">'b'</span>, <span class="number">3</span>: <span class="string">'c'</span>, <span class="number">4</span>: <span class="string">'d'</span>]</div><div class="line"><span class="keyword">def</span> overrides = [<span class="number">2</span>: <span class="string">'z'</span>, <span class="number">5</span>: <span class="string">'x'</span>, <span class="number">13</span>: <span class="string">'x'</span>]</div><div class="line"></div><div class="line"><span class="keyword">def</span> result = <span class="keyword">new</span> LinkedHashMap(defaults)</div><div class="line">result.put(<span class="number">15</span>, <span class="string">'t'</span>)</div><div class="line">result[<span class="number">17</span>] = <span class="string">'u'</span></div><div class="line">result.putAll(overrides)</div><div class="line"><span class="keyword">assert</span> result == [<span class="number">1</span>: <span class="string">'a'</span>, <span class="number">2</span>: <span class="string">'z'</span>, <span class="number">3</span>: <span class="string">'c'</span>, <span class="number">4</span>: <span class="string">'d'</span>, <span class="number">5</span>: <span class="string">'x'</span>, <span class="number">13</span>: <span class="string">'x'</span>, <span class="number">15</span>: <span class="string">'t'</span>, <span class="number">17</span>: <span class="string">'u'</span>]</div></pre></td></tr></table></figure></p>
<p>如果想要删除map中全部的元素,可以使用<code>clear</code>方法.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> m = [<span class="number">1</span>:<span class="string">'a'</span>, <span class="number">2</span>:<span class="string">'b'</span>]</div><div class="line"><span class="keyword">assert</span> m.get(<span class="number">1</span>) == <span class="string">'a'</span></div><div class="line">m.clear()</div><div class="line"><span class="keyword">assert</span> m == [:]</div></pre></td></tr></table></figure></p>
<p>通过map字面量标记创建的map会使用<code>object</code>的<code>equals</code>方法和<code>hashcode</code>方法.</p>
<p>还要注意的是,不要使用GString作为map的key, 因为GString的hashcode方法和String的hashcode方法不一样.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> key = <span class="string">'some key'</span></div><div class="line"><span class="keyword">def</span> map = [:]</div><div class="line"><span class="keyword">def</span> gstringKey = <span class="string">"$&#123;key.toUpperCase()&#125;"</span></div><div class="line">map.put(gstringKey,<span class="string">'value'</span>)</div><div class="line"><span class="keyword">assert</span> map.get(<span class="string">'SOME KEY'</span>) == <span class="literal">null</span></div></pre></td></tr></table></figure></p>
<h5 id="Keys-values-and-entries"><a href="#Keys-values-and-entries" class="headerlink" title="Keys, values and entries"></a>Keys, values and entries</h5><p>我们可以在视图中inspect<code>keys, values, and entries</code><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> map = [<span class="number">1</span>:<span class="string">'a'</span>, <span class="number">2</span>:<span class="string">'b'</span>, <span class="number">3</span>:<span class="string">'c'</span>]</div><div class="line"></div><div class="line"><span class="keyword">def</span> entries = map.entrySet()</div><div class="line">entries.each &#123; entry -&gt;</div><div class="line">  <span class="keyword">assert</span> entry.key <span class="keyword">in</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</div><div class="line">  <span class="keyword">assert</span> entry.value <span class="keyword">in</span> [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>]</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> keys = map.keySet()</div><div class="line"><span class="keyword">assert</span> keys == [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="keyword">as</span> Set</div></pre></td></tr></table></figure></p>
<p>Mutating values returned by the view (be it a map entry, a key or a value) is highly discouraged because success of the operation directly depends on the type of the map being manipulated. In particular, Groovy relies on collections from the JDK that in general make no guarantee that a collection can safely be manipulated through keySet, entrySet, or values.</p>
<h5 id="Filtering-and-searching-1"><a href="#Filtering-and-searching-1" class="headerlink" title="Filtering and searching"></a>Filtering and searching</h5><p>The Groovy development kit contains filtering, searching and collecting methods similar to those found for lists:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> people = [</div><div class="line"><span class="symbol">    1:</span> [<span class="string">name:</span><span class="string">'Bob'</span>, <span class="string">age:</span> <span class="number">32</span>, <span class="string">gender:</span> <span class="string">'M'</span>],</div><div class="line"><span class="symbol">    2:</span> [<span class="string">name:</span><span class="string">'Johnny'</span>, <span class="string">age:</span> <span class="number">36</span>, <span class="string">gender:</span> <span class="string">'M'</span>],</div><div class="line"><span class="symbol">    3:</span> [<span class="string">name:</span><span class="string">'Claire'</span>, <span class="string">age:</span> <span class="number">21</span>, <span class="string">gender:</span> <span class="string">'F'</span>],</div><div class="line"><span class="symbol">    4:</span> [<span class="string">name:</span><span class="string">'Amy'</span>, <span class="string">age:</span> <span class="number">54</span>, <span class="string">gender:</span><span class="string">'F'</span>]</div><div class="line">]</div><div class="line"></div><div class="line"><span class="keyword">def</span> bob = people.find &#123; it.value.name == <span class="string">'Bob'</span> &#125; <span class="comment">// find a single entry</span></div><div class="line"><span class="keyword">def</span> females = people.findAll &#123; it.value.gender == <span class="string">'F'</span> &#125;</div><div class="line"></div><div class="line"><span class="comment">// both return entries, but you can use collect to retrieve the ages for example</span></div><div class="line"><span class="keyword">def</span> ageOfBob = bob.value.age</div><div class="line"><span class="keyword">def</span> agesOfFemales = females.collect &#123;</div><div class="line">    it.value.age</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">assert</span> ageOfBob == <span class="number">32</span></div><div class="line"><span class="keyword">assert</span> agesOfFemales == [<span class="number">21</span>,<span class="number">54</span>]</div><div class="line"></div><div class="line"><span class="comment">// but you could also use a key/pair value as the parameters of the closures</span></div><div class="line"><span class="keyword">def</span> agesOfMales = people.findAll &#123; id, person -&gt;</div><div class="line">    person.gender == <span class="string">'M'</span></div><div class="line">&#125;.collect &#123; id, person -&gt;</div><div class="line">    person.age</div><div class="line">&#125;</div><div class="line"><span class="keyword">assert</span> agesOfMales == [<span class="number">32</span>, <span class="number">36</span>]</div><div class="line"></div><div class="line"><span class="comment">// `every` returns true if all entries match the predicate</span></div><div class="line"><span class="keyword">assert</span> people.every &#123; id, person -&gt;</div><div class="line">    person.age &gt; <span class="number">18</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// `any` returns true if any entry matches the predicate</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> people.any &#123; id, person -&gt;</div><div class="line">    person.age == <span class="number">54</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="Grouping"><a href="#Grouping" class="headerlink" title="Grouping"></a>Grouping</h5><p>We can group a list into a map using some criteria:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="number">7</span>, <span class="string">'b'</span>, [<span class="number">2</span>, <span class="number">3</span>]].groupBy &#123;</div><div class="line">    it.<span class="keyword">class</span></div><div class="line">&#125; == [(String)   : [<span class="string">'a'</span>, <span class="string">'b'</span>],</div><div class="line">      (Integer)  : [<span class="number">7</span>],</div><div class="line">      (ArrayList): [[<span class="number">2</span>, <span class="number">3</span>]]</div><div class="line">]</div><div class="line"></div><div class="line"><span class="keyword">assert</span> [</div><div class="line">        [<span class="string">name:</span> <span class="string">'Clark'</span>, <span class="string">city:</span> <span class="string">'London'</span>], [<span class="string">name:</span> <span class="string">'Sharma'</span>, <span class="string">city:</span> <span class="string">'London'</span>],</div><div class="line">        [<span class="string">name:</span> <span class="string">'Maradona'</span>, <span class="string">city:</span> <span class="string">'LA'</span>], [<span class="string">name:</span> <span class="string">'Zhang'</span>, <span class="string">city:</span> <span class="string">'HK'</span>],</div><div class="line">        [<span class="string">name:</span> <span class="string">'Ali'</span>, <span class="string">city:</span> <span class="string">'HK'</span>], [<span class="string">name:</span> <span class="string">'Liu'</span>, <span class="string">city:</span> <span class="string">'HK'</span>],</div><div class="line">].groupBy &#123; it.city &#125; == [</div><div class="line"><span class="symbol">        London:</span> [[<span class="string">name:</span> <span class="string">'Clark'</span>, <span class="string">city:</span> <span class="string">'London'</span>],</div><div class="line">                 [<span class="string">name:</span> <span class="string">'Sharma'</span>, <span class="string">city:</span> <span class="string">'London'</span>]],</div><div class="line">        <span class="string">LA    :</span> [[<span class="string">name:</span> <span class="string">'Maradona'</span>, <span class="string">city:</span> <span class="string">'LA'</span>]],</div><div class="line">        <span class="string">HK    :</span> [[<span class="string">name:</span> <span class="string">'Zhang'</span>, <span class="string">city:</span> <span class="string">'HK'</span>],</div><div class="line">                 [<span class="string">name:</span> <span class="string">'Ali'</span>, <span class="string">city:</span> <span class="string">'HK'</span>],</div><div class="line">                 [<span class="string">name:</span> <span class="string">'Liu'</span>, <span class="string">city:</span> <span class="string">'HK'</span>]],</div><div class="line">]</div></pre></td></tr></table></figure>
<h3 id="Ranges"><a href="#Ranges" class="headerlink" title="Ranges"></a>Ranges</h3><p>Ranges allow you to create a list of sequential values. These can be used as List since Range extends java.util.List.</p>
<p>Ranges defined with the .. notation are inclusive (that is the list contains the from and to value).</p>
<p>Ranges defined with the ..&lt; notation are half-open, they include the first value but not the last value.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// an inclusive range</span></div><div class="line"><span class="keyword">def</span> range = <span class="number">5.</span><span class="number">.8</span></div><div class="line"><span class="keyword">assert</span> range.size() == <span class="number">4</span></div><div class="line"><span class="keyword">assert</span> range.get(<span class="number">2</span>) == <span class="number">7</span></div><div class="line"><span class="keyword">assert</span> range[<span class="number">2</span>] == <span class="number">7</span></div><div class="line"><span class="keyword">assert</span> range <span class="keyword">instanceof</span> java.util.List</div><div class="line"><span class="keyword">assert</span> range.contains(<span class="number">5</span>)</div><div class="line"><span class="keyword">assert</span> range.contains(<span class="number">8</span>)</div><div class="line"></div><div class="line"><span class="comment">// lets use a half-open range</span></div><div class="line">range = <span class="number">5.</span>.&lt;<span class="number">8</span></div><div class="line"><span class="keyword">assert</span> range.size() == <span class="number">3</span></div><div class="line"><span class="keyword">assert</span> range.get(<span class="number">2</span>) == <span class="number">7</span></div><div class="line"><span class="keyword">assert</span> range[<span class="number">2</span>] == <span class="number">7</span></div><div class="line"><span class="keyword">assert</span> range <span class="keyword">instanceof</span> java.util.List</div><div class="line"><span class="keyword">assert</span> range.contains(<span class="number">5</span>)</div><div class="line"><span class="keyword">assert</span> !range.contains(<span class="number">8</span>)</div><div class="line"></div><div class="line"><span class="comment">//get the end points of the range without using indexes</span></div><div class="line">range = <span class="number">1.</span><span class="number">.10</span></div><div class="line"><span class="keyword">assert</span> range.from == <span class="number">1</span></div><div class="line"><span class="keyword">assert</span> range.to == <span class="number">10</span></div></pre></td></tr></table></figure>
<p>Note that int ranges are implemented efficiently, creating a lightweight Java object containing a from and to value.</p>
<p>Ranges can be used for any Java object which implements java.lang.Comparable for comparison and also have methods next() and previous() to return the next / previous item in the range. For example, you can create a range of String elements:</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/04/11/编程语言/Groovy 集合/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/04/11/编程语言/Groovy 集合/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/04/09/编程语言/Groovy IO/" title="Groovy IO" itemprop="url">Groovy IO</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-04-09T07:00:00.000Z" itemprop="datePublished"> Published 2014-04-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <blockquote>
<p>本文是对Groovy部分官方文档进行了翻译</p>
</blockquote>
<h3 id="读文件"><a href="#读文件" class="headerlink" title="读文件"></a>读文件</h3><p>作为第一个例子,让我们看一下,如何输出一个文本文件里的所有行<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> File(baseDir, <span class="string">'haiku.txt'</span>).eachLine &#123; line -&gt;</div><div class="line">    println line</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>eachLine</code>方法是Groovy自动添加到File Class的,同时呢,Groovy还添加了很多变量,例如,你如果想要知道每一行的行号,你可以使用这个变量:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> File(baseDir, <span class="string">'haiku.txt'</span>).eachLine &#123; line, nb -&gt;</div><div class="line">    println <span class="string">"Line $nb: $line"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>无论由于什么原因, 当<code>eachLine</code>中抛出了异常,这个方法都会确保,资源已经被正确的关闭掉了. 这对所有Groovy自动添加的关于I/O资源的方法都有效.</p>
<p>例如, 某种情况你使用了<code>Reader</code>, 但是你还想让Groovy自己管理资源. 下面这个例子, 即使抛出了exception, reader仍然会被自动关闭.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> count = <span class="number">0</span>, MAXSIZE = <span class="number">3</span></div><div class="line"><span class="keyword">new</span> File(baseDir,<span class="string">"haiku.txt"</span>).withReader &#123; reader -&gt;</div><div class="line">    <span class="keyword">while</span> (reader.readLine()) &#123;</div><div class="line">        <span class="keyword">if</span> (++count &gt; MAXSIZE) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'Haiku should only have 3 verses'</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果你想要把文本文件中每一行都放进一个list中, 你可以这么做:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> list = <span class="keyword">new</span> File(baseDir, <span class="string">'haiku.txt'</span>).collect &#123;it&#125;</div></pre></td></tr></table></figure></p>
<p>或者你想利用操作符将文件中每一行都添加到一个数组中:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> array = <span class="keyword">new</span> File(baseDir, <span class="string">'haiku.txt'</span>) <span class="keyword">as</span> String[]</div></pre></td></tr></table></figure></p>
<p>下面这个示例,非常简单的实现了,将一个文件存进一个字节数组里:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">byte</span>[] contents = file.bytes</div></pre></td></tr></table></figure></p>
<p>如下例,我们轻松地获得了一个输入流.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> is = <span class="keyword">new</span> File(baseDir,<span class="string">'haiku.txt'</span>).newInputStream()</div><div class="line"><span class="comment">// do something ...</span></div><div class="line">is.close()</div></pre></td></tr></table></figure></p>
<p>上个例子中我们获得了一个输入流,但是最后我们不得不手动关闭它, Groovy提供另一个方法<code>withInputStream</code>, 这个方法可以帮我们自动的关闭输入流.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> File(baseDir,<span class="string">'haiku.txt'</span>).withInputStream &#123; stream -&gt;</div><div class="line">    <span class="comment">// do something ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="写文件"><a href="#写文件" class="headerlink" title="写文件"></a>写文件</h3><p>有时候,你需要的也许只是写文件,下面展示了,如何在Groovy中写文件<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> File(baseDir,<span class="string">'haiku.txt'</span>).withWriter(<span class="string">'utf-8'</span>) &#123; writer -&gt;</div><div class="line">    writer.writeLine <span class="string">'Into the ancient pond'</span></div><div class="line">    writer.writeLine <span class="string">'A frog jumps'</span></div><div class="line">    writer.writeLine <span class="string">'Water’s sound!'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但对于一个要求很简单的需求来说,我们可以使用<code>&lt;&lt;</code>向文件中写<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> File(baseDir,<span class="string">'haiku.txt'</span>) &lt;&lt; <span class="string">'''Into the ancient pond</span></div><div class="line">A frog jumps</div><div class="line">Water’s sound!'''</div></pre></td></tr></table></figure></p>
<p>当然不是每一次我们都是向文件中输出文本,下面的例子演示了,我们如何向一个文件中写入字节:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">file.bytes = [<span class="number">66</span>,<span class="number">22</span>,<span class="number">11</span>]</div></pre></td></tr></table></figure></p>
<p>当然,你也可以直接打开一个输出流,下面的例子演示了如何开启一个输出流.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> os = <span class="keyword">new</span> File(baseDir,<span class="string">'data.bin'</span>).newOutputStream()</div><div class="line"><span class="comment">// do something ...</span></div><div class="line">os.close()</div></pre></td></tr></table></figure></p>
<p>同<code>newInputStream</code>一样,<code>newOutputStream</code>同样需要手动关闭, ok,你大概想到了<code>withOutputStream</code>:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> File(baseDir,<span class="string">'data.bin'</span>).withOutputStream &#123; stream -&gt;</div><div class="line">    <span class="comment">// do something ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="遍历文件"><a href="#遍历文件" class="headerlink" title="遍历文件"></a>遍历文件</h3><p>在脚本中, 有个很常用的需求就是,遍历一个目录,然后找到一个文件,进行某些操作. Groovy提供了很多方法,来达到这个效果. 下面的例子演示了将一个目录下的所有文件都执行某个操作:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">dir.eachFile &#123; file -&gt;                      (<span class="number">1</span>)</div><div class="line">    println file.name</div><div class="line">&#125;</div><div class="line">dir.eachFileMatch(<span class="regexp">~/.*\.txt/</span>) &#123; file -&gt;     (<span class="number">2</span>)</div><div class="line">    println file.name</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>在目录下的每个文件上执行闭包操作.</li>
<li>根据正则表达式在目录下找到符合条件的文件,然后执行闭包操作.</li>
</ol>
<p>也许你想要遍历某个目录和目录里的所有子目录, 那么你可以使用<code>eachFileRecurse</code><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">dir.eachFileRecurse &#123; file -&gt;                      (<span class="number">1</span>)</div><div class="line">    println file.name</div><div class="line">&#125;</div><div class="line"></div><div class="line">dir.eachFileRecurse(FileType.FILES) &#123; file -&gt;      (<span class="number">2</span>)</div><div class="line">    println file.name</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>对目录里的所有子目录进行递归, 然后对找到的文件和目录进行闭包操作</li>
<li>对目录里进行递归查找,但是只查找文件.</li>
</ol>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">dir.traverse &#123; file -&gt;</div><div class="line">    <span class="keyword">if</span> (file.directory &amp;&amp; file.name==<span class="string">'bin'</span>) &#123;</div><div class="line">        FileVisitResult.TERMINATE                   (<span class="number">1</span>)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        println file.name</div><div class="line">        FileVisitResult.CONTINUE                    (<span class="number">2</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>如果找到的文件是目录,且它的名字是”dir”, 则停止遍历</li>
<li>打印出文件的名字,接着遍历</li>
</ol>
<h3 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h3><p>在java中会使用<code>java.io.DataOutputStream</code> 序列化数据也不罕见. Groovy对这个需求也做了非常简单的实现, 下面的例子演示了如何序列化和反序列化:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">boolean</span> b = <span class="literal">true</span></div><div class="line">String message = <span class="string">'Hello from Groovy'</span></div><div class="line"><span class="comment">// Serialize data into a file</span></div><div class="line">file.withDataOutputStream &#123; out -&gt;</div><div class="line">    out.writeBoolean(b)</div><div class="line">    out.writeUTF(message)</div><div class="line">&#125;</div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="comment">// Then read it back</span></div><div class="line">file.withDataInputStream &#123; input -&gt;</div><div class="line">    <span class="keyword">assert</span> input.readBoolean() == b</div><div class="line">    <span class="keyword">assert</span> input.readUTF() == message</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>同样,如果这个数据实例了序列化接口<code>Serializable</code>, 你可以使用 object output stream将整个数据序列化到文件:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Person p = <span class="keyword">new</span> Person(<span class="string">name:</span><span class="string">'Bob'</span>, <span class="string">age:</span><span class="number">76</span>)</div><div class="line"><span class="comment">// Serialize data into a file</span></div><div class="line">file.withObjectOutputStream &#123; out -&gt;</div><div class="line">    out.writeObject(p)</div><div class="line">&#125;</div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="comment">// Then read it back</span></div><div class="line">file.withObjectInputStream &#123; input -&gt;</div><div class="line">    <span class="keyword">def</span> p2 = input.readObject()</div><div class="line">    <span class="keyword">assert</span> p2.name == p.name</div><div class="line">    <span class="keyword">assert</span> p2.age == p.age</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h3><p>前面的章节介绍了在Groovy中操作files, readers or streams非常简单. 然而, 像系统管理员或者开发者,可能更多的是执行一个系统命令.</p>
<p>Groovy同样提供了非常简单的方式执行命令行命令. 只需要定义一个命令的字符串,然后执行这个字符串的<code>execute()</code>. 在类Unix系统中(如果在windows中也安装了类Unix命令行工具也算),你可以这样执行命令.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> process = <span class="string">"ls -l"</span>.execute()             (<span class="number">1</span>)</div><div class="line">println <span class="string">"Found text $&#123;process.text&#125;"</span>        (<span class="number">2</span>)</div></pre></td></tr></table></figure></p>
<ol>
<li>在外部过程(external process)执行ls命令</li>
<li>获得命令的输出,并输出</li>
</ol>
<p><code>execute()</code>方法返回一个<code>java.lang.Process</code>实例, 随后选择一种输出流<code>in/out/err</code>, 同时检查<code>exit</code>值,查看是否命令执行完毕.</p>
<p>下面的例子使用了和刚才那个例子一样的命令,但是现在我们每次都会对获得的结果进行行输出.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">            <span class="keyword">def</span> process = <span class="string">"ls -l"</span>.execute()             (<span class="number">1</span>)</div><div class="line">            process.<span class="keyword">in</span>.eachLine &#123; line -&gt;               (<span class="number">2</span>)</div><div class="line">                println line                            (<span class="number">3</span>)</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">assert</span> process <span class="keyword">instanceof</span> Process</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">void</span> testProcessConsumeOutput() &#123;</div><div class="line">        <span class="keyword">if</span> (unixlike) &#123;</div><div class="line">            doInTmpDir &#123; b -&gt;</div><div class="line">                File file = <span class="literal">null</span></div><div class="line">                <span class="keyword">def</span> tmpDir = b.tmp &#123;</div><div class="line">                    file = <span class="string">'foo.tmp'</span>(<span class="string">'foo'</span>)</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">assert</span> file.exists()</div><div class="line">                <span class="keyword">def</span> p = <span class="string">"rm -f foo.tmp"</span>.execute([], tmpDir)</div><div class="line">                p.consumeProcessOutput()</div><div class="line">                p.waitFor()</div><div class="line">                <span class="keyword">assert</span> !file.exists()</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">void</span> testProcessPipe() &#123;</div><div class="line">        <span class="keyword">if</span> (unixlike) &#123;</div><div class="line">            doInTmpDir &#123; b -&gt;</div><div class="line">                <span class="keyword">def</span> proc1, proc2, proc3, proc4</div><div class="line">                proc1 = <span class="string">'ls'</span>.execute()</div><div class="line">                proc2 = <span class="string">'tr -d o'</span>.execute()</div><div class="line">                proc3 = <span class="string">'tr -d e'</span>.execute()</div><div class="line">                proc4 = <span class="string">'tr -d i'</span>.execute()</div><div class="line">                proc1 | proc2 | proc3 | proc4</div><div class="line">                proc4.waitFor()</div><div class="line">                <span class="keyword">if</span> (proc4.exitValue()) &#123;</div><div class="line">                    println proc4.err.text</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    println proc4.text</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">def</span> sout = <span class="keyword">new</span> StringBuilder()</div><div class="line">                <span class="keyword">def</span> serr = <span class="keyword">new</span> StringBuilder()</div><div class="line">                proc2 = <span class="string">'tr -d o'</span>.execute()</div><div class="line">                proc3 = <span class="string">'tr -d e'</span>.execute()</div><div class="line">                proc4 = <span class="string">'tr -d i'</span>.execute()</div><div class="line">                proc4.consumeProcessOutput(sout, serr)</div><div class="line">                proc2 | proc3 | proc4</div><div class="line">                [proc2, proc3].each &#123; it.consumeProcessErrorStream(serr) &#125;</div><div class="line">                proc2.withWriter &#123; writer -&gt;</div><div class="line">                    writer &lt;&lt; <span class="string">'testfile.groovy'</span></div><div class="line">                &#125;</div><div class="line">                proc4.waitForOrKill(<span class="number">1000</span>)</div><div class="line">                println <span class="string">"Standard output: $sout"</span></div><div class="line">                println <span class="string">"Standard error: $serr"</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Serializable</span> &#123;</span></div><div class="line">        String name</div><div class="line">        <span class="keyword">int</span> age</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>1    executes the ls command in an external process<br>2    for each line of the input stream of the process<br>3    print the line</p>
<ol>
<li>在外部进程中执行ls命令<br>2.</li>
</ol>
<p>It is worth noting that in corresponds to an input stream to the standard output of the command. out will refer to a stream where you can send data to the process (its standard input).</p>
<p>Remember that many commands are shell built-ins and need special handling. So if you want a listing of files in a directory on a Windows machine and write:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> process = <span class="string">"dir"</span>.execute()</div><div class="line">println <span class="string">"$&#123;process.text&#125;"</span></div></pre></td></tr></table></figure>
<p>接着你会收到一个异常<code>IOException</code>,异常信息为<code>Cannot run program &quot;dir&quot;: CreateProcess error=2</code>,系统找不到指定的文件.</p>
<p>这是因为<code>dir</code>是内建于<code>windows shell(cmd.ext)</code>, 想要使用那个命令,你要像下面这个样操作:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> process = <span class="string">"cmd /c dir"</span>.execute()</div><div class="line">println <span class="string">"$&#123;process.text&#125;"</span></div></pre></td></tr></table></figure></p>
<p>还有,因为上述的功能是在内部使用的<code>java.lang.Process</code>, 这个类的一些不足的地方,我们也要充分考虑. 在javadoc中,是这样描述这个类的:</p>
<blockquote>
<p>Because some native platforms only provide limited buffer size for standard input and output streams, failure to promptly write the input stream or read the output stream of the subprocess may cause the subprocess to block, and even deadlock<br>Because of this, Groovy provides some additional helper methods which make stream handling for processes easier.</p>
</blockquote>
<p>现在演示一下,如何输出进程里所有的输出(包括error stream).<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> p = <span class="string">"rm -f foo.tmp"</span>.execute([], tmpDir)</div><div class="line">p.consumeProcessOutput()</div><div class="line">p.waitFor()</div></pre></td></tr></table></figure></p>
<p><code>consumeProcessOutput</code>仍然有很多对<code>StringBuffer</code>, <code>InputStream</code>, <code>OutputStream</code>等封装的变量, 如果想要获取一个完整的封装列表的,那可以参考 <a href="http://docs.groovy-lang.org/latest/html/groovy-jdk/java/lang/Process.html" target="_blank" rel="external">GDK API for java.lang.Process</a></p>
<p>另外, <code>pipeTo</code>命令 可以让一个进程的输出流连接到一个进程的输入流里. 如下例:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">proc1 = <span class="string">'ls'</span>.execute()</div><div class="line">proc2 = <span class="string">'tr -d o'</span>.execute()</div><div class="line">proc3 = <span class="string">'tr -d e'</span>.execute()</div><div class="line">proc4 = <span class="string">'tr -d i'</span>.execute()</div><div class="line">proc1 | proc2 | proc3 | proc4</div><div class="line">proc4.waitFor()</div><div class="line"><span class="keyword">if</span> (proc4.exitValue()) &#123;</div><div class="line">    println proc4.err.text</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    println proc4.text</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Consuming errors<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> sout = <span class="keyword">new</span> StringBuilder()</div><div class="line"><span class="keyword">def</span> serr = <span class="keyword">new</span> StringBuilder()</div><div class="line">proc2 = <span class="string">'tr -d o'</span>.execute()</div><div class="line">proc3 = <span class="string">'tr -d e'</span>.execute()</div><div class="line">proc4 = <span class="string">'tr -d i'</span>.execute()</div><div class="line">proc4.consumeProcessOutput(sout, serr)</div><div class="line">proc2 | proc3 | proc4</div><div class="line">[proc2, proc3].each &#123; it.consumeProcessErrorStream(serr) &#125;</div><div class="line">proc2.withWriter &#123; writer -&gt;</div><div class="line">    writer &lt;&lt; <span class="string">'testfile.groovy'</span></div><div class="line">&#125;</div><div class="line">proc4.waitForOrKill(<span class="number">1000</span>)</div><div class="line">println <span class="string">"Standard output: $sout"</span></div><div class="line">println <span class="string">"Standard error: $serr"</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/04/09/编程语言/Groovy IO/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/04/09/编程语言/Groovy IO/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/04/08/编程语言/Groovy/" title="Groovy 注释和标识符" itemprop="url">Groovy 注释和标识符</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-04-08T07:00:00.000Z" itemprop="datePublished"> Published 2014-04-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <blockquote>
<p>本文是对Groovy部分官方文档进行了翻译</p>
</blockquote>
<h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><h3 id="单行注释"><a href="#单行注释" class="headerlink" title="单行注释"></a>单行注释</h3><p>想要使用单行注释, 使用<code>//</code>就可以了.  本行中<code>//</code>后续的内容都会被认为是注释的一部分<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// a standalone single line comment</span></div><div class="line">println <span class="string">"hello"</span> <span class="comment">// a comment till the end of the line</span></div></pre></td></tr></table></figure></p>
<h3 id="多行注释"><a href="#多行注释" class="headerlink" title="多行注释"></a>多行注释</h3><p>多行注释从<code>/*</code>开始, 直到<code>*/</code>结束(跨行也包含在内)<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* a standalone multiline comment</span></div><div class="line">spanning two lines */</div><div class="line">println <span class="string">"hello"</span> <span class="comment">/* a multiline comment starting</span></div><div class="line">at the end of a statement */</div><div class="line">println <span class="number">1</span> <span class="comment">/* one */</span> + <span class="number">2</span> <span class="comment">/* two */</span></div></pre></td></tr></table></figure></p>
<h4 id="GroovyDoc-注释"><a href="#GroovyDoc-注释" class="headerlink" title="GroovyDoc 注释"></a>GroovyDoc 注释</h4><p><code>GroovyDoc</code> 注释也是多行的, 但是它是以<code>/**</code>开始, <code>*/</code>结束定义的.<br>这种注释一般用于以下情况：</p>
<ul>
<li>类型定义(包含 classes, interfaces, enums, annotations)</li>
<li>字段和属性定义</li>
<li>方法定义</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * A Class description</div><div class="line">  */</div><div class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></div><div class="line">     <span class="comment">/** the name of the person */</span></div><div class="line">     String name</div><div class="line"></div><div class="line">     <span class="comment">/**</span></div><div class="line">      * Creates a greeting method for a certain person.</div><div class="line">      *</div><div class="line">      * <span class="doctag">@param</span> otherPerson the person to greet</div><div class="line">      * <span class="doctag">@return</span> ag reeting message</div><div class="line">      */</div><div class="line">     String greet(String otherPerson) &#123;</div><div class="line">        <span class="string">"Hello $&#123;otherPerson&#125;"</span></div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h3 id="Shebang-line"><a href="#Shebang-line" class="headerlink" title="Shebang line"></a>Shebang line</h3><p>除了上面提到的单行注释外, 还有一种特殊的单行注释.这种注释在UNIX系统下通常称为shebang线, 这种注释允许脚本直接在命令行里执行( 但是前提是你已经在系统是安装了<code>groovy</code>,并且在<code>PATH</code>里进行了配置)</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/env groovy</span></div><div class="line">println <span class="string">"Hello from the shebang line"</span></div></pre></td></tr></table></figure>
<p><code>#</code>字符必须是这个文件里的第一个字符,否则编译器将会抛出一个编译错误.</p>
<h2 id="标识符"><a href="#标识符" class="headerlink" title="标识符"></a>标识符</h2><h3 id="普通标识符"><a href="#普通标识符" class="headerlink" title="普通标识符"></a>普通标识符</h3><p>标识符以一个<code>字母</code>或者<code>$</code>或者<code>_</code>开始, 不能以数字打头.<br>如果以字母打头,他们在下列范围内</p>
<ul>
<li>‘a’ to ‘z’ (lowercase ascii letter)</li>
<li>‘A’ to ‘Z’ (uppercase ascii letter)</li>
<li>‘\u00C0’ to ‘\u00D6’</li>
<li>‘\u00D8’ to ‘\u00F6’</li>
<li>‘\u00F8’ to ‘\u00FF’</li>
<li>‘\u0100’ to ‘\uFFFE’</li>
</ul>
<p>剩下的字符就可以包含字母或者数字了.  下面列举了一些合法的标识符：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> name</div><div class="line"><span class="keyword">def</span> item3</div><div class="line"><span class="keyword">def</span> with_underscore</div><div class="line"><span class="keyword">def</span> $dollarStart</div></pre></td></tr></table></figure></p>
<p>下面是一些非法的标识符<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">def 3tier</div><div class="line">def a+b</div><div class="line">def a#b</div></pre></td></tr></table></figure></p>
<p><code>.</code>后面的关键字也是合法的标识符<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">foo.<span class="keyword">as</span></div><div class="line">foo.<span class="keyword">assert</span></div><div class="line">foo.<span class="keyword">break</span></div><div class="line">foo.<span class="keyword">case</span></div><div class="line">foo.<span class="keyword">catch</span></div></pre></td></tr></table></figure></p>
<h3 id="带引号的标识符"><a href="#带引号的标识符" class="headerlink" title="带引号的标识符"></a>带引号的标识符</h3><p>带引号的标识符出现在<code>.\</code>. 例如<code>person.name</code>表达式中的<code>name</code>部分能通过这俩种方式引起来<code>person.&quot;name&quot;</code>或者<code>person.\&#39;name&#39;</code>. 当特定标识符中包含非法字符(java语言禁止的字符),但是通过引号的方式可以达到在Groovy的合法. 例如,一个破折号,一个空格,一个感叹号,<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> map = [:]</div><div class="line"></div><div class="line">map.<span class="string">"an identifier with a space and double quotes"</span> = <span class="string">"ALLOWED"</span></div><div class="line">map.<span class="string">'with-dash-signs-and-single-quotes'</span> = <span class="string">"ALLOWED"</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> map.<span class="string">"an identifier with a space and double quotes"</span> == <span class="string">"ALLOWED"</span></div><div class="line"><span class="keyword">assert</span> map.<span class="string">'with-dash-signs-and-single-quotes'</span> == <span class="string">"ALLOWED"</span></div></pre></td></tr></table></figure></p>
<p>正像一会我们在strings模块看到的一样, Groovy提供了不同的string字面量. 以下所列举的都是合法的<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">map.<span class="string">'single quote'</span></div><div class="line">map.<span class="string">"double quote"</span></div><div class="line">map.<span class="string">'''triple single quote'''</span></div><div class="line">map.<span class="string">"""triple double quote"""</span></div><div class="line">map.<span class="regexp">/slashy string/</span></div><div class="line">map.<span class="string">$/dollar slashy string/$</span></div></pre></td></tr></table></figure></p>
<p>strings 和 Groovy’s GStrings 在纯字符上面是有一点不同的,as in that the latter case, the interpolated values are inserted in the final string for evaluating the whole identifier:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> firstname = <span class="string">"Homer"</span></div><div class="line">map.<span class="string">"Simson-$&#123;firstname&#125;"</span> = <span class="string">"Homer Simson"</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> map.<span class="string">'Simson-Homer'</span> == <span class="string">"Homer Simson"</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/04/08/编程语言/Groovy/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/04/08/编程语言/Groovy/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2013/11/20/zookeeper/ZooKeeper Java客户端/" title="ZooKeeper Java客户端" itemprop="url">ZooKeeper Java客户端</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2013-11-20T08:00:00.000Z" itemprop="datePublished"> Published 2013-11-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我们使用ZooKeeper官方java客户端进行测试,另外可以使用curator.</p>
<p>我们使用Maven添加相关依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="创建节点"><a href="#创建节点" class="headerlink" title="创建节点"></a>创建节点</h2><p>然后我们向zk服务器上添加俩个节点<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.zookeeper.CreateMode;</div><div class="line"><span class="keyword">import</span> org.apache.zookeeper.KeeperException;</div><div class="line"><span class="keyword">import</span> org.apache.zookeeper.ZooDefs;</div><div class="line"><span class="keyword">import</span> org.apache.zookeeper.ZooKeeper;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateNode</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT_PATH = <span class="string">"/Servers"</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ZooKeeper zooKeeper;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, KeeperException, InterruptedException </span>&#123;</div><div class="line">		<span class="comment">// 连接ZooKeeper服务器</span></div><div class="line">		zooKeeper = <span class="keyword">new</span> ZooKeeper(<span class="string">"localhost:2181"</span>, <span class="number">15000</span>, event -&gt; &#123;</div><div class="line">			<span class="comment">// TODO</span></div><div class="line">		&#125;);</div><div class="line"></div><div class="line">		<span class="comment">// 创建根节点, 子节点依赖于父节点, 我们不能直接创建出/Servers/server1</span></div><div class="line">		zooKeeper.create(ROOT_PATH, <span class="comment">// 节点路径</span></div><div class="line">				<span class="string">"create"</span>.getBytes(), <span class="comment">// 节点数据</span></div><div class="line">				ZooDefs.Ids.OPEN_ACL_UNSAFE, <span class="comment">// 权限控制(不使用节点权限控制)</span></div><div class="line">				CreateMode.PERSISTENT, <span class="comment">// 节点类型(临时节点不允许创建子节点,所以我们选择了持久节点)</span></div><div class="line">				(rc, path, ctx, name) -&gt; &#123; <span class="comment">// 节点创建成功之后的回调函数</span></div><div class="line">					<span class="comment">// TODO</span></div><div class="line">				&#125;, ROOT_PATH);</div><div class="line"></div><div class="line">		<span class="comment">// 创建子节点</span></div><div class="line">		zooKeeper.create(ROOT_PATH + <span class="string">"/server1"</span>, <span class="comment">// 节点路径</span></div><div class="line">				<span class="string">"create"</span>.getBytes(), <span class="comment">// 节点数据</span></div><div class="line">				ZooDefs.Ids.OPEN_ACL_UNSAFE, <span class="comment">// 权限控制</span></div><div class="line">				CreateMode.PERSISTENT, <span class="comment">// 节点类型</span></div><div class="line">				(rc, path, ctx, name) -&gt; &#123; <span class="comment">// 节点创建成功之后的回调函数</span></div><div class="line">					<span class="comment">// TODO</span></div><div class="line">				&#125;, ROOT_PATH);</div><div class="line"></div><div class="line">		<span class="comment">// 获取节点下的所有子节点</span></div><div class="line">		List&lt;String&gt; children = zooKeeper.getChildren(ROOT_PATH, event -&gt; &#123;</div><div class="line">			<span class="comment">// TODO</span></div><div class="line">		&#125;);</div><div class="line"></div><div class="line">		children.forEach(child -&gt; System.out.println(child));</div><div class="line"></div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.zookeeper.*;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.Random;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateNode</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT_PATH = <span class="string">"/Servers"</span> + <span class="keyword">new</span> Random().nextInt(<span class="number">100000</span>);</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ZooKeeper zooKeeper;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, KeeperException, InterruptedException </span>&#123;</div><div class="line">		<span class="comment">// 连接ZooKeeper服务器</span></div><div class="line">		zooKeeper = <span class="keyword">new</span> ZooKeeper(<span class="string">"localhost:2181"</span>, <span class="number">15000</span>, event -&gt; &#123;</div><div class="line">			System.out.println(<span class="string">"事件变化 : "</span> + event.getPath() + <span class="string">" -&gt; "</span> + event.getType());</div><div class="line">		&#125;);</div><div class="line"></div><div class="line">		<span class="comment">// 创建根节点, 子节点依赖于父节点, 我们不能直接创建出/Servers/server1</span></div><div class="line">		zooKeeper.create(ROOT_PATH, <span class="comment">// 节点路径</span></div><div class="line">				<span class="string">"create"</span>.getBytes(), <span class="comment">// 节点数据</span></div><div class="line">				ZooDefs.Ids.OPEN_ACL_UNSAFE, <span class="comment">// 权限控制(不使用节点权限控制)</span></div><div class="line">				CreateMode.PERSISTENT, <span class="comment">// 节点类型(临时节点不允许创建子节点,所以我们选择了持久节点)</span></div><div class="line">				(rc, path, ctx, name) -&gt; &#123; <span class="comment">// 节点创建成功之后的回调函数</span></div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						System.out.println(<span class="string">"Create Node OK!"</span>);</div><div class="line">						zooKeeper.getChildren(ROOT_PATH, event -&gt; &#123;</div><div class="line">							System.out.println(<span class="string">"Watch : "</span> + event.getPath() + <span class="string">" -&gt; "</span> + event.getType());</div><div class="line">						&#125;);</div><div class="line">					&#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</div><div class="line">						e.printStackTrace();</div><div class="line">					&#125;</div><div class="line">				&#125;, ROOT_PATH);</div><div class="line"></div><div class="line">		<span class="comment">// 在创建上个node的时候, 由于注册watch是异步执行的, 因此需要在这里等待一下</span></div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line"></div><div class="line">		zooKeeper.create(ROOT_PATH + <span class="string">"/server1"</span>, <span class="comment">// 节点路径</span></div><div class="line">				<span class="string">"create"</span>.getBytes(), <span class="comment">// 节点数据</span></div><div class="line">				ZooDefs.Ids.OPEN_ACL_UNSAFE, <span class="comment">// 权限控制(不使用节点权限控制)</span></div><div class="line">				CreateMode.PERSISTENT, <span class="comment">// 节点类型(临时节点不允许创建子节点,所以我们选择了持久节点)</span></div><div class="line">				(rc, path, ctx, name) -&gt; &#123; <span class="comment">// 节点创建成功之后的回调函数</span></div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						System.out.println(<span class="string">"Create Node OK!"</span>);</div><div class="line">						zooKeeper.getChildren(ROOT_PATH, event -&gt; &#123;</div><div class="line">							System.out.println(<span class="string">"Watch : "</span> + event.getPath() + <span class="string">" -&gt; "</span> + event.getType());</div><div class="line">						&#125;);</div><div class="line">					&#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</div><div class="line">						e.printStackTrace();</div><div class="line">					&#125;</div><div class="line">				&#125;, ROOT_PATH);</div><div class="line"></div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果为<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">事件变化 : null -&gt; None</div><div class="line">Create Node OK!</div><div class="line">Watch : /Servers53734 -&gt; NodeChildrenChanged</div><div class="line">Create Node OK!</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/ZooKeeper/">ZooKeeper</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2013/11/20/zookeeper/ZooKeeper Java客户端/#comments" class="ds-thread-count comments-count-link" data-thread-key="2013/11/20/zookeeper/ZooKeeper Java客户端/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2013/11/20/zookeeper/ZooKeeper 命令行客户端/" title="ZooKeeper 命令行客户端" itemprop="url">ZooKeeper 命令行客户端</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2013-11-20T08:00:00.000Z" itemprop="datePublished"> Published 2013-11-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我们执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bin/zkCli.cmd -server 127.0.0.1:2181</div></pre></td></tr></table></figure></p>
<p>就连接上了刚才启动的服务器,进入shell<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">E:\zookeeper-3.4.6\bin&gt;.\zkCli.cmd -server 127.0.0.1:2181</div><div class="line">Connecting to 127.0.0.1:2181</div><div class="line">2015-11-09 16:04:51,367 [myid:] - INFO  [main:Environment@100] - Client environment:zookeeper.version=3.4.6-1569965, built on 02/20/2014 09:09 GMT</div><div class="line">...</div><div class="line">2015-11-09 16:04:51,374 [myid:] - INFO  [main:Environment@100] - Client environment:user.home=C:\Users\Administrator</div><div class="line">2015-11-09 16:04:51,374 [myid:] - INFO  [main:Environment@100] - Client environment:user.dir=E:\zookeeper-3.4.6\bin</div><div class="line">2015-11-09 16:04:51,375 [myid:] - INFO  [main:ZooKeeper@438] - Initiating client connection, connectString=127.0.0.1:2181 sessionTimeout=30000 watcher=org.apache.zookeeper.ZooKeeperMain$MyWatcher@277050dc</div><div class="line">Welcome to ZooKeeper!</div><div class="line">2015-11-09 16:04:51,514 [myid:] - INFO  [main-SendThread(127.0.0.1:2181):ClientCnxn$SendThread@975] - Opening socket connection to server 127.0.0.1/127.0.0.1:2181. Will not attempt to authenticate using SASL (unknown error)</div><div class="line">2015-11-09 16:04:51,516 [myid:] - INFO  [main-SendThread(127.0.0.1:2181):ClientCnxn$SendThread@852] - Socket connection established to 127.0.0.1/127.0.0.1:2181, initiating session</div><div class="line">2015-11-09 16:04:51,684 [myid:] - INFO  [main-SendThread(127.0.0.1:2181):ClientCnxn$SendThread@1235] - Session establishment complete on server 127.0.0.1/127.0.0.1:2181, sessionid = 0x150eb438ceb0000, negotiated timeout = 30000</div><div class="line"></div><div class="line">WATCHER::</div><div class="line"></div><div class="line">WatchedEvent state:SyncConnected type:None path:null</div><div class="line">JLine support is enabled</div><div class="line">[zk: 127.0.0.1:2181(CONNECTED) 0]</div></pre></td></tr></table></figure></p>
<p>进入到shell之后,我们可以敲人<code>help</code>命令，查看我们都能使用哪些命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[zk: 127.0.0.1:2181(CONNECTED) 1] help</div><div class="line">ZooKeeper -server host:port cmd args</div><div class="line">	stat path [watch]</div><div class="line">	set path data [version]</div><div class="line">	ls path [watch]</div><div class="line">	delquota [-n|-b] path</div><div class="line">	ls2 path [watch]</div><div class="line">	setAcl path acl</div><div class="line">	setquota -n|-b val path</div><div class="line">	history</div><div class="line">	redo cmdno</div><div class="line">	printwatches on|off</div><div class="line">	delete path [version]</div><div class="line">	sync path</div><div class="line">	listquota path</div><div class="line">	rmr path</div><div class="line">	get path [watch]</div><div class="line">	create [-s] [-e] path data acl</div><div class="line">	addauth scheme auth</div><div class="line">	quit</div><div class="line">	getAcl path</div><div class="line">	close</div><div class="line">	connect host:port</div><div class="line">[zk: 127.0.0.1:2181(CONNECTED) 2]</div></pre></td></tr></table></figure></p>
<p>看到了,我们能使用这么多命令，下来我们简单的接受几个命令.</p>
<p>我们使用<code>create</code>命令创建一个<code>znode</code>(这个node里和字符串”my_data”关联起来了).<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[zk: 127.0.0.1:2181(CONNECTED) 1] create /zk_test my_data</div><div class="line">Created /zk_test</div><div class="line">[zk: 127.0.0.1:2181(CONNECTED) 3] ls /</div><div class="line">[zookeeper, zk_test]</div><div class="line">[zk: 127.0.0.1:2181(CONNECTED) 4]</div></pre></td></tr></table></figure></p>
<p>但是实际上，这个node还没有被创建出来.</p>
<p>下来我们使用<code>get</code>命令验证一下<code>zk_test</code>是不是真的和”my_data”关联起来了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[zk: 127.0.0.1:2181(CONNECTED) 4] get /zk_test</div><div class="line">my_data</div><div class="line">cZxid = 0x3</div><div class="line">ctime = Mon Nov 09 16:29:12 CST 2015</div><div class="line">mZxid = 0x3</div><div class="line">mtime = Mon Nov 09 16:29:12 CST 2015</div><div class="line">pZxid = 0x3</div><div class="line">cversion = 0</div><div class="line">dataVersion = 0</div><div class="line">aclVersion = 0</div><div class="line">ephemeralOwner = 0x0</div><div class="line">dataLength = 7</div><div class="line">numChildren = 0</div><div class="line">[zk: 127.0.0.1:2181(CONNECTED) 5]</div></pre></td></tr></table></figure></p>
<p>我们还可以使用<code>set</code>命令将刚才那个node重新关联<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[zk: 127.0.0.1:2181(CONNECTED) 5] set /zk_test new_data</div><div class="line">cZxid = 0x3</div><div class="line">ctime = Mon Nov 09 16:29:12 CST 2015</div><div class="line">mZxid = 0x4</div><div class="line">mtime = Mon Nov 09 16:35:11 CST 2015</div><div class="line">pZxid = 0x3</div><div class="line">cversion = 0</div><div class="line">dataVersion = 1</div><div class="line">aclVersion = 0</div><div class="line">ephemeralOwner = 0x0</div><div class="line">dataLength = 8</div><div class="line">numChildren = 0</div><div class="line">[zk: 127.0.0.1:2181(CONNECTED) 7] get /zk_test</div><div class="line">new_data</div><div class="line">cZxid = 0x3</div><div class="line">ctime = Mon Nov 09 16:29:12 CST 2015</div><div class="line">mZxid = 0x4</div><div class="line">mtime = Mon Nov 09 16:35:11 CST 2015</div><div class="line">pZxid = 0x3</div><div class="line">cversion = 0</div><div class="line">dataVersion = 1</div><div class="line">aclVersion = 0</div><div class="line">ephemeralOwner = 0x0</div><div class="line">dataLength = 8</div><div class="line">numChildren = 0</div><div class="line">[zk: 127.0.0.1:2181(CONNECTED) 8]</div></pre></td></tr></table></figure></p>
<p>最后，我们将这个node删掉<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[zk: 127.0.0.1:2181(CONNECTED) 9] delete /zk_test</div><div class="line">[zk: 127.0.0.1:2181(CONNECTED) 10] ls /</div><div class="line">[zookeeper]</div><div class="line">[zk: 127.0.0.1:2181(CONNECTED) 11]</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/ZooKeeper/">ZooKeeper</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2013/11/20/zookeeper/ZooKeeper 命令行客户端/#comments" class="ds-thread-count comments-count-link" data-thread-key="2013/11/20/zookeeper/ZooKeeper 命令行客户端/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2013/09/13/JavaLibrary/Guava CachesExplained/" title="Guava Cache" itemprop="url">Guava Cache</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2013-09-13T07:00:00.000Z" itemprop="datePublished"> Published 2013-09-13</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">LoadingCache&lt;Key, Graph&gt; graphs = CacheBuilder.newBuilder()  </div><div class="line">       .maximumSize(<span class="number">1000</span>)  </div><div class="line">       .expireAfterWrite(<span class="number">10</span>, TimeUnit.MINUTES)  </div><div class="line">       .removalListener(MY_LISTENER)  </div><div class="line">       .build(  </div><div class="line">           <span class="keyword">new</span> CacheLoader&lt;Key, Graph&gt;() &#123;  </div><div class="line">             <span class="function"><span class="keyword">public</span> Graph <span class="title">load</span><span class="params">(Key key)</span> <span class="keyword">throws</span> AnyException </span>&#123;  </div><div class="line">               <span class="keyword">return</span> createExpensiveGraph(key);  </div><div class="line">             &#125;  </div><div class="line">           &#125;);</div></pre></td></tr></table></figure>
<h2 id="适用范围"><a href="#适用范围" class="headerlink" title="适用范围"></a>适用范围</h2><p>缓存的使用范围是十分广泛的。每当计算或者通过一些方式生成一个值的时候，会造成资源严重浪费的时候我们可以考虑用缓存技术来存储该值。</p>
<p>缓存和<code>CurrentMap</code>十分相似(键值对形式),但是他们之间还是仍有诸多不同.他们之间最大的不同之处是<code>ConcurrentMap</code>里的元素在被明确地删除之前会一直被存储在<code>Map</code>里，但是对于cache来说，为了维护cache的内存占用，cache被设计成会自动删除其中的数据。在一些应用场合中，使用<code>LoadingCache也</code>是非常有用的，即使它不被允许自动删除其entries(由于它的自动内存加载机制，他不允许这么做)。</p>
<p>一般来说，Guava的缓存技术一般适用于以下场合</p>
<ol>
<li>想要消耗掉一些内存来换取速度的提升</li>
<li>key(map中也有key)会在一段时间内被频繁的访问。</li>
<li>在cache存储的数据容量不会大于其RAM中存储的。</li>
</ol>
<p>你可以按照上文中的例子(CacheBuilder的builder pattern)来创建一个Cache，但是定制属于自己应用程序的Cache才是最激动人心的事。</p>
<blockquote>
<p>注：如果你的应用程序中不会用到上文提到的Cache的特性，那么你可以考虑ConcurrentHashMap，它在内存方面也许更有优势。但是ConcurrentHashMap是非常困难，甚至不可能的来模拟出Cache那样的强大功能。<br>至于如何选择，就要看你的应用程序需求了,仔细看看下面提到的特性—-例如元素的存活期，元素的大小等等，这些特点都是在ConcurrentMap里所不存在的。</p>
</blockquote>
<h2 id="总体"><a href="#总体" class="headerlink" title="总体"></a>总体</h2><p>你应该先问自己第一个问题：你是否有特定的明确的通过某些keys的作参数生成Value的方法？如果你的回答是肯定的话，那么<code>CacheLoader</code>是适合你的。如果你不需要通过某些key来生成value或者你想要重载默认的方法或者想要使用<code>get-if-absent-compute</code>方式,你可以参考<a href="">From A Callable</a>。一般我们可以通过<code>Cache.put</code>直接将元素插入cache中，但是我们应该首先考虑它的自动缓存加载，因为它会考虑到所有缓存内容的一致性。</p>
<blockquote>
<p>From A CacheLoader : LoadingCache通过一个附着的CacheLoader来创建。创建一个CacheLoader也是非常简单的，只要实现一个V load(K key) throws exception的方法就可以了.下面的例子展示出如何创建一个LoadingCache<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">LoadingCache&lt;Key, Graph&gt; graphs = CacheBuilder.newBuilder()  </div><div class="line">       .maximumSize(<span class="number">1000</span>)  </div><div class="line">       .build(  </div><div class="line">           <span class="keyword">new</span> CacheLoader&lt;Key, Graph&gt;() &#123;  </div><div class="line">             <span class="function"><span class="keyword">public</span> Graph <span class="title">load</span><span class="params">(Key key)</span> <span class="keyword">throws</span> AnyException </span>&#123;  </div><div class="line">               <span class="keyword">return</span> createExpensiveGraph(key);  </div><div class="line">             &#125;  </div><div class="line">           &#125;);  </div><div class="line"></div><div class="line">...  </div><div class="line"><span class="keyword">try</span> &#123;  </div><div class="line">  <span class="keyword">return</span> graphs.get(key);  </div><div class="line">&#125; <span class="keyword">catch</span> (ExecutionException e) &#123;  </div><div class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> OtherException(e.getCause());  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>上面的例子也展示除了我们可以通过<code>get(K)</code>的方式对<code>LoadingCache</code>进行查询获取值。我们如果可以从cache中查找到该key，那么将会直接返回该key对应的value，否则会通过cache的<code>CacheLoader</code>自动加载一个新的键值对，然后返回该值。因为<code>CacheLoader</code>可能会抛出异常，所以get(K)可能会抛出<code>Execution</code>。如果在<code>CacheLoader</code>中定义了一个非异常检查的<code>load</code>方法，那么在查询取值时可以使用<code>getUnchecked(Key)</code>;但是如果你声明了throws，则一定不要调用<code>getUnchecked(Key)</code>. 下面是一个例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">LoadingCache&lt;Key, Graph&gt; graphs = CacheBuilder.newBuilder()  </div><div class="line">       .expireAfterAccess(<span class="number">10</span>, TimeUnit.MINUTES)  </div><div class="line">       .build(  </div><div class="line">           <span class="keyword">new</span> CacheLoader&lt;Key, Graph&gt;() &#123;  </div><div class="line">             <span class="function"><span class="keyword">public</span> Graph <span class="title">load</span><span class="params">(Key key)</span> </span>&#123; <span class="comment">// no checked exception  </span></div><div class="line">               <span class="keyword">return</span> createExpensiveGraph(key);  </div><div class="line">             &#125;  </div><div class="line">           &#125;);  </div><div class="line"></div><div class="line">...  </div><div class="line"><span class="keyword">return</span> graphs.getUnchecked(key);</div></pre></td></tr></table></figure></p>
<p>当我们想要获取N多值的时候，在查询时可以使用方法<code>getAll(Iterable&lt;? extends K&gt;)</code>.在getAll中，对每一个不存在于cache里的key都会执行一个单独的对<code>CacheLoader.load</code>的方法调用来加载该值。看，guava提供了如此优秀的方法当进行一次getAll比多次get更有优势时，我们就应该重载<code>CacheLoader.loadAll</code>来实现这个功能。</p>
<p>可以通过实现<code>CacheLoader.loadAll</code>这个方法来加载那些不被包含的显示请求的值。</p>
<p>如果想要设定cache有一定的大小可以通过<code>CacheBuilder.maximumSize(long)</code>来设定。如此设定会使得cache在达到限定值时删除那些没有被使用过或者不经常使用的entries.</p>
<blockquote>
<p>From a Callable: 所有的Guava caches，不管是否是loading模式的，都支持get(K, Callable<v>)方法。这个方法会从cache中返回与该key相关联的value，或者从Callable中计算该值并把它放进cache中。这个方法使用了一个非常简单的模式”if cached, return; otherwise create, cache and return”</v></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Cache&lt;Key, Value&gt; cache = CacheBuilder.newBuilder()  </div><div class="line">    .maximumSize(<span class="number">1000</span>)  </div><div class="line">    .build(); <span class="comment">// look Ma, no CacheLoader  </span></div><div class="line">...  </div><div class="line"><span class="keyword">try</span> &#123;  </div><div class="line">  <span class="comment">// If the key wasn't in the "easy to compute" group, we need to  </span></div><div class="line">  <span class="comment">// do things the hard way.  </span></div><div class="line">  cache.get(key, <span class="keyword">new</span> Callable&lt;Value&gt;() &#123;  </div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> Value <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> AnyException </span>&#123;  </div><div class="line">      <span class="keyword">return</span> doThingsTheHardWay(key);  </div><div class="line">    &#125;  </div><div class="line">  &#125;);  </div><div class="line">&#125; <span class="keyword">catch</span> (ExecutionException e) &#123;  </div><div class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> OtherException(e.getCause());  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Inserted Directly : Values也可以通过cache.put(key,value)直接将值插入cache中。该方法将重写先前与key匹配的entry。</p>
<h2 id="Eviction"><a href="#Eviction" class="headerlink" title="Eviction"></a>Eviction</h2><p>一个不能避免的问题：由于内存原因，我们不能将所有的东西都加载进cache中。那么你必须下决定：一个cache entry应该何时被抛弃。Guava提供了三种entry释放策略：size-basd evicton，time-based eviction 和reference-based eviction</p>
<h3 id="Size-based-Eviction"><a href="#Size-based-Eviction" class="headerlink" title="Size-based Eviction"></a>Size-based Eviction</h3><p>如果你的cache不允许扩容,即不允许超过设定的最大值，那么使用CacheBuilder.maxmuSize(long)即可。在这种条件下，cache会自己释放掉那些最近没有或者不经常使用的entries内存。注意：cache并不是在超过限定时才会删除掉那些entries，而是在即将达到这个限定值时，那么你就要小心考虑这种情况了，因为很明显即使没有达到这个限定值，cache仍然会进行删除操作。</p>
<p>还有一种情况：cache里不同的entries可能会有不同的weight。例如：如果你的cache values有着截然不同的内存占用—-你可以使用CacheBuilder.weigher(Weigher)设定weigh和使用CacheBuilder.maximumWeight(long)设定一个最大值。<br>下面代码展示了对weight的使用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">LoadingCache&lt;Key, Graph&gt; graphs = CacheBuilder.newBuilder()  </div><div class="line">       .maximumWeight(<span class="number">100000</span>)  </div><div class="line">       .weigher(<span class="keyword">new</span> Weigher&lt;Key, Graph&gt;() &#123;  </div><div class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">weigh</span><span class="params">(Key k, Graph g)</span> </span>&#123;  </div><div class="line">            <span class="keyword">return</span> g.vertices().size();  </div><div class="line">          &#125;  </div><div class="line">        &#125;)  </div><div class="line">       .build(  </div><div class="line">           <span class="keyword">new</span> CacheLoader&lt;Key, Graph&gt;() &#123;  </div><div class="line">             <span class="function"><span class="keyword">public</span> Graph <span class="title">load</span><span class="params">(Key key)</span> </span>&#123; <span class="comment">// no checked exception  </span></div><div class="line">               <span class="keyword">return</span> createExpensiveGraph(key);  </div><div class="line">             &#125;  </div><div class="line">           &#125;);</div></pre></td></tr></table></figure></p>
<h3 id="Timed-Eviction"><a href="#Timed-Eviction" class="headerlink" title="Timed Eviction"></a>Timed Eviction</h3><p>CacheBuilder 提供了俩种方式来实现这一模式<br>expireAfterAccess(long, TimeUnit)<br>从最后一次访问(读或者写)开始计时，过了这段指定的时间就会释放掉该entries。注意：那些被删掉的entries的顺序时和size-based eviction是十分相似的。<br>expireAfterWrite(long,TimeUnit)<br>它是从entries被创建或者最后一次被修改值的点来计时的，如果从这个点开始超过了那段指定的时间，entries就会被删除掉。这点设计的很精明，因为数据会随着时间变得越来越陈旧。<br>如果想要测试Timed Eviction，使用Ticker interface和CacheBuilder.ticker(Ticker)方法对你的cache设定一个时间即可，那么你就不需要去等待系统时间了。</p>
<h3 id="Reference-based-Eviction"><a href="#Reference-based-Eviction" class="headerlink" title="Reference-based Eviction"></a>Reference-based Eviction</h3><p>Guava为你准备了entries的垃圾回收器，对于keys或者values可以使用<code>weak reference</code> ，对于values可以使用 <code>soft reference</code>.</p>
<p><code>CacheBuilder.weakKeys()</code>通过weak reference存储keys。在这种情况下，如果keys没有被strong或者soft引用，那么entries会被垃圾回收。这种条件下的垃圾回收器是建立在标识符(引用)之上的，那么这会造成整个cache是使用==来比较俩个key的，而不是equals();</p>
<p><code>CacheBuilder.weakValues()</code>  通过weak referene 存储values.在这种情况下，如果valves没有被strong或者soft引用，那么entries会被垃圾回收。这种条件下的垃圾回收器是建立在标识符(引用)之上的，那么这会造成整个cache是使用==来比较俩个values的，而不是equals();<br>CacheBuilder.softValues()</p>
<h3 id="Explicit-Removals"><a href="#Explicit-Removals" class="headerlink" title="Explicit Removals"></a>Explicit Removals</h3><p>也许在某年某月某天你不想再等cache释放entries，而是自己能手动的去释放掉这些entries，下面三个方法会帮助你</p>
<ul>
<li>单个释放：Cache.invalidate(key)</li>
<li>多个释放：Cache.invalidateAll(keys)</li>
<li>全部释放：Cache.invalidateAll()</li>
</ul>
<h3 id="Removal-Listeners"><a href="#Removal-Listeners" class="headerlink" title="Removal Listeners"></a>Removal Listeners</h3><p>cache允许你指定一个removal listener监听entry的移除操作(例如<code>CacheBuilder.removalListener(RemovalListener)</code>).通过R<code>emovaNotification</code>获得的<code>RemovalListener</code>制定了RemovalCause,key和value`。</p>
<blockquote>
<p>注意RemovalListener抛出的任何异常都会被Logger记录然后被丢弃</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">CacheLoader&lt;Key, DatabaseConnection&gt; loader = <span class="keyword">new</span> CacheLoader&lt;Key, DatabaseConnection&gt; () &#123;  </div><div class="line">  <span class="function"><span class="keyword">public</span> DatabaseConnection <span class="title">load</span><span class="params">(Key key)</span> <span class="keyword">throws</span> Exception </span>&#123;  </div><div class="line">    <span class="keyword">return</span> openConnection(key);  </div><div class="line">  &#125;  </div><div class="line">&#125;;  </div><div class="line">RemovalListener&lt;Key, DatabaseConnection&gt; removalListener = <span class="keyword">new</span> RemovalListener&lt;Key, DatabaseConnection&gt;() &#123;  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRemoval</span><span class="params">(RemovalNotification&lt;Key, DatabaseConnection&gt; removal)</span> </span>&#123;  </div><div class="line">    DatabaseConnection conn = removal.getValue();  </div><div class="line">    conn.close(); <span class="comment">// tear down properly  </span></div><div class="line">  &#125;  </div><div class="line">&#125;;  </div><div class="line"></div><div class="line"><span class="keyword">return</span> CacheBuilder.newBuilder()  </div><div class="line">  .expireAfterWrite(<span class="number">2</span>, TimeUnit.MINUTES)  </div><div class="line">  .removalListener(removalListener)  </div><div class="line">  .build(loader);</div></pre></td></tr></table></figure>
<p>警告：removal listeners是被默认同步执行的，而且cache的维护是在其普通操作中维护的，那么“昂贵的”removal listener会降低cache操作(某些方法)的效率。如果你在使用一个”昂贵的”removal listener，你可以使用RemovalListener.asynchronous(RemovalListener,Executor),将其布置成异步操作.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java-Library/">Java Library</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2013/09/13/JavaLibrary/Guava CachesExplained/#comments" class="ds-thread-count comments-count-link" data-thread-key="2013/09/13/JavaLibrary/Guava CachesExplained/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2013/09/13/zookeeper/ZooKeeper 服务器/" title="ZooKeeper 服务器" itemprop="url">ZooKeeper 服务器</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2013-09-13T07:00:00.000Z" itemprop="datePublished"> Published 2013-09-13</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>演示windows系统下快速使用<code>Zookeeper3.4.6</code>版本</p>
<h2 id="单机模式"><a href="#单机模式" class="headerlink" title="单机模式"></a>单机模式</h2><p>我们从Zookeeper官网下载下其最新的压缩包之后,然后解压得到下面的目录：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">├───bin</div><div class="line">├───conf</div><div class="line">├───contrib</div><div class="line">├───datadir</div><div class="line">├───dist-maven</div><div class="line">├───docs</div><div class="line">├───lib</div><div class="line">├───recipes</div><div class="line">└───src</div></pre></td></tr></table></figure></p>
<blockquote>
<p><code>datadir</code>是我自己创建的,用于存放内存数据的快照文件。</p>
</blockquote>
<ol>
<li>进入到<code>conf</code>目录，将<code>zoo_sample.cfg</code>修改为<code>zoo.cfg</code>文件</li>
<li>修改<code>zoo.cfg</code>文件内容,<code>dataDir=E:/zookeeper-3.4.6/datadir</code>这个是我修改过的路径</li>
<li>进入到<code>bin</code>目录, 执行<code>.\zkServer.cmd start</code> .最后见到<code>Established session 0x150eb438ceb0000 with negotiated timeout 30000 for client /127.0.0.1:54408</code>就启动成功了</li>
</ol>
<blockquote>
<p>如果遇到<code>java.lang.NumberFormatException: For input string: &quot;E:\zookeeper-3.4.6\bin\..\conf\zoo.cfg&quot;</code>这个提示,那就要去修改<code>bin/zkServer.cmd</code>文件, 将<code>%*</code>这个去掉就好了</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">call %JAVA% "-Dzookeeper.log.dir=%ZOO_LOG_DIR%" "-Dzookeeper.root.logger=%ZOO_LOG4J_PROP%" -cp "%CLASSPATH%" %ZOOMAIN% "%ZOOCFG%" %*</div></pre></td></tr></table></figure>
<p>修改成<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">call %JAVA% "-Dzookeeper.log.dir=%ZOO_LOG_DIR%" "-Dzookeeper.root.logger=%ZOO_LOG4J_PROP%" -cp "%CLASSPATH%" %ZOOMAIN% "%ZOOCFG%"</div></pre></td></tr></table></figure></p>
<h2 id="集群模式"><a href="#集群模式" class="headerlink" title="集群模式"></a>集群模式</h2>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/ZooKeeper/">ZooKeeper</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2013/09/13/zookeeper/ZooKeeper 服务器/#comments" class="ds-thread-count comments-count-link" data-thread-key="2013/09/13/zookeeper/ZooKeeper 服务器/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2012/08/20/杂记/SVN 总结/" title="SVN 总结" itemprop="url">SVN 总结</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2012-08-20T07:00:00.000Z" itemprop="datePublished"> Published 2012-08-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="服务器搭建"><a href="#服务器搭建" class="headerlink" title="服务器搭建"></a>服务器搭建</h2><p>下载svn服务器<a href="http://sourceforge.net/projects/win32svn/" target="_blank" rel="external">subversion</a>和svn客户端TortoiseSVN(下载页面有安装程序和汉化程序)，还有<a href="">apache</a>(apache主要是为了解析成网络，要不然安装好的svn只能在局域网里使用)</p>
<p>在e盘下创建svn仓库<code>svnresp</code> <img src="https://raw.githubusercontent.com/ming15/blog-website/images/svn/0.jpg" alt=""></p>
<p>创建好版本库后需要将版本库里的配置文件<code>E:\svnresp\conf\svnserve.conf</code>文件进行修改<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># password-db = passwd</div><div class="line">将其修改成</div><div class="line">password-db = passwd</div></pre></td></tr></table></figure></p>
<p>如果不修改这个配置在提交文件是会产生：svn认证失败的错误。 修改如图,前面一定不能有空格：<br><a href="https://raw.githubusercontent.com/ming15/blog-website/images/svn/1.jpg" target="_blank" rel="external"></a><a href="https://raw.githubusercontent.com/ming15/blog-website/images/svn/2.jpg" target="_blank" rel="external"></a><br>然后修改同一目录下的<code>E:\svnresp\conf\passwd.conf</code>文件<br><a href="https://raw.githubusercontent.com/ming15/blog-website/images/svn/3.jpg" target="_blank" rel="external"></a></p>
<blockquote>
<p>注意xiaoli是合法用户，而sally则是非法用户。=前面的为用户名，后面的为密码，同样的前面不能有空格</p>
</blockquote>
<p>都配置好成功之后，接下来我到一个测试项目下进行导入。</p>
<p>首先是开启我们的svn服务器：<br><a href="https://raw.githubusercontent.com/ming15/blog-website/images/svn/4.jpg" target="_blank" rel="external"></a></p>
<p>回车后只要不显示其他内容那么就说明该svn服务器已经启动了。<code>svnserve -d -r</code>是固定写法，而其后面的内容是版本库地址。</p>
<p>然后我们找到测试项目，在空白处右击<br><a href="https://raw.githubusercontent.com/ming15/blog-website/images/svn/5.jpg" target="_blank" rel="external"></a></p>
<p>选择版本浏览器或者导入都可以，我选择的是导入。<br><a href="https://raw.githubusercontent.com/ming15/blog-website/images/svn/6.jpg" target="_blank" rel="external"></a></p>
<p><code>localhost</code>是你要把文件提交到的svn版本库的ip，我在本机做的所以就填写的localhost。而newdemo是我为提交的文件所存放的文件夹。导入信息就是这个版本的信息，可以在版本浏览器中看到。<br><a href="https://raw.githubusercontent.com/ming15/blog-website/images/svn/7.jpg" target="_blank" rel="external"></a><br>填写好在passwd文件里配置好的用户名和密码就可以提交文件了。<br><a href="https://raw.githubusercontent.com/ming15/blog-website/images/svn/8.jpg" target="_blank" rel="external"></a></p>
<h2 id="修改服务器地址"><a href="#修改服务器地址" class="headerlink" title="修改服务器地址"></a>修改服务器地址</h2><p>当svn服务器地址变化之后我们使用如下命令进行修改<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn <span class="keyword">switch</span> --relocate http:<span class="comment">//10.234.10.11/svn/server/ http://10.230.8.116/svn/server/</span></div></pre></td></tr></table></figure></p>
<blockquote>
<p>在修改前后我们可以使用<code>svn info</code>命令进行查看, 当前svn信息.</p>
</blockquote>
<h2 id="无法clean-up"><a href="#无法clean-up" class="headerlink" title="无法clean up"></a>无法clean up</h2><p>在TortoiseSVN执行clean up时报错“Previous operation has not finished; run ‘cleanup’ if it was interrupted”, 遇到这种情况只要在命令行里执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn cleanup</div></pre></td></tr></table></figure></p>
<p>就好了</p>
<blockquote>
<p>需要在安装TortoiseSVN时, 勾选上命令行工具</p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/杂记/">杂记</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2012/08/20/杂记/SVN 总结/#comments" class="ds-thread-count comments-count-link" data-thread-key="2012/08/20/杂记/SVN 总结/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/9/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github Card</p>
<div class="github-card" data-github="yu66" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/JVM/" title="JVM">JVM<sup>38</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java/" title="Java">Java<sup>36</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java-Library/" title="Java Library">Java Library<sup>40</sup></a></li>
		  
		
		  
			<li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/NoSql/" title="NoSql">NoSql<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/数据库/" title="数据库">数据库<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/杂记/" title="杂记">杂记<sup>23</sup></a></li>
		  
		
		  
			<li><a href="/categories/算法/" title="算法">算法<sup>11</sup></a></li>
		  
		
		  
			<li><a href="/categories/编程语言/" title="编程语言">编程语言<sup>20</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Netty/" title="Netty">Netty<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/asm/" title="asm">asm<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Spring/" title="Spring">Spring<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Guice/" title="Guice">Guice<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="http://vertx.yu66.wang/" target="_blank" title="vertx3">vertx3</a>
            
          </li>
        
    </ul>
</div>

  

<div class="doubanshow">
<p class="asidetitle">Douban Show</p>
<div>
<script type="text/javascript" src="http://www.douban.com/service/badge/xxxyy/?show=collection&amp;n=12&amp;columns=3&amp;hidelogo=yes&amp;hideself=yes&amp;cat=book|movie" ></script>
</div>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=3253370782&verifier=e9ca895b&dpc=1"></iframe>
</div>


  

<div class="lofter">
<p class="asidetitle">Lofter</p>

 <iframe width="100%" height="39" class="share_self"  frameborder="0" scrolling="no" src="http://ming15.lofter.com/"></iframe>
</div>




</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 博客,我选择重构 <br/>
			重构使事情变得更美,更加正确</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/3253370782" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/yu66" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		<a href="https://www.douban.com/people/xxxyy" target="_blank" class="icon-douban" title="豆瓣"></a>
		
		
		<a href="http://www.zhihu.com/people/ming15" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="王玉">王玉</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"wanggnim"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F9e8fca440159a2125668804e46682db4' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
