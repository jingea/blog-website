
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>·</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="王玉">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="·">
<meta property="og:url" content="http://www.yu66.wang/page/7/index.html">
<meta property="og:site_name" content="·">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="·">

    
    <link rel="alternative" href="/atom.xml" title="·" type="application/atom+xml">
    
    
    
    <link rel="apple-touch-icon" href="/img/author.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/author.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="·">·</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
						<form class="search" action="http://zhannei.baidu.com/cse/search" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= 17728547076946147000 ><input type="text" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/04/02/nosql/Redis部署/" title="Redis 部署" itemprop="url">Redis 部署</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2015-04-01T16:00:00.000Z" itemprop="datePublished"> 发表于 2015-04-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://www.redis.cn/download.html" target="_blank" rel="external">Redis安装 使用</a></p>
<p>下载，解压和安装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ wget http://download.redis.io/releases/redis-2.8.19.tar.gz</div><div class="line">$ tar xzf redis-2.8.19.tar.gz</div><div class="line">$ cd redis-2.8.19</div><div class="line">$ make</div></pre></td></tr></table></figure></p>
<p>编译后的可执行文件在src目录中，可以使用下面的命令运行Redis:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ src/redis-server</div></pre></td></tr></table></figure></p>
<p>你可以使用内置的客户端连接Redis:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ src/redis-cli</div><div class="line">redis&gt; set foo bar</div><div class="line">OK</div><div class="line">redis&gt; get foo</div><div class="line">&quot;bar&quot;</div></pre></td></tr></table></figure></p>
<h3 id="启动redis服务器"><a href="#启动redis服务器" class="headerlink" title="启动redis服务器"></a>启动redis服务器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">cd redis-2.8.19</div><div class="line">src/redis-server</div></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/NoSql/">NoSql</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/04/02/nosql/Redis部署/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/04/02/nosql/Redis部署/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/03/09/JavaSE/并发 线程管理/" title="线程 状态管理" itemprop="url">线程 状态管理</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2015-03-08T16:00:00.000Z" itemprop="datePublished"> 发表于 2015-03-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>从<a href="https://docs.oracle.com/javase/7/docs/api/java/lang/Thread.State.html" target="_blank" rel="external">Oracle官方文档</a>中我们知道Java线程有如下几种状态</p>
<ul>
<li>NEW : Thread对象已经创建出来但是还没有运行.</li>
<li>RUNNABLE : 线程正在执行.</li>
<li>BLOCKED : 线程等待锁</li>
<li>WAITING : 线程正在等待另一个线程来对自己执行某个特定的行为.</li>
<li>TIMED_WAITING: 线程正在等待(在超时范围内)另一个线程来对自己执行某个特定的行为.</li>
<li>TERMINATED : 线程退出.</li>
</ul>
<p>从google上找了俩张线程图<br><img src="https://coderanch.com/t/616837/a/4509/threadStatesAll.png" alt=""><br><img src="https://avaldes.com/wp-content/uploads/2012/03/thread_states.png" alt=""></p>
<p>我们重点看一下<code>BLOCKED</code>, <code>WAITING</code>, <code>TIMED_WAITING</code></p>
<h2 id="BLOCKED"><a href="#BLOCKED" class="headerlink" title="BLOCKED"></a>BLOCKED</h2><p>当等待锁的时候,会引发线程的等待状态<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestLock</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		ThreadUtil.printThreadState(<span class="string">"thread1"</span>, <span class="string">"thread2"</span>);</div><div class="line"></div><div class="line">		Runnable runnable = () -&gt; &#123;</div><div class="line">			<span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">				System.out.println(Thread.currentThread().getName() + <span class="string">" Sleep"</span>);</div><div class="line">				<span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">				<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">					<span class="keyword">if</span> (System.currentTimeMillis() - now &gt; <span class="number">5000</span>) &#123;</div><div class="line">						<span class="keyword">break</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				System.out.println(Thread.currentThread().getName() + <span class="string">" Sleep Finshed"</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		Thread thread1 = <span class="keyword">new</span> Thread(runnable, <span class="string">"thread1"</span>);</div><div class="line">		Thread thread2 = <span class="keyword">new</span> Thread(runnable, <span class="string">"thread2"</span>);</div><div class="line">		thread1.start();</div><div class="line">		thread2.start();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">thread1 Sleep</div><div class="line">2016-09-22T17:05:37.064  thread2 -&gt; BLOCKED</div><div class="line">2016-09-22T17:05:37.064  thread1 -&gt; RUNNABLE</div><div class="line">2016-09-22T17:05:38.029  thread2 -&gt; BLOCKED</div><div class="line">2016-09-22T17:05:38.029  thread1 -&gt; RUNNABLE</div><div class="line">2016-09-22T17:05:39.030  thread2 -&gt; BLOCKED</div><div class="line">2016-09-22T17:05:39.030  thread1 -&gt; RUNNABLE</div><div class="line">2016-09-22T17:05:40.031  thread2 -&gt; BLOCKED</div><div class="line">2016-09-22T17:05:40.031  thread1 -&gt; RUNNABLE</div><div class="line">thread1 Sleep Finshed</div><div class="line">thread2 Sleep</div><div class="line">2016-09-22T17:05:41.032  thread2 -&gt; RUNNABLE</div><div class="line">2016-09-22T17:05:42.033  thread2 -&gt; RUNNABLE</div><div class="line">2016-09-22T17:05:43.034  thread2 -&gt; RUNNABLE</div><div class="line">2016-09-22T17:05:44.035  thread2 -&gt; RUNNABLE</div><div class="line">2016-09-22T17:05:45.037  thread2 -&gt; RUNNABLE</div><div class="line">thread2 Sleep Finshed</div></pre></td></tr></table></figure></p>
<p>我们看到thread2就进入了BLOCKED状态.</p>
<h2 id="WAITING"><a href="#WAITING" class="headerlink" title="WAITING"></a>WAITING</h2><p>调用下面三个方法,线程会进入WAITING状态</p>
<ul>
<li><code>Object.wait</code> with no timeout</li>
<li><code>Thread.join</code> with no timeout</li>
<li><code>LockSupport.park</code></li>
</ul>
<p>注意在调用 <code>Object.wait</code> 和 <code>Thread.join</code> 方法时, 不能传参, 否则线程不会进入到WAITING状态, 我在join中做了个实现</p>
<h3 id="wait"><a href="#wait" class="headerlink" title="wait"></a>wait</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestWait</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		ThreadUtil.printThreadState(<span class="string">"User"</span>);</div><div class="line"></div><div class="line">		Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">			<span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">			<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (System.currentTimeMillis() - now &gt; <span class="number">2000</span>) &#123;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					lock.wait();</div><div class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">					e.printStackTrace();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;, <span class="string">"User"</span>);</div><div class="line">		thread.start();</div><div class="line"></div><div class="line">		Thread notify = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">			<span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">			<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (System.currentTimeMillis() - now &gt; <span class="number">5000</span>) &#123;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">				lock.notify();</div><div class="line">			&#125;</div><div class="line">		&#125;, <span class="string">"notify"</span>);</div><div class="line">		notify.start();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="number">2016</span>-<span class="number">09</span>-<span class="number">22</span>T17:<span class="number">18</span>:<span class="number">12.745</span>  User -&gt; RUNNABLE</div><div class="line"><span class="number">2016</span>-<span class="number">09</span>-<span class="number">22</span>T17:<span class="number">18</span>:<span class="number">13.747</span>  User -&gt; WAITING</div><div class="line"><span class="number">2016</span>-<span class="number">09</span>-<span class="number">22</span>T17:<span class="number">18</span>:<span class="number">14.729</span>  User -&gt; WAITING</div><div class="line"><span class="number">2016</span>-<span class="number">09</span>-<span class="number">22</span>T17:<span class="number">18</span>:<span class="number">15.712</span>  User -&gt; WAITING</div><div class="line"><span class="number">2016</span>-<span class="number">09</span>-<span class="number">22</span>T17:<span class="number">18</span>:<span class="number">16.713</span>  User -&gt; WAITING</div></pre></td></tr></table></figure></p>
<h3 id="join"><a href="#join" class="headerlink" title="join"></a>join</h3><p>Threead类的join()方法被调用时,调用它的线程将被挂起,直到这个线程对象完成它的任务join(long millseconds)如果使用这种方法,被挂起的线程只要满足指定的毫秒数到,或者join线程运行完,被挂起线程恢复运行<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.time.LocalDateTime;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJoin</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		ThreadUtil.printThreadState(<span class="string">"main"</span>, <span class="string">"car"</span>, <span class="string">"dog"</span>);</div><div class="line"></div><div class="line">		Thread carThread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">			System.out.println(LocalDateTime.now() + <span class="string">" Car run"</span>);</div><div class="line">			<span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">			<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (System.currentTimeMillis() - now &gt; <span class="number">3000</span>) &#123;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			System.out.println(LocalDateTime.now() + <span class="string">" Car Stop"</span>);</div><div class="line">		&#125;, <span class="string">"car"</span>);</div><div class="line"></div><div class="line">		Thread dogThread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">			System.out.println(LocalDateTime.now() + <span class="string">" Dog run"</span>);</div><div class="line">			<span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">			<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (System.currentTimeMillis() - now &gt; <span class="number">3000</span>) &#123;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			System.out.println(LocalDateTime.now() + <span class="string">" Dog Stop"</span>);</div><div class="line">		&#125;, <span class="string">"dog"</span>);</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			dogThread.start();</div><div class="line">			carThread.start();</div><div class="line">			System.out.println(<span class="string">"Begin join"</span>);</div><div class="line">			carThread.join();</div><div class="line">			System.out.println(<span class="string">"Started join"</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Begin join</div><div class="line">2016-09-22T17:17:04.053 Car run</div><div class="line">2016-09-22T17:17:04.053 Dog run</div><div class="line">2016-09-22T17:17:05.011  car -&gt; RUNNABLE</div><div class="line">2016-09-22T17:17:05.011  main -&gt; WAITING</div><div class="line">2016-09-22T17:17:05.011  dog -&gt; RUNNABLE</div><div class="line">2016-09-22T17:17:06.013  car -&gt; RUNNABLE</div><div class="line">2016-09-22T17:17:06.013  main -&gt; WAITING</div><div class="line">2016-09-22T17:17:06.013  dog -&gt; RUNNABLE</div><div class="line">2016-09-22T17:17:07.011  car -&gt; RUNNABLE</div><div class="line">2016-09-22T17:17:07.011  main -&gt; WAITING</div><div class="line">2016-09-22T17:17:07.011  dog -&gt; RUNNABLE</div><div class="line">2016-09-22T17:17:07.055 Car Stop</div><div class="line">Started join</div><div class="line">2016-09-22T17:17:07.060 Dog Stop</div></pre></td></tr></table></figure></p>
<p>当我调用<code>carThread.join(3);</code>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Begin join</div><div class="line">Started join</div><div class="line">2016-09-22T17:19:26.029 Car run</div><div class="line">2016-09-22T17:19:26.036 Dog run</div><div class="line">2016-09-22T17:19:27.004  dog -&gt; RUNNABLE</div><div class="line">2016-09-22T17:19:27.005  car -&gt; RUNNABLE</div><div class="line">2016-09-22T17:19:28.004  dog -&gt; RUNNABLE</div><div class="line">2016-09-22T17:19:28.004  car -&gt; RUNNABLE</div><div class="line">2016-09-22T17:19:29.005  dog -&gt; RUNNABLE</div><div class="line">2016-09-22T17:19:29.005  car -&gt; RUNNABLE</div><div class="line">2016-09-22T17:19:29.030 Car Stop</div><div class="line">2016-09-22T17:19:29.037 Dog Stop</div></pre></td></tr></table></figure></p>
<h2 id="TIMED-WAITING"><a href="#TIMED-WAITING" class="headerlink" title="TIMED_WAITING"></a>TIMED_WAITING</h2><p>调用下列方法线程会进入TIMED_WAITING状态</p>
<ul>
<li>Thread.sleep</li>
<li>Object.wait with timeout</li>
<li>Thread.join with timeout</li>
<li>LockSupport.parkNanos</li>
<li>LockSupport.parkUntil</li>
</ul>
<h3 id="sleep"><a href="#sleep" class="headerlink" title="sleep"></a>sleep</h3><p>使用sleep()方法中断线程的运行. sleep()中断线程后,直到CPU时钟来临JVM选中它继续执行的这段期间, 该线程不会占用任何资源</p>
<blockquote>
<p>yield()方法通知JVM该线程对象可以释放CPU了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSleep</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		ThreadUtil.printThreadState(<span class="string">"User"</span>);</div><div class="line"></div><div class="line">		Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">			<span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">			<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (System.currentTimeMillis() - now &gt; <span class="number">2000</span>) &#123;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			System.out.println(<span class="string">"User Sleep"</span>);</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				TimeUnit.SECONDS.sleep(<span class="number">2</span>);</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			System.out.println(<span class="string">"User Sleep Finshed"</span>);</div><div class="line">		&#125;, <span class="string">"User"</span>);</div><div class="line">		thread.start();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">2016-09-22T17:29:12.378  User -&gt; RUNNABLE</div><div class="line">2016-09-22T17:29:13.345  User -&gt; RUNNABLE</div><div class="line">User Sleep</div><div class="line">2016-09-22T17:29:14.346  User -&gt; TIMED_WAITING</div><div class="line">2016-09-22T17:29:15.347  User -&gt; TIMED_WAITING</div><div class="line">User Sleep Finshed</div></pre></td></tr></table></figure></p>
<h3 id="join-1"><a href="#join-1" class="headerlink" title="join"></a>join</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.time.LocalDateTime;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJoin</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		ThreadUtil.printThreadState(<span class="string">"main"</span>, <span class="string">"car"</span>, <span class="string">"dog"</span>);</div><div class="line"></div><div class="line">		Thread carThread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">			System.out.println(LocalDateTime.now() + <span class="string">" Car run"</span>);</div><div class="line">			<span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">			<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (System.currentTimeMillis() - now &gt; <span class="number">3000</span>) &#123;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			System.out.println(LocalDateTime.now() + <span class="string">" Car Stop"</span>);</div><div class="line">		&#125;, <span class="string">"car"</span>);</div><div class="line"></div><div class="line">		Thread dogThread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">			System.out.println(LocalDateTime.now() + <span class="string">" Dog run"</span>);</div><div class="line">			<span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">			<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (System.currentTimeMillis() - now &gt; <span class="number">3000</span>) &#123;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			System.out.println(LocalDateTime.now() + <span class="string">" Dog Stop"</span>);</div><div class="line">		&#125;, <span class="string">"dog"</span>);</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			dogThread.start();</div><div class="line">			carThread.start();</div><div class="line"></div><div class="line">			System.out.println(<span class="string">"Begin join"</span>);</div><div class="line">			carThread.join(<span class="number">3000</span>);</div><div class="line">			System.out.println(<span class="string">"end join"</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Begin join</div><div class="line">2016-09-22T18:23:56.591 Dog run</div><div class="line">2016-09-22T18:23:56.601 Car run</div><div class="line">2016-09-22T18:23:57.646  main -&gt; TIMED_WAITING</div><div class="line">2016-09-22T18:23:57.647  dog -&gt; RUNNABLE</div><div class="line">2016-09-22T18:23:57.647  car -&gt; RUNNABLE</div><div class="line">2016-09-22T18:23:58.582  main -&gt; TIMED_WAITING</div><div class="line">2016-09-22T18:23:58.582  dog -&gt; RUNNABLE</div><div class="line">2016-09-22T18:23:58.582  car -&gt; RUNNABLE</div><div class="line">end join</div><div class="line">2016-09-22T18:23:59.583  dog -&gt; RUNNABLE</div><div class="line">2016-09-22T18:23:59.583  car -&gt; RUNNABLE</div><div class="line">2016-09-22T18:23:59.592 Dog Stop</div><div class="line">2016-09-22T18:23:59.602 Car Stop</div></pre></td></tr></table></figure></p>
<h3 id="wait-1"><a href="#wait-1" class="headerlink" title="wait"></a>wait</h3><p>参考join</p>
<h2 id="守护线程的创建和运行"><a href="#守护线程的创建和运行" class="headerlink" title="守护线程的创建和运行"></a>守护线程的创建和运行</h2><p>守护线程的优先级很低,通常来说,同一个应用程序中没有其他的线程运行,守护线程才运行. 当守护线程运行结束后,JVM也就结束了这个应用程序</p>
<p>守护线程通常用来作为同一程序中普通线程的服务提供者,因为没有办法确定守护线程什么时候才能获取CPU时钟, 而且在没有其他线程运行的时候,守护线程随时可能会结束</p>
<blockquote>
<p> 一个典型的守护线程就是java的垃圾回收器</p>
</blockquote>
<p><code>setDeamon()</code>方法只能在<code>start()</code>方法之前被调用,一旦线程开始运行,将不能再修改其状态</p>
<blockquote>
<p>注: 需要注意的是,只有在没有用户线程运行的时候,而不是没有用户线程存在的时候守护线程才运行. 例如当所有用户线程多沉睡后,也会被视为没有用户线程执行</p>
</blockquote>
<ol>
<li>Thread.setDaemon(true)必须在thread.start()之前设置，否则会跑出一个IllegalThreadStateException异常。你不能把正在运行的常规线程设置为守护线程。</li>
<li>在Daemon线程中产生的新线程也是Daemon的</li>
<li>不是所有的应用都可以分配给Daemon线程来进行服务，比如读写操作或者计算逻辑。因为在Daemon Thread还没来的及进行操作时，虚拟机可能已经退出了。</li>
<li>当用户线程都运行完后,守护线程也就跟着结束了</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		DeameanThread dt = <span class="keyword">new</span> DeameanThread();</div><div class="line">		NormalThread nt = <span class="keyword">new</span> NormalThread();</div><div class="line">		nt.start();</div><div class="line">		dt.start();</div><div class="line">		System.out.println(<span class="string">"main"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">NormalThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">	NormalThread() &#123;</div><div class="line">		setDaemon(<span class="keyword">false</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">long</span> old = System.currentTimeMillis();</div><div class="line">		<span class="keyword">while</span>((System.currentTimeMillis() - old) &lt; <span class="number">3000</span>) &#123;&#125;</div><div class="line">		System.out.println(<span class="string">"NormalThread"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DeameanThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">	DeameanThread() &#123;</div><div class="line">		setDaemon(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">while</span>(<span class="keyword">true</span>)&#123;&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ThreadUtil"><a href="#ThreadUtil" class="headerlink" title="ThreadUtil"></a>ThreadUtil</h2><p>在上面的例子中用到的输出线程状态信息的工具类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.time.LocalDateTime;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadUtil</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printThreadState</span><span class="params">(String... filter)</span> </span>&#123;</div><div class="line">		Thread print = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">			<span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line">			<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (System.currentTimeMillis() - now &gt; <span class="number">1000</span>) &#123;</div><div class="line">					now = System.currentTimeMillis();</div><div class="line">					Thread.getAllStackTraces().forEach((key, thread) -&gt; &#123;</div><div class="line">						<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filter.length; i++) &#123;</div><div class="line">							<span class="keyword">if</span> (key.getName().equals(filter[i])) &#123;</div><div class="line">								System.out.println(LocalDateTime.now() + <span class="string">"  "</span> +key.getName() + <span class="string">" -&gt; "</span> + key.getState());</div><div class="line">							&#125;</div><div class="line">						&#125;</div><div class="line">					&#125;);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;, <span class="string">"Print"</span>);</div><div class="line">		print.start();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/03/09/JavaSE/并发 线程管理/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/03/09/JavaSE/并发 线程管理/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/03/08/nosql/MongoDB/" title="运行MongoDB" itemprop="url">运行MongoDB</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2015-03-08T08:00:00.000Z" itemprop="datePublished"> 发表于 2015-03-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="Run-MongoDB-On-Windows"><a href="#Run-MongoDB-On-Windows" class="headerlink" title="Run MongoDB On Windows"></a>Run MongoDB On Windows</h2><p>如果在没有进行auth设置且在Secure Mode运行, 那么就不要使 mongod.exe在公共网络上可见.</p>
<h3 id="设置MOngoDB环境"><a href="#设置MOngoDB环境" class="headerlink" title="设置MOngoDB环境"></a>设置MOngoDB环境</h3><h4 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h4><p>在环境变量里添加环境变量 <code>D:\Program Files\MongoDB\Server\3.0\</code> 然后在Path里添加： <code>%MONGODB_HOME%\bin</code></p>
<h4 id="data-directory"><a href="#data-directory" class="headerlink" title="data directory"></a>data directory</h4><p>MongoDB 需要一个data directory来存储全部的数据. MongoDB默认的data directory路径是<code>\data\db</code>,<br>所以我们需要创建一个data directory. 假设我们在D盘创建了一个这样的目录: <code>D:\mongodb\data\db</code>.</p>
<p>你可以通过–dbpath选项给mongod.exe设置另一个data directory.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongod.exe --dbpath D:\mongodb\data\db</div></pre></td></tr></table></figure></p>
<p>如果你的data directory包含空格的话,那么就需要使用””将他们包含起来：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongod.exe --dbpath <span class="string">"d:\test\mongo db data"</span></div></pre></td></tr></table></figure></p>
<h2 id="启动MongoDB"><a href="#启动MongoDB" class="headerlink" title="启动MongoDB"></a>启动MongoDB</h2><h3 id="使用mongod-exe命令启动mongoDB"><a href="#使用mongod-exe命令启动mongoDB" class="headerlink" title="使用mongod.exe命令启动mongoDB"></a>使用mongod.exe命令启动mongoDB</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongod.exe</div></pre></td></tr></table></figure>
<h3 id="启动日志"><a href="#启动日志" class="headerlink" title="启动日志"></a>启动日志</h3><p>最后我们在启动日志里看到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">waiting for connections on port 27017</div></pre></td></tr></table></figure></p>
<h3 id="命令行方式启动"><a href="#命令行方式启动" class="headerlink" title="命令行方式启动"></a>命令行方式启动</h3><p>MongoDB 默认存储数据目录为/data/db/ (或者 c:/data/db), 默认端口 27017,默认 HTTP 端口 28017.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongod --dbpath=/data/db</div></pre></td></tr></table></figure></p>
<h3 id="配置文件方式启动"><a href="#配置文件方式启动" class="headerlink" title="配置文件方式启动"></a>配置文件方式启动</h3><p>MongoDB 也支持同 mysql 一样的读取启动配置文件的方式来启动数据库,配置文件的内容如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat /etc/mongodb.cnf</div></pre></td></tr></table></figure></p>
<p>启动时加上”-f”参数,并指向配置文件即可:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongod -f /etc/mongodb.cnf</div></pre></td></tr></table></figure></p>
<h4 id="Daemon-方式启动"><a href="#Daemon-方式启动" class="headerlink" title="Daemon 方式启动"></a>Daemon 方式启动</h4><p>MongoDB 提供了一种后台 Daemon 方式启动的选择,只需加上一个” –fork”参数即可,,但如果用到了 ” –fork”参数就必须也启用 ”–logpath”参数,这是强制的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongod --dbpath=/data/db --logpath=/data/log/r3.log --fork</div></pre></td></tr></table></figure></p>
<h4 id="mongod-参数说明"><a href="#mongod-参数说明" class="headerlink" title="mongod 参数说明"></a>mongod 参数说明</h4><p>mongod 的参数分为一般参数, windows 参数, replication 参数, replica set 参数,以及隐含参数.上面列举的都是一般参数</p>
<p>mongod 的参数中,没有设置内存大小相关的参数,是的, MongoDB 使用 os mmap 机制来缓存数据文件数据,自身目前不提供缓存机制.这样好处是代码简单,<br>mmap 在数据量不超过内存时效率很高.但是数据量超过系统可用内存后,则写入的性能可能不太稳定,容易出现大起大落,不过在最新的 1.8 版本中,这个情况相对以前的版本已经<br>有了一定程度的改善.</p>
<h5 id="mongod-的主要参数有："><a href="#mongod-的主要参数有：" class="headerlink" title="mongod 的主要参数有："></a>mongod 的主要参数有：</h5><ul>
<li>dbpath —— 数据文件存放路径,每个数据库会在其中创建一个子目录,用于防止同一个实例多次运行的 mongod.lock 也保存在此目录中.</li>
<li>logpath —— 错误日志文件</li>
<li>logappend —— 错误日志采用追加模式（默认是覆写模式）</li>
<li>bind_ip —— 对外服务的绑定 ip,一般设置为空,及绑定在本机所有可用 ip 上,如有需要可以单独指定</li>
<li>port —— 对外服务端口 . Web 管理端口在这个 port 的基础上+1000</li>
<li>fork —— 以后台 Daemon 形式运行服务</li>
<li>journal —— 开启日志功能,通过保存操作日志来降低单机故障的恢复时间,在 1.8 版本后正式加入,取代在 1.7.5 版本中的 dur 参数.</li>
<li>syncdelay —— 系统同步刷新磁盘的时间,单位为秒,默认是 60 秒.</li>
<li>directoryperdb —— 每个 db 存放在单独的目录中,建议设置该参数.与 MySQL 的独立表空间类似</li>
<li>maxConns —— 最大连接数</li>
<li>repairpath —— 执行 repair 时的临时目录.在如果没有开启 journal,异常 down 机后重启 ,必须执行 repair操作.</li>
</ul>
<h2 id="停止数据库"><a href="#停止数据库" class="headerlink" title="停止数据库"></a>停止数据库</h2><ul>
<li>Control-C</li>
<li>shutdownServer()指令<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mongo --port 28013</div><div class="line">use admin</div><div class="line">db.shutdownServer()</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="常用工具集"><a href="#常用工具集" class="headerlink" title="常用工具集"></a>常用工具集</h2><p>MongoDB 在 bin 目录下提供了一系列有用的工具,这些工具提供了 MongoDB 在运维管理上的方便。</p>
<ul>
<li>bsondump: 将 bson 格式的文件转储为 json 格式的数据</li>
<li>mongo: 客户端命令行工具,其实也是一个 js 解释器,支持 js 语法</li>
<li>mongod: 数据库服务端,每个实例启动一个进程,可以 fork 为后台运行</li>
<li>mongodump/ mongorestore: 数据库备份和恢复工具</li>
<li>mongoexport/ mongoimport: 数据导出和导入工具</li>
<li>mongofiles: GridFS 管理工具,可实现二制文件的存取</li>
<li>mongos: 分片路由,如果使用了 sharding 功能,则应用程序连接的是 mongos 而不是mongod</li>
<li>mongosniff: 这一工具的作用类似于 tcpdump,不同的是他只监控 MongoDB 相关的包请求,并且是以指定的可读性的形式输出</li>
<li>mongostat: 实时性能监控工具</li>
</ul>
<h2 id="部署-Replica-Sets"><a href="#部署-Replica-Sets" class="headerlink" title="部署 Replica Sets"></a>部署 Replica Sets</h2><ul>
<li><p>创建数据文件存储路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir E:/mongoData/data/r0</div><div class="line">mkdir E:/mongoData/data/r1</div><div class="line">mkdir E:/mongoData/data/r2</div></pre></td></tr></table></figure>
</li>
<li><p>创建日志文件路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir E:/mongoData/log</div></pre></td></tr></table></figure>
</li>
<li><p>创建主从 key 文件，用于标识集群的私钥的完整路径，如果各个实例的 key file 内容不一致，程序将不能正常用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mkdir E:/mongoData/key</div><div class="line">echo &quot;this is rs1 super secret key&quot; &gt; E:/mongoData/key/r0</div><div class="line">echo &quot;this is rs1 super secret key&quot; &gt; E:/mongoData/key/r1</div><div class="line">echo &quot;this is rs1 super secret key&quot; &gt; E:/mongoData/key/r2</div></pre></td></tr></table></figure>
</li>
<li><p>启动 3 个实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mongod --replSet rs1 --keyFile E:/mongoData/key/r0 -fork --port 28010 --dbpath E:/mongoData/data/r0 --logpath=E:/mongoData/log/r0.log --logappend</div><div class="line">mongod --replSet rs1 --keyFile E:/mongoData/key/r1 -fork --port 28011 --dbpath E:/mongoData/data/r1 --logpath=E:/mongoData/log/r1.log --logappend</div><div class="line">mongod --replSet rs1 --keyFile E:/mongoData/key/r2 -fork --port 28012 --dbpath E:/mongoData/data/r2 --logpath=E:/mongoData/log/r2.log --logappend</div></pre></td></tr></table></figure>
</li>
<li><p>配置及初始化 Replica Sets</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongo -port 28010</div></pre></td></tr></table></figure>
</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/NoSql/">NoSql</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/03/08/nosql/MongoDB/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/03/08/nosql/MongoDB/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/03/08/nosql/MongoDB Replica/" title="MongoDB Replica" itemprop="url">MongoDB Replica</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2015-03-08T08:00:00.000Z" itemprop="datePublished"> 发表于 2015-03-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Deploy-a-Replica-Set"><a href="#Deploy-a-Replica-Set" class="headerlink" title="Deploy a Replica Set"></a>Deploy a Replica Set</h1><p>这篇教程讲述的是如何基于正在运行的不进行控制访问的<code>mongod</code>创建三个<code>replica set</code>.</p>
<p>如果想要创建带有控制访问功能的<code>replica set</code>,参考<a href="http://docs.mongodb.org/manual/tutorial/deploy-replica-set-with-auth/" target="_blank" rel="external">Deploy Replica Set and Configure Authentication and Authorization</a>. 如果你想要在一个单独的MongoDB上部署<code>replica set</code>, 可以参考<a href="http://docs.mongodb.org/manual/tutorial/convert-standalone-to-replica-set/" target="_blank" rel="external">Convert a Standalone to a Replica Set</a>. 关于更多的<code>replica set</code>部署信息,参考<a href="http://docs.mongodb.org/manual/replication/" target="_blank" rel="external">Replication</a>和<a href="http://docs.mongodb.org/manual/core/replica-set-architectures/" target="_blank" rel="external">Replica Set Deployment Architectures</a></p>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>带有三个成员的<code>replica sets</code>就足够应付网络切分和其他类型的系统失败. 那些sets有足够的能力来应付分布式类型的读操作. <code>Replica sets</code>应该保证它的成员数量维持在一个奇数上. 这条规则能够保证正常的<a href="http://docs.mongodb.org/manual/core/replica-set-elections/" target="_blank" rel="external">elections</a>. 更多关于对<code>replica sets</code>的设计,参考<a href="http://docs.mongodb.org/manual/core/replication-introduction/" target="_blank" rel="external">Replication overview</a></p>
<p>基本的步骤是: 首先启动要成为<code>replica set</code>成员的<code>mongod</code>, 然后配置<code>replica set</code>, 最后将<code>mongod</code>添加到<code>replica set</code>上.</p>
<h2 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h2><p>在生产部署阶段, 你应该尽量在不同的主机上部署代理<code>mongod</code>的成员. 当使用虚拟主机进行生产部署时, 你应该在不同的主机服务器上都部署一个’mongod’.</p>
<p>在你创建<code>replica set</code>之前, 你必须先检查你的网络配置能够允许每一个成员都能够相互连接上. 一个成功的<code>replica set</code>部署, 每一个成员都能够连接得上其他成员. 关于如何检查连接,参考<a href="http://docs.mongodb.org/manual/tutorial/troubleshoot-replica-sets/#replica-set-troubleshooting-check-connection" target="_blank" rel="external">Test Connections Between all Members</a></p>
<h2 id="Considerations-When-Deploying-a-Replica-Set"><a href="#Considerations-When-Deploying-a-Replica-Set" class="headerlink" title="Considerations When Deploying a Replica Set"></a>Considerations When Deploying a Replica Set</h2><h3 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h3><p>在生产阶段, 将<code>replica set</code>和它的成员部署到同一台机器上. 如果可能的话, 绑定到MongoDB标准端口27017上. 使用<code>bind_ip</code>选项确保MongoDB会根据配置好的地址监听来自应用程序的连接.</p>
<p>如果<code>replica set</code>在不同的机房内部署, 那么应该确保大多数的<code>mongod</code>实例部署在第一站点上.参考<a href="">Replica Set Deployment Architectures</a></p>
<h3 id="Connectivity"><a href="#Connectivity" class="headerlink" title="Connectivity"></a>Connectivity</h3><p>确保网络中所有的<code>replica set</code>成员和客户端的流量能够安全和高效地传输:</p>
<ul>
<li>创建一个虚拟的私有网络. 确保该网络上一个单独站点可以路由不同成员间 间所有的流量.</li>
<li>配置访问控制能够阻止未知的客户端连接到 <code>replica set</code>上</li>
<li>配置网络和防火墙规则以便进站和出站的网络包仅仅是在MongoDB的默认端口和你的配置上.</li>
</ul>
<p>最终确保<code>replica set</code>中每个成员都可以通过可解析的<code>DNS</code>或者<code>hostname</code>访问到. 你应该恰当地设置上<code>DNS</code>名称或者通过<code>/etc/hosts</code>文件来映射这个配置</p>
<h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><p>Specify the run time configuration on each system in a configuration file stored in /etc/mongodb.conf or a related location. Create the directory where MongoDB stores data files before deploying MongoDB.</p>
<p>For more information about the run time options used above and other configuration options, see Configuration File Options.</p>
<h2 id="Procedure"><a href="#Procedure" class="headerlink" title="Procedure"></a>Procedure</h2><p>下面的步骤概括了在<code>access control</code>失效的情况下如何部署replica set</p>
<h3 id="Start-each-member-of-the-replica-set-with-the-appropriate-options"><a href="#Start-each-member-of-the-replica-set-with-the-appropriate-options" class="headerlink" title="Start each member of the replica set with the appropriate options."></a>Start each member of the replica set with the appropriate options.</h3><p>启动<code>mongod</code>然后通过<code>replSet</code>选项设定<code>replica set</code>名字, 向<code>replica set</code>中添加一个成员. 如果想要配置其他特有参数,参考<a href="">Replication Options</a></p>
<p>如果你的应用程序连接了多个<code>replica set</code>, 每一个<code>replica set</code>都应该有一个独立的名字. 某些驱动会根据<code>replica set</code>名称将<code>replica set</code>连接进行分组.</p>
<p>下面是一个示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongod --replSet &quot;rs0&quot;</div></pre></td></tr></table></figure></p>
<p>你也通过配置文件设置<code>replica set</code>名字. 如果想要通过配置文件启动<code>mongod</code>, 那么你需要<code>--config</code>选项指定配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongod --config $HOME/.mongodb/config</div></pre></td></tr></table></figure></p>
<p>在生产部署阶段, 你可以通过配置一个控制脚本来管理这个进程. 但是控制脚本的使用超过了该教程的介绍范围.</p>
<blockquote>
<p>注意:</p>
<p>如果你的c盘没有创建C:/data/db, 那么会抛出 ：Hotfix KB2731284 or later update is not installed. 以及 C:\data\db not found 的字样.</p>
<p>那么你就需要在命令上加上 –dbpath 选项了</p>
</blockquote>
<h3 id="Connect-a-mongo-shell-to-a-replica-set-member"><a href="#Connect-a-mongo-shell-to-a-replica-set-member" class="headerlink" title="Connect a mongo shell to a replica set member."></a>Connect a mongo shell to a replica set member.</h3><p>下例展示了如何连接到在<code>localhost:27017</code>上运行的<code>mongod</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongo</div></pre></td></tr></table></figure></p>
<h3 id="Initiate-the-replica-set"><a href="#Initiate-the-replica-set" class="headerlink" title="Initiate the replica set."></a>Initiate the replica set.</h3><p>接着这<code>mongo</code>shell里使用<code>rs.initiate()</code>设置成员.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rs.initiate()</div></pre></td></tr></table></figure></p>
<p>MongoDB使用<code>replica set</code>默认配置启动了一个包含当前成员的<code>replica set</code></p>
<blockquote>
<p>注意:</p>
<p>这个过程大概需要几分钟的时间, 所以需要耐心的稍等一下.</p>
</blockquote>
<h3 id="Verify-the-initial-replica-set-configuration"><a href="#Verify-the-initial-replica-set-configuration" class="headerlink" title="Verify the initial replica set configuration."></a>Verify the initial replica set configuration.</h3><p>在<code>mongo</code>shell中使用<code>rs.conf()</code>输出<code>replica set</code>配置:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rs.conf()</div></pre></td></tr></table></figure></p>
<p>输出的<code>replica set</code>配置类似于下面的结构<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">   <span class="attr">"_id"</span> : <span class="string">"rs0"</span>,</div><div class="line">   <span class="attr">"version"</span> : <span class="number">1</span>,</div><div class="line">   <span class="attr">"members"</span> : [</div><div class="line">      &#123;</div><div class="line">         <span class="attr">"_id"</span> : <span class="number">1</span>,</div><div class="line">         <span class="attr">"host"</span> : <span class="string">"mongodb0.example.net:27017"</span></div><div class="line">      &#125;</div><div class="line">   ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Add-the-remaining-members-to-the-replica-set"><a href="#Add-the-remaining-members-to-the-replica-set" class="headerlink" title="Add the remaining members to the replica set."></a>Add the remaining members to the replica set.</h3><p>在<code>mongo</code>shell中使用<code>rs.add()</code>方法添加俩个成员:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">rs.add(&quot;mongodb1.example.net&quot;)</div><div class="line">rs.add(&quot;mongodb2.example.net&quot;)</div></pre></td></tr></table></figure></p>
<p>完成这一步之后,你就获得了一个拥有完整功能的<code>replica set</code>. 新的<code>replica set</code>会选出一个主要的来.</p>
<h3 id="Check-the-status-of-the-replica-set"><a href="#Check-the-status-of-the-replica-set" class="headerlink" title="Check the status of the replica set."></a>Check the status of the replica set.</h3><p>在<code>mongo</code>shell中使用<code>rs.status()</code>方法查看<code>replica set</code>状态.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rs.status()</div></pre></td></tr></table></figure></p>
<h2 id="Replication-Introduction"><a href="#Replication-Introduction" class="headerlink" title="Replication Introduction"></a>Replication Introduction</h2><p><code>Replication</code> 是用于多台服务器间数据同步的一个进程.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/NoSql/">NoSql</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/03/08/nosql/MongoDB Replica/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/03/08/nosql/MongoDB Replica/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/03/08/nosql/MongoDB客户端/" title="MongoDB客户端" itemprop="url">MongoDB客户端</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2015-03-08T08:00:00.000Z" itemprop="datePublished"> 发表于 2015-03-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="A-Quick-Tour"><a href="#A-Quick-Tour" class="headerlink" title="A Quick Tour"></a>A Quick Tour</h2><p>使用java 驱动开发是非常简单的,首先你要确保你的<code>classpath</code>中包含<code>mongo.jar</code></p>
<h3 id="Making-a-Connection"><a href="#Making-a-Connection" class="headerlink" title="Making a Connection"></a>Making a Connection</h3><p>为了能够连接上MongoDB,最低的要求也是你要知道连接的database的名称. 这个数据库可以不存在,如果不存在的话,MongoDB会自动创建这个数据库</p>
<p>另外,你可以指定连接的服务器的地址和端口,下面的例子展示了三种连接本地<code>mydb</code>数据库的方式<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.mongodb.BasicDBObject;</div><div class="line"><span class="keyword">import</span> com.mongodb.BulkWriteOperation;</div><div class="line"><span class="keyword">import</span> com.mongodb.BulkWriteResult;</div><div class="line"><span class="keyword">import</span> com.mongodb.Cursor;</div><div class="line"><span class="keyword">import</span> com.mongodb.DB;</div><div class="line"><span class="keyword">import</span> com.mongodb.DBCollection;</div><div class="line"><span class="keyword">import</span> com.mongodb.DBCursor;</div><div class="line"><span class="keyword">import</span> com.mongodb.DBObject;</div><div class="line"><span class="keyword">import</span> com.mongodb.MongoClient;</div><div class="line"><span class="keyword">import</span> com.mongodb.ParallelScanOptions;</div><div class="line"><span class="keyword">import</span> com.mongodb.ServerAddress;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.concurrent.TimeUnit.SECONDS;</div><div class="line"></div><div class="line"><span class="comment">// To directly connect to a single MongoDB server (note that this will not auto-discover the primary even</span></div><div class="line"><span class="comment">// if it's a member of a replica set:</span></div><div class="line">MongoClient mongoClient = <span class="keyword">new</span> MongoClient();</div><div class="line"><span class="comment">// or</span></div><div class="line">MongoClient mongoClient = <span class="keyword">new</span> MongoClient( <span class="string">"localhost"</span> );</div><div class="line"><span class="comment">// or</span></div><div class="line">MongoClient mongoClient = <span class="keyword">new</span> MongoClient( <span class="string">"localhost"</span> , <span class="number">27017</span> );</div><div class="line"><span class="comment">// or, to connect to a replica set, with auto-discovery of the primary, supply a seed list of members</span></div><div class="line">MongoClient mongoClient = <span class="keyword">new</span> MongoClient(Arrays.asList(<span class="keyword">new</span> ServerAddress(<span class="string">"localhost"</span>, <span class="number">27017</span>),</div><div class="line">                                      <span class="keyword">new</span> ServerAddress(<span class="string">"localhost"</span>, <span class="number">27018</span>),</div><div class="line">                                      <span class="keyword">new</span> ServerAddress(<span class="string">"localhost"</span>, <span class="number">27019</span>)));</div><div class="line"></div><div class="line">DB db = mongoClient.getDB( <span class="string">"mydb"</span> );</div></pre></td></tr></table></figure></p>
<p>在这个例子中<code>db</code>对象保持着一个对MongoDB服务器指定数据库的一个连接. 通过这个对象你可以做很多其他操作</p>
<blockquote>
<p>Note:</p>
<p><code>MongoClient</code>实例实际上维持着对这个数据库的一个连接池. 即使在多线程的情况下,你也只需要一个<code>MongoClient</code>实例, 参考<a href="">concurrency doc page</a></p>
</blockquote>
<p><code>MongoClient</code>被设计成一个线程安全且线程共享的类. 一个典型例子是,你对一个数据库集群仅仅创建了一个<code>MongoClient</code>实例,然后在你的整个应用程序中都使用这一个实例. 如果出于一些特殊原因你不得不创建多个<code>MongoClient</code>实例,那么你需要注意下面俩点：</p>
<ul>
<li>all resource usage limits (max connections, etc) apply per MongoClient instance</li>
<li>当关闭一个实例时,你必须确保你调用了<code>MongoClient.close()</code>清理掉了全部的资源</li>
</ul>
<p>New in version 2.10.0: The MongoClient class is new in version 2.10.0. For releases prior to that, please use the Mongo class instead.</p>
<h3 id="Authentication-Optional"><a href="#Authentication-Optional" class="headerlink" title="Authentication (Optional)"></a>Authentication (Optional)</h3><p>MongoDB可以在安全模式下运行, 这种模式下,需要通过验证才能访问数据库. 当在这种模式下运行的时候, 任何客户端都必须提供一组证书.在java Driver中,你只需要在创建<code>MongoClient</code>实例时提供一下证书.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">MongoCredential credential = MongoCredential.createMongoCRCredential(userName, database, password);</div><div class="line">MongoClient mongoClient = <span class="keyword">new</span> MongoClient(<span class="keyword">new</span> ServerAddress(), Arrays.asList(credential));</div></pre></td></tr></table></figure></p>
<p>MongoDB支持不同的认证机制,具体参考<a href="">the access control tutorials</a></p>
<h3 id="Getting-a-Collection"><a href="#Getting-a-Collection" class="headerlink" title="Getting a Collection"></a>Getting a Collection</h3><p>如果想要使用一个collection,那么你仅仅需要调用<code>getCollection(String collectionName)</code>方法,然后指定该collection名称就好</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DBCollection coll = db.getCollection(<span class="string">"testCollection"</span>);</div></pre></td></tr></table></figure>
<p>一旦你有了collection对象,那你就可以执行例如插入数据,查询数据等等的操作了</p>
<h3 id="Setting-Write-Concern"><a href="#Setting-Write-Concern" class="headerlink" title="Setting Write Concern"></a>Setting Write Concern</h3><p>在2.10.0这个版本里,默认的write concern是<code>WriteConcern.ACKNOWLEDGED</code>不过你可以通过下面的方法轻松改变它<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongoClient.setWriteConcern(WriteConcern.JOURNALED);</div></pre></td></tr></table></figure></p>
<p>对应write concern提供了很多种选项. 另外,这个默认的write concern分别可以在数据库,collection,以及单独的更新操作上重载.</p>
<h3 id="Inserting-a-Document"><a href="#Inserting-a-Document" class="headerlink" title="Inserting a Document"></a>Inserting a Document</h3><p>一旦你拥有了collection对象,你就可以向该collection中插入document. 例如,我们可以插入一个像下面这样的一个json文档<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">   "name" : "MongoDB",</div><div class="line">   "type" : "database",</div><div class="line">   "count" : 1,</div><div class="line">   "info" : &#123;</div><div class="line">               x : 203,</div><div class="line">               y : 102</div><div class="line">             &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意,上面的例子中我们有一个内嵌的文档.想要插入这样一个文档,我们可以使用<code>BasicDBObject</code>类来实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">BasicDBObject doc = <span class="keyword">new</span> BasicDBObject(<span class="string">"name"</span>, <span class="string">"MongoDB"</span>)</div><div class="line">        .append(<span class="string">"type"</span>, <span class="string">"database"</span>)</div><div class="line">        .append(<span class="string">"count"</span>, <span class="number">1</span>)</div><div class="line">        .append(<span class="string">"info"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"x"</span>, <span class="number">203</span>).append(<span class="string">"y"</span>, <span class="number">102</span>));</div><div class="line">coll.insert(doc);</div></pre></td></tr></table></figure></p>
<h3 id="findOne"><a href="#findOne" class="headerlink" title="findOne()"></a>findOne()</h3><p>如果想要查看刚才插入的文档,我们可以简单地调用<code>findOne()</code>,这个操作会获得该collection中的第一个文档.这个方法只是返回一个文档对象(而<code>find()</code>会返回一个<code>DBCursor</code>对象),当collection中只有一个文档的时候,这是非常有用的.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">DBObject myDoc = coll.findOne();</div><div class="line">System.out.println(myDoc);</div></pre></td></tr></table></figure></p>
<p>结果如下：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123; <span class="attr">"_id"</span> : <span class="string">"49902cde5162504500b45c2c"</span> ,</div><div class="line">  <span class="attr">"name"</span> : <span class="string">"MongoDB"</span> ,</div><div class="line">  <span class="attr">"type"</span> : <span class="string">"database"</span> ,</div><div class="line">  <span class="attr">"count"</span> : <span class="number">1</span> ,</div><div class="line">  <span class="attr">"info"</span> : &#123; <span class="attr">"x"</span> : <span class="number">203</span> , <span class="attr">"y"</span> : <span class="number">102</span>&#125;&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>Note:</p>
<p><code>_id</code>元素是MongoDB自动添加到你的文档中的. 记住,MongoDB内部以“_”/”$”开头储存元素名称</p>
</blockquote>
<h3 id="Adding-Multiple-Documents"><a href="#Adding-Multiple-Documents" class="headerlink" title="Adding Multiple Documents"></a>Adding Multiple Documents</h3><p>当测试一些其他查询的时候,我们需要大量的数据,让我们添加一些简单的文档到collection中.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">   <span class="attr">"i"</span> : value</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们可以在一个循环中不断地插入数据<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</div><div class="line">    coll.insert(<span class="keyword">new</span> BasicDBObject(<span class="string">"i"</span>, i));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意：我们可以向同一个collection中插入包含不同元素的文档.所以MongoDB也被称为<code>schema-free</code></p>
<h3 id="Counting-Documents-in-A-Collection"><a href="#Counting-Documents-in-A-Collection" class="headerlink" title="Counting Documents in A Collection"></a>Counting Documents in A Collection</h3><p>通过以上的操作我们已经插入了101个文档,我们通过<code>getCount()</code>方法来检查一下.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.out.println(coll.getCount());</div></pre></td></tr></table></figure></p>
<h3 id="Using-a-Cursor-to-Get-All-the-Documents"><a href="#Using-a-Cursor-to-Get-All-the-Documents" class="headerlink" title="Using a Cursor to Get All the Documents"></a>Using a Cursor to Get All the Documents</h3><p>如果想要获得collection中的全部文档,我们可以使用<code>find()</code>方法. <code>find()</code>返回一个<code>DBCursor</code>对象,我们可以通过遍历该对象获取所有匹配我们需求的文档.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">DBCursor cursor = coll.find();</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">   <span class="keyword">while</span>(cursor.hasNext()) &#123;</div><div class="line">       System.out.println(cursor.next());</div><div class="line">   &#125;</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">   cursor.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Getting-A-Single-Document-with-A-Query"><a href="#Getting-A-Single-Document-with-A-Query" class="headerlink" title="Getting A Single Document with A Query"></a>Getting A Single Document with A Query</h3><p>我们可以向<code>find()</code>方法传递一个查询参数, 通过该参数找到集合中符合需求的文档子集. 下例中展示了我们想要找到i是7的所有文档.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">BasicDBObject query = <span class="keyword">new</span> BasicDBObject(<span class="string">"i"</span>, <span class="number">71</span>);</div><div class="line"></div><div class="line">cursor = coll.find(query);</div><div class="line"></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">   <span class="keyword">while</span>(cursor.hasNext()) &#123;</div><div class="line">       System.out.println(cursor.next());</div><div class="line">   &#125;</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">   cursor.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>该代码只会输出一个文档<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123; <span class="attr">"_id"</span> : <span class="string">"49903677516250c1008d624e"</span> , <span class="attr">"i"</span> : <span class="number">71</span> &#125;</div></pre></td></tr></table></figure></p>
<p>你也可以从其他的实例和文档中查看<code>$</code>操作符的用法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.things.find(&#123;j: &#123;$ne: <span class="number">3</span>&#125;, k: &#123;$gt: <span class="number">10</span>&#125; &#125;);</div></pre></td></tr></table></figure></p>
<p>使用内嵌的<code>DBObject</code>,<code>$</code>可以看作是正则表达式字串<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">query = <span class="keyword">new</span> BasicDBObject(<span class="string">"j"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"$ne"</span>, <span class="number">3</span>))</div><div class="line">        .append(<span class="string">"k"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"$gt"</span>, <span class="number">10</span>));</div><div class="line"></div><div class="line">cursor = coll.find(query);</div><div class="line"></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">while</span>(cursor.hasNext()) &#123;</div><div class="line">        System.out.println(cursor.next());</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">    cursor.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Getting-A-Set-of-Documents-With-a-Query"><a href="#Getting-A-Set-of-Documents-With-a-Query" class="headerlink" title="Getting A Set of Documents With a Query"></a>Getting A Set of Documents With a Query</h3><p>我们可以使用查询来获得collection中的一个文档集合.例如,我们使用下面的语法来获取所有i &gt; 50的文档<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// find all where i &gt; 50</span></div><div class="line">query = <span class="keyword">new</span> BasicDBObject(<span class="string">"i"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"$gt"</span>, <span class="number">50</span>));</div><div class="line"></div><div class="line">cursor = coll.find(query);</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">while</span> (cursor.hasNext()) &#123;</div><div class="line">        System.out.println(cursor.next());</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">    cursor.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们还可以获得一个区间(20 &lt; i &lt;= 30)文档集合<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">query = <span class="keyword">new</span> BasicDBObject(<span class="string">"i"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"$gt"</span>, <span class="number">20</span>).append(<span class="string">"$lte"</span>, <span class="number">30</span>));</div><div class="line">cursor = coll.find(query);</div><div class="line"></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">while</span> (cursor.hasNext()) &#123;</div><div class="line">        System.out.println(cursor.next());</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">    cursor.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="MaxTime"><a href="#MaxTime" class="headerlink" title="MaxTime"></a>MaxTime</h3><p>MongoDB2.6 添加查询超时的能力</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">coll.find().maxTime(<span class="number">1</span>, SECONDS).count();</div></pre></td></tr></table></figure>
<p>在上面的例子中将<code>maxTime</code>设置为1s,当时间到后查询将被打断</p>
<h3 id="Bulk-operations"><a href="#Bulk-operations" class="headerlink" title="Bulk operations"></a>Bulk operations</h3><p>Under the covers MongoDB is moving away from the combination of a write operation followed by get last error (GLE) and towards a write commands API. These new commands allow for the execution of bulk insert/update/remove operations. There are two types of bulk operations:</p>
<ol>
<li>Ordered bulk operations. 按顺序执行全部的操作,当遇到第一个写失败的时候,退出</li>
<li>Unordered bulk operations. 并行执行全部操作, 同时收集全部错误.该操作不保证按照顺序执行</li>
</ol>
<p>下面展示了上面所说的俩个示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1. Ordered bulk operation</span></div><div class="line">BulkWriteOperation builder = coll.initializeOrderedBulkOperation();</div><div class="line">builder.insert(<span class="keyword">new</span> BasicDBObject(<span class="string">"_id"</span>, <span class="number">1</span>));</div><div class="line">builder.insert(<span class="keyword">new</span> BasicDBObject(<span class="string">"_id"</span>, <span class="number">2</span>));</div><div class="line">builder.insert(<span class="keyword">new</span> BasicDBObject(<span class="string">"_id"</span>, <span class="number">3</span>));</div><div class="line"></div><div class="line">builder.find(<span class="keyword">new</span> BasicDBObject(<span class="string">"_id"</span>, <span class="number">1</span>)).updateOne(<span class="keyword">new</span> BasicDBObject(<span class="string">"$set"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"x"</span>, <span class="number">2</span>)));</div><div class="line">builder.find(<span class="keyword">new</span> BasicDBObject(<span class="string">"_id"</span>, <span class="number">2</span>)).removeOne();</div><div class="line">builder.find(<span class="keyword">new</span> BasicDBObject(<span class="string">"_id"</span>, <span class="number">3</span>)).replaceOne(<span class="keyword">new</span> BasicDBObject(<span class="string">"_id"</span>, <span class="number">3</span>).append(<span class="string">"x"</span>, <span class="number">4</span>));</div><div class="line"></div><div class="line">BulkWriteResult result = builder.execute();</div><div class="line"></div><div class="line"><span class="comment">// 2. Unordered bulk operation - no guarantee of order of operation</span></div><div class="line">builder = coll.initializeUnorderedBulkOperation();</div><div class="line">builder.find(<span class="keyword">new</span> BasicDBObject(<span class="string">"_id"</span>, <span class="number">1</span>)).removeOne();</div><div class="line">builder.find(<span class="keyword">new</span> BasicDBObject(<span class="string">"_id"</span>, <span class="number">2</span>)).removeOne();</div><div class="line"></div><div class="line">result = builder.execute();</div></pre></td></tr></table></figure></p>
<blockquote>
<p>Note:</p>
<p>For servers older than 2.6 the API will down convert the operations. To support the correct semantics for BulkWriteResult and BulkWriteException, the operations have to be done one at a time. It’s not possible to down convert 100% so there might be slight edge cases where it cannot correctly report the right numbers.</p>
</blockquote>
<h3 id="parallelScan"><a href="#parallelScan" class="headerlink" title="parallelScan"></a>parallelScan</h3><p>MongoDB 2.6 增加了<code>parallelCollectionScan</code>命令, 该命令通过使用多个游标读取整个collection.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">ParallelScanOptions parallelScanOptions = ParallelScanOptions</div><div class="line">        .builder()</div><div class="line">        .numCursors(<span class="number">3</span>)</div><div class="line">        .batchSize(<span class="number">300</span>)</div><div class="line">        .build();</div><div class="line"></div><div class="line">List&lt;Cursor&gt; cursors = coll.parallelScan(parallelScanOptions);</div><div class="line"><span class="keyword">for</span> (Cursor pCursor: cursors) &#123;</div><div class="line">    <span class="keyword">while</span> (pCursor.hasNext()) &#123;</div><div class="line">        System.out.println((pCursor.next()));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其对collection进行IO吞吐量的优化.</p>
<blockquote>
<p>Note:</p>
<p><code>ParallelScan</code>不能通过<code>mongos</code>运行</p>
</blockquote>
<h2 id="Quick-Tour-of-the-Administrative-Functions"><a href="#Quick-Tour-of-the-Administrative-Functions" class="headerlink" title="Quick Tour of the Administrative Functions"></a>Quick Tour of the Administrative Functions</h2><h3 id="Getting-A-List-of-Databases"><a href="#Getting-A-List-of-Databases" class="headerlink" title="Getting A List of Databases"></a>Getting A List of Databases</h3><p>通过下面的代码你可以获取一个可用数据库列表<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">MongoClient mongoClient = <span class="keyword">new</span> MongoClient();</div><div class="line"></div><div class="line"><span class="keyword">for</span> (String s : mongoClient.getDatabaseNames()) &#123;</div><div class="line">   System.out.println(s);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用<code>mongoClient.getDB()</code>并不会创建一个数据库. 仅仅当尝试向数据库写入数据时,该数据库才会被创建. 例如尝试创建一个所以或者一个collection或者插入一个文档.</p>
<h3 id="Dropping-A-Database"><a href="#Dropping-A-Database" class="headerlink" title="Dropping A Database"></a>Dropping A Database</h3><p>通过<code>MongoClient</code>实例你也可以<code>drop</code>掉一个数据库<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">MongoClient mongoClient = <span class="keyword">new</span> MongoClient();</div><div class="line">mongoClient.dropDatabase(<span class="string">"databaseToBeDropped"</span>);</div></pre></td></tr></table></figure></p>
<h3 id="Creating-A-Collection"><a href="#Creating-A-Collection" class="headerlink" title="Creating A Collection"></a>Creating A Collection</h3><p>有俩种方式创建collection：</p>
<ol>
<li>如果向一个不存在的collection中尝试插入一个文档,那么该collection会被创建出来</li>
<li>或者直接调用<code>createCollection</code>命令</li>
</ol>
<p>下面的例子展示了创建1M大小的collection<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">db = mongoClient.getDB(<span class="string">"mydb"</span>);</div><div class="line">db.createCollection(<span class="string">"testCollection"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"capped"</span>, <span class="keyword">true</span>)</div><div class="line">        .append(<span class="string">"size"</span>, <span class="number">1048576</span>));</div></pre></td></tr></table></figure></p>
<h3 id="Getting-A-List-of-Collections"><a href="#Getting-A-List-of-Collections" class="headerlink" title="Getting A List of Collections"></a>Getting A List of Collections</h3><p>你可以通过下面的方式获得一个数据库当中可用collection列表<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (String s : db.getCollectionNames()) &#123;</div><div class="line">   System.out.println(s);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的例子会输出：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">system.indexes</div><div class="line">testCollection</div></pre></td></tr></table></figure></p>
<blockquote>
<p>Note:</p>
<p><code>system.indexes</code> collection是自动创建的, 它里面是数据库中所有的索引, 所以不应该直接访问它</p>
</blockquote>
<h3 id="Dropping-A-Collection"><a href="#Dropping-A-Collection" class="headerlink" title="Dropping A Collection"></a>Dropping A Collection</h3><p>你可以通过<code>drop()</code>方法直接drop掉一个collection<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">DBCollection coll = db.getCollection(<span class="string">"testCollection"</span>);</div><div class="line">coll.drop();</div><div class="line">System.out.println(db.getCollectionNames());</div></pre></td></tr></table></figure></p>
<h3 id="Getting-a-List-of-Indexes-on-a-Collection"><a href="#Getting-a-List-of-Indexes-on-a-Collection" class="headerlink" title="Getting a List of Indexes on a Collection"></a>Getting a List of Indexes on a Collection</h3><p>下例展示了如何获得一个collection中索引的列表<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">List&lt;DBObject&gt; list = coll.getIndexInfo();</div><div class="line"></div><div class="line"><span class="keyword">for</span> (DBObject o : list) &#123;</div><div class="line">   System.out.println(o.get(<span class="string">"key"</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的实例会进行下面的输出：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123; "v" : 1 , "key" : &#123; "_id" : 1&#125; , "name" : "_id_" , "ns" : "mydb.testCollection"&#125;</div><div class="line">&#123; "v" : 1 , "key" : &#123; "i" : 1&#125; , "name" : "i_1" , "ns" : "mydb.testCollection"&#125;</div><div class="line">&#123; "v" : 1 , "key" : &#123; "loc" : "2dsphere"&#125; , "name" : "loc_2dsphere" , ... &#125;</div><div class="line">&#123; "v" : 1 , "key" : &#123; "_fts" : "text" , "_ftsx" : 1&#125; , "name" : "content_text" , ... &#125;</div></pre></td></tr></table></figure></p>
<h3 id="Creating-An-Index"><a href="#Creating-An-Index" class="headerlink" title="Creating An Index"></a>Creating An Index</h3><p>MongoDB支持索引,而且它们可以轻松地插入到一个集合中.创建索引的过程非常简单,你只需要指定被索引的字段,你还可以指定该索引是上升的(1)还是下降的(-1).<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">coll.createIndex(<span class="keyword">new</span> BasicDBObject(<span class="string">"i"</span>, <span class="number">1</span>));  <span class="comment">// create index on "i", ascending</span></div></pre></td></tr></table></figure></p>
<h3 id="Geo-indexes"><a href="#Geo-indexes" class="headerlink" title="Geo indexes"></a>Geo indexes</h3><p>MongoDB支持不同的地理空间索引,在下面的例子中,我们将窗口一个<code>2dsphere</code>索引, 我们可以通过标准<code>GeoJson</code>标记进行查询. 想要创建一个<code>2dsphere</code>索引,我们需要在索引文档中指定<code>2dsphere</code>这个字面量.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">coll.createIndex(<span class="keyword">new</span> BasicDBObject(<span class="string">"loc"</span>, <span class="string">"2dsphere"</span>));</div></pre></td></tr></table></figure></p>
<p>有不同的方式去查询<code>2dsphere</code>索引,下面的例子中找到了500m以内的位置.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">BasicDBList coordinates = <span class="keyword">new</span> BasicDBList();</div><div class="line">coordinates.put(<span class="number">0</span>, -<span class="number">73.97</span>);</div><div class="line">coordinates.put(<span class="number">1</span>, <span class="number">40.77</span>);</div><div class="line">coll.insert(<span class="keyword">new</span> BasicDBObject(<span class="string">"name"</span>, <span class="string">"Central Park"</span>)</div><div class="line">                .append(<span class="string">"loc"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"type"</span>, <span class="string">"Point"</span>).append(<span class="string">"coordinates"</span>, coordinates))</div><div class="line">                .append(<span class="string">"category"</span>, <span class="string">"Parks"</span>));</div><div class="line"></div><div class="line">coordinates.put(<span class="number">0</span>, -<span class="number">73.88</span>);</div><div class="line">coordinates.put(<span class="number">1</span>, <span class="number">40.78</span>);</div><div class="line">coll.insert(<span class="keyword">new</span> BasicDBObject(<span class="string">"name"</span>, <span class="string">"La Guardia Airport"</span>)</div><div class="line">        .append(<span class="string">"loc"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"type"</span>, <span class="string">"Point"</span>).append(<span class="string">"coordinates"</span>, coordinates))</div><div class="line">        .append(<span class="string">"category"</span>, <span class="string">"Airport"</span>));</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// Find whats within 500m of my location</span></div><div class="line">BasicDBList myLocation = <span class="keyword">new</span> BasicDBList();</div><div class="line">myLocation.put(<span class="number">0</span>, -<span class="number">73.965</span>);</div><div class="line">myLocation.put(<span class="number">1</span>, <span class="number">40.769</span>);</div><div class="line">myDoc = coll.findOne(</div><div class="line">            <span class="keyword">new</span> BasicDBObject(<span class="string">"loc"</span>,</div><div class="line">                <span class="keyword">new</span> BasicDBObject(<span class="string">"$near"</span>,</div><div class="line">                        <span class="keyword">new</span> BasicDBObject(<span class="string">"$geometry"</span>,</div><div class="line">                                <span class="keyword">new</span> BasicDBObject(<span class="string">"type"</span>, <span class="string">"Point"</span>)</div><div class="line">                                    .append(<span class="string">"coordinates"</span>, myLocation))</div><div class="line">                             .append(<span class="string">"$maxDistance"</span>,  <span class="number">500</span>)</div><div class="line">                        )</div><div class="line">                )</div><div class="line">            );</div><div class="line">System.out.println(myDoc.get(<span class="string">"name"</span>));</div></pre></td></tr></table></figure></p>
<p>更多参考<a href="">geospatial</a>文档</p>
<h3 id="Text-indexes"><a href="#Text-indexes" class="headerlink" title="Text indexes"></a>Text indexes</h3><p>MongoDB还支持<code>text</code>索引,该索引用来支持从String中搜索文本. <code>text</code>索引可以包含任何字段,但是该字段的值必须是String或者String数组.想要创建一个<code>text</code>索引,只需要在索引文档中指定<code>text</code>字面量.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// create a text index on the "content" field</span></div><div class="line">coll.createIndex(<span class="keyword">new</span> BasicDBObject(<span class="string">"content"</span>, <span class="string">"text"</span>));</div></pre></td></tr></table></figure></p>
<p>MongoDB2.6 以后<code>text</code>索引融进了主要的查询语言中,并且成为了一种默认的方式.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Insert some documents</span></div><div class="line">coll.insert(<span class="keyword">new</span> BasicDBObject(<span class="string">"_id"</span>, <span class="number">0</span>).append(<span class="string">"content"</span>, <span class="string">"textual content"</span>));</div><div class="line">coll.insert(<span class="keyword">new</span> BasicDBObject(<span class="string">"_id"</span>, <span class="number">1</span>).append(<span class="string">"content"</span>, <span class="string">"additional content"</span>));</div><div class="line">coll.insert(<span class="keyword">new</span> BasicDBObject(<span class="string">"_id"</span>, <span class="number">2</span>).append(<span class="string">"content"</span>, <span class="string">"irrelevant content"</span>));</div><div class="line"></div><div class="line"><span class="comment">// Find using the text index</span></div><div class="line">BasicDBObject search = <span class="keyword">new</span> BasicDBObject(<span class="string">"$search"</span>, <span class="string">"textual content -irrelevant"</span>);</div><div class="line">BasicDBObject textSearch = <span class="keyword">new</span> BasicDBObject(<span class="string">"$text"</span>, search);</div><div class="line"><span class="keyword">int</span> matchCount = coll.find(textSearch).count();</div><div class="line">System.out.println(<span class="string">"Text search matches: "</span>+ matchCount);</div><div class="line"></div><div class="line"><span class="comment">// Find using the $language operator</span></div><div class="line">textSearch = <span class="keyword">new</span> BasicDBObject(<span class="string">"$text"</span>, search.append(<span class="string">"$language"</span>, <span class="string">"english"</span>));</div><div class="line">matchCount = coll.find(textSearch).count();</div><div class="line">System.out.println(<span class="string">"Text search matches (english): "</span>+ matchCount);</div><div class="line"></div><div class="line"><span class="comment">// Find the highest scoring match</span></div><div class="line">BasicDBObject projection = <span class="keyword">new</span> BasicDBObject(<span class="string">"score"</span>, <span class="keyword">new</span> BasicDBObject(<span class="string">"$meta"</span>, <span class="string">"textScore"</span>));</div><div class="line">myDoc = coll.findOne(textSearch, projection);</div><div class="line">System.out.println(<span class="string">"Highest scoring document: "</span>+ myDoc);</div></pre></td></tr></table></figure></p>
<p>上面的代码应该输出：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Text search matches: <span class="number">2</span></div><div class="line"><span class="function">Text search <span class="title">matches</span> <span class="params">(english)</span>: 2</span></div><div class="line">Highest scoring document: &#123; <span class="string">"_id"</span> : <span class="number">1</span> , <span class="string">"content"</span> : <span class="string">"additional content"</span> , <span class="string">"score"</span> : <span class="number">0.75</span>&#125;</div></pre></td></tr></table></figure></p>
<p>更多关于text search,参考<a href="">text index and $text query operator</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/NoSql/">NoSql</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/03/08/nosql/MongoDB客户端/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/03/08/nosql/MongoDB客户端/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/03/08/JavaSE/Java hook/" title="JAVA钩子程序" itemprop="url">JAVA钩子程序</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2015-03-07T16:00:00.000Z" itemprop="datePublished"> 发表于 2015-03-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>触发的时机有：</p>
<ol>
<li>当所有的非deamon线程(守护线程)结束, 或者调用了<code>Systrem.exit()</code>方法 而导致的程序正常的退出</li>
<li>JVM收到需要关闭自己的信号（比如SIGINT、SIGTERM等，但像SIGKILL，JVM就没有机会去处理了），也或者发生如系统关闭这种不可阻挡的事件。</li>
</ol>
<p>对于addShutdownHook中的钩子代码，也是有一些要注意的地方，下面列举几点：</p>
<ol>
<li>关闭钩子可以注册多个，在关闭JVM时就会起多个线程来运行钩子。通常来说，一个钩子就足够了，但如果需要启用多个钩子，就需要注意并发带来的问题。</li>
<li>钩子里也要注意对异常的处理，如果不幸抛出了异常，那么钩子的执行序列就会被终止。</li>
<li>在钩子运行期间，工作线程也在运行，需要考虑到工作线程是否会对钩子的执行带来影响</li>
<li>钩子里的代码尽可能简洁，否则当像系统关闭等情景可能钩子来不及运行完JVM就被退出了。</li>
</ol>
<h2 id="信号触发"><a href="#信号触发" class="headerlink" title="信号触发"></a>信号触发</h2><p>使信号触发JVM的钩子程序<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HookTest</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Hook());</div><div class="line">		<span class="keyword">while</span>(<span class="keyword">true</span>)&#123;&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Hook</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			System.out.println(<span class="string">"Hook execute!!!"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行钩子程序<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nohup java HookTest &amp;</div></pre></td></tr></table></figure></p>
<p>关闭程序<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kill HookTest_PID</div></pre></td></tr></table></figure></p>
<p>我们可以在nohup程序中看到Hook execute!!!输出</p>
<p>我从<a href="http://journal.thobe.org/2013/02/jvms-and-kill-signals.html" target="_blank" rel="external">JVMs and kill signals</a>看到一篇博客, 这个上面总结了哪些信号会导致JVM运行Hook<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function">signal			shutdown	runs hook	exit code	comment</span></div><div class="line"><span class="title">default</span> <span class="params">(<span class="number">15</span>)</span>	yes			yes			143			SIGTERM is the <span class="keyword">default</span> unix kill signal</div><div class="line">0				no			-			-	</div><div class="line">1 <span class="params">(SIGHUP)</span>		yes			yes			129	</div><div class="line">2 <span class="params">(SIGINT)</span>		yes			yes			130			SIGINT is the signal sent on ^C</div><div class="line">3 <span class="params">(SIGQUIT)</span>		no			-			-			触发 JVM dump threads / stack-traces</div><div class="line">4 <span class="params">(SIGILL)</span>		yes			no			134			触发 JVM 输出一个 core dump 文件, 同时abort on trap 6</div><div class="line">5				yes			no			133			Makes the JVM exit with "Trace/BPT trap: 5"</div><div class="line">6 <span class="params">(SIGABRT)</span>		yes			no			134			Makes the JVM exit with "Abort trap: 6"</div><div class="line">7				yes			no			135			Makes the JVM exit with "EMT trap: 7"</div><div class="line">8 <span class="params">(SIGFPE)</span>		yes			no			134			Makes the JVM write a core dump and abort on trap 6</div><div class="line">9 <span class="params">(SIGKILL)</span>		yes			no			137			The JVM is forcibly <span class="title">killed</span> <span class="params">(exits with <span class="string">"Killed: 9"</span>)</span></div><div class="line">10 <span class="params">(SIGBUS)</span>		yes			no			134			Emulates a "Bus Error"</div><div class="line">11 <span class="params">(SIGSEGV)</span>	yes			no			134			Emulates a "Segmentation fault"</div><div class="line">12				yes			no			140			Makes the JVM exit with "Bad system call: 12"</div><div class="line">13				no			-			-			</div><div class="line">14				yes			no			142			Makes the JVM exit with "Alarm clock: 14"</div><div class="line">15 <span class="params">(SIGTERM)</span>	yes			yes			143			This is the <span class="keyword">default</span> unix kill signal</div><div class="line">16				no			-			-			</div><div class="line">17				no			-			145			Stops the <span class="title">application</span> <span class="params">(sends it to the background)</span>, same as ^Z</div><div class="line">18				no			-			146			Stops the <span class="title">application</span> <span class="params">(sends it to the background)</span>, same as ^Z</div><div class="line">19				no			-			-			</div><div class="line">20				no			-			-			</div><div class="line">21				no			-			149			Stops the <span class="title">application</span> <span class="params">(sends it to the background)</span>, same as ^Z</div><div class="line">22				no			-			150			Stops the <span class="title">application</span> <span class="params">(sends it to the background)</span>, same as ^Z</div><div class="line">23				no			-			-			</div><div class="line">24				yes			no			152			Makes the JVM exit with "Cputime limit exceeded: 24"</div><div class="line">25				no			-			-			</div><div class="line">26				yes			no			154			Makes the JVM exit with "Virtual timer expired: 26"</div><div class="line">27				yes			no			155			Makes the JVM exit with "Profiling timer expired: 27"</div><div class="line">28				no			-			-			</div><div class="line">29				no			-			-			</div><div class="line">30				yes			no			158			Makes the JVM exit with "User defined signal 1: 30"</div><div class="line">31				yes			no			134			Makes the JVM exit on Segmentation fault</div></pre></td></tr></table></figure></p>
<h2 id="内存溢出触发"><a href="#内存溢出触发" class="headerlink" title="内存溢出触发"></a>内存溢出触发</h2><p>测试JVM栈溢出后调用钩子程序<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HookTest</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Hook());</div><div class="line">		exec();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exec</span><span class="params">()</span> </span>&#123;</div><div class="line">		exec();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Hook</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			System.out.println(<span class="string">"Hook execute!!!"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行后输出为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">D:\<span class="built_in">test</span>OOM&gt;java HookTest</div><div class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.StackOverflowError</div><div class="line">	at HookTest.exec(HookTest.java:9)</div><div class="line">	at HookTest.exec(HookTest.java:9)</div><div class="line">	at HookTest.exec(HookTest.java:9)</div><div class="line">	at HookTest.exec(HookTest.java:9)</div><div class="line">	...</div><div class="line">	at HookTest.exec(HookTest.java:9)</div><div class="line">	at HookTest.exec(HookTest.java:9)</div><div class="line">	at HookTest.exec(HookTest.java:9)</div><div class="line">	at HookTest.exec(HookTest.java:9)</div><div class="line">	at HookTest.exec(HookTest.java:9)</div><div class="line">	at HookTest.exec(HookTest.java:9)</div><div class="line">	at HookTest.exec(HookTest.java:9)</div><div class="line">	at HookTest.exec(HookTest.java:9)</div><div class="line">	at HookTest.exec(HookTest.java:9)</div><div class="line">	at HookTest.exec(HookTest.java:9)</div><div class="line">	at HookTest.exec(HookTest.java:9)</div><div class="line">Hook execute!!!</div><div class="line"></div><div class="line">D:\<span class="built_in">test</span>OOM&gt;</div></pre></td></tr></table></figure></p>
<p>为了测试在更加复杂的环境下, Hook的使用情况, 看下面的测试代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.time.LocalDateTime;</div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HookTest</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, String&gt; cache = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		cache.put(<span class="string">"abc"</span>, <span class="string">"abc"</span>);</div><div class="line"></div><div class="line">		Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Hook());</div><div class="line"></div><div class="line">		<span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">1024</span> *<span class="number">1024</span> * <span class="number">1024</span>];</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Hook</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</div><div class="line">				System.out.println(LocalDateTime.now());</div><div class="line">				System.out.println(<span class="string">"    freeMemory ： "</span> + Runtime.getRuntime().freeMemory());</div><div class="line">				System.out.println(<span class="string">"    maxMemory ： "</span> + Runtime.getRuntime().maxMemory());</div><div class="line">				System.out.println(<span class="string">"    totalMemory ： "</span> + Runtime.getRuntime().totalMemory());</div><div class="line">				System.out.println(<span class="string">"    currentThread name : "</span> + Thread.currentThread().getName());</div><div class="line">				System.out.println(<span class="string">"    cache size : "</span> + cache.size());</div><div class="line">				cache.put(LocalDateTime.now().toString(), LocalDateTime.now().toString());</div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					TimeUnit.SECONDS.sleep(<span class="number">1</span>);</div><div class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">					e.printStackTrace();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行后的输出结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">ζ java HookTest</div><div class="line">2016-07-09T16:12:12.479</div><div class="line">    freeMemory : 155922512</div><div class="line">    maxMemory : 2375024640</div><div class="line">    totalMemory : 160956416</div><div class="line">    currentThread name : Thread-0</div><div class="line">    cache size : 1</div><div class="line">2016-07-09T16:12:13.480</div><div class="line">    freeMemory : 155922512</div><div class="line">    maxMemory : 2375024640</div><div class="line">    totalMemory : 160956416</div><div class="line">    currentThread name : Thread-0</div><div class="line">    cache size : 2</div><div class="line">2016-07-09T16:12:14.480</div><div class="line">    freeMemory : 155922512</div><div class="line">    maxMemory : 2375024640</div><div class="line">    totalMemory : 160956416</div><div class="line">    currentThread name : Thread-0</div><div class="line">    cache size : 3</div><div class="line">2016-07-09T16:12:15.480</div><div class="line">    freeMemory : 155922512</div><div class="line">    maxMemory : 2375024640</div><div class="line">    totalMemory : 160956416</div><div class="line">    currentThread name : Thread-0</div><div class="line">    cache size : 4</div><div class="line">...</div></pre></td></tr></table></figure></p>
<h2 id="正常结束触发"><a href="#正常结束触发" class="headerlink" title="正常结束触发"></a>正常结束触发</h2><p>测试程序正常结束后也会调用钩子程序<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HookTest</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Hook());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Hook</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			System.out.println(<span class="string">"Hook execute!!!"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">D:\<span class="built_in">test</span>OOM&gt;java HookTest</div><div class="line">Hook execute!!!</div><div class="line"></div><div class="line">D:\<span class="built_in">test</span>OOM&gt;</div></pre></td></tr></table></figure></p>
<h2 id="调用exit-触发"><a href="#调用exit-触发" class="headerlink" title="调用exit()触发"></a>调用exit()触发</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HookTest</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Hook());</div><div class="line">		System.exit(<span class="number">0</span>);</div><div class="line"></div><div class="line">		System.out.println(<span class="string">"Main over"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Hook</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			System.out.println(<span class="string">"Hook execute!!!"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">D:\<span class="built_in">test</span>OOM&gt;java HookTest</div><div class="line">Hook execute!!!</div><div class="line"></div><div class="line">D:\<span class="built_in">test</span>OOM&gt;</div></pre></td></tr></table></figure></p>
<h2 id="不被触发"><a href="#不被触发" class="headerlink" title="不被触发"></a>不被触发</h2><p>再google上找到了一篇这样的文章<a href="https://dzone.com/articles/know-jvm-series-2-shutdown" target="_blank" rel="external">Know the JVM Series: Shutdown Hooks</a>里面介绍了钩子程序在什么情况下不会执行<br>尽管上面列举出了N多触发钩子程序的示例, 但是并不保证这个钩子程序总是能被触发执行的, 例如</p>
<ul>
<li>JVM内部发生错误, 可能还没有来得及触发钩子程序, JVM就挂掉了(JVM 发生内部错误, 有没有日志呢?)</li>
<li>还有上面我们给出的那个信号表, 如果操作系统发送出上面的信号的话, 同样的, JVM没有执行钩子程序就退出了</li>
<li>还有调用<code>Runime.halt()</code>函数也不会执行钩子程序</li>
</ul>
<p>还有一种情况是, 当操作系统向进程发送一个<code>SIGTERM</code>信号之后, 如果进程没有在指定的时间之内关闭, 那么操作系统会强制将该进程杀掉, 如此一来钩子程序也不会得到完整的执行(因为钩子程序可能执行到一半就被操作系统杀死了). 因此不管是这篇文章还是JDK API都推荐不要在钩子程序里写复杂的业务逻辑, 避免产生死锁或者产生长时间的IO操作, 尽可能快地让钩子程序执行完毕.</p>
<p>在oracle上的<a href="http://docs.oracle.com/javase/1.5.0/docs/guide/lang/hook-design.html" target="_blank" rel="external">Design of the Shutdown Hooks API</a>同样见到这样一句话,<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Will shutdown hooks be run <span class="keyword">if</span> the VM crashes?</div><div class="line">	If the VM crashes due to an error <span class="keyword">in</span> native code <span class="keyword">then</span> no guarantee can be made about whether or not the hooks will be run.</div></pre></td></tr></table></figure></p>
<p>哎,, 怎么着才能监控JVM挂掉的信息呢？</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/03/08/JavaSE/Java hook/#comments" class="ds-thread-count comments-count-link" data-thread-key="2015/03/08/JavaSE/Java hook/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/09/26/JavaSE/Java网络 BIO server/" title="java BIO服务器" itemprop="url">java BIO服务器</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-09-25T16:00:00.000Z" itemprop="datePublished"> 发表于 2014-09-26</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>一个Java阻塞服务器实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>(ServerSocket server =  <span class="keyword">new</span> ServerSocket(<span class="number">9090</span>)) &#123;</div><div class="line">	<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">		<span class="keyword">try</span>(<span class="keyword">final</span> Socket finalSocket = server.accept();) &#123;</div><div class="line">			Runnable runnable = () -&gt; &#123;</div><div class="line"></div><div class="line">				<span class="keyword">try</span>(BufferedReader in = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(finalSocket.getInputStream()));</div><div class="line">					PrintWriter out = <span class="keyword">new</span> PrintWriter(finalSocket.getOutputStream(), <span class="keyword">true</span>);) &#123;</div><div class="line"></div><div class="line">					String body = <span class="keyword">null</span>;</div><div class="line">					<span class="keyword">while</span> ((body = in.readLine()) != <span class="keyword">null</span>) &#123;</div><div class="line">						System.out.println(<span class="string">"Server Revice： "</span> + body);</div><div class="line">						out.println(<span class="string">"Server -&gt; client"</span>);</div><div class="line">					&#125;</div><div class="line"></div><div class="line">				&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">					e.printStackTrace();</div><div class="line">				&#125;</div><div class="line">			&#125;;</div><div class="line">			<span class="keyword">new</span> Thread(runnable).start();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>客户端测试代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>(Socket socket = <span class="keyword">new</span> Socket(<span class="string">"127.0.0.1"</span>, <span class="number">9090</span>);</div><div class="line">	BufferedReader in = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(</div><div class="line">			socket.getInputStream()));</div><div class="line">	PrintWriter out = <span class="keyword">new</span> PrintWriter(socket.getOutputStream(), <span class="keyword">true</span>);) &#123;</div><div class="line">	System.out.println(<span class="string">"Server Revice： "</span> + in.readLine());</div><div class="line">	out.println(<span class="string">"client -&gt; Server"</span>);</div><div class="line"></div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">	e.printStackTrace();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="socket-api"><a href="#socket-api" class="headerlink" title="socket api"></a>socket api</h2><ul>
<li><p><code>Socket(String, int, InetAddress, int)</code> 这个构造函数创建一个指向指定主机指定端口的TCP socket,并尝试连接远程socket.它连接到前俩个参数指定的主机上,从后俩个参数指定的本地网络接口和端口进行连接.本地网络接口<br>可以是物理的(如不同的以太网卡)或者虚拟的(一个多宿主主机).如果本地端口为0,会从1024-65535之间随机可用端口.之所以希望显示选择本地地址,这种情况可能出现在使用双以太网端口的路由器/防火墙上.入站连接会在一个接口接受,处理并通过另一个接口转发到本地网络.</p>
<blockquote>
<p><code>Socket(InetAddress, int, InetAddress, int)</code>作用与<code>Socket(String, int, InetAddress, int)</code>相同,只不过连接地址是通过InteAdderss进行连接</p>
</blockquote>
</li>
<li><p><code>Socket()</code> 如果要要派生<code>Socket</code>子类或者实现一种特殊的socket,从而能加密事务或者理解本地代理服务器,此时就要用到这个函数.新的socket类的大部分实现要在一个<code>SocketImpl</code>对象中编写.该构造函数安装默认的<code>SocketImpl</code>(来自工厂方法或者<code>PlainSocketImpl</code>).</p>
</li>
<li><code>Socket(String, int)</code> 这个构造函数创建一个指向指定主机指定端口的TCP socket,并尝试连接远程socket.</li>
<li><code>Socket(InetAddress, int)</code> 这个构造函数创建一个指向指定主机指定端口的TCP socket,并尝试连接远程socket.在很少的情况下,当你向相同的主机打开很多socket时,先将主机名转换为InetAddress,然后重复使用此InetAddress是更有效的.</li>
<li><code>connect(SocketAddress)</code> 我们一般使用INetSocketAddress</li>
<li><code>close()</code> 对于socket敏感的程序,在垃圾回收器介入之前,系统会很快达到所能打开socket的上限.关闭一个<code>Socket</code>之后,其<code>InetAddress</code>,端口号,本地地址,本地端口号仍然可以通过<code>getInetAddress(),getPort(),getLocalAddress(),getLocalPort()</code>方法访问.不过虽然扔可以调用<code>getInputStream</code>或<code>getOutputStream()</code>,但试图从<code>InputStream</code>读取数据或者<code>OutputStream</code>写入数据抛出一个<code>IOException</code>异常.</li>
<li><code>getInputStream()</code>返回一个输入流,可以将socket的数据读入程序</li>
<li><code>getPort()</code> 获取Socket连接(或过去连接或将要连接)远程主机的哪个端口返回一个原始的<code>OutputStream</code>,用于将应用程序的数据写入socket另一端.出于性能原因,将其缓冲也是个好主意.</li>
<li><code>getInetAddress()</code> socket连接哪台远程服务器,或者当连接已关闭时,告知它连接时所连接的是哪台主机</li>
<li><code>getLocalAddress()</code> 获取socket绑定于哪个网络接口,一般会在多宿主主机或有多个网络接口的主机使用此方法</li>
<li><code>shutdownInput()</code> 半关闭连接.关闭socket的输入流,实际上这并不会关闭socket,但是它会影响与之连接的流认为已经到了流的末尾.即使半关闭了连接,甚至关闭了俩次,仍需要在结束使用时关闭socket.该方法只影响输出流,他们不释放与socket关联的资源,如占用的端口.</li>
<li><code>isConnected()</code> 指向远端服务器.这个方法不能告诉你socket当前是否连接到远程主机,而是告知socket是否曾经连接过主机.如果socket能够连接到远程主机,则此主机返回为<code>true</code>,即使此时socket已被关闭.要判断socket当前是否打开,需要检查<code>isConnected()</code>返回<code>true</code>,并且<code>isClosed()</code>返回<code>false</code>.</li>
<li><code>isBound()</code> 指的是本地端,它告知socket是否绑定于本地系统的向外端口.</li>
<li><code>isClosed()</code> 在socket已经关闭时返回<code>true</code>,未关闭时返回<code>false</code>.但是如果socket从未连接过也降返回<code>false</code>.</li>
</ul>
<h2 id="ServerSocket-api"><a href="#ServerSocket-api" class="headerlink" title="ServerSocket api"></a>ServerSocket api</h2><p>socket实现进程通信(实质上提供了进程通信的端点). 每一个socket用一个半相关描述:(协议，本地地址，本地端口). 一个完整的socket有一个本地唯一的socket号，由操作系统分配。于一个网络连接来说，套接字是平等的，并没有差别，不因为在服务器端或在客户端而产生不同级别.</p>
<ul>
<li><p>new ServerSocket(port); 在当前主机的所有网络接口或者所有IP地址的指定port上进行入站监听,如果port为0系统会随意指定一个端口</p>
</li>
<li><p>new ServerSocket(port, queueLenght) 在当前主机的所有网络接口或者所以IP地址的该指定port上进行入站监听.如果port为0系统会随意指定一个端口,queueLenght设置入栈请求的队列长度(如果队列超过最大值,会使用系统最大值). 第二个参数为backlog参数,accept()方法，该方法从队列中取出连接请求，使得队列能够及时的腾出空间，以容纳新的连接请求。 即ServerSocket构造函数中的backlog参数时，是可以serverSocket在不调用accept方法取出连接时，能接受的最大连接数</p>
</li>
<li><p>new ServerSocket(port, queueLenght, address); 在当前主机的指定的IP地址的指定port上进行入站监听(适用于多IP地址系统上运行的服务器)如果port为0系统会随意指定一个端口queueLenght设置入栈请求的队列长度(如果队列超过最大值,会使用系统最大值)</p>
</li>
<li><p>connect.close() 关闭ServerSocket ：释放本地主机的绑定端口,允许其他程序继续使用释放掉的端口。终端ServerSocket接受的目前处于打开状态的所以Socket 关闭Socket .尽管在程序结束时ServerSocket会自动关闭但是尽量还是在程序中保证,当ServerSocket结束时将其手动关闭</p>
</li>
<li><p><code>!connect.isClosed() &amp;&amp; connect.isBound()</code> 检查ServerSocket是否打开.当关闭后isClosed会返回true, isBound指的是是否曾经绑定过端口,但是并不指现在的状态</p>
</li>
<li><p>setRcvBuf 这相当于调用accept()返回的socket的socket.setReceiveBufferSize(size);可以在绑定服务器socket之前或之后设置此选项 除非要设置大于64K的缓冲区大小,这时对于未绑定的ServerSocket必须在绑定他之前设置这个选项</p>
</li>
</ul>
<h2 id="TCP参数"><a href="#TCP参数" class="headerlink" title="TCP参数"></a>TCP参数</h2><ul>
<li><code>setTcpNoDelay(boolean)</code>设置<code>TCP_NODELAY</code>为<code>true</code>,可确保包会尽快地发送,而无论包的大小.正常情况下,小的包(1byte)在发送前会组合为大点的包.在发送另一个包之前,本地主机要等待远程系统对前一个包的响应,这称为<code>Nagle</code>算法.<code>Nagle</code>算法的问题是,如果远程系统没有尽可能快地将回应发送回本地系统,那么依赖于小数据量信息稳定传输的应用程序会变得很慢.为true关闭socket缓冲,为false再次打开socket缓冲.</li>
<li><code>setSoLinger(boolean, int)</code>该设置规定了当socket关闭时如何处理尚未发送的数据报.如果socket关闭(close方法)系统仍会将剩余的数据发送出去.如果延迟时间为0,那所有未发送的数据都会被丢弃.如果延迟时间为任意正数,close方法会被堵塞指定秒数,等待数据发送和接受回应,该段时间过去后socket被关闭,将会关闭输出输入流,既不会接收到数据也不会在发送数据.</li>
<li><code>setOOBInline(boolean)</code> 用于发送紧急数据</li>
<li><code>setSoTimeout(int)</code> 当socket尝试读取数据时,<code>read</code>方法会阻塞尽可能长的时间来得到足够的字节.该选项就是确保此次调用阻塞的时间不会大于某个固定的毫秒数,如果阻塞时间长于固定毫秒数就会抛出<code>InterruptedIoException</code>.尽管抛出了该异常但是socket仍然是连接的.此次read失败,但是仍然可以尝试再次读取该socket. 该选项是在accept抛出java.ioInterruptedIOException前等待入栈连接的时间,以毫秒计</li>
<li><code>setSendBufferSize(int)</code> 设置socket网络输出的缓冲区字节数</li>
<li><code>setReceiveBufferSize(int)</code> 设置socket网络输入的缓冲区的字节数.大多数TCP栈使用缓冲区提升网络性能,较大的缓冲区会提升快速连接(比如10M或更快)的网络性能,而较慢的拨号连接在较小的缓冲区下表现更加.一般来讲,传输大的连续的数据块(在FTP和HTTP很常见),这可以从大缓冲区收益;而大缓冲区对交互式会话如<code>telnet</code>和许多游戏则没有多大帮助.</li>
<li><code>setKeepAlive(boolean)</code> 启用<code>SO_KEEPALIVE</code>客户端会偶尔(一般俩个小时)利用一个空闲连接发送一个数据包,确保服务器没有崩溃.如果服务器没有响应,客户端会在11分钟之内持续发送此包,直到接受到服务器的回馈或者到12分钟左右直接将客户端关闭.</li>
<li><code>setReuseAddress(boolean)</code> 设置主机地址可重用. 指定如果仍有旧的数据在网络上传输,新的程序是否可以绑定到该端口</li>
<li><code>getReuseAddress()</code> socket关闭时,可能不会立即释放本地地址,一般会等待一段时间,确保所有寻址到待端口在网络上传输的数据接受到.关闭后一般接收到的数据报不会再进行任何处理,这么做是为了当有新的进程关联到该端口的时候不会接受到莫名其妙的数据.要想使用这个设置必须将老的socket如下设置</li>
</ul>
<p><a href="http://www.open-open.com/lib/view/open1412994697952.html#articleHeader3" target="_blank" rel="external">几个重要的TCP/IP选项解析(Java Socket)</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/09/26/JavaSE/Java网络 BIO server/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/09/26/JavaSE/Java网络 BIO server/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/09/25/JavaSE/Java网络 代理/" title="java代理" itemprop="url">java代理</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-09-24T16:00:00.000Z" itemprop="datePublished"> 发表于 2014-09-25</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>通过系统属性来指出本地代理服务器地址。 采用的参数有<code>http.proxyHost,http.proxyPort,http.nonProxyHost</code>以及三个相同的ftp协议开头的代理参数。 java不支持其他任何应用层协议,但如果对所有TCP连接都使用socks代理则可以使用<code>socksProxyHost</code>和<code>socksProxyPort</code>系统属性来确定<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 设置代理服务器的ip地址</span></div><div class="line">System.setProperty(<span class="string">"http.proxyHost"</span>, <span class="string">"192.168.254.254"</span>);</div><div class="line"><span class="comment">// 设置代理服务器的端口</span></div><div class="line">System.setProperty(<span class="string">"http.proxyPort"</span>, <span class="string">"9000"</span>);</div><div class="line"><span class="comment">// 设置java.oreilly.com和xml.oreilly.com主机不被代理而是直接连接</span></div><div class="line">System.setProperty(<span class="string">"http.nonProxyHost"</span>, <span class="string">"java.oreilly.com|xml.oreilly.com"</span>);</div><div class="line"></div><div class="line">SocketAddress add = <span class="keyword">new</span> InetSocketAddress(<span class="string">"proxy.example.com"</span>, <span class="number">80</span>);</div><div class="line">Proxy proxy = <span class="keyword">new</span> Proxy(Proxy.Type.HTTP, add);</div></pre></td></tr></table></figure></p>
<p>虚拟机都有一个为不同连接定位代理服务器的<code>ProxySelector</code> 对象. 默认的<code>ProxySelector</code>只检查各种系统属性和URL协议,决定如何连接到不同的主机.</p>
<p>下面<code>LocalProxySelect</code>是一个自己实现的选择器<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLocalProxySelect</span><span class="params">()</span> </span>&#123;</div><div class="line">	ProxySelector select = <span class="keyword">new</span> LocalProxySelect();</div><div class="line">	<span class="comment">// 每个虚拟机只运行着一个ProxySelector对象.setDefault之后所以的连接都会询问这个代理</span></div><div class="line">	<span class="comment">// 因此不能在公共的环境下改变代理连接.  那ProxySelector要如何使用</span></div><div class="line">	ProxySelector.setDefault(select);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalProxySelect</span> <span class="keyword">extends</span> <span class="title">ProxySelector</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> List&lt;Object&gt; failed = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> List&lt;Proxy&gt; <span class="title">select</span><span class="params">(URI uri)</span> </span>&#123;</div><div class="line">		<span class="comment">// uri 连接所需的主机</span></div><div class="line"></div><div class="line">		List&lt;Proxy&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">		<span class="keyword">if</span>(failed.contains(uri) || <span class="string">"http"</span>.equalsIgnoreCase(uri.getScheme())) &#123;</div><div class="line">			result.add(Proxy.NO_PROXY);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// 所有的连接都会使用proxy.example.com 进行代理</span></div><div class="line">			SocketAddress address = <span class="keyword">new</span> InetSocketAddress(<span class="string">"proxy.example.com"</span>, <span class="number">8000</span>);</div><div class="line">			Proxy proxy = <span class="keyword">new</span> Proxy(Proxy.Type.HTTP, address);</div><div class="line">			result.add(proxy);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> result;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connectFailed</span><span class="params">(URI uri, SocketAddress sa, IOException ioe)</span> </span>&#123;</div><div class="line">		failed.add(uri);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下面实现一个socket代理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Socket socket = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">	SocketAddress proxyAddress = <span class="keyword">new</span> InetSocketAddress(<span class="string">"myproxy.example.com"</span>, <span class="number">1080</span>);</div><div class="line">	Proxy  proxy = <span class="keyword">new</span> Proxy(Proxy.Type.SOCKS, proxyAddress);</div><div class="line">	socket = <span class="keyword">new</span> Socket(proxy);</div><div class="line">	SocketAddress remote = <span class="keyword">new</span> InetSocketAddress(<span class="string">"login.ibiblio.org"</span>, <span class="number">25</span>);</div><div class="line">	socket.connect(remote);</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">	e.printStackTrace();</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">	<span class="keyword">if</span>(socket != <span class="keyword">null</span>)</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			socket.close();</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/09/25/JavaSE/Java网络 代理/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/09/25/JavaSE/Java网络 代理/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/09/21/JavaSE/Java网络 URL/" title="Java URL" itemprop="url">Java URL</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-09-20T16:00:00.000Z" itemprop="datePublished"> 发表于 2014-09-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="URI"><a href="#URI" class="headerlink" title="URI"></a>URI</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scheme:scheme-specific-part (模式:模式特有部分)</div></pre></td></tr></table></figure>
<p>URI模式包含 data, file, ftp, http, news, telnet, urn (还有基于JAVA的rmi, jndi 等非标准模式,也称为protocol)<br>例如：<code>http://www.yu66.wang/2015/10/13/%E5%B7%A5%E5%85%B7/2015-10-12-AWK/</code>这个例子中模式为<code>http</code>, 负责解析该URI的机构<code>yu66.wang</code> 负责将<code>/2015/10/13/%E5%B7%A5%E5%85%B7/2015-10-12-AWK/</code>地址映射到主机资源</p>
<p>还有的URI路径中含有? 这是URI的查询部分.后面紧跟查询参数,多个参数用&amp;分割. 例如：<code>git@github.com:yu66/VertxServer.git</code>该URI中模式为<code>git</code> 解析结构为<code>github.com</code> 还可以在git和@之间加上用户名和密码<code>git://username:password@github.com:yu66/VertxServer.git</code></p>
<p>URI一般由以下组成</p>
<ul>
<li>模式</li>
<li>URI解析结构</li>
<li>资源路径</li>
<li>查询参数构成</li>
</ul>
<ol>
<li>URL ： 指向Internet上某个位置的某个文件.用于标识Internet上的资源位置. 指定访问服务器的协议, 服务器名, 文件在次服务器上的位置<code>protocol://username@hostname:port/path/filename?query##fragment</code>协议可以看成是模式但是它不包含URN.</li>
<li>URN ：不指向位置的资源名.  (具体的内容参考例子磁力链接)<code>urn:namespace:resource_name</code>. <code>namespace</code>:某个授权机构维护的某类资源的集合名.  <code>resource_name</code> 集合中的资源名</li>
</ol>
<p>这里简述一下相对URL. 举例来说<code>&lt;a href=&quot;java.html&quot;&gt;</code> 这个超链接会继承父文档(当前文档)的协议, 主机名, 资源路径<code>.java.html</code>会替换掉,父文档里最后的文件名,还有例如<code>&lt;a href=&quot;/demo/java.html&quot;&gt;</code>那这个超链接会将主机名后的资源路径一起换掉 ，用该路径替换</p>
<p>Java支持的传输协议：</p>
<ul>
<li>超文本传输协议: <code>http://www.baidu.com</code>        </li>
<li>安全http协议: <code>https://www.amazon.com/exec/obidos/order2</code></li>
<li>文件传输协议: <code>ftp://metalab.unc.edu/pub/languages/java/javafaq</code></li>
<li>简单邮件传输协议: <code>mailto:elharo@metalab.unc.edu</code></li>
<li>telnet协议: <code>telnet://dibner.poly.edu</code></li>
<li>本地文件访问协议: <code>file:</code></li>
<li>gopher: <code>gopher://gopher.anc.org.za</code></li>
<li>轻量级目录访问协议: <code>ldap://ldap.itd.umich.edu</code></li>
<li>jar: <code>jar://</code></li>
<li>NFS,网络文件协议: <code>nfs://utopia.poly.edu/usr/tmp</code></li>
<li>JDBC 定制协议   通过java.sql包支持: <code>jdbc:mysql://luna.matalab.unc.edu:3306/NEWS</code></li>
<li>rmi  远程方法的调用协议   通过java.rmi包支持: <code>rmi://metalab.unc.edu/RenderEngine</code></li>
<li>HotJava的定制协议: <code>doc:/UserGuide/release.html</code>,<code>netdoc:/UserGuide/release.html</code>, <code>systemresource://www.adc.org/+/index.html</code>, <code>verbatim:http://www.adc.org</code></li>
</ul>
<h2 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h2><p>URL使用的字符必须来自ASCII的子集(大写字母<code>A-Z</code>,小写字母<code>a-z</code>,数字<code>0-9</code>, 标点字符 <code>- _ . ! ~ * &#39; ,</code>) 需要注意的是<code>/ &amp; ? @ # ; $ + = %</code> 也可以使用,但是必须转换为字节(每个字节为%后跟俩个16进制数字)(空格编码为+) 所以URL组成的内容是ASCII的子集 + 经过转换后的字节 但是URL不会自动地进行编码和解码因此我们需要URLEncoder来进行编码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 解码由x-www-form-url-encoded格式编码的字符串</span></div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSpace</span><span class="params">()</span> </span>&#123;</div><div class="line">		String base64 = <span class="string">"wKOS4FsxiFvE48KGGSuSkRui9Iap1ukgl1+eVqZiGhXQYYiP8KGCV%2FRIeTEyMLsWxE%2FEx6jhuW3DPUt4JYX+cohUOqFVVaQ%2FioGZCAge3ygaCz%2Fe4q8o9XQzOEtcdXPywGZ0e5sgE787ij4dRZy2ILK2cxsVvC8yrlIPGZ3LUg8nOj8oEg5l2AnQnA3i+Sxbgqmwe1OjIXVZqPZWb+Y4SVQL8EpWlmEjXb4HjgmGTgVYzwJ64QO7HUPP1yuQHkS0PLS%2FpbPrgL5vqTF7h%2FPvMw=%3D"</span>;</div><div class="line">		String decoded = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			decoded = URLDecoder.decode(base64);</div><div class="line">		&#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">			<span class="comment">// 如果url包含一个%而后却没有2个16进制数字 抛出该异常</span></div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		System.out.println(decoded);</div><div class="line">		<span class="keyword">byte</span>[] decode = UrlBase64.decode(base64);</div><div class="line">		System.out.println(<span class="keyword">new</span> String(decode));</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>需要注意额是= 和 &amp; URLEncoder会进行盲目地编码 因此在使用URLEncoder编码时避免将整个url字串都编码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">print(<span class="string">"  : "</span> + URLEncoder.encode(<span class="string">" "</span>, <span class="string">"UTF-8"</span>));</div><div class="line">print(<span class="string">"= : "</span> + URLEncoder.encode(<span class="string">"="</span>, <span class="string">"UTF-8"</span>));</div><div class="line">print(<span class="string">"&amp; : "</span> + URLEncoder.encode(<span class="string">"&amp;"</span>, <span class="string">"UTF-8"</span>));</div><div class="line">print(<span class="string">"* : "</span> + URLEncoder.encode(<span class="string">"*"</span>, <span class="string">"UTF-8"</span>));</div><div class="line">print(<span class="string">"% : "</span> + URLEncoder.encode(<span class="string">"%"</span>, <span class="string">"UTF-8"</span>));</div><div class="line">print(<span class="string">"+ : "</span> + URLEncoder.encode(<span class="string">"+"</span>, <span class="string">"UTF-8"</span>));</div><div class="line">print(<span class="string">"/ : "</span> + URLEncoder.encode(<span class="string">"/"</span>, <span class="string">"UTF-8"</span>));</div><div class="line">print(<span class="string">". : "</span> + URLEncoder.encode(<span class="string">"."</span>, <span class="string">"UTF-8"</span>));</div><div class="line">print(<span class="string">": : "</span> + URLEncoder.encode(<span class="string">":"</span>, <span class="string">"UTF-8"</span>));</div><div class="line">print(<span class="string">"~ : "</span> + URLEncoder.encode(<span class="string">"~"</span>, <span class="string">"UTF-8"</span>));</div><div class="line">print(<span class="string">"\" : "</span> + URLEncoder.encode(<span class="string">"\""</span>, <span class="string">"UTF-8"</span>));</div><div class="line">print(<span class="string">"() : "</span> + URLEncoder.encode(<span class="string">"(url)"</span>, <span class="string">"UTF-8"</span>));</div></pre></td></tr></table></figure></p>
<p>不带端口构造<code>URL</code>(需要注意的是：该构造器生成的URL端口为-1,所以回使用该协议的默认端口   第三个参数加反斜线也是需要注意的)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">URL url = <span class="keyword">new</span> URL(<span class="string">"http"</span> , <span class="string">"www.eff.org"</span>, <span class="string">"/blueribbon.html#intro"</span>);</div></pre></td></tr></table></figure></p>
<p>带端口构造<code>URL</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">URL url = <span class="keyword">new</span> URL(<span class="string">"http"</span> , <span class="string">"www.eff.org"</span>, <span class="number">8080</span>, <span class="string">"/blueribbon.html#intro"</span>);</div></pre></td></tr></table></figure></p>
<p>根据相对URL和基础URL构建一个绝对URL,当希望迭代处理位于相同目录下的一组文件时, 可以考虑使用该构造器<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">URL url = <span class="keyword">new</span> URL(<span class="string">"http://ibiblio.org/javafaq/index.html"</span>);</div><div class="line">URL newURL = <span class="keyword">new</span> URL(url, <span class="string">"mailinglists.html"</span>);</div><div class="line">Assert.assertEquals(<span class="string">"http://ibiblio.org/javafaq/mailinglists.html"</span>, newURL.toString());</div></pre></td></tr></table></figure></p>
<p>利用ClassLoader可以加载资源,例如图片 音频等<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">URL url = ClassLoader.getSystemResource(<span class="string">"resource/simple.txt"</span>);</div><div class="line">Assert.assertEquals(<span class="keyword">null</span>, url);</div></pre></td></tr></table></figure></p>
<p>利用ClassLoader可以加载资源,例如图片 音频等<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">URL url = getClass().getResource(<span class="string">"resource/simple.txt"</span>);</div><div class="line">Assert.assertEquals(<span class="keyword">null</span>, url);</div></pre></td></tr></table></figure></p>
<p>查看URL中的模式<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">URL url = <span class="keyword">new</span> URL(<span class="string">"http://ibiblio.org/javafaq/index.html"</span>);</div><div class="line">Assert.assertEquals(<span class="string">"http"</span>, url.getProtocol());</div><div class="line">URL url = <span class="keyword">new</span> URL(<span class="string">"http://www.ibiblio.org/javafaq/index.html"</span>);</div><div class="line">Assert.assertEquals(<span class="string">"www.ibiblio.org"</span>, url.getHost());</div></pre></td></tr></table></figure></p>
<p>查看URL中的路径 (范围：主机名后面的第一个/ 到片段标示符# 之前) 包含查询字符串<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">URL url = <span class="keyword">new</span> URL(<span class="string">"http://ibiblio.org/nywc/compositions.pthml?category=Piano"</span>);</div><div class="line">Assert.assertEquals(<span class="string">"/nywc/compositions.pthml?category=Piano"</span>, url.getFile());</div></pre></td></tr></table></figure></p>
<p>查看URL中的路径 (范围：主机名后面的第一个/ 到片段标示符# 之前)  不包含查询字符串<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">URL url = <span class="keyword">new</span> URL(<span class="string">"http://ibiblio.org/nywc/compositions.pthml?category=Piano"</span>);</div><div class="line">Assert.assertEquals(<span class="string">"/nywc/compositions.pthml"</span>, url.getPath());</div></pre></td></tr></table></figure></p>
<p>查看URL中的查询字符串<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">URL url = <span class="keyword">new</span> URL(<span class="string">"http://ibiblio.org/nywc/compositions.pthml?category=Piano"</span>);</div><div class="line">Assert.assertEquals(<span class="string">"category=Piano"</span>, url.getQuery());</div></pre></td></tr></table></figure></p>
<p>查看URL中的查询字符串<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">URL url = <span class="keyword">new</span> URL(<span class="string">"ftp://mp3:secret@ftp.example.com/c%3a/stuff/mp3"</span>);</div><div class="line">Assert.assertEquals(<span class="string">"mp3:secret"</span>, url.getUserInfo());</div></pre></td></tr></table></figure></p>
<p>查看URL中的Authority(授权机构,包含用户信息,主机和端口.一般都回返回主机信息,但是不一定包含用户信息和端口)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">URL url = <span class="keyword">new</span> URL(<span class="string">"ftp://mp3:secret@ftp.example.com/c%3a/stuff/mp3"</span>);</div><div class="line">Assert.assertEquals(<span class="string">"mp3:secret@ftp.example.com"</span>, url.getAuthority());</div></pre></td></tr></table></figure></p>
<p>sameFile 只是简单的测试url中的主机名是否是别名, 需要更细致的测试, sameFile 与 equals的区别是sameFile不考虑标示符儿equals需要考虑标示符<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">URL u1 = <span class="keyword">new</span> URL(<span class="string">"http://www.ncsa.uiuc.edu/HTMLPrimer.html#GS"</span>);</div><div class="line">URL u2 = <span class="keyword">new</span> URL(<span class="string">"http://www.ncsa.uiuc.edu/HTMLPrimer.html#HD"</span>);</div><div class="line"><span class="keyword">if</span>(u1.sameFile(u2))</div><div class="line">	System.out.println(u1 + <span class="string">" is same file with "</span> + u2);</div><div class="line"><span class="keyword">else</span></div><div class="line">	System.out.println(u1 + <span class="string">" is not same file with "</span> + u2);</div></pre></td></tr></table></figure></p>
<p>连接URl所指向的资源.执行客户端和服务器之间任何必要的握手.返回一个可以读取数据的<code>InputStream</code>,该流读取文件里的原始内容,不包括任何HTTP首部或者任何与协议有关的信息<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>(InputStream in = <span class="keyword">new</span> URL(<span class="string">"http://www.baidu.com"</span>).openStream()) &#123;</div><div class="line">	<span class="keyword">int</span> c = <span class="number">0</span>;</div><div class="line">	<span class="keyword">while</span>((c = in.read()) != -<span class="number">1</span>) &#123;</div><div class="line">	<span class="keyword">if</span>(c == <span class="string">'&lt;'</span>) System.out.println();</div><div class="line">		System.out.write(c);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>openConnection</code>打开指定URL的socket,返回URLConnection对象(一个打开网络资源的连接)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">URLConnection conn = <span class="keyword">new</span> URL(<span class="string">"http://www.baidu.com"</span>).openConnection();</div><div class="line"><span class="keyword">try</span>(InputStream in = conn.getInputStream()) &#123;</div><div class="line">	<span class="keyword">int</span> c = <span class="number">0</span>;</div><div class="line">	<span class="keyword">while</span>((c = in.read()) != -<span class="number">1</span>) &#123;</div><div class="line">		System.out.write(c);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/09/21/JavaSE/Java网络 URL/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/09/21/JavaSE/Java网络 URL/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/09/20/JavaSE/Java网络/" title="Java 网络接口" itemprop="url">Java 网络接口</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-09-19T16:00:00.000Z" itemprop="datePublished"> 发表于 2014-09-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>Java里使用的是TCP/IP</p>
<ul>
<li>应用层协议：(例如Http协议) 该层数据由下三层协议共同制定</li>
<li>传输层协议：(常用TCP,UDP)(ICMP Ping命令基于该协议). 该层协议用于确保数据报以发送时的顺序接受,并且不会丢包. 如果发现顺序有误,或者数据丢失,则可要求对方重新发送数据(TCP会要求这一点, 但是UDP协议只是检查数据发送顺序,以及数据是否丢失并不要求对方重传数据)</li>
<li>网络层协议：(使用最广泛的是IP协议)<blockquote>
<p>网络层第一任务是对数据位或者字节进行分组,打成包(包内数据称为数据报).网络层第二任务定义了主机彼此间的寻址方式(例如IPV4用四个字节来标识一个地址).在JAVA里,IP协议是它唯一理解的网络层协议.</p>
</blockquote>
</li>
</ul>
<p>IP数据报格式<br>链路层协议：定义了网络接口(以太网接口或者环牌接口)</p>
<p>谈一下Internet地址分类 (具体定义参考 WIKI IP地址), IP地址分为A,B,C,D,E,F类 (E,F分别作为广播地址这里不说了)</p>
<ul>
<li>A类地址 第一个字节固定</li>
<li>B类地址 前俩个地址固定</li>
<li>C类地址 前三个地址固定<br>这里所说的固定指的是ISP给你的时候就固定了,你只能使用固定之后几位的地址.例如给了你一个C类地址 那么你只有256个地址可以使用.</li>
</ul>
<p>后来为了节约地址,出现了CIDR  用/nn 指定前几位为固定的.例如/24 为前24位即前三个字节是固定的也就是一个c类地址.这么着就拟补了有的组织使用的IP大于c类却远远小于B类而造成的地址浪费.</p>
<p>在这里需要特殊说明的是有一些非路由地址,例如10; 192.16或者172.16到172.31 开头的地址.这些地址用于构建组织内部网路(例如家里只有一个IP但是却有很多设备,这时就需要通过路由为这些设备分配IP地址了),或者一些大型组织使用C类地址时非常有用<br>路由器会将非路由地址转换为外部地址</p>
<h2 id="网络接口"><a href="#网络接口" class="headerlink" title="网络接口"></a>网络接口</h2><p>网络接口的命名</p>
<ul>
<li>eth0: ethernet的简写，一般用于以太网接口。</li>
<li>wifi0:wifi是无线局域网，因此wifi0一般指无线网络接口。</li>
<li>ath0: Atheros的简写，一般指Atheros芯片所包含的无线网络接口。</li>
<li>lo: local的简写，一般指本地环回接口。</li>
</ul>
<p>lo:虚拟网络接口,其并不真实地从外界接收和发送数据包，而是在系统内部接收和发送数据包，因此虚拟网络接口不需要驱动程序硬件网卡的网络接口由驱动程序创建。而虚拟的网络接口由系统创建或通过应用层程序创建。<br>假如包是由一个本地进程为另一个本地进程产生的, 它们将通过外出链的’lo’接口,然后返回进入链的’lo’接口</p>
<p>Java网络接口相关主要用到<code>java.net.NetworkInterface</code>这个类，其表示一个本地IP地址,该类可以是一个物理接口或者绑定于同一个物理接口的虚拟接口.</p>
<p>获取某个名的网络接口对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NetworkInterface net = NetworkInterface.getByName(<span class="string">"eth0"</span>);</div></pre></td></tr></table></figure></p>
<p>获取一个绑定于制定ip地址的网络接口对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getLocalHost();</div><div class="line">NetworkInterface net = NetworkInterface.getByInetAddress(address);</div></pre></td></tr></table></figure></p>
<p>列出本机所有的网络接口  包括物理或者虚拟网络接口<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Enumeration&lt;NetworkInterface&gt; nets = NetworkInterface.getNetworkInterfaces();</div><div class="line"><span class="keyword">while</span>(nets.hasMoreElements()) &#123;</div><div class="line"> System.out.println(<span class="string">"网络接口 ： "</span> + nets.nextElement());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>列出本机所有绑定到该网络接口上的ip地址<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">NetworkInterface net = NetworkInterface.getByName(<span class="string">"eth0"</span>);</div><div class="line"> Enumeration&lt;InetAddress&gt; address = net.getInetAddresses();</div><div class="line"></div><div class="line"> <span class="keyword">while</span>(address.hasMoreElements()) &#123;</div><div class="line">	 System.out.println(<span class="string">"IP 地址 ： "</span> + address.nextElement());</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.net.Inet4Address;</div><div class="line"><span class="keyword">import</span> java.net.InetAddress;</div><div class="line"><span class="keyword">import</span> java.net.NetworkInterface;</div><div class="line"><span class="keyword">import</span> java.util.Enumeration;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrintNet</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 获取全部的网络接口(由操作系统设置,每个硬件网卡(一个MAC)对应一个网络接口)</span></div><div class="line">		Enumeration&lt;?&gt; nets = NetworkInterface.getNetworkInterfaces();</div><div class="line">		<span class="keyword">while</span> (nets.hasMoreElements()) &#123;</div><div class="line">			NetworkInterface net = (NetworkInterface) nets.nextElement();</div><div class="line">			printNetworkInterface(net);</div><div class="line">			Enumeration&lt;?&gt; addresses = net.getInetAddresses();  <span class="comment">// 返回该接口中所有绑定的ip</span></div><div class="line">			System.out.println(<span class="string">"该接口下所有的ip:"</span>);</div><div class="line">			<span class="keyword">while</span> (addresses.hasMoreElements()) &#123;</div><div class="line">				InetAddress ip = (InetAddress) addresses.nextElement();</div><div class="line">                pickUpHosyAddress(ip);</div><div class="line">				printInetAddress(ip);</div><div class="line">			&#125;</div><div class="line">			System.out.println();</div><div class="line">			System.out.println();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printNetworkInterface</span><span class="params">(NetworkInterface net)</span> <span class="keyword">throws</span> Exception</span>&#123;</div><div class="line">		System.out.println(<span class="string">"网络接口的显示名称   :"</span> + net.getDisplayName());</div><div class="line">		System.out.println(<span class="string">"网络接口的名称       :"</span> + net.getName());</div><div class="line">		System.out.println(<span class="string">"idx                	:"</span> + net.getIndex());</div><div class="line">		System.out.println(<span class="string">"最大传输单元         :"</span> + net.getMTU());</div><div class="line">		System.out.println(<span class="string">"mac地址              :"</span> + displayMac(net.getHardwareAddress()));</div><div class="line">		System.out.println(<span class="string">"是否是回送接口       :"</span> + net.isLoopback());</div><div class="line">		System.out.println(<span class="string">"是否是点对点接口     :"</span> + net.isPointToPoint());</div><div class="line">		System.out.println(<span class="string">"是否已经开启并运行   :"</span> + net.isUp());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 输出ip地址</div><div class="line">	 * <span class="doctag">@param</span> ip</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pickUpHosyAddress</span><span class="params">(InetAddress ip)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (!ip.isLoopbackAddress() &amp;&amp; !ip.isSiteLocalAddress() &amp;&amp; ip.getHostAddress().indexOf(<span class="string">":"</span>) == -<span class="number">1</span>) &#123;</div><div class="line">			System.out.println(<span class="string">"外网 HostAddress   :"</span> + ip.getHostAddress());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (ip.isLoopbackAddress() &amp;&amp; !ip.isSiteLocalAddress() &amp;&amp; ip.getHostAddress().indexOf(<span class="string">":"</span>) == -<span class="number">1</span>) &#123;</div><div class="line">			System.out.println(<span class="string">"内网 HostAddress   :"</span> + ip.getHostAddress());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (ip != <span class="keyword">null</span> &amp;&amp; !ip.isLoopbackAddress() &amp;&amp; ip <span class="keyword">instanceof</span> Inet4Address) &#123;</div><div class="line">			System.out.println(<span class="string">"HostAddress        :"</span> + ip.getHostAddress());</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 打印InetAddress 相关信息</div><div class="line">	 * <span class="doctag">@param</span> ip</div><div class="line">	 * <span class="doctag">@throws</span> Exception</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printInetAddress</span><span class="params">(InetAddress ip)</span> <span class="keyword">throws</span> Exception</span>&#123;</div><div class="line">		System.out.println(<span class="string">"远程主机的主机名         :"</span> + ip.getCanonicalHostName());</div><div class="line">		System.out.println(<span class="string">"主机地址                 :"</span> + ip.getHostAddress());</div><div class="line">		System.out.println(<span class="string">"远程主机的别名           :"</span> + ip.getHostName());</div><div class="line">		System.out.println(<span class="string">"mac Address             :"</span> + displayMac(ip.getAddress()));</div><div class="line">		System.out.println(<span class="string">"本机主机名               :"</span> + ip.getLocalHost().getHostName());</div><div class="line">		System.out.println(<span class="string">"回环地址 主机名          :"</span> + ip.getLoopbackAddress().getHostName());</div><div class="line">		<span class="comment">// (127.0.0.0 ~ 127.255.255.255)</span></div><div class="line">		System.out.println(<span class="string">"是否是本机的IP地址       :"</span> + ip.isLoopbackAddress());</div><div class="line">		<span class="comment">//(10.0.0.0 ~ 10.255.255.255)(172.16.0.0 ~ 172.31.255.255)(192.168.0.0 ~ 192.168.255.255)</span></div><div class="line">		System.out.println(<span class="string">"是否是地区本地地址       :"</span> + ip.isSiteLocalAddress());</div><div class="line">		<span class="comment">// 允许服务器主机接受来自任何网络接口的客户端连接</span></div><div class="line">		System.out.println(<span class="string">"是否是通配符地址         :"</span> + ip.isAnyLocalAddress());</div><div class="line">		<span class="comment">// (169.254.0.0 ~ 169.254.255.255)</span></div><div class="line">		System.out.println(<span class="string">"是否是本地连接地址       :"</span> + ip.isLinkLocalAddress());</div><div class="line">		<span class="comment">// (224.0.0.0 ~ 239.255.255.255)广播地址可以向网络中的所有计算机发送信息</span></div><div class="line">		System.out.println(<span class="string">"是否是 广播地址           :"</span> + ip.isMulticastAddress());</div><div class="line">		<span class="comment">//  除了(224.0.0.0)和第一个字节是239的IP地址都是全球范围的广播地址</span></div><div class="line">		System.out.println(<span class="string">"是否是全球范围的广播地址:"</span> + ip.isMCGlobal());</div><div class="line">		<span class="comment">// (224.0.0.0 ~ 224.0.0.255)</span></div><div class="line">		System.out.println(<span class="string">"是否是子网广播地址         :"</span> + ip.isMCLinkLocal());</div><div class="line">		<span class="comment">// 本地接口广播地址不能将广播信息发送到产生广播信息的网络接口</span></div><div class="line">		<span class="comment">// 所有的IPv4广播地址都不是本地接口广播地址。</span></div><div class="line">		System.out.println(<span class="string">"是否是本地接口广播地址      :"</span> + ip.isMCNodeLocal());</div><div class="line">		<span class="comment">// 可以向公司或企业内部的所有的计算机发送广播信息</span></div><div class="line">		<span class="comment">// IPv4的组织范围广播地址的第一个字节是239，第二个字节不小于192，第三个字节不大于195</span></div><div class="line">		System.out.println(<span class="string">"是否是组织范围的广播地址:"</span> + ip.isMCOrgLocal());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">displayMac</span><span class="params">(<span class="keyword">byte</span>[] mac)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (mac == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">		&#125;</div><div class="line">		StringBuilder bufferBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mac.length; i++) &#123;</div><div class="line">			<span class="keyword">byte</span> b = mac[i];</div><div class="line">			<span class="keyword">int</span> intValue = <span class="number">0</span>;</div><div class="line">			<span class="keyword">if</span> (b &gt;= <span class="number">0</span>)</div><div class="line">				intValue = b;</div><div class="line">			<span class="keyword">else</span></div><div class="line">				intValue = <span class="number">256</span> + b;</div><div class="line">			bufferBuilder.append(Integer.toHexString(intValue));</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (i != mac.length - <span class="number">1</span>)</div><div class="line">				bufferBuilder.append(<span class="string">"-"</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> bufferBuilder.toString();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>InetAddress 是对IP的高级表示。</p>
<p>InetAddress 相关API使用</p>
<p>InetAddress将equals方法重写,如果俩个InetAddress对象的ip地址相同则判断这俩个对象相等.但是并不判断主机名是否相等<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InetAddress i1 = InetAddress.getByName(<span class="string">"www.ibiblio.org"</span>);</div><div class="line">InetAddress i2 = InetAddress.getByName(<span class="string">"helios.metalab.unc.edu"</span>);</div></pre></td></tr></table></figure></p>
<p>InetAddress将hashCode方法重写,只对ip地址进行hashCode计算.如果俩个InetAddress对象的ip地址相同则判断这俩个对象的hashCode相等<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">InetAddress i1 = InetAddress.getByName(<span class="string">"www.ibiblio.org"</span>);</div><div class="line">InetAddress i2 = InetAddress.getByName(<span class="string">"helios.metalab.unc.edu"</span>);</div><div class="line">Assert.assertEquals(<span class="keyword">true</span>, i1.hashCode() == i2.hashCode());</div></pre></td></tr></table></figure></p>
<p>下例中toString将主机名一起打印了出来. 但不是所有的InetAddress都含有主机名.java 1.4之后,如果没有主机名就会将其打印成空字符串,而不是像1.3之前的打印点分四段式ip地址<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InetAddress i1 = InetAddress.getByName(<span class="string">"www.ibiblio.org"</span>);</div><div class="line">Assert.assertEquals(<span class="string">"www.ibiblio.org/152.19.134.40"</span>, i1.toString());</div></pre></td></tr></table></figure></p>
<p>使用DNS查找主机IP地址,该方法会试图连接本地DNS服务器. 如果没有找到主机会抛出UnknownHostException异常<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getByName(<span class="string">"localhost"</span>);</div><div class="line">Assert.assertEquals(<span class="string">"localhost/127.0.0.1"</span>, address.toString());</div></pre></td></tr></table></figure></p>
<p>直接为IP地址创建一个InetAddress对象,但是它不会检查DNS服务器(不会主动查找主机名). 如果没有找到主机也不会抛出UnknownHostException异常. 只有当使用getHostName() 或者使用toString()时才会通过DNS查找主机名.如果没有找到主机名,那它会使用默认值(即点分四段或者16进制式地址)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getByName(<span class="string">"180.149.131.98"</span>);</div><div class="line">Assert.assertEquals(<span class="string">"/180.149.131.98"</span>, address.toString());</div><div class="line">Assert.assertEquals(<span class="string">"180.149.131.98"</span>, address.getHostName());</div></pre></td></tr></table></figure></p>
<p>返回对应该主机名的所有地址,该方法会试图连接本地DNS服务器<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">InetAddress[] address = InetAddress.getAllByName(<span class="string">"www.baidu.com"</span>);</div><div class="line"><span class="keyword">for</span> (InetAddress inetAddress : address) &#123;</div><div class="line">System.out.println(<span class="string">"testGetAllByName_ok : "</span> + inetAddress);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>显示当前机器的IP地址.该方法会试图连接本地DNS服务器.just-PC 为本地DSN服务器为本地域中主机返回的主机名.该地址是路由分配地址(即内网使用的路由地址)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getLocalHost();</div><div class="line">Assert.assertEquals(<span class="string">"just-PC/192.168.1.101"</span>, address.toString());</div></pre></td></tr></table></figure></p>
<p>该方法会试图连接本地DNS服务器<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InetAddress <span class="keyword">address </span>= InetAddress.getByName(<span class="string">""</span>)<span class="comment">;</span></div><div class="line">Assert.assertEquals(<span class="string">"localhost/127.0.0.1"</span>, <span class="keyword">address.toString());</span></div></pre></td></tr></table></figure></p>
<p>该方法会试图连接本地DNS服务器, 无法找到抛出UnknownHostException异常<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">InetAddress.getByName(<span class="string">"asd"</span>);</div></pre></td></tr></table></figure></p>
<p>获取一个主机的字符串形式的主机名. 如果该主机没有主机名(没有在DNS注册)或者安全管理器(SecurityManager)确定阻止该主机名,就会返回点分四段式ip地址<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getLocalHost();</div><div class="line">System.out.println(<span class="string">"Host Name : "</span> + address.getHostName()); <span class="comment">// 本地主机名取决于本地NDS在解析本地主机名时的行为</span></div><div class="line">InetAddress address1 = InetAddress.getByName(<span class="string">"180.149.131.98"</span>);</div><div class="line">Assert.assertEquals(<span class="string">"180.149.131.98"</span>, address1.getHostName());  <span class="comment">// 为什么没有返回主机名？？</span></div></pre></td></tr></table></figure></p>
<p>返回点分四段式ip地址<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getLocalHost();</div><div class="line">Assert.assertEquals(<span class="string">"192.168.1.101"</span>, address.getHostAddress());</div></pre></td></tr></table></figure></p>
<p>主要是用来测试地址类型是ipv4还是ipv6<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getLocalHost();</div><div class="line"><span class="comment">// 返回网络字节顺序(最高位是数组的第一个字节)的字节数组形式的ip地址</span></div><div class="line"><span class="keyword">byte</span>[] arr = address.getAddress();  </div><div class="line"><span class="keyword">if</span>(arr.length == <span class="number">4</span>)</div><div class="line">System.out.print(<span class="string">"Address Type : IPv4---"</span>);</div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span>(arr.length == <span class="number">16</span>)</div><div class="line">System.out.print(<span class="string">"Address Type : IPv6---"</span>);</div><div class="line"><span class="keyword">for</span> (<span class="keyword">byte</span> b : arr) &#123;</div><div class="line">System.out.print(b);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>测试地址可达性,尝试连接远程主机的echo接口,查看是否可达. 该方法在全球Internet上并不可靠,防火墙会拦截java用于查看主机是否可大的网络协议<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getByName(<span class="string">"180.149.131.98"</span>);</div><div class="line">System.out.println(<span class="string">"is Rechable : "</span> + address.isReachable(<span class="number">5</span>));</div><div class="line">System.out.println(address.isReachable(InetAddress., ttl, timeout));</div></pre></td></tr></table></figure></p>
<p>测试是否是通配符地址. 通配符地址可匹配本地系统中所有地址. IPv4中通配符地址是0.0.0.0 IPv6是::<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getLocalHost();</div><div class="line">address.isAnyLocalAddress();</div></pre></td></tr></table></figure></p>
<p>测试是否是回路地址. 回路地址在IP层连接同一台电脑,不使用任何物理硬件. 这就绕过了可能有问题的硬件设备进行测试  地址是127.0.0.1<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getLocalHost();</div><div class="line">address.isLoopbackAddress();</div></pre></td></tr></table></figure></p>
<p>测试是否是IPv6本地连接地址(以FE80开头地址,后8个字节用以太网mac地址(本地地址)填充). 这个地址有助于实现IPv6网络自动配置 ,并且不会将包转发出本地子网<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getLocalHost();</div><div class="line">address.isLinkLocalAddress();</div></pre></td></tr></table></figure></p>
<p>测试是否是IPv6本地网站地址(以FEC0开头地址,后8个字节用以太网mac地址(本地地址)填充). 这个地址只会被路由器在网站内转发<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getLocalHost();</div><div class="line">address.isSiteLocalAddress();</div></pre></td></tr></table></figure></p>
<p>是否是组广播地址(IPV4:224.0.0.0-239.255.255.255) 向预定计算机进行广播<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getLocalHost();</div><div class="line">address.isMulticastAddress();</div></pre></td></tr></table></figure></p>
<p>测试是否是全球广播地<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getLocalHost();</div><div class="line">address.isMCGlobal();</div></pre></td></tr></table></figure></p>
<p>组织范围内广播地址<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getLocalHost();</div><div class="line">address.isMCOrgLocal();</div></pre></td></tr></table></figure></p>
<p>是否是网站内组播地址<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getLocalHost();</div><div class="line">address.isMCSiteLocal();</div></pre></td></tr></table></figure></p>
<p>子网范围内组播地址<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getLocalHost();</div><div class="line">address.isMCLinkLocal();</div></pre></td></tr></table></figure></p>
<p>本地接口组播地址<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InetAddress address = InetAddress.getLocalHost();</div><div class="line">address.isMCNodeLocal();</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/09/20/JavaSE/Java网络/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/09/20/JavaSE/Java网络/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/09/09/jvm/JVM 类加载机制/" title="类加载机制" itemprop="url">类加载机制</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-09-09T07:00:00.000Z" itemprop="datePublished"> 发表于 2014-09-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="类的生命周期"><a href="#类的生命周期" class="headerlink" title="类的生命周期"></a>类的生命周期</h3><p>类从被加载进虚拟机内存开始到卸载出内存的生命周期:</p>
<ol>
<li>加载</li>
<li>验证</li>
<li>准备</li>
<li>解析</li>
<li>初始化</li>
<li>使用</li>
<li>卸载</li>
</ol>
<blockquote>
<p>特殊说明<br>2.验证, 3.准备, 4.解析 又称为连接阶段<br>1.加载, 2.验证, 3.准备, 4.解析, 5. 初始化 被称为类加载</p>
</blockquote>
<h3 id="加载"><a href="#加载" class="headerlink" title="加载"></a>加载</h3><p>加载的过程就是JVM读取class文件, 然后将其转换成方法区的数据结构存储在方法区中, 接着在JVM堆中对其实例化一个<code>java.lang.Class</code>对象, 然后应用程序就可以通过该Class对象访问方法区中的数据了。</p>
<p>整个类的加载过程如下</p>
<ol>
<li>通过类的全限定名来获取此类的二进制流.</li>
<li>将这个字节流所代表的静态存储结构转化为方法区的运行时结构</li>
<li>在java堆中生成一个代表这个类的<code>java.class.Class</code>对象.</li>
</ol>
<p>在上面的三个过程中, 唯一开发人员可控的就是如何实现加载过程, 也就是从哪里获取以及如何获取类的字节码. 一般情况而言我们都是使用系统提供的类加载器, 或者自己实现一个加载器. 实现参考<a href="http://www.ming15.wang/2016/01/29/jvm/使用Classloader加载类/" target="_blank" rel="external">使用Classloader加载类</a></p>
<blockquote>
<p>我们还可以使用<a href="">Class.forName(..)</a> 为我们加载类</p>
</blockquote>
<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>这个阶段主要是用来检测java文件编译后的class文件是符合虚拟机规范的.</p>
<p>如果我们在java源码中将一个对象强转为一个没有被定义的类, 那么javac在编译的时候, 会给我们提示编译错误. 但是我们可以通过ASM这类的工具修改一个class字节流达到刚才我们描述的那个非法的功能. 这样子一来如果不对加载进虚拟机的字节码流做校验的话, 很可能会对虚拟机产生很大的危害, 因此验证阶段就是做这个事情用的.下面我们看一下校验过程:</p>
<p>首先是class文件格式验证, 保证输入的字节流能正确地解析并存储于方法区之内.</p>
<ol>
<li>是否以魔术0xCAFEBABY 开头</li>
<li>主次版本号是否在当前虚拟机处理范围内.</li>
<li>常量池中是否有不被支持的常量类型(检查常量tag标志)</li>
<li>… 还有很多其他校验</li>
</ol>
<p>然后是基于方法区的数据结构进行元数据验证, 基本上就是在检验数据类型</p>
<ol>
<li>这个类是否是父类.</li>
<li>这个类是否继承了不允许继承的类(被final修饰的类)</li>
<li>如果这个类不是抽象类,是否实现了其父类或接口中所要求实现的所有方法</li>
<li>… 还有很多其他校验</li>
</ol>
<p>紧接着同样基于方法区的数据结构对方法体进行验证.(主要是针对数据流和控制流进行分析.)</p>
<ol>
<li>保证任意时刻操作数栈的数据类型与指令代码序列都能配合工作.例如操作数栈放置一个int类型的数据,不会按照long类型加载到本地变量表.</li>
<li>保证跳转指令不会跳转到方法体以外的字节码指令上</li>
<li>…  还有很多其他校验</li>
</ol>
<p>最后是符号引用验证.符号校验可以看作是对类自身以外(常量池中的各种符号引用)的信息进行匹配性的校验</p>
<ol>
<li>符号引用通过字符串描述的全限定名是否能找到对应的类</li>
<li>在指定类中是否存在符号方法的字段描述及简单名称所描述的方法和字段</li>
<li>… 还有很多其他的校验<blockquote>
<p>符号引用的校验是确保解析动作能正常执行.最后一个阶段校验发生在虚拟机将符号引用转化为直接引用的时候,这个转化动作将在连接的第三阶段-解析阶段中发生</p>
</blockquote>
</li>
</ol>
<h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>准备阶段为类变量在方法区中进行内存分配以及初始值设置. 我们看下面的一个类变量value<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> value = <span class="number">123</span>;</div></pre></td></tr></table></figure></p>
<p>value在准备阶段初始值为0而不是123.因为把value赋值为123的putstatic指令是在类构造器<code>&lt;clinit&gt;()</code>方法中执行的,而类构造器只有在初始化阶段才会执行.</p>
<blockquote>
<p>但是在一些特殊情况下,如果类字段的字段属性表中存在ConstantValue属性,那么在准备阶段value值就会被初始化为ConstantValue指定的属性值.</p>
</blockquote>
<h3 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h3><p>解析阶段是虚拟机将常量池符号引用替换为直接引用的过程(符号引用以CONSTANT_Class_info,CONSTANT_Field_info等类型常量)</p>
<ol>
<li>符号引用: 以一组符号来描述所引用的目标,符号可以是任何形式的字面量,只要使用时能无歧义地定位到目标即可.符号引用与内存实现的布局无关,引用的目标不一定已经加载到内存中.</li>
<li>直接引用:可以是直接指向目标的指针,相对偏移量或是一个能间接定位到目标的句柄.直接引用是与虚拟机实现的内存布局相关的,同一个符号引用在不同的虚拟机实例上翻译出来的直接引用一般不会相同.如果有了直接引用,那引用的目标一定已经在内存中存在.</li>
</ol>
<p>虚拟机只规定了在<code>anewarray,checkcast,getfield,getstatic,instanceof,invokeinterface,invokespecial,invokestatic,invokevirtual,mutianewarray,new,putfield,putstatic</code>这13个用于操作符号引用的字节码指令之前,先对他们所使用的符号引用进行解析. 因此有可能是在类被加载时进行解析，也有可能是该符号被使用的时候才会被解析，这个要看具体的虚拟机实现。但是不管是采用哪种方式，都可能发生多次解析的现象，因此虚拟机对此有一个缓存策略，只要一次解析成功，那么后续再接受到解析请求时就会从缓存里面拿，如果第一次解析失败，则以后的解析请求也是失败的</p>
<p>####　CONSTANT_Class_info结构体解析<br>假设类D引用了一个符号引用N, 第一次将符号引用N解析为类或接口C的直接引用时需要以下步骤</p>
<ol>
<li>如果C不是一个数组类型,D的类加载器会根据N的全限定名将类C加载进虚拟机. 加载过程中由于上述验证步骤的需要,又可能触发加载C类的父类或实现的接口.一旦这个加载过程出现了任何异常,解析过程将失败.</li>
<li>如果C是一个数组类型,并且数组的元素类型为对象,也就是N的描述符会是类似”[Ljava.lang.Integer”的形式.那将会按照第一点的规则加载数组元素类型,如果N的描述符如前面所假设的形式,需要加载的元素类型就是”java.lang.Integer”,接着由虚拟机生成一个代表此数组维度和元素的数组对象</li>
<li>如果上述步骤没有出现任何异常,那么C在虚拟机中实际已经称为一个有效的类或接口了,但在解析完成之前还要进行符号引用验证,确认C是否具备对D的访问权限,如果不具备访问权限,抛出”java.lang.IllegalAccessError”异常</li>
</ol>
<h4 id="CONSTANT-Fieldref-info结构体解析"><a href="#CONSTANT-Fieldref-info结构体解析" class="headerlink" title="CONSTANT_Fieldref_info结构体解析"></a>CONSTANT_Fieldref_info结构体解析</h4><p>要解析一个从未被解析过的字段符号引用,首先会对字段表内class_index项中索引的CONSTANT_Class_info符号引用进行解析,也就是字段所属的类或接口的符号引用.如果在解析这个类或接口符号引用的过程中出现了任何异常,都会导致字段解析失败,如果解析成功,那将这个字段所属的类或接口用C表示.</p>
<ol>
<li>如果C本身就包含了简单名称和字段描述符都与目标相匹配的字段,则返回了这个字段的直接引用,查找结束</li>
<li>否则,如果在C中实现了接口,将会按照继承关系从上往下递归搜索各个接口和它的父接口,如果接口中包含了简单名称和字段描述符都与目标相匹配的字段,则返回这个字段的直接引用,查找结束.</li>
<li>否则,如果C不是java.lang.Object的话,将会按照继承关系从上往下递归搜索其父类,如果父类中不包含了简单名称和字段描述符都与目标相匹配的字段,则返回这个字段的直接引用,查找结束.</li>
<li>否则,查找失败,抛出java.lang.NoSuchFieldError异常</li>
</ol>
<p>如果查找过程成功返回了引用,将会对这个字段进行权限验证,如果发现不具备对其字段的访问权限,则抛出”java.lang.IllegalAccessError”异常.尝试在父类和子类中都出现相同的字段,看看编译器是否会编译</p>
<h4 id="CONSTANT-Methodref-info结构体解析"><a href="#CONSTANT-Methodref-info结构体解析" class="headerlink" title="CONSTANT_Methodref_info结构体解析"></a>CONSTANT_Methodref_info结构体解析</h4><p>类方法解析的第一个步骤与字段解析一样,也是需要解析类方法表的class_index项中索引的方法所属的类或接口的符号引用,如果解析成功,依然使用C表示这个类.</p>
<ol>
<li>类方法和接口方法符号引用的常量类型定义是分开的,如果在类方法表中发现class_index中索引的C是个接口,那就直接抛出java,lang.IncompatibleClassChangeError.</li>
<li>通过第一步,在类C中查找是否有简单名称和描述符都与目标相匹配的方法,如果有则直接返回这个方法的引用,查找结束.</li>
<li>否则在类C的父类中递归查找是否有简单名称和描述符都与目标相匹配的方法,如果有则返回这个方法的直接引用,查找结束</li>
<li>否则在类C实现的接口列表及它们的父接口之中递归查找是否有简单名称和描述符都与目标相匹配的方法,如果存在匹配的方法.说明类C是一个抽象类,这时候查找结束,抛出java.lang.AbstractMethodError异常</li>
<li>否则,宣告查找失败,抛出java.lang.NoSuchMethodError.</li>
</ol>
<p>最后如果查找过程中成功返回了直接引用,将会对这个方法进行权限验证:如果发现不具备对此方法的权限访问,将抛出java.lang.IllegalAccessError</p>
<h4 id="CONSTANT-InterfaceMethodref-info结构体解析"><a href="#CONSTANT-InterfaceMethodref-info结构体解析" class="headerlink" title="CONSTANT_InterfaceMethodref_info结构体解析"></a>CONSTANT_InterfaceMethodref_info结构体解析</h4><p>接口方法也需要先解析出接口方法表的class_index项中索引的方法所属的类或接口的符号引用,如果解析成功,依然用C表示这个接口:</p>
<ol>
<li>与类方法解析相反,如果在接口方法表中发现class_index中的索引C是个类而不是接口,就将直接抛出java.lang.IncompatibleClassChangeError异常.</li>
<li>否则在接口C中查找是否有简单名称和描述符都与目标相匹配的方法,如果有则返回这个方法的直接引用,查找结束.</li>
<li>否则在接口C的父接口中递归查找,知道java.lang.Object类为止,看是否有简单名称和描述符都与目标相匹配的方法,如果有则返回这个方法的直接引用,查找结束.</li>
<li>否则,宣告方法查找失败,抛出java.lang.NoSuchMethodError异常</li>
</ol>
<p>由于接口中的所有方法都默认是public的,所以不存在访问权限的问题,因为接口方法的符号引用解析都应当不会抛出”java.lang.IllegalAccessError”异常</p>
<h3 id="类的初始化"><a href="#类的初始化" class="headerlink" title="类的初始化"></a>类的初始化</h3><p>类初始化阶段是类加载过程中最后一步,开始执行类构造器<clinit>方法. <code>&lt;clinit&gt;</code>方法执行过程可能会影响程序运行行为的一些特点和细节</clinit></p>
<ol>
<li><code>&lt;clinit&gt;</code>方法由编译器将类变量的赋值动作和静态语句块(static{}块)中的语句合并产生的.编译器收集的顺序是由语句在源文件中出现的顺序决定的,静态语句块只能访问到定义在静态语句块之前的变量,定义在它之后的变量,在前面的静态语句块中可以赋值但是不能访问.</li>
<li><code>&lt;clinit&gt;()</code>方法和实例的构造函数(<init>)不同,他不需要显式地调用父类构造器,虚拟机会保证在子类的<clinit>()方法执行之前,父类的<code>&lt;clinit&gt;</code>方法已经执行完毕,因此虚拟机中第一个被执行的<code>&lt;clinit&gt;()</code>方法的类肯定是<code>java.lang.Object</code></clinit></init></li>
<li>由于父类的<code>&lt;clinit&gt;()</code>方法先执行,也就意味着父类中定义的静态语句块要优先于子类的变量赋值操作</li>
<li><code>&lt;clinit&gt;()</code>方法对于对类或者接口来说并不是必须的,如果一个类中没有静态语句块,也没有对变量的赋值操作,那么编译器可以不为这个类生成<code>&lt;clinit&gt;()</code>方法.</li>
<li>接口中不能使用静态语句块,但仍然有变量初始化的赋值操作,因此接口与类一样会生成<clinit>()方法.但接口与类不同的是,执行接口<code>&lt;clinit&gt;()</code>不需要先执行父接口<code>&lt;clinit&gt;()</code>.只有当父接口中定义的变量被使用时,父接口才会被初始化.另外,接口的实现类在初始化时也一样不会执行接口的<clinit>()方法.</clinit></clinit></li>
<li>虚拟机会保证一个类的<code>&lt;clinit&gt;()</code>方法在多线程环境中被正确地加锁和同步,如果多个线程同时去初始化一个类,那么只会有一个线程去执行这个类的<code>&lt;clinit&gt;()</code>方法,其他线程都需要阻塞等待,直到活动线程执行<code>&lt;clinit&gt;()</code>方法完毕. 如果,在一个类的<clinit>()方法中有耗时很长的操作,那就很可能造成多个进程阻塞.</clinit></li>
</ol>
<p><code>&lt;clinit&gt;()</code>方法执行顺序<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewClass</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> A = <span class="number">1</span>;</div><div class="line">        <span class="keyword">static</span> &#123;</div><div class="line">            A = <span class="number">2</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sub</span> <span class="keyword">extends</span> <span class="title">Parent</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> B = A;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        System.out.println(Sub.B);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>字段解析<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadLoopClass</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">true</span>) &#123;</div><div class="line">            System.out.println(Thread.currentThread() + <span class="string">" init DeadLoopClass "</span>);</div><div class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;&#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Runnable script = <span class="keyword">new</span> Runnable() &#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                System.out.println(Thread.currentThread() + <span class="string">" start"</span>);</div><div class="line">                DeadLoopClass dlc = <span class="keyword">new</span> DeadLoopClass();</div><div class="line">                System.out.println(Thread.currentThread() + <span class="string">" run over"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        Thread t1 = <span class="keyword">new</span> Thread(script);</div><div class="line">        Thread t2 = <span class="keyword">new</span> Thread(script);</div><div class="line">        t1.start();</div><div class="line">        t2.start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>类初始化的四种情况</p>
<ol>
<li>遇到new, getstatic, putstatic, invokestatic, 这四条字节码指令时, 如果类没有进行过初始化,则必须先触发初始化</li>
<li>使用java.lang.reflect包的方法进行反射调用的时候,如果类没有进行过初始化,则需要先触发其初始化</li>
<li>当初始化一个类的时候,如果发现其父类还没有进行过初始化,则需要先触发其父类的初始化.</li>
<li>当虚拟机启动的时候,用户需要指定一个要执行的主类,虚拟机会先初始化这个主类.</li>
</ol>
<p>通过子类引用父类的静态字段,不会导致子类的类初始化<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SuperClass</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        System.out.println(<span class="string">"SuperClass init"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> value = <span class="number">123</span>;</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubClass</span> <span class="keyword">extends</span> <span class="title">SuperClass</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        System.out.println(<span class="string">"SubClass init"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotInitialization</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        System.out.println(SubClass.value);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过数组定义来引用类,不会触发此类的初始化<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SuperClass</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        System.out.println(<span class="string">"SuperClass init"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> value = <span class="number">123</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotInitialization</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SuperClass[] sca = <span class="keyword">new</span> SuperClass[<span class="number">10</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>常量在编译阶段会存入调用类的常量池中,本质上没有直接引用到定义常量的类,因此不会触发定义常量的类的初始化<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConstClass</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        System.out.println(<span class="string">"ConstClass init"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HELLOWORLD = <span class="string">"hello world"</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotInitialization</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        System.out.println(ConstClass.HELLOWORLD);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/09/09/jvm/JVM 类加载机制/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/09/09/jvm/JVM 类加载机制/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/09/08/杂记/gitbook/" title="gitbook使用" itemprop="url">gitbook使用</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-09-07T16:00:00.000Z" itemprop="datePublished"> 发表于 2014-09-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="安装gitbook命令行"><a href="#安装gitbook命令行" class="headerlink" title="安装gitbook命令行"></a>安装gitbook命令行</h1><ol>
<li>下载安装<code>npm</code>和<code>io.js</code></li>
<li>安装<code>git</code>, <code>gitbook</code>需要依赖<code>git</code>.</li>
<li>将<code>git</code>的<code>bin</code>目录放到环境变量<code>Path</code>里</li>
<li>在windows下npm module一般都是安装到<code>C:\Users\Administrator\AppData\Roaming\npm\node_modules</code>这<br> 里,所以为了我们能够使用安装好的module,我们将这个路径添加到环境变量<code>Path</code>里</li>
<li>然后使用<code>npm install gitbook-cli -g</code> 安装gitbook</li>
<li>最后验证一下gitbook是否安装成功： <code>gitbook -V</code> 我安装的是<code>0.3.3</code>, 所以在命令行里直接输出了<code>0.3.3</code></li>
</ol>
<h1 id="gitbook-github简历博客"><a href="#gitbook-github简历博客" class="headerlink" title="gitbook + github简历博客"></a>gitbook + github简历博客</h1><p>我们假设下列所有操作都在<code>D:\git</code>这个目录下操作</p>
<ol>
<li>我们将github上创建的项目<code>demo</code>检出到<code>D:\git</code>目录里,最好你也是用svn检出的，因为我是在svn检出的前提下写了个小工具</li>
<li>然后我们进入到<code>D:\git\demo</code>目录里,我们会看到<code>branches</code>和<code>trunk</code>俩个文件夹,<code>branches</code>用于存储博客的web文件,<code>trunk</code>用于存放博客的<code>markdown</code>源文件</li>
<li>接着我们进入到<code>D:\git\demo\trunk</code>新建<code>blog</code>文件夹</li>
<li>进入到<code>D:\git\demo\trunk\blog</code>在这个目录里新建一个<code>build.bat</code>批处理脚本文件,同时创建一个<code>repository</code></li>
<li><code>build.bat</code>批处理脚本文件内容为<code>gitbook build ./repository ../../branches/gh-pages</code></li>
<li>我们使用gitbook客户端在<code>repository</code>文件夹内创建一个gitbook项目</li>
<li>双击运行<code>build.bat</code></li>
<li>查看<code>D:\git\demo\branches\gh-pages</code>是否生成了一个web站点呢？这个就是我们的博客了</li>
<li>最后在<code>D:\git\demo</code>这个目录里上传所有的文件就好了</li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/杂记/">杂记</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/09/08/杂记/gitbook/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/09/08/杂记/gitbook/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/09/06/jvm/JVM内存溢出/" title="JVM内存溢出" itemprop="url">JVM内存溢出</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-09-05T16:00:00.000Z" itemprop="datePublished"> 发表于 2014-09-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="ConstantPool-OOM"><a href="#ConstantPool-OOM" class="headerlink" title="ConstantPool OOM"></a>ConstantPool OOM</h2><p>溢出代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 运行时常量溢出</div><div class="line"> * VM Args: -XX:PermSize=10M -XX:MaxPermSize=10M</div><div class="line"> * <span class="doctag">@author</span> mingwang</div><div class="line"> *</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RuntimeConstantPoolOOM</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">		<span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">		<span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</div><div class="line">			list.add(String.valueOf(i++).intern());</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果想运行时常量池添加内容最简单的方式就是String.intern()这个native方法.该方法的作用是:如果池中已经包含一个等于此String对象的字符串,则返回池中这个字符串的String对象.否则将次String对象包含的字符串添加到常量池中,并返回次String对象音乐.</p>
<h2 id="Stack-OOM"><a href="#Stack-OOM" class="headerlink" title="Stack OOM"></a>Stack OOM</h2><p>溢出代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestStackSOF</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> stackLength = <span class="number">1</span>;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">stackLeak</span><span class="params">()</span> </span>&#123;</div><div class="line">		stackLength ++;</div><div class="line">		stackLeak();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			stackLeak();</div><div class="line">		&#125; <span class="keyword">catch</span>(Throwable e) &#123;</div><div class="line">			System.out.println(<span class="string">"stack length:"</span> + stackLength + <span class="string">". "</span> + e.getMessage());</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行上面的程序<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">D:\<span class="built_in">test</span>OOM&gt;java -XX:+HeapDumpOnOutOfMemoryError -Xss1M TestStackSOF</div><div class="line">stack length:22427. null</div></pre></td></tr></table></figure></p>
<p>1M的栈空间大概能执行以上那个简单方法的22427次. 这个次数并不是在编译期就决定的,而是在运行时根据具体的内存使用情况而变化的. </p>
<p>下面的代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">stackLeak</span><span class="params">()</span> </span>&#123;</div><div class="line">                stackLeak();</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">                stackLeak();</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>使用<code>-XX:+HeapDumpOnOutOfMemoryError</code>并不能产生堆内存溢出错误, 也没有产生类似于java_pid19212.hprof文件的文件.<br>使用<code>java -XX:ErrorFile=./error.log -Xss1M Test</code> 也没有产生错误文件<br>上面的并没有产生<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaVMStackOOM</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dontStop</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</div><div class="line"></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stackLeakByThread</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</div><div class="line">			Thread t = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable()&#123;</div><div class="line">				<span class="meta">@Override</span></div><div class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">					dontStop();</div><div class="line">				&#125;</div><div class="line">			&#125;);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		JavaVMStackOM om = <span class="keyword">new</span> JavaVMStackOM();</div><div class="line">		om.stackLeakByThread();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>以上俩个实现都都无法让虚拟机产生OutOfMemoryError异常,只能产生StackOverflowError.实验结果表明: 单个线程下,无论由于栈帧太大还是虚拟机容量太小,当内存无法分配时,虚拟机抛出的都是StackOverflowError.如果测试时不是限于单线程,通过不断建立新线程的方式倒是可以产生内存溢出异常. 但是这样产生的内存溢出异常与栈空间是否足够大并不存在任何联系,或者准确说,在这种情况下,给每个线程的栈分配的内存越大,反而越容易产生内存溢出异常.</p>
<p>当开发多线程应用时应该特别注意的是,出现StackOverflowError异常时有错误堆栈可以阅读,相对来说比较容易找到问题.如果使用虚拟机默认参数,栈深度在大多数情况下达到1000-2000完全没有问题,对于正常的方法调用(包括递归),这个深度应该够用了,但是如果建立过多的线程导致的内存溢出,在不能减少线程数或者更换64位虚拟机的情况下,就只能通过减少最大堆和减少栈容量来换取更多的线程.</p>
<h2 id="Metadata-OOM"><a href="#Metadata-OOM" class="headerlink" title="Metadata OOM"></a>Metadata OOM</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaMethodAreaOOM</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</div><div class="line">			Enhancer enhancer = <span class="keyword">new</span> Enhancer();</div><div class="line">			enhancer.setSuperclass(OOMObject.class);</div><div class="line">			enhancer.setUseCache(<span class="keyword">false</span>);</div><div class="line">			enhancer.setCallBack(<span class="keyword">new</span> MethodInterceptor()&#123;</div><div class="line">				<span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] objs,</span></span></div><div class="line">				MethodProxy proxy) <span class="keyword">throws</span> Throwable &#123;</div><div class="line">					<span class="keyword">return</span> proxy.invokeSuper(obj, args);</div><div class="line">				&#125;</div><div class="line">			&#125;);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OOMObject</span> </span>&#123;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>执行代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">javac JavaMethodAreaOOMRun.java</div><div class="line">java -XX:PermSize10M -XX:MaxPermSize10M JavaMethodAreaOOMRun</div></pre></td></tr></table></figure></p>
<p>方法区用于存放Class信息,为了测试这个区域,基本思路是产生大量的类去填充方法区,直到溢出.本例中使用的是CGLib, 还可以使用ASM等框架进行测试.方法区溢出也是一种常见的内存溢出异常.一个类如果被垃圾收集器回收,其条件是非常苛刻的. 在经常动态生成大量Class的应用中,需要特别注意类的回收状况. (基于OSGI的应用即使是同一个类文件被不同的加载器加载也会视为不同的类)</p>
<h2 id="Heap-OOM"><a href="#Heap-OOM" class="headerlink" title="Heap OOM"></a>Heap OOM</h2><p>我们首先看一段内存溢出的代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestHeapOOM</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++) &#123;</div><div class="line">			System.out.println(<span class="string">"Allocate : "</span> + i);</div><div class="line">			<span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1324</span> * <span class="number">1124</span> * i * <span class="number">2</span>];</div><div class="line">		&#125; </div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来我们运行一下上面的那个程序<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line">D:\testOOM&gt;java -XX:+HeapDumpOnOutOfMemoryError -XX:+PrintHeapAtGC -Xms10M -Xmx10M -Xmn4M TestHeapOOM</div><div class="line">Allocate : 1</div><div class="line">Allocate : 2</div><div class="line">Allocate : 3</div><div class="line">&#123;Heap before GC invocations=1 (full 0):</div><div class="line"> PSYoungGen      total 3584K, used 3002K [0x00000000ffc00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 3072K, 97% used [0x00000000ffc00000,0x00000000ffeee8c0,0x00000000fff00000)</div><div class="line">  from space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 6144K, used 4096K [0x00000000ff600000, 0x00000000ffc00000, 0x00000000ffc00000)</div><div class="line">  object space 6144K, 66% used [0x00000000ff600000,0x00000000ffa00010,0x00000000ffc00000)</div><div class="line"> Metaspace       used 2580K, capacity 4486K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 287K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">Heap after GC invocations=1 (full 0):</div><div class="line"> PSYoungGen      total 3584K, used 488K [0x00000000ffc00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 3072K, 0% used [0x00000000ffc00000,0x00000000ffc00000,0x00000000fff00000)</div><div class="line">  from space 512K, 95% used [0x00000000fff00000,0x00000000fff7a020,0x00000000fff80000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line"> ParOldGen       total 6144K, used 4312K [0x00000000ff600000, 0x00000000ffc00000, 0x00000000ffc00000)</div><div class="line">  object space 6144K, 70% used [0x00000000ff600000,0x00000000ffa36020,0x00000000ffc00000)</div><div class="line"> Metaspace       used 2580K, capacity 4486K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 287K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">&#125;</div><div class="line">&#123;Heap before GC invocations=2 (full 0):</div><div class="line"> PSYoungGen      total 3584K, used 488K [0x00000000ffc00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 3072K, 0% used [0x00000000ffc00000,0x00000000ffc00000,0x00000000fff00000)</div><div class="line">  from space 512K, 95% used [0x00000000fff00000,0x00000000fff7a020,0x00000000fff80000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line"> ParOldGen       total 6144K, used 4312K [0x00000000ff600000, 0x00000000ffc00000, 0x00000000ffc00000)</div><div class="line">  object space 6144K, 70% used [0x00000000ff600000,0x00000000ffa36020,0x00000000ffc00000)</div><div class="line"> Metaspace       used 2580K, capacity 4486K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 287K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">Heap after GC invocations=2 (full 0):</div><div class="line"> PSYoungGen      total 3584K, used 488K [0x00000000ffc00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 3072K, 0% used [0x00000000ffc00000,0x00000000ffc00000,0x00000000fff00000)</div><div class="line">  from space 512K, 95% used [0x00000000fff80000,0x00000000ffffa020,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 6144K, used 4312K [0x00000000ff600000, 0x00000000ffc00000, 0x00000000ffc00000)</div><div class="line">  object space 6144K, 70% used [0x00000000ff600000,0x00000000ffa36020,0x00000000ffc00000)</div><div class="line"> Metaspace       used 2580K, capacity 4486K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 287K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">&#125;</div><div class="line">&#123;Heap before GC invocations=3 (full 1):</div><div class="line"> PSYoungGen      total 3584K, used 488K [0x00000000ffc00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 3072K, 0% used [0x00000000ffc00000,0x00000000ffc00000,0x00000000fff00000)</div><div class="line">  from space 512K, 95% used [0x00000000fff80000,0x00000000ffffa020,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 6144K, used 4312K [0x00000000ff600000, 0x00000000ffc00000, 0x00000000ffc00000)</div><div class="line">  object space 6144K, 70% used [0x00000000ff600000,0x00000000ffa36020,0x00000000ffc00000)</div><div class="line"> Metaspace       used 2580K, capacity 4486K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 287K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">Heap after GC invocations=3 (full 1):</div><div class="line"> PSYoungGen      total 3584K, used 0K [0x00000000ffc00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 3072K, 0% used [0x00000000ffc00000,0x00000000ffc00000,0x00000000fff00000)</div><div class="line">  from space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 6144K, used 642K [0x00000000ff600000, 0x00000000ffc00000, 0x00000000ffc00000)</div><div class="line">  object space 6144K, 10% used [0x00000000ff600000,0x00000000ff6a08a0,0x00000000ffc00000)</div><div class="line"> Metaspace       used 2580K, capacity 4486K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 287K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">&#125;</div><div class="line">&#123;Heap before GC invocations=4 (full 1):</div><div class="line"> PSYoungGen      total 3584K, used 0K [0x00000000ffc00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 3072K, 0% used [0x00000000ffc00000,0x00000000ffc00000,0x00000000fff00000)</div><div class="line">  from space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 6144K, used 642K [0x00000000ff600000, 0x00000000ffc00000, 0x00000000ffc00000)</div><div class="line">  object space 6144K, 10% used [0x00000000ff600000,0x00000000ff6a08a0,0x00000000ffc00000)</div><div class="line"> Metaspace       used 2580K, capacity 4486K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 287K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">Heap after GC invocations=4 (full 1):</div><div class="line"> PSYoungGen      total 3584K, used 0K [0x00000000ffc00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 3072K, 0% used [0x00000000ffc00000,0x00000000ffc00000,0x00000000fff00000)</div><div class="line">  from space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line"> ParOldGen       total 6144K, used 642K [0x00000000ff600000, 0x00000000ffc00000, 0x00000000ffc00000)</div><div class="line">  object space 6144K, 10% used [0x00000000ff600000,0x00000000ff6a08a0,0x00000000ffc00000)</div><div class="line"> Metaspace       used 2580K, capacity 4486K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 287K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">&#125;</div><div class="line">&#123;Heap before GC invocations=5 (full 2):</div><div class="line"> PSYoungGen      total 3584K, used 0K [0x00000000ffc00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 3072K, 0% used [0x00000000ffc00000,0x00000000ffc00000,0x00000000fff00000)</div><div class="line">  from space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line"> ParOldGen       total 6144K, used 642K [0x00000000ff600000, 0x00000000ffc00000, 0x00000000ffc00000)</div><div class="line">  object space 6144K, 10% used [0x00000000ff600000,0x00000000ff6a08a0,0x00000000ffc00000)</div><div class="line"> Metaspace       used 2580K, capacity 4486K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 287K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">Heap after GC invocations=5 (full 2):</div><div class="line"> PSYoungGen      total 3584K, used 0K [0x00000000ffc00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 3072K, 0% used [0x00000000ffc00000,0x00000000ffc00000,0x00000000fff00000)</div><div class="line">  from space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line"> ParOldGen       total 6144K, used 630K [0x00000000ff600000, 0x00000000ffc00000, 0x00000000ffc00000)</div><div class="line">  object space 6144K, 10% used [0x00000000ff600000,0x00000000ff69d8d0,0x00000000ffc00000)</div><div class="line"> Metaspace       used 2580K, capacity 4486K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 287K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">&#125;</div><div class="line">java.lang.OutOfMemoryError: Java heap space</div><div class="line">Dumping heap to java_pid17676.hprof ...</div><div class="line">Heap dump file created [1336934 bytes in 0.006 secs]</div><div class="line">Exception in thread "main" java.lang.OutOfMemoryError: Java heap space</div><div class="line">	at TestHeapOOM.main(TestHeapOOM.java:6)</div><div class="line"></div><div class="line">D:\testOOM&gt;</div></pre></td></tr></table></figure></p>
<p>我们来分析一下, 我们固定堆内存大小为10M, 新生代为4M. 我们看到PSYoungGen总共为3584K, 分别为eden区3072K, from survivor区为512K, 然后加上to survivor 区的512K, 总共为4096K. 老年代总共为6114K</p>
<p>我们来看一下第一次GC之前的内存分布情况: 此时程序已经进行了俩次内存分配, 在第三次的(分配6M 6114K的byte数组)时候触发了GC. 此时 新生代为3002K, 老年代为4096K, 我们可以推断出，第一次2M的byte数组应该是分配在了新生代, 而第二次的4M byte数组直接分配在了老年代.</p>
<p>而经过一次GC之后, 新生代使用了488K, 而老年代增长到4312K. 经过一次GC之后新生代消耗了<code>3002 - 488 -(4312 - 4096) = 2298</code>, 我们可以推断出第一次分配的那2M的byte数组被回收掉了.</p>
<p>接下来又进行了一次yong GC但是内存并没有发生什么变化,于是就发生了一次full GC.</p>
<p>第一次full GC(也就是invocations=3的时候)之后, 我们看到新生代被清空了, 老年代也只剩下了642K的内存被使用着, 我们推断应该是那个4M的byte数组被回收掉了. 但是此时要分配一个6M的byte数组,显然老年代是不够的. 于是在这次Full GC的时候又进行了一次GC操作, 但是内存仍然不够, 于是又产生了一次Full GC, 也就是full=2的那次. 但是很悲催, 内存仍然是不够用的, 于是就看到了java.lang.OutOfMemoryError: Java heap space, 同时生成了一个java_pid17676.hprof 的文件.</p>
<p>对于*.hprof文件。我们可以通过下列工具分析它</p>
<ul>
<li>Eclipse Memory Analyzer</li>
<li>JProfiler</li>
<li>jvisualvm</li>
<li>jhat</li>
</ul>
<p>由于我们从上面的GC日志中分析出了引发内存溢出的原因, 也就不再使用上列的工具分析*.hprof文件了,但是对于复杂的应用程序来说,如果发生了堆内存溢出的话, 使用上列工具分析的话,还是非常有必要的.</p>
<p>在分析这个文件的时候,我们重点确认内存中的对象是否是必要的,也就是弄清楚是引发了内存泄漏还是内存溢出.</p>
<ol>
<li>如果是内存泄漏可通过工具查看泄漏对象到GC Roots的引用链.于是就能找到泄漏对象是通过怎样的路径与GC Toots相关联,并导致垃圾收集器无法自动回收它们的. 掌握了泄漏对象的类型信息,以及GC Roots引用链信息,就可以比较准确地定位出泄漏代码的位置.</li>
<li>如果不存在泄漏, 换句话说就是内存中的对象确实还都必须存货着, 那就应当检查虚拟机的堆参数,与物理机内存对比查看是否还可以调大,从代码上检查是否存在某些生命周期过长,持有状态时间过长的情况,尝试减少程序运行周期的内存消耗.</li>
</ol>
<h2 id="DirectMemory-OOM"><a href="#DirectMemory-OOM" class="headerlink" title="DirectMemory OOM"></a>DirectMemory OOM</h2><p>溢出代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * VM Args: -Xmx20M -XX:MaxDirectMemorySize=10M</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectMemoryOOM</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> _1MB = <span class="number">1024</span> * <span class="number">1024</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Field unsafeField = Unsafe.class.getDeclaredFields()[<span class="number">0</span>];</div><div class="line">        unsafeField.setAccessible(<span class="keyword">true</span>);</div><div class="line">        Unsafe unsafe = (Unsafe)unsafeField.get(<span class="keyword">null</span>);</div><div class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)</div><div class="line">            unsafe.allocateMemory(_1MB);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>直接通过反射获取Unsafe实例并进行内存分配,Unsafe类的getUnsafe()方法限制了只有引导类加载器才会返回实例,也就是设计者希望只有rt.jar中的类才能使用unsafe的功能. 因为虽然使用DirectbyeBuffer分配内存也会抛出内存异常,但抛出异常时并没有真正向操作系统申请分配内存,而是通过计算得知内存无法分配,于是手动抛出异常,真正申请分配内存的方法是:unsafe.allocateMemory(_1MB);</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/09/06/jvm/JVM内存溢出/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/09/06/jvm/JVM内存溢出/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/09/04/jvm/JVM 方法调用/" title="JVM方法调用" itemprop="url">JVM方法调用</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-09-03T16:00:00.000Z" itemprop="datePublished"> 发表于 2014-09-04</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="动态连接"><a href="#动态连接" class="headerlink" title="动态连接"></a>动态连接</h2><p>每个栈帧内部都包含一个指向运行时常量池的引用来支持当前方法的代码实现动态连接.在Class文件中,描述一个方法调用其他方法,或者访问其他成员变量是通过符号引用来表示的.动态连接就是将这些符号引用所表示的方法转换为实际方法的直接引用.<br>类加载的过程中将要解析尚未被解析的符号引用, 并且将变量访问转换为访问这些变量的存储结构所在的运行时内存位置的正确偏移量.由于动态连接的存在,通过晚期绑定使用的其他类的方法和变量在发生变化时,将不会对调用他们的方法构成影响</p>
<p>每个栈帧都包含一个指向运行时常量池中该栈帧所属的方法引用,持有这个引用是为了支持调用过程中的<code>动态连接</code>.Class文件的常量池中存有大量的符号引用,字节码中的方法调用指令就以常量池中指向方法的符号引用为参数. 这些符号引用一部分会在类加载阶段或第一次使用的时候转化为直接引用,这种转化称为静态解析. 另外一部分将在每一次的运行期间转化为直接引用,这部分称为动态连接</p>
<h2 id="方法正常调用完成"><a href="#方法正常调用完成" class="headerlink" title="方法正常调用完成"></a>方法正常调用完成</h2><p>当前栈帧承担着恢复调用者状态的责任, 其状态包括调用这的局部变量表, 操作数栈以及被正确增加用来表示执行了该方法调用指令的程序计数器等。使得调用者的代码能在被调用的方法返回并且返回值被压入调用者栈帧的操作数栈后继续正常执行</p>
<h2 id="方法调用非正常完成"><a href="#方法调用非正常完成" class="headerlink" title="方法调用非正常完成"></a>方法调用非正常完成</h2><p>指的是在方法调用过程了,某些指令导致了虚拟机抛出异常,而且虚拟机抛出的异常在该方法中没办法处理,或者在执行过程中遇到athrow字节码指令抛出的显式异常,同时在方法内部没有捕获异常</p>
<h2 id="方法返回地址"><a href="#方法返回地址" class="headerlink" title="方法返回地址"></a>方法返回地址</h2><p>当一个方法执行后,有俩个方式退出这个地址.第一种方式是执行引擎遇到任意一个方法返回的字节码指令,这时候可能会有返回值传递给上层的方法调用者(调用当前方法的方法称为调用者),是否有返回值和返回值的类型将根据遇到何种方法返回指令来决定,这种退出方法的方式为正常完成出口.</p>
<p>另一种退出的方法是,在方法执行过程中遇到了异常,并且这个异常没有在方法体内得到处理,无论虚拟机内部产生的异常,还是代码中使用athrow字节码之类产生的异常,只要在本方法的异常表中没有搜索到匹配的异常处理器,就会导致方法退出,这种退出方法的方式称为异常完成出口.一个方法使用异常完成出口的方式退出,是不会给它的上层调用者产生任何返回值的.</p>
<p>无论采用何种退出方法,在方法退出之后,都需要返回到方法被调用的位置,程序才能继续执行,方法返回时可能需要在栈帧中保存一些信息,用来帮助恢复它的上层方法的执行状态.一般来说,方法正常退出时,调用者的PC计数器的值就可以作为返回地址,栈帧中很可能会保存这个计数器值.而方法异常退出时,返回地址是要通过异常处理器表来确定的,栈帧中一般不会保存这部分信息.</p>
<p>方法退出的过程实际上等同于把当前栈帧出栈,因此退出时可能执行的操作有:回复上层方法的局部变量表和操作数栈,把返回值(如果有的话)压入调用者栈帧的操作数栈中,调整PC计数器的值以执行方法调用指令后面的一条指令等.</p>
<h2 id="方法调用"><a href="#方法调用" class="headerlink" title="方法调用"></a>方法调用</h2><p>方法调用并不等于方法执行,方法调用阶段唯一的任务就是确定方法的版本号(即调用哪个方法),暂时还不涉及方法内部的具体运行过程.在承运运行时,进行方法调用是最普遍,最频繁的的操作,单前面已经讲过,Class文件的编译过程中不包含传统编译的连接步骤,一切方法调用在Class文件里面存储的都只是符号引用,而不是方法在实际运行时内存布局中的入口地址(相当于之前的所说的直接引用).这个特性给java带来了更加强大的动态拓展能力,但也使得java方法的调用过程变得相对复杂起来,需要在类加载期间甚至到运行期间才能确定目标方法的直接引用.</p>
<h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><p>继续前面关于方法调用的话题,所有方法调用中的目标方法在Class文件里面都是一个常量池中的符号引用,在类加载的解析极端,会将其中的一部分符号引用转化为直接引用,这种解析能够成立的前提是:方法在程序真正运行之前就有一个可确定的调用版本,并且这个方法在运行期是不可改变的.换句话说,调用目标在程序代码写好,编译器进行编译时就必须确定下来.这类方法的调用称为<code>解析(Resolution)</code>.</p>
<p>在java语言中,符合”编译器可知,运行期不可变”这个要求的方法主要是有静态方法和私有方法俩大类,前者与类型直接关联,后者在外部不可被访问,这俩种方法都不可能通过继承或别的方式重写出其他版本,因此他们都适合在类加载阶段进行解析.</p>
<p>与之对应的是,在java虚拟机里面提供了四条方法调用字节码指令:</p>
<ul>
<li><code>invokestatic</code>: 调用静态方法</li>
<li><code>invokespecial</code>:调用实例构造器<code>&lt;init&gt;</code>方法,私有方法和父类方法</li>
<li><code>invokevirtual</code>:调用所有的虚方法</li>
<li><code>invokeinterface</code>:调用接口方法,会在运行时再确定一个实现此接口的对象</li>
</ul>
<p>只要能被<code>invokestatic</code>, <code>invokespecial</code>指令调用的方法,都可以在解析阶段确定唯一的版本,符合这个条件的有静态方法,私有方法,实例构造器和父类方法四类,他们在类加载的时候就会把符号引用解析为该方法的直接引用.这些方法可以称为<code>非虚方法</code>,与此相反,其他方法就称为<code>虚方法</code>(除了final方法).下面的例子中最常见的解析调用的例子,此样例中,静态方法<code>sayHello()</code>只可能属于类型<code>StaticResolution</code>,没有任何手段可以覆盖或者隐藏这个方法.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticResolution</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"hello"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        StaticResolution.sayHello();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过javap查看字节码:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public static void main(java.lang.String[]);</div><div class="line">   descriptor: ([Ljava/lang/String;)V</div><div class="line">   flags: ACC_PUBLIC, ACC_STATIC</div><div class="line">   Code:</div><div class="line">     stack=0, locals=1, args_size=1</div><div class="line">        0: invokestatic  #5                  // Method sayHello:()V</div><div class="line">        3: return</div><div class="line">     LineNumberTable:</div><div class="line">       line 9: 0</div><div class="line">       line 10: 3</div></pre></td></tr></table></figure></p>
<p>java中的非虚方法除了使用<code>invokestatic</code>和<code>invokespecial</code>调用的方法之外还有一种,就是被<code>final</code>修饰的方法.虽然<code>final</code>方法是使用<code>invokespecial</code>指令来调用的,但是由于它无法被覆盖,没有其他版本,所以也无须对方法接受者进行多态选择,又或者说多态选择的结果是唯一的.在java语言规范中明确说明了final方法是一种非虚方法.</p>
<p>解析调用一定是个静态过程,在编译期间就完全确定,在类装载的解析阶段就会把涉及的符号引用全部转变为可确定的直接引用,不会延迟到运行期再去完成.而分派调用则可能是静态的也可能是动态的,根据分派依据的宗数量可分为单分派和多分派.这俩类分派方式俩俩组合就构成了静态单分派,静态多分派,动态单分派,动态多分派.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/09/04/jvm/JVM 方法调用/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/09/04/jvm/JVM 方法调用/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/09/03/jvm/JVM 内存分配/" title="JVM 内存分配" itemprop="url">JVM 内存分配</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-09-02T16:00:00.000Z" itemprop="datePublished"> 发表于 2014-09-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h2><p>JVM栈和常用的数据结构很相似,都是一种先进后出的数据结构. JVM栈是每个线程私有的内存空间.线程的基本行为就是方法调用, 而方法调用就是通过JVM栈传递的.每当我们创建一个线程对象的的时候, 都会创建一个JVM栈. 它的生命周期与线程相同.</p>
<p>JVM栈是由JVM栈帧组成的, 每次方法调用都会有一个JVM栈帧进入JVM栈,也称入栈, 当方法执行完(不管是return还是异常),栈帧都会被弹出JVM栈,也称出栈. 栈帧包含如下结构:</p>
<ul>
<li>PC寄存器</li>
<li>本地方法栈</li>
<li>局部变量表</li>
<li>操作数栈</li>
<li>动态连接</li>
<li>方法出口</li>
</ul>
<p>在java虚拟机中.对这个区域规定了俩种异常情况:</p>
<ol>
<li>如果请求的栈深度大于虚拟机所允许的深度,抛出<code>StackOverflowError</code></li>
<li>如果虚拟机可以动态扩展,当拓展时无法申请到足够的内存时会抛出<code>OutOfMemoryError</code>异常</li>
</ol>
<h3 id="PC寄存器"><a href="#PC寄存器" class="headerlink" title="PC寄存器"></a>PC寄存器</h3><p>每当我们创建一个线程的时候, 都会JVM都会附带着创建一个本线程私有的PC寄存器和虚拟机栈. PC寄存器用于存放当前线程执行的字节码指令(线程当前方法)地址. 字节码解释器通过修改寄存器里的值使线程完成下一个指令的执行. 分支,循环,跳转,异常处理,线程恢复等基础功能都需要依赖这个寄存器完成. 在一个单CPU的环境中, 一个多线程的程序通过轮流切换线程完成多线程运行. 那么在切换线程的时候, 被切换的线程对应的寄存器里的值被保存了下来, 当线程再切换回来的时候,线程得以继续运行.</p>
<blockquote>
<p>PC寄存器是唯一一个在java虚拟机规范中没有规定任何<code>OutOfMemoryError</code>情况的区域.</p>
</blockquote>
<h3 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h3><ul>
<li>用来支持native方法</li>
</ul>
<h3 id="操作数栈"><a href="#操作数栈" class="headerlink" title="操作数栈"></a>操作数栈</h3><p>每个栈帧内部都包含一个称为操作数栈的先进后出栈. 同局部变量表一样,操作数栈的最大深度也是在编译的时候被写入到Code属性的max_stacks数据项之中的.操作数栈的每一个元素都可以是任意的java数据类型,包括long和double(一个long或者double类型的数据会占用俩个单位的栈深度, 其他类型占用一个单位的栈深度). 32位的数据类型所占的栈容量为1,64位数据类型所占的栈容量为2.在方法执行的时候,操作数栈的深度都不会超过在max_stacks数据项中设定的最大值. </p>
<p>栈帧在刚创建的时候, 操作数栈是空的, JVM提供了一系列指令从局部变量表或者对象实例的字段中复制常量或变量值到操作数栈中.也提供了一些列指令从操作数栈取走, 操作数据, 以及把结果重新入栈. 也就是入栈和出栈操作.例如:在做算术运算的时候是通过操作数栈来进行的,又或者在调用其他方法的时候是通过操作数栈来进行参数传递的.参考<a href="http://www.yu66.wang/2014/09/08/jvm/%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4/">字节码指令</a></p>
<p>例如,整数加法的字节码指令iadd在运行的时候要求操作数栈中最接近栈顶的俩个元素已经存入了俩个int型的数值,当执行这个指令时,会将这俩个int值出栈并相加,然后将相加的结果入栈.</p>
<p>另外,在概念模型中,俩个栈帧为虚拟机栈的元素,相互之间是完全独立的.但是大多数虚拟机的实现里都会做一些优化处理,令俩个栈帧出现一部分重叠.让下面栈帧的部分操作数栈与上面栈帧的部分局部变量表重叠在一起,这样在进行方法调用时就可以共有一部分数据,而无需进行额外的参数复制传递:</p>
<h3 id="局部变量表"><a href="#局部变量表" class="headerlink" title="局部变量表"></a>局部变量表</h3><p>局部变量表存放基本类型的数据和对象的引用,但对象本身不存放在栈中,而是存放在堆中.</p>
<ul>
<li>其长度在编译器决定</li>
<li>一个局部变量称为一个Slot.每个Slot只可以保存一个<code>boolean, byte, char, short, int, float, reference,returnAddress</code>类型的数据.<code>long</code>或者<code>double</code>需要俩个Slot保存.</li>
<li>局部变量表来完成方法调用时的参数传递. (如果是实例方法, 第0个局部变量是用来存储调用实例方法的对象的引用)</li>
</ul>
<p>局部变量表中的Slot是可重用的, 我们看下面的例子:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CollectSlot</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">byte</span>[] byes3m = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">3</span> * <span class="number">1024</span> * <span class="number">1024</span>];</div><div class="line">		System.gc();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行一下上面的程序, 我们得到下面的结果<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">ζ java -XX:+PrintGCDetails -XX:MaxNewSize=1m -Xmx10M -Xms10M CollectSlot</div><div class="line">[GC (Allocation Failure) [PSYoungGen: 509K-&gt;488K(1024K)] 509K-&gt;504K(9728K), 0.0004559 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">[GC (System.gc()) [PSYoungGen: 745K-&gt;488K(1024K)] 3833K-&gt;3656K(9728K), 0.0005722 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">[Full GC (System.gc()) [PSYoungGen: 488K-&gt;0K(1024K)] [ParOldGen: 3168K-&gt;3614K(8704K)] 3656K-&gt;3614K(9728K), [Metaspace: 2572K-&gt;2572K(1056768K)], 0.0045062 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">Heap</div><div class="line"> PSYoungGen      total 1024K, used 10K [0x00000000ffe80000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 512K, 2% used [0x00000000ffe80000,0x00000000ffe82a68,0x00000000fff00000)</div><div class="line">  from space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 8704K, used 3614K [0x00000000ff600000, 0x00000000ffe80000, 0x00000000ffe80000)</div><div class="line">  object space 8704K, 41% used [0x00000000ff600000,0x00000000ff987840,0x00000000ffe80000)</div><div class="line"> Metaspace       used 2578K, capacity 4486K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 287K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">Java HotSpot(TM) 64-Bit Server VM warning: NewSize (1536k) is greater than the MaxNewSize (1024k). A new max generation size of 1536k will be used.</div></pre></td></tr></table></figure></p>
<p>在启动程序的时候, 我们将JVM堆内存设置为10M, 新生代为1M, 当我们在应用程序中分配3M内存的时候, byes3m这个对象就直接分配在了老年代中. 从GC日志的第一条中我们也可以看出, <code>[PSYoungGen: 509K-&gt;488K(1024K)]</code> 新生代已经使用了509k, 回收后488K, 总共1024k. 当调用<code>System.gc()</code>我们发现永久代的内存并没有回收掉，这也正是我们的预期</p>
<p>然后我们修改一下那个程序<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CollectSlot</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">byte</span>[] byes3m = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">3</span> * <span class="number">1024</span> * <span class="number">1024</span>];</div><div class="line">		byes3m = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">byte</span>[] byes3m_ = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">3</span> * <span class="number">1024</span> * <span class="number">1024</span>];</div><div class="line">		System.gc();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们将byes3m置为null, 看看其占用的内存会不会回收掉<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">ζ java -XX:+PrintGCDetails -XX:MaxNewSize=1m -Xmx10M -Xms10M CollectSlot</div><div class="line">[GC (Allocation Failure) [PSYoungGen: 509K-&gt;496K(1024K)] 509K-&gt;528K(9728K), 0.0005626 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">[GC (System.gc()) [PSYoungGen: 753K-&gt;488K(1024K)] 6929K-&gt;6744K(9728K), 0.0006016 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">[Full GC (System.gc()) [PSYoungGen: 488K-&gt;0K(1024K)] [ParOldGen: 6256K-&gt;3614K(8704K)] 6744K-&gt;3614K(9728K), [Metaspace: 2572K-&gt;2572K(1056768K)], 0.0045914 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">Heap</div><div class="line"> PSYoungGen      total 1024K, used 10K [0x00000000ffe80000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 512K, 2% used [0x00000000ffe80000,0x00000000ffe82a68,0x00000000fff00000)</div><div class="line">  from space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 8704K, used 3614K [0x00000000ff600000, 0x00000000ffe80000, 0x00000000ffe80000)</div><div class="line">  object space 8704K, 41% used [0x00000000ff600000,0x00000000ff987840,0x00000000ffe80000)</div><div class="line"> Metaspace       used 2578K, capacity 4486K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 287K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">Java HotSpot(TM) 64-Bit Server VM warning: NewSize (1536k) is greater than the MaxNewSize (1024k). A new max generation size of 1536k will be used.</div></pre></td></tr></table></figure></p>
<p>好，我们看到了<code>ParOldGen: 6256K-&gt;3614K(8704K)</code> 这句话, 说明已经有3M的内存被回收掉了。 </p>
<blockquote>
<p>赋null值的操作在经过虚拟机JIT编译器优化之后会被消除掉,这时候将变量设置为null实际上是没有意义的.因为我们的方法调用还没有达到JIT编译的次数, 因此在上面的例子中, 赋null值还是管用的, 但是在平时编码时,我们还是尽量不要依赖这种null赋值的操作</p>
</blockquote>
<p>下面我们再修改一下程序, 将其放在代码块中，这样placeholder1的slot就会被placeholder2复用,<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CollectSlot</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">byte</span>[] byes3m = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">3</span> * <span class="number">1024</span> * <span class="number">1024</span>];</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">byte</span>[] byes3m1 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">3</span> * <span class="number">1024</span> * <span class="number">1024</span>];</div><div class="line">		System.gc();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">ζ java -XX:+PrintGCDetails -XX:MaxNewSize=1m -Xmx10M -Xms10M CollectSlot</div><div class="line">[GC (Allocation Failure) [PSYoungGen: 509K-&gt;472K(1024K)] 509K-&gt;472K(9728K), 0.0006416 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">[GC (System.gc()) [PSYoungGen: 729K-&gt;488K(1024K)] 6873K-&gt;6752K(9728K), 0.0038950 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">[Full GC (System.gc()) [PSYoungGen: 488K-&gt;0K(1024K)] [ParOldGen: 6264K-&gt;3614K(8704K)] 6752K-&gt;3614K(9728K), [Metaspace: 2572K-&gt;2572K(1056768K)], 0.0045731 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">Heap</div><div class="line"> PSYoungGen      total 1024K, used 10K [0x00000000ffe80000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 512K, 2% used [0x00000000ffe80000,0x00000000ffe82a68,0x00000000fff00000)</div><div class="line">  from space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line"> ParOldGen       total 8704K, used 3614K [0x00000000ff600000, 0x00000000ffe80000, 0x00000000ffe80000)</div><div class="line">  object space 8704K, 41% used [0x00000000ff600000,0x00000000ff987840,0x00000000ffe80000)</div><div class="line"> Metaspace       used 2578K, capacity 4486K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 287K, capacity 386K, committed 512K, reserved 1048576K</div><div class="line">Java HotSpot(TM) 64-Bit Server VM warning: NewSize (1536k) is greater than the MaxNewSize (1024k). A new max generation size of 1536k will be used.</div></pre></td></tr></table></figure></p>
<p>在上面的GC日志中,我们同样看到<code>ParOldGen: 6264K-&gt;3614K(8704K)</code>说明在代码块里面的那3M内存也已经被回收掉了. 这段内存能被回收的关键就是byes3m1复用了byes3m局部变量表中的Slot.因此byes3m原来指向的堆内存就不存在引用了,在GC时,这段内存就被回收掉了.但是如果没有byes3m1这个对象创建的话,byes3m的虽然离开了其作用域,但是由于GCRoots还关联着对其的引用,因此也是不会被回收的.</p>
<p>这种代码在绝大部分情况下影响都非常小, 但是如果一个方法中有一些很耗时的操作, 同时又分配了很大的内存, 将这些不再使用的占大内存的变量放到代码块中就是一个比较好的操作了，所以我们应该以恰当的作用域来控制变量回收时间。</p>
<p>关于局部变量表,还有一点可能会对实际开发产生影响,就是局部变量表不像前面介绍的类变量那样存在”准备阶段”.类变量有俩次赋初始值的过程,一次在准备阶段,赋予系统初始值.另外一次在初始化阶段,赋予程序员定义的初始化. 因此即使在初始化阶段程序员没有为类变量赋值也没关系,类变量仍然具有一个确定的初始值. 但是局部变量就不一样了,如果一个局部变量定义了但没有赋初始值是不能使用的.</p>
<h2 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h2><p>我们首先看一下JVM堆内存的特点</p>
<ul>
<li>是供各个线程共享的运行时内存</li>
<li>所有类实例和数组对象分配内存的地方</li>
<li>存储了内存管理系统(GC)</li>
<li>堆内存可以处于物理上不连续的内存空间中,逻辑上是连续的即可.</li>
<li>如果在堆内中没有内存完成实例分配,而且堆无法再拓展时,会抛出OutOfMemoryError</li>
<li>随着JIT编译器的发展和逃逸分析技术的逐渐成熟,栈上分配,标量替换优化技术将会导致一些变化,所有的对象在堆上分配也不是那么绝对了</li>
</ul>
<p>然后我们看一下堆内存内部分配: 由于现在GC收集器基本都是采用的分代收集算法,所以java堆还可以细分为:新生代和老年代.分的再细一点还有Eden空间,From Survivor空间,To Sruvivor空间.</p>
<h3 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a>内存分配</h3><ol>
<li>新生代GC(<code>Minor GC</code>)：新生代GC, Java对象大多都朝生夕灭,所以<code>Minor GC</code>非常频繁,回收速度也比较快.</li>
<li>老年代GC(<code>Major GC/Full GC</code>)：老年代GC,出现了Major GC,经常会伴随至少一次的Minor GC. MajorGC的速度一般会比Minor GC慢10倍以上.</li>
</ol>
<h3 id="引用计数算法"><a href="#引用计数算法" class="headerlink" title="引用计数算法"></a>引用计数算法</h3><p>引用计数算法很难解决对象之间相互循环引用的问题<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceCountingGC</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> Object instance = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> _1MB = <span class="number">3</span> * <span class="number">1024</span> * <span class="number">1024</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">byte</span>[] bigSize = <span class="keyword">new</span> <span class="keyword">byte</span>[_1MB];</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		&#123;</div><div class="line">			ReferenceCountingGC obj1 = <span class="keyword">new</span> ReferenceCountingGC();</div><div class="line">			ReferenceCountingGC obj2 = <span class="keyword">new</span> ReferenceCountingGC();</div><div class="line"></div><div class="line">			obj1.instance = obj2;</div><div class="line">			obj2.instance = obj1;</div><div class="line">		&#125;</div><div class="line">		System.gc();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们运行<code>-XX:+PrintGCDetails -Xmx10M -Xms10M</code>得到结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[GC (System.gc()) [PSYoungGen: 1650K-&gt;504K(2560K)] 7794K-&gt;7001K(9728K), 0.0029060 secs] [Times: user=0.05 sys=0.00, real=0.00 secs]</div><div class="line">[Full GC (System.gc()) [PSYoungGen: 504K-&gt;0K(2560K)] [ParOldGen: 6497K-&gt;6952K(7168K)] 7001K-&gt;6952K(9728K), [Metaspace: 3051K-&gt;3051K(1056768K)], 0.0104574 secs] [Times: user=0.00 sys=0.00, real=0.01 secs]</div><div class="line">Heap</div><div class="line"> PSYoungGen      total 2560K, used 41K [0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000)</div><div class="line">  eden space 2048K, 2% used [0x00000000ffd00000,0x00000000ffd0a560,0x00000000fff00000)</div><div class="line">  from space 512K, 0% used [0x00000000fff00000,0x00000000fff00000,0x00000000fff80000)</div><div class="line">  to   space 512K, 0% used [0x00000000fff80000,0x00000000fff80000,0x0000000100000000)</div><div class="line"> ParOldGen       total 7168K, used 6952K [0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000)</div><div class="line">  object space 7168K, 96% used [0x00000000ff600000,0x00000000ffcca158,0x00000000ffd00000)</div><div class="line"> Metaspace       used 3058K, capacity 4494K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 331K, capacity 386K, committed 512K, reserved 1048576K</div></pre></td></tr></table></figure></p>
<p>我们看到GC之后这块内存并没有回收掉</p>
<h3 id="根搜索算法"><a href="#根搜索算法" class="headerlink" title="根搜索算法"></a>根搜索算法</h3><p>这个算法的基本思想是:通过一系列的名为”GC Roots”的对象作为起始点, 从这些起始点开始向下搜索,搜索所走过的路径称为引用链,当一个对象到GC Roots没有任何引用链时,则证明这个对象是不可到达的.</p>
<p>在java中可作为GC Roots的对象包括以下几种:</p>
<ol>
<li>虚拟机栈(栈帧中的本地变量表)中的引用对象.</li>
<li>方法区中的类静态属性引用的对象.</li>
<li>方法区中的常量引用对象</li>
<li>本地方法栈中JNI的引用的对象</li>
</ol>
<h4 id="新生代"><a href="#新生代" class="headerlink" title="新生代"></a>新生代</h4><p>新生代分为Eden区和Survivor区(Eden有一个, Survivor有俩个). 大多数情况下,对象在新生代<code>Eden</code>区中分配.当<code>Eden</code>区没有足够的空间进行分配时,虚拟机将发起一次<code>Minor GC</code>, 将存活下来的对象移动到一个Survivor区中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> _1MB = <span class="number">1024</span> * <span class="number">1024</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * VM参数：-verbose:gc -Xms20M -Xmx20M -Xmn10M -XX:SurvivorRatio=8</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testAllocation</span><span class="params">()</span> </span>&#123;</div><div class="line">	    <span class="keyword">byte</span>[] allocation1, allocation2, allocation3, allocation4;</div><div class="line">	    allocation1 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span> * _1MB];</div><div class="line">	    allocation2 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span> * _1MB];</div><div class="line">	    allocation3 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span> * _1MB];</div><div class="line">	    allocation4 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span> * _1MB];  <span class="comment">// 出现一次Minor GC</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>分析如下：</p>
<ol>
<li>首先在堆中分配3个2MB大小和1个4MB大小的byte数组, 在运行时通过<code>-Xms20M、 -Xmx20M</code>和<code>-Xmn10M</code>这3个参数限制Java堆大小为20MB,且不可扩展,其中10MB分配给新生代,剩下的10MB分配给老年代.</li>
<li><code>-XX:SurvivorRatio=8</code>决定了新生代中Eden区与一个<code>Survivor</code>区的空间比例是8比1,从输出的结果也能清晰地看到<code>“eden space 8192K、from space 1024K、to space 1024K”</code>的信息,新生代总可用空间为<code>9216KB</code>(<code>Eden</code>区+1个<code>Survivor</code>区的总容量).</li>
<li>执行<code>testAllocation()</code>中分配<code>allocation4</code>对象的语句时会发生一次Minor GC,这次GC的结果是新生代6651KB变为148KB,而总内存占用量则几乎没有减少(因为allocation1、2、3三个对象都是存活的,虚拟机几乎没有找到可回收的对象).</li>
<li>这次GC发生的原因是给allocation4分配内存的时候,发现Eden已经被占用了6MB,剩余空间已不足以分配allocation4所需的4MB内存,因此发生Minor GC.GC期间虚拟机又发现已有的3个2MB大小的对象全部无法放入Survivor空间(Survivor空间只有1MB大小),所以只好通过分配担保机制提前转移到老年代去.</li>
<li>这次GC结束后,4MB的allocation4对象被顺利分配在Eden中.因此程序执行完的结果是Eden占用4MB(被allocation4占用),Survivor空闲,老年代被占用6MB(被allocation1、2、3占用)</li>
</ol>
<h4 id="老年代"><a href="#老年代" class="headerlink" title="老年代"></a>老年代</h4><p>大对象和长期存活的对象会进入老年代。所谓大对象就是指,需要大量连续内存空间的Java对象,最典型的大对象就是那种很长的字符串及数组. 如果连续出现多个大对象, 会导致老年代频繁发生<code>Full GC</code>, 因此在写程序时应该避免频繁出现大对象.</p>
<p>我们可以使用<code>-XX:PretenureSizeThreshold</code>参数令大于这个值的对象直接在老年代中分配. 这样做的目的是避免在Eden区及两个Survivor区之间发生大量的内存拷贝(新生代采用复制算法收集内存).</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> _1MB = <span class="number">1024</span> * <span class="number">1024</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * VM参数：-verbose:gc -Xms20M -Xmx20M -Xmn10M -XX:SurvivorRatio=8</div><div class="line">  * -XX:PretenureSizeThreshold=3145728</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testPretenureSizeThreshold</span><span class="params">()</span> </span>&#123;</div><div class="line">	　<span class="keyword">byte</span>[] allocation;</div><div class="line">	　allocation = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span> * _1MB];  <span class="comment">//直接分配在老年代中</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们看到Eden空间几乎没有被使用,而老年代10MB的空间被使用了40%,也就是4MB的allocation对象直接就分配在老年代中,这是因为<code>PretenureSizeThreshold</code>被设置为3MB(就是3145728B,这个参数不能与<code>-Xmx</code>之类的参数一样直接写3MB),因此超过3MB的对象都会直接在老年代中进行分配.</p>
<blockquote>
<p>注意<code>PretenureSizeThreshold</code>参数只对Serial和ParNew两款收集器有效,<code>Parallel Scavenge</code>收集器不认识这个参数,<code>Parallel Scavenge</code>收集器一般并不需要设置.如果遇到必须使用此参数的场合,可以考虑ParNew加CMS的收集器组合.</p>
</blockquote>
<p>虚拟机给每个对象定义了一个对象年龄(Age)计数器.如果对象在Eden出生并经过第一次Minor GC后仍然存活,    并且能被Survivor容纳的话,将被移动到Survivor空间中,并将对象年龄设为1.对象在Survivor区中每熬过一次Minor GC,年龄就增加1岁,当它的年龄增加到一定程度(默认为15岁)时,就会被晋升到老年代中.对象晋升老年代的年龄阈值,可以通过参数<code>-XX:MaxTenuringThreshold</code>来设置.</p>
<p>大家可以分别以<code>-XX:MaxTenuringThreshold=1</code>和<code>-XX:MaxTenuringThreshold=15</code>两种设置来执行刚才示例. 例子中allocation1对象需要256KB的内存空间,Survivor空间可以容纳.当MaxTenuringThreshold=1时,allocation1对象在第二次GC发生时进入老年代,新生代已使用的内存GC后会非常干净地变成0KB.而MaxTenuringThreshold=15时,第二次GC发生后,allocation1对象则还留在新生代Survivor空间,这时候新生代仍然有404KB的空间被占用.</p>
<p>实例代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> _1MB = <span class="number">1024</span> * <span class="number">1024</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * VM参数：-verbose:gc -Xms20M -Xmx20M -Xmn10M</div><div class="line">  * -XX:SurvivorRatio=8 -XX:MaxTenuringThreshold=1</div><div class="line">  * -XX:+PrintTenuringDistribution</div><div class="line">  */</div><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testTenuringThreshold</span><span class="params">()</span> </span>&#123;</div><div class="line">	 <span class="keyword">byte</span>[] allocation1, allocation2, allocation3;</div><div class="line">	 allocation1 = <span class="keyword">new</span> <span class="keyword">byte</span>[_1MB / <span class="number">4</span>];</div><div class="line">	  <span class="comment">// 什么时候进入老年代取决于XX:MaxTenuringThreshold设置</span></div><div class="line">	 allocation2 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span> * _1MB];</div><div class="line">	 allocation3 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span> * _1MB];</div><div class="line">	 allocation3 = <span class="keyword">null</span>;</div><div class="line">	 allocation3 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span> * _1MB];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="动态年龄判断"><a href="#动态年龄判断" class="headerlink" title="动态年龄判断"></a>动态年龄判断</h5><p>为了能更好地适应不同程序的内存状况,虚拟机并不总是要求对象的年龄必须达到<code>MaxTenuringThreshold</code>才能晋升老年代,如果在<code>Survivor</code>空间中相同年龄所有对象大小的总和大于<code>Survivor</code>空间的一半,年龄大于或等于该年龄的对象就可以直接进入老年代,无须等到<code>MaxTenuringThreshold</code>中要求的年龄.</p>
<p>例如下例中设置参数<code>-XX: MaxTenuringThreshold=15</code>,会发现运行结果中<code>Survivor</code>的空间占用仍然为0%,而老年代比预期增加了<code>6%</code>,也就是说<code>allocation1、allocation2</code>对象都直接进入了老年代,而没有等到15岁的临界年龄.因为这两个对象加起来已经达到了512KB,并且它们是同年的,满足同年对象达到Survivor空间的一半规则.我们只要注释掉其中一个对象的new操作,就会发现另外一个不会晋升到老年代中去了.</p>
<p>示例代码<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">private static final int _1MB = 1024 #### 1024;</div><div class="line"></div><div class="line">/**</div><div class="line">  * VM参数：-verbose:gc -Xms20M -Xmx20M -Xmn10M</div><div class="line">  * -XX:SurvivorRatio=8 -XX:MaxTenuringThreshold=15</div><div class="line">  * -XX:+PrintTenuringDistribution</div><div class="line">  */</div><div class="line">@SuppressWarnings("unused")</div><div class="line">public static void testTenuringThreshold2() &#123;</div><div class="line">	 byte[] allocation1, allocation2, allocation3, allocation4;</div><div class="line">	 allocation1 = new byte[_1MB / 4];</div><div class="line">	  // allocation1+allocation2大于survivor空间的一半</div><div class="line">	 allocation2 = new byte[_1MB / 4];</div><div class="line">	 allocation3 = new byte[4 #### _1MB];</div><div class="line">	 allocation4 = new byte[4 #### _1MB];</div><div class="line">	 allocation4 = null;</div><div class="line">	 allocation4 = new byte[4 #### _1MB];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="空间分配担保"><a href="#空间分配担保" class="headerlink" title="空间分配担保"></a>空间分配担保</h4><p>在发生Minor GC时,虚拟机会检测之前每次晋升到老年代的平均大小是否大于老年代的剩余空间大小,如果大于,则改为直接进行一次Full GC.如果小于,则查看HandlePromotionFailure设置是否允许担保失败;如果允许,那只会进行Minor GC;如果不允许,则也要改为进行一次Full GC.</p>
<p>前面提到过,新生代使用复制收集算法,但为了内存利用率,只使用其中一个Survivor空间来作为轮换备份,因此当出现大量对象在Minor GC后仍然存活的情况时(最极端就是内存回收后新生代中所有对象都存活),就需要老年代进行分配担保,让Survivor    无法容纳的对象直接进入老年代.与生活中的贷款担保类似,老年代要进行这样的担保,前提是老年代本身还有容纳这些对象的    剩余空间,一共有多少对象会活下来,在实际完成内存回收之前是无法明确知道的,所以只好取之前每一次回收晋升到老年代对象容量的平均大小值作为经验值,与老年代的剩余空间进行比较,决定是否进行Full GC来让老年代腾出更多空间.</p>
<p>取平均值进行比较其实仍然是一种动态概率的手段,也就是说如果某次Minor GC存活后的对象突增,远远高于平均值的话,依然会导致担保失败(Handle Promotion Failure).如果出现了HandlePromotionFailure失败,    那就只好在失败后重新发起一次Full GC.虽然担保失败时绕的圈子是最大的,但大部分情况下都还是会将    HandlePromotionFailure开关打开,避免Full GC过于频繁,</p>
<p>示例代码<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">private static final int _1MB = 1024 #### 1024;</div><div class="line"></div><div class="line">/**</div><div class="line">  * VM参数：-verbose:gc -Xms20M -Xmx20M -Xmn10M</div><div class="line">  * -XX:SurvivorRatio=8 -XX:-HandlePromotionFailure</div><div class="line">  */</div><div class="line">@SuppressWarnings("unused")</div><div class="line">public static void testHandlePromotion() &#123;</div><div class="line">	 byte[] allocation1, allocation2, allocation3,</div><div class="line">	 allocation4, allocation5, allocation6, allocation7;</div><div class="line">	 allocation1 = new byte[2 #### _1MB];</div><div class="line">	 allocation2 = new byte[2 #### _1MB];</div><div class="line">	 allocation3 = new byte[2 #### _1MB];</div><div class="line">	 allocation1 = null;</div><div class="line">	 allocation4 = new byte[2 #### _1MB];</div><div class="line">	 allocation5 = new byte[2 #### _1MB];</div><div class="line">	 allocation6 = new byte[2 #### _1MB];</div><div class="line">	 allocation4 = null;</div><div class="line">	 allocation5 = null;</div><div class="line">	 allocation6 = null;</div><div class="line">	 allocation7 = new byte[2 #### _1MB];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="直接内存"><a href="#直接内存" class="headerlink" title="直接内存"></a>直接内存</h2><p>直接内存并不是虚拟机运行时数据区的一部分,也不是java虚拟机规范中定义的内存区域,但是这部分内存也被频繁使用,而且也会导致OutOfMemoryError异常出现</p>
<p>在JDK1.4引入的NIO类,一种基于通道与缓冲区的I/O方式,它可以利用Native函数库直接分配堆外内存,然后通过一个存储在java堆里面的DirectByteBuffer对象作为这块内存的引用进行操作.这样能在一些场景中显著提高性能,因为避免了java堆和Native堆中来回复制数据.</p>
<p>显然本机直接内存的分配不会收到java堆大小的限制,但是既然是内存,则肯定会收到本机总内存(包括RAM及SWAP区或者分页文件)及处理器寻址空间的限制.一般在配置虚拟机参数时,会genuine实际内存设置-Xmx等参数信息,但经常会忽略掉直接内存,使得各个区域的总和大于物理内存限制,从而导致动态拓展时,出现OutOfMemoryError.</p>
<h2 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h2><ul>
<li>虚拟机启动时创建</li>
<li>供各个线程共享的运行时内存</li>
<li>存储了每个类的结构信息, 运行时常量池, 静态变量,即时编译器编译后的代码, 方法数据, 构造函数, 普通方法的字节码内容</li>
<li>java虚拟机规范对这个区域的限制非常宽松,除了和java堆一样不需要连续的内存外,和可以实现固定大小或者可拓展的之外,还可以选择不实现垃圾收集.(在HotSop虚拟机中一般喜欢称这个区域为永久代)并非数据进入永久代就像其名字一样”永久存在”. 这个区域的回收目标是针对常量池的回收和对类型的卸载.</li>
<li>当方法区无法满足内存分配需求时,将抛出OutOfMemoryError.</li>
</ul>
<p>运行时常量池是方法区的一部分.</p>
<p>Class文件中除了有类的版本,字段,方法,接口等信息外,还有一项信息是常量池,用于存储编译器产生的各种字面量和符号引用.这部分内容将在类加载后存放到方法区的运行时常量池中.</p>
<p>运行时常量池相对于Class文件常量池的另外一个重要特征是具备动态性,java语言并不要求常量一定只能在编译器产生,也就是并非预置入Class文件常量池的内容才能进入方法区运行时常量池,运行期间也可能将新的常量放入常量池,这种特性被用到比较多的便是<code>String#intern()</code>在加载类和接口到虚拟机后就创建对应的常量池,其是Class文件中每个类或者接口常量池表的运行时表示.</p>
<p>它包含了从编译期克制的数值字面量到必须到运行期解析后才能获得的方法或字段引用</p>
<p>java 中的常量池,是为了方便快捷地创建某些对象而出现的,当需要一个对象时,就可以从池中取一个出来(如果池中没有则创建一个)， 则在需要重复创建相等变量时节省了很多时间 . 常量池其实也就是一个内存空间,不同于使用 <code>new</code> 关键字创建的对象所在的堆空间 . 常量池用来存放在编译期间就可以确定的数据,比如字符串等类型</p>
<p>在新生代,常规应用进行一次垃圾收集,一般可以收回70%-95%的空间,而永久代(方法区)远低于此.</p>
<p>永久代的垃圾回收主要是回收俩部分内容:</p>
<ul>
<li>废弃常量: 回收废弃常量与回收java堆中的对象非常类似.以常量池字面量回收为例,如果一个字符串”ABC”已经进入了常量池,但是当前系统中没有任何一个String对象是叫做”ABC”的,换句话说也就是没有任何String对象引用这个字面量,也没有其他地方引用这个字面量,如果这个时候发生内存回收,而且必要的话,这个”ABC”常量会被清除出常量池.常量池中的其他类(皆苦),方法,字段的符号引用也与此类似.</li>
<li>无用的类</li>
</ul>
<p>判断一个类是否是无用的类条件要苛刻的多. 要同时满足下面三个条件:</p>
<ol>
<li>该类的所有实例都已经被回收,也就是java堆中不存在该类的实例.<br.></br.></li>
<li>加载该类的ClassLoader已经被回收.<br.></br.></li>
<li>该类对应的java.lang.Class对象没有在任何地方被引用,无法在任何地方通过反射访问该类.</li>
</ol>
<p>虚拟机可以对满足上面三个条件的类进行回收,这里说的仅仅是可以,而不是和对象一样,不使用了就必然回收.是否对类进行回收HotSpot虚拟机提供了-Xnoclassgc参数进行控制,还可以使用<code>-verbose:Class</code>及<br><code>-XX:+TraceClassLoading</code>,<code>-XX:+TraceClassUnLoading</code>查看类的加载和卸载信息.<code>-verbose:Class</code>和<code>-XX:+TraceClassLoading</code>可以在Product版的虚拟机中使用,但是<code>-XX:+TraceClassLoading</code>参数需要fastdebug版的虚拟机支持</p>
<p>静态存储里存放程序运行时一直存在的数据 . 可用关键字 static 来标识一个对象的特定元素是静态的,被static 修饰的成员变量和成员方法独立于该类的任何对象,它不依赖类特定的实例,被类的所有实例共享 . 但 JAVA 对象本身不会存放在静态存储空间里,而只是把对象中的一些特殊元素放置这里 .</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/09/03/jvm/JVM 内存分配/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/09/03/jvm/JVM 内存分配/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/04/18/编程语言/Groovy JSON/" title="Groovy JSON" itemprop="url">Groovy JSON</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-04-18T07:00:00.000Z" itemprop="datePublished"> 发表于 2014-04-18</time>
    
  </p>
</header>
    <div class="article-content">
        
        <blockquote>
<p>本文是对Groovy部分官方文档进行了翻译</p>
</blockquote>
<p>Groovy 原生支持Groovy对象和JSON之间的转换. <code>groovy.json</code>包内的类用于JSON的序列化和解析功能</p>
<h2 id="JsonSlurper"><a href="#JsonSlurper" class="headerlink" title="JsonSlurper"></a>JsonSlurper</h2><p><code>JsonSlurper</code>用于将JSON文本或者其他数据内容解析成Groovy里的数据结构,例如<code>maps&lt;/code&gt;,</code>lists, 或者其他原生基本类型 <code>Integer&lt;/code&gt;,</code>Double, <code>Boolean&lt;/code&gt;,</code>String`。</p>
<p>这个类重载了很多方法, 而且还添加了一些特殊的方法, 例如<code>parseText&lt;/code&gt;,</code>parseFile<code>等.下面这个例子中我们使用了</code>parseText<code>方法, 它会解析一个JSON字符串, 然后递归地将它转换成</code>list, <code>map</code>结构. 一些其他的`parse* 方法和这个方法很类似, 都返回了JSON字符串, 只不过其他的方法接受的参数不一样.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> jsonSlurper = <span class="keyword">new</span> JsonSlurper()</div><div class="line"><span class="keyword">def</span> object = jsonSlurper.parseText(<span class="string">'&#123; "name": "John Doe" &#125; /* some comment */'</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> object <span class="keyword">instanceof</span> Map</div><div class="line"><span class="keyword">assert</span> object.name == <span class="string">'John Doe'</span></div></pre></td></tr></table></figure>
<p>需要注意的是, 产生的结果是一个纯map, 可以像一个普通的Groovy对象实例持有它. <code>JsonSlurper</code>根据<a href="http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf" target="_blank" rel="external">ECMA-404 JSON Interchange Standard</a>定义来解析JSON, 同时支持JavaScript的注释和时间类型.</p>
<p>除了支持maps之外, <code>JsonSlurper</code> 还支持将JSON数组解析成list的功能<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> jsonSlurper = <span class="keyword">new</span> JsonSlurper()</div><div class="line"><span class="keyword">def</span> object = jsonSlurper.parseText(<span class="string">'&#123; "myList": [4, 8, 15, 16, 23, 42] &#125;'</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> object <span class="keyword">instanceof</span> Map</div><div class="line"><span class="keyword">assert</span> object.myList <span class="keyword">instanceof</span> List</div><div class="line"><span class="keyword">assert</span> object.myList == [<span class="number">4</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">23</span>, <span class="number">42</span>]</div></pre></td></tr></table></figure></p>
<p>JSON标准上只支持下面这些原生数据类型：<code>string&lt;/code&gt;,</code>number, <code>object&lt;/code&gt;,</code>true, <code>false&lt;/code&gt;,</code>null. <code>JsonSlurper</code> 将那些JSON类型转换成Groovy类型.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> jsonSlurper = <span class="keyword">new</span> JsonSlurper()</div><div class="line"><span class="keyword">def</span> object = jsonSlurper.parseText <span class="string">'''</span></div><div class="line">    &#123; "simple": 123,</div><div class="line">      "fraction": 123.66,</div><div class="line">      "exponential": 123e12</div><div class="line">    &#125;'''</div><div class="line"></div><div class="line"><span class="keyword">assert</span> object <span class="keyword">instanceof</span> Map</div><div class="line"><span class="keyword">assert</span> object.simple.<span class="keyword">class</span> == Integer</div><div class="line"><span class="keyword">assert</span> object.fraction.<span class="keyword">class</span> == BigDecimal</div><div class="line"><span class="keyword">assert</span> object.exponential.<span class="keyword">class</span> == BigDecimal</div></pre></td></tr></table></figure></p>
<p><code>JsonSlurper</code> 生成的结果就是纯Groovy对象实例, 她的内部不会包含任何的JSON相关的类对象, 它的用法是相当透明的. 事实上<code>JsonSlurper</code>的结果遵循<code>GPath</code>表达式. <code>GPath</code>是一个非常强大的表达式语言, 它支持多种不同的数据格式(例如<code>XmlSlurper</code>支持<code>XML</code> 就是其中一个例子)</p>
<p>如果想要了解更多的内容, 你可以直接去<a href="http://docs.groovy-lang.org/latest/html/documentation/core-semantics.html#gpath_expressions" target="_blank" rel="external">GPath expressions</a>看一看.<br>下面给出了JSON类型与Groovy数据类型之间的对应关系.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">JSON			Groovy</div><div class="line">string			java.lang.String</div><div class="line">number			java.lang.BigDecimal or java.lang.Integer</div><div class="line">object			java.util.LinkedHashMap</div><div class="line">array			java.util.ArrayList</div><div class="line"><span class="literal">true</span>			<span class="literal">true</span></div><div class="line"><span class="literal">false</span>			<span class="literal">false</span></div><div class="line"><span class="literal">null</span>			<span class="literal">null</span></div><div class="line">date			java.util.Date based on the yyyy-MM-dd’T’<span class="string">HH:</span><span class="string">mm:</span>ssZ date format</div></pre></td></tr></table></figure></p>
<p>如果JSON中的一个值是<code>null&lt;/code&gt;,</code>JsonSlurper<code>支持它转换成Groovy中的</code>null.这就与其他JSON解析器形成了对比, 代表一个空值与库提供的单一对象。</p>
<h3 id="Parser-Variants"><a href="#Parser-Variants" class="headerlink" title="Parser Variants"></a>Parser Variants</h3><p>Groovy 有多个<code>JsonSlurper</code> 解析器实现. 每一个解析器都对应着不同的需求, 每一个特定的解析都能很好的处理特定需求, 所以默认的解析器并不是适应于所有的情况. 下面就对各个解析器做个简介:</p>
<p><code>JsonParserCharArray</code> 解析器接受一个JSON字符串, 然后其内部使用一个字节数组进行解析. During value conversion it copies character sub-arrays (a mechanism known as “chopping”) and operates on them.</p>
<ul>
<li><p><code>JsonFastParser</code>解析器是<code>JsonParserCharArray</code>解析器的变种, 它是最快的解析器. 尽管它是最快的,但是基于某些原因,它并不是默认的解析器. <code>JsonFastParser</code>解析器也被称为索引覆盖(index-overlay)解析器. 当解析给定JSON字符串的时候,该解析器会极力避免创建新的字节数组或者字符串实例. 它一直指向原生的字节数组。 另外, 它会尽可能的推迟对象的创建. If parsed maps are put into long-term caches care must be taken as the map objects might not be created and still consist of pointer to the original char buffer only. <code>JsonFastParser</code>采取了一种特殊的切割模型, 它会尽早地分割char buffer, 以便能维持一份对原生buffer比较小的拷贝. 如果你想使用<code>JsonFastParser&lt;/code&gt;, 那么给你的建议是保持</code>JsonFastParser`的JSON buffer在2MB左右, 而且时刻要保持长期缓存限制.</p>
</li>
<li><p><code>JsonParserLax</code> 是<code>JsonFastParser</code>的一个变种实现. 它与<code>JsonFastParser</code> 有一些相似的想能特点, 但是不同的是它不是仅仅依靠`ECMA-404 JSON grammar. 例如,在下面例子中它支持不带引号的字符串注释.</p>
</li>
</ul>
<p><code>JsonParserUsingCharacterSource</code> 用于解析非常大的文件. 它使用一种称为<code>“character windowing”</code>的技术去解析非常大(超过2MB)的JSON文件,而且性能上也非常稳定</p>
<p><code>JsonSlurper</code>的默认实现是 <code>JsonParserCharArray&lt;/code&gt;.</code>JsonParserType`包含了解析器种类的枚举类型:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Implementation					Constant</div><div class="line">JsonParserCharArray				JsonParserType#CHAR_BUFFER</div><div class="line">JsonFastParser					JsonParserType#INDEX_OVERLAY</div><div class="line">JsonParserLax					JsonParserType#LAX</div><div class="line">JsonParserUsingCharacterSource	JsonParserType#CHARACTER_SOURCE</div></pre></td></tr></table></figure>
<p>如果想要改变解析器的实现也非常简单, 只需要通过调用<code>JsonSlurper#setType()&lt;/code&gt;方法给</code>JsonParserType`设置上不同的值就可以了</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> jsonSlurper = <span class="keyword">new</span> JsonSlurper(<span class="string">type:</span> JsonParserType.INDEX_OVERLAY)</div><div class="line"><span class="keyword">def</span> object = jsonSlurper.parseText(<span class="string">'&#123; "myList": [4, 8, 15, 16, 23, 42] &#125;'</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> object <span class="keyword">instanceof</span> Map</div><div class="line"><span class="keyword">assert</span> object.myList <span class="keyword">instanceof</span> List</div><div class="line"><span class="keyword">assert</span> object.myList == [<span class="number">4</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">23</span>, <span class="number">42</span>]</div></pre></td></tr></table></figure>
<h3 id="JsonOutput"><a href="#JsonOutput" class="headerlink" title="JsonOutput"></a>JsonOutput</h3><p><code>JsonOutput</code>用于将Groovy对象序列化成JSON字符串.</p>
<p><code>JsonOutput</code> 重载了<code>toJson</code>静态方法. 每个不同的<code>toJson</code>方法都会接受一个不同的参数类型.</p>
<p><code>toJson</code>方法返回的是一个包含JSOn格式的字符串<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> json = JsonOutput.toJson([<span class="string">name:</span> <span class="string">'John Doe'</span>, <span class="string">age:</span> <span class="number">42</span>])</div><div class="line"></div><div class="line"><span class="keyword">assert</span> json == <span class="string">'&#123;"name":"John Doe","age":42&#125;'</span></div></pre></td></tr></table></figure></p>
<p><code>JsonOutput</code>不仅支持原生类型, map, list等类型序列化到JSON, 甚至还支持序列化`POGOs(一种比较老的Groovy对象)</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span> String name &#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> json = JsonOutput.toJson([ <span class="keyword">new</span> Person(<span class="string">name:</span> <span class="string">'John'</span>), <span class="keyword">new</span> Person(<span class="string">name:</span> <span class="string">'Max'</span>) ])</div><div class="line"></div><div class="line"><span class="keyword">assert</span> json == <span class="string">'[&#123;"name":"John"&#125;,&#123;"name":"Max"&#125;]'</span></div></pre></td></tr></table></figure>
<p>刚才那个例子中, JSON输出默认没有进行pretty输出. 因此<code>JsonSlurper</code>还提供了<code>prettyPrint</code>方法<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> json = JsonOutput.toJson([<span class="string">name:</span> <span class="string">'John Doe'</span>, <span class="string">age:</span> <span class="number">42</span>])</div><div class="line"></div><div class="line"><span class="keyword">assert</span> json == <span class="string">'&#123;"name":"John Doe","age":42&#125;'</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> JsonOutput.prettyPrint(json) == <span class="string">'''\</span></div><div class="line">&#123;</div><div class="line">    "name": "John Doe",</div><div class="line">    "age": 42</div><div class="line">&#125;'''.stripIndent()</div></pre></td></tr></table></figure></p>
<p><code>prettyPrint</code>方法只接受一个String类型的字符串, 它不能和<code>JsonOutput</code>里其他的方式结合起来使用, it can be applied on arbitrary JSON String instances.</p>
<p>在Groovy中还可以使用<code>JsonBuilder&lt;/code&gt;,</code>StreamingJsonBuilder<code>方式创建JSON. 这俩个构建起都提供了一个</code>DSL, 当构建器生成一个JSON的时候,可以制定一个对象图.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// an inclusive range</span></div><div class="line"><span class="keyword">def</span> range = <span class="string">'a'</span>..<span class="string">'d'</span></div><div class="line"><span class="keyword">assert</span> range.size() == <span class="number">4</span></div><div class="line"><span class="keyword">assert</span> range.get(<span class="number">2</span>) == <span class="string">'c'</span></div><div class="line"><span class="keyword">assert</span> range[<span class="number">2</span>] == <span class="string">'c'</span></div><div class="line"><span class="keyword">assert</span> range <span class="keyword">instanceof</span> java.util.List</div><div class="line"><span class="keyword">assert</span> range.contains(<span class="string">'a'</span>)</div><div class="line"><span class="keyword">assert</span> range.contains(<span class="string">'d'</span>)</div><div class="line"><span class="keyword">assert</span> !range.contains(<span class="string">'e'</span>)</div></pre></td></tr></table></figure>
<p>You can iterate on a range using a classic for loop:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.10</span>) &#123;</div><div class="line">    println <span class="string">"Hello $&#123;i&#125;"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>but alternatively you can achieve the same effect in a more Groovy idiomatic style, by iterating a range with each method:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(<span class="number">1.</span><span class="number">.10</span>).each &#123; i -&gt;</div><div class="line">    println <span class="string">"Hello $&#123;i&#125;"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Ranges can be also used in the switch statement:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">switch</span> (years) &#123;</div><div class="line">    <span class="keyword">case</span> <span class="number">1.</span><span class="number">.10</span>: interestRate = <span class="number">0.076</span>; <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> <span class="number">11.</span><span class="number">.25</span>: interestRate = <span class="number">0.052</span>; <span class="keyword">break</span>;</div><div class="line"><span class="symbol">    default:</span> interestRate = <span class="number">0.037</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/04/18/编程语言/Groovy JSON/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/04/18/编程语言/Groovy JSON/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/04/17/编程语言/Groovy ANT/" title="Groovy ANT" itemprop="url">Groovy ANT</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-04-17T07:00:00.000Z" itemprop="datePublished"> 发表于 2014-04-17</time>
    
  </p>
</header>
    <div class="article-content">
        
        <blockquote>
<p>本文是对Groovy部分官方文档进行了翻译</p>
</blockquote>
<p>虽然<code>Ant</code>只是一个构建工具, 但其提供了例如能够操作文件(包括zip文件), 拷贝, 资源管理等诸多实用功能. 然而如果你不喜欢使用<code>build.xml</code>文件或者<code>Jelly</code>脚本, 而是想要一种清晰简洁的构建方式, 那么你就可以试试使用Groovy编写构建过程.</p>
<p>Groovy提供了一个辅助类<code>AntBuilder</code>帮忙编写Ant构建任务. 它看起来很像一个不带尖括号的Ant’s XML的简洁版本. 因此你可以在脚本中混合和匹配标记. Ant本身是一组Jar文件的集合. 将这组jar文件添加到你的classpath上, 你就可以在Groovy中轻轻松松的使用它们.</p>
<p><code>AntBuilder</code>通过便捷的构造器语法直接暴露了Ant task. 下面是一个简单的示例, 它的功能是在标准输出上输出一条消息.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> ant = <span class="keyword">new</span> AntBuilder()          </div><div class="line">ant.echo(<span class="string">'hello from Ant!'</span>)</div></pre></td></tr></table></figure></p>
<ol>
<li>创建一个<code>AntBuilder</code>实例</li>
<li>执行<code>AntBuilder</code>实例的echo task</li>
</ol>
<p>假设,现在你需要创建一个ZIP文件：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> ant = <span class="keyword">new</span> AntBuilder()</div><div class="line">ant.zip(<span class="string">destfile:</span> <span class="string">'sources.zip'</span>, <span class="string">basedir:</span> <span class="string">'src'</span>)</div></pre></td></tr></table></figure></p>
<p>在下面的例子中, 我们将展示在Groovy中使用传统的Ant 模式通过<code>AntBuilder</code>拷贝一组文件.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lets just call one task</span></div><div class="line">ant.echo(<span class="string">"hello"</span>)</div><div class="line"></div><div class="line"><span class="comment">// here is an example of a block of Ant inside GroovyMarkup</span></div><div class="line">ant.sequential &#123;</div><div class="line">    echo(<span class="string">"inside sequential"</span>)</div><div class="line">    <span class="keyword">def</span> myDir = <span class="string">"target/AntTest/"</span></div><div class="line">    mkdir(<span class="string">dir:</span> myDir)</div><div class="line">    copy(<span class="string">todir:</span> myDir) &#123;</div><div class="line">        fileset(<span class="string">dir:</span> <span class="string">"src/test"</span>) &#123;</div><div class="line">            include(<span class="string">name:</span> <span class="string">"**/*.groovy"</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    echo(<span class="string">"done"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// now lets do some normal Groovy again</span></div><div class="line"><span class="keyword">def</span> file = <span class="keyword">new</span> File(ant.project.baseDir,<span class="string">"target/AntTest/groovy/util/AntTest.groovy"</span>)</div><div class="line"><span class="keyword">assert</span> file.exists()</div></pre></td></tr></table></figure></p>
<p>下面的例子是遍历一组文件, 然后将每个文件根据特殊模式进行匹配.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lets create a scanner of filesets</span></div><div class="line"><span class="keyword">def</span> scanner = ant.fileScanner &#123;</div><div class="line">    fileset(<span class="string">dir:</span><span class="string">"src/test"</span>) &#123;</div><div class="line">        include(<span class="string">name:</span><span class="string">"**/Ant*.groovy"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// now lets iterate over</span></div><div class="line"><span class="keyword">def</span> found = <span class="literal">false</span></div><div class="line"><span class="keyword">for</span> (f <span class="keyword">in</span> scanner) &#123;</div><div class="line">    println(<span class="string">"Found file $f"</span>)</div><div class="line">    found = <span class="literal">true</span></div><div class="line">    <span class="keyword">assert</span> f <span class="keyword">instanceof</span> File</div><div class="line">    <span class="keyword">assert</span> f.name.endsWith(<span class="string">".groovy"</span>)</div><div class="line">&#125;</div><div class="line"><span class="keyword">assert</span> found</div></pre></td></tr></table></figure></p>
<p>Or execute a JUnit test:</p>
<p>下面我们执行JUnit<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lets create a scanner of filesets</span></div><div class="line">ant.junit &#123;</div><div class="line">    test(<span class="string">name:</span><span class="string">'groovy.util.SomethingThatDoesNotExist'</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在, 让我们的步子迈地更大一点：在Groovy中编译然后执行一个Java文件.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ant.echo(<span class="string">file:</span><span class="string">'Temp.java'</span>, <span class="string">'''</span></div><div class="line">    class Temp &#123;</div><div class="line">        public static void main(String[] args) &#123;</div><div class="line">            System.out.println("Hello");</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">''')</div><div class="line">ant.javac(<span class="string">srcdir:</span><span class="string">'.'</span>, <span class="string">includes:</span><span class="string">'Temp.java'</span>, <span class="string">fork:</span><span class="string">'true'</span>)</div><div class="line">ant.java(<span class="string">classpath:</span><span class="string">'.'</span>, <span class="string">classname:</span><span class="string">'Temp'</span>, <span class="string">fork:</span><span class="string">'true'</span>)</div><div class="line">ant.echo(<span class="string">'Done'</span>)</div></pre></td></tr></table></figure></p>
<p>需要提及的是, <code>AntBuilder</code>是内嵌于<code>Gradle</code>中的. 你可以像在Groovy中那样, 在<code>Gradle</code>使用<code>AntBuilder</code></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/04/17/编程语言/Groovy ANT/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/04/17/编程语言/Groovy ANT/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/04/16/编程语言/Groovy 字符串/" title="Groovy 字符串" itemprop="url">Groovy 字符串</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-04-16T07:00:00.000Z" itemprop="datePublished"> 发表于 2014-04-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <blockquote>
<p>本文是对Groovy部分官方文档进行了翻译</p>
</blockquote>
<p>在Groovy文本字面量被称为String,这是以字符链的形式出现的. Groovy允许你实例化<code>java.lang.String</code>,像  GStrings (<code>groovy.lang.GString</code>)那样, (GString还被称为插值字符串)</p>
<h3 id="单引号字符"><a href="#单引号字符" class="headerlink" title="单引号字符"></a>单引号字符</h3><p>单引号字符串是通过单引号括起来的一列字符<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'a single quoted string'</span></div></pre></td></tr></table></figure></p>
<p>单引号字符和<code>java.lang.String</code>是同一个东西, 同时它也不允许插值的出现</p>
<h3 id="字符串连接"><a href="#字符串连接" class="headerlink" title="字符串连接"></a>字符串连接</h3><p>Groovy里所有的字符串都可以通过 <code>+</code> 连接起来<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> <span class="string">'ab'</span> == <span class="string">'a'</span> + <span class="string">'b'</span></div></pre></td></tr></table></figure></p>
<h3 id="三重单引号字符串"><a href="#三重单引号字符串" class="headerlink" title="三重单引号字符串"></a>三重单引号字符串</h3><p>三重单引号字符串 是通过三个单引号 包围起来的字符序列.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'''a triple single quoted string'''</span></div></pre></td></tr></table></figure></p>
<p>三重单引号字符串就是纯<code>java.lang.String</code> 而且不允许插值.<br>三重单引号字符串可以多行赋值.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> aMultilineString = <span class="string">'''line one</span></div><div class="line">line two</div><div class="line">line three'''</div></pre></td></tr></table></figure></p>
<p>如果你的代码进行了缩进, 例如类中的方法体, 那跨行的三重单引号字符串也会包含缩进. 不过可以调用<code>String#stripIndent()</code> 去除掉缩进. <code>String#stripMargin()</code>方法会通过分割符从字符串的开头<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> startingAndEndingWithANewline = <span class="string">'''</span></div><div class="line">line one</div><div class="line">line two</div><div class="line">line three</div><div class="line">'''</div></pre></td></tr></table></figure></p>
<p>你也许会注意到最终得到的字符串会包含一个换行符.It is possible to strip that character by escaping the newline with a backslash:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> strippedFirstNewline = <span class="string">'''\</span></div><div class="line">line one</div><div class="line">line two</div><div class="line">line three</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">assert</span> !strippedFirstNewline.startsWith(<span class="string">'\n'</span>)</div></pre></td></tr></table></figure></p>
<h4 id="更换特殊字符"><a href="#更换特殊字符" class="headerlink" title="更换特殊字符"></a>更换特殊字符</h4><p>可以通过<code>\</code>字符在<code>&#39;&#39;</code>继续引用<code>&#39;</code><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'an escaped single quote: \' needs a backslash'</span></div></pre></td></tr></table></figure></p>
<p>当然也可以通过<code>\</code>来引用它自身<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'an escaped escape character: \\ needs a double backslash'</span></div></pre></td></tr></table></figure></p>
<p>还有一些其他的特殊字符需要<code>\</code>来引用<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Escape sequence	Character</div><div class="line"><span class="string">'\t'</span>	tabulation</div><div class="line"><span class="string">'\b'</span>	backspace</div><div class="line"><span class="string">'\n'</span>	newline</div><div class="line"><span class="string">'\r'</span>	carriage <span class="keyword">return</span></div><div class="line"><span class="string">'\f'</span>	formfeed</div><div class="line"><span class="string">'\\'</span>	backslash</div><div class="line"><span class="string">'\''</span>	single quote (<span class="keyword">for</span> single quoted and triple single quoted strings)</div><div class="line"><span class="string">'\"'</span>	<span class="keyword">double</span> quote (<span class="keyword">for</span> <span class="keyword">double</span> quoted and triple <span class="keyword">double</span> quoted strings)</div></pre></td></tr></table></figure></p>
<h4 id="Unicode-转义序列"><a href="#Unicode-转义序列" class="headerlink" title="Unicode 转义序列"></a>Unicode 转义序列</h4><p>有一些字符并不能通过键盘输出, 那么此时就可以通过Unicode 转义序列来实现. 例如<code>backslash</code>, 在u后跟4个16进制数字即可.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'The Euro currency symbol: \u20AC'</span></div></pre></td></tr></table></figure>
<h3 id="双引号包含的-string"><a href="#双引号包含的-string" class="headerlink" title="双引号包含的 string"></a>双引号包含的 string</h3><p>通过双引号包括起来的字符串<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"a double quoted string"</span></div></pre></td></tr></table></figure></p>
<p>当双引号字符串内没有插值(<code>${}</code>)的时候, 那它就等同于<code>java.lang.String</code>, 当有插值的时候那么双引号字符串就是<code>groovy.lang.GString</code>的实例</p>
<h4 id="String-插值"><a href="#String-插值" class="headerlink" title="String 插值"></a>String 插值</h4><p>任何表达式都可以嵌入到除了单引号和三引号的所有字符串常量中. 当对字符串求值的时候, 插值会使用他的值来替换掉字符串里的占位符. 占位符表达式通过<code>${}</code> 或者 <code>$</code>来实现. 占位符里的表达式值会被转换成其字符串表示形式, 转换是通过调用表达式<code>toString()</code>方法,通过传递一个String参数.</p>
<p>下面的例子展示的是字符串里的占位符定位本地变量<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> name = <span class="string">'Guillaume'</span> <span class="comment">// a plain string</span></div><div class="line"><span class="keyword">def</span> greeting = <span class="string">"Hello $&#123;name&#125;"</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> greeting.toString() == <span class="string">'Hello Guillaume'</span></div></pre></td></tr></table></figure></p>
<p>但是并非所有的表达式都是合法的, 像下面我们列举的这个算术表达式</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> sum = <span class="string">"The sum of 2 and 3 equals $&#123;2 + 3&#125;"</span></div><div class="line"><span class="keyword">assert</span> sum.toString() == <span class="string">'The sum of 2 and 3 equals 5'</span></div></pre></td></tr></table></figure>
<p>其实并不是只有表达式允许出现在<code>${}</code>表达式里. Statements 同样可以在<code>${}</code> 占位符里出现, 但是statement的值会是null. 如果有N个statements出现在<code>${}</code>里,那么最后一个statement应该返回一个有效值,以便被插入到字符串里. 例如<code>&quot;The sum of 1 and 2 is equal to ${def a = 1; def b = 2; a + b}&quot;</code> 是允许的,而且也会像语法预期的那样执行, 但是习惯上,GString 占位符里应该更多的是使用简单表达式.<br>除了<code>${}</code>占位符之外, 我们也可以使用<code>$</code>标记前缀点缀表达式：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> person = [<span class="string">name:</span> <span class="string">'Guillaume'</span>, <span class="string">age:</span> <span class="number">36</span>]</div><div class="line"><span class="keyword">assert</span> <span class="string">"$person.name is $person.age years old"</span> == <span class="string">'Guillaume is 36 years old'</span></div></pre></td></tr></table></figure>
<p>但是仅仅一下形式的点缀表达式是合法的：a.b, a.b.c,etc.但是那些包含括号的表达式(例如方法调用,花括号为闭包,算术运算符)是无效的.<br>下面给出了一个定义成数字形式的变量.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> number = <span class="number">3.14</span></div></pre></td></tr></table></figure></p>
<p>下面的 statement 将会抛出一个<code>groovy.lang.MissingPropertyException</code> 异常,因为Groovy认为你正在尝试访问那个数字的不存在的toString属性.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">shouldFail(MissingPropertyException) &#123;</div><div class="line">    println <span class="string">"$number.toString()"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>你可以理解成解析器会将<code>&quot;$number.toString()&quot;</code> 解释成 <code>&quot;${number.toString}()&quot;</code>.如果你想要在GString中避免<code>$</code>或者<code>${}</code> 称为插值的话,只需要在它们前面加上<code>\</code>即可.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> <span class="string">'$&#123;name&#125;'</span> == <span class="string">"\$&#123;name&#125;"</span></div></pre></td></tr></table></figure>
<h4 id="特殊插值形式-闭包表达式"><a href="#特殊插值形式-闭包表达式" class="headerlink" title="特殊插值形式-闭包表达式"></a>特殊插值形式-闭包表达式</h4><p>到目前为止,我们看到可以在${}占位符里插入任何的表达式, 但还有一种特殊的表达式-闭包表达式. 当占位符内好汉一个箭头时<code>${→}</code>,这个表达式实际上就是一个闭包表达式.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> sParameterLessClosure = <span class="string">"1 + 2 == $&#123;-&gt; 3&#125;"</span> (<span class="number">1</span>)</div><div class="line"><span class="keyword">assert</span> sParameterLessClosure == <span class="string">'1 + 2 == 3'</span></div><div class="line"></div><div class="line"><span class="keyword">def</span> sOneParamClosure = <span class="string">"1 + 2 == $&#123; w -&gt; w &lt;&lt; 3&#125;"</span> (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> sOneParamClosure == <span class="string">'1 + 2 == 3'</span></div></pre></td></tr></table></figure>
<ol>
<li>由于闭包不用声明参数, 所以在使用闭包时,我们不必对其传参</li>
<li>上例中,闭包中使用了一个<code>java.io.StringWriter argument</code>参数, 我们可以使用<code>&lt;&lt;</code>操作符添加内容.不论任何情况, 占位符都被嵌入了闭包.</li>
</ol>
<p>上面的表达式看起来更像是使用了一个啰嗦的方式去定义插值表达式, 但是闭包有个有趣又高级的特性：惰性计算:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> number = <span class="number">1</span> (<span class="number">1</span>)</div><div class="line"><span class="keyword">def</span> eagerGString = <span class="string">"value == $&#123;number&#125;"</span></div><div class="line"><span class="keyword">def</span> lazyGString = <span class="string">"value == $&#123; -&gt; number &#125;"</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> eagerGString == <span class="string">"value == 1"</span> (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> lazyGString ==  <span class="string">"value == 1"</span> (<span class="number">3</span>)</div><div class="line"></div><div class="line">number = <span class="number">2</span> (<span class="number">4</span>)</div><div class="line"><span class="keyword">assert</span> eagerGString == <span class="string">"value == 1"</span> (<span class="number">5</span>)</div><div class="line"><span class="keyword">assert</span> lazyGString ==  <span class="string">"value == 2"</span> (<span class="number">6</span>)</div></pre></td></tr></table></figure>
<ol>
<li>我们定义了数值为1的number类型变量, 它稍后会作为插值出现在俩个GString中,</li>
<li>我们希望eagerGString 产生的字符串包含着相同的值 1</li>
<li>同样我们也希望lazyGString 产生的字符串包含着相同的值 1</li>
<li>然后我们将number改变一个值.</li>
<li>With a plain interpolated expression, the value was actually bound at the time of creation of the GString.</li>
<li>But with a closure expression, the closure is called upon each coercion of the GString into String, resulting in an updated string containing the new number value.</li>
</ol>
<p>An embedded closure expression taking more than one parameter will generate an exception at runtime. Only closures with zero or one parameters are allowed.</p>
<h4 id="Inteoperability-with-Java"><a href="#Inteoperability-with-Java" class="headerlink" title="Inteoperability with Java"></a>Inteoperability with Java</h4><p>当一个方法(不管是在Java还是在Groovy中定义的)带有一个<code>java.lang.String</code>参数, 但我们传递一个<code>groovy.lang.GString instance</code>实例, GString会自动调用toString()方法.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">String takeString(String message) &#123;         (<span class="number">4</span>)</div><div class="line">    <span class="keyword">assert</span> message <span class="keyword">instanceof</span> String        (<span class="number">5</span>)</div><div class="line">    <span class="keyword">return</span> message</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> message = <span class="string">"The message is $&#123;'hello'&#125;"</span>   (<span class="number">1</span>)</div><div class="line"><span class="keyword">assert</span> message <span class="keyword">instanceof</span> GString           (<span class="number">2</span>)</div><div class="line"></div><div class="line"><span class="keyword">def</span> result = takeString(message)            (<span class="number">3</span>)</div><div class="line"><span class="keyword">assert</span> result <span class="keyword">instanceof</span> String</div><div class="line"><span class="keyword">assert</span> result == <span class="string">'The message is hello'</span></div></pre></td></tr></table></figure>
<ol>
<li>首先我们创建一个GString变量</li>
<li>然后我们检查一下声明的变量是否是GString的实例</li>
<li>接着我们向一个方法(参数为String类型)传递GString类型变量</li>
<li>takeString()显式地指出了它唯一的参数为String</li>
<li>我们再次验证所需的参数是String 而不是GString</li>
</ol>
<h4 id="GString-and-String-hashCodes"><a href="#GString-and-String-hashCodes" class="headerlink" title="GString and String hashCodes"></a>GString and String hashCodes</h4><p>尽管插值字符串能被用来代替<code>Java strings</code>, 但是他们在某些地方并不是完全一样的—— 他们的hashCodes是不同的. Java Strig是<code>immutable</code>, 然而, GString通过它的内插值 生成的字符串是可以改变的. 即使生成完全一样的字符串, GStrings 和 Strings的 hashCode 仍然是不一样的.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> <span class="string">"one: $&#123;1&#125;"</span>.hashCode() != <span class="string">"one: 1"</span>.hashCode()</div></pre></td></tr></table></figure>
<p>GString 和 Strings 拥有不同的hashCode值, 在Map中应该避免使用GString作为key, 特别的,当我们想要检索值的之后应该使用String,而不是GString.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> key = <span class="string">"a"</span></div><div class="line"><span class="keyword">def</span> m = [<span class="string">"$&#123;key&#125;"</span>: <span class="string">"letter $&#123;key&#125;"</span>]     (<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> m[<span class="string">"a"</span>] == <span class="literal">null</span>                   (<span class="number">2</span>)</div></pre></td></tr></table></figure></p>
<ol>
<li>map使用一对键值被创建了出来,其key是GString类型</li>
<li>当我们通过一个String类型的key进行检索值的时候,我们会得到一个null的结果, 产生这样的现象正是由于String和GString拥有不同的hashCode</li>
</ol>
<h3 id="Triple-double-quoted-string"><a href="#Triple-double-quoted-string" class="headerlink" title="Triple double quoted string"></a>Triple double quoted string</h3><p>三重双引号字符串其使用和双引号字符串及其相像, 但与双引号字符串不同的一点是：它们是可以换行的(像三重单引号字符串那样)<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> name = <span class="string">'Groovy'</span></div><div class="line"><span class="keyword">def</span> template = <span class="string">"""</span></div><div class="line">    Dear Mr $&#123;name&#125;,</div><div class="line"></div><div class="line">    You're the winner of the lottery!</div><div class="line"></div><div class="line">    Yours sincerly,</div><div class="line"></div><div class="line">    Dave</div><div class="line">"""</div><div class="line"></div><div class="line"><span class="keyword">assert</span> template.toString().contains(<span class="string">'Groovy'</span>)</div></pre></td></tr></table></figure></p>
<p>在三重双引号字符串中,不管是双引号还是单引号都不需要escaped</p>
<h3 id="Slashy-string"><a href="#Slashy-string" class="headerlink" title="Slashy string"></a>Slashy string</h3><p>除了引号字符串, Groovy还提供了slashy字符串(使用/作为分隔符). Slashy字符串对定义正则表达式和正则模式是非常有用的.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> fooPattern = <span class="regexp">/.*foo.*/</span></div><div class="line"><span class="keyword">assert</span> fooPattern == <span class="string">'.*foo.*'</span></div></pre></td></tr></table></figure>
<p>只有在<code>/ slashes</code>中需要使用\ 来escaped<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> escapeSlash = <span class="regexp">/The character \/</span> is a forward slash/</div><div class="line"><span class="keyword">assert</span> escapeSlash == <span class="string">'The character / is a forward slash'</span></div></pre></td></tr></table></figure></p>
<p>Slashy字符串也可以是多行的<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> multilineSlashy = /one</div><div class="line">    two</div><div class="line">    three/</div><div class="line"></div><div class="line"><span class="keyword">assert</span> multilineSlashy.contains(<span class="string">'\n'</span>)</div></pre></td></tr></table></figure></p>
<p>Slashy字符串也可以插值形式出现(像GString一样)<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> color = <span class="string">'blue'</span></div><div class="line"><span class="keyword">def</span> interpolatedSlashy = <span class="regexp">/a $&#123;color&#125; car/</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> interpolatedSlashy == <span class="string">'a blue car'</span></div></pre></td></tr></table></figure></p>
<p>下面有一些常识方面的东西需要你知道：<br><code>//</code>不会被解释为空Slashy字符串,这代表着行注释.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> <span class="string">''</span> == <span class="comment">//</span></div></pre></td></tr></table></figure>
<h3 id="Dollar-slashy-string"><a href="#Dollar-slashy-string" class="headerlink" title="Dollar slashy string"></a>Dollar slashy string</h3><p>Dollar slashy字符串 通过<code>$/``/$</code> 来实现多行GString. 美元符作为转义字符, 而且它还能转义另一个美元符号, 或者一个 forward slash. 除了要实现像GString占位符和闭包美元符slashy的开头美元符之外, 美元符和forward slashes都不需要转义<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> name = <span class="string">"Guillaume"</span></div><div class="line"><span class="keyword">def</span> date = <span class="string">"April, 1st"</span></div><div class="line"></div><div class="line"><span class="keyword">def</span> dollarSlashy = <span class="string">$/</span></div><div class="line">    Hello $name,</div><div class="line">    today we're $&#123;date&#125;.</div><div class="line"></div><div class="line">    $ dollar sign</div><div class="line">    $$ escaped dollar sign</div><div class="line">    \ backslash</div><div class="line">    / forward slash</div><div class="line">    $/ escaped forward slash</div><div class="line">    $/$ escaped dollar slashy string delimiter</div><div class="line">/$</div><div class="line"></div><div class="line"><span class="keyword">assert</span> [</div><div class="line">    <span class="string">'Guillaume'</span>,</div><div class="line">    <span class="string">'April, 1st'</span>,</div><div class="line">    <span class="string">'$ dollar sign'</span>,</div><div class="line">    <span class="string">'$ escaped dollar sign'</span>,</div><div class="line">    <span class="string">'\\ backslash'</span>,</div><div class="line">    <span class="string">'/ forward slash'</span>,</div><div class="line">        <span class="string">'$/ escaped forward slash'</span>,</div><div class="line">        <span class="string">'/$ escaped dollar slashy string delimiter'</span></div><div class="line"></div><div class="line">        ].each &#123; dollarSlashy.contains(it) &#125;</div></pre></td></tr></table></figure></p>
<h3 id="Characters"><a href="#Characters" class="headerlink" title="Characters"></a>Characters</h3><p>不像java, Groovy里没有显式的字符字面量. 可以通过下面三种方式,显式地生成Groovy 字符变量<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> c1 = <span class="string">'A'</span> (<span class="number">1</span>)</div><div class="line"><span class="keyword">assert</span> c1 <span class="keyword">instanceof</span> Character</div><div class="line"></div><div class="line"><span class="keyword">def</span> c2 = <span class="string">'B'</span> <span class="keyword">as</span> <span class="keyword">char</span> (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> c2 <span class="keyword">instanceof</span> Character</div><div class="line"></div><div class="line"><span class="keyword">def</span> c3 = (<span class="keyword">char</span>)<span class="string">'C'</span> (<span class="number">3</span>)</div><div class="line"><span class="keyword">assert</span> c3 <span class="keyword">instanceof</span> Character</div></pre></td></tr></table></figure></p>
<ol>
<li>通过指定char类型来显式地声明一个character变量</li>
<li>通过操作符强制转换类型</li>
<li>通过强制转换成指定类型</li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/04/16/编程语言/Groovy 字符串/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/04/16/编程语言/Groovy 字符串/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/04/15/编程语言/Groovy 数字/" title="Groovy 数字" itemprop="url">Groovy 数字</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-04-15T07:00:00.000Z" itemprop="datePublished"> 发表于 2014-04-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <blockquote>
<p>本文是对Groovy部分官方文档进行了翻译</p>
</blockquote>
<p>Groovy支持多种不同的整数字面量和小数字面量 (通过依靠Java数字类型实现)</p>
<h3 id="Integral-literals"><a href="#Integral-literals" class="headerlink" title="Integral literals"></a>Integral literals</h3><p>The integral literal types are the same as in Java:</p>
<p>证书类型变量和Java里的一样</p>
<ul>
<li>byte</li>
<li>char</li>
<li>short</li>
<li>int</li>
<li>long</li>
<li>java.lang.BigInteger</li>
</ul>
<p>You can create integral numbers of those types with the following declarations:</p>
<p>可以通过以下声明方式创建整数类型变量<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// primitive types</span></div><div class="line"><span class="keyword">byte</span>  b = <span class="number">1</span></div><div class="line"><span class="keyword">char</span>  c = <span class="number">2</span></div><div class="line"><span class="keyword">short</span> s = <span class="number">3</span></div><div class="line"><span class="keyword">int</span>   i = <span class="number">4</span></div><div class="line"><span class="keyword">long</span>  l = <span class="number">5</span></div><div class="line"></div><div class="line"><span class="comment">// infinite precision</span></div><div class="line">BigInteger bi =  <span class="number">6</span></div></pre></td></tr></table></figure></p>
<p>如果使用<code>def</code>关键字, 整型类型会发生改变：它会自动适配成能够存储number类型的类型<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> a = <span class="number">1</span></div><div class="line"><span class="keyword">assert</span> a <span class="keyword">instanceof</span> Integer</div><div class="line"></div><div class="line"><span class="comment">// Integer.MAX_VALUE</span></div><div class="line"><span class="keyword">def</span> b = <span class="number">2147483647</span></div><div class="line"><span class="keyword">assert</span> b <span class="keyword">instanceof</span> Integer</div><div class="line"></div><div class="line"><span class="comment">// Integer.MAX_VALUE + 1</span></div><div class="line"><span class="keyword">def</span> c = <span class="number">2147483648</span></div><div class="line"><span class="keyword">assert</span> c <span class="keyword">instanceof</span> Long</div><div class="line"></div><div class="line"><span class="comment">// Long.MAX_VALUE</span></div><div class="line"><span class="keyword">def</span> d = <span class="number">9223372036854775807</span></div><div class="line"><span class="keyword">assert</span> d <span class="keyword">instanceof</span> Long</div><div class="line"></div><div class="line"><span class="comment">// Long.MAX_VALUE + 1</span></div><div class="line"><span class="keyword">def</span> e = <span class="number">9223372036854775808</span></div><div class="line"><span class="keyword">assert</span> e <span class="keyword">instanceof</span> BigInteger</div></pre></td></tr></table></figure></p>
<p>As well as for negative numbers:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> na = <span class="number">-1</span></div><div class="line"><span class="keyword">assert</span> na <span class="keyword">instanceof</span> Integer</div><div class="line"></div><div class="line"><span class="comment">// Integer.MIN_VALUE</span></div><div class="line"><span class="keyword">def</span> nb = <span class="number">-2147483648</span></div><div class="line"><span class="keyword">assert</span> nb <span class="keyword">instanceof</span> Integer</div><div class="line"></div><div class="line"><span class="comment">// Integer.MIN_VALUE - 1</span></div><div class="line"><span class="keyword">def</span> nc = <span class="number">-2147483649</span></div><div class="line"><span class="keyword">assert</span> nc <span class="keyword">instanceof</span> Long</div><div class="line"></div><div class="line"><span class="comment">// Long.MIN_VALUE</span></div><div class="line"><span class="keyword">def</span> nd = <span class="number">-9223372036854775808</span></div><div class="line"><span class="keyword">assert</span> nd <span class="keyword">instanceof</span> Long</div><div class="line"></div><div class="line"><span class="comment">// Long.MIN_VALUE - 1</span></div><div class="line"><span class="keyword">def</span> ne = <span class="number">-9223372036854775809</span></div><div class="line"><span class="keyword">assert</span> ne <span class="keyword">instanceof</span> BigInteger</div></pre></td></tr></table></figure></p>
<h4 id="Alternative-non-base-10-representations"><a href="#Alternative-non-base-10-representations" class="headerlink" title="Alternative non-base 10 representations"></a>Alternative non-base 10 representations</h4><h5 id="Binary-literal"><a href="#Binary-literal" class="headerlink" title="Binary literal"></a>Binary literal</h5><p>在Java6以前和Groovy中,number类型可以是小数, 8进制和16进制. 但是在Java7和Groovy2中,可以使用0b前缀表示二进制数据.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> xInt = <span class="number">0b10101111</span></div><div class="line"><span class="keyword">assert</span> xInt == <span class="number">175</span></div><div class="line"></div><div class="line"><span class="keyword">short</span> xShort = <span class="number">0b11001001</span></div><div class="line"><span class="keyword">assert</span> xShort == <span class="number">201</span> <span class="keyword">as</span> <span class="keyword">short</span></div><div class="line"></div><div class="line"><span class="keyword">byte</span> xByte = <span class="number">0b11</span></div><div class="line"><span class="keyword">assert</span> xByte == <span class="number">3</span> <span class="keyword">as</span> <span class="keyword">byte</span></div><div class="line"></div><div class="line"><span class="keyword">long</span> xLong = <span class="number">0b101101101101</span></div><div class="line"><span class="keyword">assert</span> xLong == <span class="number">2925</span>l</div><div class="line"></div><div class="line">BigInteger xBigInteger = <span class="number">0b111100100001</span></div><div class="line"><span class="keyword">assert</span> xBigInteger == <span class="number">3873</span>g</div><div class="line"></div><div class="line"><span class="keyword">int</span> xNegativeInt = <span class="number">-0</span>b10101111</div><div class="line"><span class="keyword">assert</span> xNegativeInt == <span class="number">-175</span></div></pre></td></tr></table></figure></p>
<h5 id="Octal-literal"><a href="#Octal-literal" class="headerlink" title="Octal literal"></a>Octal literal</h5><p>8进制的电话,只需要开头是0后跟要表示的8进制数即可.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> xInt = <span class="number">077</span></div><div class="line"><span class="keyword">assert</span> xInt == <span class="number">63</span></div><div class="line"></div><div class="line"><span class="keyword">short</span> xShort = <span class="number">011</span></div><div class="line"><span class="keyword">assert</span> xShort == <span class="number">9</span> <span class="keyword">as</span> <span class="keyword">short</span></div><div class="line"></div><div class="line"><span class="keyword">byte</span> xByte = <span class="number">032</span></div><div class="line"><span class="keyword">assert</span> xByte == <span class="number">26</span> <span class="keyword">as</span> <span class="keyword">byte</span></div><div class="line"></div><div class="line"><span class="keyword">long</span> xLong = <span class="number">0246</span></div><div class="line"><span class="keyword">assert</span> xLong == <span class="number">166</span>l</div><div class="line"></div><div class="line">BigInteger xBigInteger = <span class="number">01111</span></div><div class="line"><span class="keyword">assert</span> xBigInteger == <span class="number">585</span>g</div><div class="line"></div><div class="line"><span class="keyword">int</span> xNegativeInt = <span class="number">-077</span></div><div class="line"><span class="keyword">assert</span> xNegativeInt == <span class="number">-63</span></div></pre></td></tr></table></figure></p>
<h5 id="Hexadecimal-literal"><a href="#Hexadecimal-literal" class="headerlink" title="Hexadecimal literal"></a>Hexadecimal literal</h5><p>Hexadecimal numbers are specified in the typical format of 0x followed by hex digits.</p>
<p>16进制的电话,只需要开头是0x后跟要表示的16进制数即可.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">int</span> xInt = <span class="number">0x77</span></div><div class="line"><span class="keyword">assert</span> xInt == <span class="number">119</span></div><div class="line"></div><div class="line"><span class="keyword">short</span> xShort = <span class="number">0xaa</span></div><div class="line"><span class="keyword">assert</span> xShort == <span class="number">170</span> <span class="keyword">as</span> <span class="keyword">short</span></div><div class="line"></div><div class="line"><span class="keyword">byte</span> xByte = <span class="number">0x3a</span></div><div class="line"><span class="keyword">assert</span> xByte == <span class="number">58</span> <span class="keyword">as</span> <span class="keyword">byte</span></div><div class="line"></div><div class="line"><span class="keyword">long</span> xLong = <span class="number">0xffff</span></div><div class="line"><span class="keyword">assert</span> xLong == <span class="number">65535</span>l</div><div class="line"></div><div class="line">BigInteger xBigInteger = <span class="number">0xaaaa</span></div><div class="line"><span class="keyword">assert</span> xBigInteger == <span class="number">43690</span>g</div><div class="line"></div><div class="line">Double xDouble = <span class="keyword">new</span> Double(<span class="string">'0x1.0p0'</span>)</div><div class="line"><span class="keyword">assert</span> xDouble == <span class="number">1.0</span>d</div><div class="line"></div><div class="line"><span class="keyword">int</span> xNegativeInt = <span class="number">-0x77</span></div><div class="line"><span class="keyword">assert</span> xNegativeInt == <span class="number">-119</span></div></pre></td></tr></table></figure></p>
<h3 id="Decimal-literals"><a href="#Decimal-literals" class="headerlink" title="Decimal literals"></a>Decimal literals</h3><p>小数字面量和在java 里一样</p>
<ul>
<li>float</li>
<li>double</li>
<li>java.lang.BigDecimal</li>
</ul>
<p>可以通过下面的方式创建小数类型的number<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// primitive types</span></div><div class="line"><span class="keyword">float</span>  f = <span class="number">1.234</span></div><div class="line"><span class="keyword">double</span> d = <span class="number">2.345</span></div><div class="line"></div><div class="line"><span class="comment">// infinite precision</span></div><div class="line">BigDecimal bd =  <span class="number">3.456</span></div></pre></td></tr></table></figure></p>
<p>Decimals can use exponents, with the e or E exponent letter, followed by an optional sign, and a integral number representing the exponent:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> <span class="number">1e3</span>  ==  <span class="number">1</span>_000<span class="number">.0</span></div><div class="line"><span class="keyword">assert</span> <span class="number">2E4</span>  == <span class="number">20</span>_000<span class="number">.0</span></div><div class="line"><span class="keyword">assert</span> <span class="number">3e+1</span> ==     <span class="number">30.0</span></div><div class="line"><span class="keyword">assert</span> <span class="number">4E-2</span> ==      <span class="number">0.04</span></div><div class="line"><span class="keyword">assert</span> <span class="number">5e-1</span> ==      <span class="number">0.5</span></div></pre></td></tr></table></figure>
<p>Conveniently for exact decimal number calculations, Groovy choses java.lang.BigDecimal as its decimal number type. In addition, both float and double are supported, but require an explicit type declaration, type coercion or suffix. Even if BigDecimal is the default for decimal numbers, such literals are accepted in methods or closures taking float or double as parameter types.</p>
<p>Decimal numbers can’t be represented using a binary, octal or hexadecimal representation.</p>
<h3 id="Underscore-in-literals"><a href="#Underscore-in-literals" class="headerlink" title="Underscore in literals"></a>Underscore in literals</h3><p>When writing long literal numbers, it’s harder on the eye to figure out how some numbers are grouped together, for example with groups of thousands, of words, etc. By allowing you to place underscore in number literals, it’s easier to spot those groups:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">long</span> creditCardNumber = <span class="number">1234</span>_5678_9012_3456L</div><div class="line"><span class="keyword">long</span> socialSecurityNumbers = <span class="number">999</span>_99_9999L</div><div class="line"><span class="keyword">double</span> monetaryAmount = <span class="number">12</span>_345_132<span class="number">.12</span></div><div class="line"><span class="keyword">long</span> hexBytes = <span class="number">0xFF</span>_EC_DE_5E</div><div class="line"><span class="keyword">long</span> hexWords = <span class="number">0xFFEC</span>_DE5E</div><div class="line"><span class="keyword">long</span> maxLong = <span class="number">0x7fff</span>_ffff_ffff_ffffL</div><div class="line"><span class="keyword">long</span> alsoMaxLong = <span class="number">9</span>_223_372_036_854_775_807L</div><div class="line"><span class="keyword">long</span> bytes = <span class="number">0b11010010</span>_01101001_10010100_10010010</div></pre></td></tr></table></figure>
<h3 id="Number-type-suffixes"><a href="#Number-type-suffixes" class="headerlink" title="Number type suffixes"></a>Number type suffixes</h3><p>我们可以通过添加后缀的方式强制指定一个数字的类型(包含二进制,八进制和十六进制)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Type			Suffix</div><div class="line">BigInteger		G or g</div><div class="line">Long			L or l</div><div class="line">Integer			I or i</div><div class="line">BigDecimal		G or g</div><div class="line">Double			D or d</div><div class="line">Float			F or f</div></pre></td></tr></table></figure></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> <span class="number">42</span>I == <span class="keyword">new</span> Integer(<span class="string">'42'</span>)</div><div class="line"><span class="keyword">assert</span> <span class="number">42</span>i == <span class="keyword">new</span> Integer(<span class="string">'42'</span>) <span class="comment">// lowercase i more readable</span></div><div class="line"><span class="keyword">assert</span> <span class="number">123</span>L == <span class="keyword">new</span> Long(<span class="string">"123"</span>) <span class="comment">// uppercase L more readable</span></div><div class="line"><span class="keyword">assert</span> <span class="number">2147483648</span> == <span class="keyword">new</span> Long(<span class="string">'2147483648'</span>) <span class="comment">// Long type used, value too large for an Integer</span></div><div class="line"><span class="keyword">assert</span> <span class="number">456</span>G == <span class="keyword">new</span> BigInteger(<span class="string">'456'</span>)</div><div class="line"><span class="keyword">assert</span> <span class="number">456</span>g == <span class="keyword">new</span> BigInteger(<span class="string">'456'</span>)</div><div class="line"><span class="keyword">assert</span> <span class="number">123.45</span> == <span class="keyword">new</span> BigDecimal(<span class="string">'123.45'</span>) <span class="comment">// default BigDecimal type used</span></div><div class="line"><span class="keyword">assert</span> <span class="number">1.200065</span>D == <span class="keyword">new</span> Double(<span class="string">'1.200065'</span>)</div><div class="line"><span class="keyword">assert</span> <span class="number">1.234</span>F == <span class="keyword">new</span> Float(<span class="string">'1.234'</span>)</div><div class="line"><span class="keyword">assert</span> <span class="number">1.23E23</span>D == <span class="keyword">new</span> Double(<span class="string">'1.23E23'</span>)</div><div class="line"><span class="keyword">assert</span> <span class="number">0b1111</span>L.<span class="keyword">class</span> == Long <span class="comment">// binary</span></div><div class="line"><span class="keyword">assert</span> <span class="number">0xFF</span>i.<span class="keyword">class</span> == Integer <span class="comment">// hexadecimal</span></div><div class="line"><span class="keyword">assert</span> <span class="number">034</span>G.<span class="keyword">class</span> == BigInteger <span class="comment">// octal</span></div></pre></td></tr></table></figure>
<h3 id="Math-operations"><a href="#Math-operations" class="headerlink" title="Math operations"></a>Math operations</h3><p>尽管接下来我们还要详细讨论操作符, 但是鉴于数学操作符的重要性, 现在我们还是要先讨论其行为和返回类型</p>
<ul>
<li>byte, char, short 和 int 之间的二进制计算返回的是int类型</li>
<li>byte, char, short 和 int 之间的二进制计算中涉及到long的话, 那么返回的就是long类型</li>
<li>BigInteger 与任何整数类型的二进制计算 返回的结果都是BigInteger类型</li>
<li>float, double 和 BigDecimal 之间的二进制计算返回的结果都是double类型</li>
<li>俩个BigDecimal之间的二进制运算返回的都是BigDecimal类型.</li>
</ul>
<p>由于Groovy提供了操作符重载功能, BigInteger和BigDecimal之间的算术运算也得以实现, 但是在Java中需要调用一些方法才能计算这些不同类型的数字.</p>
<h4 id="The-case-of-the-power-operator"><a href="#The-case-of-the-power-operator" class="headerlink" title="The case of the power operator"></a>The case of the power operator</h4><p>Groovy 里有一种强大的操作符<code>**</code>, 这个操作符带有base和exponent俩个参数. 这个操作符的结果依赖于它的操作数和操作结果.Groovy使用下面的规则来决定该操作符的返回类型</p>
<h5 id="如果exponent为小数类型"><a href="#如果exponent为小数类型" class="headerlink" title="如果exponent为小数类型"></a>如果exponent为小数类型</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>. 如果结果能表示为Integer类型,那就返回Integer类型</div><div class="line"><span class="number">2</span>. 否则如果结果能表示为Long类型,那就返回Long类型</div><div class="line"><span class="number">3</span>. 否则的话就返回Double</div></pre></td></tr></table></figure>
<h5 id="如果exponent为整数类型"><a href="#如果exponent为整数类型" class="headerlink" title="如果exponent为整数类型"></a>如果exponent为整数类型</h5><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="number">1.</span> 如果exponent负数负数, 那就返回Integer, Long 或者Double,</div><div class="line"><span class="number">2.</span> 如果exponent是正数或者<span class="number">0</span>, 那就要根据base来判断了</div><div class="line">	A. 如果base是 BigDecimal, 那就返回BigDecimal类型</div><div class="line">	B. 如果base是 BigInteger, 那就返回BigInteger类型</div><div class="line">	C. 如果base是 Integer, 那就返回Integer类型, 如果返回的值超过Integer范围的话,就返回BigInteger</div><div class="line">	D. 如果base是 Long, 那就返回Long类型, 如果返回的值超过Long范围的话,就返回BigInteger</div></pre></td></tr></table></figure>
<h5 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h5><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// base and exponent are ints and the result can be represented by an Integer</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">2</span>    **   <span class="number">3</span>    <span class="keyword">instanceof</span> Integer    <span class="comment">//  8</span></div><div class="line"><span class="keyword">assert</span>   <span class="number">10</span>    **   <span class="number">9</span>    <span class="keyword">instanceof</span> Integer    <span class="comment">//  1_000_000_000</span></div><div class="line"></div><div class="line"><span class="comment">// the base is a long, so fit the result in a Long</span></div><div class="line"><span class="comment">// (although it could have fit in an Integer)</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">5</span>L   **   <span class="number">2</span>    <span class="keyword">instanceof</span> Long       <span class="comment">//  25</span></div><div class="line"></div><div class="line"><span class="comment">// the result can't be represented as an Integer or Long, so return a BigInteger</span></div><div class="line"><span class="keyword">assert</span>  <span class="number">100</span>    **  <span class="number">10</span>    <span class="keyword">instanceof</span> BigInteger <span class="comment">//  10e20</span></div><div class="line"><span class="keyword">assert</span> <span class="number">1234</span>    ** <span class="number">123</span>    <span class="keyword">instanceof</span> BigInteger <span class="comment">//  170515806212727042875...</span></div><div class="line"></div><div class="line"><span class="comment">// the base is a BigDecimal and the exponent a negative int</span></div><div class="line"><span class="comment">// but the result can be represented as an Integer</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">0.5</span>  **  <span class="number">-2</span>    <span class="keyword">instanceof</span> Integer    <span class="comment">//  4</span></div><div class="line"></div><div class="line"><span class="comment">// the base is an int, and the exponent a negative float</span></div><div class="line"><span class="comment">// but again, the result can be represented as an Integer</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">1</span>    **  <span class="number">-0.3</span>f <span class="keyword">instanceof</span> Integer    <span class="comment">//  1</span></div><div class="line"></div><div class="line"><span class="comment">// the base is an int, and the exponent a negative int</span></div><div class="line"><span class="comment">// but the result will be calculated as a Double</span></div><div class="line"><span class="comment">// (both base and exponent are actually converted to doubles)</span></div><div class="line"><span class="keyword">assert</span>   <span class="number">10</span>    **  <span class="number">-1</span>    <span class="keyword">instanceof</span> Double     <span class="comment">//  0.1</span></div><div class="line"></div><div class="line"><span class="comment">// the base is a BigDecimal, and the exponent is an int, so return a BigDecimal</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">1.2</span>  **  <span class="number">10</span>    <span class="keyword">instanceof</span> BigDecimal <span class="comment">//  6.1917364224</span></div><div class="line"></div><div class="line"><span class="comment">// the base is a float or double, and the exponent is an int</span></div><div class="line"><span class="comment">// but the result can only be represented as a Double value</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">3.4</span>f **   <span class="number">5</span>    <span class="keyword">instanceof</span> Double     <span class="comment">//  454.35430372146965</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">5.6</span>d **   <span class="number">2</span>    <span class="keyword">instanceof</span> Double     <span class="comment">//  31.359999999999996</span></div><div class="line"></div><div class="line"><span class="comment">// the exponent is a decimal value</span></div><div class="line"><span class="comment">// and the result can only be represented as a Double value</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">7.8</span>  **   <span class="number">1.9</span>  <span class="keyword">instanceof</span> Double     <span class="comment">//  49.542708423868476</span></div><div class="line"><span class="keyword">assert</span>    <span class="number">2</span>    **   <span class="number">0.1</span>f <span class="keyword">instanceof</span> Double     <span class="comment">//  1.0717734636432956</span></div></pre></td></tr></table></figure>
<h2 id="Booleans"><a href="#Booleans" class="headerlink" title="Booleans"></a>Booleans</h2><p>Boolean是一种特殊的数据类型, 他们的值只有俩种情况：true 和 false.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> myBooleanVariable = <span class="literal">true</span></div><div class="line"><span class="keyword">boolean</span> untypedBooleanVar = <span class="literal">false</span></div><div class="line">booleanField = <span class="literal">true</span></div></pre></td></tr></table></figure></p>
<p>true and false are the only two primitive boolean values. But more complex boolean expressions can be represented using logical operators.</p>
<p>In addition, Groovy has special rules (often referred to as Groovy Truth) for coercing non-boolean objects to a boolean value.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/04/15/编程语言/Groovy 数字/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/04/15/编程语言/Groovy 数字/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/04/11/编程语言/Groovy 集合/" title="Groovy 集合" itemprop="url">Groovy 集合</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2014-04-11T07:00:00.000Z" itemprop="datePublished"> 发表于 2014-04-11</time>
    
  </p>
</header>
    <div class="article-content">
        
        <blockquote>
<p>本文是对Groovy部分官方文档进行了翻译</p>
</blockquote>
<p>Groovy 语言层面上就支持多种集合类型,包括list, map, range. 大多数类型集合都是基于java的集合框架,而且Groovy development kit对这些集合内置很多快捷方法.</p>
<h3 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h3><p>Groovy使用了一种被<code>[]</code>括起来,值通过<code>,</code>分割的语法 定义list. Groovy list 采用的是 JDK里<code>java.util.List</code>的实现, 因为它自身并没有定义自己的集合类.<br>Groovy list 的默认实现是<code>java.util.ArrayList</code>, 在后面我们可以看到其他形式的list</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]         (<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> numbers <span class="keyword">instanceof</span> List  (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> numbers.size() == <span class="number">3</span>      (<span class="number">3</span>)</div></pre></td></tr></table></figure>
<ol>
<li>我们定义了一个Number类型的List,然后将这个list分配给一个变量</li>
<li>判断list是 Java’s <code>java.util.List</code> interface 的实例</li>
<li>list的大小可以通过size()来进行查询, 例子中也给我们展示了这个list确实包含3个元素</li>
</ol>
<p>在上面的list中,我们使用的是同类元素的list, 但其实Groovy list中的数据类型还可以不一样：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> heterogeneous = [<span class="number">1</span>, <span class="string">"a"</span>, <span class="literal">true</span>]  (<span class="number">1</span>)</div></pre></td></tr></table></figure></p>
<ol>
<li>我们定义了一个包含有number,string,boolean 三个类型的list</li>
</ol>
<p>在上面我们提到过, list实际上是<code>java.util.ArrayList</code>实例, 但其实list还可以是其他不同类型的实例, 下面我们通过操作符或者显式类型声明来强制指定 list使用不同的List实现<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> arrayList = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</div><div class="line"><span class="keyword">assert</span> arrayList <span class="keyword">instanceof</span> java.util.ArrayList</div><div class="line"></div><div class="line"><span class="keyword">def</span> linkedList = [<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>] <span class="keyword">as</span> LinkedList    (<span class="number">1</span>)</div><div class="line"><span class="keyword">assert</span> linkedList <span class="keyword">instanceof</span> java.util.LinkedList</div><div class="line"></div><div class="line">LinkedList otherLinked = [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]          (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> otherLinked <span class="keyword">instanceof</span> java.util.LinkedList</div></pre></td></tr></table></figure></p>
<ol>
<li>我们使用操作符强制将类型显式地声明为<code>java.util.LinkedList</code></li>
<li>我们使用显式声明方式, 将list声明为<code>java.util.LinkedList</code></li>
</ol>
<p>我们可以通过<code>[]</code>下标操作符来访问list中的元素(读写都可以). 下标既如果是正数的话,那就从左到右访问元素, 如果下标是负数那就从右到左访问元素. 我们好可以使用<code>&lt;&lt;</code>操作符向list里追加元素<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> letters = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>]</div><div class="line"></div><div class="line"><span class="keyword">assert</span> letters[<span class="number">0</span>] == <span class="string">'a'</span>     (<span class="number">1</span>)</div><div class="line"><span class="keyword">assert</span> letters[<span class="number">1</span>] == <span class="string">'b'</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> letters[<span class="number">-1</span>] == <span class="string">'d'</span>    (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> letters[<span class="number">-2</span>] == <span class="string">'c'</span></div><div class="line"></div><div class="line">letters[<span class="number">2</span>] = <span class="string">'C'</span>             (<span class="number">3</span>)</div><div class="line"><span class="keyword">assert</span> letters[<span class="number">2</span>] == <span class="string">'C'</span></div><div class="line"></div><div class="line">letters &lt;&lt; <span class="string">'e'</span>               (<span class="number">4</span>)</div><div class="line"><span class="keyword">assert</span> letters[ <span class="number">4</span>] == <span class="string">'e'</span></div><div class="line"><span class="keyword">assert</span> letters[<span class="number">-1</span>] == <span class="string">'e'</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> letters[<span class="number">1</span>, <span class="number">3</span>] == [<span class="string">'b'</span>, <span class="string">'d'</span>]         (<span class="number">5</span>)</div><div class="line"><span class="keyword">assert</span> letters[<span class="number">2.</span><span class="number">.4</span>] == [<span class="string">'C'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>]    (<span class="number">6</span>)</div></pre></td></tr></table></figure></p>
<ol>
<li>访问第一个元素(从这可以看出,list的下标是从0开始的)</li>
<li>通过-1 下标访问list中的最后一个元素.</li>
<li>使用下标对list中第三个元素重新赋值</li>
<li>使用<code>&lt;&lt;</code>向list尾部添加一个元素</li>
<li>一次性访问list中俩个元素,这个操作的结果是返回一个包含俩个元素的新的list</li>
<li>使用值域符来访问list中一定范围内的值.</li>
</ol>
<p>由于list支持多种不同类型的元素, 那么list中也可以包含list,这样就可以制造出多维list<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> multi = [[<span class="number">0</span>, <span class="number">1</span>], [<span class="number">2</span>, <span class="number">3</span>]]     (<span class="number">1</span>)</div><div class="line"><span class="keyword">assert</span> multi[<span class="number">1</span>][<span class="number">0</span>] == <span class="number">2</span>          (<span class="number">2</span>)</div></pre></td></tr></table></figure></p>
<ol>
<li>定义了一个包含Number类型list的list</li>
<li>访问外层的第二个元素(第二个list), 然后访问内部list的第一个元素(第二个list的第一个元素)</li>
</ol>
<h4 id="List-literals"><a href="#List-literals" class="headerlink" title="List literals"></a>List literals</h4><p>你可以像下面这样创建集合, 注意<code>[]</code>是空集合表达式.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> list = [<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</div><div class="line"><span class="keyword">assert</span> list.get(<span class="number">2</span>) == <span class="number">7</span></div><div class="line"><span class="keyword">assert</span> list[<span class="number">2</span>] == <span class="number">7</span></div><div class="line"><span class="keyword">assert</span> list <span class="keyword">instanceof</span> java.util.List</div><div class="line"></div><div class="line"><span class="keyword">def</span> emptyList = []</div><div class="line"><span class="keyword">assert</span> emptyList.size() == <span class="number">0</span></div><div class="line">emptyList.add(<span class="number">5</span>)</div><div class="line"><span class="keyword">assert</span> emptyList.size() == <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>每一个list表达式都是实现自<code>java.util.List</code></p>
<p>当然list也可以指定其具体的实现类型<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> list1 = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</div><div class="line"><span class="comment">//construct a new list, seeded with the same items as in list1</span></div><div class="line"><span class="keyword">def</span> list2 = <span class="keyword">new</span> ArrayList&lt;String&gt;(list1)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> list2 == list1 <span class="comment">// == checks that each corresponding element is the same</span></div><div class="line"></div><div class="line"><span class="comment">// clone() can also be called</span></div><div class="line"><span class="keyword">def</span> list3 = list1.clone()</div><div class="line"><span class="keyword">assert</span> list3 == list1</div></pre></td></tr></table></figure></p>
<p>list本质上是一个有序的对象集合.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> list = [<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</div><div class="line"><span class="keyword">assert</span> list.size() == <span class="number">4</span></div><div class="line"><span class="keyword">assert</span> list.getClass() == ArrayList     <span class="comment">// the specific kind of list being used</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> list[<span class="number">2</span>] == <span class="number">7</span>                     <span class="comment">// indexing starts at 0</span></div><div class="line"><span class="keyword">assert</span> list.getAt(<span class="number">2</span>) == <span class="number">7</span>               <span class="comment">// equivalent method to subscript operator []</span></div><div class="line"><span class="keyword">assert</span> list.get(<span class="number">2</span>) == <span class="number">7</span>                 <span class="comment">// alternative method</span></div><div class="line"></div><div class="line">list[<span class="number">2</span>] = <span class="number">9</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="number">5</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">8</span>,]           <span class="comment">// trailing comma OK</span></div><div class="line"></div><div class="line">list.putAt(<span class="number">2</span>, <span class="number">10</span>)                       <span class="comment">// equivalent method to [] when value being changed</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="number">5</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">8</span>]</div><div class="line"><span class="keyword">assert</span> list.set(<span class="number">2</span>, <span class="number">11</span>) == <span class="number">10</span>            <span class="comment">// alternative method that returns old value</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="number">5</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">8</span>]</div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="number">1</span>, <span class="string">'a'</span>, <span class="string">'a'</span>, <span class="number">2.5</span>, <span class="number">2.5</span>f, <span class="number">2.5</span>d, <span class="string">'hello'</span>, <span class="number">7</span>g, <span class="literal">null</span>, <span class="number">9</span> <span class="keyword">as</span> <span class="keyword">byte</span>]</div><div class="line"><span class="comment">//objects can be of different types; duplicates allowed</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>][<span class="number">-1</span>] == <span class="number">5</span>             <span class="comment">// use negative indices to count from the end</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>][<span class="number">-2</span>] == <span class="number">4</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>].getAt(<span class="number">-2</span>) == <span class="number">4</span>       <span class="comment">// getAt() available with negative index...</span></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>].get(<span class="number">-2</span>)                 <span class="comment">// but negative index not allowed with get()</span></div><div class="line">    <span class="keyword">assert</span> <span class="literal">false</span></div><div class="line">&#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">    <span class="keyword">assert</span> e <span class="keyword">instanceof</span> ArrayIndexOutOfBoundsException</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="List-as-a-boolean-expression"><a href="#List-as-a-boolean-expression" class="headerlink" title="List as a boolean expression"></a>List as a boolean expression</h4><p>list还可以计算出boolean表达式.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> ![]             <span class="comment">// an empty list evaluates as false</span></div><div class="line"></div><div class="line"><span class="comment">//all other lists, irrespective of contents, evaluate as true</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>] &amp;&amp; [<span class="string">'a'</span>] &amp;&amp; [<span class="number">0</span>] &amp;&amp; [<span class="number">0.0</span>] &amp;&amp; [<span class="literal">false</span>] &amp;&amp; [<span class="literal">null</span>]</div></pre></td></tr></table></figure></p>
<h4 id="Iterating-on-a-list"><a href="#Iterating-on-a-list" class="headerlink" title="Iterating on a list"></a>Iterating on a list</h4><p>可以通过<code>each</code>, <code>eachWithIndex</code>遍历整个集合.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].each &#123;</div><div class="line">    println <span class="string">"Item: $it"</span> <span class="comment">// `it` is an implicit parameter corresponding to the current element</span></div><div class="line">&#125;</div><div class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>].eachWithIndex &#123; it, i -&gt; <span class="comment">// `it` is the current element, while `i` is the index</span></div><div class="line">    println <span class="string">"$i: $it"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在遍历的时候,我们经常需要将遍历出来的值经过某些运算,然后再重新放进一个新的list中. 这种操作经常称为映射(mapping), 这种操作通过<code>collect</code>方法实现.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].collect &#123; it * <span class="number">2</span> &#125; == [<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>]</div><div class="line"></div><div class="line"><span class="comment">// shortcut syntax instead of collect</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]*.multiply(<span class="number">2</span>) == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].collect &#123; it.multiply(<span class="number">2</span>) &#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> list = [<span class="number">0</span>]</div><div class="line"><span class="comment">// it is possible to give `collect` the list which collects the elements</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].collect(list) &#123; it * <span class="number">2</span> &#125; == [<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>]</div><div class="line"><span class="keyword">assert</span> list == [<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>]</div></pre></td></tr></table></figure></p>
<h4 id="Manipulating-lists"><a href="#Manipulating-lists" class="headerlink" title="Manipulating lists"></a>Manipulating lists</h4><h5 id="Filtering-and-searching"><a href="#Filtering-and-searching" class="headerlink" title="Filtering and searching"></a>Filtering and searching</h5><p><a href="http://www.groovy-lang.org/gdk.html" target="_blank" rel="external">Groovy development kit</a>提供了许多强大有趣的方法用来强化标准集合:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].find &#123; it &gt; <span class="number">1</span> &#125; == <span class="number">2</span>           <span class="comment">// find 1st element matching criteria</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].findAll &#123; it &gt; <span class="number">1</span> &#125; == [<span class="number">2</span>, <span class="number">3</span>]   <span class="comment">// find all elements matching critieria</span></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>].findIndexOf &#123;      <span class="comment">// find index of 1st element matching criteria</span></div><div class="line">    it <span class="keyword">in</span> [<span class="string">'c'</span>, <span class="string">'e'</span>, <span class="string">'g'</span>]</div><div class="line">&#125; == <span class="number">2</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'c'</span>].indexOf(<span class="string">'c'</span>) == <span class="number">2</span>  <span class="comment">// index returned</span></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'c'</span>].indexOf(<span class="string">'z'</span>) == <span class="number">-1</span> <span class="comment">// index -1 means value not in list</span></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'c'</span>].lastIndexOf(<span class="string">'c'</span>) == <span class="number">4</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].every &#123; it &lt; <span class="number">5</span> &#125;               <span class="comment">// returns true if all elements match the predicate</span></div><div class="line"><span class="keyword">assert</span> ![<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].every &#123; it &lt; <span class="number">3</span> &#125;</div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].any &#123; it &gt; <span class="number">2</span> &#125;                 <span class="comment">// returns true if any element matches the predicate</span></div><div class="line"><span class="keyword">assert</span> ![<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].any &#123; it &gt; <span class="number">3</span> &#125;</div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>].sum() == <span class="number">21</span>                <span class="comment">// sum anything with a plus() method</span></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>].sum &#123;</div><div class="line">    it == <span class="string">'a'</span> ? 1 : it == <span class="string">'b'</span> ? 2 : it == <span class="string">'c'</span> ? 3 : it == <span class="string">'d'</span> ? 4 : it == <span class="string">'e'</span> ? 5 : <span class="number">0</span></div><div class="line">    <span class="comment">// custom value to use in sum</span></div><div class="line">&#125; == <span class="number">15</span></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>].sum &#123; ((<span class="keyword">char</span>) it) - ((<span class="keyword">char</span>) <span class="string">'a'</span>) &#125; == <span class="number">10</span></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>].sum() == <span class="string">'abcde'</span></div><div class="line"><span class="keyword">assert</span> [[<span class="string">'a'</span>, <span class="string">'b'</span>], [<span class="string">'c'</span>, <span class="string">'d'</span>]].sum() == [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>]</div><div class="line"></div><div class="line"><span class="comment">// an initial value can be provided</span></div><div class="line"><span class="keyword">assert</span> [].sum(<span class="number">1000</span>) == <span class="number">1000</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].sum(<span class="number">1000</span>) == <span class="number">1006</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].join(<span class="string">'-'</span>) == <span class="string">'1-2-3'</span>           <span class="comment">// String joining</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].inject(<span class="string">'counting: '</span>) &#123;</div><div class="line">    str, item -&gt; str + item                     <span class="comment">// reduce operation</span></div><div class="line">&#125; == <span class="string">'counting: 123'</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].inject(<span class="number">0</span>) &#123; count, item -&gt;</div><div class="line">    count + item</div><div class="line">&#125; == <span class="number">6</span></div></pre></td></tr></table></figure>
<p>下面这段代码是由Groovy语言支撑的在集合中找到最大和最小数的例子:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> list = [<span class="number">9</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">10</span>, <span class="number">5</span>]</div><div class="line"><span class="keyword">assert</span> list.max() == <span class="number">10</span></div><div class="line"><span class="keyword">assert</span> list.min() == <span class="number">2</span></div><div class="line"></div><div class="line"><span class="comment">// we can also compare single characters, as anything comparable</span></div><div class="line"><span class="keyword">assert</span> [<span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'a'</span>, <span class="string">'z'</span>].min() == <span class="string">'a'</span></div><div class="line"></div><div class="line"><span class="comment">// we can use a closure to specify the sorting behaviour</span></div><div class="line"><span class="keyword">def</span> list2 = [<span class="string">'abc'</span>, <span class="string">'z'</span>, <span class="string">'xyzuvw'</span>, <span class="string">'Hello'</span>, <span class="string">'321'</span>]</div><div class="line"><span class="keyword">assert</span> list2.max &#123; it.size() &#125; == <span class="string">'xyzuvw'</span></div><div class="line"><span class="keyword">assert</span> list2.min &#123; it.size() &#125; == <span class="string">'z'</span></div></pre></td></tr></table></figure></p>
<p>在闭包里,你还可以自定义一个比较规则.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Comparator mc = &#123; a, b -&gt; a == b ? 0 : (a &lt; b ? -1 : <span class="number">1</span>) &#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> list = [<span class="number">7</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">-6</span>, <span class="number">-1</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">-9</span>, <span class="number">5</span>, <span class="number">-13</span>]</div><div class="line"><span class="keyword">assert</span> list.max(mc) == <span class="number">11</span></div><div class="line"><span class="keyword">assert</span> list.min(mc) == <span class="number">-13</span></div><div class="line"></div><div class="line">Comparator mc2 = &#123; a, b -&gt; a == b ? 0 : (Math.abs(a) &lt; Math.abs(b)) ? -1 : <span class="number">1</span> &#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">assert</span> list.max(mc2) == <span class="number">-13</span></div><div class="line"><span class="keyword">assert</span> list.min(mc2) == <span class="number">-1</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> list.max &#123; a, b -&gt; a.equals(b) ? 0 : Math.abs(a) &lt; Math.abs(b) ? -1 : <span class="number">1</span> &#125; == <span class="number">-13</span></div><div class="line"><span class="keyword">assert</span> list.min &#123; a, b -&gt; a.equals(b) ? 0 : Math.abs(a) &lt; Math.abs(b) ? -1 : <span class="number">1</span> &#125; == <span class="number">-1</span></div></pre></td></tr></table></figure></p>
<h5 id="Adding-or-removing-elements"><a href="#Adding-or-removing-elements" class="headerlink" title="Adding or removing elements"></a>Adding or removing elements</h5><p>我们可以使用<code>[]</code>去声明一个新的空list, 然后使用<code>&lt;&lt;</code>向list追加元素<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> list = []</div><div class="line"><span class="keyword">assert</span> list.empty</div><div class="line"></div><div class="line">list &lt;&lt; <span class="number">5</span></div><div class="line"><span class="keyword">assert</span> list.size() == <span class="number">1</span></div><div class="line"></div><div class="line">list &lt;&lt; <span class="number">7</span> &lt;&lt; <span class="string">'i'</span> &lt;&lt; <span class="number">11</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="number">5</span>, <span class="number">7</span>, <span class="string">'i'</span>, <span class="number">11</span>]</div><div class="line"></div><div class="line">list &lt;&lt; [<span class="string">'m'</span>, <span class="string">'o'</span>]</div><div class="line"><span class="keyword">assert</span> list == [<span class="number">5</span>, <span class="number">7</span>, <span class="string">'i'</span>, <span class="number">11</span>, [<span class="string">'m'</span>, <span class="string">'o'</span>]]</div><div class="line"></div><div class="line"><span class="comment">//first item in chain of &lt;&lt; is target list</span></div><div class="line"><span class="keyword">assert</span> ([<span class="number">1</span>, <span class="number">2</span>] &lt;&lt; <span class="number">3</span> &lt;&lt; [<span class="number">4</span>, <span class="number">5</span>] &lt;&lt; <span class="number">6</span>) == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, [<span class="number">4</span>, <span class="number">5</span>], <span class="number">6</span>]</div><div class="line"></div><div class="line"><span class="comment">//using leftShift is equivalent to using &lt;&lt;</span></div><div class="line"><span class="keyword">assert</span> ([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] &lt;&lt; <span class="number">4</span>) == ([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].leftShift(<span class="number">4</span>))</div><div class="line">```groovy</div><div class="line">We can add to a list <span class="keyword">in</span> many <span class="string">ways:</span></div><div class="line">```groovy</div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>] + <span class="number">3</span> + [<span class="number">4</span>, <span class="number">5</span>] + <span class="number">6</span> == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</div><div class="line"><span class="comment">// equivalent to calling the `plus` method</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>].plus(<span class="number">3</span>).plus([<span class="number">4</span>, <span class="number">5</span>]).plus(<span class="number">6</span>) == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</div><div class="line"></div><div class="line"><span class="keyword">def</span> a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</div><div class="line">a += <span class="number">4</span>      <span class="comment">// creates a new list and assigns it to `a`</span></div><div class="line">a += [<span class="number">5</span>, <span class="number">6</span>]</div><div class="line"><span class="keyword">assert</span> a == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, *[<span class="number">222</span>, <span class="number">333</span>], <span class="number">456</span>] == [<span class="number">1</span>, <span class="number">222</span>, <span class="number">333</span>, <span class="number">456</span>]</div><div class="line"><span class="keyword">assert</span> [*[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]] == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, [<span class="number">2</span>, <span class="number">3</span>, [<span class="number">4</span>, <span class="number">5</span>], <span class="number">6</span>], <span class="number">7</span>, [<span class="number">8</span>, <span class="number">9</span>]].flatten() == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]</div><div class="line"></div><div class="line"><span class="keyword">def</span> list = [<span class="number">1</span>, <span class="number">2</span>]</div><div class="line">list.add(<span class="number">3</span>)</div><div class="line">list.addAll([<span class="number">5</span>, <span class="number">4</span>])</div><div class="line"><span class="keyword">assert</span> list == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>]</div><div class="line"></div><div class="line">list = [<span class="number">1</span>, <span class="number">2</span>]</div><div class="line">list.add(<span class="number">1</span>, <span class="number">3</span>) <span class="comment">// add 3 just before index 1</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>]</div><div class="line"></div><div class="line">list.addAll(<span class="number">2</span>, [<span class="number">5</span>, <span class="number">4</span>]) <span class="comment">//add [5,4] just before index 2</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">2</span>]</div><div class="line"></div><div class="line">list = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'z'</span>, <span class="string">'e'</span>, <span class="string">'u'</span>, <span class="string">'v'</span>, <span class="string">'g'</span>]</div><div class="line">list[<span class="number">8</span>] = <span class="string">'x'</span> <span class="comment">// the [] operator is growing the list as needed</span></div><div class="line"><span class="comment">// nulls inserted if required</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'z'</span>, <span class="string">'e'</span>, <span class="string">'u'</span>, <span class="string">'v'</span>, <span class="string">'g'</span>, <span class="literal">null</span>, <span class="string">'x'</span>]</div></pre></td></tr></table></figure></p>
<p>在list中<code>+</code>的语义并没有发生变化,这是何等的重要啊~~~ 与<code>&lt;&lt;</code>相比, <code>+</code>会创建一个新的list,  但是这个创建的list很可能不是你所预期的, 而且这种方式也可能会导致一些性能问题.</p>
<p><code>Groovy development kit</code>同样提供了很多便捷的方式从list里删除元素:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'b'</span>,<span class="string">'b'</span>] - <span class="string">'c'</span> == [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'b'</span>,<span class="string">'b'</span>]</div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'b'</span>,<span class="string">'b'</span>] - <span class="string">'b'</span> == [<span class="string">'a'</span>,<span class="string">'c'</span>]</div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'b'</span>,<span class="string">'b'</span>] - [<span class="string">'b'</span>,<span class="string">'c'</span>] == [<span class="string">'a'</span>]</div><div class="line"></div><div class="line"><span class="keyword">def</span> list = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>]</div><div class="line">list -= <span class="number">3</span>           <span class="comment">// creates a new list by removing `3` from the original one</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">1</span>]</div><div class="line"><span class="keyword">assert</span> ( list -= [<span class="number">2</span>,<span class="number">4</span>] ) == [<span class="number">1</span>,<span class="number">1</span>]</div></pre></td></tr></table></figure></p>
<p>同样,你也能通过索引的方式从list里删除元素.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> list = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>]</div><div class="line"><span class="keyword">assert</span> list.remove(<span class="number">2</span>) == <span class="number">3</span>          <span class="comment">// remove the third element, and return it</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>]</div></pre></td></tr></table></figure></p>
<p>假设,你如果从list中删除多个相同元素中的第一个, 那你可以调用<code>remove</code>方法.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> list= [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'b'</span>,<span class="string">'b'</span>]</div><div class="line"><span class="keyword">assert</span> list.remove(<span class="string">'c'</span>)             <span class="comment">// remove 'c', and return true because element removed</span></div><div class="line"><span class="keyword">assert</span> list.remove(<span class="string">'b'</span>)             <span class="comment">// remove first 'b', and return true because element removed</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> ! list.remove(<span class="string">'z'</span>)           <span class="comment">// return false because no elements removed</span></div><div class="line"><span class="keyword">assert</span> list == [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'b'</span>]</div></pre></td></tr></table></figure></p>
<p>如果你想要将list清空的话,只需要调用<code>clear</code>方法即可<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> list= [<span class="string">'a'</span>,<span class="number">2</span>,<span class="string">'c'</span>,<span class="number">4</span>]</div><div class="line">list.clear()</div><div class="line"><span class="keyword">assert</span> list == []</div></pre></td></tr></table></figure></p>
<h5 id="Set-operations"><a href="#Set-operations" class="headerlink" title="Set operations"></a>Set operations</h5><p><code>Groovy development kit</code>还包含很多逻辑运算的方法<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> <span class="string">'a'</span> <span class="keyword">in</span> [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>]             <span class="comment">// returns true if an element belongs to the list</span></div><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>].contains(<span class="string">'a'</span>)      <span class="comment">// equivalent to the `contains` method in Java</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>].containsAll([<span class="number">1</span>,<span class="number">4</span>])       <span class="comment">// `containsAll` will check that all elements are found</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>].count(<span class="number">3</span>) == <span class="number">4</span>  <span class="comment">// count the number of elements which have some value</span></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>].count &#123;</div><div class="line">    it%<span class="number">2</span>==<span class="number">0</span>                             <span class="comment">// count the number of elements which match the predicate</span></div><div class="line">&#125; == <span class="number">2</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">8</span>,<span class="number">10</span>,<span class="number">12</span>].intersect([<span class="number">1</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">9</span>,<span class="number">12</span>]) == [<span class="number">1</span>,<span class="number">6</span>,<span class="number">12</span>]</div><div class="line"></div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].disjoint( [<span class="number">4</span>,<span class="number">6</span>,<span class="number">9</span>] )</div><div class="line"><span class="keyword">assert</span> ![<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].disjoint( [<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>] )</div></pre></td></tr></table></figure></p>
<h5 id="Sorting"><a href="#Sorting" class="headerlink" title="Sorting"></a>Sorting</h5><p>Groovy还提供了很多使用闭包比较器的排序操作<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> [<span class="number">6</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">5</span>].sort() == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">9</span>]</div><div class="line"></div><div class="line"><span class="keyword">def</span> list = [<span class="string">'abc'</span>, <span class="string">'z'</span>, <span class="string">'xyzuvw'</span>, <span class="string">'Hello'</span>, <span class="string">'321'</span>]</div><div class="line"><span class="keyword">assert</span> list.sort &#123;</div><div class="line">    it.size()</div><div class="line">&#125; == [<span class="string">'z'</span>, <span class="string">'abc'</span>, <span class="string">'321'</span>, <span class="string">'Hello'</span>, <span class="string">'xyzuvw'</span>]</div><div class="line"></div><div class="line"><span class="keyword">def</span> list2 = [<span class="number">7</span>, <span class="number">4</span>, <span class="number">-6</span>, <span class="number">-1</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">-9</span>, <span class="number">5</span>, <span class="number">-13</span>]</div><div class="line"><span class="keyword">assert</span> list2.sort &#123; a, b -&gt; a == b ? 0 : Math.abs(a) &lt; Math.abs(b) ? -1 : <span class="number">1</span> &#125; ==</div><div class="line">        [<span class="number">-1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">-6</span>, <span class="number">7</span>, <span class="number">-9</span>, <span class="number">11</span>, <span class="number">-13</span>]</div><div class="line"></div><div class="line">Comparator mc = &#123; a, b -&gt; a == b ? 0 : Math.abs(a) &lt; Math.abs(b) ? -1 : <span class="number">1</span> &#125;</div><div class="line"></div><div class="line"><span class="comment">// JDK 8+ only</span></div><div class="line"><span class="comment">// list2.sort(mc)</span></div><div class="line"><span class="comment">// assert list2 == [-1, 2, 3, 4, 5, -6, 7, -9, 11, -13]</span></div><div class="line"></div><div class="line"><span class="keyword">def</span> list3 = [<span class="number">6</span>, <span class="number">-3</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">-7</span>, <span class="number">1</span>, <span class="number">5</span>]</div><div class="line"></div><div class="line">Collections.sort(list3)</div><div class="line"><span class="keyword">assert</span> list3 == [<span class="number">-7</span>, <span class="number">-3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">9</span>]</div><div class="line"></div><div class="line">Collections.sort(list3, mc)</div><div class="line"><span class="keyword">assert</span> list3 == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">-3</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">-7</span>, <span class="number">9</span>]</div></pre></td></tr></table></figure></p>
<h5 id="Duplicating-elements"><a href="#Duplicating-elements" class="headerlink" title="Duplicating elements"></a>Duplicating elements</h5><p><code>roovy development kit</code>还通过重载操作符的方式, 内部提供了一些方法进行list元素复制.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] * <span class="number">3</span> == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</div><div class="line"><span class="keyword">assert</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].multiply(<span class="number">2</span>) == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</div><div class="line"><span class="keyword">assert</span> Collections.nCopies(<span class="number">3</span>, <span class="string">'b'</span>) == [<span class="string">'b'</span>, <span class="string">'b'</span>, <span class="string">'b'</span>]</div><div class="line"></div><div class="line"><span class="comment">// nCopies from the JDK has different semantics than multiply for lists</span></div><div class="line"><span class="keyword">assert</span> Collections.nCopies(<span class="number">2</span>, [<span class="number">1</span>, <span class="number">2</span>]) == [[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">1</span>, <span class="number">2</span>]] <span class="comment">//not [1,2,1,2]</span></div></pre></td></tr></table></figure></p>
<h3 id="Arrays"><a href="#Arrays" class="headerlink" title="Arrays"></a>Arrays</h3><p>Groovy 数组重用了list符号, 但是如果想要创建数组, 那么就必须强制地显式定义数组类型<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">String[] arrStr = [<span class="string">'Ananas'</span>, <span class="string">'Banana'</span>, <span class="string">'Kiwi'</span>]  (<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> arrStr <span class="keyword">instanceof</span> String[]    (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> !(arrStr <span class="keyword">instanceof</span> List)</div><div class="line"></div><div class="line"><span class="keyword">def</span> numArr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] <span class="keyword">as</span> <span class="keyword">int</span>[]      (<span class="number">3</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> numArr <span class="keyword">instanceof</span> <span class="keyword">int</span>[]       (<span class="number">4</span>)</div><div class="line"><span class="keyword">assert</span> numArr.size() == <span class="number">3</span></div></pre></td></tr></table></figure></p>
<ol>
<li>使用显式变量类型定义了一个字符串数组</li>
<li>断言刚才创建的数组是否是string类型</li>
<li>使用操作符定义一个int数组</li>
<li>断言刚才创建的数组是否是int类型</li>
</ol>
<p>我们也可以创建出一个多维数组<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> matrix3 = <span class="keyword">new</span> Integer[<span class="number">3</span>][<span class="number">3</span>]         (<span class="number">1</span>)</div><div class="line"><span class="keyword">assert</span> matrix3.size() == <span class="number">3</span></div><div class="line"></div><div class="line">Integer[][] matrix2                     (<span class="number">2</span>)</div><div class="line">matrix2 = [[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]]</div><div class="line"><span class="keyword">assert</span> matrix2 <span class="keyword">instanceof</span> Integer[][]</div></pre></td></tr></table></figure></p>
<ol>
<li>我们指定了新数组的边界</li>
<li>当然我们也可以不指定它的边界</li>
</ol>
<p>访问数组元素和访问list元素的方式相同<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">String[] names = [<span class="string">'Cédric'</span>, <span class="string">'Guillaume'</span>, <span class="string">'Jochen'</span>, <span class="string">'Paul'</span>]</div><div class="line"><span class="keyword">assert</span> names[<span class="number">0</span>] == <span class="string">'Cédric'</span>     (<span class="number">1</span>)</div><div class="line"></div><div class="line">names[<span class="number">2</span>] = <span class="string">'Blackdrag'</span>          (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> names[<span class="number">2</span>] == <span class="string">'Blackdrag'</span></div></pre></td></tr></table></figure></p>
<p>1    Retrieve the first element of the array<br>2    Set the value of the third element of the array to a new value</p>
<ol>
<li>检索数组中第一个元素</li>
<li>对数组中第三个元素重新赋值</li>
</ol>
<p>Groovy不支持Java数组初始化语法, 因为Java数组中的花括号可能被会Groovy无解成闭包</p>
<h3 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h3><p>有时候我们在其他语言中称map为 字典或者关联数组. Map将key和value关联起来, 在Groovy中map被<code>[]</code>括起来, 通过<code>,</code>分割键值对, 键值通过<code>:</code>分割<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> colors = [<span class="string">red:</span> <span class="string">'#FF0000'</span>, <span class="string">green:</span> <span class="string">'#00FF00'</span>, <span class="string">blue:</span> <span class="string">'#0000FF'</span>]   (<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> colors[<span class="string">'red'</span>] == <span class="string">'#FF0000'</span>    (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> colors.green  == <span class="string">'#00FF00'</span>    (<span class="number">3</span>)</div><div class="line"></div><div class="line">colors[<span class="string">'pink'</span>] = <span class="string">'#FF00FF'</span>           (<span class="number">4</span>)</div><div class="line">colors.yellow  = <span class="string">'#FFFF00'</span>           (<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> colors.pink == <span class="string">'#FF00FF'</span></div><div class="line"><span class="keyword">assert</span> colors[<span class="string">'yellow'</span>] == <span class="string">'#FFFF00'</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> colors <span class="keyword">instanceof</span> java.util.LinkedHashMap</div></pre></td></tr></table></figure></p>
<ol>
<li>我们定义了一个string类型的代表颜色名字的数组,</li>
<li>然后使用下标来检索map中是否包含red这个key</li>
<li>我们还可以直接使用<code>.</code>来索引到某个key</li>
<li>我们可以使用下标向map中添加一个新的键值对</li>
<li>我们也可以使用<code>.</code>添加一个新的键值对</li>
</ol>
<p>Groovy创建的map类型默认的是<code>java.util.LinkedHashMap</code></p>
<p>当你想要访问一个不存在的key时：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> colors.unknown == <span class="literal">null</span></div></pre></td></tr></table></figure></p>
<p>你将检索出一个null的结果</p>
<p>在上面的例子中我们使用的是以string作为key, 但是你还可以使用其他类型作为map的key：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> numbers = [<span class="number">1</span>: <span class="string">'one'</span>, <span class="number">2</span>: <span class="string">'two'</span>]</div><div class="line"></div><div class="line"><span class="keyword">assert</span> numbers[<span class="number">1</span>] == <span class="string">'one'</span></div></pre></td></tr></table></figure>
<p>我们使用了number作为了map新的key类型, number类型就会直接被解释为number类型, 因此Groovy不会像先前那样创建一个string类型的key. 但是假设你想要传递一个变量作为key,是变量的值作为key：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> key = <span class="string">'name'</span></div><div class="line"><span class="keyword">def</span> person = [<span class="string">key:</span> <span class="string">'Guillaume'</span>]      (<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> !person.containsKey(<span class="string">'name'</span>)   (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> person.containsKey(<span class="string">'key'</span>)     (<span class="number">3</span>)</div></pre></td></tr></table></figure>
<ol>
<li>与<code>\&#39;Guillaume&#39;</code> 关联的key实际上是<code>&quot;key&quot;</code>这个字符串, 而不是这个key的引用值<code>&#39;name&#39;</code></li>
<li>map中不包含<code>&#39;name&#39;</code>key</li>
<li>取而代之的是map中包含一个<code>&quot;key&quot;</code>的字符串</li>
</ol>
<p>你可以向map中传递一个引号字符串作为key,例如<code>[&quot;name&quot;: &quot;Guillaume&quot;]</code>.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">person = [(key): <span class="string">'Guillaume'</span>]        (<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="keyword">assert</span> person.containsKey(<span class="string">'name'</span>)    (<span class="number">2</span>)</div><div class="line"><span class="keyword">assert</span> !person.containsKey(<span class="string">'key'</span>)    (<span class="number">3</span>)</div></pre></td></tr></table></figure>
<p>1    This time, we surround the key variable with parentheses, to instruct the parser we are passing a variable rather than defining a string key<br>2    The map does contain the name key<br>3    But the map doesn’t contain the key key as before<br>1.<br>2.<br>3.</p>
<h4 id="Map-literals"><a href="#Map-literals" class="headerlink" title="Map literals"></a>Map literals</h4><p>在Groovy中可以使用<code>[:]</code> 创建一个map.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> map = [<span class="string">name:</span> <span class="string">'Gromit'</span>, <span class="string">likes:</span> <span class="string">'cheese'</span>, <span class="string">id:</span> <span class="number">1234</span>]</div><div class="line"><span class="keyword">assert</span> map.get(<span class="string">'name'</span>) == <span class="string">'Gromit'</span></div><div class="line"><span class="keyword">assert</span> map.get(<span class="string">'id'</span>) == <span class="number">1234</span></div><div class="line"><span class="keyword">assert</span> map[<span class="string">'name'</span>] == <span class="string">'Gromit'</span></div><div class="line"><span class="keyword">assert</span> map[<span class="string">'id'</span>] == <span class="number">1234</span></div><div class="line"><span class="keyword">assert</span> map <span class="keyword">instanceof</span> java.util.Map</div><div class="line"></div><div class="line"><span class="keyword">def</span> emptyMap = [:]</div><div class="line"><span class="keyword">assert</span> emptyMap.size() == <span class="number">0</span></div><div class="line">emptyMap.put(<span class="string">"foo"</span>, <span class="number">5</span>)</div><div class="line"><span class="keyword">assert</span> emptyMap.size() == <span class="number">1</span></div><div class="line"><span class="keyword">assert</span> emptyMap.get(<span class="string">"foo"</span>) == <span class="number">5</span></div></pre></td></tr></table></figure></p>
<p>Map的key默认是<code>string</code>, 例如<code>[a:1]</code>等同于<code>[&#39;a&#39;:1]</code>. 比较荣誉造成疑惑的就是,如果你创建了一个变量a(值为b), 但是你将变量a<code>put</code>进map后, map的key会是a,而不是b. 如果你遇到了这个情况的话,那么你必须对使用<code>()</code>key进行转义了.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> a = <span class="string">'Bob'</span></div><div class="line"><span class="keyword">def</span> ages = [<span class="string">a:</span> <span class="number">43</span>]</div><div class="line"><span class="keyword">assert</span> ages[<span class="string">'Bob'</span>] == <span class="literal">null</span> <span class="comment">// `Bob` is not found</span></div><div class="line"><span class="keyword">assert</span> ages[<span class="string">'a'</span>] == <span class="number">43</span>     <span class="comment">// because `a` is a literal!</span></div><div class="line"></div><div class="line">ages = [(a): <span class="number">43</span>]            <span class="comment">// now we escape `a` by using parenthesis</span></div><div class="line"><span class="keyword">assert</span> ages[<span class="string">'Bob'</span>] == <span class="number">43</span>   <span class="comment">// and the value is found!</span></div></pre></td></tr></table></figure></p>
<p>通过下面的方式你可以轻松克隆一个map<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> map = [</div><div class="line">        <span class="string">simple :</span> <span class="number">123</span>,</div><div class="line"><span class="symbol">        complex:</span> [<span class="string">a:</span> <span class="number">1</span>, <span class="string">b:</span> <span class="number">2</span>]</div><div class="line">]</div><div class="line"><span class="keyword">def</span> map2 = map.clone()</div><div class="line"><span class="keyword">assert</span> map2.get(<span class="string">'simple'</span>) == map.get(<span class="string">'simple'</span>)</div><div class="line"><span class="keyword">assert</span> map2.get(<span class="string">'complex'</span>) == map.get(<span class="string">'complex'</span>)</div><div class="line">map2.get(<span class="string">'complex'</span>).put(<span class="string">'c'</span>, <span class="number">3</span>)</div><div class="line"><span class="keyword">assert</span> map.get(<span class="string">'complex'</span>).get(<span class="string">'c'</span>) == <span class="number">3</span></div></pre></td></tr></table></figure></p>
<h4 id="Map-property-notation"><a href="#Map-property-notation" class="headerlink" title="Map property notation"></a>Map property notation</h4><p>Maps和beans也是非常相像的, 所以你可以对map使用<code>get/set</code>操作元素,当然这也有个前提,那就是map中的key必须是符合Groovy标识符的key.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> map = [<span class="string">name:</span> <span class="string">'Gromit'</span>, <span class="string">likes:</span> <span class="string">'cheese'</span>, <span class="string">id:</span> <span class="number">1234</span>]</div><div class="line"><span class="keyword">assert</span> map.name == <span class="string">'Gromit'</span>     <span class="comment">// can be used instead of map.get('Gromit')</span></div><div class="line"><span class="keyword">assert</span> map.id == <span class="number">1234</span></div><div class="line"></div><div class="line"><span class="keyword">def</span> emptyMap = [:]</div><div class="line"><span class="keyword">assert</span> emptyMap.size() == <span class="number">0</span></div><div class="line">emptyMap.foo = <span class="number">5</span></div><div class="line"><span class="keyword">assert</span> emptyMap.size() == <span class="number">1</span></div><div class="line"><span class="keyword">assert</span> emptyMap.foo == <span class="number">5</span></div></pre></td></tr></table></figure>
<p>注意:<code>map.foo</code>总是会在map中查找key<code>foo</code>. 这意味着,<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> map = [<span class="string">name:</span> <span class="string">'Gromit'</span>, <span class="string">likes:</span> <span class="string">'cheese'</span>, <span class="string">id:</span> <span class="number">1234</span>]</div><div class="line"><span class="keyword">assert</span> map.<span class="keyword">class</span> == <span class="literal">null</span></div><div class="line"><span class="keyword">assert</span> map.get(<span class="string">'class'</span>) == <span class="literal">null</span></div><div class="line"><span class="keyword">assert</span> map.getClass() == LinkedHashMap <span class="comment">// this is probably what you want</span></div><div class="line"></div><div class="line">map = [<span class="number">1</span>      : <span class="string">'a'</span>,</div><div class="line">       (<span class="literal">true</span>) : <span class="string">'p'</span>,</div><div class="line">       (<span class="literal">false</span>): <span class="string">'q'</span>,</div><div class="line">       (<span class="literal">null</span>) : <span class="string">'x'</span>,</div><div class="line">       <span class="string">'null'</span> : <span class="string">'z'</span>]</div><div class="line"><span class="keyword">assert</span> map.containsKey(<span class="number">1</span>) <span class="comment">// 1 is not an identifier so used as is</span></div><div class="line"><span class="keyword">assert</span> map.<span class="literal">true</span> == <span class="literal">null</span></div><div class="line"><span class="keyword">assert</span> map.<span class="literal">false</span> == <span class="literal">null</span></div><div class="line"><span class="keyword">assert</span> map.get(<span class="literal">true</span>) == <span class="string">'p'</span></div><div class="line"><span class="keyword">assert</span> map.get(<span class="literal">false</span>) == <span class="string">'q'</span></div><div class="line"><span class="keyword">assert</span> map.<span class="literal">null</span> == <span class="string">'z'</span></div><div class="line"><span class="keyword">assert</span> map.get(<span class="literal">null</span>) == <span class="string">'x'</span></div></pre></td></tr></table></figure></p>
<h4 id="Iterating-on-maps"><a href="#Iterating-on-maps" class="headerlink" title="Iterating on maps"></a>Iterating on maps</h4><p><code>Groovy development kit</code>还提供了<code>eachWithIndex</code>方法遍历map.值得注意的是,map会保留put元素的顺序,也就是说,当你遍历一个map的时候,无论进行多少次,你获得的元素的顺序是一定的.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> map = [</div><div class="line">        <span class="string">Bob  :</span> <span class="number">42</span>,</div><div class="line"><span class="symbol">        Alice:</span> <span class="number">54</span>,</div><div class="line">        <span class="string">Max  :</span> <span class="number">33</span></div><div class="line">]</div><div class="line"></div><div class="line"><span class="comment">// `entry` is a map entry</span></div><div class="line">map.each &#123; entry -&gt;</div><div class="line">    println <span class="string">"Name: $entry.key Age: $entry.value"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// `entry` is a map entry, `i` the index in the map</span></div><div class="line">map.eachWithIndex &#123; entry, i -&gt;</div><div class="line">    println <span class="string">"$i - Name: $entry.key Age: $entry.value"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Alternatively you can use key and value directly</span></div><div class="line">map.each &#123; key, value -&gt;</div><div class="line">    println <span class="string">"Name: $key Age: $value"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Key, value and i as the index in the map</span></div><div class="line">map.eachWithIndex &#123; key, value, i -&gt;</div><div class="line">    println <span class="string">"$i - Name: $key Age: $value"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Manipulating-maps"><a href="#Manipulating-maps" class="headerlink" title="Manipulating maps"></a>Manipulating maps</h4><h5 id="Adding-or-removing-elements-1"><a href="#Adding-or-removing-elements-1" class="headerlink" title="Adding or removing elements"></a>Adding or removing elements</h5><p>向map中添加元素你可以使用<code>put</code>方法, <code>下标</code>, <code>putAll</code>方法.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> defaults = [<span class="number">1</span>: <span class="string">'a'</span>, <span class="number">2</span>: <span class="string">'b'</span>, <span class="number">3</span>: <span class="string">'c'</span>, <span class="number">4</span>: <span class="string">'d'</span>]</div><div class="line"><span class="keyword">def</span> overrides = [<span class="number">2</span>: <span class="string">'z'</span>, <span class="number">5</span>: <span class="string">'x'</span>, <span class="number">13</span>: <span class="string">'x'</span>]</div><div class="line"></div><div class="line"><span class="keyword">def</span> result = <span class="keyword">new</span> LinkedHashMap(defaults)</div><div class="line">result.put(<span class="number">15</span>, <span class="string">'t'</span>)</div><div class="line">result[<span class="number">17</span>] = <span class="string">'u'</span></div><div class="line">result.putAll(overrides)</div><div class="line"><span class="keyword">assert</span> result == [<span class="number">1</span>: <span class="string">'a'</span>, <span class="number">2</span>: <span class="string">'z'</span>, <span class="number">3</span>: <span class="string">'c'</span>, <span class="number">4</span>: <span class="string">'d'</span>, <span class="number">5</span>: <span class="string">'x'</span>, <span class="number">13</span>: <span class="string">'x'</span>, <span class="number">15</span>: <span class="string">'t'</span>, <span class="number">17</span>: <span class="string">'u'</span>]</div></pre></td></tr></table></figure></p>
<p>如果想要删除map中全部的元素,可以使用<code>clear</code>方法.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> m = [<span class="number">1</span>:<span class="string">'a'</span>, <span class="number">2</span>:<span class="string">'b'</span>]</div><div class="line"><span class="keyword">assert</span> m.get(<span class="number">1</span>) == <span class="string">'a'</span></div><div class="line">m.clear()</div><div class="line"><span class="keyword">assert</span> m == [:]</div></pre></td></tr></table></figure></p>
<p>通过map字面量标记创建的map会使用<code>object</code>的<code>equals</code>方法和<code>hashcode</code>方法.</p>
<p>还要注意的是,不要使用GString作为map的key, 因为GString的hashcode方法和String的hashcode方法不一样.<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> key = <span class="string">'some key'</span></div><div class="line"><span class="keyword">def</span> map = [:]</div><div class="line"><span class="keyword">def</span> gstringKey = <span class="string">"$&#123;key.toUpperCase()&#125;"</span></div><div class="line">map.put(gstringKey,<span class="string">'value'</span>)</div><div class="line"><span class="keyword">assert</span> map.get(<span class="string">'SOME KEY'</span>) == <span class="literal">null</span></div></pre></td></tr></table></figure></p>
<h5 id="Keys-values-and-entries"><a href="#Keys-values-and-entries" class="headerlink" title="Keys, values and entries"></a>Keys, values and entries</h5><p>我们可以在视图中inspect<code>keys, values, and entries</code><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> map = [<span class="number">1</span>:<span class="string">'a'</span>, <span class="number">2</span>:<span class="string">'b'</span>, <span class="number">3</span>:<span class="string">'c'</span>]</div><div class="line"></div><div class="line"><span class="keyword">def</span> entries = map.entrySet()</div><div class="line">entries.each &#123; entry -&gt;</div><div class="line">  <span class="keyword">assert</span> entry.key <span class="keyword">in</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</div><div class="line">  <span class="keyword">assert</span> entry.value <span class="keyword">in</span> [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>]</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">def</span> keys = map.keySet()</div><div class="line"><span class="keyword">assert</span> keys == [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="keyword">as</span> Set</div></pre></td></tr></table></figure></p>
<p>Mutating values returned by the view (be it a map entry, a key or a value) is highly discouraged because success of the operation directly depends on the type of the map being manipulated. In particular, Groovy relies on collections from the JDK that in general make no guarantee that a collection can safely be manipulated through keySet, entrySet, or values.</p>
<h5 id="Filtering-and-searching-1"><a href="#Filtering-and-searching-1" class="headerlink" title="Filtering and searching"></a>Filtering and searching</h5><p>The Groovy development kit contains filtering, searching and collecting methods similar to those found for lists:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">def</span> people = [</div><div class="line"><span class="symbol">    1:</span> [<span class="string">name:</span><span class="string">'Bob'</span>, <span class="string">age:</span> <span class="number">32</span>, <span class="string">gender:</span> <span class="string">'M'</span>],</div><div class="line"><span class="symbol">    2:</span> [<span class="string">name:</span><span class="string">'Johnny'</span>, <span class="string">age:</span> <span class="number">36</span>, <span class="string">gender:</span> <span class="string">'M'</span>],</div><div class="line"><span class="symbol">    3:</span> [<span class="string">name:</span><span class="string">'Claire'</span>, <span class="string">age:</span> <span class="number">21</span>, <span class="string">gender:</span> <span class="string">'F'</span>],</div><div class="line"><span class="symbol">    4:</span> [<span class="string">name:</span><span class="string">'Amy'</span>, <span class="string">age:</span> <span class="number">54</span>, <span class="string">gender:</span><span class="string">'F'</span>]</div><div class="line">]</div><div class="line"></div><div class="line"><span class="keyword">def</span> bob = people.find &#123; it.value.name == <span class="string">'Bob'</span> &#125; <span class="comment">// find a single entry</span></div><div class="line"><span class="keyword">def</span> females = people.findAll &#123; it.value.gender == <span class="string">'F'</span> &#125;</div><div class="line"></div><div class="line"><span class="comment">// both return entries, but you can use collect to retrieve the ages for example</span></div><div class="line"><span class="keyword">def</span> ageOfBob = bob.value.age</div><div class="line"><span class="keyword">def</span> agesOfFemales = females.collect &#123;</div><div class="line">    it.value.age</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">assert</span> ageOfBob == <span class="number">32</span></div><div class="line"><span class="keyword">assert</span> agesOfFemales == [<span class="number">21</span>,<span class="number">54</span>]</div><div class="line"></div><div class="line"><span class="comment">// but you could also use a key/pair value as the parameters of the closures</span></div><div class="line"><span class="keyword">def</span> agesOfMales = people.findAll &#123; id, person -&gt;</div><div class="line">    person.gender == <span class="string">'M'</span></div><div class="line">&#125;.collect &#123; id, person -&gt;</div><div class="line">    person.age</div><div class="line">&#125;</div><div class="line"><span class="keyword">assert</span> agesOfMales == [<span class="number">32</span>, <span class="number">36</span>]</div><div class="line"></div><div class="line"><span class="comment">// `every` returns true if all entries match the predicate</span></div><div class="line"><span class="keyword">assert</span> people.every &#123; id, person -&gt;</div><div class="line">    person.age &gt; <span class="number">18</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// `any` returns true if any entry matches the predicate</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> people.any &#123; id, person -&gt;</div><div class="line">    person.age == <span class="number">54</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="Grouping"><a href="#Grouping" class="headerlink" title="Grouping"></a>Grouping</h5><p>We can group a list into a map using some criteria:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">assert</span> [<span class="string">'a'</span>, <span class="number">7</span>, <span class="string">'b'</span>, [<span class="number">2</span>, <span class="number">3</span>]].groupBy &#123;</div><div class="line">    it.<span class="keyword">class</span></div><div class="line">&#125; == [(String)   : [<span class="string">'a'</span>, <span class="string">'b'</span>],</div><div class="line">      (Integer)  : [<span class="number">7</span>],</div><div class="line">      (ArrayList): [[<span class="number">2</span>, <span class="number">3</span>]]</div><div class="line">]</div><div class="line"></div><div class="line"><span class="keyword">assert</span> [</div><div class="line">        [<span class="string">name:</span> <span class="string">'Clark'</span>, <span class="string">city:</span> <span class="string">'London'</span>], [<span class="string">name:</span> <span class="string">'Sharma'</span>, <span class="string">city:</span> <span class="string">'London'</span>],</div><div class="line">        [<span class="string">name:</span> <span class="string">'Maradona'</span>, <span class="string">city:</span> <span class="string">'LA'</span>], [<span class="string">name:</span> <span class="string">'Zhang'</span>, <span class="string">city:</span> <span class="string">'HK'</span>],</div><div class="line">        [<span class="string">name:</span> <span class="string">'Ali'</span>, <span class="string">city:</span> <span class="string">'HK'</span>], [<span class="string">name:</span> <span class="string">'Liu'</span>, <span class="string">city:</span> <span class="string">'HK'</span>],</div><div class="line">].groupBy &#123; it.city &#125; == [</div><div class="line"><span class="symbol">        London:</span> [[<span class="string">name:</span> <span class="string">'Clark'</span>, <span class="string">city:</span> <span class="string">'London'</span>],</div><div class="line">                 [<span class="string">name:</span> <span class="string">'Sharma'</span>, <span class="string">city:</span> <span class="string">'London'</span>]],</div><div class="line">        <span class="string">LA    :</span> [[<span class="string">name:</span> <span class="string">'Maradona'</span>, <span class="string">city:</span> <span class="string">'LA'</span>]],</div><div class="line">        <span class="string">HK    :</span> [[<span class="string">name:</span> <span class="string">'Zhang'</span>, <span class="string">city:</span> <span class="string">'HK'</span>],</div><div class="line">                 [<span class="string">name:</span> <span class="string">'Ali'</span>, <span class="string">city:</span> <span class="string">'HK'</span>],</div><div class="line">                 [<span class="string">name:</span> <span class="string">'Liu'</span>, <span class="string">city:</span> <span class="string">'HK'</span>]],</div><div class="line">]</div></pre></td></tr></table></figure>
<h3 id="Ranges"><a href="#Ranges" class="headerlink" title="Ranges"></a>Ranges</h3><p>Ranges allow you to create a list of sequential values. These can be used as List since Range extends java.util.List.</p>
<p>Ranges defined with the .. notation are inclusive (that is the list contains the from and to value).</p>
<p>Ranges defined with the ..&lt; notation are half-open, they include the first value but not the last value.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// an inclusive range</span></div><div class="line"><span class="keyword">def</span> range = <span class="number">5.</span><span class="number">.8</span></div><div class="line"><span class="keyword">assert</span> range.size() == <span class="number">4</span></div><div class="line"><span class="keyword">assert</span> range.get(<span class="number">2</span>) == <span class="number">7</span></div><div class="line"><span class="keyword">assert</span> range[<span class="number">2</span>] == <span class="number">7</span></div><div class="line"><span class="keyword">assert</span> range <span class="keyword">instanceof</span> java.util.List</div><div class="line"><span class="keyword">assert</span> range.contains(<span class="number">5</span>)</div><div class="line"><span class="keyword">assert</span> range.contains(<span class="number">8</span>)</div><div class="line"></div><div class="line"><span class="comment">// lets use a half-open range</span></div><div class="line">range = <span class="number">5.</span>.&lt;<span class="number">8</span></div><div class="line"><span class="keyword">assert</span> range.size() == <span class="number">3</span></div><div class="line"><span class="keyword">assert</span> range.get(<span class="number">2</span>) == <span class="number">7</span></div><div class="line"><span class="keyword">assert</span> range[<span class="number">2</span>] == <span class="number">7</span></div><div class="line"><span class="keyword">assert</span> range <span class="keyword">instanceof</span> java.util.List</div><div class="line"><span class="keyword">assert</span> range.contains(<span class="number">5</span>)</div><div class="line"><span class="keyword">assert</span> !range.contains(<span class="number">8</span>)</div><div class="line"></div><div class="line"><span class="comment">//get the end points of the range without using indexes</span></div><div class="line">range = <span class="number">1.</span><span class="number">.10</span></div><div class="line"><span class="keyword">assert</span> range.from == <span class="number">1</span></div><div class="line"><span class="keyword">assert</span> range.to == <span class="number">10</span></div></pre></td></tr></table></figure>
<p>Note that int ranges are implemented efficiently, creating a lightweight Java object containing a from and to value.</p>
<p>Ranges can be used for any Java object which implements java.lang.Comparable for comparison and also have methods next() and previous() to return the next / previous item in the range. For example, you can create a range of String elements:</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/编程语言/">编程语言</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2014/04/11/编程语言/Groovy 集合/#comments" class="ds-thread-count comments-count-link" data-thread-key="2014/04/11/编程语言/Groovy 集合/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/6/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/8/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="yu66" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/JVM/" title="JVM">JVM<sup>13</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java/" title="Java">Java<sup>24</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java-Library/" title="Java Library">Java Library<sup>34</sup></a></li>
		  
		
		  
			<li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/NoSql/" title="NoSql">NoSql<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/数据库/" title="数据库">数据库<sup>7</sup></a></li>
		  
		
		  
			<li><a href="/categories/杂记/" title="杂记">杂记<sup>18</sup></a></li>
		  
		
		  
			<li><a href="/categories/算法/" title="算法">算法<sup>11</sup></a></li>
		  
		
		  
			<li><a href="/categories/编程语言/" title="编程语言">编程语言<sup>20</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Netty/" title="Netty">Netty<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/asm/" title="asm">asm<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Spring/" title="Spring">Spring<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Guice/" title="Guice">Guice<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://vertx.yu66.wang/" target="_blank" title="vertx3">vertx3</a>
            
          </li>
        
    </ul>
</div>

  

<div class="doubanshow">
<p class="asidetitle">豆瓣秀</p>
<div>
<script type="text/javascript" src="http://www.douban.com/service/badge/xxxyy/?show=collection&amp;n=12&amp;columns=3&amp;hidelogo=yes&amp;hideself=yes&amp;cat=book|movie" ></script>
</div>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=3253370782&verifier=e9ca895b&dpc=1"></iframe>
</div>


  

<div class="lofter">
<p class="asidetitle">Lofter</p>

 <iframe width="100%" height="39" class="share_self"  frameborder="0" scrolling="no" src="http://ming15.lofter.com/"></iframe>
</div>




</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 博客,我选择重构 <br/>
			重构使事情变得更美,更加正确</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/3253370782" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/yu66" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		<a href="https://www.douban.com/people/xxxyy" target="_blank" class="icon-douban" title="豆瓣"></a>
		
		
		<a href="http://www.zhihu.com/people/ming15" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="王玉">王玉</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"wanggnim"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F9e8fca440159a2125668804e46682db4' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
