
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>王玉</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="王玉">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="王玉">
<meta property="og:url" content="http://www.yu66.wang/page/3/index.html">
<meta property="og:site_name" content="王玉">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="王玉">

    
    <link rel="alternative" href="/atom.xml" title="王玉" type="application/atom+xml">
    
    
    
    <link rel="apple-touch-icon" href="/img/author.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/author.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="王玉" title="王玉"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="王玉">王玉</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
						<form class="search" action="http://zhannei.baidu.com/cse/search" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= 17728547076946147000 ><input type="text" name="q" size="30" placeholder="Search"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/27/zookeeper/ZooKeeper Curator 基本操作/" title="ZooKeeper Curator 基本操作" itemprop="url">ZooKeeper Curator 基本操作</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-04-27T07:00:00.000Z" itemprop="datePublished"> Published 2016-04-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>Curator的Framework API为我们操作Zookeeper提供了非常便捷的操作. 它在ZooKeeper API之上为我们增加里许多新的特性, 例如对ZooKeeper集群连接的管理以及重试操作等等. 下面就列举了一些特性:</p>
<ul>
<li>自动连接管理</li>
<li>Leader 选举</li>
<li>共享锁</li>
<li>路径缓存以及watch</li>
<li>分布式队列(以及分布式Priority队列)</li>
</ul>
<p>我们根据下面的例子看一下Curator Framework的增删改查操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</div><div class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</div><div class="line"><span class="keyword">import</span> org.apache.curator.utils.CloseableUtils;</div><div class="line"><span class="keyword">import</span> org.apache.zookeeper.CreateMode;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCurator</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		CuratorFramework client = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client = CuratorFrameworkFactory.newClient(<span class="string">"0.0.0.0:2181"</span>, <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</div><div class="line">			client.start();</div><div class="line"></div><div class="line">			<span class="comment">// 创建一个临时节点, 如果父节点不存在, 则将父节点也创建出来</span></div><div class="line">			client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(<span class="string">"/Servers/LoginServer"</span>);</div><div class="line"></div><div class="line">			<span class="comment">// 查看根节点下的所有节点, 但是不会对子节点进行递归查询</span></div><div class="line">			client.getChildren().forPath(<span class="string">"/"</span>).forEach(path -&gt; System.out.println(<span class="string">"Exist : "</span> + path));</div><div class="line"></div><div class="line">			<span class="comment">// 设置数据</span></div><div class="line">			client.setData().forPath(<span class="string">"/Servers/LoginServer"</span>, <span class="string">"192.168.15.15"</span>.getBytes());</div><div class="line"></div><div class="line">			<span class="comment">// 获取节点数据</span></div><div class="line">			System.out.println(<span class="string">"Data : "</span> + client.getData().forPath(<span class="string">"/Servers/LoginServer"</span>));</div><div class="line"></div><div class="line">			<span class="comment">// 将子节点和父节点一起删除</span></div><div class="line">			client.delete().deletingChildrenIfNeeded().forPath(<span class="string">"/Servers"</span>);</div><div class="line"></div><div class="line">			<span class="comment">// 验证最后还有哪些节点存在</span></div><div class="line">			client.getChildren().forPath(<span class="string">"/"</span>).forEach(path -&gt; System.out.println(<span class="string">"Exist : "</span> + path));</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			CloseableUtils.closeQuietly(client);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Exist : Servers</div><div class="line">Exist : zookeeper</div><div class="line">Data : [B@63753b6d</div></pre></td></tr></table></figure></p>
<blockquote>
<p>如果要异步执行的话, 只需要调用相关逻辑的background方法就好了</p>
</blockquote>
<p>我们使用的是Curator2.x版本<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>我们应该使用curator-framework, 而不是使用curator-client<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>curator-client是对Zookepper官方API的一个简单封装, 如果我们使用curator-client, 还需要自己处理一些底层问题, 例如失败重连等问题<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">RetryLoop retryLoop = client.newRetryLoop();</div><div class="line"><span class="keyword">while</span> ( retryLoop.shouldContinue() )</div><div class="line">&#123;</div><div class="line">   <span class="keyword">try</span></div><div class="line">   &#123;</div><div class="line">       <span class="comment">// perform your work</span></div><div class="line">       ...</div><div class="line">       <span class="comment">// it's important to re\-get the ZK instance as there may have been an error and the instance was re\-created</span></div><div class="line">       ZooKeeper      zk = client.getZookeeper();</div><div class="line">       retryLoop.markComplete();</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">catch</span> ( Exception e )</div><div class="line">   &#123;</div><div class="line">       retryLoop.takeException(e);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">RetryLoop.callWithRetry(client, <span class="keyword">new</span> Callable&lt;Void&gt;()</div><div class="line">&#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> Void <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span></div><div class="line">      &#123;</div><div class="line">          <span class="comment">// do your work here - it will get retried if needed</span></div><div class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/ZooKeeper/">ZooKeeper</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/27/zookeeper/ZooKeeper Curator 基本操作/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/27/zookeeper/ZooKeeper Curator 基本操作/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/26/zookeeper/ZooKeeper Curator 事件监听/" title="ZooKeeper Curator 事件监听" itemprop="url">ZooKeeper Curator 事件监听</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-04-26T07:00:00.000Z" itemprop="datePublished"> Published 2016-04-26</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="监测时检查出已有节点"><a href="#监测时检查出已有节点" class="headerlink" title="监测时检查出已有节点"></a>监测时检查出已有节点</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> zk;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Date;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.cache.ChildData;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.cache.PathChildrenCache;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.cache.PathChildrenCacheEvent;</div><div class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.cache.PathChildrenCacheListener;</div><div class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</div><div class="line"><span class="keyword">import</span> org.apache.curator.utils.CloseableUtils;</div><div class="line"><span class="keyword">import</span> org.apache.curator.utils.ZKPaths;</div><div class="line"><span class="keyword">import</span> org.apache.zookeeper.CreateMode;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathCacheExample</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line"></div><div class="line">		ZKClient zkClient1 = register(<span class="string">"Server1"</span>);</div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">10</span>);</div><div class="line"></div><div class="line">		ZKClient zkClient2 = register(<span class="string">"Server2"</span>);</div><div class="line">		ZKClient zkClient3 = register(<span class="string">"Server3"</span>);</div><div class="line"></div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">5</span>);</div><div class="line">		zkClient1.closeAllService();</div><div class="line">		zkClient2.closeAllService();</div><div class="line">		zkClient3.closeAllService();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZKClient <span class="title">register</span><span class="params">(String serverName)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		ZKClient zkClient = <span class="keyword">new</span> ZKClient(serverName);</div><div class="line">		Thread thread = <span class="keyword">new</span> Thread(zkClient);</div><div class="line">		thread.start();</div><div class="line">		<span class="keyword">return</span> zkClient;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZKClient</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"/ServersCache1"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> CuratorFramework client = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> PathChildrenCache cache = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> String servername = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeAllService</span><span class="params">()</span> </span>&#123;</div><div class="line">		closeCuratorFramework();</div><div class="line">		closePathChildrenCache();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeCuratorFramework</span><span class="params">()</span> </span>&#123;</div><div class="line">		CloseableUtils.closeQuietly(cache);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closePathChildrenCache</span><span class="params">()</span> </span>&#123;</div><div class="line">		CloseableUtils.closeQuietly(client);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ZKClient</span><span class="params">(String serverName)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.servername = serverName;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client = CuratorFrameworkFactory.newClient(<span class="string">"0.0.0.0:2181"</span>, <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</div><div class="line">			client.start();</div><div class="line">			cache = <span class="keyword">new</span> PathChildrenCache(client, PATH, <span class="keyword">true</span>);</div><div class="line">			cache.start();</div><div class="line">			addListener(cache);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		create(client, servername, servername);</div><div class="line">		setValue(client, servername, servername);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			TimeUnit.SECONDS.sleep(<span class="number">1</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(PathChildrenCache cache)</span> </span>&#123;</div><div class="line">		PathChildrenCacheListener listener = (client, event) -&gt; &#123;</div><div class="line">			<span class="keyword">switch</span> (event.getType()) &#123;</div><div class="line">				<span class="keyword">case</span> CHILD_ADDED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"added"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">case</span> CHILD_UPDATED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"changed"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">case</span> CHILD_REMOVED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"removed"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		cache.getListenable().addListener(listener);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printNodeStateChange</span><span class="params">(String type, String path)</span> </span>&#123;</div><div class="line">		System.out.println(servername + <span class="string">" Monitor Node "</span> + type + <span class="string">": "</span> + path + <span class="string">". "</span> + <span class="keyword">new</span> Date().toLocaleString());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(CuratorFramework client, String pathName)</span> </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.delete().deletingChildrenIfNeeded().forPath(path);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(CuratorFramework client, String pathName, String data)</span>  </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(path, data.getBytes());</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(CuratorFramework client, String pathName, String data)</span> </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.setData().forPath(path, data.getBytes());</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Server1 Monitor Node added: /ServersCache1/Server1. 2016-4-28 18:41:54</div><div class="line">Server1 Monitor Node added: /ServersCache1/Server2. 2016-4-28 18:42:04</div><div class="line">Server1 Monitor Node added: /ServersCache1/Server3. 2016-4-28 18:42:04</div><div class="line">Server3 Monitor Node added: /ServersCache1/Server1. 2016-4-28 18:42:04</div><div class="line">Server3 Monitor Node added: /ServersCache1/Server2. 2016-4-28 18:42:04</div><div class="line">Server3 Monitor Node added: /ServersCache1/Server3. 2016-4-28 18:42:04</div><div class="line">Server2 Monitor Node added: /ServersCache1/Server1. 2016-4-28 18:42:04</div><div class="line">Server2 Monitor Node added: /ServersCache1/Server2. 2016-4-28 18:42:04</div><div class="line">Server2 Monitor Node added: /ServersCache1/Server3. 2016-4-28 18:42:04</div><div class="line">Server3 Monitor Node removed: /ServersCache1/Server1. 2016-4-28 18:42:09</div><div class="line">Server2 Monitor Node removed: /ServersCache1/Server1. 2016-4-28 18:42:09</div><div class="line">Server3 Monitor Node removed: /ServersCache1/Server2. 2016-4-28 18:42:09</div></pre></td></tr></table></figure></p>
<h2 id="删除节点监测"><a href="#删除节点监测" class="headerlink" title="删除节点监测"></a>删除节点监测</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathCacheExample</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line"></div><div class="line">		ZKClient zkClient1 = register(<span class="string">"Server1"</span>);</div><div class="line"></div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		ZKClient zkClient2 = register(<span class="string">"Server2"</span>);</div><div class="line">		ZKClient zkClient3 = register(<span class="string">"Server3"</span>);</div><div class="line"></div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZKClient <span class="title">register</span><span class="params">(String serverName)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		ZKClient zkClient = <span class="keyword">new</span> ZKClient(serverName);</div><div class="line">		Thread thread = <span class="keyword">new</span> Thread(zkClient);</div><div class="line">		thread.start();</div><div class="line">		<span class="keyword">return</span> zkClient;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZKClient</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"/ServersCache5"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> CuratorFramework client = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> PathChildrenCache cache = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> String servername = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeAllService</span><span class="params">()</span> </span>&#123;</div><div class="line">		closeCuratorFramework();</div><div class="line">		closePathChildrenCache();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeCuratorFramework</span><span class="params">()</span> </span>&#123;</div><div class="line">		CloseableUtils.closeQuietly(client);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closePathChildrenCache</span><span class="params">()</span> </span>&#123;</div><div class="line">		CloseableUtils.closeQuietly(cache);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ZKClient</span><span class="params">(String serverName)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.servername = serverName;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client = CuratorFrameworkFactory.newClient(<span class="string">"0.0.0.0:2181"</span>, <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</div><div class="line">			client.start();</div><div class="line">			cache = <span class="keyword">new</span> PathChildrenCache(client, PATH, <span class="keyword">true</span>);</div><div class="line">			cache.start();</div><div class="line">			addListener(cache);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		create(client, servername, servername);</div><div class="line">		setValue(client, servername, servername);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		remove(client, servername);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(PathChildrenCache cache)</span> </span>&#123;</div><div class="line">		PathChildrenCacheListener listener = (client, event) -&gt; &#123;</div><div class="line">			<span class="keyword">switch</span> (event.getType()) &#123;</div><div class="line">				<span class="keyword">case</span> CHILD_ADDED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"added"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">case</span> CHILD_UPDATED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"changed"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">case</span> CHILD_REMOVED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"removed"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		cache.getListenable().addListener(listener);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printNodeStateChange</span><span class="params">(String type, String path)</span> </span>&#123;</div><div class="line">		System.out.println(servername + <span class="string">" Monitor Node "</span> + type + <span class="string">": "</span> + path + <span class="string">". "</span> + <span class="keyword">new</span> Date().toLocaleString());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(CuratorFramework client, String pathName)</span> </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.delete().forPath(path);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(CuratorFramework client, String pathName, String data)</span>  </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(path, data.getBytes());</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(CuratorFramework client, String pathName, String data)</span> </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.setData().forPath(path, data.getBytes());</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Server1 Monitor Node added: /ServersCache5/Server1. 2016-4-28 19:33:13</div><div class="line">Server1 Monitor Node added: /ServersCache5/Server2. 2016-4-28 19:33:16</div><div class="line">Server2 Monitor Node added: /ServersCache5/Server1. 2016-4-28 19:33:16</div><div class="line">Server1 Monitor Node added: /ServersCache5/Server3. 2016-4-28 19:33:16</div><div class="line">Server2 Monitor Node added: /ServersCache5/Server2. 2016-4-28 19:33:16</div><div class="line">Server2 Monitor Node added: /ServersCache5/Server3. 2016-4-28 19:33:16</div><div class="line">Server3 Monitor Node added: /ServersCache5/Server1. 2016-4-28 19:33:16</div><div class="line">Server3 Monitor Node added: /ServersCache5/Server2. 2016-4-28 19:33:16</div><div class="line">Server3 Monitor Node added: /ServersCache5/Server3. 2016-4-28 19:33:16</div><div class="line">Server2 Monitor Node removed: /ServersCache5/Server1. 2016-4-28 19:33:16</div><div class="line">Server1 Monitor Node removed: /ServersCache5/Server1. 2016-4-28 19:33:16</div><div class="line">Server3 Monitor Node removed: /ServersCache5/Server1. 2016-4-28 19:33:16</div><div class="line">Server1 Monitor Node removed: /ServersCache5/Server2. 2016-4-28 19:33:19</div><div class="line">Server3 Monitor Node removed: /ServersCache5/Server2. 2016-4-28 19:33:19</div><div class="line">Server2 Monitor Node removed: /ServersCache5/Server2. 2016-4-28 19:33:19</div><div class="line">Server3 Monitor Node removed: /ServersCache5/Server3. 2016-4-28 19:33:19</div><div class="line">Server1 Monitor Node removed: /ServersCache5/Server3. 2016-4-28 19:33:19</div><div class="line">Server2 Monitor Node removed: /ServersCache5/Server3. 2016-4-28 19:33:19</div></pre></td></tr></table></figure></p>
<h2 id="客户端网络断开监测"><a href="#客户端网络断开监测" class="headerlink" title="客户端网络断开监测"></a>客户端网络断开监测</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathCacheExample</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line"></div><div class="line">		ZKClient zkClient1 = register(<span class="string">"Server1"</span>);</div><div class="line"></div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		ZKClient zkClient2 = register(<span class="string">"Server2"</span>);</div><div class="line">		ZKClient zkClient3 = register(<span class="string">"Server3"</span>);</div><div class="line"></div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		zkClient1.closeCuratorFramework();</div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">1</span>);</div><div class="line">		zkClient2.closeCuratorFramework();</div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">1</span>);</div><div class="line">		zkClient3.closeCuratorFramework();</div><div class="line"></div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		zkClient1.closePathChildrenCache();</div><div class="line">		zkClient2.closePathChildrenCache();</div><div class="line">		zkClient3.closePathChildrenCache();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZKClient <span class="title">register</span><span class="params">(String serverName)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		ZKClient zkClient = <span class="keyword">new</span> ZKClient(serverName);</div><div class="line">		Thread thread = <span class="keyword">new</span> Thread(zkClient);</div><div class="line">		thread.start();</div><div class="line">		<span class="keyword">return</span> zkClient;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZKClient</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"/ServersCache4"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> CuratorFramework client = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> PathChildrenCache cache = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> String servername = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeAllService</span><span class="params">()</span> </span>&#123;</div><div class="line">		closeCuratorFramework();</div><div class="line">		closePathChildrenCache();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeCuratorFramework</span><span class="params">()</span> </span>&#123;</div><div class="line">		CloseableUtils.closeQuietly(client);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closePathChildrenCache</span><span class="params">()</span> </span>&#123;</div><div class="line">		CloseableUtils.closeQuietly(cache);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ZKClient</span><span class="params">(String serverName)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.servername = serverName;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client = CuratorFrameworkFactory.newClient(<span class="string">"0.0.0.0:2181"</span>, <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</div><div class="line">			client.start();</div><div class="line">			cache = <span class="keyword">new</span> PathChildrenCache(client, PATH, <span class="keyword">true</span>);</div><div class="line">			cache.start();</div><div class="line">			addListener(cache);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		create(client, servername, servername);</div><div class="line"><span class="comment">//		remove(client, servername);</span></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			TimeUnit.SECONDS.sleep(<span class="number">1</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(PathChildrenCache cache)</span> </span>&#123;</div><div class="line">		PathChildrenCacheListener listener = (client, event) -&gt; &#123;</div><div class="line">			<span class="keyword">switch</span> (event.getType()) &#123;</div><div class="line">				<span class="keyword">case</span> CHILD_ADDED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"added"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">case</span> CHILD_UPDATED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"changed"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">case</span> CHILD_REMOVED: &#123;</div><div class="line">					printNodeStateChange(<span class="string">"removed"</span>, event.getData().getPath());</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		cache.getListenable().addListener(listener);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printNodeStateChange</span><span class="params">(String type, String path)</span> </span>&#123;</div><div class="line">		System.out.println(servername + <span class="string">" Monitor Node "</span> + type + <span class="string">": "</span> + path + <span class="string">". "</span> + <span class="keyword">new</span> Date().toLocaleString());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(CuratorFramework client, String pathName)</span> </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.delete().deletingChildrenIfNeeded().forPath(path);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(CuratorFramework client, String pathName, String data)</span>  </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(path, data.getBytes());</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(CuratorFramework client, String pathName, String data)</span> </span>&#123;</div><div class="line">		String path = ZKPaths.makePath(PATH, pathName);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			client.setData().forPath(path, data.getBytes());</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结果输出为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Server1 Monitor Node added: /ServersCache4/Server1. 2016-4-28 19:27:32</div><div class="line">Server1 Monitor Node added: /ServersCache4/Server2. 2016-4-28 19:27:35</div><div class="line">Server3 Monitor Node added: /ServersCache4/Server1. 2016-4-28 19:27:35</div><div class="line">Server1 Monitor Node added: /ServersCache4/Server3. 2016-4-28 19:27:35</div><div class="line">Server3 Monitor Node added: /ServersCache4/Server2. 2016-4-28 19:27:35</div><div class="line">Server3 Monitor Node added: /ServersCache4/Server3. 2016-4-28 19:27:35</div><div class="line">Server2 Monitor Node added: /ServersCache4/Server1. 2016-4-28 19:27:35</div><div class="line">Server2 Monitor Node added: /ServersCache4/Server2. 2016-4-28 19:27:35</div><div class="line">Server2 Monitor Node added: /ServersCache4/Server3. 2016-4-28 19:27:35</div><div class="line">Server2 Monitor Node removed: /ServersCache4/Server1. 2016-4-28 19:27:38</div><div class="line">Server1 Monitor Node removed: /ServersCache4/Server1. 2016-4-28 19:27:38</div><div class="line">Server3 Monitor Node removed: /ServersCache4/Server1. 2016-4-28 19:27:38</div><div class="line">Server2 Monitor Node removed: /ServersCache4/Server2. 2016-4-28 19:27:39</div><div class="line">Server3 Monitor Node removed: /ServersCache4/Server2. 2016-4-28 19:27:39</div><div class="line">Server3 Monitor Node removed: /ServersCache4/Server3. 2016-4-28 19:27:40</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/ZooKeeper/">ZooKeeper</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/26/zookeeper/ZooKeeper Curator 事件监听/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/26/zookeeper/ZooKeeper Curator 事件监听/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/26/spring/Spring 任务调度/" title="Spring 任务调度" itemprop="url">Spring 任务调度</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-04-26T07:00:00.000Z" itemprop="datePublished"> Published 2016-04-26</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="https://spring.io/guides/gs/scheduling-tasks/" target="_blank" rel="external">官方文档</a>学习</p>
<p>测试代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Date;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableScheduling;</div><div class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</div><div class="line"></div><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@EnableScheduling</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestScheduledTasks</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		SpringApplication.run(TestScheduledTasks.class);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScheduledTasks</span> </span>&#123;</div><div class="line">	<span class="comment">// 当任务完成之后, 再延迟fixedDelay毫秒后执行</span></div><div class="line">	<span class="meta">@Scheduled</span>(fixedDelay = <span class="number">3000</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fixedDelay</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		System.out.println(<span class="string">"fixedDelay : "</span> + <span class="keyword">new</span> Date());</div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 每三秒钟执行一次</span></div><div class="line">	<span class="meta">@Scheduled</span>(fixedRate = <span class="number">3000</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fixedRate</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		TimeUnit.SECONDS.sleep(<span class="number">3</span>);</div><div class="line">		System.out.println(<span class="string">"fixedRate : "</span> + <span class="keyword">new</span> Date());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">fixedRate : Tue Apr 26 15:59:15 CST 2016</div><div class="line">fixedDelay : Tue Apr 26 15:59:15 CST 2016</div><div class="line">fixedRate : Tue Apr 26 15:59:21 CST 2016</div><div class="line">fixedRate : Tue Apr 26 15:59:24 CST 2016</div><div class="line">fixedRate : Tue Apr 26 15:59:27 CST 2016</div><div class="line">fixedDelay : Tue Apr 26 15:59:27 CST 2016</div></pre></td></tr></table></figure></p>
<p><code>Scheduled</code>的注解还有</p>
<ul>
<li>cron : 这个可以让我们使用cron表达式</li>
</ul>
<p>最后添加所需要的Maven依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gs-scheduling-tasks<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Spring-Guice/">Spring Guice</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/26/spring/Spring 任务调度/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/26/spring/Spring 任务调度/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/23/nginx/nginx web服务器/" title="nginx web服务器" itemprop="url">nginx web服务器</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-04-23T07:00:00.000Z" itemprop="datePublished"> Published 2016-04-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>官方文档<a href="https://www.nginx.com/resources/admin-guide/nginx-web-server/" target="_blank" rel="external"></a>学习</p>
<p>在Nginx中每个用来处理HTTP请求的virtual server都被称为<code>location</code>. <code>location</code>可以参与请求处理的整个过程. <code>location</code>可以代理一个请求或者直接返回一个文件. 不但如此, 在<code>location</code>中我们还可以修改URI访问路径, 这样我们就可以将该请求指向其他的<code>location</code>或者其他的virtual server. </p>
<h2 id="Setting-Up-Virtual-Servers"><a href="#Setting-Up-Virtual-Servers" class="headerlink" title="Setting Up Virtual Servers"></a>Setting Up Virtual Servers</h2><p>Nginx插件配置必须最少包含一个<code>server</code>指令(用于定义虚拟服务器-virtual server). 当Nginx插件处理一个请求时, 它首先会选择处理该请求的虚拟服务器. 一个虚拟服务器定义在<code>http</code>上下文里, 例如:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    server &#123;</div><div class="line">        # Server configuration</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>http</code>上下文里可以定义多个<code>server</code>指令, 这样一来就可以实现多个虚拟服务器了.</p>
<p>在<code>server</code>指令里通常包含一个<code>listen</code>指令, 通过<code>listen</code>指令来指定监听请求的IP地址和端口号(或者Unix domain socket and path). IPv4 和 IPv6 地址都可进行配置</p>
<p>下面的例子展示了在IP地址<code>127.0.0.1</code>和端口<code>8080</code>上进行网络事件监听<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen 127.0.0.1:8080;</div><div class="line">    # The rest of server configuration</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果端口忽略不写的话, Nginx插件会使用标准端口. 还有如果IP地址忽略不填的话, Nginx插件会在所有的IP地址上进行网络事件监听. 如果没有配置<code>listen</code>指令的话, 在超级用户权限下, 标准端口是<code>80/tcp</code>, 默认端口<code>8000/tcp</code>.</p>
<p>如果有多个<code>server</code>指令里配置的IP地址和端口匹配到请求, 那么Nginx插件会根据请求的<code>Host header</code>字段与<code>server_name</code>指令进行匹配. 我们可以将<code>server_name</code>指令配置成一个全名称的地址, 或者使用通配符, 正则表达式. 如果想要使用通配符的话, 可以在地址的开头或者结尾使用<code>*</code>.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen      80;</div><div class="line">    server_name example.org www.example.org;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果有多个<code>server_name</code>指令匹配到<code>Host header</code>, Nginx插件会根据如下顺序进行匹配查找, 直到找到第一个.</p>
<ol>
<li>名字完全符合</li>
<li>以<code>*</code>开始的, 最符合的名字, 例如<code>*.example.org</code></li>
<li>以<code>*</code>结束的, 最符合的名字, 例如<code>mail.*</code></li>
<li>第一个匹配正则表达式的</li>
</ol>
<p>如果请求中的<code>Host header</code>没有匹配到一个合适的server name, Nginx插件会将该消息路由到默认服上面去. 默认服是在<code>nginx.conf</code>文件里进行配置的. 我们也可以使用<code>default_server</code>参数在<code>listen</code>指令中进行显示设定.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen      80 default_server;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Configuring-Locations"><a href="#Configuring-Locations" class="headerlink" title="Configuring Locations"></a>Configuring Locations</h2><p>Nginx插件可以根据请求的URI将请求派发到不同的代理上, 或者处理不同的文件. 这种功能是通过<code>server</code>指令里的<code>location</code>指令完成的.</p>
<p>例如你可以定义三个<code>location</code>指令, 一个用来将请求派发到一个代理服务器, 一个用来将其他的请求派发到另外的一个代理服务器,最后的一个用来提供本地文件系统服务.</p>
<p>NGINX Plus tests request URIs against the parameters of all location directives and applies the directives defined in the matching location. Inside each location block, it is usually possible (with a few exceptions) to place even more location directives to further refine the processing for specific groups of requests.</p>
<blockquote>
<p>注意, 在这篇教程中, location这个字指的是一个单独的<code>location</code>上下文.</p>
</blockquote>
<p>有俩种<code>location</code>指令参数</p>
<ul>
<li>prefix strings : 请求的URI是以固定的字符串开头, 例如prefix strings是<code>/some/path/</code>, 那么<code>/some/path/document.html</code>就是这种类型的, 但是<code>/my-site/some/path</code>就不是.</li>
<li>regular expressions :</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location /some/path/ &#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当使用表达式的时候, 如果使用<code>~</code>开头则表示要区分大小写. 如果以<code>~*</code>开头,则表示忽略大小写. 下面的例子是只要请求包含<code>.html</code>或者<code>.htm</code>这些字符串就都匹配<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location ~ \.html? &#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Nginx插件进行location匹配时, 优先进行<code>prefix string</code>匹配, 如果<code>prefix string</code>匹配不到再进行正则匹配.</p>
<p>Higher priority is given to regular expressions, unless the ^~ modifier is used. Among the prefix strings NGINX Plus selects the most specific one (that is, the longest and most complete string). The exact logic for selecting a location to process a request is given below:</p>
<ol>
<li>Test the URI against all prefix strings.</li>
<li>The = (equals sign) modifier defines an exact match of the URI and a prefix string. If the exact match is found, the search stops.</li>
<li>If the ^~ (caret-tilde) modifier prepends the longest matching prefix string, the regular expressions are not checked.</li>
<li>Store the longest matching prefix string.</li>
<li>Test the URI against regular expressions.</li>
<li>Break on the first matching regular expression and use the corresponding location.</li>
<li>If no regular expression matches, use the location corresponding to the stored prefix string.</li>
</ol>
<p><code>=</code>的典型用例是请求<code>/</code>, 如果请求<code>/</code>是非常频繁的, 在<code>location</code>指令上设置<code>= /</code>可以大幅提升访问速度, 这是因为在路径搜索匹配时, 一旦匹配到就不再继续搜素匹配了, 节约了时间.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location = / &#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>location</code>上下文中可以包含多个指令, 用于说明如何处理一个请求, 例如是想提供静态文件服务还是想向一个代理服务器派发请求. 例如, 在下面的例子中, 第一个请求就是提供<code>/data</code>目录下的静态文件服务, 第二个请求就是向一个代理服务器<code>www.example.com</code>派发请求.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    location /images/ &#123;</div><div class="line">        root /data;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">        proxy_pass http://www.example.com;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>root</code>指令用于指定提供静态文件服务的文件系统路径. 如果有一个请求<code>/images/example.png</code>, 那么nginx插件会在文件系统中进行如下搜索<code>/data/images/example.png</code>.</li>
<li><code>proxy_pass</code>指令会将请求派发到代理服务器上. 在上面的例子中, 只要是请求不是以<code>/images/</code>开头的, 那么请求都会派发到那个代理服务器上.</li>
</ul>
<h2 id="Using-Variables"><a href="#Using-Variables" class="headerlink" title="Using Variables"></a>Using Variables</h2><p>你可以在配置文件里使用变量, 以便Nginx插件可以根据不同的情况进行不同的处理. 变量在运行时进行计算, 然后将值传递给指令使用. 我们可以通过<code>$</code>来引用一个变量(例如<code>$time</code>).</p>
<p>在Nginx里已经为我们提前定义好了一些变量, 例如<a href="http://nginx.org/en/docs/http/ngx_http_core_module.html?&amp;_ga=1.54594219.1025068217.1457188479#variables" target="_blank" rel="external">core HTTP</a>. 而且你也可以使用<code>set</code>, <code>map</code>, <code>geo</code>等指令自定义一些变量.</p>
<h2 id="Returning-Specific-Status-Codes"><a href="#Returning-Specific-Status-Codes" class="headerlink" title="Returning Specific Status Codes"></a>Returning Specific Status Codes</h2><p>在一些web站点中, 由于资源移除或者其他原因, 我们需要直接给前端返回一个错误码, 那么我们可以使用<code>return</code>指令来完成.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location /wrong/url &#123;</div><div class="line">    return 404;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下面的例子中, 第一个参数是一个错误码. 第二个参数是一个可选参数(代表一个重连接的URL)<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location /permanently/moved/url &#123;</div><div class="line">    return 301 http://www.example.com/moved/here;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>return</code>指令既可以放在<code>location</code>指令里, 也可以放在<code>server</code>指令里</p>
<h2 id="Rewriting-URIs-in-Requests"><a href="#Rewriting-URIs-in-Requests" class="headerlink" title="Rewriting URIs in Requests"></a>Rewriting URIs in Requests</h2><p>请求URI可以在被处理时通过<code>rewrite</code>指令被多次修改, <code>rewrite</code>指令包含一个可选参数和俩个必选参数.</p>
<ul>
<li>第一个参数(必填)是用来匹配请求的正则表达式.</li>
<li>第二个参数(必填)是用来指向重连接所需要匹配的URI.(下面的例子中我们采用的是正则表达式进行匹配)</li>
<li>第三个参数(选填)是用来标记是继续执行下一个重连接还是执行其他操作(例如返回一个错误码)<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location /users/ &#123;</div><div class="line">    rewrite ^/users/(.*)$ /show?user=$1 break;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>在<code>server</code>或者<code>location</code>指令中可以包含多个<code>rewrite</code>指令. Nginx插件会根据<code>rewrite</code>指令出现的顺序依次执行.</p>
<p>After NGINX processes a set of rewriting instructions, it selects a location context according to the new URI. If the selected location contains rewrite directives, they are executed in turn. If the URI matches any of those, a search for the new location starts after all defined rewrite directives are processed.</p>
<p>下面的例子展示里<code>rewrite</code>和<code>return</code>指令混合使用的方式<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    ...</div><div class="line">    rewrite ^(/download/.*)/media/(.*)\..*$ $1/mp3/$2.mp3 last;</div><div class="line">    rewrite ^(/download/.*)/audio/(.*)\..*$ $1/mp3/$2.ra  last;</div><div class="line">    return  403;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的例子区分了俩组URI. <code>/download/some/media/file</code>的URI会被替换成<code>/download/some/mp3/file.mp3</code>. 由于这个<code>rewrite</code>指令后面跟里一个<code>last</code>标记, 因此下面的<code>rewrite</code>和<code>return</code>指令就不会再执行到了. 但是如果URI例如<code>/download/some/audio/file</code>并不符合第一个,那么Nginx插件会继续匹配到第二个, 当然第二个符合, 于是URI被替换成<code>/download/some/mp3/file.ra</code>. 如果前俩个都不符合的话, 那么就会返回<code>403</code>错误码.</p>
<p>下面, 我们会介绍俩种终止URI<code>rewrite</code>执行的方式:</p>
<ul>
<li><code>last</code> – 这种方式只是会在当前的<code>server</code>或者<code>location</code>上下文中停止, 但是Nginx插件会对重写的URI继续在<code>location</code>里进行查找.</li>
<li><code>break</code> – 它不会对新的URI在当前上下文中进行查找, 而是简单的终止掉整个过程.</li>
</ul>
<h2 id="Rewriting-HTTP-Responses"><a href="#Rewriting-HTTP-Responses" class="headerlink" title="Rewriting HTTP Responses"></a>Rewriting HTTP Responses</h2><p>有时候你可能需要重写或者替换HTTP响应中的内容, 或者将一个字符串替换为另一个. <code>sub_filter</code>指令可以实现类似于这种的需求. <code>sub_filter</code>支持变量以及链式替换, 以便实现更加复杂的重写功能.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">    sub_filter      /blog/ /blog-staging/;</div><div class="line">    sub_filter_once off;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另一个例子是将<code>http://</code>改变为<code>https://</code>, 而且将localhost地址改变为请求头中的主机名. <code>sub_filter_once</code>指令是告诉NGINX在<code>location</code>指令里可以开启多个<code>sub_filter</code>.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">    sub_filter     'href="http://127.0.0.1:8080/'    'href="http://$host/';</div><div class="line">    sub_filter     'img src="http://127.0.0.1:8080/' 'img src="http://$host/';</div><div class="line">    sub_filter_once on;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意, 如果响应已经在一个<code>sub_filter</code>修改过里, 那么即使另一个<code>sub_filter</code>也匹配到了,但是不会再次修改.</p>
</blockquote>
<h2 id="Handling-Errors"><a href="#Handling-Errors" class="headerlink" title="Handling Errors"></a>Handling Errors</h2><p>使用<code>error_page</code>指令, 我们可以配置Nginx插件返回一个自定义的界面或者响应一个不同的错误码,甚至可以重定向到一个新的地址上面去. 在下面的例子中, <code>error_page</code>指令会在发生错误时返回一个指定的界面<code>/404.html</code>, 而不是像默认的返回一个404错误码.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">error_page 404 /404.html;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意, 这个指令并不是直接就返回了(<code>return</code>指令直接返回), 而是指定一种当错误发生时的一种处理方式.</p>
</blockquote>
<p>在下面的例子中, 当Nginx找不到文件时, 它会返回<code>301</code>错误码, 同时告诉客户端重定向到<code>http:/example.com/new/path.html</code>这个界面上.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location /old/path.html &#123;</div><div class="line">    error_page 404 =301 http:/example.com/new/path.html;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>The following configuration is an example of passing a request to the back end when a file is not found. Because there is no status code specified after the equals sign in the error_page directive, the response to the client has the status code returned by the proxied server (not necessarily 404).</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    ...</div><div class="line">    location /images/ &#123;</div><div class="line">        # Set the root directory to search for the file</div><div class="line">        root /data/www;</div><div class="line"></div><div class="line">        # Disable logging of errors related to file existence</div><div class="line">        open_file_cache_errors off;</div><div class="line"></div><div class="line">        # Make an internal redirect if the file is not found</div><div class="line">        error_page 404 = /fetch$uri;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location /fetch/ &#123;</div><div class="line">        proxy_pass http://backend/;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The error_page directive instructs NGINX Plus to make an internal redirect when a file is not found. The $uri variable in the final parameter to the error_page directive holds the URI of the current request, which gets passed in the redirect.</p>
<p>For example, if /images/some/file is not found, it is replaced with /fetch/images/some/file and a new search for a location starts. As a result, the request ends up in the second location context and is proxied to <a href="http://backend/" target="_blank" rel="external">http://backend/</a>.</p>
<p>The open_file_cache_errors directive prevents writing an error message if a file is not found. This is not necessary here since missing files are correctly handled.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/23/nginx/nginx web服务器/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/23/nginx/nginx web服务器/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/22/spring/Spring 异步方法访问/" title="Spring 异步方法访问" itemprop="url">Spring 异步方法访问</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-04-22T07:00:00.000Z" itemprop="datePublished"> Published 2016-04-22</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="https://spring.io/guides/gs/async-method/" target="_blank" rel="external">官方文档</a>学习</p>
<p>官网的教程就是访问GitHub 的一个用户数据. 首先我们创建一个Model类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonIgnoreProperties;</div><div class="line"></div><div class="line"><span class="meta">@JsonIgnoreProperties</span>(ignoreUnknown=<span class="keyword">true</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> String blog;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBlog</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> blog;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBlog</span><span class="params">(String blog)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.blog = blog;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"User [name="</span> + name + <span class="string">", blog="</span> + blog + <span class="string">"]"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>Spring默认使用的是 Jackson JSON类库。 在这个例子中@JsonIgnoreProperties, 会忽略Github返回的不在User中的参数</p>
</blockquote>
<p>然后我们创建一个异步的服务<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent.Future;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Async;</div><div class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.AsyncResult;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</div><div class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</div><div class="line"></div><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GitHubLookupService</span> </span>&#123;</div><div class="line"></div><div class="line">    RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</div><div class="line"></div><div class="line">    <span class="meta">@Async</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Future&lt;User&gt; <span class="title">findUser</span><span class="params">(String user)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Looking up "</span> + user);</div><div class="line">        User results = restTemplate.getForObject(<span class="string">"https://api.github.com/users/"</span> + user, User.class);</div><div class="line">        <span class="comment">// Artificial delay of 1s for demonstration purposes</span></div><div class="line">        Thread.sleep(<span class="number">1000L</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;User&gt;(results);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们创建的服务, 使用的是RestTemplate来创建一个Rest远程调用, 然后将结果转换为一个User实例.</p>
<p><code>@Async</code>注解会让Spring在一个单独的线程中执行该方法, 最后我们使用<code>AsyncResult</code>对调用的结果进行了一个异步的封装.</p>
<blockquote>
<p>需要注意的是, 如果创建一个本地实例并不会异步调用<code>findUser()</code>方法, 我们必须在<code>@Configuration</code>或者<code>@ComponentScan</code>注解中才行.</p>
</blockquote>
<p>下面我们创建Demo运行一下程序<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent.Future;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.CommandLineRunner;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;</div><div class="line"></div><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@EnableAsync</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    GitHubLookupService gitHubLookupService;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// Start the clock</span></div><div class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</div><div class="line"></div><div class="line">        <span class="comment">// Kick of multiple, asynchronous lookups</span></div><div class="line">        Future&lt;User&gt; page1 = gitHubLookupService.findUser(<span class="string">"PivotalSoftware"</span>);</div><div class="line">        Future&lt;User&gt; page2 = gitHubLookupService.findUser(<span class="string">"CloudFoundry"</span>);</div><div class="line">        Future&lt;User&gt; page3 = gitHubLookupService.findUser(<span class="string">"Spring-Projects"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Wait until they are all done</span></div><div class="line">        <span class="keyword">while</span> (!(page1.isDone() &amp;&amp; page2.isDone() &amp;&amp; page3.isDone())) &#123;</div><div class="line">            Thread.sleep(<span class="number">10</span>); <span class="comment">//10-millisecond pause between each check</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Print results, including elapsed time</span></div><div class="line">        System.out.println(<span class="string">"Elapsed time: "</span> + (System.currentTimeMillis() - start));</div><div class="line">        System.out.println(page1.get());</div><div class="line">        System.out.println(page2.get());</div><div class="line">        System.out.println(page3.get());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(Application.class, args);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>@EnableAsync</code>注解, 会让<code>@Async</code>方法在一个线程池中执行</p>
<blockquote>
<p>@SpringBootApplication会为我们做如下工作</p>
<ul>
<li>@Configuration</li>
<li>@EnableAutoConfiguration</li>
<li>@ComponentScan</li>
</ul>
</blockquote>
<p>最后添加所需要的Maven依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gs-async-method<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Spring-Guice/">Spring Guice</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/22/spring/Spring 异步方法访问/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/22/spring/Spring 异步方法访问/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/20/Java/JProfiler nowait连接/" title="JProfiler nowait连接" itemprop="url">JProfiler nowait连接</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-04-20T07:00:00.000Z" itemprop="datePublished"> Published 2016-04-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <blockquote>
<p>下载安装Linux版本(我选择的是LINUX Setup Executable (43 MB) 版本). 下载完成之后, 直接执行下载文件jprofiler_linux_9_1_1.sh就可以了, 然后按照提示一步一步安装.</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/ming15/blog-website/images/jprofiler/nowait/jprofiler1.png" alt=""><br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/jprofiler/nowait/jprofiler2.png" alt=""><br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/jprofiler/nowait/jprofiler3.png" alt=""><br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/jprofiler/nowait/jprofiler4.png" alt=""><br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/jprofiler/nowait/jprofiler5.png" alt=""><br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/jprofiler/nowait/jprofiler6.png" alt=""><br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/jprofiler/nowait/jprofiler7.png" alt=""><br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/jprofiler/nowait/jprofiler8.png" alt=""><br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/jprofiler/nowait/jprofiler9.png" alt=""><br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/jprofiler/nowait/jprofiler10.png" alt=""></p>
<blockquote>
<p>但是需要注意的是, 这种连接方式十分消耗服务器性能, 当我开启了方法消耗统计了之后, 跑了500个机器人之后, 就已经卡的不得了了.</p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/20/Java/JProfiler nowait连接/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/20/Java/JProfiler nowait连接/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/12/Java/Mybatis SqlSession/" title="Mybatis SqlSession" itemprop="url">Mybatis SqlSession</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-04-12T07:00:00.000Z" itemprop="datePublished"> Published 2016-04-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>一直在使用Mybatis, 但是一直对Mybatis中的SqlSession的实际操作过程没有深入了解过, 今天在项目中引用了Mybatis-Guice模块, 很好奇Mybatis-Guice是如何做的SqlSeesion自动资源释放,因此今天就找时间好好研究一下<code>SqlSession</code>.</p>
<p>首先看一下<a href="http://www.mybatis.org/mybatis-3/zh/getting-started.html" target="_blank" rel="external">Mybatis3官方文档</a>中对<code>SqlSessionFactoryBuilder</code>, <code>SqlSessionFactory</code>和<code>SqlSession</code>的描述：</p>
<ul>
<li><code>SqlSessionFactoryBuilder</code> : 用于构建<code>SqlSessionFactory</code>. 我们可以使用它来构建一个单数据源或者多数据源的应用程序.</li>
<li><code>SqlSessionFactory</code> : 创建<code>SqlSession</code>, 该实例的生命周期应该是整个应用程序.</li>
<li><code>SqlSession</code> : 包含了面向数据库执行 SQL 命令所需的所有方法, 但它不是线程安全的. 每当向数据库发起一个请求时都应该打开一个<code>SqlSession</code>,然后操作完之后再<code>finally</code>中关闭它.</li>
</ul>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><p><code>SqlSessionFactoryBuilder</code>是通过xml配置文件或者<code>Configuration</code>建构出<code>SqlSessionFactory</code>, 然后<code>SqlSessionFactory</code>通过<code>openSession()</code>来获得一个<code>SqlSession</code>. <code>SqlSession</code>接口实现自<code>Closeable</code>接口. 按照官网所说, 我们应该这样使用<code>SqlSession</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">SqlSession session = sqlSessionFactory.openSession();</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  <span class="comment">// do work</span></div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">  session.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但其实我们可以使用Java7提供的AutoClose语法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> (SqlSession sqlSession = sqlSessionFactory.openSession()) &#123;</div><div class="line">	<span class="comment">// do work</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样代码就精简了很多.</p>
<h2 id="SqlSession-源码"><a href="#SqlSession-源码" class="headerlink" title="SqlSession 源码"></a>SqlSession 源码</h2><p><code>SqlSession</code>接口中定义了大量的我们操作SQL提供的接口</p>
<ul>
<li><t> T selectOne(String statement);</t></li>
<li><e> List<e> selectList(String statement);</e></e></li>
<li><p>void select(String statement, ResultHandler handler);<br>等等. 我们看一下它的实现类<code>DefaultSqlSession</code>的实现:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Configuration configuration;</div><div class="line"><span class="keyword">private</span> Executor executor;</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> dirty;</div></pre></td></tr></table></figure>
</li>
<li><p><code>Configuration</code> 是我们通过<code>SqlSessionFactoryBuilder</code>构建出<code>SqlSessionFactory</code>时使用的配置</p>
</li>
<li><code>Executor</code> 是真正的sql执行的部分</li>
</ul>
<p>我们在<code>DefaultSqlSessionFactory</code>看一下<code>SqlSession</code>的真实创建过程<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> SqlSession <span class="title">openSessionFromDataSource</span><span class="params">(ExecutorType execType, TransactionIsolationLevel level, <span class="keyword">boolean</span> autoCommit)</span> </span>&#123;</div><div class="line">  Transaction tx = <span class="keyword">null</span>;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">final</span> Environment environment = configuration.getEnvironment();</div><div class="line">    <span class="keyword">final</span> TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);</div><div class="line">    tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</div><div class="line">    <span class="keyword">final</span> Executor executor = configuration.newExecutor(tx, execType, autoCommit);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DefaultSqlSession(configuration, executor);</div><div class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">    closeTransaction(tx); <span class="comment">// may have fetched a connection so lets call close()</span></div><div class="line">    <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">"Error opening session.  Cause: "</span> + e, e);</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">    ErrorContext.instance().reset();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>final Executor executor = configuration.newExecutor(tx, execType, autoCommit);</code>会根据execType创建出不同类型的<code>Executor</code></p>
<ul>
<li>BatchExecutor</li>
<li>ReuseExecutor</li>
<li>SimpleExecutor</li>
<li>CachingExecutor</li>
</ul>
<p>下来我们看一下<code>selectList()</code>实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">selectList</span><span class="params">(String statement, Object parameter, RowBounds rowBounds)</span> </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    MappedStatement ms = configuration.getMappedStatement(statement);</div><div class="line">    List&lt;E&gt; result = executor.&lt;E&gt;query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">    <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">"Error querying database.  Cause: "</span> + e, e);</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">    ErrorContext.instance().reset();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>MappedStatement类在Mybatis框架中用于表示XML文件中一个sql语句节点,即一个<code>&lt;select /&gt;、&lt;update /&gt;</code>或者<code>&lt;insert /&gt;</code>标签.Mybatis框架在初始化阶段会对XML配置文件进行读取,将其中的sql语句节点对象化为一个个<code>MappedStatement</code>对象.<br>从配置中拿到一个<code>MappedStatement</code>然后交给executor去真正的执行, 真正的有query逻辑的只有<code>BaseExecutor</code>和<code>CachingExecutor</code>, 为了简单起见,我们看一下<code>BaseExecutor</code>. 由于中间的过程还涉及到了Mybatis的本地存储, 我们也跳过这部分.<br><code>BaseExecutor#query()</code> -&gt; <code>BaseExecutor#queryFromDatabase()</code>-&gt; <code>SimpleExecutor#doQuery()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">doQuery</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    Statement stmt = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      Configuration configuration = ms.getConfiguration();</div><div class="line">	  <span class="comment">// StatementHandler用于管理java.sql.Statement, 执行真正的与数据库操作</span></div><div class="line">      StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);</div><div class="line">	  <span class="comment">// 通过StatementHandler实例化出一个Statement</span></div><div class="line">      stmt = prepareStatement(handler, ms.getStatementLog());</div><div class="line">	  <span class="comment">// Statement开始执行查询逻辑</span></div><div class="line">      <span class="keyword">return</span> handler.&lt;E&gt;query(stmt, resultHandler);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      closeStatement(stmt);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>我们看一下<code>SimpleStatementHandler</code>里的查询逻辑<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(Statement statement, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   String sql = boundSql.getSql();</div><div class="line">   statement.execute(sql);</div><div class="line">   <span class="keyword">return</span> resultSetHandler.&lt;E&gt;handleResultSets(statement);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p><code>SqlSource</code>接口只有一个<code>getBoundSql(Object parameterObject)</code>方法,返回一个<code>BoundSql</code>对象.一个<code>BoundSql</code>对象,代表了一次sql语句的实际执行,而<code>SqlSource</code>对象的责任,就是根据传入的参数对象,动态计算出这个<code>BoundSql</code>,也就是说Mapper文件中的<if>节点的计算,是由SqlSource对象完成的.<code>SqlSource</code>最常用的实现类是<code>DynamicSqlSource</code></if></p>
</blockquote>
<p>那么<code>close()</code>执行的是什么操作呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    executor.close(isCommitOrRollbackRequired(<span class="keyword">false</span>));</div><div class="line">    dirty = <span class="keyword">false</span>;</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">    ErrorContext.instance().reset();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们还是看<code>BaseExecutor</code>的<code>close()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">boolean</span> forceRollback)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        rollback(forceRollback);</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">		<span class="comment">// 真正关闭资源</span></div><div class="line">        <span class="keyword">if</span> (transaction != <span class="keyword">null</span>) transaction.close();</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</div><div class="line">      log.debug(<span class="string">"Unexpected exception on closing transaction.  Cause: "</span> + e);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      transaction = <span class="keyword">null</span>;</div><div class="line">      deferredLoads = <span class="keyword">null</span>;</div><div class="line">      localCache = <span class="keyword">null</span>;</div><div class="line">      localOutputParameterCache = <span class="keyword">null</span>;</div><div class="line">      closed = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>我们看一下<code>JdbcTransaction</code>的<code>close()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">  <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</div><div class="line">    resetAutoCommit();</div><div class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">      log.debug(<span class="string">"Closing JDBC Connection ["</span> + connection + <span class="string">"]"</span>);</div><div class="line">    &#125;</div><div class="line">    connection.close();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>Transaction</code> : 包装了一个数据库连接. 处理整个网络连接过程中的所有操作, 例如creation, preparation, commit/rollback and close. </li>
</ul>
<h2 id="异常测试"><a href="#异常测试" class="headerlink" title="异常测试"></a>异常测试</h2><p>如果我们不关闭SqlSession会有什么情况发生呢?<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"><span class="keyword">import</span> java.sql.SQLException;</div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.Date;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</div><div class="line"><span class="keyword">import</span> org.apache.ibatis.io.Resources;</div><div class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</div><div class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</div><div class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMybatis</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        String resource = <span class="string">"mybatis-config.xml"</span>;</div><div class="line">        InputStream inputStream = Resources.getResourceAsStream(resource);</div><div class="line">        SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</div><div class="line">        List&lt;SqlSession&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">            SqlSession session = sqlSessionFactory.openSession();</div><div class="line">            QueryMapper mapper = session.getMapper(QueryMapper.class);</div><div class="line">            list.add(session);</div><div class="line">            System.out.println(i + <span class="string">"  :  "</span> + mapper.select() + <span class="string">" - "</span> + <span class="keyword">new</span> Date().toLocaleString());</div><div class="line">        &#125;</div><div class="line">        list.forEach(session -&gt; &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                System.out.println(session.getConnection().isClosed());</div><div class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">QueryMapper</span> </span>&#123;</div><div class="line">    <span class="meta">@Select</span>(<span class="string">"select name from user"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">select</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下面是我们的配置文件<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> <span class="meta">?&gt;</span></span></div><div class="line"><span class="meta">&lt;!DOCTYPE configuration</span></div><div class="line">        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"</div><div class="line">        "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/test?autoReconnect=true"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"poolMaximumActiveConnections"</span> <span class="attr">value</span>=<span class="string">"3"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"poolMaximumIdleConnections"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"poolTimeToWait"</span> <span class="attr">value</span>=<span class="string">"5"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">class</span>=<span class="string">"QueryMapper"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>我们配置了最大可用连接数为3, 最大的闲置连接为1. 结果为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>  :  [<span class="number">123</span>] - <span class="number">2016</span>-<span class="number">4</span>-<span class="number">12</span> <span class="number">18</span>:<span class="number">37</span>:<span class="number">28</span></div><div class="line"><span class="number">2</span>  :  [<span class="number">123</span>] - <span class="number">2016</span>-<span class="number">4</span>-<span class="number">12</span> <span class="number">18</span>:<span class="number">37</span>:<span class="number">28</span></div><div class="line"><span class="number">3</span>  :  [<span class="number">123</span>] - <span class="number">2016</span>-<span class="number">4</span>-<span class="number">12</span> <span class="number">18</span>:<span class="number">37</span>:<span class="number">28</span></div><div class="line"><span class="number">4</span>  :  [<span class="number">123</span>] - <span class="number">2016</span>-<span class="number">4</span>-<span class="number">12</span> <span class="number">18</span>:<span class="number">37</span>:<span class="number">48</span></div><div class="line"><span class="number">5</span>  :  [<span class="number">123</span>] - <span class="number">2016</span>-<span class="number">4</span>-<span class="number">12</span> <span class="number">18</span>:<span class="number">37</span>:<span class="number">48</span></div><div class="line"><span class="number">6</span>  :  [<span class="number">123</span>] - <span class="number">2016</span>-<span class="number">4</span>-<span class="number">12</span> <span class="number">18</span>:<span class="number">37</span>:<span class="number">48</span></div><div class="line"><span class="number">7</span>  :  [<span class="number">123</span>] - <span class="number">2016</span>-<span class="number">4</span>-<span class="number">12</span> <span class="number">18</span>:<span class="number">38</span>:<span class="number">08</span></div><div class="line"><span class="number">8</span>  :  [<span class="number">123</span>] - <span class="number">2016</span>-<span class="number">4</span>-<span class="number">12</span> <span class="number">18</span>:<span class="number">38</span>:<span class="number">08</span></div><div class="line"><span class="number">9</span>  :  [<span class="number">123</span>] - <span class="number">2016</span>-<span class="number">4</span>-<span class="number">12</span> <span class="number">18</span>:<span class="number">38</span>:<span class="number">08</span></div><div class="line">java.sql.SQLException: Error accessing PooledConnection. Connection is invalid.</div><div class="line">	at org.apache.ibatis.datasource.pooled.PooledConnection.checkConnection(PooledConnection.java:<span class="number">254</span>)</div><div class="line">	at org.apache.ibatis.datasource.pooled.PooledConnection.invoke(PooledConnection.java:<span class="number">243</span>)</div><div class="line">	at com.sun.proxy.$Proxy3.isClosed(Unknown Source)</div><div class="line">	at TestMybatis.lambda$main$<span class="number">0</span>(TestMybatis.java:<span class="number">29</span>)</div><div class="line">	at java.util.ArrayList.forEach(ArrayList.java:<span class="number">1249</span>)</div><div class="line">	at TestMybatis.main(TestMybatis.java:<span class="number">27</span>)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</div><div class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</div><div class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</div><div class="line">	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:<span class="number">144</span>)</div><div class="line">java.sql.SQLException: Error accessing PooledConnection. Connection is invalid.</div><div class="line">	at org.apache.ibatis.datasource.pooled.PooledConnection.checkConnection(PooledConnection.java:<span class="number">254</span>)</div><div class="line">	at org.apache.ibatis.datasource.pooled.PooledConnection.invoke(PooledConnection.java:<span class="number">243</span>)</div><div class="line">	at com.sun.proxy.$Proxy3.isClosed(Unknown Source)</div><div class="line">	at TestMybatis.lambda$main$<span class="number">0</span>(TestMybatis.java:<span class="number">29</span>)</div><div class="line">	at java.util.ArrayList.forEach(ArrayList.java:<span class="number">1249</span>)</div><div class="line">	at TestMybatis.main(TestMybatis.java:<span class="number">27</span>)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</div><div class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</div><div class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</div><div class="line">	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:<span class="number">144</span>)</div><div class="line">java.sql.SQLException: Error accessing PooledConnection. Connection is invalid.</div><div class="line">	at org.apache.ibatis.datasource.pooled.PooledConnection.checkConnection(PooledConnection.java:<span class="number">254</span>)</div><div class="line">	at org.apache.ibatis.datasource.pooled.PooledConnection.invoke(PooledConnection.java:<span class="number">243</span>)</div><div class="line">	at com.sun.proxy.$Proxy3.isClosed(Unknown Source)</div><div class="line">	at TestMybatis.lambda$main$<span class="number">0</span>(TestMybatis.java:<span class="number">29</span>)</div><div class="line">	at java.util.ArrayList.forEach(ArrayList.java:<span class="number">1249</span>)</div><div class="line">	at TestMybatis.main(TestMybatis.java:<span class="number">27</span>)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</div><div class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</div><div class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</div><div class="line">	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:<span class="number">144</span>)</div><div class="line">java.sql.SQLException: Error accessing PooledConnection. Connection is invalid.</div><div class="line">	at org.apache.ibatis.datasource.pooled.PooledConnection.checkConnection(PooledConnection.java:<span class="number">254</span>)</div><div class="line">	at org.apache.ibatis.datasource.pooled.PooledConnection.invoke(PooledConnection.java:<span class="number">243</span>)</div><div class="line">	at com.sun.proxy.$Proxy3.isClosed(Unknown Source)</div><div class="line">	at TestMybatis.lambda$main$<span class="number">0</span>(TestMybatis.java:<span class="number">29</span>)</div><div class="line">	at java.util.ArrayList.forEach(ArrayList.java:<span class="number">1249</span>)</div><div class="line">	at TestMybatis.main(TestMybatis.java:<span class="number">27</span>)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</div><div class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</div><div class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</div><div class="line">	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:<span class="number">144</span>)</div><div class="line">java.sql.SQLException: Error accessing PooledConnection. Connection is invalid.</div><div class="line">	at org.apache.ibatis.datasource.pooled.PooledConnection.checkConnection(PooledConnection.java:<span class="number">254</span>)</div><div class="line">	at org.apache.ibatis.datasource.pooled.PooledConnection.invoke(PooledConnection.java:<span class="number">243</span>)</div><div class="line">	at com.sun.proxy.$Proxy3.isClosed(Unknown Source)</div><div class="line">	at TestMybatis.lambda$main$<span class="number">0</span>(TestMybatis.java:<span class="number">29</span>)</div><div class="line">	at java.util.ArrayList.forEach(ArrayList.java:<span class="number">1249</span>)</div><div class="line">	at TestMybatis.main(TestMybatis.java:<span class="number">27</span>)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</div><div class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</div><div class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</div><div class="line">	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:<span class="number">144</span>)</div><div class="line">java.sql.SQLException: Error accessing PooledConnection. Connection is invalid.</div><div class="line">	at org.apache.ibatis.datasource.pooled.PooledConnection.checkConnection(PooledConnection.java:<span class="number">254</span>)</div><div class="line">	at org.apache.ibatis.datasource.pooled.PooledConnection.invoke(PooledConnection.java:<span class="number">243</span>)</div><div class="line">	at com.sun.proxy.$Proxy3.isClosed(Unknown Source)</div><div class="line">	at TestMybatis.lambda$main$<span class="number">0</span>(TestMybatis.java:<span class="number">29</span>)</div><div class="line">	at java.util.ArrayList.forEach(ArrayList.java:<span class="number">1249</span>)</div><div class="line">	at TestMybatis.main(TestMybatis.java:<span class="number">27</span>)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</div><div class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</div><div class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</div><div class="line">	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:<span class="number">144</span>)</div><div class="line"><span class="keyword">false</span></div><div class="line"><span class="keyword">false</span></div><div class="line"><span class="keyword">false</span></div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/12/Java/Mybatis SqlSession/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/12/Java/Mybatis SqlSession/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/06/Java/IP地址在网卡上的表现/" title="IP地址在网卡上的表现" itemprop="url">IP地址在网卡上的表现</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-04-06T07:00:00.000Z" itemprop="datePublished"> Published 2016-04-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>今天遇到一个比较奇葩的问题, 在一个JDBC程序连接数据库的时候, 使用IPV4地址就无法访问, 使用localhost就成功, 现在就对这个问题一探究竟<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jdbc:mysql:<span class="comment">//localhost:3306/c2x?autoReconnect=true</span></div></pre></td></tr></table></figure></p>
<p>首先要说明一下localhost, 127.0.0.1和ipv4之间的关系</p>
<ul>
<li>localhost : 首先这不是一个地址, 而是一个域名, 类似于www.baidu.com这种东西</li>
<li>127.0.0.1 : 127开头的网段默认都是属于loopback接口, 用于测试本机TCP/IP协议栈. 它被分配在了一个虚拟网卡上</li>
<li>ipv4 : 是一个真实网卡上的ip地址.</li>
</ul>
<p>首先我们看一下win7系统上的C:\Windows\System32\drivers\etc的host配置文件<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># localhost name resolution is handled within DNS itself.</div><div class="line">#	127.0.0.1       localhost</div><div class="line">#	::1             localhost</div></pre></td></tr></table></figure></p>
<p>我们看到127.0.0.1就映射到了localhost, ::1是在ipv6的前提下分配到的localhost. 通过这个配置文件我们就看到了localhost和 127.0.0.1这二者之间的关系.</p>
<p>下面我们再使用<code>ipconfig/all</code>这个命令看一下Windows的网卡配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">Windows IP 配置</div><div class="line"></div><div class="line">   主机名  . . . . . . . . . . . . . : OA1503P0256</div><div class="line">   主 DNS 后缀 . . . . . . . . . . . : xxx(lol)</div><div class="line">   节点类型  . . . . . . . . . . . . : 混合</div><div class="line">   IP 路由已启用 . . . . . . . . . . : 否</div><div class="line">   WINS 代理已启用 . . . . . . . . . : 否</div><div class="line">   DNS 后缀搜索列表  . . . . . . . . : xxx(lol)</div><div class="line"></div><div class="line">以太网适配器 本地连接:</div><div class="line"></div><div class="line">   连接特定的 DNS 后缀 . . . . . . . : xxx(lol)</div><div class="line">   描述. . . . . . . . . . . . . . . : Realtek PCIe GBE Family Controller</div><div class="line">   物理地址. . . . . . . . . . . . . : F0-79-59-64-74-71</div><div class="line">   DHCP 已启用 . . . . . . . . . . . : 是</div><div class="line">   自动配置已启用. . . . . . . . . . : 是</div><div class="line">   本地链接 IPv6 地址. . . . . . . . : fe80::1d00:63da:2b98:8c05%11(首选) </div><div class="line">   IPv4 地址 . . . . . . . . . . . . : 192.168.10.220(首选) </div><div class="line">   子网掩码  . . . . . . . . . . . . : 255.255.255.0</div><div class="line">   获得租约的时间  . . . . . . . . . : 2016年3月29日 10:05:04</div><div class="line">   租约过期的时间  . . . . . . . . . : 2016年4月6日 16:32:42</div><div class="line">   默认网关. . . . . . . . . . . . . : 192.168.10.254</div><div class="line">   DHCP 服务器 . . . . . . . . . . . : 192.168.10.202</div><div class="line">   DHCPv6 IAID . . . . . . . . . . . : 235430502</div><div class="line">   DHCPv6 客户端 DUID  . . . . . . . : 00-01-00-01-1C-AE-A2-19-F0-79-59-64-74-71</div><div class="line">   DNS 服务器  . . . . . . . . . . . : 192.168.10.12</div><div class="line">                                       192.168.15.3</div><div class="line">   TCPIP 上的 NetBIOS  . . . . . . . : 已启用</div><div class="line"></div><div class="line">隧道适配器 isatap.xxx(lol):</div><div class="line"></div><div class="line">   媒体状态  . . . . . . . . . . . . : 媒体已断开</div><div class="line">   连接特定的 DNS 后缀 . . . . . . . : xxx(lol)</div><div class="line">   描述. . . . . . . . . . . . . . . : Microsoft ISATAP Adapter</div><div class="line">   物理地址. . . . . . . . . . . . . : 00-00-00-00-00-00-00-E0</div><div class="line">   DHCP 已启用 . . . . . . . . . . . : 否</div><div class="line">   自动配置已启用. . . . . . . . . . : 是</div><div class="line"></div><div class="line">隧道适配器 Teredo Tunneling Pseudo-Interface:</div><div class="line"></div><div class="line">   媒体状态  . . . . . . . . . . . . : 媒体已断开</div><div class="line">   连接特定的 DNS 后缀 . . . . . . . : </div><div class="line">   描述. . . . . . . . . . . . . . . : Teredo Tunneling Pseudo-Interface</div><div class="line">   物理地址. . . . . . . . . . . . . : 00-00-00-00-00-00-00-E0</div><div class="line">   DHCP 已启用 . . . . . . . . . . . : 否</div><div class="line">   自动配置已启用. . . . . . . . . . : 是</div></pre></td></tr></table></figure></p>
<p>好了, 最后验证一下刚开始谈到的那个数据库的问题. 当我分别使用<code>192.168.10.20</code>和<code>localhost</code>通过SQLyog连接时, 果真看到的是俩个不一样的数据库….</p>
<p>然后我又写了一个测试程序<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestLocalhost</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line">        ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket();</div><div class="line">        serverSocket.bind(<span class="keyword">new</span> InetSocketAddress(<span class="string">"192.168.10.220"</span>, <span class="number">9051</span>));</div><div class="line"><span class="comment">//        serverSocket.bind(new InetSocketAddress("localhost", 9051));</span></div><div class="line">        serverSocket.accept();</div><div class="line">        System.out.println(<span class="string">"connected!!!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后使用http请求测试</p>
<ul>
<li><code>http://localhost:9051/</code> 不可连接成功</li>
<li><code>http://192.168.10.220:9051/</code>  连接成功<br>说明<code>192.168.10.20</code>和<code>localhost</code>本身是不能互通的.</li>
</ul>
<p>接下来我改进一下这个程序<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestLocalhost</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        SocketAcceptor socketAcceptor1 = <span class="keyword">new</span> SocketAcceptor(<span class="string">"192.168.10.220"</span>);</div><div class="line">        SocketAcceptor socketAcceptor2 = <span class="keyword">new</span> SocketAcceptor(<span class="string">"localhost"</span>);</div><div class="line">        socketAcceptor1.start();</div><div class="line">        socketAcceptor2.start();</div><div class="line"></div><div class="line">        TimeUnit.SECONDS.sleep(<span class="number">100</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SocketAcceptor</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">final</span> String ip;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SocketAcceptor</span><span class="params">(String ip)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.ip = ip;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                ServerSocket serverSocket1 = <span class="keyword">new</span> ServerSocket();</div><div class="line">                serverSocket1.bind(<span class="keyword">new</span> InetSocketAddress(ip, <span class="number">9051</span>));</div><div class="line">                serverSocket1.accept();</div><div class="line">                System.out.println(ip + <span class="string">" accepted"</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后继续使用上面俩个地址进行访问, 发现最后都进行了输出<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">192.168.10.220 accepted</div><div class="line">localhost accepted</div></pre></td></tr></table></figure></p>
<p>这个例子也说明了不同的网卡可以绑定不同的端口, 即使是虚拟网卡也有一套自己端口</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/06/Java/IP地址在网卡上的表现/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/06/Java/IP地址在网卡上的表现/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/31/算法/计算二维数组索引/" title="计算二维数组索引" itemprop="url">计算二维数组索引</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-31T07:00:00.000Z" itemprop="datePublished"> Published 2016-03-31</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>假设我们有这样的一个二维数组<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(X,Y)	<span class="number">0</span>	<span class="number">1</span>	<span class="number">2</span></div><div class="line"><span class="number">0</span>		<span class="number">0</span>	<span class="number">1</span>	<span class="number">2</span></div><div class="line"><span class="number">1</span>		<span class="number">3</span>	<span class="number">4</span>	<span class="number">5</span></div><div class="line"><span class="number">2</span>		<span class="number">6</span>	<span class="number">7</span>	<span class="number">8</span></div></pre></td></tr></table></figure></p>
<ul>
<li>(0, 0) -&gt; 0</li>
<li>(1, 0) -&gt; 1</li>
<li>(2, 0) -&gt; 2</li>
<li>(0, 1) -&gt; 3</li>
<li>(1, 1) -&gt; 4</li>
<li>(2, 1) -&gt; 5</li>
<li>(0, 2) -&gt; 6</li>
<li>(1, 2) -&gt; 7</li>
<li>(2, 2) -&gt; 8<br>下面我们实现这个算法<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> width = <span class="number">3</span>;</div><div class="line">        <span class="keyword">int</span> length = <span class="number">3</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; width; x++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; length; y++) &#123;</div><div class="line">                System.out.println(<span class="string">"("</span> + x + <span class="string">", "</span> + y + <span class="string">")"</span> + (x + y * length));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>我们可以这样想象: 将这个二维数组串行, 就是以<code>0, 1 , 2, 3, 4, 5, 6</code>, 当计算(1, 1)这个坐标的时候就是用x加上 y在x上移动的倍数</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/算法/">算法</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/31/算法/计算二维数组索引/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/31/算法/计算二维数组索引/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/20/jvm/类和实例的初始化/" title="类和实例的初始化" itemprop="url">类和实例的初始化</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-20T07:00:00.000Z" itemprop="datePublished"> Published 2016-03-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="实例化过程"><a href="#实例化过程" class="headerlink" title="实例化过程"></a>实例化过程</h2><p>最近面试的时候遇到很多人都在问java初始化的东西, 今天就写个测试程序来个JAVA初始化大揭秘.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestInit</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> B();</div><div class="line">        <span class="keyword">new</span> B();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"A"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    &#123;</div><div class="line">        System.out.println(<span class="string">"A init"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        System.out.println(<span class="string">"A static init"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"B"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    &#123;</div><div class="line">        System.out.println(<span class="string">"B init"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        System.out.println(<span class="string">"B static init"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个程序的输出结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">A static init</div><div class="line">B static init</div><div class="line">A init</div><div class="line">A</div><div class="line">B init</div><div class="line">B</div><div class="line">A init</div><div class="line">A</div><div class="line">B init</div><div class="line">B</div></pre></td></tr></table></figure></p>
<p>下面我用javap命令反编译一下TestInit的class字节码<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">➜  classes  javap -c TestInit</div><div class="line">Compiled from "TestInit.java"</div><div class="line">public class TestInit &#123;</div><div class="line">  public TestInit();</div><div class="line">    Code:</div><div class="line">       0: aload_0</div><div class="line">       1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</div><div class="line">       4: return</div><div class="line"></div><div class="line">  public static void main(java.lang.String[]);</div><div class="line">    Code:</div><div class="line">       0: new           #2                  // class B</div><div class="line">       3: dup</div><div class="line">       4: invokespecial #3                  // Method B."&lt;init&gt;":()V</div><div class="line">       7: pop</div><div class="line">       8: new           #2                  // class B</div><div class="line">      11: dup</div><div class="line">      12: invokespecial #3                  // Method B."&lt;init&gt;":()V</div><div class="line">      15: pop</div><div class="line">      16: return</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后看一下A的class字节码<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">➜  classes  javap -c A</div><div class="line">Compiled from "TestInit.java"</div><div class="line">class A &#123;</div><div class="line">  public A();</div><div class="line">    Code:</div><div class="line">       0: aload_0</div><div class="line">       1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</div><div class="line">       4: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</div><div class="line">       7: ldc           #3                  // String A init</div><div class="line">       9: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</div><div class="line">      12: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</div><div class="line">      15: ldc           #5                  // String A</div><div class="line">      17: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</div><div class="line">      20: return</div><div class="line"></div><div class="line">  static &#123;&#125;;</div><div class="line">    Code:</div><div class="line">       0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</div><div class="line">       3: ldc           #6                  // String A static init</div><div class="line">       5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</div><div class="line">       8: return</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面代码的执行结果我们也可以看出, A的代码是先执行的<code>static</code>静态初始化的(这段代码只有在类被加载进虚拟机中时才会执行一次). 那么我们就先从它分析入手</p>
<ol>
<li><code>getstatic</code> 访问<code>java/lang/System.out</code>这个实例熟悉</li>
<li><code>ldc</code> 从常量池里加载一个常亮进入操作数栈, 这里加载的是<code>A static init</code>字符串</li>
<li><code>invokevirtual</code> 然后调用<code>java/io/PrintStream.println</code>方法, 输出<code>A static init</code>字符串</li>
</ol>
<p>构造器的代码开始执行</p>
<ol>
<li><code>aload_0</code> : 从局部变量表加载一个reference类型值到操作数栈, 这个变量应该是this</li>
<li><code>invokespecial</code> : 用于需要特殊处理的实例方法(实例初始化方法, 私有方法和父类方法). 这里是调用A的实例化方法, 也就是<code>{}</code>这中的代码</li>
<li><code>getstatic</code> 实例化方法访问<code>java/lang/System.out</code>属性</li>
<li><code>ldc</code> 实例化方法从常量池里加载一个常亮进入操作数栈, 这里加载的是<code>A init</code>字符串</li>
<li><code>invokevirtual</code> 实例化方法调用<code>java/io/PrintStream.println</code>方法, 输出<code>A init</code>字符串</li>
<li><code>getstatic</code> 构造器访问<code>java/lang/System.out</code>属性</li>
<li><code>ldc</code>构造器从常量池里加载一个常亮进入操作数栈, 这里加载的是<code>A</code>字符串</li>
<li><code>invokevirtual</code> 构造器调用<code>java/io/PrintStream.println</code>方法, 输出<code>A</code>字符串</li>
</ol>
<p>然后我们看一下B的claa字节码<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">➜  classes  javap -c B</div><div class="line">Compiled from "TestInit.java"</div><div class="line">class B extends A &#123;</div><div class="line">  public B();</div><div class="line">    Code:</div><div class="line">       0: aload_0</div><div class="line">       1: invokespecial #1                  // Method A."&lt;init&gt;":()V</div><div class="line">       4: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</div><div class="line">       7: ldc           #3                  // String B init</div><div class="line">       9: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</div><div class="line">      12: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</div><div class="line">      15: ldc           #5                  // String B</div><div class="line">      17: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</div><div class="line">      20: return</div><div class="line"></div><div class="line">  static &#123;&#125;;</div><div class="line">    Code:</div><div class="line">       0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</div><div class="line">       3: ldc           #6                  // String B static init</div><div class="line">       5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</div><div class="line">       8: return</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>与A类似, B同样是从类的初始化开始代码执行的</p>
<ol>
<li><code>getstatic</code> 访问<code>java/lang/System.out</code>这个实例熟悉</li>
<li><code>ldc</code> 从常量池里加载一个常亮进入操作数栈, 这里加载的是<code>B static init</code>字符串</li>
<li><code>invokevirtual</code> 然后调用<code>java/io/PrintStream.println</code>方法, 输出<code>B static init</code>字符串</li>
</ol>
<p>然后是构造器方法执行</p>
<ol>
<li><code>aload_0</code>同样的是加载<code>this</code>进虚拟机栈</li>
<li><code>invokespecial</code> 调用父类A的实例初始化方法</li>
<li>然后就开死像A一样, 调用自己的实例化过程</li>
</ol>
<p>如果我们只加载这个类呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestInit</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</div><div class="line">		Class.forName(<span class="string">"B"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果输出为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">A static init</div><div class="line">B static init</div></pre></td></tr></table></figure></p>
<p>这也间接地验证了我们上面的推算</p>
<h2 id="类的初始化"><a href="#类的初始化" class="headerlink" title="类的初始化"></a>类的初始化</h2><p>类初始化阶段是类加载过程中最后一步,开始执行类构造器<clinit>方法. <code>&lt;clinit&gt;</code>方法执行过程可能会影响程序运行行为的一些特点和细节</clinit></p>
<ol>
<li><code>&lt;clinit&gt;</code>方法由编译器将类变量的赋值动作和静态语句块(static{}块)中的语句合并产生的.编译器收集的顺序是由语句在源文件中出现的顺序决定的,静态语句块只能访问到定义在静态语句块之前的变量,定义在它之后的变量,在前面的静态语句块中可以赋值但是不能访问.</li>
<li><code>&lt;clinit&gt;()</code>方法和实例的构造函数(<init>)不同,他不需要显式地调用父类构造器,虚拟机会保证在子类的<clinit>()方法执行之前,父类的<code>&lt;clinit&gt;</code>方法已经执行完毕,因此虚拟机中第一个被执行的<code>&lt;clinit&gt;()</code>方法的类肯定是<code>java.lang.Object</code></clinit></init></li>
<li>由于父类的<code>&lt;clinit&gt;()</code>方法先执行,也就意味着父类中定义的静态语句块要优先于子类的变量赋值操作</li>
<li><code>&lt;clinit&gt;()</code>方法对于对类或者接口来说并不是必须的,如果一个类中没有静态语句块,也没有对变量的赋值操作,那么编译器可以不为这个类生成<code>&lt;clinit&gt;()</code>方法.</li>
<li>接口中不能使用静态语句块,但仍然有变量初始化的赋值操作,因此接口与类一样会生成<clinit>()方法.但接口与类不同的是,执行接口<code>&lt;clinit&gt;()</code>不需要先执行父接口<code>&lt;clinit&gt;()</code>.只有当父接口中定义的变量被使用时,父接口才会被初始化.另外,接口的实现类在初始化时也一样不会执行接口的<clinit>()方法.</clinit></clinit></li>
<li>虚拟机会保证一个类的<code>&lt;clinit&gt;()</code>方法在多线程环境中被正确地加锁和同步,如果多个线程同时去初始化一个类,那么只会有一个线程去执行这个类的<code>&lt;clinit&gt;()</code>方法,其他线程都需要阻塞等待,直到活动线程执行<code>&lt;clinit&gt;()</code>方法完毕. 如果,在一个类的<clinit>()方法中有耗时很长的操作,那就很可能造成多个进程阻塞.</clinit></li>
</ol>
<p><code>&lt;clinit&gt;()</code>方法执行顺序<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewClass</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> A = <span class="number">1</span>;</div><div class="line">        <span class="keyword">static</span> &#123;</div><div class="line">            A = <span class="number">2</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sub</span> <span class="keyword">extends</span> <span class="title">Parent</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> B = A;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        System.out.println(Sub.B);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>字段解析<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadLoopClass</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">true</span>) &#123;</div><div class="line">            System.out.println(Thread.currentThread() + <span class="string">" init DeadLoopClass "</span>);</div><div class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;&#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Runnable script = <span class="keyword">new</span> Runnable() &#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                System.out.println(Thread.currentThread() + <span class="string">" start"</span>);</div><div class="line">                DeadLoopClass dlc = <span class="keyword">new</span> DeadLoopClass();</div><div class="line">                System.out.println(Thread.currentThread() + <span class="string">" run over"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        Thread t1 = <span class="keyword">new</span> Thread(script);</div><div class="line">        Thread t2 = <span class="keyword">new</span> Thread(script);</div><div class="line">        t1.start();</div><div class="line">        t2.start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>类初始化的四种情况</p>
<ol>
<li>遇到new, getstatic, putstatic, invokestatic, 这四条字节码指令时, 如果类没有进行过初始化,则必须先触发初始化</li>
<li>使用java.lang.reflect包的方法进行反射调用的时候,如果类没有进行过初始化,则需要先触发其初始化</li>
<li>当初始化一个类的时候,如果发现其父类还没有进行过初始化,则需要先触发其父类的初始化.</li>
<li>当虚拟机启动的时候,用户需要指定一个要执行的主类,虚拟机会先初始化这个主类.</li>
</ol>
<p>通过子类引用父类的静态字段,不会导致子类的类初始化<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SuperClass</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        System.out.println(<span class="string">"SuperClass init"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> value = <span class="number">123</span>;</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubClass</span> <span class="keyword">extends</span> <span class="title">SuperClass</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        System.out.println(<span class="string">"SubClass init"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotInitialization</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        System.out.println(SubClass.value);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过数组定义来引用类,不会触发此类的初始化<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SuperClass</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        System.out.println(<span class="string">"SuperClass init"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> value = <span class="number">123</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotInitialization</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SuperClass[] sca = <span class="keyword">new</span> SuperClass[<span class="number">10</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>常量在编译阶段会存入调用类的常量池中,本质上没有直接引用到定义常量的类,因此不会触发定义常量的类的初始化<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConstClass</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        System.out.println(<span class="string">"ConstClass init"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HELLOWORLD = <span class="string">"hello world"</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotInitialization</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        System.out.println(ConstClass.HELLOWORLD);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/20/jvm/类和实例的初始化/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/20/jvm/类和实例的初始化/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/19/算法/二叉树/" title="二叉树" itemprop="url">二叉树</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-19T07:00:00.000Z" itemprop="datePublished"> Published 2016-03-19</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>二叉树就是有一个根节点, 每个节点最多有俩个子节点的树形结构. 二叉树又分为三种状态</p>
<ul>
<li>满二叉树: 除了叶子节点之外, 所有的节点上都有俩个子节点的树</li>
<li>完全二叉树 : 除了叶子结点之外, 其余的节点上要么有俩个子节点要么一个子节点的树</li>
<li>非完全二叉树 : 除了叶子节点之外, 其余的节点上出现了只有一个子节点的树</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/算法/">算法</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/19/算法/二叉树/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/19/算法/二叉树/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/19/netty/Unsafe/" title="Netty Unsafe" itemprop="url">Netty Unsafe</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-19T07:00:00.000Z" itemprop="datePublished"> Published 2016-03-19</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>首先我们来看一下<code>Unsafe</code>的继承<br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/netty/unsafe.jpg" alt=""></p>
<h2 id="Unsafe"><a href="#Unsafe" class="headerlink" title="Unsafe"></a>Unsafe</h2><p><code>Unsafe</code>是<code>Channel</code>的内部接口, 它定义了下面的相关功能</p>
<ul>
<li><code>localAddress()</code> : 获得本地绑定的<code>SocketAddress</code>对象</li>
<li><code>remoteAddress()</code> : 返回与网络对等端绑定的地址<code>SocketAddress</code></li>
<li><code>register()</code> : 将<code>EventLoop</code>注册到<code>Channel</code>上, 一旦注册成功就返回<code>ChannelFuture</code></li>
<li><code>bind()</code> : 将<code>SocketAddress</code>绑定到<code>Channel</code>上.</li>
<li><code>connect()</code> : <code>Channel</code>与对端的<code>SocketAddress</code>进行连接</li>
<li><code>disconnect()</code> : <code>Channel</code>与网络对端断开连接</li>
<li><code>close()</code> : 关闭<code>Channel</code>与网络对端的连接</li>
<li><code>deregister()</code> : <code>Channel</code>与<code>EventLoop</code>解除注册关系</li>
<li><code>beginRead()</code> : Schedules a read operation that fills the inbound buffer of the first {@link ChannelInboundHandler} in the {@link ChannelPipeline}.  If there’s already a pending read operation, this method does nothing.</li>
<li><code>write()</code> : 调度一个写操作</li>
<li><code>flush()</code> : 通过<code>write()</code>将全部的写操作进行调用</li>
<li><code>outboundBuffer()</code> : Returns the {@link ChannelOutboundBuffer} of the {@link Channel} where the pending write requests are stored.</li>
</ul>
<h2 id="AbstractUnsafe"><a href="#AbstractUnsafe" class="headerlink" title="AbstractUnsafe"></a>AbstractUnsafe</h2><p><code>AbstractUnsafe</code>是<code>AbstractChannel</code>的内部类, 主要是提供了对<code>AbstractChannel</code>的辅助功能, 它内部实现了N个, 这些方法最终都会调用<code>AbstractChannel</code>子类实现的<code>doXXX()</code>相关方法. 例如:</p>
<ul>
<li><code>register()</code> -&gt; <code>doRegister()</code>(<code>AbstractNioChannel</code>实现), 调用完成之后调用pipline的<code>fireChannelRegistered()</code>和<code>fireChannelActive()</code>.</li>
<li><code>bind()</code> -&gt; <code>doBind()</code></li>
<li><code>disconnect()</code> -&gt; <code>doDisconnect()</code></li>
<li><code>close()</code> -&gt; <code>doClose()</code></li>
<li><code>deregister</code> -&gt; <code>doDeregister()</code>(<code>AbstractNioChannel</code>实现)</li>
<li><code>beginRead()</code> -&gt; <code>doBeginRead()</code>(<code>AbstractNioChannel</code>实现)</li>
<li><code>flush()</code> -&gt; <code>doWrite()</code></li>
</ul>
<p>需要仔细看一下的是<code>AbstractUnsafe</code>内部消息存储的一个环形数组<code>ChannelOutboundBuffer</code>成员<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ChannelOutboundBuffer outboundBuffer = <span class="keyword">new</span> ChannelOutboundBuffer(AbstractChannel.<span class="keyword">this</span>);</div></pre></td></tr></table></figure></p>
<p>下来我们看一下它的<code>write()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(Object msg, ChannelPromise promise)</span> </span>&#123;</div><div class="line">            ChannelOutboundBuffer outboundBuffer = <span class="keyword">this</span>.outboundBuffer;</div><div class="line">            <span class="keyword">if</span> (outboundBuffer == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// outboundBuffer为空, 说明channel已经关闭了, 那么现在就需要立刻做快速失败处理</span></div><div class="line">                safeSetFailure(promise, CLOSED_CHANNEL_EXCEPTION);</div><div class="line">                <span class="comment">// 将消息释放掉, 避免发生内存泄漏</span></div><div class="line">                ReferenceCountUtil.release(msg);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">int</span> size;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                msg = filterOutboundMessage(msg);</div><div class="line">                size = estimatorHandle().size(msg);</div><div class="line">                <span class="keyword">if</span> (size &lt; <span class="number">0</span>) &#123;</div><div class="line">                    size = <span class="number">0</span>;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                safeSetFailure(promise, t);</div><div class="line">                ReferenceCountUtil.release(msg);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// 我们看到, 在写消息的时候,最后就是将msg写到了一个环形数组里</span></div><div class="line">            outboundBuffer.addMessage(msg, size, promise);</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>将消息写到<code>outboundBuffer</code>之后, 最终我们还是需要调用<code>flush()</code>将其真正刷到TCP中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> </span>&#123;</div><div class="line">            ChannelOutboundBuffer outboundBuffer = <span class="keyword">this</span>.outboundBuffer;</div><div class="line">            outboundBuffer.addFlush();</div><div class="line">            flush0();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">flush0</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">final</span> ChannelOutboundBuffer outboundBuffer = <span class="keyword">this</span>.outboundBuffer;</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                doWrite(outboundBuffer);</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line"></div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                inFlush0 = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>我们看到最终的写到channel中也是由<code>doWrite()</code>方法实现的.</p>
<h2 id="AbstractNioUnsafe"><a href="#AbstractNioUnsafe" class="headerlink" title="AbstractNioUnsafe"></a>AbstractNioUnsafe</h2><p><code>AbstractNioUnsafe</code>是<code>AbstactNioChannel</code>的内部类. 与<code>AbstractUnsafe</code>类似, 它也是提供了一些对Channel的代理调用</p>
<ul>
<li><code>connect()</code> -&gt; <code>doConnect()</code></li>
<li><code>finishConnect()</code> -&gt; <code>doFinishConnect()</code></li>
</ul>
<h2 id="NioByteUnsafe"><a href="#NioByteUnsafe" class="headerlink" title="NioByteUnsafe"></a>NioByteUnsafe</h2><p>我们重点看一下<code>read()</code>和<code>write()</code>方法</p>
<p>我们首先看一下<code>read()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">final</span> ChannelConfig config = config();</div><div class="line">            <span class="keyword">if</span> (!config.isAutoRead() &amp;&amp; !isReadPending()) &#123;</div><div class="line">                <span class="comment">// ChannelConfig.setAutoRead(false) was called in the meantime</span></div><div class="line">                removeReadOp();</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> ChannelPipeline pipeline = pipeline();</div><div class="line">            <span class="keyword">final</span> ByteBufAllocator allocator = config.getAllocator();</div><div class="line">            <span class="comment">// 我们配置的每次读取数据最多读取的数据量</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> maxMessagesPerRead = config.getMaxMessagesPerRead();</div><div class="line">            RecvByteBufAllocator.Handle allocHandle = <span class="keyword">this</span>.allocHandle;</div><div class="line">            <span class="keyword">if</span> (allocHandle == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">this</span>.allocHandle = allocHandle = config.getRecvByteBufAllocator().newHandle();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ByteBuf byteBuf = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">int</span> messages = <span class="number">0</span>;</div><div class="line">            <span class="keyword">boolean</span> close = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// 读取的总量</span></div><div class="line">                <span class="keyword">int</span> totalReadAmount = <span class="number">0</span>;</div><div class="line">                <span class="comment">//</span></div><div class="line">                <span class="keyword">boolean</span> readPendingReset = <span class="keyword">false</span>;</div><div class="line">                do &#123;</div><div class="line">                    <span class="comment">// 获取一个byteBuf对象, 用于这次读取数据, 具体的获取策略, 本文最后有介绍</span></div><div class="line">                    byteBuf = allocHandle.allocate(allocator);</div><div class="line">                    <span class="keyword">int</span> writable = byteBuf.writableBytes();</div><div class="line">                    <span class="comment">// 调用NioSocketChannel的doReadBytes()实现, 将数据读进byteBuf中</span></div><div class="line">                    <span class="keyword">int</span> localReadAmount = doReadBytes(byteBuf);</div><div class="line">                    <span class="keyword">if</span> (localReadAmount &lt;= <span class="number">0</span>) &#123;</div><div class="line">                        <span class="comment">// 如果没有读到数据,则将ByteBuf释放掉</span></div><div class="line">                        byteBuf.release();</div><div class="line">                        close = localReadAmount &lt; <span class="number">0</span>;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (!readPendingReset) &#123;</div><div class="line">                        readPendingReset = <span class="keyword">true</span>;</div><div class="line">                        setReadPending(<span class="keyword">false</span>);</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// 开始在pipeline里进行ByteBuf数据传播</span></div><div class="line">                    pipeline.fireChannelRead(byteBuf);</div><div class="line">                    byteBuf = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (totalReadAmount &gt;= Integer.MAX_VALUE - localReadAmount) &#123;</div><div class="line">                        <span class="comment">// Avoid overflow.</span></div><div class="line">                        totalReadAmount = Integer.MAX_VALUE;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="comment">// 统计所有的读到的数据</span></div><div class="line">                    totalReadAmount += localReadAmount;</div><div class="line"></div><div class="line">                    <span class="comment">// stop reading</span></div><div class="line">                    <span class="keyword">if</span> (!config.isAutoRead()) &#123;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (localReadAmount &lt; writable) &#123;</div><div class="line">                        <span class="comment">// Read less than what the buffer can hold,</span></div><div class="line">                        <span class="comment">// which might mean we drained the recv buffer completely.</span></div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// 如果仍然有未读数据的话, 则继续读取</span></div><div class="line">                &#125; <span class="keyword">while</span> (++ messages &lt; maxMessagesPerRead);</div><div class="line"></div><div class="line">                <span class="comment">// 当前所有数据都读取完了, 触发</span></div><div class="line">                pipeline.fireChannelReadComplete();</div><div class="line">                <span class="comment">// 根据当前读到的字节数预测下个消息的字节数大小</span></div><div class="line">                allocHandle.record(totalReadAmount);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (close) &#123;</div><div class="line">                    closeOnRead(pipeline);</div><div class="line">                    close = <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                handleReadException(pipeline, byteBuf, t, close);</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                <span class="comment">// Check if there is a readPending which was not processed yet.</span></div><div class="line">                <span class="comment">// This could be for two reasons:</span></div><div class="line">                <span class="comment">// * The user called Channel.read() or ChannelHandlerContext.read() in channelRead(...) method</span></div><div class="line">                <span class="comment">// * The user called Channel.read() or ChannelHandlerContext.read() in channelReadComplete(...) method</span></div><div class="line">                <span class="comment">//</span></div><div class="line">                <span class="comment">// See https://github.com/netty/netty/issues/2254</span></div><div class="line">                <span class="keyword">if</span> (!config.isAutoRead() &amp;&amp; !isReadPending()) &#123;</div><div class="line">                    removeReadOp();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h2 id="NioMessageUnsafe"><a href="#NioMessageUnsafe" class="headerlink" title="NioMessageUnsafe"></a>NioMessageUnsafe</h2><p><code>NioMessageUnsafe</code>是<code>AbstractNioMessageChannel</code>的内部类. 它的<code>read()</code>方法与<code>NioByteMessage</code>的类似, 只不过这个是用于<br>服务<code>NioServerSocketChannel</code>的, 它内部的<code>doReadMessages()</code>会调用的<code>NioServerSocketChannel</code>的实现. <code>readBuf</code>每个<code>NioMessageUnsafe</code>对象都会生成一个<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; readBuf = <span class="keyword">new</span> ArrayList&lt;Object&gt;();</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="function"><span class="keyword">assert</span> <span class="title">eventLoop</span><span class="params">()</span>.<span class="title">inEventLoop</span><span class="params">()</span></span>;</div><div class="line">            <span class="keyword">final</span> ChannelConfig config = config();</div><div class="line">            <span class="keyword">if</span> (!config.isAutoRead() &amp;&amp; !isReadPending()) &#123;</div><div class="line">                <span class="comment">// ChannelConfig.setAutoRead(false) was called in the meantime</span></div><div class="line">                removeReadOp();</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// 从配置中获取每次读取消息的最大字节数</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> maxMessagesPerRead = config.getMaxMessagesPerRead();</div><div class="line">            <span class="keyword">final</span> ChannelPipeline pipeline = pipeline();</div><div class="line">            <span class="keyword">boolean</span> closed = <span class="keyword">false</span>;</div><div class="line">            Throwable exception = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">for</span> (;;) &#123;</div><div class="line">                        <span class="comment">// 从NioServerSocketChannel中读取NioSocketChannel进readBuf中</span></div><div class="line">                        <span class="keyword">int</span> localRead = doReadMessages(readBuf);</div><div class="line">                        <span class="keyword">if</span> (localRead == <span class="number">0</span>) &#123;</div><div class="line">                          <span class="comment">// 如果没有新的连接, 则不再读取</span></div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span> (localRead &lt; <span class="number">0</span>) &#123;</div><div class="line">                            closed = <span class="keyword">true</span>;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="comment">// stop reading and remove op</span></div><div class="line">                        <span class="keyword">if</span> (!config.isAutoRead()) &#123;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="keyword">if</span> (readBuf.size() &gt;= maxMessagesPerRead) &#123;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                    exception = t;</div><div class="line">                &#125;</div><div class="line">                setReadPending(<span class="keyword">false</span>);</div><div class="line">                <span class="keyword">int</span> size = readBuf.size();</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i ++) &#123;</div><div class="line">                    <span class="comment">// 触发NioServerSocketChannel的pipeline的fireChannelRead()方法</span></div><div class="line">                    <span class="comment">// 从而触发ServerBoostTrap的read方法, 将readBuf里的NioSocketChannel与从Reactor进行注册绑定</span></div><div class="line">                    pipeline.fireChannelRead(readBuf.get(i));</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// 将所有的NioSocketChannel与从Reactor都完成注册之后, 将readBuf清空</span></div><div class="line">                readBuf.clear();</div><div class="line">                <span class="comment">// 最后调用NioServerSocketChannel的fireChannelReadComplete</span></div><div class="line">                pipeline.fireChannelReadComplete();</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (exception != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> IOException &amp;&amp; !(exception <span class="keyword">instanceof</span> PortUnreachableException)) &#123;</div><div class="line">                        <span class="comment">// ServerChannel should not be closed even on IOException because it can often continue</span></div><div class="line">                        <span class="comment">// accepting incoming connections. (e.g. too many open files)</span></div><div class="line">                        closed = !(AbstractNioMessageChannel.<span class="keyword">this</span> <span class="keyword">instanceof</span> ServerChannel);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    pipeline.fireExceptionCaught(exception);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (closed) &#123;</div><div class="line">                    <span class="keyword">if</span> (isOpen()) &#123;</div><div class="line">                        close(voidPromise());</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                <span class="comment">// Check if there is a readPending which was not processed yet.</span></div><div class="line">                <span class="comment">// This could be for two reasons:</span></div><div class="line">                <span class="comment">// * The user called Channel.read() or ChannelHandlerContext.read() in channelRead(...) method</span></div><div class="line">                <span class="comment">// * The user called Channel.read() or ChannelHandlerContext.read() in channelReadComplete(...) method</span></div><div class="line">                <span class="comment">//</span></div><div class="line">                <span class="comment">// See https://github.com/netty/netty/issues/2254</span></div><div class="line">                <span class="keyword">if</span> (!config.isAutoRead() &amp;&amp; !isReadPending()) &#123;</div><div class="line">                    removeReadOp();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h2 id="AdaptiveRecvByteBufAllocator"><a href="#AdaptiveRecvByteBufAllocator" class="headerlink" title="AdaptiveRecvByteBufAllocator"></a>AdaptiveRecvByteBufAllocator</h2><p>由于<code>RecvByteBufAllocator</code>只在Unsafe体系中用到了, 就不再单独拿个章节出来讲它, 在这里我们重点分析一个<code>AdaptiveRecvByteBufAllocator</code></p>
<p>我们首先看一下他的内部成员属性<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_MINIMUM = <span class="number">64</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL = <span class="number">1024</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_MAXIMUM = <span class="number">65536</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_INCREMENT = <span class="number">4</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_DECREMENT = <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>[] SIZE_TABLE;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>DEFAULT_MINIMUM</code> : 默认的每个ByteBuf的最小值</li>
<li><code>DEFAULT_INITIAL</code> : 默认的每个ByteBuf的初始值</li>
<li><code>DEFAULT_MAXIMUM</code> : 默认的每个ByteBuf的最大值</li>
<li><code>INDEX_INCREMENT</code> : 默认的每个ByteBuf的增大步进大小</li>
<li><code>INDEX_DECREMENT</code> : 默认的每个ByteBuf的减小步进大小</li>
<li><code>SIZE_TABLE</code> : 所有ByteBuf消息可能会用到的大小值</li>
</ul>
<p>然后我们看一下他的静态初始化<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> &#123;</div><div class="line">        List&lt;Integer&gt; sizeTable = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</div><div class="line">        <span class="comment">// 当消息小于512的时候, 每次步进16字节, 也就是预测下个消息比当前消息仍然大16字节</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">16</span>; i &lt; <span class="number">512</span>; i += <span class="number">16</span>) &#123;</div><div class="line">            sizeTable.add(i);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 当消息大小大于512的时候, 则采取倍增的方式</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">512</span>; i &gt; <span class="number">0</span>; i &lt;&lt;= <span class="number">1</span>) &#123;</div><div class="line">            sizeTable.add(i);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        SIZE_TABLE = <span class="keyword">new</span> <span class="keyword">int</span>[sizeTable.size()];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SIZE_TABLE.length; i ++) &#123;</div><div class="line">            SIZE_TABLE[i] = sizeTable.get(i);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>下面我们看一下<code>getSizeTableIndex()</code>这个方法, 这个方法主要是根据入参然后推算出下一个消息的大小, 内部算法采用的是一个二分查找<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSizeTableIndex</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> size)</span> </span>&#123;</div><div class="line">        <span class="comment">// 遍历所有的SIZE_TABLE</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> low = <span class="number">0</span>, high = SIZE_TABLE.length - <span class="number">1</span>;;) &#123;</div><div class="line">            <span class="keyword">if</span> (high &lt; low) &#123;</div><div class="line">                <span class="keyword">return</span> low;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (high == low) &#123;</div><div class="line">                <span class="keyword">return</span> high;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// 找到中间位置索引</span></div><div class="line">            <span class="keyword">int</span> mid = low + high &gt;&gt;&gt; <span class="number">1</span>;</div><div class="line">            <span class="keyword">int</span> a = SIZE_TABLE[mid];</div><div class="line">            <span class="keyword">int</span> b = SIZE_TABLE[mid + <span class="number">1</span>];</div><div class="line">            <span class="keyword">if</span> (size &gt; b) &#123;</div><div class="line">                <span class="comment">// size大于中间值则向前查找</span></div><div class="line">                low = mid + <span class="number">1</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (size &lt; a) &#123;</div><div class="line">                <span class="comment">// size小于中间值则向后查找</span></div><div class="line">                high = mid - <span class="number">1</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (size == a) &#123;</div><div class="line">                <span class="comment">// 取a值</span></div><div class="line">                <span class="keyword">return</span> mid;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 取b值</span></div><div class="line">                <span class="keyword">return</span> mid + <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>但是真正的预测下一个消息的逻辑是放在了<code>AdaptiveRecvByteBufAllocator</code>的内部类<code>HandleImpl</code>中.<br>我们重点看一下他的<code>record</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">record</span><span class="params">(<span class="keyword">int</span> actualReadBytes)</span> </span>&#123;</div><div class="line">           <span class="keyword">if</span> (actualReadBytes &lt;= SIZE_TABLE[Math.max(<span class="number">0</span>, index - INDEX_DECREMENT - <span class="number">1</span>)]) &#123;</div><div class="line">               <span class="comment">// 判断当前可读字节是否小于当前字节数的前一个大小, 如果小于, 则判断是否需要缩小容量</span></div><div class="line">               <span class="keyword">if</span> (decreaseNow) &#123;</div><div class="line">                   <span class="comment">// 如果需要的话, 则算出前一个索引位置进行缩小下个消息的ByteBuf的大小</span></div><div class="line">                   index = Math.max(index - INDEX_DECREMENT, minIndex);</div><div class="line">                   nextReceiveBufferSize = SIZE_TABLE[index];</div><div class="line">                   decreaseNow = <span class="keyword">false</span>;</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   decreaseNow = <span class="keyword">true</span>;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (actualReadBytes &gt;= nextReceiveBufferSize) &#123;</div><div class="line">               <span class="comment">// 当前可读字节数大于下个可读字节数, 则对其下个ByteBuf进行扩容处理</span></div><div class="line">               index = Math.min(index + INDEX_INCREMENT, maxIndex);</div><div class="line">               nextReceiveBufferSize = SIZE_TABLE[index];</div><div class="line">               decreaseNow = <span class="keyword">false</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Netty/">Netty</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/19/netty/Unsafe/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/19/netty/Unsafe/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/17/netty/Netty 压测/" title="Netty 压测" itemprop="url">Netty 压测</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-17T07:00:00.000Z" itemprop="datePublished"> Published 2016-03-17</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我们知道Netty的性能是非常好的,那究竟有多好呢? 今天我写了一个小程序测试了一下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="keyword">int</span> cpuSize = Runtime.getRuntime().availableProcessors();</div><div class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</div><div class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup(cpuSize);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();</div><div class="line">            b.group(bossGroup, workerGroup)</div><div class="line">                    .channel(NioServerSocketChannel.class)</div><div class="line">                    .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</div><div class="line">                    .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</div><div class="line">                    .option(ChannelOption.AUTO_READ, <span class="keyword">true</span>)</div><div class="line">                    .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> </span>&#123;</div><div class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> InHandler());</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line"></div><div class="line">            ChannelFuture f = b.bind(<span class="number">8881</span>).sync();</div><div class="line">            f.channel().closeFuture().sync();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            bossGroup.shutdownGracefully();</div><div class="line">            workerGroup.shutdownGracefully();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> </span>&#123;</div><div class="line">        ctx.write(msg);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</div><div class="line">        ctx.flush();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面是一个简单的Socket服务器, 不做任何的编解码工作, 当接收到数据之后, 直接返回给客户端.</p>
<p>在启动的这个服务器的时候加上指定虚拟机的堆大小(我们指定了大小为固定的30M)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-Xmx30m -Xms30m</div><div class="line">`</div></pre></td></tr></table></figure></p>
<p>然后写一个Socket客户端程序(原谅我客户端是用python写的, 现在我正在把我业余时间写代码的语言替换成python)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line">count = <span class="number">0</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">socketSendData</span><span class="params">()</span>:</span></div><div class="line">    client=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</div><div class="line">    client.connect((<span class="string">'localhost'</span>,<span class="number">8881</span>))</div><div class="line">    client.send(<span class="string">'2'</span>)</div><div class="line">    time.sleep(<span class="number">60</span>)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">2000</span>, <span class="number">1</span>):</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">       t = threading.Thread(target=socketSendData)</div><div class="line">       info = t.start()</div><div class="line">    <span class="keyword">except</span>:</div><div class="line">       count += <span class="number">1</span></div><div class="line">       <span class="keyword">print</span> <span class="string">"Error: unable to start thread  "</span> + str(count)</div></pre></td></tr></table></figure></p>
<p>由于测试机配置问题, 我的python程序只能启动2000个Socket连接, 但是也无所谓, 我们看一下在这俩千个Socket连接时, Netty服务器的消耗</p>
<p>我们首先看一下客户端连接运行之前的Netty程序的内存占用<br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/netty/netty%20压测1.jpg" alt=""><br>我们看到了在top中为46M, 在visualVM中分配的30M堆内存也只使用了10M, 而且一直在GC.</p>
<p>那么我们再看一下压测之后的内?<br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/netty/Netty%20压测2.jpg" alt=""><br>top中显示占用了58M的内存, 而在visualVM只不过偶尔比10M多一点的内存,而且又很快的GC掉了.</p>
<p>那么top中多出的12M内存是怎么回事呢?这是因为Netty默认的使用的是UnpooledDirectByteBuf(姑且是这么个名字吧), 它使用的是非池化的直接内存, 也就是说在接受网络连接数据的时候,它并没有直接使用堆内内存,而是使用的堆外的.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Netty/">Netty</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/17/netty/Netty 压测/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/17/netty/Netty 压测/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/16/数据库/数据压缩/" title="Mysql 数据压缩" itemprop="url">Mysql 数据压缩</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-16T07:00:00.000Z" itemprop="datePublished"> Published 2016-03-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我们在创建一个表的时候, 可以采用压缩技术<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> CUSTOMER (  </div><div class="line">…  </div><div class="line">) <span class="keyword">COMPRESS</span> YES;</div></pre></td></tr></table></figure></p>
<p>如果想要在中途停止表的压缩<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> CUSTOMER <span class="keyword">COMPRESS</span> <span class="keyword">NO</span>;</div></pre></td></tr></table></figure></p>
<p>但是停止之后并不会对已经存在的数据进行解压缩,如果想要对已经存在的数据解压缩的话, 我们可以使用<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">REORG TABLE CUSTOMER;</div></pre></td></tr></table></figure></p>
<p>这个语句会根据当前表的压缩状态来重新整理表, 对数据进行压缩解压缩.</p>
<p>如果我们只是想要对某个字符串字段(一般是针对Blob字段进行压缩)进行压缩的话, 那么我们可以使用压缩函数<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">COMPRESS(string_to_compress)</div></pre></td></tr></table></figure></p>
<p>然后再对其进行解压缩<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UNCOMPRESS()</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/数据库/">数据库</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/16/数据库/数据压缩/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/16/数据库/数据压缩/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/16/mgits/git/" title="git" itemprop="url">git</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-16T07:00:00.000Z" itemprop="datePublished"> Published 2016-03-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="添加忽略文件"><a href="#添加忽略文件" class="headerlink" title="添加忽略文件"></a>添加忽略文件</h2><p>如果想要忽略文件或者文件夹的话, 可以直接修改<code>.gitignore</code>文件.</p>
<p>例如我要忽略pulic目录下所有的文件和文件夹, 只需要在<code>.gitignore</code>文件中添加如下一行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public/*</div></pre></td></tr></table></figure></p>
<blockquote>
<p>需要注意的是, 如果你在master分之上将其忽略了, 那么当你跳转到其他分之的时候, 你还需要修改其他分支的<code>.gitignore</code>文件</p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/mgits/">mgits</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/16/mgits/git/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/16/mgits/git/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/16/mgits/编码和补码/" title="原码 反码 补码" itemprop="url">原码 反码 补码</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-16T07:00:00.000Z" itemprop="datePublished"> Published 2016-03-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>在大学的时候曾经研究过计算机中数字补码存储方式. 但是时间太长了, 今天拿出点时间再回顾一下,做个笔记.</p>
<p>我们来看一个简单的数字, byte类型的10.我们知道byte的存储单位是8个byte. 因此我们首先看一下10这个数字的原码表示形式<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0000 1010</div></pre></td></tr></table></figure></p>
<p>最左边的最高位表示数字的正反, 因此-10的原码表示形式为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1000 1010</div></pre></td></tr></table></figure></p>
<p>接下来, 我们来看一下反码. 反码就是数字的二进制表示的最高位符号位不变, 其他位取反.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">10的反码</div><div class="line">0111 0101</div><div class="line">-10的反码</div><div class="line">1111 0101</div></pre></td></tr></table></figure></p>
<p>接着我们看一下数字的补码.</p>
<ul>
<li>正数的补码就是原码</li>
<li>负数的补码是数字的反码加1</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">10的补码</div><div class="line">0000 1010</div><div class="line">-10的补码</div><div class="line">1111 0110</div></pre></td></tr></table></figure>
<p>那么计算机为什么要采用补码的形式存储数字呢?</p>
<p>第一点: 为了存储0.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">正数的0的原码</div><div class="line">0000 0000</div><div class="line">负数的0的原码</div><div class="line">1000 0000</div></pre></td></tr></table></figure></p>
<p>我们发现同一个数字却有俩种不同的存储形式, 那么如果采用补码呢?<br>则<code>1000 0000</code>也变成了<code>0000 0000</code></p>
<p>第二点: 可以简化加减法运算. 采用补码的话, 可以将减法作为加法来运算.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/mgits/">mgits</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/16/mgits/编码和补码/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/16/mgits/编码和补码/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/16/数据库/SQL Mod/" title="Data too long for column 引起的设置 sql_mod" itemprop="url">Data too long for column 引起的设置 sql_mod</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-16T07:00:00.000Z" itemprop="datePublished"> Published 2016-03-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>今天游戏上线, 在角色登陆日志里突然发生了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Data too long <span class="keyword">for</span> column <span class="string">'name'</span> at row 1</div></pre></td></tr></table></figure></p>
<p>当时在我们测试环境测试了,没问题, 这是为啥嘞? 当时没有纠结这个问题, 现在出现问题的这个varchar长度调大, 问题解决.</p>
<p>但是为啥生产环境出现问题, 而测试环境就没问题了, 于是开启了我的探索之旅…</p>
<p>我在自己的机器上创建了一张这样的表<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`testvarchar`</span> (</div><div class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span></div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</div></pre></td></tr></table></figure></p>
<p>执行以下语句<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> testvarchar(<span class="keyword">NAME</span>) <span class="keyword">VALUES</span>(<span class="string">"0123456789"</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> testvarchar(<span class="keyword">NAME</span>) <span class="keyword">VALUES</span>(<span class="string">"0123456789123"</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> testvarchar(<span class="keyword">NAME</span>) <span class="keyword">VALUES</span>(<span class="string">"中文测试中文测试中文测试"</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> testvarchar(<span class="keyword">NAME</span>) <span class="keyword">VALUES</span>(<span class="string">"abcdeabcdeabcde"</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> testvarchar(<span class="keyword">NAME</span>) <span class="keyword">VALUES</span>(<span class="string">"a        ee  ee"</span>);</div></pre></td></tr></table></figure></p>
<p>查询结果为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">0123456789</div><div class="line">0123456789</div><div class="line">中文测试中文测试中文</div><div class="line">abcdeabcde</div><div class="line">a        e</div></pre></td></tr></table></figure></p>
<p>很奇怪数据都存进去了,但是却把我的数据给截取到指定的长度10个字符. 而且不管是中文还是数字都是10字符长度. 这会不会和刚才那个问题有关系呢? 鉴于刚才那个问题没有头绪, 于是我看下这个截取的是为啥？<br>于是我找到了这篇文章<a href="http://www.th7.cn/db/mysql/201512/146503.shtml" target="_blank" rel="external">mysql中varchar字段长度超过限制长度自动截取的问题</a></p>
<p>我在本地种使用<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SET</span> <span class="keyword">SESSION</span> sql_mode=<span class="string">'STRICT_TRANS_TABLES'</span>;</div><div class="line"><span class="keyword">SELECT</span> @@sql_mode;</div></pre></td></tr></table></figure></p>
<p>再次执行上面的插入,果真产生了<code>Data too long for column</code>, 看来就是生产环境里设置了这个值引起的.</p>
<p>在本地环境里也要设置成和生产环境一样的, 肯定不能用<code>SESSION</code>，用<code>GLOBLE</code>也不靠谱,我再Windows上对my.ini进行修改<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Set the SQL mode to strict</span></div><div class="line">sql-mode=<span class="string">"STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"</span></div></pre></td></tr></table></figure></p>
<p>这样一来,哪怕MySQL重启了,我们的设置仍然有效.</p>
<p>最后贴一下其他的sql_mode的值</p>
<ul>
<li><code>ONLY_FULL_GROUP_BY</code>：对于GROUP BY聚合操作，如果在SELECT中的列，没有在GROUP BY中出现，那么这个SQL是不合法的，因为列不在GROUP BY从句中</li>
<li><code>NO_AUTO_VALUE_ON_ZERO</code>：该值影响自增长列的插入。默认设置下，插入0或NULL代表生成下一个自增长值。如果用户 希望插入的值为0，而该列又是自增长的，那么这个选项就有用了。</li>
<li><code>STRICT_TRANS_TABLES</code>：在该模式下，如果一个值不能插入到一个事务表中，则中断当前的操作，对非事务表不做限制</li>
<li><code>NO_ZERO_IN_DATE</code>：在严格模式下，不允许日期和月份为零</li>
<li><code>NO_ZERO_DATE</code>：设置该值，mysql数据库不允许插入零日期，插入零日期会抛出错误而不是警告。</li>
<li><code>ERROR_FOR_DIVISION_BY_ZERO</code>：在INSERT或UPDATE过程中，如果数据被零除，则产生错误而非警告。如 果未给出该模式，那么数据被零除时MySQL返回NULL</li>
<li><code>NO_AUTO_CREATE_USER</code>：禁止GRANT创建密码为空的用户</li>
<li><code>NO_ENGINE_SUBSTITUTION</code>：如果需要的存储引擎被禁用或未编译，那么抛出错误。不设置此值时，用默认的存储引擎替代，并抛出一个异常</li>
<li><code>PIPES_AS_CONCAT</code>：将”||”视为字符串的连接操作符而非或运算符，这和Oracle数据库是一样的，也和字符串的拼接函数Concat相类似</li>
<li><code>ANSI_QUOTES</code>：启用ANSI_QUOTES后，不能用双引号来引用字符串，因为它被解释为识别符</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/数据库/">数据库</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/16/数据库/SQL Mod/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/16/数据库/SQL Mod/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/14/netty/NioEventLoop/" title="Netty NioEventLoop" itemprop="url">Netty NioEventLoop</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-14T07:00:00.000Z" itemprop="datePublished"> Published 2016-03-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>在真实的业务环境中, 我们都是使用主从Reactor线程模型. 在Netty中主从线程池都是使用的<code>NioEventLoopGroup</code>, 它实现了<br><code>java.util.concurrent.Executor</code>. 虽然在编程中我们使用的是<code>NioEventLoopGroup</code>, 但是主要的逻辑确是在<code>MultithreadEventExecutorGroup</code>里实现的.<br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/netty/NioEventLoopGroup.jpg" alt=""><br>下来我们首先看一下<code>MultithreadEventExecutorGroup</code>的数据成员<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> EventExecutor[] children;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> EventExecutorChooser chooser;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">MultithreadEventExecutorGroup</span><span class="params">(<span class="keyword">int</span> nThreads, ThreadFactory threadFactory, Object... args)</span> </span>&#123;</div><div class="line">        children = <span class="keyword">new</span> SingleThreadEventExecutor[nThreads];</div><div class="line">        <span class="keyword">if</span> (isPowerOfTwo(children.length)) &#123;</div><div class="line">            chooser = <span class="keyword">new</span> PowerOfTwoEventExecutorChooser();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            chooser = <span class="keyword">new</span> GenericEventExecutorChooser();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nThreads; i ++) &#123;</div><div class="line">            <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                children[i] = newChild(threadFactory, args);</div><div class="line">                success = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                <span class="comment">// <span class="doctag">TODO:</span> Think about if this is a good exception type</span></div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"failed to create a child event loop"</span>, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>我们看到了<code>NioEventLoopGroup</code>内部聚合了一个<code>EventExecutor</code>的数组. 这个数组就构成了主从线程池. 线程的选择由<code>EventExecutorChooser chooser</code>来实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> EventExecutor <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> chooser.next();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PowerOfTwoEventExecutorChooser</span> <span class="keyword">implements</span> <span class="title">EventExecutorChooser</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EventExecutor <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> children[childIndex.getAndIncrement() &amp; children.length - <span class="number">1</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericEventExecutorChooser</span> <span class="keyword">implements</span> <span class="title">EventExecutorChooser</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EventExecutor <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> children[Math.abs(childIndex.getAndIncrement() % children.length)];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而<code>newChild()</code>的方法实现是由子类来确定的, 我们来直接看一下<code>NioEventLoopGroup</code>的内部实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> EventExecutor <span class="title">newChild</span><span class="params">(ThreadFactory threadFactory, Object... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NioEventLoop(<span class="keyword">this</span>, threadFactory, (SelectorProvider) args[<span class="number">0</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>它是直接生成了一个<code>NioEventLoop</code>的实例出来. 下来我们看一下<code>NioEventLoop</code>的实现<br><img src="https://raw.githubusercontent.com/ming15/blog-website/images/netty/NioEventLoop.jpg" alt=""><br>我们看一下<code>NioEventLoop</code>的属性成员<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 多路选择复用器</span></div><div class="line">Selector selector;</div><div class="line"><span class="comment">// Netty优化过的SelectedSelectionKeys</span></div><div class="line"><span class="keyword">private</span> SelectedSelectionKeySet selectedKeys;</div><div class="line"><span class="comment">// SelectorProvider.provider()提供, 在NioEventLoopGroup构造器中实现</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> SelectorProvider provider;</div></pre></td></tr></table></figure></p>
<p>我们看到<code>NioEventLoop</code>主要是实现了IO多路复用, 它的任务执行是由父类<code>SingleThreadEventExecutor</code>实现的, 下面我们从它的构造器来追溯到<code>SingleThreadEventExecutor</code>上<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">NioEventLoop(NioEventLoopGroup parent, ThreadFactory threadFactory, SelectorProvider selectorProvider) &#123;</div><div class="line">    <span class="keyword">super</span>(parent, threadFactory, <span class="keyword">false</span>);</div><div class="line">    <span class="keyword">if</span> (selectorProvider == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"selectorProvider"</span>);</div><div class="line">    &#125;</div><div class="line">    provider = selectorProvider;</div><div class="line">    selector = openSelector();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>SingleThreadEventExecutor</code>这个类主要是实现了主从线程池中的线程功能, 所有的任务都在单线程中执行, 因此将这个线程池串行化, 可以将其看待成一个线程. 在<code>SingleThreadEventExecutor</code>中的构造器中,添加向任务队列中添加一个调用<code>NioEventLoop</code>的<code>run()</code>方法的任务<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">SingleThreadEventExecutor</span><span class="params">(</span></span></div><div class="line">            EventExecutorGroup parent, ThreadFactory threadFactory, <span class="keyword">boolean</span> addTaskWakesUp) &#123;</div><div class="line">        thread = threadFactory.newThread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</div><div class="line">                updateLastExecutionTime();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    SingleThreadEventExecutor.<span class="keyword">this</span>.run();</div><div class="line">                    success = <span class="keyword">true</span>;</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    <span class="keyword">for</span> (;;) &#123;</div><div class="line">                        <span class="keyword">int</span> oldState = STATE_UPDATER.get(SingleThreadEventExecutor.<span class="keyword">this</span>);</div><div class="line">                        <span class="keyword">if</span> (oldState &gt;= ST_SHUTTING_DOWN || STATE_UPDATER.compareAndSet(</div><div class="line">                                SingleThreadEventExecutor.<span class="keyword">this</span>, oldState, ST_SHUTTING_DOWN)) &#123;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// Check if confirmShutdown() was called at the end of the loop.</span></div><div class="line">                    <span class="keyword">if</span> (success &amp;&amp; gracefulShutdownStartTime == <span class="number">0</span>) &#123;</div><div class="line">                        logger.error(<span class="string">"Buggy "</span> + EventExecutor.class.getSimpleName());</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="comment">// Run all remaining tasks and shutdown hooks.</span></div><div class="line">                        <span class="keyword">for</span> (;;) &#123;</div><div class="line">                            <span class="keyword">if</span> (confirmShutdown()) &#123;</div><div class="line">                                <span class="keyword">break</span>;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            cleanup();</div><div class="line">                        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                            STATE_UPDATER.set(SingleThreadEventExecutor.<span class="keyword">this</span>, ST_TERMINATED);</div><div class="line">                            threadLock.release();</div><div class="line">                            terminationFuture.setSuccess(<span class="keyword">null</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        taskQueue = newTaskQueue();</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>我们看到了一行关键性代码<code>SingleThreadEventExecutor.this.run()</code>, 它调用了自己的<code>run()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure></p>
<p>而这个方法是在<code>NioEventLoop</code>中实现的,也是我们要重点分析的代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">boolean</span> oldWakenUp = wakenUp.getAndSet(<span class="keyword">false</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// 查看taskQueue里是否有任务, 如果有任务的话, 则直接selector.selectNow();</span></div><div class="line">                <span class="keyword">if</span> (hasTasks()) &#123;</div><div class="line">                    selectNow();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    select(oldWakenUp);</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (wakenUp.get()) &#123;</div><div class="line">                        selector.wakeup();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                cancelledKeys = <span class="number">0</span>;</div><div class="line">                needsToSelectAgain = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> ioRatio = <span class="keyword">this</span>.ioRatio;</div><div class="line">                <span class="comment">// 如果当前线程是百分百执行的话, 则直接处理所有的任务</span></div><div class="line">                <span class="keyword">if</span> (ioRatio == <span class="number">100</span>) &#123;</div><div class="line">                    processSelectedKeys();</div><div class="line">                    runAllTasks();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">long</span> ioStartTime = System.nanoTime();</div><div class="line"></div><div class="line">                    processSelectedKeys();</div><div class="line"></div><div class="line">                    <span class="keyword">final</span> <span class="keyword">long</span> ioTime = System.nanoTime() - ioStartTime;</div><div class="line">                    runAllTasks(ioTime * (<span class="number">100</span> - ioRatio) / ioRatio);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">//</span></div><div class="line">                <span class="keyword">if</span> (isShuttingDown()) &#123;</div><div class="line">                    closeAll();</div><div class="line">                    <span class="keyword">if</span> (confirmShutdown()) &#123;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>上面的<code>run()</code>就是不断的轮询当前<code>NioEventLoop</code>里是否有任务. 然后处理Selector上已经就绪的Channel和任务队列里的任务.<br>然后我们接着往下看<code>processSelectedKeys()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processSelectedKeys</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (selectedKeys != <span class="keyword">null</span>) &#123;</div><div class="line">           processSelectedKeysOptimized(selectedKeys.flip());</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           processSelectedKeysPlain(selector.selectedKeys());</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processSelectedKeysPlain</span><span class="params">(Set&lt;SelectionKey&gt; selectedKeys)</span> </span>&#123;</div><div class="line">           <span class="comment">// check if the set is empty and if so just return to not create garbage by</span></div><div class="line">           <span class="comment">// creating a new Iterator every time even if there is nothing to process.</span></div><div class="line">           <span class="comment">// See https://github.com/netty/netty/issues/597</span></div><div class="line">           <span class="keyword">if</span> (selectedKeys.isEmpty()) &#123;</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           Iterator&lt;SelectionKey&gt; i = selectedKeys.iterator();</div><div class="line">           <span class="keyword">for</span> (;;) &#123;</div><div class="line">               <span class="keyword">final</span> SelectionKey k = i.next();</div><div class="line">               <span class="comment">// 取出SelectionKey的附件</span></div><div class="line">               <span class="keyword">final</span> Object a = k.attachment();</div><div class="line">               i.remove();</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (a <span class="keyword">instanceof</span> AbstractNioChannel) &#123;</div><div class="line">                 <span class="comment">// a有可能是NioServerSocketChannel或者NioSocketChannel</span></div><div class="line">                   processSelectedKey(k, (AbstractNioChannel) a);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="comment">// 如果a不是Channel的话, 那就是NioTask了</span></div><div class="line">                   <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">                   NioTask&lt;SelectableChannel&gt; task = (NioTask&lt;SelectableChannel&gt;) a;</div><div class="line">                   processSelectedKey(k, task);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (!i.hasNext()) &#123;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (needsToSelectAgain) &#123;</div><div class="line">                   selectAgain();</div><div class="line">                   selectedKeys = selector.selectedKeys();</div><div class="line"></div><div class="line">                   <span class="comment">// Create the iterator again to avoid ConcurrentModificationException</span></div><div class="line">                   <span class="keyword">if</span> (selectedKeys.isEmpty()) &#123;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   &#125; <span class="keyword">else</span> &#123;</div><div class="line">                       i = selectedKeys.iterator();</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<p>然后咱们接着往下看对Channel的处理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">processSelectedKey</span><span class="params">(SelectionKey k, AbstractNioChannel ch)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> NioUnsafe unsafe = ch.unsafe();</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">int</span> readyOps = k.readyOps();</div><div class="line">        <span class="comment">// Also check for readOps of 0 to workaround possible JDK bug which may otherwise lead</span></div><div class="line">        <span class="comment">// to a spin loop</span></div><div class="line">        <span class="keyword">if</span> ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != <span class="number">0</span> || readyOps == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// 如果是读事件或者连接的事件,则直接调用read方法</span></div><div class="line">            unsafe.read();</div><div class="line">            <span class="keyword">if</span> (!ch.isOpen()) &#123;</div><div class="line">                <span class="comment">// Connection already closed - no need to handle write.</span></div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> ((readyOps &amp; SelectionKey.OP_WRITE) != <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// 如果是写操作位, 则说明有半包消息没有写完, 需要继续</span></div><div class="line">            ch.unsafe().forceFlush();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> ((readyOps &amp; SelectionKey.OP_CONNECT) != <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// remove OP_CONNECT as otherwise Selector.select(..) will always return without blocking</span></div><div class="line">            <span class="comment">// See https://github.com/netty/netty/issues/924</span></div><div class="line">            <span class="keyword">int</span> ops = k.interestOps();</div><div class="line">            ops &amp;= ~SelectionKey.OP_CONNECT;</div><div class="line">            k.interestOps(ops);</div><div class="line"></div><div class="line">            unsafe.finishConnect();</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (CancelledKeyException ignored) &#123;</div><div class="line">        unsafe.close(unsafe.voidPromise());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>在unsafe的多态这我们要多说一些, 我们知道NioEventLoop内部处理的Channel其实是有俩种类型的, 一个是<code>NioServerScoketChannel</code>一个是<code>NioSocketChannel</code>.</p>
<p><code>NioServerSocketChannel</code>继承自<code>AbstractNioMessageChannel</code>, 而这个父类实现了一个<code>NioMessageUnsafe</code>的一个内部类, 这个内部类的<code>read()</code>方法会调用Channel里的<code>doReadMessage()</code>方法. 父类的<code>doReadMessage()</code>方法是由子类来具体实现的. 在<code>NioServerScoketChannel</code>中是生成了一个<code>NioSocketChannel</code>的列表作为消息返回, 然后再让<code>ServerBootstrapAcceptor</code>将<code>NioSocketChannel</code>绑定到从Reactor上.</p>
<p><code>NioSocketChannel</code>继承自<code>AbstractNioByteChannel</code>, 这个父类实现了一个<code>NioByteUnsafe</code>, 这个Unsafe就负责创建ByteBuf, 接受真正的网络数据了.</p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Netty/">Netty</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/14/netty/NioEventLoop/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/14/netty/NioEventLoop/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/12/算法/环形队列/" title="环形队列" itemprop="url">环形队列</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-12T08:00:00.000Z" itemprop="datePublished"> Published 2016-03-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#-*- coding=utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="comment"># 环形队列实现</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CircleQueue</span>:</span></div><div class="line">    <span class="comment"># 队列头</span></div><div class="line">    queueHead = <span class="number">0</span></div><div class="line">    <span class="comment"># 队列尾</span></div><div class="line">    queueTail = <span class="number">0</span></div><div class="line">    <span class="comment"># 队列容量</span></div><div class="line">    queueCacity = <span class="number">0</span></div><div class="line">    <span class="comment"># 队列当前长度</span></div><div class="line">    queueLength = <span class="number">0</span></div><div class="line">    <span class="comment"># 队列容器</span></div><div class="line">    queue = []</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, capacity)</span>:</span></div><div class="line">        self.queueCacity = capacity</div><div class="line">        self.queue = [<span class="number">0</span>] * capacity</div><div class="line"></div><div class="line">    <span class="comment"># 入列</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enqueue</span><span class="params">(self, obj)</span>:</span></div><div class="line">        <span class="keyword">if</span>(self.isFull()):</div><div class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"Queue is Full"</span>)</div><div class="line"></div><div class="line">        self.queue[self.queueTail] = obj</div><div class="line">        self.queueTail += <span class="number">1</span></div><div class="line">        <span class="comment"># 为了让队列头一直在环形队列中进行变化, 因此进行取余操作,</span></div><div class="line">        <span class="comment"># 当队列头达到最大容量时,再增长就回到初始队列头的位置</span></div><div class="line">        self.queueTail = self.queueTail % self.queueCacity</div><div class="line">        self.queueLength += <span class="number">1</span></div><div class="line"></div><div class="line">        <span class="keyword">return</span> self.queueLength</div><div class="line"></div><div class="line">    <span class="comment"># 出列</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dequeue</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">if</span>(self.isEmpoty()):</div><div class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"Queue is Empoty"</span>)</div><div class="line">        obj = self.queue[self.queueHead]</div><div class="line">        self.queueHead += <span class="number">1</span></div><div class="line">        self.queueHead = self.queueHead % self.queueCacity</div><div class="line">        self.queueLength -= <span class="number">1</span></div><div class="line">        <span class="keyword">return</span> obj</div><div class="line"></div><div class="line">    <span class="comment"># 判断队列是否为空</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isEmpoty</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.queueLength == <span class="number">0</span></div><div class="line"></div><div class="line">    <span class="comment"># 判断队列是否已满</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isFull</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.queueLength == self.queueCacity</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 测试</span></div><div class="line">circleQueue = CircleQueue(<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="comment"># 入列5个元素</span></div><div class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">1</span>) == <span class="number">1</span></div><div class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">2</span>) == <span class="number">2</span></div><div class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">3</span>) == <span class="number">3</span></div><div class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">4</span>) == <span class="number">4</span></div><div class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">5</span>) == <span class="number">5</span></div><div class="line"></div><div class="line"><span class="comment"># 现在队列的长度为5, 且队列尾已经和队列头重合了</span></div><div class="line"><span class="keyword">assert</span> circleQueue.queueLength == <span class="number">5</span></div><div class="line"><span class="keyword">assert</span> circleQueue.queueTail == <span class="number">0</span></div><div class="line"><span class="keyword">assert</span> circleQueue.queueHead == <span class="number">0</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> circleQueue.dequeue() == <span class="number">1</span></div><div class="line"><span class="keyword">assert</span> circleQueue.dequeue() == <span class="number">2</span></div><div class="line"><span class="keyword">assert</span> circleQueue.dequeue() == <span class="number">3</span></div><div class="line"><span class="keyword">assert</span> circleQueue.dequeue() == <span class="number">4</span></div><div class="line"><span class="keyword">assert</span> circleQueue.dequeue() == <span class="number">5</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> circleQueue.queueTail == <span class="number">0</span></div><div class="line"><span class="keyword">assert</span> circleQueue.queueHead == <span class="number">0</span></div><div class="line"></div><div class="line"><span class="comment"># 再入列一个数据,当前长度为1,且队列头为0,队列尾为1</span></div><div class="line"><span class="keyword">assert</span> circleQueue.enqueue(<span class="number">6</span>) == <span class="number">1</span></div><div class="line"></div><div class="line"><span class="keyword">assert</span> circleQueue.queueTail == <span class="number">1</span></div><div class="line"><span class="keyword">assert</span> circleQueue.queueHead == <span class="number">0</span></div></pre></td></tr></table></figure>
<p>环形队列的关键是能让头索引和尾索引能够在整个环形队列中自己循环</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/算法/">算法</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/12/算法/环形队列/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/12/算法/环形队列/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/06/nginx/nginx安装与命令/" title="Nginx安装与启动,关闭" itemprop="url">Nginx安装与启动,关闭</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="王玉" target="_blank" itemprop="author">王玉</a>
		
  <p class="article-time">
    <time datetime="2016-03-06T08:00:00.000Z" itemprop="datePublished"> Published 2016-03-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>在MAC上安装Nginx</p>
<p>使用命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">brew install nginx</div></pre></td></tr></table></figure></p>
<p>homebrew会自动为我们安装. 程序会安装在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/Cellar/nginx/1.6.2</div></pre></td></tr></table></figure></p>
<p>nginx的配置文件在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd /usr/local/etc/nginx</div></pre></td></tr></table></figure></p>
<blockquote>
<p>一般通过Homebrew安装的程序都会放在<code>/usr/local/Cellar/</code>里, 而配置文件会存储在<code>/usr/local/etc/</code>里</p>
</blockquote>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>我们可以通过下面这个简单的命令直接启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/nginx</div></pre></td></tr></table></figure></p>
<p>或者使用一个经过配置化的参数启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/nginx -t -c ~/mynginx.conf -g &quot;pid /var/run/nginx.pid; worker_processes 2;&quot;</div></pre></td></tr></table></figure></p>
<h2 id="关闭"><a href="#关闭" class="headerlink" title="关闭"></a>关闭</h2><p>一般我们可以通过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/nginx -s stop</div></pre></td></tr></table></figure></p>
<p>但是我们还可以通过想Nginx 主进程发送信号的方式来关闭它.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kill -QUIT $( cat /usr/local/nginx/logs/nginx.pid )</div></pre></td></tr></table></figure></p>
<p>一般我们推荐第二种方式, 让Nginx自己去停掉所有的主从进程</p>
<p>Nginx还接受如下参数</p>
<ul>
<li>TERM, INT    : Quick shutdown</li>
<li>QUIT :    Graceful shutdown</li>
<li>KILL :    Halts a stubborn process</li>
<li>HUP : Configuration reload, Start the new worker processes with a new configuration, Gracefully shutdown the old worker processes</li>
<li>USR1 :    Reopen the log files</li>
<li>USR2 :    Upgrade Executable on the fly</li>
<li>WINCH :    Gracefully shutdown the worker processes</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
</div>


</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/06/nginx/nginx安装与命令/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/03/06/nginx/nginx安装与命令/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/2/"><span></span>Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/4/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github Card</p>
<div class="github-card" data-github="yu66" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
		
		  
			<li><a href="/categories/JVM/" title="JVM">JVM<sup>38</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java/" title="Java">Java<sup>65</sup></a></li>
		  
		
		  
		
		  
		
		  
			<li><a href="/categories/Netty/" title="Netty">Netty<sup>8</sup></a></li>
		  
		
		  
			<li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/NoSql/" title="NoSql">NoSql<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/Spring-Guice/" title="Spring Guice">Spring Guice<sup>12</sup></a></li>
		  
		
		  
			<li><a href="/categories/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/asm/" title="asm">asm<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/linux/" title="linux">linux<sup>8</sup></a></li>
		  
		
		  
			<li><a href="/categories/mgits/" title="mgits">mgits<sup>16</sup></a></li>
		  
		
		  
		
		  
		
		  
			<li><a href="/categories/数据库/" title="数据库">数据库<sup>13</sup></a></li>
		  
		
		  
		
		  
			<li><a href="/categories/算法/" title="算法">算法<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/编程语言/" title="编程语言">编程语言<sup>18</sup></a></li>
		  
		
		  
		
		</ul>
</div>


  

  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="http://vertx.yu66.wang/" target="_blank" title="vertx3">vertx3</a>
            
          </li>
        
    </ul>
</div>

  

<div class="doubanshow">
<p class="asidetitle">Douban Show</p>
<div>
<script type="text/javascript" src="http://www.douban.com/service/badge/xxxyy/?show=collection&amp;n=12&amp;columns=3&amp;hidelogo=yes&amp;hideself=yes&amp;cat=book|movie" ></script>
</div>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=3253370782&verifier=e9ca895b&dpc=1"></iframe>
</div>


  

<div class="lofter">
<p class="asidetitle">Lofter</p>

 <iframe width="100%" height="39" class="share_self"  frameborder="0" scrolling="no" src="http://ming15.lofter.com/"></iframe>
</div>




</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 博客,我选择重构 <br/>
			重构使事情变得更美,更加正确</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/3253370782" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/yu66" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		<a href="https://www.douban.com/people/xxxyy" target="_blank" class="icon-douban" title="豆瓣"></a>
		
		
		<a href="http://www.zhihu.com/people/ming15" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="王玉">王玉</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"wanggnim"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F9e8fca440159a2125668804e46682db4' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
