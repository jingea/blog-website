category: 网络
date: 2015-11-08
title: 传输层
---

在俩个主机之间创建逻辑上的通信连接.同时还要确保所传输的数据是可达的,如果不可达在负责重发.

包含的协议:
* TCP
* UDP
* SCTP
* DCCP
TCP模块负责建立,发送数据以及断开连接. 当传输层接收到应用层传递过来的数据,由TCP模块处理时,TCP模块会在应用层数据前部添加一个TCP首部,其包含:
* 源端口号
* 目标端口号
* 序号(识别包中哪些是应用层数据)
* 校验和(判断数据是否被破坏)

## 连接管理

![](https://raw.githubusercontent.com/wanggnim/blog-website/images/net/TCP_STATE2.jpg)
## 三次握手
* 第一次握手：建立连接时，客户端首先向服务端发送一个 SYN 包和一个随机序列号 A，客户端进入SYN_SENT状态，等待服务器确认；
* 第二次握手：服务端收到后会回复客户端一个 SYN-ACK 包以及一个确认号（用于确认收到 SYN）A+1，同时再发送一个随机序列号 B，此时服务器进入SYN_RECV状态；
* 第三次握手：客户端收到后会发送一个 ACK 包以及确认号（用于确认收到 SYN-ACK）B+1 和序列号 A+1 给服务端，此包发送完毕，客户端和服务器进入ESTABLISHED（TCP连接成功）状态，完成三次握手。

### 四次挥手
1. 客户端执行`CLOSE`主动关闭,向服务器发送`FIN`数据报. 客户端进入`FIN WAIT1`状态
2. 服务器收到客户端发送过来的`FIN`数据包执行被动关闭,同时向客户端响应`ACK`数据包,服务器进入`CLOSE WAIT`状态. 客户端收到服务端发送过来的`ACK`包后, 客户端进入`FIN WAIT2`状态.
3. 紧接着服务器再发送一个`ACK`包,服务器进入`LAST ACK`状态. 服务器端就关闭了.
4. 客户端收到`ACK`包后进入`TIME_WAIT`状态. 当客户端超时后也就执行关闭了.



TCP端口状态：
1. LISTENING状态: FTP服务启动后首先处于侦听（LISTENING）状态。
2. ESTABLISHED状态: ESTABLISHED的意思是建立连接。表示两台机器正在通信。
3. CLOSE_WAIT: 对方主动关闭连接或者网络异常导致连接中断，这时我方的状态会变成CLOSE_WAIT 此时我方要调用close()来使得连接正确关闭
4. TIME_WAIT: 我方主动调用close()断开连接，收到对方确认后状态变为TIME_WAIT。TCP协议规定TIME_WAIT状态会一直持续2MSL(即两倍的分段最大生存期)，以此来确保旧的连接状态不会对新连接产生影响。处于TIME_WAIT状态的连接占用的资源不会被内核释放，所以作为服务器，在可能的情况下，尽量不要主动断开连接，以减少TIME_WAIT状态造成的资源浪费。目前有一种避免TIME_WAIT资源浪费的方法，就是关闭socket的LINGER选项。但这种做法是TCP协议不推荐使用的，在某些情况下这个操作可能会带来错误。
5. SYN_SENT状态:SYN_SENT状态表示请求连接，当你要访问其它的计算机的服务时首先要发个同步信号给该端口，此时状态为SYN_SENT，如果连接成功了就变为ESTABLISHED，此时SYN_SENT状态非常短暂。但如果发现SYN_SENT非常多且在向不同的机器发出，那你的机器可能中了冲击波或震荡波之类的病毒了。这类病毒为了感染别的计算机，它就要扫描别的计算机，在扫描的过程中对每个要扫描的计算机都要发出了同步请求，这也是出现许多SYN_SENT的原因。


